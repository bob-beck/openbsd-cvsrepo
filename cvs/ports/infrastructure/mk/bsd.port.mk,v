head	1.1341;
access;
symbols
	OPENBSD_6_1:1.1339.0.2
	OPENBSD_6_1_BASE:1.1339
	OPENBSD_6_0:1.1319.0.2
	OPENBSD_6_0_BASE:1.1319
	OPENBSD_5_9:1.1305.0.2
	OPENBSD_5_9_BASE:1.1305
	OPENBSD_5_8:1.1298.0.4
	OPENBSD_5_8_BASE:1.1298
	OPENBSD_5_7:1.1288.0.2
	OPENBSD_5_7_BASE:1.1288
	OPENBSD_5_6:1.1273.0.2
	OPENBSD_5_6_BASE:1.1273
	OPENBSD_5_5:1.1256.0.2
	OPENBSD_5_5_BASE:1.1256
	OPENBSD_5_4:1.1244.0.2
	OPENBSD_5_4_BASE:1.1244
	OPENBSD_5_3:1.1212.0.2
	OPENBSD_5_3_BASE:1.1212
	OPENBSD_5_2:1.1182.0.2
	OPENBSD_5_2_BASE:1.1182
	OPENBSD_5_1_BASE:1.1158
	OPENBSD_5_1:1.1158.0.2
	OPENBSD_5_0:1.1101.0.2
	OPENBSD_5_0_BASE:1.1101
	OPENBSD_4_9:1.1071.0.2
	OPENBSD_4_9_BASE:1.1071
	OPENBSD_4_8:1.1026.0.2
	OPENBSD_4_8_BASE:1.1026
	OPENBSD_4_7:1.979.0.2
	OPENBSD_4_7_BASE:1.979
	OPENBSD_4_6:1.967.0.2
	OPENBSD_4_6_BASE:1.967
	OPENBSD_4_5:1.959.0.2
	OPENBSD_4_5_BASE:1.959
	OPENBSD_4_4:1.951.0.2
	OPENBSD_4_4_BASE:1.951
	OPENBSD_4_3:1.923.0.2
	OPENBSD_4_3_BASE:1.923
	OPENBSD_4_2:1.912.0.2
	OPENBSD_4_2_BASE:1.912
	OPENBSD_4_1:1.881.0.2
	OPENBSD_4_1_BASE:1.881
	OPENBSD_4_0:1.763.0.2
	OPENBSD_4_0_BASE:1.763
	OPENBSD_3_9:1.745.0.2
	OPENBSD_3_9_BASE:1.745
	OPENBSD_3_8:1.704.0.2
	OPENBSD_3_8_BASE:1.704
	OPENBSD_3_7:1.685.0.2
	OPENBSD_3_7_BASE:1.685
	OPENBSD_3_6:1.642.0.2
	OPENBSD_3_6_BASE:1.642
	OPENBSD_3_5:1.611.0.2
	OPENBSD_3_5_BASE:1.611
	OPENBSD_3_4:1.587.0.2
	OPENBSD_3_4_BASE:1.587
	OPENBSD_3_3:1.543.0.2
	OPENBSD_3_3_BASE:1.543
	OPENBSD_3_2:1.535.0.2
	OPENBSD_3_2_BASE:1.535
	OPENBSD_3_1:1.522.0.2
	OPENBSD_3_1_BASE:1.522
	OPENBSD_3_0:1.475.0.2
	OPENBSD_3_0_BASE:1.475
	OPENBSD_2_9_TRACKING_SWITCH:1.435
	OPENBSD_2_9:1.405.0.2
	OPENBSD_2_9_BASE:1.405
	OPENBSD_2_8:1.340.0.2
	OPENBSD_2_8_BASE:1.340
	OPENBSD_2_7:1.273.0.2
	OPENBSD_2_7_BASE:1.273
	OPENBSD_2_6:1.130.0.2
	OPENBSD_2_6_BASE:1.130;
locks; strict;
comment	@# @;


1.1341
date	2017.04.25.10.23.09;	author espie;	state Exp;
branches;
next	1.1340;
commitid	7Q48cpBNb9CzlwHv;

1.1340
date	2017.04.11.15.36.56;	author espie;	state Exp;
branches;
next	1.1339;
commitid	ZGqhyFqJh28gT1pB;

1.1339
date	2017.02.28.21.31.46;	author edd;	state Exp;
branches;
next	1.1338;
commitid	IDVaTkf8YvXJdlGD;

1.1338
date	2017.02.26.18.54.48;	author espie;	state Exp;
branches;
next	1.1337;
commitid	a0Rwd60Go6g6VgwE;

1.1337
date	2017.02.26.11.18.25;	author espie;	state Exp;
branches;
next	1.1336;
commitid	pcMcAWFxJA4zDbRh;

1.1336
date	2017.02.21.13.55.16;	author espie;	state Exp;
branches;
next	1.1335;
commitid	KmhcXgpW3cUqFAbC;

1.1335
date	2017.02.21.13.53.40;	author espie;	state Exp;
branches;
next	1.1334;
commitid	nAnDCVkPa2rDyv4n;

1.1334
date	2017.02.21.13.49.34;	author espie;	state Exp;
branches;
next	1.1333;
commitid	gYLVoOXBzBxT7Vqo;

1.1333
date	2017.02.21.13.46.18;	author espie;	state Exp;
branches;
next	1.1332;
commitid	R8YqURGmoapTqR0d;

1.1332
date	2017.02.21.13.31.56;	author espie;	state Exp;
branches;
next	1.1331;
commitid	jbpXjgacvNpC60bV;

1.1331
date	2017.02.21.13.15.01;	author espie;	state Exp;
branches;
next	1.1330;
commitid	iQOSF3GmiuLQDZS1;

1.1330
date	2017.02.20.13.45.17;	author espie;	state Exp;
branches;
next	1.1329;
commitid	xaSiO7Q7Iw6ks2Ai;

1.1329
date	2017.02.18.15.15.07;	author espie;	state Exp;
branches;
next	1.1328;
commitid	GqySWuWsdKO6Ri2k;

1.1328
date	2017.02.18.15.00.02;	author espie;	state Exp;
branches;
next	1.1327;
commitid	XK9oJoZm6Bli5VWN;

1.1327
date	2017.02.17.23.17.43;	author espie;	state Exp;
branches;
next	1.1326;
commitid	KaJAVPXT03yvLGUo;

1.1326
date	2017.02.13.12.56.50;	author espie;	state Exp;
branches;
next	1.1325;
commitid	NGUDx6UxJgU8dQ3L;

1.1325
date	2016.12.13.07.25.47;	author landry;	state Exp;
branches;
next	1.1324;
commitid	UFjrpmGpo2Ykzoj8;

1.1324
date	2016.10.31.11.08.34;	author jasper;	state Exp;
branches;
next	1.1323;
commitid	NPZcVshskyZNOLnA;

1.1323
date	2016.10.28.15.46.48;	author sthen;	state Exp;
branches;
next	1.1322;
commitid	SoXWudwPaMDWjn0V;

1.1322
date	2016.09.06.10.31.12;	author espie;	state Exp;
branches;
next	1.1321;
commitid	VQ3bBU2eFM28WWUq;

1.1321
date	2016.09.03.13.29.59;	author sthen;	state Exp;
branches;
next	1.1320;
commitid	cQhFKpSwh2F0LG8A;

1.1320
date	2016.08.18.12.28.53;	author sthen;	state Exp;
branches;
next	1.1319;
commitid	B2FG0FaPmxcUfzwp;

1.1319
date	2016.07.10.18.51.03;	author espie;	state Exp;
branches;
next	1.1318;
commitid	MrWbZFNtWi1ikjwu;

1.1318
date	2016.06.22.10.13.17;	author ajacoutot;	state Exp;
branches;
next	1.1317;
commitid	jYUgMx42kb0kVzZO;

1.1317
date	2016.05.17.13.38.25;	author espie;	state Exp;
branches;
next	1.1316;
commitid	LYsgoFnnCDGpRguw;

1.1316
date	2016.05.17.13.33.21;	author espie;	state Exp;
branches;
next	1.1315;
commitid	CVWL1i0SHFecbVb7;

1.1315
date	2016.05.01.09.12.27;	author ajacoutot;	state Exp;
branches;
next	1.1314;
commitid	eUlM10vqwOLAPBAg;

1.1314
date	2016.04.27.20.41.04;	author espie;	state Exp;
branches;
next	1.1313;
commitid	e3BwbZn39AdvrG4n;

1.1313
date	2016.04.27.18.13.09;	author espie;	state Exp;
branches;
next	1.1312;
commitid	MHsSMB0tSzma7JRT;

1.1312
date	2016.04.26.17.35.35;	author naddy;	state Exp;
branches;
next	1.1311;
commitid	dMWCfWygKUXvQSas;

1.1311
date	2016.04.26.10.56.59;	author sthen;	state Exp;
branches;
next	1.1310;
commitid	FbIvW5WdGqu5h4SS;

1.1310
date	2016.03.20.20.07.20;	author naddy;	state Exp;
branches;
next	1.1309;
commitid	RqaPG8M2ltW6WJDm;

1.1309
date	2016.03.15.22.56.27;	author naddy;	state Exp;
branches;
next	1.1308;
commitid	5sYsv04MyB1Es3EC;

1.1308
date	2016.03.15.20.58.58;	author naddy;	state Exp;
branches;
next	1.1307;
commitid	JzP17OldYfIezicf;

1.1307
date	2016.03.11.20.32.22;	author naddy;	state Exp;
branches;
next	1.1306;
commitid	yofBOltCJdHzQwua;

1.1306
date	2016.03.09.17.21.44;	author naddy;	state Exp;
branches;
next	1.1305;
commitid	pjIkrlzWLd0hqcyH;

1.1305
date	2016.01.06.19.51.54;	author jasper;	state Exp;
branches;
next	1.1304;
commitid	oLaxgKLE8zEoqX5k;

1.1304
date	2015.12.29.19.48.08;	author jasper;	state Exp;
branches;
next	1.1303;
commitid	XvBWUIk78lcMZEr5;

1.1303
date	2015.12.24.18.29.35;	author jasper;	state Exp;
branches;
next	1.1302;
commitid	e7wt5uhI7oqwiXsv;

1.1302
date	2015.11.18.16.37.31;	author sthen;	state Exp;
branches;
next	1.1301;
commitid	OIiguwuULKRAfdIG;

1.1301
date	2015.11.07.09.54.46;	author espie;	state Exp;
branches;
next	1.1300;
commitid	2a4whjeIXuUsNxbO;

1.1300
date	2015.10.18.14.05.05;	author naddy;	state Exp;
branches;
next	1.1299;
commitid	fqBqobF7OCwLpaVw;

1.1299
date	2015.10.16.20.07.39;	author naddy;	state Exp;
branches;
next	1.1298;
commitid	2RvwhZEgXRRcwUL7;

1.1298
date	2015.07.19.17.31.44;	author naddy;	state Exp;
branches;
next	1.1297;
commitid	SGdcwT9meBEfmtWo;

1.1297
date	2015.06.11.09.26.01;	author espie;	state Exp;
branches;
next	1.1296;
commitid	RVyjapYgS9RPcky2;

1.1296
date	2015.05.23.10.53.24;	author czarkoff;	state Exp;
branches;
next	1.1295;
commitid	s4prXHt4PYvMnNOn;

1.1295
date	2015.05.16.17.04.51;	author espie;	state Exp;
branches;
next	1.1294;
commitid	iD9ehW5Fb0EKqqZ1;

1.1294
date	2015.05.14.18.00.27;	author jasper;	state Exp;
branches;
next	1.1293;
commitid	T2UWJaZfg0iYDH8X;

1.1293
date	2015.05.11.12.07.17;	author espie;	state Exp;
branches;
next	1.1292;
commitid	Mkzv1lFWcV9jjaJQ;

1.1292
date	2015.05.03.08.06.03;	author espie;	state Exp;
branches;
next	1.1291;
commitid	e7Osysb4az6GhR96;

1.1291
date	2015.04.27.12.52.01;	author espie;	state Exp;
branches;
next	1.1290;
commitid	CyKGQGhvoa2GaEoH;

1.1290
date	2015.04.22.07.07.19;	author zhuk;	state Exp;
branches;
next	1.1289;
commitid	LvMHTs00pHnJSaEw;

1.1289
date	2015.04.05.13.32.16;	author sthen;	state Exp;
branches;
next	1.1288;
commitid	uMahrmqBRYKd1A6b;

1.1288
date	2015.01.04.05.47.07;	author brad;	state Exp;
branches;
next	1.1287;
commitid	Qti9zLAVBo191gHV;

1.1287
date	2014.12.13.11.08.15;	author espie;	state Exp;
branches;
next	1.1286;
commitid	jHe0zeG53HNlnQjI;

1.1286
date	2014.12.10.22.39.24;	author espie;	state Exp;
branches;
next	1.1285;
commitid	GorE3rdMtZhWqoRJ;

1.1285
date	2014.11.22.10.07.38;	author espie;	state Exp;
branches;
next	1.1284;
commitid	qpngfZN4R57lunIZ;

1.1284
date	2014.11.03.16.35.05;	author espie;	state Exp;
branches;
next	1.1283;
commitid	eiav32iK1tX14VfX;

1.1283
date	2014.09.16.19.10.54;	author espie;	state Exp;
branches;
next	1.1282;
commitid	x494cFl03hhaYmmv;

1.1282
date	2014.09.13.15.09.24;	author naddy;	state Exp;
branches;
next	1.1281;
commitid	FxcWXlITiovQCNP3;

1.1281
date	2014.09.09.09.34.04;	author espie;	state Exp;
branches;
next	1.1280;
commitid	CqL8BniOCzdjgRj5;

1.1280
date	2014.09.05.14.45.02;	author jasper;	state Exp;
branches;
next	1.1279;
commitid	f4VbjcUvEOJXzzBc;

1.1279
date	2014.09.03.09.05.25;	author espie;	state Exp;
branches;
next	1.1278;
commitid	RNl8N3cZLQb75g52;

1.1278
date	2014.09.02.14.26.39;	author jasper;	state Exp;
branches;
next	1.1277;
commitid	Ptx1R6NkkFWYpLmY;

1.1277
date	2014.08.11.11.34.42;	author sthen;	state Exp;
branches;
next	1.1276;
commitid	5cnA2HwlCE1sCCHT;

1.1276
date	2014.08.10.11.34.27;	author jasper;	state Exp;
branches;
next	1.1275;
commitid	3QuAY4eoR1zWBaaI;

1.1275
date	2014.08.10.09.02.21;	author espie;	state Exp;
branches;
next	1.1274;
commitid	4qew8IwcSeELc5of;

1.1274
date	2014.08.10.08.59.48;	author espie;	state Exp;
branches;
next	1.1273;
commitid	J6YjvtGPOV1NhCrC;

1.1273
date	2014.07.23.10.19.08;	author espie;	state Exp;
branches;
next	1.1272;
commitid	gl4DQyr9YH9eBa4C;

1.1272
date	2014.07.14.08.21.00;	author zhuk;	state Exp;
branches;
next	1.1271;
commitid	y9Mme4jE9tCBBChN;

1.1271
date	2014.07.12.19.22.34;	author espie;	state Exp;
branches;
next	1.1270;
commitid	4s2bOrKBlYcug0yx;

1.1270
date	2014.07.12.17.35.32;	author espie;	state Exp;
branches;
next	1.1269;
commitid	g9GVMnSaykPGUXLd;

1.1269
date	2014.07.10.23.19.55;	author sthen;	state Exp;
branches;
next	1.1268;
commitid	igFubl5pDlghiMqJ;

1.1268
date	2014.07.09.10.28.42;	author robert;	state Exp;
branches;
next	1.1267;
commitid	XTWubZK7fMNF78yc;

1.1267
date	2014.07.09.10.27.11;	author robert;	state Exp;
branches;
next	1.1266;
commitid	1JS1tCZtb78Uqr7a;

1.1266
date	2014.06.05.10.06.09;	author sthen;	state Exp;
branches;
next	1.1265;
commitid	7ultRv3ChRGThM8v;

1.1265
date	2014.04.25.15.28.52;	author espie;	state Exp;
branches;
next	1.1264;

1.1264
date	2014.04.25.15.13.51;	author sthen;	state Exp;
branches;
next	1.1263;

1.1263
date	2014.04.18.21.14.20;	author kili;	state Exp;
branches;
next	1.1262;

1.1262
date	2014.04.15.08.52.35;	author ajacoutot;	state Exp;
branches;
next	1.1261;

1.1261
date	2014.04.08.13.29.34;	author espie;	state Exp;
branches;
next	1.1260;

1.1260
date	2014.04.01.18.41.33;	author jasper;	state Exp;
branches;
next	1.1259;

1.1259
date	2014.04.01.18.38.53;	author jasper;	state Exp;
branches;
next	1.1258;

1.1258
date	2014.03.09.21.40.57;	author ajacoutot;	state Exp;
branches;
next	1.1257;

1.1257
date	2014.03.09.20.03.27;	author espie;	state Exp;
branches;
next	1.1256;

1.1256
date	2014.02.11.10.34.34;	author espie;	state Exp;
branches;
next	1.1255;

1.1255
date	2014.01.09.10.44.33;	author espie;	state Exp;
branches;
next	1.1254;

1.1254
date	2014.01.07.10.39.17;	author espie;	state Exp;
branches;
next	1.1253;

1.1253
date	2013.12.30.12.33.07;	author espie;	state Exp;
branches;
next	1.1252;

1.1252
date	2013.12.07.15.41.47;	author espie;	state Exp;
branches;
next	1.1251;

1.1251
date	2013.12.02.21.47.37;	author espie;	state Exp;
branches;
next	1.1250;

1.1250
date	2013.12.02.08.23.16;	author espie;	state Exp;
branches;
next	1.1249;

1.1249
date	2013.11.30.16.06.56;	author espie;	state Exp;
branches;
next	1.1248;

1.1248
date	2013.11.25.14.13.33;	author sthen;	state Exp;
branches;
next	1.1247;

1.1247
date	2013.11.07.01.23.19;	author juanfra;	state Exp;
branches;
next	1.1246;

1.1246
date	2013.11.03.15.45.00;	author espie;	state Exp;
branches;
next	1.1245;

1.1245
date	2013.08.07.07.20.24;	author espie;	state Exp;
branches;
next	1.1244;

1.1244
date	2013.07.09.19.48.56;	author espie;	state Exp;
branches;
next	1.1243;

1.1243
date	2013.07.08.18.37.18;	author landry;	state Exp;
branches;
next	1.1242;

1.1242
date	2013.07.08.18.27.30;	author landry;	state Exp;
branches;
next	1.1241;

1.1241
date	2013.07.08.12.45.56;	author espie;	state Exp;
branches;
next	1.1240;

1.1240
date	2013.07.05.21.48.01;	author espie;	state Exp;
branches;
next	1.1239;

1.1239
date	2013.07.04.08.04.04;	author jasper;	state Exp;
branches;
next	1.1238;

1.1238
date	2013.06.25.20.21.03;	author espie;	state Exp;
branches;
next	1.1237;

1.1237
date	2013.06.25.19.47.49;	author espie;	state Exp;
branches;
next	1.1236;

1.1236
date	2013.06.25.08.46.55;	author espie;	state Exp;
branches;
next	1.1235;

1.1235
date	2013.06.21.12.28.54;	author espie;	state Exp;
branches;
next	1.1234;

1.1234
date	2013.06.21.12.27.32;	author espie;	state Exp;
branches;
next	1.1233;

1.1233
date	2013.06.21.10.45.12;	author espie;	state Exp;
branches;
next	1.1232;

1.1232
date	2013.06.15.19.45.11;	author espie;	state Exp;
branches;
next	1.1231;

1.1231
date	2013.06.13.18.13.54;	author espie;	state Exp;
branches;
next	1.1230;

1.1230
date	2013.06.11.10.59.24;	author espie;	state Exp;
branches;
next	1.1229;

1.1229
date	2013.06.10.15.43.04;	author espie;	state Exp;
branches;
next	1.1228;

1.1228
date	2013.06.04.19.35.04;	author naddy;	state Exp;
branches;
next	1.1227;

1.1227
date	2013.05.27.16.06.51;	author espie;	state Exp;
branches;
next	1.1226;

1.1226
date	2013.05.21.12.38.06;	author ajacoutot;	state Exp;
branches;
next	1.1225;

1.1225
date	2013.05.15.16.32.16;	author sthen;	state Exp;
branches;
next	1.1224;

1.1224
date	2013.05.14.13.38.59;	author gsoares;	state Exp;
branches;
next	1.1223;

1.1223
date	2013.05.08.08.38.36;	author espie;	state Exp;
branches;
next	1.1222;

1.1222
date	2013.04.08.16.45.06;	author espie;	state Exp;
branches;
next	1.1221;

1.1221
date	2013.04.01.13.11.34;	author espie;	state Exp;
branches;
next	1.1220;

1.1220
date	2013.03.21.08.28.33;	author ajacoutot;	state Exp;
branches;
next	1.1219;

1.1219
date	2013.03.20.10.48.00;	author espie;	state Exp;
branches;
next	1.1218;

1.1218
date	2013.03.17.10.35.05;	author espie;	state Exp;
branches;
next	1.1217;

1.1217
date	2013.03.12.06.56.27;	author ajacoutot;	state Exp;
branches;
next	1.1216;

1.1216
date	2013.03.10.22.27.15;	author espie;	state Exp;
branches;
next	1.1215;

1.1215
date	2013.03.09.00.09.14;	author espie;	state Exp;
branches;
next	1.1214;

1.1214
date	2013.03.08.10.06.13;	author espie;	state Exp;
branches;
next	1.1213;

1.1213
date	2013.03.02.13.08.49;	author espie;	state Exp;
branches;
next	1.1212;

1.1212
date	2013.02.18.12.07.42;	author espie;	state Exp;
branches;
next	1.1211;

1.1211
date	2013.02.11.14.31.14;	author jasper;	state Exp;
branches;
next	1.1210;

1.1210
date	2013.02.10.13.42.38;	author sthen;	state Exp;
branches;
next	1.1209;

1.1209
date	2013.02.05.11.22.50;	author espie;	state Exp;
branches;
next	1.1208;

1.1208
date	2013.02.04.20.44.41;	author espie;	state Exp;
branches;
next	1.1207;

1.1207
date	2013.02.02.13.23.24;	author espie;	state Exp;
branches;
next	1.1206;

1.1206
date	2013.02.02.12.29.20;	author espie;	state Exp;
branches;
next	1.1205;

1.1205
date	2013.02.02.12.28.50;	author espie;	state Exp;
branches;
next	1.1204;

1.1204
date	2013.01.19.11.34.11;	author espie;	state Exp;
branches;
next	1.1203;

1.1203
date	2013.01.07.17.46.14;	author espie;	state Exp;
branches;
next	1.1202;

1.1202
date	2013.01.06.11.57.21;	author espie;	state Exp;
branches;
next	1.1201;

1.1201
date	2012.12.31.09.14.07;	author espie;	state Exp;
branches;
next	1.1200;

1.1200
date	2012.12.30.20.40.40;	author espie;	state Exp;
branches;
next	1.1199;

1.1199
date	2012.11.27.11.35.57;	author espie;	state Exp;
branches;
next	1.1198;

1.1198
date	2012.11.19.14.19.35;	author espie;	state Exp;
branches;
next	1.1197;

1.1197
date	2012.11.19.12.24.50;	author espie;	state Exp;
branches;
next	1.1196;

1.1196
date	2012.11.19.12.19.30;	author espie;	state Exp;
branches;
next	1.1195;

1.1195
date	2012.11.05.20.29.35;	author espie;	state Exp;
branches;
next	1.1194;

1.1194
date	2012.11.03.09.40.05;	author espie;	state Exp;
branches;
next	1.1193;

1.1193
date	2012.11.01.09.58.53;	author espie;	state Exp;
branches;
next	1.1192;

1.1192
date	2012.10.29.22.27.05;	author espie;	state Exp;
branches;
next	1.1191;

1.1191
date	2012.10.11.08.07.10;	author espie;	state Exp;
branches;
next	1.1190;

1.1190
date	2012.09.24.15.49.00;	author espie;	state Exp;
branches;
next	1.1189;

1.1189
date	2012.09.22.19.00.04;	author espie;	state Exp;
branches;
next	1.1188;

1.1188
date	2012.08.31.16.48.26;	author espie;	state Exp;
branches;
next	1.1187;

1.1187
date	2012.08.19.22.30.36;	author ajacoutot;	state Exp;
branches;
next	1.1186;

1.1186
date	2012.08.19.10.36.35;	author espie;	state Exp;
branches;
next	1.1185;

1.1185
date	2012.08.18.07.58.20;	author espie;	state Exp;
branches;
next	1.1184;

1.1184
date	2012.08.17.22.32.29;	author espie;	state Exp;
branches;
next	1.1183;

1.1183
date	2012.08.04.14.23.30;	author espie;	state Exp;
branches;
next	1.1182;

1.1182
date	2012.07.10.12.04.25;	author naddy;	state Exp;
branches;
next	1.1181;

1.1181
date	2012.07.06.12.00.52;	author espie;	state Exp;
branches;
next	1.1180;

1.1180
date	2012.06.20.13.26.17;	author espie;	state Exp;
branches;
next	1.1179;

1.1179
date	2012.06.19.16.43.47;	author espie;	state Exp;
branches;
next	1.1178;

1.1178
date	2012.06.18.12.15.52;	author espie;	state Exp;
branches;
next	1.1177;

1.1177
date	2012.06.15.10.31.52;	author espie;	state Exp;
branches;
next	1.1176;

1.1176
date	2012.06.14.13.34.24;	author espie;	state Exp;
branches;
next	1.1175;

1.1175
date	2012.06.09.21.14.43;	author espie;	state Exp;
branches;
next	1.1174;

1.1174
date	2012.06.08.23.51.21;	author sthen;	state Exp;
branches;
next	1.1173;

1.1173
date	2012.06.08.15.17.02;	author espie;	state Exp;
branches;
next	1.1172;

1.1172
date	2012.06.08.14.46.54;	author espie;	state Exp;
branches;
next	1.1171;

1.1171
date	2012.05.28.09.54.18;	author espie;	state Exp;
branches;
next	1.1170;

1.1170
date	2012.05.28.09.38.04;	author espie;	state Exp;
branches;
next	1.1169;

1.1169
date	2012.05.26.12.04.35;	author espie;	state Exp;
branches;
next	1.1168;

1.1168
date	2012.05.16.06.36.56;	author jasper;	state Exp;
branches;
next	1.1167;

1.1167
date	2012.05.08.17.38.21;	author jasper;	state Exp;
branches;
next	1.1166;

1.1166
date	2012.05.07.21.11.43;	author halex;	state Exp;
branches;
next	1.1165;

1.1165
date	2012.04.28.10.50.35;	author ajacoutot;	state Exp;
branches;
next	1.1164;

1.1164
date	2012.04.22.10.39.48;	author espie;	state Exp;
branches;
next	1.1163;

1.1163
date	2012.04.17.09.31.47;	author espie;	state Exp;
branches;
next	1.1162;

1.1162
date	2012.04.16.09.21.39;	author espie;	state Exp;
branches;
next	1.1161;

1.1161
date	2012.03.22.14.08.50;	author espie;	state Exp;
branches;
next	1.1160;

1.1160
date	2012.02.23.08.32.17;	author espie;	state Exp;
branches;
next	1.1159;

1.1159
date	2012.02.17.07.33.04;	author espie;	state Exp;
branches;
next	1.1158;

1.1158
date	2012.01.29.11.29.51;	author espie;	state Exp;
branches;
next	1.1157;

1.1157
date	2012.01.28.08.39.40;	author espie;	state Exp;
branches;
next	1.1156;

1.1156
date	2012.01.21.14.44.40;	author espie;	state Exp;
branches;
next	1.1155;

1.1155
date	2012.01.14.12.22.07;	author espie;	state Exp;
branches;
next	1.1154;

1.1154
date	2012.01.14.12.21.13;	author espie;	state Exp;
branches;
next	1.1153;

1.1153
date	2011.12.21.05.16.04;	author miod;	state Exp;
branches;
next	1.1152;

1.1152
date	2011.12.10.11.15.16;	author espie;	state Exp;
branches;
next	1.1151;

1.1151
date	2011.12.09.09.42.44;	author espie;	state Exp;
branches;
next	1.1150;

1.1150
date	2011.12.08.08.15.36;	author espie;	state Exp;
branches;
next	1.1149;

1.1149
date	2011.12.02.15.14.20;	author espie;	state Exp;
branches;
next	1.1148;

1.1148
date	2011.11.27.21.04.34;	author sthen;	state Exp;
branches;
next	1.1147;

1.1147
date	2011.11.27.17.21.44;	author espie;	state Exp;
branches;
next	1.1146;

1.1146
date	2011.11.27.16.52.04;	author espie;	state Exp;
branches;
next	1.1145;

1.1145
date	2011.11.26.13.52.52;	author espie;	state Exp;
branches;
next	1.1144;

1.1144
date	2011.11.25.13.58.13;	author espie;	state Exp;
branches;
next	1.1143;

1.1143
date	2011.11.24.19.24.54;	author espie;	state Exp;
branches;
next	1.1142;

1.1142
date	2011.11.24.18.12.28;	author espie;	state Exp;
branches;
next	1.1141;

1.1141
date	2011.11.24.17.49.58;	author espie;	state Exp;
branches;
next	1.1140;

1.1140
date	2011.11.21.16.42.52;	author espie;	state Exp;
branches;
next	1.1139;

1.1139
date	2011.11.21.12.26.05;	author espie;	state Exp;
branches;
next	1.1138;

1.1138
date	2011.11.21.12.20.53;	author espie;	state Exp;
branches;
next	1.1137;

1.1137
date	2011.11.21.12.16.42;	author espie;	state Exp;
branches;
next	1.1136;

1.1136
date	2011.11.19.11.33.39;	author espie;	state Exp;
branches;
next	1.1135;

1.1135
date	2011.11.18.11.01.47;	author espie;	state Exp;
branches;
next	1.1134;

1.1134
date	2011.11.17.17.53.22;	author espie;	state Exp;
branches;
next	1.1133;

1.1133
date	2011.11.16.14.40.59;	author espie;	state Exp;
branches;
next	1.1132;

1.1132
date	2011.11.16.10.57.23;	author espie;	state Exp;
branches;
next	1.1131;

1.1131
date	2011.11.16.10.30.47;	author espie;	state Exp;
branches;
next	1.1130;

1.1130
date	2011.11.15.20.41.41;	author espie;	state Exp;
branches;
next	1.1129;

1.1129
date	2011.11.15.20.32.35;	author espie;	state Exp;
branches;
next	1.1128;

1.1128
date	2011.11.15.20.08.36;	author espie;	state Exp;
branches;
next	1.1127;

1.1127
date	2011.11.14.22.02.15;	author espie;	state Exp;
branches;
next	1.1126;

1.1126
date	2011.11.14.16.18.36;	author espie;	state Exp;
branches;
next	1.1125;

1.1125
date	2011.11.14.13.12.20;	author espie;	state Exp;
branches;
next	1.1124;

1.1124
date	2011.11.14.12.10.27;	author espie;	state Exp;
branches;
next	1.1123;

1.1123
date	2011.11.14.10.29.58;	author espie;	state Exp;
branches;
next	1.1122;

1.1122
date	2011.11.13.10.34.35;	author espie;	state Exp;
branches;
next	1.1121;

1.1121
date	2011.11.02.17.16.30;	author avsm;	state Exp;
branches;
next	1.1120;

1.1120
date	2011.10.25.15.08.10;	author espie;	state Exp;
branches;
next	1.1119;

1.1119
date	2011.10.24.12.34.08;	author espie;	state Exp;
branches;
next	1.1118;

1.1118
date	2011.10.21.16.52.05;	author espie;	state Exp;
branches;
next	1.1117;

1.1117
date	2011.10.21.16.35.14;	author espie;	state Exp;
branches;
next	1.1116;

1.1116
date	2011.10.16.07.51.27;	author espie;	state Exp;
branches;
next	1.1115;

1.1115
date	2011.10.16.07.12.35;	author espie;	state Exp;
branches;
next	1.1114;

1.1114
date	2011.10.03.15.46.33;	author espie;	state Exp;
branches;
next	1.1113;

1.1113
date	2011.09.30.05.35.52;	author espie;	state Exp;
branches;
next	1.1112;

1.1112
date	2011.09.28.10.20.19;	author espie;	state Exp;
branches;
next	1.1111;

1.1111
date	2011.09.25.21.30.04;	author naddy;	state Exp;
branches;
next	1.1110;

1.1110
date	2011.09.25.07.59.49;	author espie;	state Exp;
branches;
next	1.1109;

1.1109
date	2011.09.21.09.02.09;	author espie;	state Exp;
branches;
next	1.1108;

1.1108
date	2011.09.20.09.36.13;	author sthen;	state Exp;
branches;
next	1.1107;

1.1107
date	2011.09.16.20.02.20;	author kili;	state Exp;
branches;
next	1.1106;

1.1106
date	2011.09.16.08.26.11;	author espie;	state Exp;
branches;
next	1.1105;

1.1105
date	2011.09.15.17.19.36;	author espie;	state Exp;
branches;
next	1.1104;

1.1104
date	2011.09.10.08.20.56;	author espie;	state Exp;
branches;
next	1.1103;

1.1103
date	2011.09.10.08.05.12;	author espie;	state Exp;
branches;
next	1.1102;

1.1102
date	2011.09.03.13.39.56;	author espie;	state Exp;
branches;
next	1.1101;

1.1101
date	2011.07.20.08.46.20;	author sthen;	state Exp;
branches;
next	1.1100;

1.1100
date	2011.07.15.23.11.00;	author fgsch;	state Exp;
branches;
next	1.1099;

1.1099
date	2011.07.12.10.04.00;	author espie;	state Exp;
branches;
next	1.1098;

1.1098
date	2011.07.12.08.08.01;	author ajacoutot;	state Exp;
branches;
next	1.1097;

1.1097
date	2011.07.12.04.26.47;	author ajacoutot;	state Exp;
branches;
next	1.1096;

1.1096
date	2011.07.11.12.21.53;	author jasper;	state Exp;
branches;
next	1.1095;

1.1095
date	2011.07.10.17.15.08;	author jasper;	state Exp;
branches;
next	1.1094;

1.1094
date	2011.07.08.22.44.16;	author ajacoutot;	state Exp;
branches;
next	1.1093;

1.1093
date	2011.07.08.05.17.40;	author naddy;	state Exp;
branches;
next	1.1092;

1.1092
date	2011.07.05.15.11.20;	author sthen;	state Exp;
branches;
next	1.1091;

1.1091
date	2011.06.26.14.40.21;	author espie;	state Exp;
branches;
next	1.1090;

1.1090
date	2011.06.24.14.44.05;	author espie;	state Exp;
branches;
next	1.1089;

1.1089
date	2011.06.24.14.34.15;	author espie;	state Exp;
branches;
next	1.1088;

1.1088
date	2011.06.23.22.03.15;	author espie;	state Exp;
branches;
next	1.1087;

1.1087
date	2011.06.23.21.49.18;	author espie;	state Exp;
branches;
next	1.1086;

1.1086
date	2011.06.21.17.11.45;	author espie;	state Exp;
branches;
next	1.1085;

1.1085
date	2011.06.21.17.04.32;	author espie;	state Exp;
branches;
next	1.1084;

1.1084
date	2011.06.15.16.31.11;	author espie;	state Exp;
branches;
next	1.1083;

1.1083
date	2011.06.15.16.29.48;	author espie;	state Exp;
branches;
next	1.1082;

1.1082
date	2011.06.01.16.04.12;	author ajacoutot;	state Exp;
branches;
next	1.1081;

1.1081
date	2011.06.01.12.04.06;	author espie;	state Exp;
branches;
next	1.1080;

1.1080
date	2011.05.16.23.40.24;	author espie;	state Exp;
branches;
next	1.1079;

1.1079
date	2011.04.23.08.25.50;	author kili;	state Exp;
branches;
next	1.1078;

1.1078
date	2011.04.16.12.21.44;	author espie;	state Exp;
branches;
next	1.1077;

1.1077
date	2011.04.16.10.31.20;	author espie;	state Exp;
branches;
next	1.1076;

1.1076
date	2011.04.10.17.55.41;	author jasper;	state Exp;
branches;
next	1.1075;

1.1075
date	2011.04.03.07.19.05;	author espie;	state Exp;
branches;
next	1.1074;

1.1074
date	2011.03.28.00.16.13;	author fgsch;	state Exp;
branches;
next	1.1073;

1.1073
date	2011.03.21.09.38.53;	author sthen;	state Exp;
branches;
next	1.1072;

1.1072
date	2011.03.20.19.28.07;	author espie;	state Exp;
branches;
next	1.1071;

1.1071
date	2011.01.16.20.36.49;	author ajacoutot;	state Exp;
branches;
next	1.1070;

1.1070
date	2011.01.10.12.59.36;	author espie;	state Exp;
branches;
next	1.1069;

1.1069
date	2011.01.09.13.07.53;	author espie;	state Exp;
branches;
next	1.1068;

1.1068
date	2011.01.04.21.54.36;	author espie;	state Exp;
branches;
next	1.1067;

1.1067
date	2010.12.20.13.05.40;	author espie;	state Exp;
branches;
next	1.1066;

1.1066
date	2010.12.14.11.37.38;	author espie;	state Exp;
branches;
next	1.1065;

1.1065
date	2010.12.07.11.26.37;	author espie;	state Exp;
branches;
next	1.1064;

1.1064
date	2010.11.25.18.06.37;	author espie;	state Exp;
branches;
next	1.1063;

1.1063
date	2010.11.23.18.34.20;	author espie;	state Exp;
branches;
next	1.1062;

1.1062
date	2010.11.20.19.57.59;	author espie;	state Exp;
branches;
next	1.1061;

1.1061
date	2010.11.16.19.26.18;	author espie;	state Exp;
branches;
next	1.1060;

1.1060
date	2010.11.16.09.39.45;	author espie;	state Exp;
branches;
next	1.1059;

1.1059
date	2010.11.16.09.16.26;	author espie;	state Exp;
branches;
next	1.1058;

1.1058
date	2010.11.14.11.17.36;	author espie;	state Exp;
branches;
next	1.1057;

1.1057
date	2010.11.11.19.03.25;	author espie;	state Exp;
branches;
next	1.1056;

1.1056
date	2010.11.11.12.38.51;	author espie;	state Exp;
branches;
next	1.1055;

1.1055
date	2010.11.09.23.55.28;	author espie;	state Exp;
branches;
next	1.1054;

1.1054
date	2010.11.09.11.18.47;	author espie;	state Exp;
branches;
next	1.1053;

1.1053
date	2010.11.07.00.03.38;	author espie;	state Exp;
branches;
next	1.1052;

1.1052
date	2010.10.28.22.39.44;	author sthen;	state Exp;
branches;
next	1.1051;

1.1051
date	2010.10.28.21.09.52;	author jasper;	state Exp;
branches;
next	1.1050;

1.1050
date	2010.10.28.14.26.36;	author espie;	state Exp;
branches;
next	1.1049;

1.1049
date	2010.10.28.11.14.23;	author espie;	state Exp;
branches;
next	1.1048;

1.1048
date	2010.10.27.17.38.18;	author espie;	state Exp;
branches;
next	1.1047;

1.1047
date	2010.10.27.14.34.33;	author espie;	state Exp;
branches;
next	1.1046;

1.1046
date	2010.10.27.14.29.01;	author espie;	state Exp;
branches;
next	1.1045;

1.1045
date	2010.10.26.17.04.20;	author espie;	state Exp;
branches;
next	1.1044;

1.1044
date	2010.10.26.10.39.22;	author ajacoutot;	state Exp;
branches;
next	1.1043;

1.1043
date	2010.10.24.20.41.23;	author ajacoutot;	state Exp;
branches;
next	1.1042;

1.1042
date	2010.10.22.15.51.07;	author espie;	state Exp;
branches;
next	1.1041;

1.1041
date	2010.10.18.08.32.21;	author espie;	state Exp;
branches;
next	1.1040;

1.1040
date	2010.10.02.10.25.21;	author espie;	state Exp;
branches;
next	1.1039;

1.1039
date	2010.09.25.13.39.02;	author steven;	state Exp;
branches;
next	1.1038;

1.1038
date	2010.09.24.15.25.21;	author jasper;	state Exp;
branches;
next	1.1037;

1.1037
date	2010.09.24.13.37.53;	author jasper;	state Exp;
branches;
next	1.1036;

1.1036
date	2010.09.24.13.13.46;	author espie;	state Exp;
branches;
next	1.1035;

1.1035
date	2010.09.24.09.20.16;	author espie;	state Exp;
branches;
next	1.1034;

1.1034
date	2010.09.22.18.43.30;	author landry;	state Exp;
branches;
next	1.1033;

1.1033
date	2010.09.21.15.18.03;	author sthen;	state Exp;
branches;
next	1.1032;

1.1032
date	2010.09.13.11.04.31;	author espie;	state Exp;
branches;
next	1.1031;

1.1031
date	2010.09.09.15.06.42;	author jasper;	state Exp;
branches;
next	1.1030;

1.1030
date	2010.09.06.12.06.29;	author jasper;	state Exp;
branches;
next	1.1029;

1.1029
date	2010.08.31.19.30.43;	author sthen;	state Exp;
branches;
next	1.1028;

1.1028
date	2010.08.20.23.11.07;	author espie;	state Exp;
branches;
next	1.1027;

1.1027
date	2010.08.20.14.53.18;	author espie;	state Exp;
branches;
next	1.1026;

1.1026
date	2010.08.07.19.41.21;	author espie;	state Exp;
branches;
next	1.1025;

1.1025
date	2010.07.24.10.35.38;	author espie;	state Exp;
branches;
next	1.1024;

1.1024
date	2010.07.21.17.11.48;	author steven;	state Exp;
branches;
next	1.1023;

1.1023
date	2010.07.18.18.49.01;	author naddy;	state Exp;
branches;
next	1.1022;

1.1022
date	2010.07.10.15.21.15;	author espie;	state Exp;
branches;
next	1.1021;

1.1021
date	2010.07.10.15.17.40;	author espie;	state Exp;
branches;
next	1.1020;

1.1020
date	2010.07.10.13.29.48;	author espie;	state Exp;
branches;
next	1.1019;

1.1019
date	2010.07.10.09.11.10;	author espie;	state Exp;
branches;
next	1.1018;

1.1018
date	2010.07.09.13.11.59;	author espie;	state Exp;
branches;
next	1.1017;

1.1017
date	2010.07.08.20.48.39;	author espie;	state Exp;
branches;
next	1.1016;

1.1016
date	2010.07.06.12.38.26;	author espie;	state Exp;
branches;
next	1.1015;

1.1015
date	2010.07.06.12.09.55;	author espie;	state Exp;
branches;
next	1.1014;

1.1014
date	2010.07.06.12.02.35;	author espie;	state Exp;
branches;
next	1.1013;

1.1013
date	2010.07.06.11.50.57;	author espie;	state Exp;
branches;
next	1.1012;

1.1012
date	2010.07.06.11.27.38;	author espie;	state Exp;
branches;
next	1.1011;

1.1011
date	2010.07.05.09.00.28;	author espie;	state Exp;
branches;
next	1.1010;

1.1010
date	2010.07.05.08.58.09;	author espie;	state Exp;
branches;
next	1.1009;

1.1009
date	2010.07.04.17.26.14;	author espie;	state Exp;
branches;
next	1.1008;

1.1008
date	2010.07.04.08.45.02;	author espie;	state Exp;
branches;
next	1.1007;

1.1007
date	2010.06.20.07.48.20;	author espie;	state Exp;
branches;
next	1.1006;

1.1006
date	2010.06.17.03.31.33;	author william;	state Exp;
branches;
next	1.1005;

1.1005
date	2010.06.16.12.22.20;	author espie;	state Exp;
branches;
next	1.1004;

1.1004
date	2010.06.16.12.06.46;	author espie;	state Exp;
branches;
next	1.1003;

1.1003
date	2010.06.15.11.42.21;	author kili;	state Exp;
branches;
next	1.1002;

1.1002
date	2010.06.14.12.02.43;	author espie;	state Exp;
branches;
next	1.1001;

1.1001
date	2010.06.14.12.01.19;	author espie;	state Exp;
branches;
next	1.1000;

1.1000
date	2010.06.14.11.49.03;	author espie;	state Exp;
branches;
next	1.999;

1.999
date	2010.05.28.12.34.22;	author espie;	state Exp;
branches;
next	1.998;

1.998
date	2010.05.28.10.09.58;	author espie;	state Exp;
branches;
next	1.997;

1.997
date	2010.05.23.09.22.50;	author espie;	state Exp;
branches;
next	1.996;

1.996
date	2010.05.16.10.33.32;	author espie;	state Exp;
branches;
next	1.995;

1.995
date	2010.04.24.09.54.42;	author ajacoutot;	state Exp;
branches;
next	1.994;

1.994
date	2010.04.20.21.00.35;	author espie;	state Exp;
branches;
next	1.993;

1.993
date	2010.04.20.19.58.09;	author landry;	state Exp;
branches;
next	1.992;

1.992
date	2010.04.20.10.15.09;	author espie;	state Exp;
branches;
next	1.991;

1.991
date	2010.04.17.10.16.11;	author espie;	state Exp;
branches;
next	1.990;

1.990
date	2010.04.17.09.49.52;	author espie;	state Exp;
branches;
next	1.989;

1.989
date	2010.04.12.13.08.20;	author espie;	state Exp;
branches;
next	1.988;

1.988
date	2010.04.05.14.03.26;	author espie;	state Exp;
branches;
next	1.987;

1.987
date	2010.04.05.14.02.50;	author espie;	state Exp;
branches;
next	1.986;

1.986
date	2010.03.22.20.19.12;	author espie;	state Exp;
branches;
next	1.985;

1.985
date	2010.03.21.17.12.10;	author espie;	state Exp;
branches;
next	1.984;

1.984
date	2010.03.21.17.00.46;	author espie;	state Exp;
branches;
next	1.983;

1.983
date	2010.03.21.11.34.38;	author ajacoutot;	state Exp;
branches;
next	1.982;

1.982
date	2010.03.20.19.14.49;	author espie;	state Exp;
branches;
next	1.981;

1.981
date	2010.03.20.19.14.06;	author espie;	state Exp;
branches;
next	1.980;

1.980
date	2010.03.20.19.11.51;	author espie;	state Exp;
branches;
next	1.979;

1.979
date	2010.03.05.07.49.29;	author espie;	state Exp;
branches;
next	1.978;

1.978
date	2010.02.26.19.20.24;	author espie;	state Exp;
branches;
next	1.977;

1.977
date	2010.02.26.19.05.23;	author espie;	state Exp;
branches;
next	1.976;

1.976
date	2010.02.13.21.11.35;	author espie;	state Exp;
branches;
next	1.975;

1.975
date	2010.02.12.12.00.19;	author espie;	state Exp;
branches;
next	1.974;

1.974
date	2010.02.05.13.06.03;	author jasper;	state Exp;
branches;
next	1.973;

1.973
date	2010.01.28.10.09.06;	author espie;	state Exp;
branches;
next	1.972;

1.972
date	2009.10.14.13.01.03;	author steven;	state Exp;
branches;
next	1.971;

1.971
date	2009.10.13.14.39.23;	author landry;	state Exp;
branches;
next	1.970;

1.970
date	2009.07.26.12.14.05;	author espie;	state Exp;
branches;
next	1.969;

1.969
date	2009.07.15.23.44.36;	author espie;	state Exp;
branches;
next	1.968;

1.968
date	2009.07.13.12.21.44;	author espie;	state Exp;
branches;
next	1.967;

1.967
date	2009.06.17.13.42.49;	author landry;	state Exp;
branches;
next	1.966;

1.966
date	2009.06.12.17.26.51;	author sthen;	state Exp;
branches;
next	1.965;

1.965
date	2009.06.12.13.39.30;	author landry;	state Exp;
branches;
next	1.964;

1.964
date	2009.06.09.17.46.58;	author espie;	state Exp;
branches;
next	1.963;

1.963
date	2009.05.16.22.18.50;	author simon;	state Exp;
branches;
next	1.962;

1.962
date	2009.05.05.20.58.38;	author martynas;	state Exp;
branches;
next	1.961;

1.961
date	2009.04.24.08.53.33;	author espie;	state Exp;
branches;
next	1.960;

1.960
date	2009.04.11.14.55.31;	author espie;	state Exp;
branches;
next	1.959;

1.959
date	2009.01.05.12.43.49;	author ajacoutot;	state Exp;
branches;
next	1.958;

1.958
date	2008.11.18.11.45.41;	author espie;	state Exp;
branches;
next	1.957;

1.957
date	2008.10.25.15.06.26;	author bernd;	state Exp;
branches;
next	1.956;

1.956
date	2008.09.19.13.00.30;	author espie;	state Exp;
branches;
next	1.955;

1.955
date	2008.09.17.13.42.10;	author ajacoutot;	state Exp;
branches;
next	1.954;

1.954
date	2008.08.20.10.33.50;	author simon;	state Exp;
branches;
next	1.953;

1.953
date	2008.08.20.08.56.53;	author espie;	state Exp;
branches;
next	1.952;

1.952
date	2008.08.19.23.49.32;	author espie;	state Exp;
branches;
next	1.951;

1.951
date	2008.07.29.17.54.52;	author espie;	state Exp;
branches;
next	1.950;

1.950
date	2008.07.29.11.25.44;	author espie;	state Exp;
branches;
next	1.949;

1.949
date	2008.07.26.12.23.43;	author espie;	state Exp;
branches;
next	1.948;

1.948
date	2008.07.26.11.22.59;	author espie;	state Exp;
branches;
next	1.947;

1.947
date	2008.07.26.11.16.04;	author espie;	state Exp;
branches;
next	1.946;

1.946
date	2008.07.26.11.14.07;	author espie;	state Exp;
branches;
next	1.945;

1.945
date	2008.07.26.10.59.20;	author espie;	state Exp;
branches;
next	1.944;

1.944
date	2008.07.03.17.36.47;	author sturm;	state Exp;
branches;
next	1.943;

1.943
date	2008.07.03.15.43.22;	author espie;	state Exp;
branches;
next	1.942;

1.942
date	2008.06.06.01.17.13;	author fgsch;	state Exp;
branches;
next	1.941;

1.941
date	2008.06.05.08.14.00;	author fgsch;	state Exp;
branches;
next	1.940;

1.940
date	2008.05.18.11.22.14;	author espie;	state Exp;
branches;
next	1.939;

1.939
date	2008.05.18.10.05.21;	author espie;	state Exp;
branches;
next	1.938;

1.938
date	2008.05.18.09.58.09;	author espie;	state Exp;
branches;
next	1.937;

1.937
date	2008.05.15.10.09.29;	author espie;	state Exp;
branches;
next	1.936;

1.936
date	2008.05.15.09.57.03;	author espie;	state Exp;
branches;
next	1.935;

1.935
date	2008.05.15.09.51.17;	author espie;	state Exp;
branches;
next	1.934;

1.934
date	2008.05.12.14.45.48;	author deanna;	state Exp;
branches;
next	1.933;

1.933
date	2008.05.11.19.36.12;	author espie;	state Exp;
branches;
next	1.932;

1.932
date	2008.05.11.11.19.19;	author espie;	state Exp;
branches;
next	1.931;

1.931
date	2008.05.11.11.12.09;	author espie;	state Exp;
branches;
next	1.930;

1.930
date	2008.05.08.22.35.51;	author espie;	state Exp;
branches;
next	1.929;

1.929
date	2008.05.06.19.20.16;	author ajacoutot;	state Exp;
branches;
next	1.928;

1.928
date	2008.05.04.12.58.03;	author espie;	state Exp;
branches;
next	1.927;

1.927
date	2008.05.04.12.53.14;	author espie;	state Exp;
branches;
next	1.926;

1.926
date	2008.04.12.13.04.21;	author espie;	state Exp;
branches;
next	1.925;

1.925
date	2008.04.07.11.12.42;	author espie;	state Exp;
branches;
next	1.924;

1.924
date	2008.03.29.01.58.33;	author pvalchev;	state Exp;
branches;
next	1.923;

1.923
date	2008.01.12.14.12.43;	author espie;	state Exp;
branches;
next	1.922;

1.922
date	2008.01.04.18.38.51;	author espie;	state Exp;
branches;
next	1.921;

1.921
date	2008.01.04.17.48.35;	author espie;	state Exp;
branches;
next	1.920;

1.920
date	2007.12.28.12.49.12;	author espie;	state Exp;
branches;
next	1.919;

1.919
date	2007.12.28.12.46.03;	author espie;	state Exp;
branches;
next	1.918;

1.918
date	2007.12.05.06.55.41;	author jolan;	state Exp;
branches;
next	1.917;

1.917
date	2007.12.01.14.44.47;	author merdely;	state Exp;
branches;
next	1.916;

1.916
date	2007.09.30.15.07.40;	author steven;	state Exp;
branches;
next	1.915;

1.915
date	2007.09.21.08.04.06;	author steven;	state Exp;
branches;
next	1.914;

1.914
date	2007.09.21.06.58.21;	author steven;	state Exp;
branches;
next	1.913;

1.913
date	2007.09.16.21.38.34;	author naddy;	state Exp;
branches;
next	1.912;

1.912
date	2007.07.28.12.58.34;	author espie;	state Exp;
branches;
next	1.911;

1.911
date	2007.07.09.13.32.56;	author espie;	state Exp;
branches;
next	1.910;

1.910
date	2007.07.08.17.57.56;	author espie;	state Exp;
branches;
next	1.909;

1.909
date	2007.06.30.14.48.04;	author espie;	state Exp;
branches;
next	1.908;

1.908
date	2007.06.30.14.43.49;	author espie;	state Exp;
branches;
next	1.907;

1.907
date	2007.06.29.10.24.23;	author espie;	state Exp;
branches;
next	1.906;

1.906
date	2007.06.23.09.39.18;	author steven;	state Exp;
branches;
next	1.905;

1.905
date	2007.06.18.23.04.02;	author jakemsr;	state Exp;
branches;
next	1.904;

1.904
date	2007.06.16.09.57.03;	author espie;	state Exp;
branches;
next	1.903;

1.903
date	2007.06.04.12.15.09;	author espie;	state Exp;
branches;
next	1.902;

1.902
date	2007.06.03.22.30.25;	author espie;	state Exp;
branches;
next	1.901;

1.901
date	2007.06.03.12.51.59;	author espie;	state Exp;
branches;
next	1.900;

1.900
date	2007.06.03.11.06.41;	author espie;	state Exp;
branches;
next	1.899;

1.899
date	2007.06.03.11.03.06;	author espie;	state Exp;
branches;
next	1.898;

1.898
date	2007.06.01.13.15.21;	author espie;	state Exp;
branches;
next	1.897;

1.897
date	2007.05.31.10.52.16;	author espie;	state Exp;
branches;
next	1.896;

1.896
date	2007.05.27.11.53.39;	author espie;	state Exp;
branches;
next	1.895;

1.895
date	2007.05.25.13.07.41;	author espie;	state Exp;
branches;
next	1.894;

1.894
date	2007.05.21.11.18.10;	author steven;	state Exp;
branches;
next	1.893;

1.893
date	2007.05.01.17.17.54;	author sturm;	state Exp;
branches;
next	1.892;

1.892
date	2007.04.30.12.44.46;	author espie;	state Exp;
branches;
next	1.891;

1.891
date	2007.04.08.11.26.39;	author espie;	state Exp;
branches;
next	1.890;

1.890
date	2007.04.05.18.32.26;	author espie;	state Exp;
branches;
next	1.889;

1.889
date	2007.04.03.13.32.45;	author espie;	state Exp;
branches;
next	1.888;

1.888
date	2007.04.03.10.14.14;	author espie;	state Exp;
branches;
next	1.887;

1.887
date	2007.03.31.15.36.43;	author espie;	state Exp;
branches;
next	1.886;

1.886
date	2007.03.30.13.44.50;	author espie;	state Exp;
branches;
next	1.885;

1.885
date	2007.03.30.13.41.44;	author espie;	state Exp;
branches;
next	1.884;

1.884
date	2007.03.28.15.45.03;	author espie;	state Exp;
branches;
next	1.883;

1.883
date	2007.03.28.13.21.43;	author espie;	state Exp;
branches;
next	1.882;

1.882
date	2007.03.15.18.11.54;	author naddy;	state Exp;
branches;
next	1.881;

1.881
date	2007.02.16.19.08.54;	author espie;	state Exp;
branches;
next	1.880;

1.880
date	2007.02.11.11.44.17;	author espie;	state Exp;
branches;
next	1.879;

1.879
date	2007.02.06.20.04.01;	author espie;	state Exp;
branches;
next	1.878;

1.878
date	2007.01.15.13.43.52;	author espie;	state Exp;
branches;
next	1.877;

1.877
date	2007.01.04.11.34.14;	author bernd;	state Exp;
branches;
next	1.876;

1.876
date	2006.12.31.13.12.35;	author espie;	state Exp;
branches;
next	1.875;

1.875
date	2006.12.18.12.52.34;	author espie;	state Exp;
branches;
next	1.874;

1.874
date	2006.12.16.11.53.46;	author espie;	state Exp;
branches;
next	1.873;

1.873
date	2006.12.11.15.52.14;	author espie;	state Exp;
branches;
next	1.872;

1.872
date	2006.12.11.14.01.03;	author steven;	state Exp;
branches;
next	1.871;

1.871
date	2006.12.11.13.36.06;	author espie;	state Exp;
branches;
next	1.870;

1.870
date	2006.12.11.11.05.43;	author espie;	state Exp;
branches;
next	1.869;

1.869
date	2006.12.09.14.56.41;	author espie;	state Exp;
branches;
next	1.868;

1.868
date	2006.12.08.10.19.08;	author espie;	state Exp;
branches;
next	1.867;

1.867
date	2006.12.05.19.23.42;	author espie;	state Exp;
branches;
next	1.866;

1.866
date	2006.12.02.11.27.46;	author espie;	state Exp;
branches;
next	1.865;

1.865
date	2006.12.02.11.08.49;	author espie;	state Exp;
branches;
next	1.864;

1.864
date	2006.12.02.10.27.40;	author espie;	state Exp;
branches;
next	1.863;

1.863
date	2006.12.01.17.56.38;	author espie;	state Exp;
branches;
next	1.862;

1.862
date	2006.12.01.17.37.15;	author espie;	state Exp;
branches;
next	1.861;

1.861
date	2006.12.01.17.33.16;	author espie;	state Exp;
branches;
next	1.860;

1.860
date	2006.12.01.11.34.04;	author espie;	state Exp;
branches;
next	1.859;

1.859
date	2006.11.30.23.08.07;	author espie;	state Exp;
branches;
next	1.858;

1.858
date	2006.11.29.09.42.08;	author espie;	state Exp;
branches;
next	1.857;

1.857
date	2006.11.28.23.13.30;	author espie;	state Exp;
branches;
next	1.856;

1.856
date	2006.11.28.20.40.55;	author espie;	state Exp;
branches;
next	1.855;

1.855
date	2006.11.28.20.31.25;	author espie;	state Exp;
branches;
next	1.854;

1.854
date	2006.11.28.20.26.38;	author espie;	state Exp;
branches;
next	1.853;

1.853
date	2006.11.28.20.20.25;	author espie;	state Exp;
branches;
next	1.852;

1.852
date	2006.11.28.19.59.15;	author espie;	state Exp;
branches;
next	1.851;

1.851
date	2006.11.28.19.13.47;	author espie;	state Exp;
branches;
next	1.850;

1.850
date	2006.11.28.18.25.42;	author espie;	state Exp;
branches;
next	1.849;

1.849
date	2006.11.28.18.17.57;	author espie;	state Exp;
branches;
next	1.848;

1.848
date	2006.11.28.16.28.56;	author espie;	state Exp;
branches;
next	1.847;

1.847
date	2006.11.28.16.24.00;	author espie;	state Exp;
branches;
next	1.846;

1.846
date	2006.11.27.20.29.50;	author espie;	state Exp;
branches;
next	1.845;

1.845
date	2006.11.27.19.09.19;	author espie;	state Exp;
branches;
next	1.844;

1.844
date	2006.11.27.17.30.18;	author espie;	state Exp;
branches;
next	1.843;

1.843
date	2006.11.27.16.08.05;	author espie;	state Exp;
branches;
next	1.842;

1.842
date	2006.11.27.15.28.40;	author espie;	state Exp;
branches;
next	1.841;

1.841
date	2006.11.26.23.39.41;	author espie;	state Exp;
branches;
next	1.840;

1.840
date	2006.11.26.20.02.28;	author espie;	state Exp;
branches;
next	1.839;

1.839
date	2006.11.26.19.46.16;	author espie;	state Exp;
branches;
next	1.838;

1.838
date	2006.11.26.19.12.20;	author espie;	state Exp;
branches;
next	1.837;

1.837
date	2006.11.26.17.45.59;	author espie;	state Exp;
branches;
next	1.836;

1.836
date	2006.11.26.17.36.07;	author espie;	state Exp;
branches;
next	1.835;

1.835
date	2006.11.25.19.47.53;	author espie;	state Exp;
branches;
next	1.834;

1.834
date	2006.11.25.18.31.23;	author espie;	state Exp;
branches;
next	1.833;

1.833
date	2006.11.24.16.49.37;	author espie;	state Exp;
branches;
next	1.832;

1.832
date	2006.11.24.00.10.00;	author espie;	state Exp;
branches;
next	1.831;

1.831
date	2006.11.22.12.40.50;	author espie;	state Exp;
branches;
next	1.830;

1.830
date	2006.11.22.08.20.20;	author espie;	state Exp;
branches;
next	1.829;

1.829
date	2006.11.21.10.32.51;	author bernd;	state Exp;
branches;
next	1.828;

1.828
date	2006.11.20.23.18.25;	author steven;	state Exp;
branches;
next	1.827;

1.827
date	2006.11.20.13.50.16;	author espie;	state Exp;
branches;
next	1.826;

1.826
date	2006.11.20.12.34.52;	author espie;	state Exp;
branches;
next	1.825;

1.825
date	2006.11.20.12.04.40;	author espie;	state Exp;
branches;
next	1.824;

1.824
date	2006.11.20.11.15.39;	author espie;	state Exp;
branches;
next	1.823;

1.823
date	2006.11.20.11.11.38;	author espie;	state Exp;
branches;
next	1.822;

1.822
date	2006.11.20.10.49.22;	author espie;	state Exp;
branches;
next	1.821;

1.821
date	2006.11.20.10.38.31;	author espie;	state Exp;
branches;
next	1.820;

1.820
date	2006.11.20.10.36.13;	author espie;	state Exp;
branches;
next	1.819;

1.819
date	2006.11.20.09.59.11;	author espie;	state Exp;
branches;
next	1.818;

1.818
date	2006.11.20.09.46.56;	author espie;	state Exp;
branches;
next	1.817;

1.817
date	2006.11.19.19.52.03;	author sturm;	state Exp;
branches;
next	1.816;

1.816
date	2006.11.19.18.20.01;	author espie;	state Exp;
branches;
next	1.815;

1.815
date	2006.11.19.18.07.38;	author espie;	state Exp;
branches;
next	1.814;

1.814
date	2006.11.19.18.01.44;	author espie;	state Exp;
branches;
next	1.813;

1.813
date	2006.11.19.17.52.32;	author espie;	state Exp;
branches;
next	1.812;

1.812
date	2006.11.19.17.48.14;	author espie;	state Exp;
branches;
next	1.811;

1.811
date	2006.11.19.17.40.35;	author espie;	state Exp;
branches;
next	1.810;

1.810
date	2006.11.19.17.39.15;	author espie;	state Exp;
branches;
next	1.809;

1.809
date	2006.11.19.16.39.41;	author espie;	state Exp;
branches;
next	1.808;

1.808
date	2006.11.19.12.37.55;	author espie;	state Exp;
branches;
next	1.807;

1.807
date	2006.11.19.12.32.53;	author espie;	state Exp;
branches;
next	1.806;

1.806
date	2006.11.19.12.11.30;	author espie;	state Exp;
branches;
next	1.805;

1.805
date	2006.11.19.12.05.10;	author espie;	state Exp;
branches;
next	1.804;

1.804
date	2006.11.18.00.15.33;	author espie;	state Exp;
branches;
next	1.803;

1.803
date	2006.11.17.17.16.16;	author espie;	state Exp;
branches;
next	1.802;

1.802
date	2006.11.13.14.14.57;	author espie;	state Exp;
branches;
next	1.801;

1.801
date	2006.11.13.13.55.10;	author espie;	state Exp;
branches;
next	1.800;

1.800
date	2006.11.12.10.52.59;	author espie;	state Exp;
branches;
next	1.799;

1.799
date	2006.11.11.16.32.12;	author espie;	state Exp;
branches;
next	1.798;

1.798
date	2006.11.11.16.10.36;	author espie;	state Exp;
branches;
next	1.797;

1.797
date	2006.11.09.08.29.47;	author espie;	state Exp;
branches;
next	1.796;

1.796
date	2006.11.09.08.16.22;	author espie;	state Exp;
branches;
next	1.795;

1.795
date	2006.11.05.20.20.28;	author espie;	state Exp;
branches;
next	1.794;

1.794
date	2006.11.05.15.46.51;	author espie;	state Exp;
branches;
next	1.793;

1.793
date	2006.11.03.17.03.28;	author espie;	state Exp;
branches;
next	1.792;

1.792
date	2006.11.01.12.41.34;	author espie;	state Exp;
branches;
next	1.791;

1.791
date	2006.10.23.14.33.01;	author espie;	state Exp;
branches;
next	1.790;

1.790
date	2006.10.23.13.42.50;	author espie;	state Exp;
branches;
next	1.789;

1.789
date	2006.10.21.12.46.09;	author espie;	state Exp;
branches;
next	1.788;

1.788
date	2006.10.21.12.10.35;	author espie;	state Exp;
branches;
next	1.787;

1.787
date	2006.10.21.11.50.48;	author espie;	state Exp;
branches;
next	1.786;

1.786
date	2006.10.21.11.20.36;	author espie;	state Exp;
branches;
next	1.785;

1.785
date	2006.10.18.16.53.04;	author sturm;	state Exp;
branches;
next	1.784;

1.784
date	2006.10.18.11.09.30;	author espie;	state Exp;
branches;
next	1.783;

1.783
date	2006.10.18.10.51.39;	author espie;	state Exp;
branches;
next	1.782;

1.782
date	2006.10.17.22.32.45;	author espie;	state Exp;
branches;
next	1.781;

1.781
date	2006.10.16.10.39.40;	author espie;	state Exp;
branches;
next	1.780;

1.780
date	2006.10.15.19.29.06;	author espie;	state Exp;
branches;
next	1.779;

1.779
date	2006.10.15.09.22.49;	author espie;	state Exp;
branches;
next	1.778;

1.778
date	2006.10.15.09.20.53;	author espie;	state Exp;
branches;
next	1.777;

1.777
date	2006.10.12.08.45.56;	author espie;	state Exp;
branches;
next	1.776;

1.776
date	2006.10.09.18.11.38;	author espie;	state Exp;
branches;
next	1.775;

1.775
date	2006.10.02.17.26.34;	author espie;	state Exp;
branches;
next	1.774;

1.774
date	2006.10.02.09.37.14;	author espie;	state Exp;
branches;
next	1.773;

1.773
date	2006.09.27.10.09.34;	author espie;	state Exp;
branches;
next	1.772;

1.772
date	2006.09.23.09.40.06;	author espie;	state Exp;
branches;
next	1.771;

1.771
date	2006.09.21.11.31.33;	author bernd;	state Exp;
branches;
next	1.770;

1.770
date	2006.09.19.20.10.40;	author espie;	state Exp;
branches;
next	1.769;

1.769
date	2006.09.19.19.54.14;	author espie;	state Exp;
branches;
next	1.768;

1.768
date	2006.09.19.11.25.17;	author espie;	state Exp;
branches;
next	1.767;

1.767
date	2006.09.18.18.17.30;	author espie;	state Exp;
branches;
next	1.766;

1.766
date	2006.09.18.08.16.19;	author espie;	state Exp;
branches;
next	1.765;

1.765
date	2006.09.17.22.08.19;	author espie;	state Exp;
branches;
next	1.764;

1.764
date	2006.09.17.19.08.59;	author espie;	state Exp;
branches;
next	1.763;

1.763
date	2006.08.07.08.57.18;	author espie;	state Exp;
branches;
next	1.762;

1.762
date	2006.08.07.08.47.28;	author espie;	state Exp;
branches;
next	1.761;

1.761
date	2006.08.04.23.29.47;	author espie;	state Exp;
branches;
next	1.760;

1.760
date	2006.08.01.10.50.19;	author espie;	state Exp;
branches;
next	1.759;

1.759
date	2006.08.01.10.00.54;	author espie;	state Exp;
branches;
next	1.758;

1.758
date	2006.07.17.16.23.14;	author steven;	state Exp;
branches;
next	1.757;

1.757
date	2006.07.13.14.43.25;	author steven;	state Exp;
branches;
next	1.756;

1.756
date	2006.07.11.06.34.32;	author espie;	state Exp;
branches;
next	1.755;

1.755
date	2006.07.10.10.52.08;	author espie;	state Exp;
branches;
next	1.754;

1.754
date	2006.07.10.10.35.50;	author espie;	state Exp;
branches;
next	1.753;

1.753
date	2006.07.09.11.23.50;	author espie;	state Exp;
branches;
next	1.752;

1.752
date	2006.07.09.11.10.16;	author espie;	state Exp;
branches;
next	1.751;

1.751
date	2006.07.08.09.20.30;	author espie;	state Exp;
branches;
next	1.750;

1.750
date	2006.07.01.11.08.05;	author espie;	state Exp;
branches;
next	1.749;

1.749
date	2006.06.18.10.10.04;	author sturm;	state Exp;
branches;
next	1.748;

1.748
date	2006.06.16.18.48.58;	author sturm;	state Exp;
branches;
next	1.747;

1.747
date	2006.06.04.14.56.10;	author espie;	state Exp;
branches;
next	1.746;

1.746
date	2006.03.24.19.28.13;	author espie;	state Exp;
branches;
next	1.745;

1.745
date	2006.02.06.22.01.48;	author steven;	state Exp;
branches;
next	1.744;

1.744
date	2006.02.06.17.09.08;	author jolan;	state Exp;
branches;
next	1.743;

1.743
date	2006.01.05.19.33.17;	author espie;	state Exp;
branches;
next	1.742;

1.742
date	2005.12.29.12.48.04;	author espie;	state Exp;
branches;
next	1.741;

1.741
date	2005.12.23.12.41.37;	author espie;	state Exp;
branches;
next	1.740;

1.740
date	2005.11.27.12.31.18;	author espie;	state Exp;
branches;
next	1.739;

1.739
date	2005.11.27.12.15.59;	author sturm;	state Exp;
branches;
next	1.738;

1.738
date	2005.11.15.18.14.56;	author espie;	state Exp;
branches;
next	1.737;

1.737
date	2005.11.11.11.31.53;	author espie;	state Exp;
branches;
next	1.736;

1.736
date	2005.11.05.23.54.53;	author espie;	state Exp;
branches;
next	1.735;

1.735
date	2005.11.05.23.41.36;	author espie;	state Exp;
branches;
next	1.734;

1.734
date	2005.11.05.23.39.51;	author espie;	state Exp;
branches;
next	1.733;

1.733
date	2005.11.05.11.16.17;	author espie;	state Exp;
branches;
next	1.732;

1.732
date	2005.11.05.11.11.17;	author espie;	state Exp;
branches;
next	1.731;

1.731
date	2005.11.05.10.35.02;	author sturm;	state Exp;
branches;
next	1.730;

1.730
date	2005.11.04.09.40.30;	author espie;	state Exp;
branches;
next	1.729;

1.729
date	2005.11.04.09.34.50;	author sturm;	state Exp;
branches;
next	1.728;

1.728
date	2005.11.03.22.33.04;	author david;	state Exp;
branches;
next	1.727;

1.727
date	2005.11.03.19.32.25;	author espie;	state Exp;
branches;
next	1.726;

1.726
date	2005.11.03.17.23.30;	author espie;	state Exp;
branches;
next	1.725;

1.725
date	2005.11.02.20.30.12;	author espie;	state Exp;
branches;
next	1.724;

1.724
date	2005.11.02.20.28.11;	author espie;	state Exp;
branches;
next	1.723;

1.723
date	2005.11.01.20.39.00;	author espie;	state Exp;
branches;
next	1.722;

1.722
date	2005.11.01.14.15.01;	author espie;	state Exp;
branches;
next	1.721;

1.721
date	2005.11.01.14.04.21;	author espie;	state Exp;
branches;
next	1.720;

1.720
date	2005.11.01.13.56.30;	author espie;	state Exp;
branches;
next	1.719;

1.719
date	2005.10.10.19.20.00;	author espie;	state Exp;
branches;
next	1.718;

1.718
date	2005.10.10.16.07.33;	author bernd;	state Exp;
branches;
next	1.717;

1.717
date	2005.10.10.00.29.38;	author espie;	state Exp;
branches;
next	1.716;

1.716
date	2005.10.09.23.22.41;	author espie;	state Exp;
branches;
next	1.715;

1.715
date	2005.10.09.13.31.50;	author espie;	state Exp;
branches;
next	1.714;

1.714
date	2005.10.09.12.01.22;	author espie;	state Exp;
branches;
next	1.713;

1.713
date	2005.10.07.21.08.16;	author espie;	state Exp;
branches;
next	1.712;

1.712
date	2005.09.25.09.43.09;	author espie;	state Exp;
branches;
next	1.711;

1.711
date	2005.09.24.19.46.56;	author espie;	state Exp;
branches;
next	1.710;

1.710
date	2005.09.18.12.20.00;	author espie;	state Exp;
branches;
next	1.709;

1.709
date	2005.09.17.14.47.40;	author espie;	state Exp;
branches;
next	1.708;

1.708
date	2005.09.16.09.51.25;	author espie;	state Exp;
branches;
next	1.707;

1.707
date	2005.09.10.18.07.47;	author naddy;	state Exp;
branches;
next	1.706;

1.706
date	2005.09.05.12.43.07;	author espie;	state Exp;
branches;
next	1.705;

1.705
date	2005.09.04.22.32.37;	author espie;	state Exp;
branches;
next	1.704;

1.704
date	2005.07.04.12.32.51;	author espie;	state Exp;
branches;
next	1.703;

1.703
date	2005.06.27.12.48.56;	author espie;	state Exp;
branches;
next	1.702;

1.702
date	2005.06.25.22.12.09;	author espie;	state Exp;
branches;
next	1.701;

1.701
date	2005.06.25.22.01.46;	author espie;	state Exp;
branches;
next	1.700;

1.700
date	2005.06.25.10.51.32;	author espie;	state Exp;
branches;
next	1.699;

1.699
date	2005.06.25.10.40.50;	author espie;	state Exp;
branches;
next	1.698;

1.698
date	2005.04.30.10.43.55;	author alek;	state Exp;
branches;
next	1.697;

1.697
date	2005.04.24.18.02.45;	author espie;	state Exp;
branches;
next	1.696;

1.696
date	2005.04.23.15.24.49;	author espie;	state Exp;
branches;
next	1.695;

1.695
date	2005.04.23.15.12.19;	author espie;	state Exp;
branches;
next	1.694;

1.694
date	2005.04.23.14.31.38;	author espie;	state Exp;
branches;
next	1.693;

1.693
date	2005.04.21.01.44.50;	author alek;	state Exp;
branches;
next	1.692;

1.692
date	2005.04.19.09.21.42;	author espie;	state Exp;
branches;
next	1.691;

1.691
date	2005.04.17.22.51.16;	author espie;	state Exp;
branches;
next	1.690;

1.690
date	2005.04.17.18.31.58;	author espie;	state Exp;
branches;
next	1.689;

1.689
date	2005.04.17.13.21.14;	author espie;	state Exp;
branches;
next	1.688;

1.688
date	2005.04.17.10.10.07;	author espie;	state Exp;
branches;
next	1.687;

1.687
date	2005.04.01.15.55.36;	author jolan;	state Exp;
branches;
next	1.686;

1.686
date	2005.03.30.08.14.01;	author espie;	state Exp;
branches;
next	1.685;

1.685
date	2005.03.13.22.51.34;	author espie;	state Exp;
branches;
next	1.684;

1.684
date	2005.03.09.15.40.37;	author espie;	state Exp;
branches;
next	1.683;

1.683
date	2005.03.09.15.21.07;	author espie;	state Exp;
branches;
next	1.682;

1.682
date	2005.03.06.12.03.58;	author espie;	state Exp;
branches;
next	1.681;

1.681
date	2005.01.31.10.12.24;	author espie;	state Exp;
branches;
next	1.680;

1.680
date	2005.01.31.09.58.22;	author espie;	state Exp;
branches;
next	1.679;

1.679
date	2005.01.31.09.52.53;	author espie;	state Exp;
branches;
next	1.678;

1.678
date	2005.01.13.11.54.55;	author espie;	state Exp;
branches;
next	1.677;

1.677
date	2005.01.06.19.30.34;	author espie;	state Exp;
branches;
next	1.676;

1.676
date	2005.01.04.20.44.45;	author espie;	state Exp;
branches;
next	1.675;

1.675
date	2005.01.02.23.33.09;	author couderc;	state Exp;
branches;
next	1.674;

1.674
date	2005.01.02.20.54.02;	author couderc;	state Exp;
branches;
next	1.673;

1.673
date	2004.12.29.14.30.53;	author naddy;	state Exp;
branches;
next	1.672;

1.672
date	2004.12.21.20.56.54;	author espie;	state Exp;
branches;
next	1.671;

1.671
date	2004.12.19.12.20.12;	author espie;	state Exp;
branches;
next	1.670;

1.670
date	2004.11.28.11.44.00;	author espie;	state Exp;
branches;
next	1.669;

1.669
date	2004.11.27.14.07.19;	author espie;	state Exp;
branches;
next	1.668;

1.668
date	2004.11.27.12.36.14;	author espie;	state Exp;
branches;
next	1.667;

1.667
date	2004.11.27.09.59.35;	author espie;	state Exp;
branches;
next	1.666;

1.666
date	2004.11.21.15.59.25;	author espie;	state Exp;
branches;
next	1.665;

1.665
date	2004.11.21.11.26.22;	author espie;	state Exp;
branches;
next	1.664;

1.664
date	2004.11.21.10.43.48;	author espie;	state Exp;
branches;
next	1.663;

1.663
date	2004.11.19.22.12.28;	author sturm;	state Exp;
branches;
next	1.662;

1.662
date	2004.11.17.11.09.44;	author espie;	state Exp;
branches;
next	1.661;

1.661
date	2004.11.17.10.38.37;	author espie;	state Exp;
branches;
next	1.660;

1.660
date	2004.11.16.02.08.59;	author espie;	state Exp;
branches;
next	1.659;

1.659
date	2004.11.15.16.31.28;	author espie;	state Exp;
branches;
next	1.658;

1.658
date	2004.11.15.13.52.03;	author espie;	state Exp;
branches;
next	1.657;

1.657
date	2004.11.15.11.49.05;	author espie;	state Exp;
branches;
next	1.656;

1.656
date	2004.11.10.23.40.42;	author espie;	state Exp;
branches;
next	1.655;

1.655
date	2004.11.10.10.16.41;	author espie;	state Exp;
branches;
next	1.654;

1.654
date	2004.10.26.06.16.53;	author pvalchev;	state Exp;
branches;
next	1.653;

1.653
date	2004.10.23.10.02.51;	author espie;	state Exp;
branches;
next	1.652;

1.652
date	2004.10.23.09.58.13;	author espie;	state Exp;
branches;
next	1.651;

1.651
date	2004.10.11.10.32.04;	author espie;	state Exp;
branches;
next	1.650;

1.650
date	2004.10.08.19.58.30;	author sturm;	state Exp;
branches;
next	1.649;

1.649
date	2004.09.19.09.00.15;	author pvalchev;	state Exp;
branches;
next	1.648;

1.648
date	2004.09.18.13.48.43;	author espie;	state Exp;
branches;
next	1.647;

1.647
date	2004.09.18.13.45.23;	author espie;	state Exp;
branches;
next	1.646;

1.646
date	2004.09.15.18.58.49;	author espie;	state Exp;
branches;
next	1.645;

1.645
date	2004.09.15.18.57.31;	author espie;	state Exp;
branches;
next	1.644;

1.644
date	2004.09.14.23.07.20;	author espie;	state Exp;
branches;
next	1.643;

1.643
date	2004.09.14.23.06.02;	author espie;	state Exp;
branches;
next	1.642;

1.642
date	2004.08.13.23.28.40;	author brad;	state Exp;
branches;
next	1.641;

1.641
date	2004.08.12.19.02.45;	author espie;	state Exp;
branches;
next	1.640;

1.640
date	2004.08.11.22.42.47;	author espie;	state Exp;
branches;
next	1.639;

1.639
date	2004.08.11.22.25.23;	author espie;	state Exp;
branches;
next	1.638;

1.638
date	2004.08.10.13.48.21;	author espie;	state Exp;
branches;
next	1.637;

1.637
date	2004.08.08.23.14.03;	author espie;	state Exp;
branches;
next	1.636;

1.636
date	2004.08.08.16.43.15;	author espie;	state Exp;
branches;
next	1.635;

1.635
date	2004.08.06.11.31.22;	author espie;	state Exp;
branches;
next	1.634;

1.634
date	2004.08.05.23.43.45;	author espie;	state Exp;
branches;
next	1.633;

1.633
date	2004.08.03.21.18.24;	author espie;	state Exp;
branches;
next	1.632;

1.632
date	2004.08.03.19.30.25;	author espie;	state Exp;
branches;
next	1.631;

1.631
date	2004.08.03.16.18.51;	author espie;	state Exp;
branches;
next	1.630;

1.630
date	2004.08.03.11.16.30;	author espie;	state Exp;
branches;
next	1.629;

1.629
date	2004.08.03.08.04.02;	author espie;	state Exp;
branches;
next	1.628;

1.628
date	2004.08.02.13.01.52;	author espie;	state Exp;
branches;
next	1.627;

1.627
date	2004.08.02.12.10.17;	author espie;	state Exp;
branches;
next	1.626;

1.626
date	2004.07.24.13.53.12;	author espie;	state Exp;
branches;
next	1.625;

1.625
date	2004.07.21.14.45.33;	author espie;	state Exp;
branches;
next	1.624;

1.624
date	2004.07.20.14.23.32;	author espie;	state Exp;
branches;
next	1.623;

1.623
date	2004.07.18.22.45.14;	author espie;	state Exp;
branches;
next	1.622;

1.622
date	2004.07.18.22.44.36;	author espie;	state Exp;
branches;
next	1.621;

1.621
date	2004.07.12.08.45.32;	author espie;	state Exp;
branches;
next	1.620;

1.620
date	2004.07.11.20.44.33;	author espie;	state Exp;
branches;
next	1.619;

1.619
date	2004.06.22.20.05.46;	author sturm;	state Exp;
branches;
next	1.618;

1.618
date	2004.06.22.16.09.05;	author espie;	state Exp;
branches;
next	1.617;

1.617
date	2004.06.06.11.49.08;	author espie;	state Exp;
branches;
next	1.616;

1.616
date	2004.06.01.21.06.29;	author jolan;	state Exp;
branches;
next	1.615;

1.615
date	2004.05.31.12.27.07;	author sturm;	state Exp;
branches;
next	1.614;

1.614
date	2004.05.16.23.14.44;	author pvalchev;	state Exp;
branches;
next	1.613;

1.613
date	2004.05.01.14.27.07;	author sturm;	state Exp;
branches;
next	1.612;

1.612
date	2004.04.19.18.57.54;	author espie;	state Exp;
branches;
next	1.611;

1.611
date	2004.02.07.22.36.13;	author espie;	state Exp;
branches;
next	1.610;

1.610
date	2004.02.07.22.34.02;	author espie;	state Exp;
branches;
next	1.609;

1.609
date	2004.02.07.22.18.49;	author espie;	state Exp;
branches;
next	1.608;

1.608
date	2004.02.07.22.14.21;	author espie;	state Exp;
branches;
next	1.607;

1.607
date	2004.02.07.22.02.40;	author espie;	state Exp;
branches;
next	1.606;

1.606
date	2004.02.01.23.07.30;	author espie;	state Exp;
branches;
next	1.605;

1.605
date	2004.01.28.22.15.21;	author espie;	state Exp;
branches;
next	1.604;

1.604
date	2004.01.28.22.13.40;	author espie;	state Exp;
branches;
next	1.603;

1.603
date	2004.01.28.20.16.14;	author sturm;	state Exp;
branches;
next	1.602;

1.602
date	2004.01.22.21.28.49;	author espie;	state Exp;
branches;
next	1.601;

1.601
date	2004.01.20.17.42.12;	author sturm;	state Exp;
branches;
next	1.600;

1.600
date	2004.01.18.07.52.49;	author sturm;	state Exp;
branches;
next	1.599;

1.599
date	2004.01.11.15.04.01;	author sturm;	state Exp;
branches;
next	1.598;

1.598
date	2004.01.11.00.49.01;	author espie;	state Exp;
branches;
next	1.597;

1.597
date	2004.01.06.16.27.11;	author espie;	state Exp;
branches;
next	1.596;

1.596
date	2004.01.06.15.02.57;	author espie;	state Exp;
branches;
next	1.595;

1.595
date	2004.01.04.09.07.19;	author sturm;	state Exp;
branches;
next	1.594;

1.594
date	2003.12.26.00.26.01;	author espie;	state Exp;
branches;
next	1.593;

1.593
date	2003.12.24.00.08.48;	author espie;	state Exp;
branches;
next	1.592;

1.592
date	2003.12.16.19.05.23;	author espie;	state Exp;
branches;
next	1.591;

1.591
date	2003.12.15.17.56.40;	author espie;	state Exp;
branches;
next	1.590;

1.590
date	2003.12.11.08.55.24;	author espie;	state Exp;
branches;
next	1.589;

1.589
date	2003.11.22.12.03.44;	author espie;	state Exp;
branches;
next	1.588;

1.588
date	2003.09.28.10.57.01;	author espie;	state Exp;
branches;
next	1.587;

1.587
date	2003.08.28.23.42.44;	author naddy;	state Exp;
branches;
next	1.586;

1.586
date	2003.08.28.16.19.00;	author sturm;	state Exp;
branches;
next	1.585;

1.585
date	2003.08.21.20.22.45;	author espie;	state Exp;
branches;
next	1.584;

1.584
date	2003.08.15.00.04.45;	author espie;	state Exp;
branches;
next	1.583;

1.583
date	2003.08.14.15.29.20;	author naddy;	state Exp;
branches;
next	1.582;

1.582
date	2003.08.13.19.41.01;	author espie;	state Exp;
branches;
next	1.581;

1.581
date	2003.08.11.20.10.41;	author espie;	state Exp;
branches;
next	1.580;

1.580
date	2003.08.11.20.07.59;	author espie;	state Exp;
branches;
next	1.579;

1.579
date	2003.08.11.18.42.07;	author sturm;	state Exp;
branches;
next	1.578;

1.578
date	2003.08.04.14.37.10;	author espie;	state Exp;
branches;
next	1.577;

1.577
date	2003.08.04.14.00.46;	author espie;	state Exp;
branches;
next	1.576;

1.576
date	2003.08.04.13.25.36;	author espie;	state Exp;
branches;
next	1.575;

1.575
date	2003.08.02.09.53.27;	author espie;	state Exp;
branches;
next	1.574;

1.574
date	2003.08.01.09.07.06;	author espie;	state Exp;
branches;
next	1.573;

1.573
date	2003.08.01.09.02.42;	author espie;	state Exp;
branches;
next	1.572;

1.572
date	2003.08.01.08.29.43;	author espie;	state Exp;
branches;
next	1.571;

1.571
date	2003.08.01.08.20.43;	author espie;	state Exp;
branches;
next	1.570;

1.570
date	2003.08.01.08.07.30;	author espie;	state Exp;
branches;
next	1.569;

1.569
date	2003.07.30.19.59.48;	author espie;	state Exp;
branches;
next	1.568;

1.568
date	2003.07.30.19.51.11;	author espie;	state Exp;
branches;
next	1.567;

1.567
date	2003.07.30.19.31.31;	author espie;	state Exp;
branches;
next	1.566;

1.566
date	2003.07.30.10.40.43;	author espie;	state Exp;
branches;
next	1.565;

1.565
date	2003.07.28.17.17.04;	author sturm;	state Exp;
branches;
next	1.564;

1.564
date	2003.07.25.12.46.26;	author espie;	state Exp;
branches;
next	1.563;

1.563
date	2003.07.25.02.17.51;	author pvalchev;	state Exp;
branches;
next	1.562;

1.562
date	2003.07.24.12.50.38;	author naddy;	state Exp;
branches;
next	1.561;

1.561
date	2003.07.23.22.24.24;	author espie;	state Exp;
branches;
next	1.560;

1.560
date	2003.07.23.09.58.33;	author espie;	state Exp;
branches;
next	1.559;

1.559
date	2003.07.18.19.02.13;	author espie;	state Exp;
branches;
next	1.558;

1.558
date	2003.07.18.18.54.09;	author espie;	state Exp;
branches;
next	1.557;

1.557
date	2003.07.18.18.34.26;	author espie;	state Exp;
branches;
next	1.556;

1.556
date	2003.07.18.18.18.15;	author espie;	state Exp;
branches;
next	1.555;

1.555
date	2003.07.16.21.22.15;	author espie;	state Exp;
branches;
next	1.554;

1.554
date	2003.07.14.14.08.57;	author espie;	state Exp;
branches;
next	1.553;

1.553
date	2003.07.14.14.02.18;	author espie;	state Exp;
branches;
next	1.552;

1.552
date	2003.07.14.13.33.04;	author espie;	state Exp;
branches;
next	1.551;

1.551
date	2003.07.12.12.51.19;	author espie;	state Exp;
branches;
next	1.550;

1.550
date	2003.07.12.12.50.06;	author espie;	state Exp;
branches;
next	1.549;

1.549
date	2003.07.11.16.46.20;	author pvalchev;	state Exp;
branches;
next	1.548;

1.548
date	2003.07.09.11.16.21;	author espie;	state Exp;
branches;
next	1.547;

1.547
date	2003.07.08.22.01.23;	author espie;	state Exp;
branches;
next	1.546;

1.546
date	2003.07.08.21.51.26;	author pvalchev;	state Exp;
branches;
next	1.545;

1.545
date	2003.05.18.23.11.21;	author sturm;	state Exp;
branches;
next	1.544;

1.544
date	2003.04.06.14.34.36;	author espie;	state Exp;
branches;
next	1.543;

1.543
date	2003.03.02.17.54.27;	author pvalchev;	state Exp;
branches;
next	1.542;

1.542
date	2003.02.06.03.45.15;	author brad;	state Exp;
branches;
next	1.541;

1.541
date	2003.01.14.18.18.23;	author espie;	state Exp;
branches;
next	1.540;

1.540
date	2003.01.06.20.18.23;	author espie;	state Exp;
branches;
next	1.539;

1.539
date	2003.01.06.20.15.39;	author espie;	state Exp;
branches;
next	1.538;

1.538
date	2002.12.08.11.04.47;	author espie;	state Exp;
branches;
next	1.537;

1.537
date	2002.12.08.04.17.39;	author brad;	state Exp;
branches;
next	1.536;

1.536
date	2002.10.10.21.14.11;	author naddy;	state Exp;
branches;
next	1.535;

1.535
date	2002.09.11.19.35.21;	author espie;	state Exp;
branches;
next	1.534;

1.534
date	2002.08.30.15.06.06;	author brad;	state Exp;
branches;
next	1.533;

1.533
date	2002.08.07.15.48.19;	author avsm;	state Exp;
branches;
next	1.532;

1.532
date	2002.07.06.09.24.06;	author pvalchev;	state Exp;
branches;
next	1.531;

1.531
date	2002.05.20.05.18.18;	author mpech;	state Exp;
branches;
next	1.530;

1.530
date	2002.05.19.18.51.21;	author millert;	state Exp;
branches;
next	1.529;

1.529
date	2002.05.15.18.23.21;	author espie;	state Exp;
branches;
next	1.528;

1.528
date	2002.05.13.00.43.42;	author espie;	state Exp;
branches;
next	1.527;

1.527
date	2002.05.08.18.31.49;	author millert;	state Exp;
branches;
next	1.526;

1.526
date	2002.05.07.12.25.54;	author espie;	state Exp;
branches;
next	1.525;

1.525
date	2002.04.24.21.29.26;	author espie;	state Exp;
branches;
next	1.524;

1.524
date	2002.04.17.16.53.13;	author espie;	state Exp;
branches;
next	1.523;

1.523
date	2002.04.17.15.58.48;	author espie;	state Exp;
branches;
next	1.522;

1.522
date	2002.04.10.08.44.57;	author espie;	state Exp;
branches;
next	1.521;

1.521
date	2002.04.09.23.55.11;	author espie;	state Exp;
branches;
next	1.520;

1.520
date	2002.04.09.22.52.24;	author espie;	state Exp;
branches;
next	1.519;

1.519
date	2002.04.09.13.52.58;	author espie;	state Exp;
branches;
next	1.518;

1.518
date	2002.04.03.15.00.30;	author espie;	state Exp;
branches;
next	1.517;

1.517
date	2002.04.02.15.55.55;	author espie;	state Exp;
branches;
next	1.516;

1.516
date	2002.03.21.21.28.29;	author espie;	state Exp;
branches;
next	1.515;

1.515
date	2002.03.18.01.55.40;	author espie;	state Exp;
branches;
next	1.514;

1.514
date	2002.03.18.01.52.46;	author espie;	state Exp;
branches;
next	1.513;

1.513
date	2002.03.16.01.09.23;	author espie;	state Exp;
branches;
next	1.512;

1.512
date	2002.03.16.00.54.37;	author espie;	state Exp;
branches;
next	1.511;

1.511
date	2002.03.15.13.29.13;	author espie;	state Exp;
branches;
next	1.510;

1.510
date	2002.03.13.13.51.59;	author espie;	state Exp;
branches;
next	1.509;

1.509
date	2002.03.10.06.02.16;	author brad;	state Exp;
branches;
next	1.508;

1.508
date	2002.03.04.15.33.16;	author espie;	state Exp;
branches;
next	1.507;

1.507
date	2002.03.02.13.38.25;	author espie;	state Exp;
branches;
next	1.506;

1.506
date	2002.03.01.00.49.03;	author naddy;	state Exp;
branches;
next	1.505;

1.505
date	2002.02.27.00.25.35;	author espie;	state Exp;
branches;
next	1.504;

1.504
date	2001.12.31.09.38.54;	author espie;	state Exp;
branches;
next	1.503;

1.503
date	2001.12.23.02.17.02;	author miod;	state Exp;
branches;
next	1.502;

1.502
date	2001.12.15.18.10.36;	author brad;	state Exp;
branches;
next	1.501;

1.501
date	2001.12.13.15.40.27;	author naddy;	state Exp;
branches;
next	1.500;

1.500
date	2001.11.22.16.02.26;	author naddy;	state Exp;
branches;
next	1.499;

1.499
date	2001.11.17.10.39.19;	author espie;	state Exp;
branches;
next	1.498;

1.498
date	2001.11.15.02.07.05;	author espie;	state Exp;
branches;
next	1.497;

1.497
date	2001.11.13.12.52.22;	author espie;	state Exp;
branches;
next	1.496;

1.496
date	2001.11.12.14.32.52;	author espie;	state Exp;
branches;
next	1.495;

1.495
date	2001.11.12.14.24.06;	author espie;	state Exp;
branches;
next	1.494;

1.494
date	2001.11.12.14.19.17;	author espie;	state Exp;
branches;
next	1.493;

1.493
date	2001.11.12.14.14.46;	author espie;	state Exp;
branches;
next	1.492;

1.492
date	2001.11.12.01.27.26;	author pvalchev;	state Exp;
branches;
next	1.491;

1.491
date	2001.11.11.13.57.32;	author heko;	state Exp;
branches;
next	1.490;

1.490
date	2001.11.11.12.59.50;	author espie;	state Exp;
branches;
next	1.489;

1.489
date	2001.11.01.12.26.16;	author espie;	state Exp;
branches;
next	1.488;

1.488
date	2001.10.29.12.51.59;	author espie;	state Exp;
branches;
next	1.487;

1.487
date	2001.10.28.12.34.57;	author espie;	state Exp;
branches;
next	1.486;

1.486
date	2001.10.28.12.31.35;	author espie;	state Exp;
branches;
next	1.485;

1.485
date	2001.10.28.04.59.26;	author brad;	state Exp;
branches;
next	1.484;

1.484
date	2001.10.26.17.34.31;	author pvalchev;	state Exp;
branches;
next	1.483;

1.483
date	2001.10.26.13.46.03;	author espie;	state Exp;
branches;
next	1.482;

1.482
date	2001.10.24.16.35.38;	author espie;	state Exp;
branches;
next	1.481;

1.481
date	2001.10.24.11.57.34;	author espie;	state Exp;
branches;
next	1.480;

1.480
date	2001.10.24.11.53.54;	author espie;	state Exp;
branches;
next	1.479;

1.479
date	2001.10.24.11.49.45;	author espie;	state Exp;
branches;
next	1.478;

1.478
date	2001.10.24.11.47.41;	author espie;	state Exp;
branches;
next	1.477;

1.477
date	2001.10.24.11.44.35;	author espie;	state Exp;
branches;
next	1.476;

1.476
date	2001.10.24.11.43.06;	author espie;	state Exp;
branches;
next	1.475;

1.475
date	2001.10.11.00.01.27;	author espie;	state Exp;
branches;
next	1.474;

1.474
date	2001.10.07.11.30.30;	author espie;	state Exp;
branches;
next	1.473;

1.473
date	2001.10.07.10.53.43;	author espie;	state Exp;
branches;
next	1.472;

1.472
date	2001.10.07.10.50.47;	author espie;	state Exp;
branches;
next	1.471;

1.471
date	2001.10.07.10.47.01;	author espie;	state Exp;
branches;
next	1.470;

1.470
date	2001.10.04.22.43.45;	author naddy;	state Exp;
branches;
next	1.469;

1.469
date	2001.10.04.22.20.38;	author espie;	state Exp;
branches;
next	1.468;

1.468
date	2001.10.03.08.53.18;	author espie;	state Exp;
branches;
next	1.467;

1.467
date	2001.10.03.08.41.16;	author espie;	state Exp;
branches;
next	1.466;

1.466
date	2001.10.03.08.36.25;	author espie;	state Exp;
branches;
next	1.465;

1.465
date	2001.09.30.12.26.57;	author espie;	state Exp;
branches;
next	1.464;

1.464
date	2001.09.30.11.27.05;	author espie;	state Exp;
branches;
next	1.463;

1.463
date	2001.09.29.17.36.02;	author espie;	state Exp;
branches;
next	1.462;

1.462
date	2001.09.28.01.48.58;	author naddy;	state Exp;
branches;
next	1.461;

1.461
date	2001.09.27.10.34.19;	author espie;	state Exp;
branches;
next	1.460;

1.460
date	2001.09.21.11.41.17;	author espie;	state Exp;
branches;
next	1.459;

1.459
date	2001.09.19.16.03.09;	author espie;	state Exp;
branches;
next	1.458;

1.458
date	2001.09.19.15.16.39;	author espie;	state Exp;
branches;
next	1.457;

1.457
date	2001.09.16.14.56.42;	author espie;	state Exp;
branches;
next	1.456;

1.456
date	2001.09.14.15.04.23;	author espie;	state Exp;
branches;
next	1.455;

1.455
date	2001.09.13.09.12.45;	author ho;	state Exp;
branches;
next	1.454;

1.454
date	2001.09.07.10.56.50;	author espie;	state Exp;
branches;
next	1.453;

1.453
date	2001.09.07.09.48.23;	author espie;	state Exp;
branches;
next	1.452;

1.452
date	2001.09.06.21.33.39;	author espie;	state Exp;
branches;
next	1.451;

1.451
date	2001.09.05.11.59.54;	author espie;	state Exp;
branches;
next	1.450;

1.450
date	2001.09.05.09.13.18;	author espie;	state Exp;
branches;
next	1.449;

1.449
date	2001.09.05.09.10.34;	author espie;	state Exp;
branches;
next	1.448;

1.448
date	2001.08.28.08.09.31;	author espie;	state Exp;
branches;
next	1.447;

1.447
date	2001.08.27.08.50.30;	author espie;	state Exp;
branches;
next	1.446;

1.446
date	2001.08.27.08.47.37;	author espie;	state Exp;
branches;
next	1.445;

1.445
date	2001.08.26.21.42.18;	author brad;	state Exp;
branches;
next	1.444;

1.444
date	2001.08.25.11.23.46;	author espie;	state Exp;
branches;
next	1.443;

1.443
date	2001.08.24.14.43.28;	author todd;	state Exp;
branches;
next	1.442;

1.442
date	2001.08.24.14.39.36;	author espie;	state Exp;
branches;
next	1.441;

1.441
date	2001.08.21.22.22.57;	author naddy;	state Exp;
branches;
next	1.440;

1.440
date	2001.08.18.23.16.57;	author brad;	state Exp;
branches;
next	1.439;

1.439
date	2001.08.17.03.23.04;	author brad;	state Exp;
branches;
next	1.438;

1.438
date	2001.08.16.15.15.24;	author espie;	state Exp;
branches;
next	1.437;

1.437
date	2001.08.16.15.13.17;	author espie;	state Exp;
branches;
next	1.436;

1.436
date	2001.08.16.14.49.31;	author espie;	state Exp;
branches;
next	1.435;

1.435
date	2001.08.12.11.33.10;	author espie;	state Exp;
branches;
next	1.434;

1.434
date	2001.08.07.11.46.17;	author heko;	state Exp;
branches;
next	1.433;

1.433
date	2001.07.31.22.26.48;	author espie;	state Exp;
branches;
next	1.432;

1.432
date	2001.07.30.15.07.49;	author espie;	state Exp;
branches;
next	1.431;

1.431
date	2001.07.30.14.55.07;	author espie;	state Exp;
branches;
next	1.430;

1.430
date	2001.07.30.14.45.26;	author jsyn;	state Exp;
branches;
next	1.429;

1.429
date	2001.07.30.14.34.34;	author espie;	state Exp;
branches;
next	1.428;

1.428
date	2001.07.30.14.13.16;	author espie;	state Exp;
branches;
next	1.427;

1.427
date	2001.07.20.13.13.47;	author espie;	state Exp;
branches;
next	1.426;

1.426
date	2001.07.20.13.02.47;	author espie;	state Exp;
branches;
next	1.425;

1.425
date	2001.07.18.18.23.04;	author espie;	state Exp;
branches;
next	1.424;

1.424
date	2001.07.18.16.19.47;	author espie;	state Exp;
branches;
next	1.423;

1.423
date	2001.07.18.14.52.27;	author espie;	state Exp;
branches;
next	1.422;

1.422
date	2001.07.17.16.11.45;	author espie;	state Exp;
branches;
next	1.421;

1.421
date	2001.07.16.15.14.36;	author espie;	state Exp;
branches;
next	1.420;

1.420
date	2001.07.11.12.57.20;	author espie;	state Exp;
branches;
next	1.419;

1.419
date	2001.07.03.12.06.13;	author espie;	state Exp;
branches;
next	1.418;

1.418
date	2001.06.30.19.06.09;	author matt;	state Exp;
branches;
next	1.417;

1.417
date	2001.06.22.07.21.24;	author jakob;	state Exp;
branches;
next	1.416;

1.416
date	2001.06.22.07.15.47;	author jakob;	state Exp;
branches;
next	1.415;

1.415
date	2001.06.22.07.03.19;	author jakob;	state Exp;
branches;
next	1.414;

1.414
date	2001.06.03.14.42.07;	author espie;	state Exp;
branches;
next	1.413;

1.413
date	2001.05.23.15.48.08;	author espie;	state Exp;
branches;
next	1.412;

1.412
date	2001.05.23.14.18.24;	author espie;	state Exp;
branches;
next	1.411;

1.411
date	2001.05.23.13.28.14;	author espie;	state Exp;
branches;
next	1.410;

1.410
date	2001.05.22.11.46.17;	author espie;	state Exp;
branches;
next	1.409;

1.409
date	2001.05.19.20.07.00;	author espie;	state Exp;
branches;
next	1.408;

1.408
date	2001.05.07.15.24.50;	author espie;	state Exp;
branches;
next	1.407;

1.407
date	2001.05.05.23.42.03;	author miod;	state Exp;
branches;
next	1.406;

1.406
date	2001.05.05.20.23.42;	author espie;	state Exp;
branches;
next	1.405;

1.405
date	2001.04.20.16.25.24;	author espie;	state Exp;
branches
	1.405.2.1;
next	1.404;

1.404
date	2001.04.20.15.06.19;	author espie;	state Exp;
branches;
next	1.403;

1.403
date	2001.04.19.22.15.05;	author espie;	state Exp;
branches;
next	1.402;

1.402
date	2001.04.19.01.56.53;	author espie;	state Exp;
branches;
next	1.401;

1.401
date	2001.04.18.15.00.53;	author brad;	state Exp;
branches;
next	1.400;

1.400
date	2001.04.18.14.43.55;	author espie;	state Exp;
branches;
next	1.399;

1.399
date	2001.04.17.21.40.36;	author espie;	state Exp;
branches;
next	1.398;

1.398
date	2001.04.17.16.45.14;	author espie;	state Exp;
branches;
next	1.397;

1.397
date	2001.04.16.21.40.04;	author naddy;	state Exp;
branches;
next	1.396;

1.396
date	2001.04.14.16.49.53;	author espie;	state Exp;
branches;
next	1.395;

1.395
date	2001.04.12.20.35.59;	author espie;	state Exp;
branches;
next	1.394;

1.394
date	2001.04.11.16.06.07;	author espie;	state Exp;
branches;
next	1.393;

1.393
date	2001.04.11.15.55.34;	author espie;	state Exp;
branches;
next	1.392;

1.392
date	2001.04.09.23.16.50;	author espie;	state Exp;
branches;
next	1.391;

1.391
date	2001.04.08.16.56.22;	author espie;	state Exp;
branches;
next	1.390;

1.390
date	2001.04.08.16.55.17;	author espie;	state Exp;
branches;
next	1.389;

1.389
date	2001.04.08.16.50.13;	author espie;	state Exp;
branches;
next	1.388;

1.388
date	2001.04.08.16.49.26;	author espie;	state Exp;
branches;
next	1.387;

1.387
date	2001.04.04.09.55.34;	author espie;	state Exp;
branches;
next	1.386;

1.386
date	2001.04.04.08.17.31;	author espie;	state Exp;
branches;
next	1.385;

1.385
date	2001.04.04.08.03.59;	author espie;	state Exp;
branches;
next	1.384;

1.384
date	2001.04.02.21.08.49;	author espie;	state Exp;
branches;
next	1.383;

1.383
date	2001.04.02.11.50.25;	author espie;	state Exp;
branches;
next	1.382;

1.382
date	2001.04.02.11.45.11;	author espie;	state Exp;
branches;
next	1.381;

1.381
date	2001.04.02.11.32.32;	author espie;	state Exp;
branches;
next	1.380;

1.380
date	2001.04.02.10.35.51;	author espie;	state Exp;
branches;
next	1.379;

1.379
date	2001.04.02.10.16.59;	author espie;	state Exp;
branches;
next	1.378;

1.378
date	2001.03.29.19.01.05;	author espie;	state Exp;
branches;
next	1.377;

1.377
date	2001.03.28.15.07.05;	author espie;	state Exp;
branches;
next	1.376;

1.376
date	2001.03.28.15.04.34;	author espie;	state Exp;
branches;
next	1.375;

1.375
date	2001.03.28.15.01.01;	author espie;	state Exp;
branches;
next	1.374;

1.374
date	2001.03.28.14.50.17;	author espie;	state Exp;
branches;
next	1.373;

1.373
date	2001.03.28.14.33.24;	author espie;	state Exp;
branches;
next	1.372;

1.372
date	2001.03.28.12.15.26;	author espie;	state Exp;
branches;
next	1.371;

1.371
date	2001.03.28.11.52.20;	author espie;	state Exp;
branches;
next	1.370;

1.370
date	2001.03.28.11.48.12;	author espie;	state Exp;
branches;
next	1.369;

1.369
date	2001.03.28.11.43.16;	author espie;	state Exp;
branches;
next	1.368;

1.368
date	2001.03.28.11.32.29;	author espie;	state Exp;
branches;
next	1.367;

1.367
date	2001.03.28.11.28.31;	author espie;	state Exp;
branches;
next	1.366;

1.366
date	2001.03.28.11.27.18;	author espie;	state Exp;
branches;
next	1.365;

1.365
date	2001.03.28.10.25.38;	author espie;	state Exp;
branches;
next	1.364;

1.364
date	2001.03.25.20.35.35;	author espie;	state Exp;
branches;
next	1.363;

1.363
date	2001.03.22.00.22.36;	author espie;	state Exp;
branches;
next	1.362;

1.362
date	2001.03.17.11.16.38;	author espie;	state Exp;
branches;
next	1.361;

1.361
date	2001.03.16.14.56.41;	author espie;	state Exp;
branches;
next	1.360;

1.360
date	2001.03.16.14.54.40;	author espie;	state Exp;
branches;
next	1.359;

1.359
date	2001.03.06.18.59.38;	author espie;	state Exp;
branches;
next	1.358;

1.358
date	2001.03.01.00.01.40;	author espie;	state Exp;
branches;
next	1.357;

1.357
date	2001.02.24.22.02.08;	author espie;	state Exp;
branches;
next	1.356;

1.356
date	2001.02.13.12.09.07;	author wilfried;	state Exp;
branches;
next	1.355;

1.355
date	2001.02.10.13.50.13;	author espie;	state Exp;
branches;
next	1.354;

1.354
date	2001.02.10.13.47.54;	author espie;	state Exp;
branches;
next	1.353;

1.353
date	2001.02.03.01.14.52;	author miod;	state Exp;
branches;
next	1.352;

1.352
date	2001.01.18.14.58.16;	author espie;	state Exp;
branches;
next	1.351;

1.351
date	2001.01.08.22.34.51;	author brad;	state Exp;
branches;
next	1.350;

1.350
date	2001.01.08.22.10.36;	author espie;	state Exp;
branches;
next	1.349;

1.349
date	2001.01.08.22.09.24;	author espie;	state Exp;
branches;
next	1.348;

1.348
date	2000.12.23.12.27.17;	author espie;	state Exp;
branches;
next	1.347;

1.347
date	2000.12.23.12.25.57;	author espie;	state Exp;
branches;
next	1.346;

1.346
date	2000.12.16.15.49.12;	author espie;	state Exp;
branches;
next	1.345;

1.345
date	2000.12.16.15.47.35;	author espie;	state Exp;
branches;
next	1.344;

1.344
date	2000.12.16.15.44.35;	author espie;	state Exp;
branches;
next	1.343;

1.343
date	2000.12.14.13.13.53;	author espie;	state Exp;
branches;
next	1.342;

1.342
date	2000.12.14.13.08.59;	author espie;	state Exp;
branches;
next	1.341;

1.341
date	2000.12.01.16.31.11;	author espie;	state Exp;
branches;
next	1.340;

1.340
date	2000.10.22.16.31.38;	author espie;	state Exp;
branches;
next	1.339;

1.339
date	2000.10.22.16.06.25;	author espie;	state Exp;
branches;
next	1.338;

1.338
date	2000.10.02.07.53.24;	author espie;	state Exp;
branches;
next	1.337;

1.337
date	2000.09.23.22.03.21;	author espie;	state Exp;
branches;
next	1.336;

1.336
date	2000.09.23.12.40.27;	author espie;	state Exp;
branches;
next	1.335;

1.335
date	2000.09.23.12.36.39;	author espie;	state Exp;
branches;
next	1.334;

1.334
date	2000.09.22.02.20.30;	author espie;	state Exp;
branches;
next	1.333;

1.333
date	2000.09.19.14.14.52;	author mickey;	state Exp;
branches;
next	1.332;

1.332
date	2000.09.17.16.26.57;	author espie;	state Exp;
branches;
next	1.331;

1.331
date	2000.09.16.13.54.56;	author espie;	state Exp;
branches;
next	1.330;

1.330
date	2000.09.13.14.06.55;	author espie;	state Exp;
branches;
next	1.329;

1.329
date	2000.09.13.13.49.51;	author espie;	state Exp;
branches;
next	1.328;

1.328
date	2000.09.12.02.52.01;	author marc;	state Exp;
branches;
next	1.327;

1.327
date	2000.09.11.18.06.24;	author espie;	state Exp;
branches;
next	1.326;

1.326
date	2000.09.07.04.20.54;	author brad;	state Exp;
branches;
next	1.325;

1.325
date	2000.09.07.04.14.44;	author brad;	state Exp;
branches;
next	1.324;

1.324
date	2000.09.05.17.27.45;	author espie;	state Exp;
branches;
next	1.323;

1.323
date	2000.09.03.16.00.49;	author espie;	state Exp;
branches;
next	1.322;

1.322
date	2000.08.28.22.42.00;	author espie;	state Exp;
branches;
next	1.321;

1.321
date	2000.08.28.22.38.37;	author espie;	state Exp;
branches;
next	1.320;

1.320
date	2000.08.22.23.10.38;	author brad;	state Exp;
branches;
next	1.319;

1.319
date	2000.07.21.02.38.33;	author miod;	state Exp;
branches;
next	1.318;

1.318
date	2000.07.19.22.36.32;	author naddy;	state Exp;
branches;
next	1.317;

1.317
date	2000.07.17.07.11.50;	author espie;	state Exp;
branches;
next	1.316;

1.316
date	2000.07.14.23.07.25;	author espie;	state Exp;
branches;
next	1.315;

1.315
date	2000.07.14.23.01.12;	author espie;	state Exp;
branches;
next	1.314;

1.314
date	2000.07.11.10.32.22;	author espie;	state Exp;
branches;
next	1.313;

1.313
date	2000.07.07.15.49.32;	author espie;	state Exp;
branches;
next	1.312;

1.312
date	2000.07.03.13.01.47;	author espie;	state Exp;
branches;
next	1.311;

1.311
date	2000.06.30.21.48.50;	author espie;	state Exp;
branches;
next	1.310;

1.310
date	2000.06.30.21.42.36;	author espie;	state Exp;
branches;
next	1.309;

1.309
date	2000.06.28.15.06.26;	author espie;	state Exp;
branches;
next	1.308;

1.308
date	2000.06.20.16.51.23;	author espie;	state Exp;
branches;
next	1.307;

1.307
date	2000.06.18.23.35.02;	author turan;	state Exp;
branches;
next	1.306;

1.306
date	2000.06.18.23.27.03;	author espie;	state Exp;
branches;
next	1.305;

1.305
date	2000.06.16.23.53.40;	author espie;	state Exp;
branches;
next	1.304;

1.304
date	2000.06.16.23.10.41;	author espie;	state Exp;
branches;
next	1.303;

1.303
date	2000.06.13.01.48.17;	author espie;	state Exp;
branches;
next	1.302;

1.302
date	2000.06.12.02.09.22;	author espie;	state Exp;
branches;
next	1.301;

1.301
date	2000.06.10.17.21.33;	author espie;	state Exp;
branches;
next	1.300;

1.300
date	2000.06.10.17.15.06;	author espie;	state Exp;
branches;
next	1.299;

1.299
date	2000.06.10.15.27.54;	author espie;	state Exp;
branches;
next	1.298;

1.298
date	2000.06.09.20.59.46;	author espie;	state Exp;
branches;
next	1.297;

1.297
date	2000.06.09.19.34.31;	author espie;	state Exp;
branches;
next	1.296;

1.296
date	2000.06.09.18.37.31;	author espie;	state Exp;
branches;
next	1.295;

1.295
date	2000.06.09.16.31.54;	author espie;	state Exp;
branches;
next	1.294;

1.294
date	2000.06.09.16.26.54;	author espie;	state Exp;
branches;
next	1.293;

1.293
date	2000.06.09.16.18.42;	author espie;	state Exp;
branches;
next	1.292;

1.292
date	2000.06.07.15.46.15;	author espie;	state Exp;
branches;
next	1.291;

1.291
date	2000.06.02.14.37.17;	author brad;	state Exp;
branches;
next	1.290;

1.290
date	2000.06.02.11.42.53;	author espie;	state Exp;
branches;
next	1.289;

1.289
date	2000.06.01.17.33.53;	author espie;	state Exp;
branches;
next	1.288;

1.288
date	2000.05.31.22.37.42;	author marc;	state Exp;
branches;
next	1.287;

1.287
date	2000.05.30.16.39.04;	author espie;	state Exp;
branches;
next	1.286;

1.286
date	2000.05.30.14.51.59;	author espie;	state Exp;
branches;
next	1.285;

1.285
date	2000.05.30.14.44.23;	author espie;	state Exp;
branches;
next	1.284;

1.284
date	2000.05.29.16.43.35;	author espie;	state Exp;
branches;
next	1.283;

1.283
date	2000.05.22.13.43.55;	author espie;	state Exp;
branches;
next	1.282;

1.282
date	2000.05.18.19.59.21;	author espie;	state Exp;
branches;
next	1.281;

1.281
date	2000.05.17.12.41.28;	author espie;	state Exp;
branches;
next	1.280;

1.280
date	2000.05.17.12.14.53;	author espie;	state Exp;
branches;
next	1.279;

1.279
date	2000.05.17.00.22.39;	author espie;	state Exp;
branches;
next	1.278;

1.278
date	2000.05.16.18.14.29;	author espie;	state Exp;
branches;
next	1.277;

1.277
date	2000.05.16.17.06.46;	author espie;	state Exp;
branches;
next	1.276;

1.276
date	2000.05.16.15.54.17;	author espie;	state Exp;
branches;
next	1.275;

1.275
date	2000.05.16.15.13.28;	author espie;	state Exp;
branches;
next	1.274;

1.274
date	2000.05.16.14.40.28;	author espie;	state Exp;
branches;
next	1.273;

1.273
date	2000.04.22.19.20.12;	author espie;	state Exp;
branches
	1.273.2.1;
next	1.272;

1.272
date	2000.04.22.18.57.00;	author espie;	state Exp;
branches;
next	1.271;

1.271
date	2000.04.19.14.37.19;	author espie;	state Exp;
branches;
next	1.270;

1.270
date	2000.04.18.23.20.49;	author espie;	state Exp;
branches;
next	1.269;

1.269
date	2000.04.18.20.13.48;	author espie;	state Exp;
branches;
next	1.268;

1.268
date	2000.04.18.17.35.09;	author espie;	state Exp;
branches;
next	1.267;

1.267
date	2000.04.17.21.53.38;	author espie;	state Exp;
branches;
next	1.266;

1.266
date	2000.04.17.20.14.33;	author espie;	state Exp;
branches;
next	1.265;

1.265
date	2000.04.17.20.12.03;	author espie;	state Exp;
branches;
next	1.264;

1.264
date	2000.04.16.21.41.07;	author espie;	state Exp;
branches;
next	1.263;

1.263
date	2000.04.16.20.59.22;	author espie;	state Exp;
branches;
next	1.262;

1.262
date	2000.04.15.18.46.08;	author espie;	state Exp;
branches;
next	1.261;

1.261
date	2000.04.10.01.11.36;	author espie;	state Exp;
branches;
next	1.260;

1.260
date	2000.04.10.00.42.02;	author espie;	state Exp;
branches;
next	1.259;

1.259
date	2000.04.09.23.57.58;	author espie;	state Exp;
branches;
next	1.258;

1.258
date	2000.04.09.15.24.13;	author espie;	state Exp;
branches;
next	1.257;

1.257
date	2000.04.09.15.05.52;	author espie;	state Exp;
branches;
next	1.256;

1.256
date	2000.04.09.12.04.13;	author turan;	state Exp;
branches;
next	1.255;

1.255
date	2000.04.09.11.51.39;	author espie;	state Exp;
branches;
next	1.254;

1.254
date	2000.04.09.11.34.01;	author espie;	state Exp;
branches;
next	1.253;

1.253
date	2000.04.08.23.11.15;	author marc;	state Exp;
branches;
next	1.252;

1.252
date	2000.04.03.17.32.42;	author espie;	state Exp;
branches;
next	1.251;

1.251
date	2000.04.03.17.09.12;	author espie;	state Exp;
branches;
next	1.250;

1.250
date	2000.04.02.18.35.41;	author espie;	state Exp;
branches;
next	1.249;

1.249
date	2000.04.02.18.08.31;	author espie;	state Exp;
branches;
next	1.248;

1.248
date	2000.04.02.17.55.45;	author espie;	state Exp;
branches;
next	1.247;

1.247
date	2000.04.02.16.42.27;	author espie;	state Exp;
branches;
next	1.246;

1.246
date	2000.04.02.10.47.54;	author espie;	state Exp;
branches;
next	1.245;

1.245
date	2000.04.01.15.49.06;	author espie;	state Exp;
branches;
next	1.244;

1.244
date	2000.04.01.14.57.24;	author espie;	state Exp;
branches;
next	1.243;

1.243
date	2000.03.31.18.51.09;	author espie;	state Exp;
branches;
next	1.242;

1.242
date	2000.03.31.18.05.28;	author espie;	state Exp;
branches;
next	1.241;

1.241
date	2000.03.29.16.34.45;	author espie;	state Exp;
branches;
next	1.240;

1.240
date	2000.03.29.15.59.50;	author espie;	state Exp;
branches;
next	1.239;

1.239
date	2000.03.28.09.27.03;	author espie;	state Exp;
branches;
next	1.238;

1.238
date	2000.03.27.01.52.17;	author espie;	state Exp;
branches;
next	1.237;

1.237
date	2000.03.26.21.23.20;	author espie;	state Exp;
branches;
next	1.236;

1.236
date	2000.03.26.16.01.08;	author espie;	state Exp;
branches;
next	1.235;

1.235
date	2000.03.26.15.59.41;	author espie;	state Exp;
branches;
next	1.234;

1.234
date	2000.03.24.20.44.01;	author turan;	state Exp;
branches;
next	1.233;

1.233
date	2000.03.21.21.23.54;	author espie;	state Exp;
branches;
next	1.232;

1.232
date	2000.03.21.21.06.58;	author espie;	state Exp;
branches;
next	1.231;

1.231
date	2000.03.19.16.46.18;	author espie;	state Exp;
branches;
next	1.230;

1.230
date	2000.03.19.16.11.41;	author espie;	state Exp;
branches;
next	1.229;

1.229
date	2000.03.19.16.04.19;	author espie;	state Exp;
branches;
next	1.228;

1.228
date	2000.03.19.01.52.46;	author espie;	state Exp;
branches;
next	1.227;

1.227
date	2000.03.18.17.01.34;	author espie;	state Exp;
branches;
next	1.226;

1.226
date	2000.03.10.18.09.23;	author espie;	state Exp;
branches;
next	1.225;

1.225
date	2000.03.08.00.07.37;	author espie;	state Exp;
branches;
next	1.224;

1.224
date	2000.03.07.16.14.20;	author espie;	state Exp;
branches;
next	1.223;

1.223
date	2000.03.05.16.40.52;	author espie;	state Exp;
branches;
next	1.222;

1.222
date	2000.03.05.16.33.38;	author espie;	state Exp;
branches;
next	1.221;

1.221
date	2000.03.05.16.00.30;	author espie;	state Exp;
branches;
next	1.220;

1.220
date	2000.03.04.18.16.02;	author espie;	state Exp;
branches;
next	1.219;

1.219
date	2000.03.04.14.40.21;	author turan;	state Exp;
branches;
next	1.218;

1.218
date	2000.03.04.14.36.46;	author turan;	state Exp;
branches;
next	1.217;

1.217
date	2000.03.04.08.35.47;	author turan;	state Exp;
branches;
next	1.216;

1.216
date	2000.03.03.21.24.51;	author espie;	state Exp;
branches;
next	1.215;

1.215
date	2000.03.03.20.59.16;	author espie;	state Exp;
branches;
next	1.214;

1.214
date	2000.03.03.20.41.11;	author espie;	state Exp;
branches;
next	1.213;

1.213
date	2000.03.03.17.51.37;	author espie;	state Exp;
branches;
next	1.212;

1.212
date	2000.03.03.14.23.10;	author turan;	state Exp;
branches;
next	1.211;

1.211
date	2000.02.28.18.13.18;	author espie;	state Exp;
branches;
next	1.210;

1.210
date	2000.02.22.17.08.31;	author espie;	state Exp;
branches;
next	1.209;

1.209
date	2000.02.22.14.07.09;	author espie;	state Exp;
branches;
next	1.208;

1.208
date	2000.02.22.09.27.52;	author turan;	state Exp;
branches;
next	1.207;

1.207
date	2000.02.22.09.18.36;	author turan;	state Exp;
branches;
next	1.206;

1.206
date	2000.02.21.23.53.52;	author espie;	state Exp;
branches;
next	1.205;

1.205
date	2000.02.21.22.09.58;	author turan;	state Exp;
branches;
next	1.204;

1.204
date	2000.02.20.17.05.40;	author espie;	state Exp;
branches;
next	1.203;

1.203
date	2000.02.19.04.16.23;	author turan;	state Exp;
branches;
next	1.202;

1.202
date	2000.02.18.22.54.27;	author espie;	state Exp;
branches;
next	1.201;

1.201
date	2000.02.15.18.19.12;	author espie;	state Exp;
branches;
next	1.200;

1.200
date	2000.02.15.17.58.32;	author espie;	state Exp;
branches;
next	1.199;

1.199
date	2000.02.15.07.28.20;	author turan;	state Exp;
branches;
next	1.198;

1.198
date	2000.02.12.13.52.04;	author espie;	state Exp;
branches;
next	1.197;

1.197
date	2000.02.12.06.02.04;	author turan;	state Exp;
branches;
next	1.196;

1.196
date	2000.02.12.00.49.17;	author espie;	state Exp;
branches;
next	1.195;

1.195
date	2000.02.12.00.43.58;	author espie;	state Exp;
branches;
next	1.194;

1.194
date	2000.02.11.01.11.00;	author espie;	state Exp;
branches;
next	1.193;

1.193
date	2000.02.11.00.40.09;	author espie;	state Exp;
branches;
next	1.192;

1.192
date	2000.02.10.23.46.42;	author espie;	state Exp;
branches;
next	1.191;

1.191
date	2000.02.09.20.09.05;	author espie;	state Exp;
branches;
next	1.190;

1.190
date	2000.02.09.00.54.33;	author espie;	state Exp;
branches;
next	1.189;

1.189
date	2000.02.09.00.42.39;	author espie;	state Exp;
branches;
next	1.188;

1.188
date	2000.02.09.00.26.32;	author espie;	state Exp;
branches;
next	1.187;

1.187
date	2000.02.09.00.23.26;	author espie;	state Exp;
branches;
next	1.186;

1.186
date	2000.02.06.18.35.24;	author espie;	state Exp;
branches;
next	1.185;

1.185
date	2000.02.04.20.33.42;	author espie;	state Exp;
branches;
next	1.184;

1.184
date	2000.02.04.12.55.33;	author espie;	state Exp;
branches;
next	1.183;

1.183
date	2000.02.04.11.15.16;	author espie;	state Exp;
branches;
next	1.182;

1.182
date	2000.02.04.11.09.33;	author espie;	state Exp;
branches;
next	1.181;

1.181
date	2000.02.04.00.51.53;	author espie;	state Exp;
branches;
next	1.180;

1.180
date	2000.02.03.22.03.00;	author espie;	state Exp;
branches;
next	1.179;

1.179
date	2000.02.02.18.33.42;	author espie;	state Exp;
branches;
next	1.178;

1.178
date	2000.02.02.18.20.28;	author espie;	state Exp;
branches;
next	1.177;

1.177
date	2000.02.02.15.28.17;	author espie;	state Exp;
branches;
next	1.176;

1.176
date	2000.02.02.00.15.07;	author espie;	state Exp;
branches;
next	1.175;

1.175
date	2000.02.01.14.39.20;	author espie;	state Exp;
branches;
next	1.174;

1.174
date	2000.01.30.15.19.40;	author espie;	state Exp;
branches;
next	1.173;

1.173
date	2000.01.27.20.45.44;	author espie;	state Exp;
branches;
next	1.172;

1.172
date	2000.01.27.20.16.14;	author espie;	state Exp;
branches;
next	1.171;

1.171
date	2000.01.27.15.32.15;	author espie;	state Exp;
branches;
next	1.170;

1.170
date	2000.01.27.00.09.44;	author brad;	state Exp;
branches;
next	1.169;

1.169
date	2000.01.26.23.11.08;	author espie;	state Exp;
branches;
next	1.168;

1.168
date	2000.01.26.21.15.05;	author espie;	state Exp;
branches;
next	1.167;

1.167
date	2000.01.13.17.40.20;	author espie;	state Exp;
branches;
next	1.166;

1.166
date	2000.01.06.21.53.27;	author espie;	state Exp;
branches;
next	1.165;

1.165
date	2000.01.01.15.43.34;	author brad;	state Exp;
branches;
next	1.164;

1.164
date	99.12.24.00.27.58;	author espie;	state Exp;
branches;
next	1.163;

1.163
date	99.12.21.21.43.37;	author espie;	state Exp;
branches;
next	1.162;

1.162
date	99.12.20.19.02.37;	author espie;	state Exp;
branches;
next	1.161;

1.161
date	99.12.20.00.07.17;	author espie;	state Exp;
branches;
next	1.160;

1.160
date	99.12.19.23.48.36;	author espie;	state Exp;
branches;
next	1.159;

1.159
date	99.12.11.16.14.20;	author espie;	state Exp;
branches;
next	1.158;

1.158
date	99.12.08.17.11.09;	author espie;	state Exp;
branches;
next	1.157;

1.157
date	99.12.08.17.00.15;	author espie;	state Exp;
branches;
next	1.156;

1.156
date	99.12.03.17.37.33;	author espie;	state Exp;
branches;
next	1.155;

1.155
date	99.12.03.17.30.47;	author espie;	state Exp;
branches;
next	1.154;

1.154
date	99.12.03.17.20.02;	author espie;	state Exp;
branches;
next	1.153;

1.153
date	99.12.03.16.54.42;	author brad;	state Exp;
branches;
next	1.152;

1.152
date	99.12.03.14.57.12;	author espie;	state Exp;
branches;
next	1.151;

1.151
date	99.12.03.14.24.39;	author espie;	state Exp;
branches;
next	1.150;

1.150
date	99.12.01.22.39.44;	author ian;	state Exp;
branches;
next	1.149;

1.149
date	99.12.01.22.35.54;	author ian;	state Exp;
branches;
next	1.148;

1.148
date	99.12.01.13.36.50;	author espie;	state Exp;
branches;
next	1.147;

1.147
date	99.11.29.23.14.03;	author espie;	state Exp;
branches;
next	1.146;

1.146
date	99.11.28.14.14.58;	author espie;	state Exp;
branches;
next	1.145;

1.145
date	99.11.28.14.12.24;	author espie;	state Exp;
branches;
next	1.144;

1.144
date	99.11.27.13.17.13;	author espie;	state Exp;
branches;
next	1.143;

1.143
date	99.11.24.01.18.57;	author espie;	state Exp;
branches;
next	1.142;

1.142
date	99.11.24.00.56.52;	author espie;	state Exp;
branches;
next	1.141;

1.141
date	99.11.23.15.06.14;	author espie;	state Exp;
branches;
next	1.140;

1.140
date	99.11.22.23.44.01;	author espie;	state Exp;
branches;
next	1.139;

1.139
date	99.11.22.20.40.53;	author espie;	state Exp;
branches;
next	1.138;

1.138
date	99.11.22.20.37.04;	author espie;	state Exp;
branches;
next	1.137;

1.137
date	99.11.22.20.34.14;	author espie;	state Exp;
branches;
next	1.136;

1.136
date	99.11.21.16.18.30;	author espie;	state Exp;
branches;
next	1.135;

1.135
date	99.11.20.17.54.09;	author espie;	state Exp;
branches;
next	1.134;

1.134
date	99.11.15.18.37.58;	author espie;	state Exp;
branches;
next	1.133;

1.133
date	99.11.10.13.46.40;	author espie;	state Exp;
branches;
next	1.132;

1.132
date	99.11.05.22.44.34;	author espie;	state Exp;
branches;
next	1.131;

1.131
date	99.10.27.12.48.40;	author espie;	state Exp;
branches;
next	1.130;

1.130
date	99.10.08.11.38.05;	author espie;	state Exp;
branches;
next	1.129;

1.129
date	99.09.30.21.07.09;	author espie;	state Exp;
branches;
next	1.128;

1.128
date	99.09.30.17.34.22;	author espie;	state Exp;
branches;
next	1.127;

1.127
date	99.09.30.17.28.31;	author espie;	state Exp;
branches;
next	1.126;

1.126
date	99.09.30.16.56.16;	author espie;	state Exp;
branches;
next	1.125;

1.125
date	99.09.30.16.35.40;	author espie;	state Exp;
branches;
next	1.124;

1.124
date	99.09.30.16.24.47;	author espie;	state Exp;
branches;
next	1.123;

1.123
date	99.09.26.22.20.46;	author espie;	state Exp;
branches;
next	1.122;

1.122
date	99.09.26.10.51.34;	author espie;	state Exp;
branches;
next	1.121;

1.121
date	99.09.26.10.50.07;	author espie;	state Exp;
branches;
next	1.120;

1.120
date	99.09.26.10.48.47;	author espie;	state Exp;
branches;
next	1.119;

1.119
date	99.09.26.10.47.30;	author espie;	state Exp;
branches;
next	1.118;

1.118
date	99.09.26.10.45.35;	author espie;	state Exp;
branches;
next	1.117;

1.117
date	99.09.22.11.49.23;	author espie;	state Exp;
branches;
next	1.116;

1.116
date	99.09.22.10.16.58;	author espie;	state Exp;
branches;
next	1.115;

1.115
date	99.09.20.21.42.01;	author brad;	state Exp;
branches;
next	1.114;

1.114
date	99.09.02.21.57.32;	author brad;	state Exp;
branches;
next	1.113;

1.113
date	99.08.25.02.54.19;	author brad;	state Exp;
branches;
next	1.112;

1.112
date	99.08.23.00.03.42;	author brad;	state Exp;
branches;
next	1.111;

1.111
date	99.08.22.23.44.51;	author brad;	state Exp;
branches;
next	1.110;

1.110
date	99.08.17.03.11.35;	author brad;	state Exp;
branches;
next	1.109;

1.109
date	99.08.10.19.56.11;	author espie;	state Exp;
branches;
next	1.108;

1.108
date	99.08.10.19.55.31;	author espie;	state Exp;
branches;
next	1.107;

1.107
date	99.08.10.19.54.17;	author espie;	state Exp;
branches;
next	1.106;

1.106
date	99.08.10.19.50.37;	author espie;	state Exp;
branches;
next	1.105;

1.105
date	99.07.29.15.41.47;	author espie;	state Exp;
branches;
next	1.104;

1.104
date	99.07.28.13.02.15;	author espie;	state Exp;
branches;
next	1.103;

1.103
date	99.07.28.12.56.15;	author espie;	state Exp;
branches;
next	1.102;

1.102
date	99.07.28.12.40.56;	author espie;	state Exp;
branches;
next	1.101;

1.101
date	99.07.28.00.25.38;	author espie;	state Exp;
branches;
next	1.100;

1.100
date	99.07.27.22.12.26;	author espie;	state Exp;
branches;
next	1.99;

1.99
date	99.06.24.18.39.48;	author espie;	state Exp;
branches;
next	1.98;

1.98
date	99.06.24.17.31.16;	author espie;	state Exp;
branches;
next	1.97;

1.97
date	99.06.13.03.50.51;	author brad;	state Exp;
branches;
next	1.96;

1.96
date	99.06.04.15.32.05;	author espie;	state Exp;
branches;
next	1.95;

1.95
date	99.06.04.15.28.58;	author espie;	state Exp;
branches;
next	1.94;

1.94
date	99.06.02.15.44.50;	author espie;	state Exp;
branches;
next	1.93;

1.93
date	99.05.25.20.38.33;	author espie;	state Exp;
branches;
next	1.92;

1.92
date	99.05.23.22.45.15;	author brad;	state Exp;
branches;
next	1.91;

1.91
date	99.05.14.04.38.36;	author brad;	state Exp;
branches;
next	1.90;

1.90
date	99.05.10.21.35.25;	author brad;	state Exp;
branches;
next	1.89;

1.89
date	99.05.04.18.12.24;	author rohee;	state Exp;
branches;
next	1.88;

1.88
date	99.04.20.18.22.56;	author espie;	state Exp;
branches;
next	1.87;

1.87
date	99.04.20.18.09.37;	author espie;	state Exp;
branches;
next	1.86;

1.86
date	99.04.20.18.06.40;	author espie;	state Exp;
branches;
next	1.85;

1.85
date	99.04.20.18.04.27;	author espie;	state Exp;
branches;
next	1.84;

1.84
date	99.04.10.07.48.53;	author marc;	state Exp;
branches;
next	1.83;

1.83
date	99.04.06.19.14.41;	author marc;	state Exp;
branches;
next	1.82;

1.82
date	99.04.02.06.55.56;	author marc;	state Exp;
branches;
next	1.81;

1.81
date	99.03.30.07.12.05;	author marc;	state Exp;
branches;
next	1.80;

1.80
date	99.03.24.01.13.44;	author marc;	state Exp;
branches;
next	1.79;

1.79
date	99.03.16.23.35.37;	author espie;	state Exp;
branches;
next	1.78;

1.78
date	99.03.14.15.19.05;	author rohee;	state Exp;
branches;
next	1.77;

1.77
date	99.03.10.23.22.19;	author marc;	state Exp;
branches;
next	1.76;

1.76
date	99.03.05.16.32.49;	author espie;	state Exp;
branches;
next	1.75;

1.75
date	99.03.03.18.18.46;	author espie;	state Exp;
branches;
next	1.74;

1.74
date	99.03.03.04.16.03;	author marc;	state Exp;
branches;
next	1.73;

1.73
date	99.03.01.19.44.18;	author marc;	state Exp;
branches;
next	1.72;

1.72
date	99.03.01.18.44.04;	author espie;	state Exp;
branches;
next	1.71;

1.71
date	99.02.28.23.23.47;	author espie;	state Exp;
branches;
next	1.70;

1.70
date	99.02.27.18.28.13;	author rohee;	state Exp;
branches;
next	1.69;

1.69
date	99.02.24.20.15.48;	author marc;	state Exp;
branches;
next	1.68;

1.68
date	99.02.24.12.34.46;	author espie;	state Exp;
branches;
next	1.67;

1.67
date	99.02.21.00.50.28;	author espie;	state Exp;
branches;
next	1.66;

1.66
date	99.02.21.00.01.30;	author marc;	state Exp;
branches;
next	1.65;

1.65
date	99.02.18.19.22.45;	author marc;	state Exp;
branches;
next	1.64;

1.64
date	99.02.18.00.01.47;	author marc;	state Exp;
branches;
next	1.63;

1.63
date	99.02.17.23.52.56;	author marc;	state Exp;
branches;
next	1.62;

1.62
date	99.02.17.23.45.15;	author marc;	state Exp;
branches;
next	1.61;

1.61
date	99.02.17.13.00.42;	author espie;	state Exp;
branches;
next	1.60;

1.60
date	99.02.03.17.53.13;	author rohee;	state Exp;
branches;
next	1.59;

1.59
date	99.01.24.02.04.20;	author marc;	state Exp;
branches;
next	1.58;

1.58
date	99.01.08.23.45.48;	author pattonme;	state Exp;
branches;
next	1.57;

1.57
date	98.12.19.16.52.22;	author espie;	state Exp;
branches;
next	1.56;

1.56
date	98.12.18.12.00.46;	author form;	state Exp;
branches;
next	1.55;

1.55
date	98.12.17.18.25.06;	author espie;	state Exp;
branches;
next	1.54;

1.54
date	98.12.16.19.59.48;	author marc;	state Exp;
branches;
next	1.53;

1.53
date	98.11.27.10.51.54;	author form;	state Exp;
branches;
next	1.52;

1.52
date	98.11.25.01.08.35;	author espie;	state Exp;
branches;
next	1.51;

1.51
date	98.11.19.22.15.31;	author marc;	state Exp;
branches;
next	1.50;

1.50
date	98.11.19.04.20.09;	author espie;	state Exp;
branches;
next	1.49;

1.49
date	98.11.17.07.14.16;	author form;	state Exp;
branches;
next	1.48;

1.48
date	98.11.17.06.39.25;	author form;	state Exp;
branches;
next	1.47;

1.47
date	98.11.05.10.36.14;	author espie;	state Exp;
branches;
next	1.46;

1.46
date	98.10.05.05.13.34;	author form;	state Exp;
branches;
next	1.45;

1.45
date	98.09.08.05.51.06;	author marc;	state Exp;
branches;
next	1.44;

1.44
date	98.09.07.22.33.19;	author marc;	state Exp;
branches;
next	1.43;

1.43
date	98.08.24.04.46.14;	author marc;	state Exp;
branches;
next	1.42;

1.42
date	98.08.21.06.57.19;	author marc;	state Exp;
branches;
next	1.41;

1.41
date	98.08.08.06.14.58;	author marc;	state Exp;
branches;
next	1.40;

1.40
date	98.07.29.15.32.54;	author espie;	state Exp;
branches;
next	1.39;

1.39
date	98.07.28.15.25.24;	author espie;	state Exp;
branches;
next	1.38;

1.38
date	98.07.17.04.10.20;	author form;	state Exp;
branches;
next	1.37;

1.37
date	98.07.13.03.11.14;	author todd;	state Exp;
branches;
next	1.36;

1.36
date	98.07.12.04.34.39;	author todd;	state Exp;
branches;
next	1.35;

1.35
date	98.07.09.03.12.18;	author marc;	state Exp;
branches;
next	1.34;

1.34
date	98.07.08.03.27.17;	author marc;	state Exp;
branches;
next	1.33;

1.33
date	98.07.07.04.02.47;	author marc;	state Exp;
branches;
next	1.32;

1.32
date	98.07.06.22.06.51;	author marc;	state Exp;
branches;
next	1.31;

1.31
date	98.06.29.22.21.16;	author marc;	state Exp;
branches;
next	1.30;

1.30
date	98.06.11.16.03.48;	author marc;	state Exp;
branches;
next	1.29;

1.29
date	98.04.28.19.19.29;	author marc;	state Exp;
branches;
next	1.28;

1.28
date	98.04.06.21.46.00;	author marc;	state Exp;
branches;
next	1.27;

1.27
date	98.04.05.04.20.38;	author marc;	state Exp;
branches;
next	1.26;

1.26
date	98.03.27.03.30.43;	author marc;	state Exp;
branches;
next	1.25;

1.25
date	98.02.19.20.41.02;	author marc;	state Exp;
branches;
next	1.24;

1.24
date	98.02.11.00.40.55;	author niklas;	state Exp;
branches;
next	1.23;

1.23
date	98.02.11.00.34.55;	author niklas;	state Exp;
branches;
next	1.22;

1.22
date	98.02.10.08.33.16;	author niklas;	state Exp;
branches;
next	1.21;

1.21
date	97.12.20.01.26.57;	author joey;	state Exp;
branches;
next	1.20;

1.20
date	97.12.20.01.24.08;	author todd;	state Exp;
branches;
next	1.19;

1.19
date	97.12.17.10.06.45;	author niklas;	state Exp;
branches;
next	1.18;

1.18
date	97.12.04.08.26.23;	author niklas;	state Exp;
branches;
next	1.17;

1.17
date	97.12.02.23.36.46;	author niklas;	state Exp;
branches;
next	1.16;

1.16
date	97.12.02.21.58.12;	author niklas;	state Exp;
branches;
next	1.15;

1.15
date	97.12.02.11.11.57;	author niklas;	state Exp;
branches;
next	1.14;

1.14
date	97.09.21.10.58.41;	author niklas;	state Exp;
branches;
next	1.13;

1.13
date	97.09.09.15.11.28;	author imp;	state Exp;
branches;
next	1.12;

1.12
date	97.04.27.21.38.33;	author millert;	state Exp;
branches;
next	1.11;

1.11
date	97.04.19.19.34.29;	author millert;	state Exp;
branches;
next	1.10;

1.10
date	97.01.11.11.58.11;	author niklas;	state Exp;
branches;
next	1.9;

1.9
date	96.12.25.20.10.09;	author imp;	state Exp;
branches;
next	1.8;

1.8
date	96.12.22.17.46.02;	author niklas;	state Exp;
branches;
next	1.7;

1.7
date	96.10.22.14.01.19;	author niklas;	state Exp;
branches;
next	1.6;

1.6
date	96.08.23.11.37.41;	author niklas;	state Exp;
branches;
next	1.5;

1.5
date	96.06.30.18.25.29;	author tholo;	state Exp;
branches;
next	1.4;

1.4
date	96.06.11.10.38.02;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	96.06.10.11.23.16;	author niklas;	state Exp;
branches;
next	1.2;

1.2
date	96.06.03.23.07.28;	author niklas;	state Exp;
branches;
next	1.1;

1.1
date	96.06.03.22.47.10;	author niklas;	state Exp;
branches;
next	;

1.273.2.1
date	2000.09.15.04.38.08;	author marc;	state Exp;
branches;
next	1.273.2.2;

1.273.2.2
date	2000.09.15.06.51.08;	author marc;	state Exp;
branches;
next	;

1.405.2.1
date	2001.05.05.20.34.19;	author espie;	state Exp;
branches;
next	1.405.2.2;

1.405.2.2
date	2001.05.07.23.21.19;	author miod;	state Exp;
branches;
next	1.405.2.3;

1.405.2.3
date	2001.05.07.23.33.26;	author miod;	state Exp;
branches;
next	;


desc
@@


1.1341
log
@draft for compiler auto-selection, not ready yet.
move arch-defines.mk up so it can be used by it to load modules
@
text
@#-*- mode: Makefile; tab-width: 4; -*-
# ex:ts=4 sw=4 filetype=make:
#	$OpenBSD: bsd.port.mk,v 1.1340 2017/04/11 15:36:56 espie Exp $
#
#	bsd.port.mk - 940820 Jordan K. Hubbard.
#	This file is in the public domain.

# Each port has a MAINTAINER, which is the email address(es) of the person(s)
# to contact if you have questions/suggestions about that specific port.
# To obtain that address, just type
#	make show=MAINTAINER
# in the specific port's directory.
#
# The ports@@openbsd.org address is the `default' MAINTAINER (the generic
# OpenBSD ports mailing-list).


# The definitive source of documentation to this file's user-visible parts
# is bsd.port.mk(5).
#
# Any variable or target starting with an underscore (e.g., _DEPEND_ECHO)
# is internal to bsd.port.mk, not part of the user's API, and liable to
# change without notice.
#
# a few experimental variables are voluntarily NOT documented
# PORTS_BUILD_XENOCARA_TOO, XENOCARA_COMPONENT, 
# PARALLEL_BUILD, PARALLEL_INSTALL, DANGEROUS, GLOBAL_DEPENDS_CACHE
#
# Enquiries as to the bsd.port.mk framework should usually be directed
# to ports@@openbsd.org.

# Sequence for "all" is:  fetch checksum prepare extract patch configure build
#
# Please read the comments in the targets section below, you
# should be able to use the pre-* or post-* targets (which
# are available for every stage except checksum) or provide
# an overriding do-* target to do pretty much anything you
# want.
#
# For historical reasons, the distpatch target is a subtarget of patch.
# If you provide a do-patch, you MUST call distpatch explicitly.
# The sequence of hooks actually run is:
#
# pre-patch `real distpatch' post-distpatch `real patch' post-patch
#

#
# tests and variable definitions come first, THEN targets
#
.if ${.MAKEFLAGS:MFLAVOR=*}
ERRORS += "Fatal: Use 'env FLAVOR=${FLAVOR} ${MAKE}' instead."
.endif
.if ${.MAKEFLAGS:MSUBPACKAGE=*}
ERRORS += "Fatal: Use 'env SUBPACKAGE=${SUBPACKAGE} ${MAKE}' instead."
.endif

.for f v in bsd.port.mk _BSD_PORT_MK bsd.port.subdir.mk _BSD_PORT_SUBDIR_MK
.  if defined($v)
ERRORS += "Fatal: inclusion of bsd.port.mk from $f"
.  endif
.endfor

# include guard so that other parts don't include this twice
_BSD_PORT_MK = Done

# User settings
FETCH_PACKAGES ?= No
CLEANDEPENDS ?= No
BULK ?= Auto
WRKDIR_LINKNAME ?=

USE_MFS ?= No
WRKOBJDIR ?= ${PORTSDIR}/pobj
WRKOBJDIR_MFS ?= /tmp/pobj
FAKEOBJDIR ?=

BULK_TARGETS ?=
BULK_DO ?=
CHECK_LIB_DEPENDS ?= No
FORCE_UPDATE ?= No
DPB ?= All Fetch Test
PREPARE_CHECK_ONLY ?= No
_SHSCRIPT = sh ${PORTSDIR}/infrastructure/bin
DPB_PROPERTIES ?=

# bsd.own.mk overrides
BINMODE = 755
NONBINMODE = 644

# All variables relevant to the port's description (see dump-vars)
_ALL_VARIABLES = BUILD_DEPENDS IS_INTERACTIVE \
	SUBPACKAGE FLAVOR BUILD_PACKAGES DPB_PROPERTIES \
	MULTI_PACKAGES
# and stuff needing to be MULTI_PACKAGE'd
_ALL_VARIABLES_INDEXED = FULLPKGNAME RUN_DEPENDS LIB_DEPENDS IGNORE
_ALL_VARIABLES_PER_ARCH =

# consumers of (dump-vars) include sqlports generation and dpb
# dpb doesn't need everything, those are speed optimizations
.if ${DPB:L:Mfetch} || ${DPB:L:Mall}
_ALL_VARIABLES += DISTFILES PATCHFILES SUPDISTFILES DIST_SUBDIR MASTER_SITES \
	MASTER_SITES0 MASTER_SITES1 MASTER_SITES2 MASTER_SITES3 MASTER_SITES4 \
	MASTER_SITES5 MASTER_SITES6 MASTER_SITES7 MASTER_SITES8 MASTER_SITES9 \
	CHECKSUM_FILE FETCH_MANUALLY MISSING_FILES \
	PERMIT_DISTFILES_FTP
.endif
.if ${DPB:L:Mtest} || ${DPB:L:Mall}
_ALL_VARIABLES += NO_TEST TEST_IS_INTERACTIVE TEST_DEPENDS
.endif
.if ${DPB:L:Mall}
_ALL_VARIABLES += HOMEPAGE DISTNAME \
	BROKEN COMES_WITH \
	USE_GMAKE USE_GROFF MODULES FLAVORS \
	NO_BUILD PSEUDO_FLAVORS \
	CONFIGURE_STYLE USE_LIBTOOL SEPARATE_BUILD \
	SHARED_LIBS TARGETS PSEUDO_FLAVOR \
	MAINTAINER AUTOCONF_VERSION AUTOMAKE_VERSION CONFIGURE_ARGS \
	GH_ACCOUNT GH_COMMIT GH_PROJECT GH_TAGNAME PORTROACH \
	PORTROACH_COMMENT MAKEFILE_LIST USE_WXNEEDED
_ALL_VARIABLES_PER_ARCH += BROKEN
# and stuff needing to be MULTI_PACKAGE'd
_ALL_VARIABLES_INDEXED += COMMENT PKGNAME \
	ONLY_FOR_ARCHS NOT_FOR_ARCHS PKGSPEC PREFIX \
	PERMIT_PACKAGE_FTP PERMIT_PACKAGE_CDROM WANTLIB CATEGORIES DESCR \
	EPOCH REVISION STATIC_PLIST PKG_ARCH
.endif

PATCH_CHECK_ONLY ?= No
REFETCH ?= false
PORTROACH ?=

# Global path locations.
PORTSDIR ?= /usr/ports
LOCALBASE ?= /usr/local
X11BASE ?= /usr/X11R6
VARBASE ?= /var
DISTDIR ?= ${PORTSDIR}/distfiles
BULK_COOKIES_DIR ?= ${PORTSDIR}/bulk/${MACHINE_ARCH}
UPDATE_COOKIES_DIR ?= ${PORTSDIR}/update/${MACHINE_ARCH}

PLIST_REPOSITORY ?= ${PORTSDIR}/plist
.if !empty(PLIST_REPOSITORY)
PLIST_DB ?= ${PLIST_REPOSITORY}/${MACHINE_ARCH}
.endif
PACKAGE_REPOSITORY ?= ${PORTSDIR}/packages

# experimental, don't touch the default unless you really know
# what you are doing
PORTS_BUILD_XENOCARA_TOO ?= No

.if ${PORTS_BUILD_XENOCARA_TOO:L} == "no"
.  if !exists(${X11BASE}/man/mandoc.db)
.    if exists(${X11BASE}/man/whatis.db)
ERRORS += "Your X11/system is not current"
.    else
ERRORS += "Fatal: building ports requires correctly installed X11"
.    endif
.  endif
.endif

# stuff common to bsd.port.mk and bsd.port.subdir.mk
# (determination of PKGPATH and various shell fragments:
#  flavor determination, dependency caching behavior...)
.include "${PORTSDIR}/infrastructure/mk/pkgpath.mk"

.if ${USE_MFS:L} == "yes"
WRKOBJDIR_${PKGPATH} ?= ${WRKOBJDIR_MFS}
.else
WRKOBJDIR_${PKGPATH} ?= ${WRKOBJDIR}
.endif
FAKEOBJDIR_${PKGPATH} ?= ${FAKEOBJDIR}

BULK_${PKGPATH} ?= ${BULK}
BULK_TARGETS_${PKGPATH} ?= ${BULK_TARGETS}
BULK_DO_${PKGPATH} ?= ${BULK_DO}
CLEANDEPENDS_${PKGPATH} ?= ${CLEANDEPENDS}

# Commands and command settings.
PKG_DBDIR ?= /var/db/pkg

PROGRESS_METER ?= Yes
.if ${PROGRESS_METER:L} == "yes"
_PROGRESS = -m
.else
_PROGRESS =
.endif

FETCH_CMD ?= /usr/bin/ftp -V ${_PROGRESS} -C

# switch for fetching each distfile: avoid warnings for missing
# distinfo and wrong size when running makesum
_MAKESUM ?= false

PKG_TMPDIR ?= /var/tmp

PKG_ADD ?= /usr/sbin/pkg_add
PKG_INFO ?= /usr/sbin/pkg_info
PKG_CREATE ?= /usr/sbin/pkg_create
PKG_DELETE ?= /usr/sbin/pkg_delete

_PKG_ADD = ${PKG_ADD} ${_PROGRESS} -I
_PKG_CREATE = ${PKG_CREATE} ${_PROGRESS}
_PKG_ADD_LOCAL = TRUSTED_PKG_PATH=${_PKG_REPO} ${_PKG_ADD}
_PKG_DELETE = ${PKG_DELETE} ${_PROGRESS}

.if !defined(_ARCH_DEFINES_INCLUDED)
_ARCH_DEFINES_INCLUDED = Done
.  include "${PORTSDIR}/infrastructure/mk/arch-defines.mk"
.endif

.if !defined(_MAKEFILE_INC_DONE)
.  if exists(${.CURDIR}/../Makefile.inc)
_MAKEFILE_INC_DONE = Yes
.    include "${.CURDIR}/../Makefile.inc"
.  endif
.endif
# XXX default target varies, so that make show=... and make clean=... work
.if defined(verbose-show)
.MAIN: verbose-show
.elif defined(show)
.MAIN: show
.elif defined(clean)
.MAIN: clean
.elif defined(_internal-clean)
clean = ${_internal-clean}
.MAIN: _internal-clean
.else
.MAIN: all
.endif

# XXX clean is set in stone on the cmdline.
_clean = ${clean}
.if empty(_clean) || ${_clean} == "depends"
_clean += work
.endif
.if ${_clean:Mall}
_clean += work build packages plist
.endif
.if ${CLEANDEPENDS_${PKGPATH}:L} == "yes"
_clean += depends
.endif
.if ${_clean:Mwork} || ${_clean:Mbuild}
_clean += fake
.endif
.if ${_clean:Mforce}
_clean += -f
.endif

_okay_words = depends work fake -f flavors dist install sub packages package \
	bulk force plist build all
.for _w in ${_clean}
.  if !${_okay_words:M${_w}}
ERRORS += "Fatal: unknown clean command: ${_w}\n(not in ${_okay_words})"
.  endif
.endfor

# MODULES support
# reserved name spaces: for module=NAME, modname*, _modname* variables and
# targets.

# These variables must be defined before modules
CONFIGURE_STYLE ?=
NO_DEPENDS ?= No
NO_BUILD ?= No
NO_TEST ?= No
INSTALL_TARGET ?= install

.if !defined(_ARCH_DEFINES_INCLUDED)
_ARCH_DEFINES_INCLUDED = Done
.  include "${PORTSDIR}/infrastructure/mk/arch-defines.mk"
.endif

USE_CXX ?= No
.if ${USE_CXX:L:Mc++11}
.  if ${PROPERTIES:Mclang}
# nothing to do
.  elif ${PROPERTIES:Mllvm}
# prefer llvm module
MODULES +=	lang/clang
MODCLANG_ARCH ?=	*
MODCLANG_LANGS +=	c++
.  else
# try gcc4
MODULES +=		gcc4
MODGCC4_LANGS +=		c++
MODGCC4_ARCHS ?=		*
.  endif
.endif

.if ${CONFIGURE_STYLE:L:Mautomake} || ${CONFIGURE_STYLE:L:Mautoconf} || \
	${CONFIGURE_STYLE:L:Mautoupdate}
.  if !${CONFIGURE_STYLE:L:Mgnu}
CONFIGURE_STYLE += gnu
.  endif
.endif

.if ${CONFIGURE_STYLE:L:Mmodbuild}
.  if !${CONFIGURE_STYLE:L:Mperl}
CONFIGURE_STYLE += perl
.  endif
.endif

.for _i in perl gnu imake
.  if ${CONFIGURE_STYLE:L:M${_i}}
MODULES += ${_i}
.  endif
.endfor

MODULES ?=
.if !empty(MODULES)
_MODULES_DONE =
.  include "${PORTSDIR}/infrastructure/mk/modules.port.mk"
.endif

###
### Variable setup that can happen after modules
###

.for v in PKGREPOSITORY PKGREPOSITORYBASE CDROM_PACKAGES FTP_PACKAGES \
	SED_PLIST IGNORE_FILES NO_REGRESS REGRESS_IS_INTERACTIVE REGRESS_DEPENDS \
	PERMIT_DISTFILES_CDROM
.  if defined($v)
ERRORS += "Fatal: Variable $v is obsolete, see bsd.port.mk(5)"
.  endif
.endfor

.for t in pre-fetch do-fetch post-fetch pre-package do-package post-package
.  if target($t)
ERRORS += "Fatal: you're not allowed to override $t"
.  endif
.endfor


# some introspection
TARGETS =
.for _t in extract patch distpatch configure build fake install
.  for _s in pre do post
.    if target(${_s}-${_t})
TARGETS += ${_s}-${_t}
.    endif
.  endfor
.endfor
.for _t in post-extract post-patch pre-configure configure pre-fake post-install
.  for _m in ${MODULES:T:U}
.    if defined(MOD${_m}_${_t})
TARGETS += MOD${_m}_${_t}
.    endif
.  endfor
.endfor

SEPARATE_BUILD ?= No

DIST_SUBDIR ?=

.if !empty(DIST_SUBDIR)
FULLDISTDIR ?= ${DISTDIR}/${DIST_SUBDIR}
.else
FULLDISTDIR ?= ${DISTDIR}
.endif

PATCHDIR ?= ${.CURDIR}/patches
PATCH_LIST ?= patch-*
FILESDIR ?= ${.CURDIR}/files
PKGDIR ?= ${.CURDIR}/pkg

PREFIX ?= ${LOCALBASE}
TRUEPREFIX ?= ${PREFIX}
DESTDIRNAME ?= DESTDIR
DESTDIR ?= ${WRKINST}

MAKE_FLAGS ?=
FAKE_FLAGS ?=
LIBTOOL_FLAGS ?=

# User choice, consider read-only from a given port
BASESYSCONFDIR ?= /etc
# where configuration files should actually go
SYSCONFDIR ?= ${BASESYSCONFDIR}

# User choice, consider read-only from a given port
BASELOCALSTATEDIR ?= ${VARBASE}
# Defaut localstatedir for gnu ports
LOCALSTATEDIR ?= ${BASELOCALSTATEDIR}

RCDIR ?= /etc/rc.d
USE_WXNEEDED ?= No
USE_GMAKE ?= No
.if ${USE_GMAKE:L} == "yes"
BUILD_DEPENDS += devel/gmake
MAKE_PROGRAM = ${GMAKE}
CONFIGURE_ENV += MAKE=${MAKE_PROGRAM}
.else
MAKE_PROGRAM = ${MAKE}
.endif
# Even if a port does not actually use libtool, defaulting to Yes does no
# harm since there is a libtool in the base system.
USE_LIBTOOL ?= Yes
_lt_libs =
.if ${USE_LIBTOOL:L} != "no"
.  if ${USE_LIBTOOL:L} == "gnu"
LIBTOOL ?= ${LOCALBASE}/bin/libtool
BUILD_DEPENDS += devel/libtool
.  else
LIBTOOL ?= /usr/bin/libtool
MAKE_ENV += PORTSDIR="${PORTSDIR}"
.  endif
# Massage into an intermediate variable because python does 
# not parse variables with trailing spaces properly and adds 
# a bogus "" argument.
_LIBTOOL = ${LIBTOOL}
.if !empty(LIBTOOL_FLAGS)
_LIBTOOL += "${LIBTOOL_FLAGS}"
.endif
CONFIGURE_ENV += LIBTOOL="${_LIBTOOL}" ${_lt_libs}
MAKE_ENV += LIBTOOL="${_LIBTOOL}" ${_lt_libs}
MAKE_FLAGS += LIBTOOL="${_LIBTOOL}" ${_lt_libs}
.endif
# log for the SHARED_LIBS override
MAKE_FLAGS += SHARED_LIBS_LOG=${WRKBUILD}/shared_libs.log
USE_CCACHE ?= No
NO_CCACHE ?= No
.if ${USE_CCACHE:L} == "yes" && ${NO_CCACHE:L} == "no" && ${NO_BUILD:L} == "no"
CCACHE_DIR ?= ${WRKOBJDIR_${PKGPATH}}/.ccache
MAKE_ENV += CCACHE_DIR=${CCACHE_DIR}
.  if defined(CCACHE_ENV)
MAKE_ENV += ${CCACHE_ENV}
.  endif
CONFIGURE_ENV += CCACHE_DIR=${CCACHE_DIR}
BUILD_DEPENDS += devel/ccache
.endif

# by default, installation (fake) does not need -jN.
ALL_FAKE_FLAGS=	${MAKE_FLAGS:N-j[0-9]*} ${DESTDIRNAME}=${WRKINST} ${FAKE_FLAGS}

.if ${LOCALBASE:L} != "/usr/local"
_PKG_ADD += -L ${LOCALBASE}
.endif

# XXX this stuff is not production-ready, because there are too many bugs in
# parallel make yet.  MAKE_JOBS>1 is known to work on a few ports and used
# sparingly by dpb (DPB_PROPERTIES=parallel) for obvious gains.
#
PARALLEL_BUILD ?= Yes
PARALLEL_INSTALL ?= ${PARALLEL_BUILD}
MAKE_JOBS ?= 1

.if ${MAKE_JOBS} != 1
.  if ${PARALLEL_BUILD:L} == "yes"
MAKE_FLAGS += -j${MAKE_JOBS}
.  endif
.  if ${PARALLEL_INSTALL:L} == "yes"
ALL_FAKE_FLAGS += -j${MAKE_JOBS}
.  endif
.endif

# Here comes the part that sets BUILD_PACKAGES and various IGNORE* up.
.if !defined(_BSD_PORT_ARCH_MK_INCLUDED)
.  include "${PORTSDIR}/infrastructure/mk/bsd.port.arch.mk"
.endif

.for _S in ${MULTI_PACKAGES}
PERMIT_PACKAGE_CDROM${_S} ?= ${PERMIT_PACKAGE_CDROM}
.  if defined(PERMIT_PACKAGE_FTP)
PERMIT_PACKAGE_FTP${_S} ?= ${PERMIT_PACKAGE_FTP}
.  endif
.  if defined(PERMIT_PACKAGE_CDROM${_S}) && ${PERMIT_PACKAGE_CDROM${_S}:L} == "yes"
PERMIT_PACKAGE_FTP${_S} ?= Yes
.  endif
.  if !defined(PERMIT_PACKAGE_CDROM${_S}) || !defined(PERMIT_PACKAGE_FTP${_S})
ERRORS += "The licensing info for ${FULLPKGNAME${_S}} is incomplete."
_BAD_LICENSING = Yes
.  endif
.endfor

.if defined(PERMIT_PACKAGE_CDROM) && ${PERMIT_PACKAGE_CDROM:L} == "yes"
PERMIT_PACKAGE_FTP ?= Yes
PERMIT_DISTFILES_FTP ?= Yes
.elif defined(PERMIT_PACKAGE_FTP) && ${PERMIT_PACKAGE_FTP:L} == "yes"
PERMIT_DISTFILES_FTP ?= Yes
.endif

.if !defined(PERMIT_PACKAGE_CDROM) || !defined(PERMIT_PACKAGE_FTP) || \
	!defined(PERMIT_DISTFILES_FTP)
ERRORS += "The licensing info for ${FULLPKGNAME} is incomplete."
_BAD_LICENSING = Yes
.endif

.if defined(_BAD_LICENSING)
ERRORS += "Please notify the OpenBSD port maintainer:"
ERRORS += "    ${MAINTAINER}"
PERMIT_PACKAGE_CDROM = No
PERMIT_PACKAGE_FTP = No
PERMIT_DISTFILES_FTP = No
.  for _S in ${MULTI_PACKAGES}
PERMIT_PACKAGE_CDROM${_S} = No
PERMIT_PACKAGE_FTP${_S} = No
.  endfor
.endif

.if ${MACHINE_ARCH} != ${ARCH}
PKG_ARCH ?= ${MACHINE_ARCH},${ARCH}
.else
PKG_ARCH ?= ${MACHINE_ARCH}
.endif

REVISION ?=
EPOCH ?=

.for _s in ${MULTI_PACKAGES}
REVISION${_s} ?= ${REVISION}
EPOCH${_s} ?= ${EPOCH}
.endfor

FLAVOR ?=
FLAVORS ?=
PSEUDO_FLAVORS ?=
FLAVORS += ${PSEUDO_FLAVORS}

.if !empty(FLAVORS:Mtest) && empty(FLAVOR:Mtest)
NO_TEST = Yes
.endif

.if empty(SUBPACKAGE)
ERRORS += "Fatal: empty SUBPACKAGE is invalid."
.else
.  for _i in ${SUBPACKAGE}
.    if empty(MULTI_PACKAGES:M${_i})
ERRORS += "Fatal: Subpackage ${SUBPACKAGE} does not exist."
.    endif
.  endfor
.endif
.if !empty(MULTI_PACKAGES:N-*)
ERRORS += "Fatal: SUBPACKAGES should always begin with -: ${MULTI_PACKAGES:N-*}."
.endif

# Build FLAVOR_EXT, checking that no flavors are misspelled
FLAVOR_EXT :=
BASE_PKGPATH := ${PKGPATH}
# _FLAVOR_EXT2 is used internally for working directories.
# It encodes flavors and pseudo-flavors.
_FLAVOR_EXT2 :=
BUILD_PKGPATH := ${PKGPATH}
_PKG_ARGS =
.if !empty(PLIST_DB)
_PKG_ARGS += -DHISTORY_DIR=${PLIST_DB}/history
.endif
_README_DIR = ${LOCALBASE}/share/doc/pkg-readmes

PSEUDO_FLAVOR =
# (applies only to PLIST for now)
.if !empty(FLAVORS)
.  for _i in ${FLAVORS}
.    if empty(FLAVOR:M${_i})
_PKG_ARGS += -D${_i}=0
.    else
_FLAVOR_EXT2 := ${_FLAVOR_EXT2}-${_i}
BUILD_PKGPATH := ${BUILD_PKGPATH},${_i}
.    if empty(PSEUDO_FLAVORS:M${_i})
FLAVOR_EXT := ${FLAVOR_EXT}-${_i}
BASE_PKGPATH := ${BASE_PKGPATH},${_i}
.    else
PSEUDO_FLAVOR := ${PSEUDO_FLAVOR},${_i}
.    endif
_PKG_ARGS += -D${_i}=1
.    endif
.  endfor
.endif
.if !${BUILD_PKGPATH:M*,*}
BUILD_PKGPATH := ${BUILD_PKGPATH},
.endif

.if !empty(FLAVORS:M[0-9]*)
ERRORS += "Fatal: flavor should never start with a digit"
.endif

.if !empty(FLAVOR)
.  if !empty(FLAVORS)
.    for _i in ${FLAVOR}
.      if empty(FLAVORS:M${_i})
ERRORS += "Fatal: Unknown flavor: ${_i}"
ERRORS += "   (Possible flavors are: ${FLAVORS})."
.      endif
.    endfor
.  else
ERRORS += "Fatal: Unknown flavor(s) ${FLAVOR}"
ERRORS += "   (No flavors for this port)."
.  endif
.endif

USE_GROFF ?= No
.if ${USE_GROFF:L} == "yes"
BUILD_DEPENDS += textproc/groff>=1.21
_PKG_ARGS += -DUSE_GROFF=1
.endif

PKGNAME ?= ${DISTNAME}
FULLPKGNAME ?= ${PKGNAME}${FLAVOR_EXT}
_MASTER ?=
_DEPENDENCY_STACK ?=

.if ${MULTI_PACKAGES} == "-"
# XXX "parse" FULLPKGNAME: is there a flavor after the version number
.    if ${FULLPKGNAME:M*-[0-9]*-*}
.      if !empty(REVISION)
# XXX simplest way is to alter FULLPKGNAME in place, even though := is evil...
FULLPKGNAME := ${FULLPKGNAME:C/-([0-9][^-]*)-/-\1p${REVISION}-/}
.      endif
.      if !empty(EPOCH)
FULLPKGNAME := ${FULLPKGNAME:C/-([0-9][^-]*)-/-\1v${EPOCH}-/}
.      endif
.    else
.      if !empty(REVISION)
FULLPKGNAME := ${FULLPKGNAME}p${REVISION}
.      endif
.      if !empty(EPOCH)
FULLPKGNAME := ${FULLPKGNAME}v${EPOCH}
.      endif
.    endif
PKGSPEC ?= ${FULLPKGNAME:C/-[0-9].*/-*/}
PKGSPEC- = ${PKGSPEC}
FULLPKGNAME- = ${FULLPKGNAME}
.else
.  for _s in ${MULTI_PACKAGES}
.    if defined(FULLPKGNAME${_s})
.      if !defined(FULLPKGPATH${_s}) && "${FLAVORS}" != " ${PSEUDO_FLAVORS}"
ERRORS += "Warning: FULLPKGNAME${_s} defined but no FULLPKGPATH${_s}"
.      endif
.    else
.      if defined(PKGNAME${_s})
FULLPKGNAME${_s} = ${PKGNAME${_s}}${FLAVOR_EXT}
.      else
FULLPKGNAME${_s} = ${PKGNAME}${_s}${FLAVOR_EXT}
.      endif
.    endif
# XXX see comments above for !MULTI_PACKAGES case
.    if ${FULLPKGNAME${_s}:M*-[0-9]*-*}
.      if !empty(REVISION${_s})
FULLPKGNAME${_s} := ${FULLPKGNAME${_s}:C/-([0-9][^-]*)-/-\1p${REVISION${_s}}-/}
.      endif
.      if !empty(EPOCH${_s})
FULLPKGNAME${_s} := ${FULLPKGNAME${_s}:C/-([0-9][^-]*)-/-\1v${EPOCH${_s}}-/}
.      endif
.    else
.      if !empty(REVISION${_s})
FULLPKGNAME${_s} := ${FULLPKGNAME${_s}}p${REVISION${_s}}
.      endif
.      if !empty(EPOCH${_s})
FULLPKGNAME${_s} := ${FULLPKGNAME${_s}}v${EPOCH${_s}}
.      endif
.    endif
PKGSPEC${_s} ?= ${FULLPKGNAME${_s}:C/-[0-9].*/-*/}
.  endfor
.endif

_WRKDIR_COOKIE =		${WRKDIR}/.extract_started
_EXTRACT_COOKIE =		${WRKDIR}/.extract_done
_PATCH_COOKIE =			${WRKDIR}/.patch_done
_DISTPATCH_COOKIE =		${WRKDIR}/.distpatch_done
_PREPATCH_COOKIE =		${WRKDIR}/.prepatch_done
_BULK_COOKIE =			${BULK_COOKIES_DIR}/${FULLPKGNAME}
_FAKE_COOKIE =			${WRKINST}/.fake_done
_INSTALL_PRE_COOKIE =	${WRKINST}/.install_started
_UPDATE_COOKIES =
_FUPDATE_COOKIES =
_INSTALL_COOKIES =
.for _S in ${BUILD_PACKAGES}
.  if !empty(UPDATE_COOKIES_DIR)
_UPDATE_COOKIE${_S} =	${UPDATE_COOKIES_DIR}/${FULLPKGNAME${_S}}
_FUPDATE_COOKIE${_S} =	${UPDATE_COOKIES_DIR}/F${FULLPKGNAME${_S}}
.  else
_UPDATE_COOKIE${_S} =	${WRKDIR}/.update_${FULLPKGNAME${_S}}
_FUPDATE_COOKIE${_S} =	${WRKDIR}/.fupdate_${FULLPKGNAME${_S}}
.  endif
_INSTALL_COOKIE${_S} =	${PKG_DBDIR}/${FULLPKGNAME${_S}}/+CONTENTS
_UPDATE_COOKIES += 		${_UPDATE_COOKIE${_S}}
_FUPDATE_COOKIES += 	${_FUPDATE_COOKIE${_S}}
_INSTALL_COOKIES +=		${_INSTALL_COOKIE${_S}}
.endfor
.if ${SEPARATE_BUILD:L} != "no"
_CONFIGURE_COOKIE =		${WRKBUILD}/.configure_done
_BUILD_COOKIE =			${WRKBUILD}/.build_done
_TEST_COOKIE =			${WRKBUILD}/.test_done
.else
_CONFIGURE_COOKIE =		${WRKDIR}/.configure_done
_BUILD_COOKIE =			${WRKDIR}/.build_done
_TEST_COOKIE =			${WRKDIR}/.test_done
.endif

_ALL_COOKIES = ${_EXTRACT_COOKIE} ${_PATCH_COOKIE} ${_CONFIGURE_COOKIE} \
	${_INSTALL_PRE_COOKIE} ${_BUILD_COOKIE} ${_TEST_COOKIE} \
	${_PACKAGE_COOKIES} ${_CACHE_PACKAGE_COOKIES} \
	${_DISTPATCH_COOKIE} ${_PREPATCH_COOKIE} ${_FAKE_COOKIE} \
	${_WRKDIR_COOKIE} ${_DEPBUILD_COOKIES} \
	${_DEPRUN_COOKIES} ${_DEPTEST_COOKIES} ${_UPDATE_COOKIES} \
	${_DEPBUILDLIB_COOKIES} ${_DEPRUNLIB_COOKIES} \
	${_DEPBUILDWANTLIB_COOKIE} ${_DEPRUNWANTLIB_COOKIE} ${_DEPLIBSPECS_COOKIES}

_MAKE_COOKIE = touch

GMAKE ?= gmake

CHECKSUM_FILE ?= ${.CURDIR}/distinfo

# Current digest algorithm
_CIPHER = sha256

PORTPATH ?= ${WRKDIR}/bin:/usr/bin:/bin:/usr/sbin:/sbin:${LOCALBASE}/bin:${X11BASE}/bin

# Add any COPTS to CFLAGS.  Note: programs that use imake do not
# use CFLAGS!  Also, many (most?) ports hard code CFLAGS, ignoring
# what we pass in.
CFLAGS += ${COPTS}
CXXFLAGS += ${CXXOPTS}
WARNINGS ?= no
.if ${WARNINGS:L} == "yes"
CFLAGS += ${CDIAGFLAGS}
CXXFLAGS += ${CXXDIAGFLAGS}
.endif

# XXX trick ports into trying to write into / instead of the current user's
# homedir.
PORTHOME ?= /${PKGNAME}_writes_to_HOME

MAKE_ENV += PATH='${PORTPATH}' PREFIX='${PREFIX}' \
	LOCALBASE='${LOCALBASE}' X11BASE='${X11BASE}' \
	CFLAGS='${CFLAGS:C/ *$//}' \
	TRUEPREFIX='${PREFIX}' ${DESTDIRNAME}='' \
	HOME='${PORTHOME}'

DISTORIG ?= .bak.orig
PATCH ?= /usr/bin/patch
PATCHORIG ?= .orig
PATCH_STRIP ?= -p0
PATCH_DIST_STRIP ?= -p0

PATCH_DEBUG ?= Yes
.if ${PATCH_DEBUG:L} != "no"
PATCH_ARGS ?= -d ${WRKDIST} -z ${PATCHORIG} -E ${PATCH_STRIP}
PATCH_DIST_ARGS ?= -z ${DISTORIG} -d ${WRKDIST} -E ${PATCH_DIST_STRIP}
.else
PATCH_ARGS ?= -d ${WRKDIST} -z ${PATCHORIG} --forward --quiet -E ${PATCH_STRIP}
PATCH_DIST_ARGS ?= -z ${DISTORIG} -d ${WRKDIST} --forward --quiet -E \
	${PATCH_DIST_STRIP}
.endif

.if ${PATCH_CHECK_ONLY:L} == "yes"
PATCH_ARGS += -C
PATCH_DIST_ARGS += -C
.endif

TAR ?= /bin/tar
UNZIP ?= unzip
BZIP2 ?= bzip2


# copy selected info from bsd.own.mk
MAKE_ENV += COMPILER_VERSION=${COMPILER_VERSION} \
	PICFLAG="${PICFLAG}" ASPICFLAG=${ASPICFLAG} \
	BINGRP=bin BINOWN=root BINMODE=${BINMODE} NONBINMODE=${NONBINMODE} \
	DIRMODE=755 \
	INSTALL_COPY=-c INSTALL_STRIP=${INSTALL_STRIP} \
	MANGRP=bin MANOWN=root MANMODE=${MANMODE}
.if defined(NOPIC)
MAKE_ENV += NOPIC=${NOPIC}
.endif


.if !empty(FAKEOBJDIR_${PKGPATH})
WRKINST ?= ${FAKEOBJDIR_${PKGPATH}}/${PKGNAME}${_FLAVOR_EXT2}
.else
WRKINST ?= ${WRKDIR}/fake-${ARCH}${_FLAVOR_EXT2}
.endif

.if ${SEPARATE_BUILD:L:Mflavored}
_WRKDIR_STEM = ${PKGNAME}
.else
_WRKDIR_STEM = ${PKGNAME}${_FLAVOR_EXT2}
.endif

WRKDIR ?= ${WRKOBJDIR_${PKGPATH}}/${_WRKDIR_STEM}
_WRKDIRS = ${WRKOBJDIR_${PKGPATH}}/${_WRKDIR_STEM}
_WRKDIRS += ${WRKOBJDIR}/${_WRKDIR_STEM}
_WRKDIRS += ${WRKOBJDIR_MFS}/${_WRKDIR_STEM}

# github related variables
GH_TAGNAME ?=
GH_COMMIT ?=
GH_ACCOUNT ?=
GH_PROJECT ?=

.if !empty(GH_TAGNAME)
WRKDIST ?= ${WRKDIR}/${GH_PROJECT}-${GH_TAGNAME:C/^v//}
.elif !empty(GH_COMMIT)
WRKDIST ?= ${WRKDIR}/${GH_PROJECT}-${GH_COMMIT}
.else
WRKDIST ?= ${WRKDIR}/${DISTNAME}
.endif

.if !empty(GH_PROJECT) && !empty(GH_TAGNAME)
DISTNAME ?=	${GH_PROJECT}-${GH_TAGNAME:C/^v//}
.endif

WRKSRC ?= ${WRKDIST}

.if ${SEPARATE_BUILD:L} != "no"
WRKBUILD ?= ${WRKDIR}/build-${MACHINE_ARCH}${_FLAVOR_EXT2}
.else
WRKBUILD ?= ${WRKSRC}
.endif
WRKCONF ?= ${WRKBUILD}

XENOCARA_COMPONENT ?= No
# XXX autodetermine makefile actual name, can't do this in
# xenocara.port.mk, since WRKBUILD isn't known yet.
.if ${XENOCARA_COMPONENT:L} == "yes"
.  if exists(${WRKBUILD}/Makefile.bsd-wrapper)
MAKE_FILE ?= Makefile.bsd-wrapper
.  endif
.endif

MAKE_FILE ?= Makefile
ALL_TARGET ?= all

FAKE_TARGET ?= ${INSTALL_TARGET}

TEST_TARGET ?= test
TEST_FLAGS ?= 
TEST_ENV ?=
ALL_TEST_FLAGS = ${MAKE_FLAGS} ${TEST_FLAGS}
ALL_TEST_ENV = ${MAKE_ENV} ${TEST_ENV}
TEST_LOGFILE ?= ${WRKDIR}/test.log
TEST_LOG ?= | tee ${TEST_LOGFILE}
IS_INTERACTIVE ?= No
TEST_IS_INTERACTIVE ?= No

.if ${TEST_IS_INTERACTIVE:L} == "x11"
TEST_ENV += DISPLAY=${DISPLAY} XAUTHORITY=${XAUTHORITY}
XAUTHORITY ?= ${HOME}/.Xauthority
.endif

_PACKAGE_COOKIE_DEPS=${_FAKE_COOKIE} ${_FAKESUDO_CHECK_COOKIE}

.for _s in ${BUILD_PACKAGES}
PKGNAMES += ${FULLPKGNAME${_s}}
PKGFILES += ${PKGFILE${_s}}
PKGPATHS += ${FULLPKGPATH${_s}}
.endfor

STATIC_PLIST ?= Yes
.for _s in ${MULTI_PACKAGES}
.  for _v in PKG_ARCH RUN_DEPENDS WANTLIB LIB_DEPENDS PREFIX CATEGORIES \
	STATIC_PLIST
${_v}${_s} ?= ${${_v}}
.  endfor
.endfor

.for _s in ${MULTI_PACKAGES}
.  for _v in MESSAGE UNMESSAGE DESCR PLIST
.    if defined(${_v})
${_v}${_s} ?= ${${_v}}
.    endif
.  endfor
.endfor

_PACKAGE_LINKS =
NO_ARCH ?= ${MACHINE_ARCH}/no-arch
_PKG_REPO = ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/all/
_TMP_REPO = ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/tmp/
_CACHE_REPO = ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/cache/
PKGFILE = ${_PKG_REPO}${_PKGFILE${SUBPACKAGE}}

.for _S in ${MULTI_PACKAGES}
_PKGFILE${_S} = ${FULLPKGNAME${_S}}.tgz
.  if ${PKG_ARCH${_S}} == "*" && ${NO_ARCH} != ${MACHINE_ARCH}/all
_PACKAGE_COOKIE${_S} = ${PACKAGE_REPOSITORY}/${NO_ARCH}/${_PKGFILE${_S}}
.  else
_PACKAGE_COOKIE${_S} = ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/all/${_PKGFILE${_S}}
.  endif
_CACHE_PACKAGE_COOKIES += ${_CACHE_REPO}${_PKGFILE${_S}}
.endfor

.for _S in ${BUILD_PACKAGES}
.  if ${PKG_ARCH${_S}} == "*" && ${NO_ARCH} != ${MACHINE_ARCH}/all
_PACKAGE_LINKS += ${MACHINE_ARCH}/all/${_PKGFILE${_S}} ${NO_ARCH}/${_PKGFILE${_S}}
_PACKAGE_COOKIES${_S} += ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/all/${_PKGFILE${_S}}
.  endif
_PACKAGE_COOKIES${_S} += ${_PACKAGE_COOKIE${_S}}
.  if ${PERMIT_PACKAGE_FTP${_S}:L} == "yes"
_PACKAGE_COOKIES${_S} += ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/ftp/${_PKGFILE${_S}}
_PACKAGE_LINKS += ${MACHINE_ARCH}/ftp/${_PKGFILE${_S}} ${MACHINE_ARCH}/all/${_PKGFILE${_S}}
.  endif
.  if ${PERMIT_PACKAGE_CDROM${_S}:L} == "yes"
_PACKAGE_COOKIES${_S} += ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/cdrom/${_PKGFILE${_S}}
_PACKAGE_LINKS += ${MACHINE_ARCH}/cdrom/${_PKGFILE${_S}} ${MACHINE_ARCH}/all/${_PKGFILE${_S}}
.  endif
_PACKAGE_COOKIES += ${_PACKAGE_COOKIES${_S}}
_PACKAGE_COOKIE += ${_PACKAGE_COOKIE${_S}}
PKGFILE${_S} = ${_PKG_REPO}${_PKGFILE${_S}}
.endfor

.if empty(SUBPACKAGE) || ${SUBPACKAGE} == "-"
FULLPKGPATH ?= ${PKGPATH}${FLAVOR_EXT:S/-/,/g}
FULLPKGPATH- = ${FULLPKGPATH}
_FULLPKGPATH = ${PKGPATH}${_FLAVOR_EXT2:S/-/,/g}
_ALLPKGPATHS = ${FULLPKGPATH}
.else
_ALLPKGPATHS = ${PKGPATH}${FLAVOR_EXT:S/-/,/g}
.  for _S in ${MULTI_PACKAGES}
FULLPKGPATH${_S} ?= ${PKGPATH},${_S}${FLAVOR_EXT:S/-/,/g}
_ALLPKGPATHS += ${FULLPKGPATH${_S}}
.  endfor
FULLPKGPATH = ${FULLPKGPATH${SUBPACKAGE}}
_FULLPKGPATH = ${PKGPATH},${SUBPACKAGE}${_FLAVOR_EXT2:S/-/,/g}
.endif

FAKE_AS_ROOT ?= No
.if ${FAKE_AS_ROOT:L} == "yes"
_FAKESUDO_CHECK_COOKIE = ${WRKDIR}/.test-sudo
_BINOWNGRP = -o ${BINOWN} -g ${BINGRP}
_SHAREOWNGRP = -o ${SHAREOWN} -g ${SHAREGRP}
_MANOWNGRP = -o ${MANOWN} -g ${MANGRP}
.else
_FAKESUDO =
_FAKESUDO_CHECK_COOKIE =
_BINOWNGRP = 
_SHAREOWNGRP =
_MANOWNGRP =
_INSTALL_WRAPPER = ${PORTSDIR}/infrastructure/bin/install-wrapper
.endif

.if ${FAKE_AS_ROOT:L:Malways-wrap}
_INSTALL = ${_PERLSCRIPT}/install-wrapper
.elif ${FAKE_AS_ROOT:L:Mno}
_INSTALL ?= ${WRKDIR}/bin/install
.else
_INSTALL ?= /usr/bin/install
.endif

# A few aliases for *-install targets
INSTALL_PROGRAM = \
	${_INSTALL} ${INSTALL_COPY} ${INSTALL_STRIP} ${_BINOWNGRP} -m ${BINMODE}
INSTALL_SCRIPT = \
	${_INSTALL} ${INSTALL_COPY} ${_BINOWNGRP} -m ${BINMODE}
INSTALL_DATA = \
	${_INSTALL} ${INSTALL_COPY} ${_SHAREOWNGRP} -m ${SHAREMODE}
INSTALL_MAN = \
	${_INSTALL} ${INSTALL_COPY} ${_MANOWNGRP} -m ${MANMODE}

INSTALL_PROGRAM_DIR = \
	${_INSTALL} -d ${_BINOWNGRP} -m ${DIRMODE}
INSTALL_SCRIPT_DIR = \
	${INSTALL_PROGRAM_DIR}
INSTALL_DATA_DIR = \
	${_INSTALL} -d ${_SHAREOWNGRP} -m ${DIRMODE}
INSTALL_MAN_DIR = \
	${_INSTALL} -d ${_MANOWNGRP} -m ${DIRMODE}

WRKOBJDIR_MODE ?=
DISTDIR_MODE ?= ${WRKOBJDIR_MODE}
PACKAGE_REPOSITORY_MODE ?= ${WRKOBJDIR_MODE}
LOCKDIR_MODE ?= ${WRKOBJDIR_MODE}
PLISTDIR_MODE ?= ${WRKOBJDIR_MODE}

_INSTALL_MACROS = BSD_INSTALL_PROGRAM="${INSTALL_PROGRAM}" \
	BSD_INSTALL_SCRIPT="${INSTALL_SCRIPT}" \
	BSD_INSTALL_DATA="${INSTALL_DATA}" \
	BSD_INSTALL_MAN="${INSTALL_MAN}" \
	BSD_INSTALL_PROGRAM_DIR="${INSTALL_PROGRAM_DIR}" \
	BSD_INSTALL_SCRIPT_DIR="${INSTALL_SCRIPT_DIR}" \
	BSD_INSTALL_DATA_DIR="${INSTALL_DATA_DIR}" \
	BSD_INSTALL_MAN_DIR="${INSTALL_MAN_DIR}"
MAKE_ENV += ${_INSTALL_MACROS}

# setup for libtool
SHARED_LIBS ?=

.for _n _v in ${SHARED_LIBS}
LIB${_n}_VERSION = ${_v}
SUBST_VARS += LIB${_n}_VERSION
_lt_libs += LIB${_n}_LTVERSION='-version-info ${_v:S/./:/}:0'
_lt_libs += lib${_n:S/+/_/g:S/-/_/g:S/./_/g}_ltversion=${_v}
.endfor

# Create the generic variable substitution list, from subst vars
SUBST_VARS += MACHINE_ARCH ARCH HOMEPAGE ^PREFIX ^SYSCONFDIR FLAVOR_EXT \
	FULLPKGNAME MAINTAINER ^BASE_PKGPATH ^LOCALBASE ^X11BASE ^TRUEPREFIX \
	^RCDIR ^LOCALSTATEDIR
_tmpvars =

_PKG_ADD_AUTO ?=
.if !empty(_DEPENDENCY_STACK)
_PKG_ADD_AUTO += -a
.endif

_TERM_ENV = PKG_TMPDIR=${PKG_TMPDIR}
.for _v in TERM TERMCAP ftp_proxy http_proxy
.  if defined(${_v})
_TERM_ENV += ${_v}=${${_v}:Q}
.  endif
.endfor

# See bsd.lib.mk:162
.if ${MACHINE_ARCH:Mmips64*}
_PKG_ARGS += -Dno_mips64=0
.else
_PKG_ARGS += -Dno_mips64=1
.endif

_PKG_ARGS += -DFLAVORS=${FLAVOR_EXT:Q}
_tmpvars += FLAVORS=${FLAVOR_EXT:Q}
_PKG_ARGS += -B ${WRKINST}
.if ${LOCALBASE} != "/usr/local"
_PKG_ARGS += -L${LOCALBASE}
.endif

.for _S in ${MULTI_PACKAGES}
PKG_ARGS${_S} ?= ${PKG_ARGS}
PKG_ARGS${_S} += ${_PKG_ARGS}
.  for _v in ${SUBST_VARS}
.    if defined(${_v:S/^^//}${_S})
_substvars${_S} += -D${_v}=${${_v:S/^^//}${_S}:Q}
_tmpvars += ${_v}${_S}=${${_v:S/^^//}${_S}:Q}
.    else
_substvars${_S} += -D${_v}=${${_v:S/^^//}:Q}
_tmpvars += ${_v}=${${_v:S/^^//}:Q}
.    endif
.  endfor

PKG_ARGS${_S} += ${_substvars${_S}}
PKG_ARGS${_S} += -DFULLPKGPATH=${FULLPKGPATH${_S}}
PKG_ARGS${_S} += -DPERMIT_PACKAGE_CDROM=${PERMIT_PACKAGE_CDROM${_S}:Q}
PKG_ARGS${_S} += -DPERMIT_PACKAGE_FTP=${PERMIT_PACKAGE_FTP${_S}:Q}
.  if !empty(REVISION${_S})
PKG_ARGS${_S} += -DREVISION=${REVISION${_S}}
.  endif
.  if !empty(EPOCH${_S})
PKG_ARGS${_S} += -DEPOCH=${EPOCH${_S}}
.  endif

SUBST_CMD${_S} = ${_PERLSCRIPT}/pkg_subst ${_substvars${_S}}
.  if ${FAKE_AS_ROOT:L} == "no"
SUBST_CMD${_S} += -i
.  endif
SUBST_CMD${_S} += -B ${WRKDIR}
.endfor

SUBST_CMD = ${_PERLSCRIPT}/pkg_subst
.for _v in ${SUBST_VARS}
SUBST_CMD += -D${_v}=${${_v:S/^^//}:Q}
.endfor
.if ${FAKE_AS_ROOT:L} == "no"
SUBST_CMD += -i
.endif
SUBST_CMD += -B ${WRKDIR}

SUBST_PROGRAM = ${SUBST_CMD} -c ${_BINOWNGRP} -m ${BINMODE}
SUBST_DATA = ${SUBST_CMD} -c ${_SHAREOWNGRP} -m ${SHAREMODE}
SUBST_MAN = ${SUBST_CMD} -c ${_MANOWNGRP} -m ${MANMODE}

# XXX
.if ${MULTI_PACKAGES} == "-"
PLIST ?= ${PKGDIR}/PLIST

.  if defined(COMMENT${FLAVOR_EXT})
_COMMENT = ${COMMENT${FLAVOR_EXT}}
.  elif defined(COMMENT)
_COMMENT = ${COMMENT}
.  endif

.  if exists(${PKGDIR}/MESSAGE)
MESSAGE ?= ${PKGDIR}/MESSAGE
.  endif

.  if exists(${PKGDIR}/UNMESSAGE)
UNMESSAGE ?= ${PKGDIR}/UNMESSAGE
.  endif

DESCR ?= ${PKGDIR}/DESCR

.  for _v in PLIST _COMMENT MESSAGE UNMESSAGE DESCR
.    if defined(${_v})
${_v}- = ${${_v}}
.    endif
.  endfor
.else
.  for _S in ${MULTI_PACKAGES}
PLIST${_S} ?= ${PKGDIR}/PLIST${_S}

.    if defined(COMMENT${_S}${FLAVOR_EXT})
_COMMENT${_S} = ${COMMENT${_S}${FLAVOR_EXT}}
.    elif defined(COMMENT${_S})
_COMMENT${_S} = ${COMMENT${_S}}
.    endif

.    if exists(${PKGDIR}/MESSAGE${_S})
MESSAGE${_S} ?= ${PKGDIR}/MESSAGE${_S}
.    endif

.    if exists(${PKGDIR}/UNMESSAGE${_S})
UNMESSAGE${_S} ?= ${PKGDIR}/UNMESSAGE${_S}
.    endif

DESCR${_S} ?= ${PKGDIR}/DESCR${_S}

.  endfor
.endif

MTREE_FILE ?=

.if ${XENOCARA_COMPONENT:L} == "yes"
MTREE_FILE += /etc/mtree/BSD.x11.dist
.else
MTREE_FILE += ${PORTSDIR}/infrastructure/db/fake.mtree
.endif

.for _S in ${MULTI_PACKAGES}
# Fill out package command, and package dependencies
PKG_ARGS${_S} += -DCOMMENT=${_COMMENT${_S}:Q} -d ${DESCR${_S}}
PKG_ARGS${_S} += -f ${PLIST${_S}} -p ${PREFIX${_S}}
.  if defined(MESSAGE${_S}) && !empty(MESSAGE${_S})
PKG_ARGS${_S} += -M ${MESSAGE${_S}}
.  endif
.  if defined(UNMESSAGE${_S}) && !empty(UNMESSAGE${_S})
PKG_ARGS${_S} += -U ${UNMESSAGE${_S}}
.  endif
PKG_ARGS${_S} += -A'${PKG_ARCH${_S}}'
.  if !defined(_COMMENT${_S})
ERRORS += "Fatal: Missing comment for ${_S:S/^-$/main package/}."
.  endif
.endfor

GZIP ?= -9
GZIP_CMD ?= /usr/bin/gzip -nf ${GZIP}
M4 ?= /usr/bin/m4
STRIP ?= /usr/bin/strip

# Autoconf scripts MAY tend to use bison by default otherwise
YACC ?= yacc
# XXX ${SETENV} is needed in front of var=value lists whenever the next
# command is expanded from a variable, as this could be a shell construct
SETENV ?= /usr/bin/env -i

# Used to print all the '===>' style prompts - override this to turn them off.
ECHO_MSG ?= echo

# basic master sites configuration

MASTER_SITE_OVERRIDE ?= No

.if exists(${PORTSDIR}/infrastructure/db/network.conf)
.include "${PORTSDIR}/infrastructure/db/network.conf"
.else
.include "${PORTSDIR}/infrastructure/templates/network.conf.template"
.endif

.if !empty(GH_ACCOUNT) && !empty(GH_PROJECT)
.  if !empty(GH_COMMIT) && !empty(GH_TAGNAME)
ERRORS += "Fatal: specifying both GH_TAGNAME and GH_COMMIT is invalid"
.  endif
.  if ${GH_TAGNAME} == master
ERRORS += "Fatal: using master as GH_TAGNAME is invalid"
.  endif
MASTER_SITES_GITHUB += \
	https://github.com/${GH_ACCOUNT}/${GH_PROJECT}/archive/${GH_TAGNAME:S/$/\//}

MASTER_SITES ?= ${MASTER_SITES_GITHUB}
HOMEPAGE ?= https://github.com/${GH_ACCOUNT}/${GH_PROJECT}
.else
# Empty declarations to avoid "variable XXX is recursive" errors
MASTER_SITES ?=
.endif

# I guess we're in the master distribution business! :)  As we gain mirror
# sites for distfiles, add them to this list.
.if ${MASTER_SITE_OVERRIDE:L} == "no"
MASTER_SITES := ${MASTER_SITES} ${MASTER_SITE_BACKUP}
.else
MASTER_SITES := ${MASTER_SITE_OVERRIDE} ${MASTER_SITES}
.endif

_warn_checksum = :
.if !empty(MASTER_SITES:M*[^/])
_warn_checksum += ;echo ">>> MASTER_SITES not ending in /: ${MASTER_SITES:M*[^/]}"
.endif

.for _I in 0 1 2 3 4 5 6 7 8 9
.  if defined(MASTER_SITES${_I})
.    if !empty(MASTER_SITES${_I}:M*[^/])
_warn_checksum += ;echo ">>> MASTER_SITES${_I} not ending in /: ${MASTER_SITES${_I}:M*[^/]}"
.    endif
.    if ${MASTER_SITE_OVERRIDE:L} == "no"
MASTER_SITES${_I} := ${MASTER_SITES${_I}} ${MASTER_SITE_BACKUP}
.    else
MASTER_SITES${_I} := ${MASTER_SITE_OVERRIDE} ${MASTER_SITES${_I}}
.    endif
.  endif
.endfor


EXTRACT_SUFX ?= .tar.gz

.if !empty(GH_COMMIT)
DISTFILES ?= ${DISTNAME}${EXTRACT_SUFX}{${GH_COMMIT}${EXTRACT_SUFX}}
.else
DISTFILES ?= ${DISTNAME}${EXTRACT_SUFX}
.endif

PATCHFILES ?=
SUPDISTFILES ?=

# the following loop "parses" DISTFILES-style files
# _PATH_x contains filenames with SUBDIR prepended when necessary
# _LIST_x contains pure filenames
#
# _FULL_FETCH_LIST is used for creating all targets later on:
# 	say if DISTFILES=filename{url}sufx:0 DIST_SUBDIR=foo/
#	it will expand to  foo/filenamesufx filename MASTER_SITES0 urlsufx
#
# _FILES is used to de-duplicates names
# the order matters: DISTFILES PATCHFILES SUPDISTFILES
# - we never have the same names in DISTFILES and PATCHFILES
# - SUPDISTFILES has to happen later
_FILES=
.for v in DISTFILES PATCHFILES SUPDISTFILES
.  if !empty($v)
.    for e in ${$v}
.      for f m u in ${e:C/:[0-9]$//:C/(.*)\{.*\}(.*)/\1\2/} MASTER_SITES${e:M*\:[0-9]:C/.*:([0-9])/\1/} ${e:C/:[0-9]$//:C/.*\{(.*)\}(.*)/\1\2/}
.        if empty(_FILES:M$f)
_FILES += $f
.          if empty(DIST_SUBDIR)
_FULL_FETCH_LIST += $f $f $m $u
_PATH_$v += $f
.          else
_FULL_FETCH_LIST += ${DIST_SUBDIR}/$f $f $m $u
_PATH_$v += ${DIST_SUBDIR}/$f
.          endif
_LIST_$v += $f
.        endif
.      endfor
.    endfor
.  else
_PATH_$v =
_LIST_$v =
.  endif
.endfor
_FULL_FETCHLIST ?=

CHECKSUMFILES = ${_PATH_DISTFILES} ${_PATH_PATCHFILES}
MAKESUMFILES = ${CHECKSUMFILES} ${_PATH_SUPDISTFILES}

# This is what is actually going to be extracted, and is overridable
# by the user.
EXTRACT_ONLY ?= ${_LIST_DISTFILES}

PATCH_CASES ?=
EXTRACT_CASES ?=

_LIST_EXTRACTED = ${EXTRACT_ONLY} ${_LIST_PATCHFILES}

# okay, time for some guess work
# this is mostly ad-hoc, we may want to add more PATCH_CASES eventually.
.if !empty(_LIST_EXTRACTED:M*.zip)
BUILD_DEPENDS += archivers/unzip
EXTRACT_CASES += *.zip) \
	${UNZIP} -oq ${FULLDISTDIR}/$$archive -d ${WRKDIR};;
.endif

.if !empty(_LIST_EXTRACTED:M*.xz) || \
	!empty(_LIST_EXTRACTED:M*.lzma)
BUILD_DEPENDS += archivers/xz
EXTRACT_CASES += *.tar.xz) \
	xzdec <${FULLDISTDIR}/$$archive | ${TAR} xf -;;
EXTRACT_CASES += *.tar.lzma) \
	lzmadec <${FULLDISTDIR}/$$archive | ${TAR} xf -;;
.endif

.if !empty(_LIST_EXTRACTED:M*.tar.lz)
BUILD_DEPENDS += archivers/lzip/lunzip
EXTRACT_CASES += *.tar.lz) \
	lunzip <${FULLDISTDIR}/$$archive | ${TAR} xf -;;
PATCH_CASES += *.lz) \
	lunzip <$$patchfile | ${PATCH} ${PATCH_DIST_ARGS};;
.endif

.if !empty(_LIST_EXTRACTED:M*.bz2) || \
	!empty(_LIST_EXTRACTED:M*.tbz2) || \
	!empty(_LIST_EXTRACTED:M*.tbz)
BUILD_DEPENDS += archivers/bzip2
EXTRACT_CASES += *.tar.bz2|*.tbz2|*.tbz) \
	${BZIP2} -d <${FULLDISTDIR}/$$archive | ${TAR} xf -;;
PATCH_CASES += *.bz2) \
	${BZIP2} -d <$$patchfile | ${PATCH} ${PATCH_DIST_ARGS};;
.endif


_PERL_FIX_SHAR ?= perl -ne 'print if $$s || ($$s = m:^\#(\!\s*/bin/sh\s*| This is a shell archive):)'

EXTRACT_CASES += *.tar) \
	${TAR} xf ${FULLDISTDIR}/$$archive;;
EXTRACT_CASES += *.shar.gz|*.shar.Z|*.sh.gz|*.sh.Z) \
	${GZIP_CMD} -d <${FULLDISTDIR}/$$archive | ${_PERL_FIX_SHAR} | /bin/sh;;
EXTRACT_CASES += *.shar | *.sh) \
	${_PERL_FIX_SHAR} ${FULLDISTDIR}/$$archive | /bin/sh;;
EXTRACT_CASES += *.tar.gz|*.tgz) \
	${GZIP_CMD} -d <${FULLDISTDIR}/$$archive | ${TAR} xf -;;
EXTRACT_CASES += *.gz) \
	${GZIP_CMD} -d <${FULLDISTDIR}/$$archive >$$(basename $$archive .gz);;
EXTRACT_CASES += *) \
	${GZIP_CMD} -d <${FULLDISTDIR}/$$archive | ${TAR} xf -;;

PATCH_CASES += *.Z|*.gz) \
	${GZIP_CMD} -d <$$patchfile | ${PATCH} ${PATCH_DIST_ARGS};;
PATCH_CASES += *) \
	${PATCH} ${PATCH_DIST_ARGS} < $$patchfile;;

# Documentation
MAINTAINER ?= The OpenBSD ports mailing-list <ports@@openbsd.org>
.if empty(MAINTAINER)
ERRORS += "Fatal: defining MAINTAINER to empty is an error"
.endif

.if !defined(CATEGORIES)
ERRORS += "Fatal: CATEGORIES is mandatory."
.else
_badcat = Yes
.  for _i in ${CATEGORIES}
.    if ${_badcat} == "Yes"
.      if ${PKGPATH:M${_i}/*}
_badcat = No
.      endif
.    endif
.  endfor

.  if ${_badcat} == "Yes"
ERRORS += "Fatal: one category in ${CATEGORIES} should match PKGPATH=${PKGPATH}"
.    if ${PKGPATH:N*/*}
ERRORS += "Fatal: bogus PKGPATH=${PKGPATH} (no subdirectory)"
.    endif
.  endif
.endif



CONFIGURE_SCRIPT ?= configure
.if ${CONFIGURE_SCRIPT:M/*}
_CONFIGURE_SCRIPT = ${CONFIGURE_SCRIPT}
.else
.  if ${SEPARATE_BUILD:L} != "no"
_CONFIGURE_SCRIPT = ${WRKSRC}/${CONFIGURE_SCRIPT}
.  else
_CONFIGURE_SCRIPT = ./${CONFIGURE_SCRIPT}
.  endif
.endif

CONFIGURE_ENV += PATH=${PORTPATH}

FETCH_MANUALLY ?= No
MISSING_FILES =
.if ${FETCH_MANUALLY:L} != "no"
.  for _F in ${CHECKSUMFILES}
.    if !exists(${DISTDIR}/${_F})
MISSING_FILES += ${_F}
.    endif
.  endfor
.endif

################################################################
# Many ways to disable a port.
#
# A lot of them actually occur earlier on, in bsd.port.arch.mk
#
# If we're in BATCH mode and the port is interactive, or we're
# in interactive mode and the port is non-interactive, skip all
# the important targets.  The reason we have two modes is that
# one might want to leave a build in BATCH mode running
# overnight, then come back in the morning and do _only_ the
# interactive ones that required your intervention.
#
# Ignore ports that can't be resold if building for a CDROM.
#
# Don't build a port if it's broken.
#
# Don't build a port if it comes with the base system.
################################################################
TRY_BROKEN ?= No
_IGNORE_TEST ?=
.if ${TEST_IS_INTERACTIVE:L} != "no" && defined(BATCH)
_IGNORE_TEST += "has interactive tests"
.elif ${TEST_IS_INTERACTIVE:L} == "no" && defined(INTERACTIVE)
_IGNORE_TEST += "does not have interactive tests"
.endif

.if ${IS_INTERACTIVE:L} != "no" && defined(BATCH)
IGNORE += "is an interactive port"
.elif !(${IS_INTERACTIVE:L} != "no" || !empty(MISSING_FILES)) && defined(INTERACTIVE)
IGNORE += "is not an interactive port"
.endif
.if !empty(MISSING_FILES) && defined(BATCH)
_EXTRA_IGNORE += "is an interactive port: missing files"
.endif

.if ${TRY_BROKEN:L} != "yes"
.  if defined(BROKEN-${ARCH})
IGNORE += "is marked as broken for ${ARCH}: ${BROKEN-${ARCH}:Q}"
.  endif
.  if ${MACHINE_ARCH} != ${ARCH} && defined(BROKEN-${MACHINE_ARCH})
IGNORE += "is marked as broken for ${MACHINE_ARCH}: ${BROKEN-${MACHINE_ARCH}:Q}"
.  endif
.  if defined(BROKEN)
IGNORE += "is marked as broken: ${BROKEN:Q}"
.  endif
.endif
.if defined(COMES_WITH)
IGNORE += "-- ${FULLPKGNAME${SUBPACKAGE}:C/-[0-9].*//g} comes with OpenBSD as of release ${COMES_WITH}"
.endif

IGNORE_IS_FATAL ?= "No"
# XXX even if subpackage is invalid, define this, so that errors come out
# from ERRORS and not make internals.
IGNORE${SUBPACKAGE} ?=
.if (!empty(IGNORE${SUBPACKAGE}) || defined(_EXTRA_IGNORE)) && ${IGNORE_IS_FATAL:L} == "yes"
ERRORS += "Fatal: can't build"
ERRORS += ${IGNORE${SUBPACKAGE}} ${_EXTRA_IGNORE}
.endif

_DEPENDS_TARGET ?= install

################################################################
# Dependency checking
################################################################

# Various dependency styles
_resolve_lib = LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} \
			${_PERLSCRIPT}/resolve-lib

PKG_CREATE_NO_CHECKS ?= No
.if ${PKG_CREATE_NO_CHECKS:L} == "yes"
_pkg_wantlib_args = fake-wantlib-args
.elif ${PKG_CREATE_NO_CHECKS:L} == "warn"
_pkg_wantlib_args = wantlib-args
_check_msg = Warning
# ignore diff error
_check_error = || true
.else
_pkg_wantlib_args = wantlib-args
_check_msg = Error
# let diff error out
_check_error =
.endif
wantlib_args ?= port-wantlib-args
lib_depends_args ?= lib-depends-args



.if ${FORCE_UPDATE:L} == "yes" || ${FORCE_UPDATE:L} == "hard"
_force_update_fragment = { \
		${ECHO_MSG} "===>  Verifying update for $$pkg in $$dir"; \
		if ( eval $$toset exec ${MAKE} subupdate ); then \
			${ECHO_MSG} "===> Returning to build of ${FULLPKGNAME${SUBPACKAGE}}${_MASTER}"; \
		else \
			${REPORT_PROBLEM}; \
			exit 1; \
		fi; \
	}
_PKG_ADD_FORCE = -D update -D updatedepends
.  if ${FORCE_UPDATE:L} == "hard"
_PKG_ADD_FORCE += -D installed
.  endif
.else
_force_update_fragment = :
_PKG_ADD_FORCE =
.endif

_FULL_PACKAGE_NAME ?= No

# We check for dependency syntax errors before rewriting things.
_CHECK_DEPENDS =
.for _v in BUILD LIB RUN TEST
_CHECK_DEPENDS +:= ${${_v}_DEPENDS}
.endfor
.for _s in ${MULTI_PACKAGES}
.  for _v in RUN LIB
_CHECK_DEPENDS +:= ${${_v}_DEPENDS${_s}}
.  endfor
.endfor
.if ${_CHECK_DEPENDS:M\:*}
ERRORS += "Fatal: old style depends ${_CHECK_DEPENDS:M\:*}"
.endif

# the C,...., part basically does this:
# if the depends contains only pkgpath>=something
# then we rebuild it as STEM->=something:pkgpath

.for _v in BUILD LIB RUN TEST
${_v}_DEPENDS := ${${_v}_DEPENDS:C,^([^:]+/[^:<=>]+)([<=>][^:]+)$,STEM-\2:\1,}
.endfor
.for _v in BUILD TEST
${_v}_DEPENDS := ${${_v}_DEPENDS:C,^([^:]+/[^:<=>]+)([<=>][^:]+)(:patch|:configure|:build)$,STEM-\2:\1\3,}
.endfor
.for _s in ${MULTI_PACKAGES}
.  for _v in RUN LIB
${_v}_DEPENDS${_s} := ${${_v}_DEPENDS${_s}:C,^([^:]+/[^:<=>]+)([<=>][^:]+)$,STEM-\2:\1,}
.  endfor
.endfor


_BUILDLIB_DEPENDS = 
_BUILDWANTLIB = 
# strip inter-multi-packages dependencies during building
.for _path in ${PKGPATH:S,^mystuff/,,}
.  for _s in ${BUILD_PACKAGES}
_BUILDLIB_DEPENDS += ${LIB_DEPENDS${_s}:N*\:${_path}:N*\:${_path},*:N${_path}:N${_path},*}
_BUILDWANTLIB += ${WANTLIB${_s}}
_LIB4${_s} = ${LIB_DEPENDS${_s}:M*\:${_path}} ${LIB_DEPENDS${_s}:M*\:${_path},*} ${LIB_DEPENDS${_s}:M${_path}} ${LIB_DEPENDS${_s}:M${_path},*}
_LIB4 += ${_LIB4${_s}}
.  endfor
.endfor

# automatically try to determine USE_X11 from wantlib
USE_X11 ?= No
.for _lib in X11 GL ICE xcb pixman freetype Xft
.  if ${USE_X11:L} != "yes"
.    for _b in ${_BUILDWANTLIB:C/[>=].*//}
.      if "${_b:M${_lib}}"
USE_X11 = Yes
.      endif
.    endfor
.  endif
.endfor

.if ${USE_X11:L} == "yes" && ${PORTS_BUILD_XENOCARA_TOO:L} == "yes"
BUILD_DEPENDS += base/xenocara/meta
.endif

.if ${NO_DEPENDS:L} == "no"
_BUILD_DEPLIST = ${BUILD_DEPENDS}
_RUN_DEPLIST = ${RUN_DEPENDS${SUBPACKAGE}}
_TEST_DEPLIST = ${TEST_DEPENDS}
_BUILDLIB_DEPLIST = ${_BUILDLIB_DEPENDS}
_RUNLIB_DEPLIST = ${LIB_DEPENDS${SUBPACKAGE}}
.endif

_DEPLIST = ${_BUILD_DEPLIST} ${_RUN_DEPLIST} ${_TEST_DEPLIST} \
	${_BUILDLIB_DEPLIST} ${_RUNLIB_DEPLIST}

# compute DEPBUILD_COOKIES and friends
.for _DEP in BUILD RUN BUILDLIB RUNLIB TEST
.  for _i in ${_${_DEP}_DEPLIST}
_DEP${_DEP}_COOKIES += ${WRKDIR}/.dep-${_i:C,>=,ge-,g:C,<=,le-,g:C,<,lt-,g:C,>,gt-,g:C,\*,ANY,g:C,[|:/=],-,g}
.  endfor
_DEP${_DEP}_COOKIES ?=
.endfor

# Normal user-mode targets are PHONY targets, e.g., don't create the
# corresponding file. However, there is nothing phony about the cookie.

MODSIMPLE_configure = \
	cd ${WRKCONF} && ${SETENV} \
		CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS:C/ *$//}" \
		CXX="${CXX}" ac_cv_path_CXX="${CXX}" CXXFLAGS="${CXXFLAGS:C/ *$//}" \
		INSTALL="${_INSTALL} -c ${_BINOWNGRP}" \
		ac_given_INSTALL="${_INSTALL} -c ${_BINOWNGRP}" \
		INSTALL_PROGRAM="${INSTALL_PROGRAM}" INSTALL_MAN="${INSTALL_MAN}" \
		INSTALL_SCRIPT="${INSTALL_SCRIPT}" INSTALL_DATA="${INSTALL_DATA}" \
		YACC="${YACC}" \
		${CONFIGURE_ENV} ${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS}

FAKE_SETUP = PATH='${PORTPATH}' TRUEPREFIX=${PREFIX} \
	PREFIX=${WRKINST}${PREFIX} ${DESTDIRNAME}=${WRKINST}

_CLEANDEPENDS ?= Yes

# Internal variables, used by dependencies targets
# Only keep pkg:dir spec, strip extra target

.for _mod in C/:(patch|configure|build)$$//
_BUILD_DEP2 = ${BUILD_DEPENDS:${_mod}}
_BUILD_DEP3 = ${BUILD_DEPENDS:${_mod}}

_RUN_DEP2 = ${RUN_DEPENDS${SUBPACKAGE}:${_mod}}
_RUN_DEP3 = ${RUN_DEPENDS${SUBPACKAGE}:${_mod}}

_TEST_DEP2 = ${TEST_DEPENDS:${_mod}}
_TEST_DEP3 = ${_TEST_DEP2}

_RUN_DEP2 += ${LIB_DEPENDS${SUBPACKAGE}:${_mod}}
_LIB_DEP3 = ${LIB_DEPENDS${SUBPACKAGE}}

_BUILD_DEP2 += ${_BUILDLIB_DEPENDS:${_mod}}

.  for _S in ${MULTI_PACKAGES}
_BUILD_DEP3${_S} = ${_BUILD_DEP3}
_RUN_DEP3${_S} = ${RUN_DEPENDS${_S}:${_mod}}
_LIB_DEP3${_S} = ${LIB_DEPENDS${_S}}
.  endfor

.endfor

_DEPBUILDLIBS = ${_BUILDWANTLIB}
_DEPRUNLIBS = ${WANTLIB${SUBPACKAGE}}

# the _DEP*LIBSPECS_COOKIES are only there to force reevaluation of
# _DEPBUILDWANTLIB_COOKIE and _DEPRUNWANTLIB_COOKIE when the dependencies
# change (the list will change, and so the cookie will be regenerated)
.if ${NO_DEPENDS:L} == "no"
.  for i in ${_DEPBUILDLIBS:C,>=,-ge-,g:C,=,-gt-,g:C,/,-,g}
_DEPBUILDLIBSPECS_COOKIES += ${WRKDIR}/.spec-$i
.  endfor
_DEPBUILDWANTLIB_COOKIE = ${WRKDIR}/.buildwantlibs
.  for i in ${_DEPRUNLIBS:C,>=,-ge-,g:C,=,-gt-,g:C,/,-,g}
_DEPRUNLIBSPECS_COOKIES += ${WRKDIR}/.spec-$i
.  endfor
_DEPRUNWANTLIB_COOKIE = ${WRKDIR}/.runwantlibs${SUBPACKAGE}
.else
_DEPBUILDWANTLIB_COOKIE =
_DEPRUNWANTLIB_COOKIE =
.endif

_DEPLIBSPECS_COOKIES = ${_DEPBUILDLIBSPECS_COOKIES} ${_DEPRUNLIBSPECS_COOKIES}

# strip optional pkgspec, only keep the path
_BUILD_DEP = ${_BUILD_DEP2:C,^[^:/]*:,,}
_RUN_DEP = ${_RUN_DEP2:C,^[^:/]*:,,}
_TEST_DEP = ${_TEST_DEP2:C,^[^:/]*:,,}

REORDER_DEPENDENCIES ?=
ECHO_REORDER ?= :

# Lock infrastructure:
# to remove locks handling, define LOCKDIR to an empty value
LOCKDIR ?= ${WRKOBJDIR}/locks

LOCK_CMD ?= ${_PERLSCRIPT}/dolock
UNLOCK_CMD ?= rm -f
_LOCKS_HELD ?=
LOCK_VERBOSE ?= No
.if !empty(LOCKDIR)
.  if ${LOCK_VERBOSE:L} == "yes"
_LOCK = echo "Locking $$lock (${BUILD_PKGPATH}) from $@@"; ${LOCK_CMD} ${LOCKDIR_MODE} ${LOCKDIR}/$$lock.lock ${BUILD_PKGPATH}
_UNLOCK = echo "Unlocking $$lock from $@@"; ${UNLOCK_CMD} ${LOCKDIR}/$$lock.lock
.  else
_LOCK = ${LOCK_CMD} ${LOCKDIR_MODE} ${LOCKDIR}/$$lock.lock ${BUILD_PKGPATH}
_UNLOCK = ${UNLOCK_CMD} ${LOCKDIR}/$$lock.lock
.  endif
.  if ${SEPARATE_BUILD:L:Mflavored}
_LOCKNAME = ${FULLPKGNAME}
.  else
_LOCKNAME = ${PKGNAME}
.  endif

.  for _i in ${_LOCKNAME}
.    if empty(_LOCKS_HELD:M${_i})
_DO_LOCK = \
	lock=${_LOCKNAME}; \
	_LOCKS_HELD="${_LOCKS_HELD} ${_LOCKNAME}"; export _LOCKS_HELD; \
	${_SIMPLE_LOCK}
.    endif
.  endfor

_SIMPLE_LOCK = \
	${_LOCK}; locked=true; \
	trap 'if $$locked; then ${_UNLOCK}; locked=false; fi' 0; \
	trap 'exit 1' 1 2 3 13 15

.endif
_SIMPLE_LOCK ?= :
_DO_LOCK ?= :

CHECKSUM_PACKAGES ?= No
_PACKAGE_CHECKSUM_DIR = ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/cksums

_do_checksum_package = \
	install -d ${PACKAGE_REPOSITORY_MODE} ${_PACKAGE_CHECKSUM_DIR} && \
	cd ${_TMP_REPO} && \
	cksum -b -a sha256 $$pkgname \
		>${_PACKAGE_CHECKSUM_DIR}/$$(basename $$pkgname .tgz).sha256

.if ${CHECKSUM_PACKAGES:L} == "yes"
_checksum_package = ${_do_checksum_package}
.elif ${CHECKSUM_PACKAGES:L} == "ftp"
_checksum_package = \
	case $${permit_ftp} in yes) \
		${_do_checksum_package};; \
	esac
.elif ${CHECKSUM_PACKAGES:L} == "cdrom"
_checksum_package = \
	case $${permit_cdrom} in yes) \
		${_do_checksum_package};; \
	esac
.else
_checksum_package = :
.endif

_size_fragment = perl -e '$$s = (stat $$ARGV[0])[7]; print "SIZE ($$ARGV[1]) = $$s\n";'

# commands used all the time
_lines2list = tr '\012' '\040' | sed -e 's, $$,,'

_zap_last_line = sed -e '$$d'

_sort_dependencies = tsort -r|${_zap_last_line}

_version2stem = sed -e 's,-[0-9].*,,'

_grab_libs_from_plist = sed -n -e '/^@@lib /{ s///; p; }' \
	-e '/^@@file .*\/lib\/lib.*\.a$$/{ s/^@@file //; p; }'

# used in the following pattern
# while $(_read_spec); do $(_parse_spec); done

_read_spec = IFS=: read pkg subdir target
_parse_spec = \
	d="$$pkg$${subdir:+:}$$subdir$${target:+:}$$target"; \
	extra_msg="(DEPENDS was $$d) in ${FULLPKGPATH}"; \
	case "X$$pkg" in \
	*/*) target="$$subdir"; subdir="$$pkg"; pkg=;; \
	esac; ${_flavor_fragment}

_compute_default = \
	set -f; \
	if set -- $$(eval $$toset exec ${MAKE} _print-metadata); then \
		default=$$1; pkgspec=$$2; pkgpath=$$3; \
	else \
		echo 1>&2 "Problem with dependency $$d"; \
		exit 1; \
	fi; \
	set +f

_complete_pkgspec = \
	${_compute_default}; \
	case "X$$pkg" in \
	X) \
		pkg=$$pkgspec;; \
	XSTEM*) \
		stem=$$(echo $$default|${_version2stem}); \
		pkg="$$stem$${pkg\#STEM}";; \
	esac

_emit_lib_depends = for i in ${LIB_DEPENDS${SUBPACKAGE}:QL}; do echo "$$i"; done
_emit_run_depends = for i in ${RUN_DEPENDS${SUBPACKAGE}:QL}; do echo "$$i"; done

# computing libraries from the ports tree is expensive, so cache as many of
# these as we can

# XXX assumes it's running under _cache_fragment, either directly, or from
# a target up there

# XXX if we can't move the tmpfile, we remove it, because we've been pre-empted
# by someone with more rights who created the correct file for us
_libs2cache = \
	cached_libs=$${_DEPENDS_CACHE}/$$(echo $$subdir|sed -e 's/\//--/g'); \
	if ! test -f $$cached_libs; then \
		t=$$(mktemp $${_DEPENDS_CACHE}/tmp.XXXXXXXXXX||exit 1); \
		if eval $$toset ${MAKE} print-plist-libs >$$t; \
		then  \
			chmod 0644 $$t; \
			mv $$t $$cached_libs || rm $$t; \
		else \
			echo 1>&2 "Problem with dependency $$subdir"; \
			exit 1; \
		fi; \
	fi

# is this subdir actually needed as a libs depend ?
_if_check_needed = \
	${_parse_spec}; \
	${_libs2cache}; \
	if ${_resolve_lib} -needed ${_DEPRUNLIBS:QL} <$$cached_libs

# turn a list of found libraries into parameters for pkg_create,
# zap .a in the meantime
_show_found = \
	for k in $$found; do \
		case $$k in *.a) ;; \
		*) echo "-W $$k";; \
		esac; \
	done

# fairly good approximation of libraries we want
# XXX this is ksh, be less perfect with pure sh
_lib=/lib*.{so.+([0-9]).+([0-9]),a}

_list_system_libs = \
	for i in /usr/lib${_lib} ${X11BASE}/lib${_lib}; do echo $$i; done

_list_port_libs = \
	{ ${MAKE} show-run-depends|while read subdir; do \
		${_flavor_fragment}; \
		${_libs2cache}; \
		cat $$cached_libs; \
	done; ${_list_system_libs}; }

.if empty(PLIST_DB)
_register_plist =:
.else
_register_plist = install -d ${PLISTDIR_MODE} ${PLIST_DB:S/:/ /g} && ${_PERLSCRIPT}/register-plist ${PLIST_DB}
.endif
.if ${CHECK_LIB_DEPENDS:L} == "yes"
_check_lib_depends = ${_CHECK_LIB_DEPENDS}
.else
_check_lib_depends =:
.endif

_CHECK_LIB_DEPENDS = PORTSDIR=${PORTSDIR} ${_PERLSCRIPT}/check-lib-depends
_CHECK_LIB_DEPENDS += -d ${_PKG_REPO} -B ${WRKINST}

.for _s in ${MULTI_PACKAGES}
.  if ${STATIC_PLIST${_s}:L} == "no"
_register_plist${_s} = :
.  else
_register_plist${_s} = ${_register_plist}
.  endif
.endfor

###
### end of variable setup. Only targets now
###
dump-vars:
.if ${MULTI_PACKAGES} == "-"
.  for _v in ${_ALL_VARIABLES} ${_ALL_VARIABLES_INDEXED}
.   if defined(${_v}-)
.     if !empty(${_v}-)
	@@echo ${FULLPKGPATH}.${_v}=${${_v}-:Q}
.     endif
.   elif defined(${_v}) && !empty(${_v})
	@@echo ${FULLPKGPATH}.${_v}=${${_v}:Q}
.   endif
.  endfor
.  for _v in ${_ALL_VARIABLES_PER_ARCH}
.    for _a in ${ALL_ARCHS}
.      if defined(${_v}-${_a}) && !empty(${_v}-${_a})
	@@echo ${FULLPKGPATH}.${_v}-${_a}=${${_v}-${_a}:Q}
.      endif
.    endfor
.  endfor
.else
.  for _S in ${MULTI_PACKAGES}
.    for _v in ${_ALL_VARIABLES}
.     if defined(${_v}) && !empty(${_v})
	@@echo ${FULLPKGPATH${_S}}.${_v}=${${_v}:Q}
.     endif
.    endfor
.    for _v in ${_ALL_VARIABLES_PER_ARCH}
.      for _a in ${ALL_ARCHS}
.        if defined(${_v}-${_a}) && !empty(${_v}-${_a})
	@@echo ${FULLPKGPATH${_S}}.${_v}-${_a}=${${_v}-${_a}:Q}
.        endif
.      endfor
.    endfor
.    for _v in ${_ALL_VARIABLES_INDEXED}
.      if defined(${_v}${_S}) && !empty(${_v}${_S})
	@@echo ${FULLPKGPATH${_S}}.${_v}=${${_v}${_S}:Q}
.      endif
.    endfor
.  endfor
.endif

check-register:
.if empty(PLIST_DB)
	@@exit 1
.else
	@@if cd ${.CURDIR} && PKGPATH=${PKGPATH} ${MAKE} print-plist-with-depends | ${_PERLSCRIPT}/register-plist -p ${PLIST_DB}; then \
		echo "${FULLPKGNAME${SUBPACKAGE}} okay"; \
	else \
		echo "${FULLPKGNAME${SUBPACKAGE}} BAD"; \
	fi
.endif

check-register-all:
.for _S in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE=${_S} PKGPATH=${PKGPATH} ${MAKE} check-register
.endfor

.for _S in ${MULTI_PACKAGES}

${_CACHE_REPO}${_PKGFILE${_S}}:
	@@install -d ${PACKAGE_REPOSITORY_MODE} ${@@D}
	@@${ECHO_MSG} -n "===>  Looking for ${_PKGFILE${_S}} in \$$PKG_PATH - "
	@@if ${SETENV} ${_TERM_ENV} PKG_CACHE=${_CACHE_REPO} PKG_PATH=${_CACHE_REPO}:${_PKG_REPO}:${PACKAGE_REPOSITORY}/${NO_ARCH}/:${PKG_PATH} ${_PKG_ADD} -n -q ${_PKG_ADD_FORCE} -r -D installed -D downgrade ${_PKGFILE${_S}} >/dev/null 2>&1; then \
		${ECHO_MSG} "found"; \
		exit 0; \
	else \
		${ECHO_MSG} "not found"; \
		exit 1; \
	fi


# The real package

${_PACKAGE_COOKIE${_S}}:
	@@install -d ${PACKAGE_REPOSITORY_MODE} ${@@D} ${_TMP_REPO}
.  if ${FETCH_PACKAGES:L} == "yes" && !defined(_TRIED_FETCHING_${_PACKAGE_COOKIE${_S}})
	@@f=${_CACHE_REPO}${_PKGFILE${_S}}; \
	cd ${.CURDIR} && ${MAKE} $$f && \
		{ ln $$f $@@ 2>/dev/null || cp -p $$f $@@ ; } || \
		cd ${.CURDIR} && ${MAKE} _TRIED_FETCHING_${_PACKAGE_COOKIE${_S}}=Yes _internal-package-only
.  else
	@@${_MAKE} ${_PACKAGE_COOKIE_DEPS}
# What PACKAGE normally does:
	@@${ECHO_MSG} "===>  Building package for ${FULLPKGNAME${_S}}"
	@@${ECHO_MSG} "Create ${_PACKAGE_COOKIE${_S}}"
	@@cd ${.CURDIR} && \
	tmp=${_TMP_REPO}${_PKGFILE${_S}} pkgname=${_PKGFILE${_S}} permit_ftp=${PERMIT_PACKAGE_FTP${_S}:L:Q} permit_cdrom=${PERMIT_PACKAGE_CDROM${_S}:L:Q} && \
	if deps=$$(SUBPACKAGE=${_S} wantlib_args=${_pkg_wantlib_args} \
			${MAKE} print-package-args) && \
		${_FAKESUDO} ${_PKG_CREATE} -DPORTSDIR="${PORTSDIR}" \
			$$deps ${PKG_ARGS${_S}} $$tmp && \
		${_check_lib_depends} $$tmp && \
		${_register_plist${_S}} $$tmp && \
		${_checksum_package} && \
		mv $$tmp ${_PACKAGE_COOKIE${_S}} && \
		mode=$$(id -u):$$(id -g) && \
		${_FAKESUDO} chown $${mode} ${_PACKAGE_COOKIE${_S}}; then \
		 	exit 0; \
	else \
		${_FAKESUDO} rm -f $$tmp; \
	    exit 1; \
	fi
# End of PACKAGE.
	@@-rm -f ${_BULK_COOKIE} ${_UPDATE_COOKIE${_S}} ${_FUPDATE_COOKIE${_S}}
.  endif


# The real install

${_INSTALL_COOKIE${_S}}:
.  if ${FETCH_PACKAGES:L} == "yes"
	@@cd ${.CURDIR} && SUBPACKAGE=${_S} PKGPATH=${PKGPATH} exec ${MAKE} subpackage
.  else

	@@${_MAKE} package
.  endif
	@@cd ${.CURDIR} && SUBPACKAGE=${_S} _DEPENDS_TARGET=install PKGPATH=${PKGPATH} \
		exec ${MAKE} _internal-install-depends
	@@${ECHO_MSG} "===>  Installing ${FULLPKGNAME${_S}} from ${_PKG_REPO}"
	@@if ${PKG_INFO} -e ${FULLPKGNAME${_S}}; then \
		echo "Package ${FULLPKGNAME${_S}} is already installed"; \
	else \
		${SUDO} ${SETENV} ${_TERM_ENV} ${_PKG_ADD_LOCAL} ${_PKG_ADD_AUTO} ${PKGFILE${_S}}; \
	fi
	@@-${SUDO} ${_MAKE_COOKIE} $@@


${_UPDATE_COOKIE${_S}}:
	@@${_MAKE} _internal-package
.  if empty(UPDATE_COOKIES_DIR)
	@@${_MAKE} ${WRKDIR}
.  else
	@@mkdir -p ${UPDATE_COOKIES_DIR}
.  endif
	@@${ECHO_MSG} "===> Updating for ${FULLPKGNAME${_S}}"
	@@b=$$(cd ${.CURDIR} && SUBPACKAGE=${_S} ${MAKE} print-plist|sed -ne '/^@@pkgpath /s,,-e ,p'); \
	a=$$(${PKG_INFO} -e ${FULLPKGPATH${_S}} $$b 2>/dev/null |sort -u); \
	case $$a in \
		'') ${ECHO_MSG} "Not installed, no update";; \
		*) cd ${.CURDIR} && SUBPACKAGE=${_S} _DEPENDS_TARGET=package PKGPATH=${PKGPATH} \
		     ${MAKE} _internal-install-depends; \
		   ${ECHO_MSG} "Upgrading from $$a"; \
		   ${SUDO} ${SETENV} ${_TERM_ENV} ${_PKG_ADD_LOCAL} ${_PKG_ADD_AUTO} -r ${_PKG_ADD_FORCE} ${PKGFILE${_S}};; \
	esac
	@@${_MAKE_COOKIE} $@@

${_FUPDATE_COOKIE${_S}}:
	@@${_MAKE} _internal-package
	@@cd ${.CURDIR} && SUBPACKAGE=${_S} _DEPENDS_TARGET=package PKGPATH=${PKGPATH} \
		exec ${MAKE} _internal-install-depends
.  if empty(UPDATE_COOKIES_DIR)
	@@${_MAKE} ${WRKDIR}
.  else
	@@mkdir -p ${UPDATE_COOKIES_DIR}
.  endif
	@@${ECHO_MSG} "===> Updating/installing for ${FULLPKGNAME${_S}}"
	@@${SUDO} ${SETENV} ${_TERM_ENV} ${_PKG_ADD_LOCAL} ${_PKG_ADD_AUTO} -r ${_PKG_ADD_FORCE} ${PKGFILE${_S}}
	@@${_MAKE_COOKIE} $@@
.endfor

.PRECIOUS: ${_PACKAGE_COOKIES} ${_INSTALL_COOKIES}

makesum:
	@@${_warn_checksum}
	@@mv -f ${CHECKSUM_FILE}{,.orig} 2>/dev/null || true
	@@${MAKE} fetch-all _MAKESUM=true
.if !empty(MAKESUMFILES)
	@@cd ${DISTDIR} && cksum -b -a "${_CIPHER}" ${MAKESUMFILES} >> ${CHECKSUM_FILE}
	@@cd ${DISTDIR} && \
		for file in ${MAKESUMFILES}; do \
			${_size_fragment} $$file $$file >> ${CHECKSUM_FILE}; \
		done
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE}
	@@diff -Lold -Lnew -u ${CHECKSUM_FILE}{.orig,} 2>/dev/null|| true
	@@rm -f ${CHECKSUM_FILE}.orig
.endif

################################################################
# Dependency checking
################################################################



_internal-prepare: ${_DEPBUILD_COOKIES} ${_DEPBUILDLIB_COOKIES} \
	${_DEPBUILDWANTLIB_COOKIE}

_internal-install-depends: ${_DEPRUN_COOKIES} ${_DEPRUNLIB_COOKIES} \
	${_DEPRUNWANTLIB_COOKIE}

_internal-test-depends: ${_DEPTEST_COOKIES}

# and the rules for the actual dependencies

_print-metadata:
	@@echo '${FULLPKGNAME${SUBPACKAGE}}' '${PKGSPEC${SUBPACKAGE}}' '${FULLPKGPATH${SUBPACKAGE}}'

_print-packagename:
.if ${_FULL_PACKAGE_NAME:L} == "yes"
	@@echo '${PKGPATH}/${FULLPKGNAME${SUBPACKAGE}}'
.else
	@@echo ${FULLPKGNAME${SUBPACKAGE}}
.endif

.for _i in ${_DEPLIST}
.  if !target(${WRKDIR}/.dep-${_i:C,>=,ge-,g:C,<=,le-,g:C,<,lt-,g:C,>,gt-,g:C,\*,ANY,g:C,[|:/=],-,g})
${WRKDIR}/.dep-${_i:C,>=,ge-,g:C,<=,le-,g:C,<,lt-,g:C,>,gt-,g:C,\*,ANY,g:C,[|:/=],-,g}: ${_WRKDIR_COOKIE}
	@@unset _DEPENDS_TARGET _MASTER WRKDIR|| true; \
	echo '${_i}'| while ${_read_spec}; do \
		${_parse_spec}; \
		_ignore_cookie=${@@:S/.dep/.ignored/}; \
		toset="$$toset _IGNORE_COOKIE=$${_ignore_cookie}"; \
		case "X$$target" in X) target=${_DEPENDS_TARGET};; esac; \
		case "X$$target" in \
		Xinstall|Xreinstall) wantsub=false; check_installed=true; try_install=true;; \
		Xpackage|Xfake) wantsub=false; check_installed=true; try_install=false;; \
		Xpatch|Xconfigure|Xbuild) \
			wantsub=true; check_installed=false; try_install=false; \
			install -d ${WRKOBJDIR_MODE} `dirname ${WRKDIR}`; \
			mkdir -p ${WRKDIR}/$$dir; \
			toset="$$toset _MASTER='[${FULLPKGNAME${SUBPACKAGE}}]${_MASTER}' WRKDIR=${WRKDIR}/$$dir";; \
		*) \
			${ECHO_MSG} "===> Error: can't depend on $$target"; \
			${REPORT_PROBLEM}; \
			exit 1;; \
		esac; \
		${_complete_pkgspec}; \
		toset="$$toset _DEPENDENCY_STACK='${_DEPENDENCY_STACK} ${PKGPATH}'"; \
		h="===> ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} depends on: $$pkg -"; \
		for second_pass in false true; do \
			if $$check_installed; then \
				case ${PREPARE_CHECK_ONLY:L} in \
				yes) \
						second_pass=true;; \
				esac; \
				$$try_install && ${_force_update_fragment}; \
				if $$(${PKG_INFO} -e "$$pkg" -r "$$pkg" $$default >$@@t); then \
					sed -ne '/^inst:/s///p' <$@@t| \
						{ read v || v=found; \
							echo "$$v" >$@@; \
							${ECHO_MSG} "$$h> $$v"; } ;\
					rm $@@t; \
					break; \
				else \
					r=$$?; \
					rm $@@t; \
					case $$r in \
					1|3) \
							${ECHO_MSG} "$$h not found";; \
					esac; \
					case $$r in \
					2|3) \
							${ECHO_MSG} "$$h default $$default does not match"; \
							${REPORT_PROBLEM}; \
							exit 1;; \
					esac; \
				fi; \
			else \
				if ! ${PKG_INFO} -q -r "$$pkg" $$default; \
				then \
					${ECHO_MSG} "$$h default $$default does not match"; \
					${REPORT_PROBLEM}; \
					exit 1; \
				fi; \
			fi; \
			if $$second_pass; then \
				${ECHO_MSG} "Dependency check failed"; \
				${REPORT_PROBLEM}; \
				exit 1; \
			fi; \
			${ECHO_MSG} "===>  Verifying $$target for $$pkg in $$dir"; \
			if (eval $$toset exec ${MAKE} $$target) && \
				! test -e $${_ignore_cookie}; then \
				if $$wantsub; then \
					eval $$toset ${MAKE} show-prepare-results >$@@; \
				fi; \
				${ECHO_MSG} "===> Returning to build of ${FULLPKGNAME${SUBPACKAGE}}${_MASTER}"; \
			else \
				${REPORT_PROBLEM}; \
				exit 1; \
			fi; \
			$$try_install || break; \
		done; \
	done
	@@install -d ${WRKOBJDIR_MODE} `dirname ${WRKDIR}`
	@@mkdir -p ${WRKDIR} ${WRKDIR}/bin
	@@${_MAKE_COOKIE} $@@
.  endif
.endfor

show-prepare-results: prepare
	@@sort -u ${_DEPBUILD_COOKIES} ${_DEPBUILDLIB_COOKIES} /dev/null

show-prepare-test-results: prepare test-depends
	@@sort -u ${_DEPBUILD_COOKIES} ${_DEPBUILDLIB_COOKIES} ${_DEPTEST_COOKIES} /dev/null

# very quick rule, create this to force reevaluation of next rule when
# the dependencies in the Makefile are changed
.  if !empty(_DEPLIBSPECS_COOKIES)
${_DEPLIBSPECS_COOKIES}: ${_WRKDIR_COOKIE}
	@@${_MAKE_COOKIE} $@@
.endif

# similar rules for _DEPBUILDWANTLIB_COOKIE and _DEPRUNWANTLIB_COOKIE
.for _m in BUILD RUN
.  if !empty(_DEP${_m}WANTLIB_COOKIE)
${_DEP${_m}WANTLIB_COOKIE}: ${_DEP${_m}LIBSPECS_COOKIES} \
	${_DEP${_m}LIB_COOKIES} ${_DEPBUILD_COOKIES} ${_WRKDIR_COOKIE}
.    if !empty(_DEP${_m}LIBS)
	@@${ECHO_MSG} "===>  Verifying specs: ${_DEP${_m}LIBS}"
	@@${_cache_fragment}; if found=`{ \
		for i in ${_LIB4:QL}; do echo "$$i"; done | \
			while ${_read_spec}; do \
				${_parse_spec}; \
				${_libs2cache}; \
				cat $$cached_libs; \
			done; \
		for i in ${LOCALBASE}/lib${_lib}; do echo $$i; done;  \
		${_list_system_libs}; \
		for d in ${_DEP${_m}LIBS:QL}; do \
			case "$$d" in \
			/*) echo $${d%/*}${_lib};; \
			*/*) echo ${LOCALBASE}/$${d%/*}${_lib};; \
			esac; \
		done; } | ${_resolve_lib} ${_DEP${_m}LIBS:QL}`; \
	then \
		line="===>  found"; \
		for k in $$found; do line="$$line $$k"; done; \
		${ECHO_MSG} "$$line"; \
	else \
		echo 1>&2 "Fatal error"; \
		exit 1; \
	fi
.    endif
	@@${_MAKE_COOKIE} $@@
.  endif

.endfor

_internal-fetch-all:
# See ports/infrastructure/templates/Makefile.template
	@@${ECHO_MSG} "===>  Checking files for ${FULLPKGNAME}${_MASTER}"
# What FETCH-ALL normally does:
.  if !empty(MAKESUMFILES)
	@@${_MAKE} ${MAKESUMFILES:S@@^@@${DISTDIR}/@@}
.    endif
# End of FETCH

.if (!empty(IGNORE${SUBPACKAGE}) || defined(_EXTRA_IGNORE)) && !defined(NO_IGNORE)
_internal-all _internal-build _internal-checksum _internal-configure \
	_internal-deinstall _internal-extract _internal-fake _internal-fetch \
	_internal-install _internal-install-all _internal-manpages-check \
	_internal-package _internal-patch _internal-plist _internal-test \
	_internal-subpackage _internal-subupdate _internal-uninstall \
	_internal-update _internal-update-or-install \
	_internal-update-or-install-all _internal-update-plist \
	lib-depends-check port-lib-depends-check update-patches:
.  if !defined(IGNORE_SILENT)
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} ${IGNORE${SUBPACKAGE}} ${_EXTRA_IGNORE}."
.  endif
.  if defined(_IGNORE_COOKIE)
	@@echo "${IGNORE${SUBPACKAGE}} ${_EXTRA_IGNORE}" >${_IGNORE_COOKIE}
.  endif
.else

lib-depends-check:
	@@${_cache_fragment}; cd ${.CURDIR} && ${MAKE} package; \
	${_CHECK_LIB_DEPENDS} ${_PACKAGE_COOKIE}

${WRKINST}/.saved_libs: ${_FAKE_COOKIE} ${_FAKESUDO_CHECK_COOKIE}
	@@${_FAKESUDO} ${_CHECK_LIB_DEPENDS} -O $@@t && ${_FAKESUDO} mv $@@t $@@

port-lib-depends-check: ${WRKINST}/.saved_libs
	@@-${_cache_fragment}; for s in ${MULTI_PACKAGES}; do \
		SUBPACKAGE=$$s ${MAKE} print-plist-with-depends \
		lib_depends_args=all-lib-depends-args \
		wantlib_args=fake-wantlib-args| \
			${_CHECK_LIB_DEPENDS} -i -s ${WRKINST}/.saved_libs; \
	done

_internal-manpages-check: ${_FAKE_COOKIE} ${_FAKESUDO_CHECK_COOKIE}
	@@cd ${WRKINST}${TRUEPREFIX}/man && \
		${_FAKESUDO} /usr/libexec/makewhatis -p . && \
		cat mandoc.db

# Most standard port targets create a cookie to avoid being re-run.
#
# fetch is an exception, as it uses the files it fetches as `cookies',
# and it's run by checksum, so in essence it's a sub-goal of extract,
# in normal use.
#
# Besides, fetch can't create cookies, as it does not have WRKDIR available
# in the first place.
#

_internal-fetch:
# See ports/infrastructure/templates/Makefile.template
	@@${ECHO_MSG} "===>  Checking files for ${FULLPKGNAME}${_MASTER}"
# What FETCH normally does:
.  if !empty(CHECKSUMFILES)
	@@${_MAKE} ${CHECKSUMFILES:S@@^@@${DISTDIR}/@@}
.  endif
# End of FETCH


_internal-checksum: _internal-fetch
	@@${_warn_checksum}
	@@fgrep 2>/dev/null SIZE ${CHECKSUM_FILE} | \
	sed -e '/SIZE (\(.*\)).*/s//\1/'|\
	while read i; do \
		for j in ${MAKESUMFILES}; do \
			missing=true; \
			if test $$i = $$j; then \
				missing=false; \
				break; \
			fi; \
		done; \
		if $$missing; then \
			bad=true; \
			echo 1>&2 "!!! Extra file '$$i' in ${CHECKSUM_FILE}"; \
			echo 1>&2 "!!! Read up on SUPDISTFILES in bsd.port.mk(5)"; \
			exit 1; \
		fi; \
	done
.  if empty(CHECKSUMFILES)
	@@${ECHO_MSG} ">> No DISTFILES nor PATCHFILES."
.  else
.    if !defined(NO_CHECKSUM)
	@@if [ ! -f ${CHECKSUM_FILE} ]; then \
	  ${ECHO_MSG} 1>&2 ">> No ${CHECKSUM_FILE}."; \
	  exit 1; \
	fi
	@@cd ${DISTDIR}; OK=true; list=''; \
	  for file in ${CHECKSUMFILES}; do \
		if set -- $$(grep "^${_CIPHER:U} ($$file)" ${CHECKSUM_FILE}); \
		then \
			echo -n '>> '; \
			if ! echo "$$@@" | cksum -c; then \
				list="$$list $$file ${_CIPHER} $$4"; \
				OK=false; \
			fi; \
		else  \
			${ECHO_MSG} ">> No ${_CIPHER} recorded for $$file."; \
			OK=false; \
		fi; \
	  done; \
	  set --; \
	  if ! $$OK; then \
		if ${REFETCH}; then \
		  cd ${.CURDIR} && PKGPATH=${PKGPATH} ${MAKE} _refetch _PROBLEMS="$$list"; \
		else \
		  echo "Make sure the Makefile and ${CHECKSUM_FILE}"; \
		  echo "are up to date.  If you want to fetch a good copy of this file"; \
		  echo "from the OpenBSD main archive, type"; \
		  echo "\tmake REFETCH=true [other args]"; \
		  exit 1; \
		fi; \
	  fi
.    endif
.  endif

_refetch:
.  for file cipher value in ${_PROBLEMS}
	@@rm ${DISTDIR}/${file}
	@@${_MAKE} ${DISTDIR}/${file} \
		MASTER_SITE_OVERRIDE="${MASTER_SITE_OPENBSD:=by_cipher/${cipher}/${value:C/(..).*/\1/}/${value}/} ${MASTER_SITE_OPENBSD:=${cipher}/${value}/}"
.  endfor
	${_MAKE} _internal-checksum REFETCH=false


# The cookie's recipe hold the real rule for each of those targets.

_internal-extract: ${_EXTRACT_COOKIE}
_internal-patch: ${_DEPBUILD_COOKIES} ${_DEPBUILDLIB_COOKIES} \
	${_DEPBUILDWANTLIB_COOKIE} ${_PATCH_COOKIE}
_internal-distpatch: ${_DEPBUILD_COOKIES} ${_DEPBUILDLIB_COOKIES} \
	${_DEPBUILDWANTLIB_COOKIE} ${_DISTPATCH_COOKIE}
_internal-configure: ${_DEPBUILD_COOKIES} ${_DEPBUILDLIB_COOKIES} \
	${_DEPBUILDWANTLIB_COOKIE} ${_CONFIGURE_COOKIE}
_internal-build _internal-all: ${_DEPBUILD_COOKIES} ${_DEPBUILDLIB_COOKIES} \
	${_DEPBUILDWANTLIB_COOKIE} ${_BUILD_COOKIE}
_internal-install: ${_INSTALL_COOKIE${SUBPACKAGE}}
_internal-install-all: ${_INSTALL_COOKIES}
_internal-fake: ${_FAKE_COOKIE}
_internal-subupdate: ${_UPDATE_COOKIE${SUBPACKAGE}}
_internal-update: ${_UPDATE_COOKIES}
_internal-update-or-install: ${_FUPDATE_COOKIE${SUBPACKAGE}}
_internal-update-or-install-all: ${_FUPDATE_COOKIES}

regress: test

.  if !empty(_IGNORE_TEST)
_internal-test:
.    if !defined(IGNORE_SILENT)
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} ${_IGNORE_TEST}."
.    endif
.  else
_internal-test: ${_BUILD_COOKIE} ${_DEPTEST_COOKIES} ${_TEST_COOKIE}
.  endif

# packing list utilities.  This generates a packing list from a recently
# installed port.  Not perfect, but pretty close.  The generated file
# will have to have some tweaks done by hand.
# Note: add @@comment PACKAGE(arch=${MACHINE_ARCH}, opsys=OpenBSD, vers=${OSREV})
# when port is installed or package created.
#
_extra_info =
.  for _s in ${MULTI_PACKAGES}
_extra_info += PLIST${_s}='${PLIST${_s}}'
_extra_info += DEPPATHS${_s}="$$(${SETENV} FLAVOR=${FLAVOR:Q} SUBPACKAGE=${_s} PKGPATH=${PKGPATH} ${MAKE} show-run-depends)"
.  endfor

_internal-plist _internal-update-plist: _internal-fake ${_FAKESUDO_CHECK_COOKIE}
	@@${ECHO_MSG} "===>  Updating plist for ${FULLPKGNAME}${_MASTER}"
	@@mkdir -p ${PKGDIR}
	@@DESTDIR=${WRKINST} \
	PREFIX=${TRUEPREFIX} \
	INSTALL_PRE_COOKIE=${_INSTALL_PRE_COOKIE} \
	MAKE="${MAKE}" \
	PORTSDIR=${PORTSDIR} \
	PORTSDIR_PATH=${PORTSDIR_PATH} \
	FLAVORS='${FLAVORS}' MULTI_PACKAGES='${MULTI_PACKAGES}' \
	OKAY_FILES='${_FAKE_COOKIE} ${_INSTALL_PRE_COOKIE} ${WRKINST}/.saved_libs' \
	OWNER=$$(id -u) \
	GROUP=$$(id -g) \
	${_FAKESUDO} ${_PERLSCRIPT}/make-plist \
	${_extra_info} ${_tmpvars}

update-patches:
	@@toedit=`WRKDIST=${WRKDIST} PATCHDIR=${PATCHDIR} \
		PATCH_LIST='${PATCH_LIST}' DIFF_ARGS='${DIFF_ARGS}' \
		DISTORIG=${DISTORIG} PATCHORIG=${PATCHORIG} \
		${_SHSCRIPT}/update-patches`; \
	case $$toedit in "");; \
	*) read i?'edit patches: '; \
	cd ${PATCHDIR} && $${VISUAL:-$${EDITOR:-/usr/bin/vi}} $$toedit;; esac



.endif # IGNORECMD


# Top-level targets redirect to the real _internal-target, along with locking
# if locking exists.

.for _t in extract patch distpatch configure build all install fake \
	subupdate fetch fetch-all checksum test prepare install-depends \
	test-depends clean manpages-check plist update-plist \
	update update-or-install update-or-install-all package install-all
.  if defined(_LOCK)
${_t}:
	@@${_DO_LOCK}; cd ${.CURDIR} && PKGPATH=${PKGPATH} ${MAKE} _internal-${_t}
.  else
${_t}: _internal-${_t}
.  endif
.endfor

lock:
	@@lock=${_LOCKNAME}; ${_LOCK}
	export _LOCKS_HELD="${_LOCKS_HELD} ${_LOCKNAME}"

unlock:
	@@lock=${_LOCKNAME}; ${_UNLOCK}
.for _i in ${_LOCKNAME}
	export _LOCKS_HELD="${_LOCKS_HELD:N${_i}}"
.endfor

subpackage:
# XXX both _DO_LOCK and _cache_fragment use trap, so subshell
	@@${_DO_LOCK}; (${_cache_fragment}; cd ${.CURDIR} && ${MAKE} _internal-subpackage)

_internal-package:
	@@${_cache_fragment}; cd ${.CURDIR} && ${MAKE} _internal-package-only
# XXX loop needed for M to work
.for p in ${PKGPATH}
.  if ${BULK_$p:L} == "yes"
	@@${_MAKE} ${_BULK_COOKIE}
.  elif ${BULK_$p:L} == "auto"
.    if !empty(_DEPENDENCY_STACK)
.      if !${_DEPENDENCY_STACK:M$p}
	@@${_MAKE} ${_BULK_COOKIE}
.      endif
.    endif
.  endif
.endfor


${_BULK_COOKIE}:
	@@${_cache_fragment}; cd ${.CURDIR} && ${MAKE} _internal-package-only
	@@mkdir -p ${BULK_COOKIES_DIR}
.for _i in ${BULK_TARGETS_${PKGPATH}}
	@@${ECHO_MSG} "===> Running ${_i}"
	@@${_MAKE} ${_i} ${BULK_FLAGS}
.endfor
.if !empty(BULK_DO_${PKGPATH})
	@@${BULK_DO_${PKGPATH}}
.endif
	@@${_SUDOMAKE} _internal-clean
	@@${_MAKE_COOKIE} $@@

# The real targets. Note that some parts always get run, some parts can be
# disabled, and there are hooks to override behavior.

${WRKDIR}/.test-sudo:
	@@if [ x`SUDO_PORT_V1=ah ${SUDO} /bin/sh -c 'eval echo $${SUDO_PORT_V1}'` \
		!= xah ]; then \
			echo >&2 "Error: sudo does not let env variables through"; \
			exit 1; \
	fi
	@@${_MAKE_COOKIE} $@@

${_WRKDIR_COOKIE}:
	@@rm -rf ${WRKDIR}
.if ${PORTS_BUILD_XENOCARA_TOO:L} != "yes"
	@@appdefaults=${LOCALBASE}/lib/X11/app-defaults; \
	if ! test -d $$appdefaults -a -h $$appdefaults; then \
		echo 1>&2 "Fatal: $$appdefaults should exist and be a symlink"; \
		exit 1; \
	fi
.endif
	@@install -d ${WRKOBJDIR_MODE} `dirname ${WRKDIR}`
	@@mkdir -p ${WRKDIR} ${WRKDIR}/bin
.if ${USE_CCACHE:L} == "yes" && ${NO_CCACHE:L} == "no"
	@@${ECHO_MSG} "===>  Enabling ccache for ${FULLPKGNAME}${_MASTER}"
	@@ln -sf ${LOCALBASE}/bin/ccache ${WRKDIR}/bin/gcc
	@@ln -sf ${LOCALBASE}/bin/ccache ${WRKDIR}/bin/g++
	@@ln -sf ${LOCALBASE}/bin/ccache ${WRKDIR}/bin/cc
	@@ln -sf ${LOCALBASE}/bin/ccache ${WRKDIR}/bin/c++
.endif
.if ${FAKE_AS_ROOT:L} != "yes"
	@@install -m ${BINMODE} ${_INSTALL_WRAPPER} ${WRKDIR}/bin/install
.endif
.if !empty(WRKDIR_LINKNAME)
	@@ln -sf ${WRKDIR} ${.CURDIR}/${WRKDIR_LINKNAME}
.endif
# poison some common gettext-tools binaries
.if !defined(BUILD_DEPENDS) || !${BUILD_DEPENDS:Mdevel/gettext-tools} && \
		!${BUILD_DEPENDS:M*textproc/intltool}
	@@printf '#!/bin/sh\n\
		echo "*** $$0 was called without gettext-tools dependency ***" >&2\n\
		exit 1\n' > ${WRKDIR}/bin/msgfmt
	@@chmod 555 ${WRKDIR}/bin/msgfmt
.  for name in msgcat msginit
	@@ln -sf msgfmt ${WRKDIR}/bin/${name}
.  endfor
.endif
	@@${_MAKE_COOKIE} $@@

${_EXTRACT_COOKIE}: ${_WRKDIR_COOKIE}
	@@${_MAKE} _internal-checksum _internal-prepare
	@@${ECHO_MSG} "===>  Extracting for ${FULLPKGNAME}${_MASTER}"
.if target(pre-extract)
	@@${_MAKESYS} pre-extract
.endif
	@@${_MAKESYS} do-extract
.if target(post-extract)
	@@${_MAKESYS} post-extract
.endif
.for _m in ${MODULES:T:U}
.  if defined(MOD${_m}_post-extract)
	@@${MOD${_m}_post-extract}
.  endif
.endfor
	@@${_MAKE_COOKIE} $@@

.if !target(do-extract)
do-extract:
# What EXTRACT normally does:
	@@PATH=${PORTPATH}; set -e; cd ${WRKDIR}; \
	for archive in ${EXTRACT_ONLY}; do \
		case $$archive in \
		${EXTRACT_CASES} \
		esac; \
	done
# End of EXTRACT
.endif


# Both distpatch and patch invoke pre-patch, if it's defined.
# Hence it needs special treatment (a specific cookie).
.if target(pre-patch)
${_PREPATCH_COOKIE}:
	@@${_MAKESYS} pre-patch
.  if ${PATCH_CHECK_ONLY:L} != "yes"
	@@${_MAKE_COOKIE} $@@
.  endif
.endif



# The real distpatch

${_DISTPATCH_COOKIE}: ${_EXTRACT_COOKIE}
.if target(pre-patch)
	@@${_MAKE} ${_PREPATCH_COOKIE}
.endif
	@@${_MAKESYS} do-distpatch
.if target(post-distpatch)
	@@${_MAKESYS} post-distpatch
.endif
.if ${PATCH_CHECK_ONLY:L} != "yes"
	@@${_MAKE_COOKIE} $@@
.endif

.if !target(do-distpatch)
do-distpatch:
# What DISTPATCH normally does
.  if !empty(_LIST_PATCHFILES)
	@@${ECHO_MSG} "===>  Applying distribution patches for ${FULLPKGNAME}${_MASTER}"
	@@cd ${FULLDISTDIR}; \
	  for patchfile in ${_LIST_PATCHFILES}; do \
	  	case "${PATCH_DEBUG:L}" in \
			no) ;; \
			*) ${ECHO_MSG} "===>   Applying distribution patch $$patchfile" ;; \
		esac; \
		case $$patchfile in \
			${PATCH_CASES} \
		esac; \
	  done
.  endif
# End of DISTPATCH.
.endif

# The real patch

${_PATCH_COOKIE}: ${_EXTRACT_COOKIE}
	@@${ECHO_MSG} "===>  Patching for ${FULLPKGNAME}${_MASTER}"
.if target(pre-patch)
	@@${_MAKE} ${_PREPATCH_COOKIE}
.endif
.if target(do-patch)
	@@${_MAKESYS} do-patch
.else
# What PATCH normally does:
# XXX test for efficiency, don't bother with distpatch if it's not needed
.  if target(do-distpatch) || target(post-distpatch) || !empty(PATCHFILES)
	@@${_MAKE} _internal-distpatch
.  endif
	@@if cd ${PATCHDIR} 2>/dev/null || [ x"${PATCH_LIST:M/*}" != x"" ]; then \
		error=false; \
		for i in ${PATCH_LIST}; do \
			case $$i in \
				*.orig|*.rej|*~) \
					${ECHO_MSG} "===>   Ignoring patchfile $$i" ; \
					;; \
				*) \
				    if [ -e $$i ]; then \
						case "${PATCH_DEBUG:L}" in \
							no) ;; \
							*) ${ECHO_MSG} "===>   Applying OpenBSD patch $$i" ;; \
						esac; \
						if [ -s $$i ]; then \
							${PATCH} ${PATCH_ARGS} < $$i || \
								{ echo "***>   $$i did not apply cleanly"; \
								error=true; }; \
						else \
							${ECHO_MSG} "===>   Ignoring empty patchfile $$i"; \
						fi; \
					else \
						if [ $$i != "patch-*" ]; then \
							echo "===>   Can't find patch matching $$i"; \
							error=true; \
						fi; \
					fi; \
					;; \
			esac; \
		done;\
		if $$error; then exit 1; fi; \
	fi
# End of PATCH.
.endif
.if ${USE_WXNEEDED:L} == "yes"
	@@printf '#!/bin/sh\nexec /usr/bin/ld -z wxneeded $$@@\n' > ${WRKDIR}/bin/ld
	@@chmod 555 ${WRKDIR}/bin/ld
.endif
.if target(post-patch)
	@@${_MAKESYS} post-patch
.endif
.for _m in ${MODULES:T:U}
.  if defined(MOD${_m}_post-patch)
	@@${MOD${_m}_post-patch}
.  endif
.endfor
.if !empty(REORDER_DEPENDENCIES)
	@@sed -e '/^#/d' ${REORDER_DEPENDENCIES} | \
	  tsort -r|while read f; do \
	    cd ${WRKSRC}; \
		case $$f in \
		/*) \
			find . -name $${f#/} -print| while read i; \
				do ${ECHO_REORDER} "Touching $$i"; touch $$i; done \
			;; \
		*) \
			if test -e $$f ; then \
				${ECHO_REORDER} "Touching $$f"; touch $$f; \
			fi \
			;; \
		esac; done
.endif
.if ${PATCH_CHECK_ONLY:L} != "yes"
	@@${_MAKE_COOKIE} $@@
.endif


# The real configure

${_CONFIGURE_COOKIE}: ${_PATCH_COOKIE}
	@@${ECHO_MSG} "===>  Configuring for ${FULLPKGNAME}${_MASTER}"
.if defined(_CONFIG_SITE)
	@@cd ${PORTSDIR}/infrastructure/db && cat ${CONFIG_SITE_LIST} >${_CONFIG_SITE}
	@@echo "Using ${_CONFIG_SITE} (generated)"
.endif
	@@mkdir -p ${WRKBUILD}
.if target(pre-configure)
	@@${_MAKESYS} pre-configure
.endif
.for _m in ${MODULES:T:U}
.  if defined(MOD${_m}_pre-configure)
	@@${MOD${_m}_pre-configure}
.  endif
.endfor
.if target(do-configure)
	@@${_MAKESYS} do-configure
.else
# What CONFIGURE normally does
.  for _c in ${CONFIGURE_STYLE:U}
.    if defined(MOD${_c}_configure)
	@@${MOD${_c}_configure}
.    endif
.  endfor
# End of CONFIGURE.
.endif
.if target(post-configure)
	@@${_MAKESYS} post-configure
.endif
	@@${_MAKE_COOKIE} $@@

# The real build

${_BUILD_COOKIE}: ${_CONFIGURE_COOKIE}
.if ${NO_BUILD:L} == "no"
	@@${ECHO_MSG} "===>  Building for ${FULLPKGNAME}${_MASTER}"
.  if target(pre-build)
	@@${_MAKESYS} pre-build
.  endif
.  if target(do-build)
	@@${_MAKESYS} do-build
.  else
# What BUILD normally does:
	@@cd ${WRKBUILD} && exec ${SETENV} ${MAKE_ENV} \
		${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} ${ALL_TARGET}
# End of BUILD
.  endif
.  if target(post-build)
	@@${_MAKESYS} post-build
.  endif
.endif
	@@${_MAKE_COOKIE} $@@

${_TEST_COOKIE}: ${_BUILD_COOKIE}
.if ${NO_TEST:L} == "no"
	@@${ECHO_MSG} "===>  Regression tests for ${FULLPKGNAME}${_MASTER}"
# When interactive tests need X11
.  if ${TEST_IS_INTERACTIVE:L} == "x11"
.    if !defined(DISPLAY) || !exists(${XAUTHORITY})
	@@echo 1>&2 "The regression tests require a running instance of X."
	@@echo 1>&2 "You will also need to set the environment variable DISPLAY"
	@@echo 1>&2 "to point to an active X11 display and XAUTHORITY to point"
	@@echo 1>&2 "to the appropriate .Xauthority file."
	@@exit 1
.    endif
.  endif
.  if target(pre-test)
	@@${_MAKE} pre-test
.  endif
.  if target(do-test)
	@@cd ${.CURDIR} && exec 3>&1 && exit `exec 4>&1 1>&3; \
		(exec; set +e; PKGPATH=${PKGPATH} ${MAKE} do-test; \
		echo $$? >&4) 2>&1 ${TEST_LOG}`
.  else
# What TEST normally does:
	@@cd ${WRKBUILD} && exec 3>&1 && exit `exec 4>&1 1>&3; \
		(exec; set +e; ${SETENV} ${ALL_TEST_ENV} ${MAKE_PROGRAM} \
		${ALL_TEST_FLAGS} -f ${MAKE_FILE} ${TEST_TARGET}; \
		echo $$? >&4) 2>&1 ${TEST_LOG}`
# End of TEST
.  endif
.  if target(post-test)
	@@${_MAKE} post-test
.  endif
.else
	@@echo 1>&2 "No regression tests for ${FULLPKGNAME}"
.endif
	@@${_MAKE_COOKIE} $@@

# XXX we don't care about the order
.for _m in ${MODULES:T:U}
.  if defined(MOD${_m}_post-install)
_hook-post-install::
	@@${MOD${_m}_post-install}
.  endif
.endfor

${_FAKE_COOKIE}: ${_BUILD_COOKIE} ${_FAKESUDO_CHECK_COOKIE}
	@@${ECHO_MSG} "===>  Faking installation for ${FULLPKGNAME}${_MASTER}"
	@@if [ x`umask 022;${_FAKESUDO} /bin/sh -c umask` != x022 ]; then \
		echo >&2 "Error: your umask is \"`${_FAKESUDO} /bin/sh -c umask`"\".; \
		exit 1; \
	fi
.if ${FAKE_AS_ROOT:L} == "yes"
	@@${_FAKESUDO} install -d -m 755 ${_BINOWNGRP} ${WRKINST}
.else
	install -d -m 755 ${WRKINST}
.endif
	@@cat ${MTREE_FILE}| \
		${_FAKESUDO} /usr/sbin/mtree -U -e -d -p ${WRKINST} >/dev/null
.if ${FAKE_AS_ROOT:L} != "yes"
	@@ln -sf /bin/echo ${WRKDIR}/bin/chown
	@@ln -sf /bin/echo ${WRKDIR}/bin/chgrp
	@@install -m ${BINMODE} ${_INSTALL_WRAPPER} ${WRKDIR}/bin/install
.endif
.for _m in ${MODULES:T:U}
.  if defined(MOD${_m}_pre-fake)
	@@${MOD${_m}_pre-fake}
.  endif
.endfor
.if target(pre-fake)
	@@${_SUDOMAKESYS} pre-fake ${FAKE_SETUP}
.endif
	@@${_FAKESUDO} ${_MAKE_COOKIE} ${_INSTALL_PRE_COOKIE}
.if target(pre-install)
	@@${_SUDOMAKESYS} pre-install ${FAKE_SETUP}
.endif
.if target(do-install)
	@@${_SUDOMAKESYS} do-install ${FAKE_SETUP}
.else
# What FAKE normally does:
	@@cd ${WRKBUILD} && umask 022 && exec ${_FAKESUDO} \
		${SETENV} ${MAKE_ENV} ${FAKE_SETUP} \
		${MAKE_PROGRAM} ${ALL_FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
# End of FAKE.
.endif
.if target(post-install)
	@@${_SUDOMAKESYS} post-install ${FAKE_SETUP}
.endif
.if target(_hook-post-install)
	@@${_SUDOMAKESYS} _hook-post-install ${FAKE_SETUP}
.endif
.if ${MULTI_PACKAGES} == "-"
	@@if test -e ${PKGDIR}/README; then \
		r=${WRKINST}${_README_DIR}/${FULLPKGNAME}; \
		echo "Installing ${PKGDIR}/README as $$r"; \
		${_FAKESUDO} ${SUBST_CMD} ${_SHAREOWNGRP} -m ${SHAREMODE} -c ${PKGDIR}/README $$r; \
	fi
.else
.  for _s in ${MULTI_PACKAGES}
	@@if test -e ${PKGDIR}/README${_s}; then \
		r=${WRKINST}${_README_DIR}/${FULLPKGNAME${_s}}; \
		echo "Installing ${PKGDIR}/README${_s} as $$r"; \
		${_FAKESUDO} ${SUBST_CMD${_s}} ${_SHAREOWNGRP} -m ${SHAREMODE} -c ${PKGDIR}/README${_s} $$r; \
	fi
.  endfor
.endif
	@@mkdir -p ${PKGDIR}
	@@cd ${PKGDIR} && for i in *.rc; do \
		if test X"$$i" != "X*.rc"; then \
			r=${WRKINST}${RCDIR}/$${i%.rc}; \
			echo "Installing ${PKGDIR}/$$i as $$r"; \
			${_FAKESUDO} ${SUBST_CMD} ${_BINOWNGRP} -m ${BINMODE} -c $$i $$r; \
		fi; \
	done

	@@${_FAKESUDO} ${_MAKE_COOKIE} $@@

print-plist:
	@@${_PKG_CREATE} -n -q ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}

print-plist-with-depends:
	@@if a=`SUBPACKAGE=${SUBPACKAGE} PKGPATH=${PKGPATH} ${MAKE} print-package-args`; \
	then \
		${_PKG_CREATE} -n -q $$a ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}; \
	else \
		exit 1; \
	fi

print-plist-libs-with-depends:
	@@if a=`SUBPACKAGE=${SUBPACKAGE} PKGPATH=${PKGPATH} ${MAKE} print-package-args`; \
	then \
		${_PKG_CREATE} -DLIBS_ONLY -n -q $$a ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}; \
	else \
		exit 1; \
	fi

print-plist-all:
.for _S in ${MULTI_PACKAGES}
		@@${ECHO_MSG} "===> ${FULLPKGNAME${_S}}"
.  if ${STATIC_PLIST${_s}:L} == "yes"
		@@${_PKG_CREATE} -n -q ${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}}
.  else
		@@${_PKG_CREATE} -n -q ${PKG_ARGS${_S}:S@@^-f$@@-D@@g} -f/dev/null ${_PACKAGE_COOKIE${_S}}
.  endif
.endfor

print-plist-all-with-depends:
.for _S in ${MULTI_PACKAGES}
	@@${ECHO_MSG} "===> ${FULLPKGNAME${_S}}"
	@@if a=`SUBPACKAGE=${_S} PKGPATH=${PKGPATH} ${MAKE} print-package-args`; \
	then \
		${_PKG_CREATE} -n -q $$a ${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}}; \
	else \
		exit 1; \
	fi
.endfor

print-plist-contents:
	@@${_PKG_CREATE} -n -Q ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}

print-plist-libs:
	@@${_PKG_CREATE} -DLIBS_ONLY -n -Q ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}|${_grab_libs_from_plist}

_internal-package-only: ${_PACKAGE_COOKIES}

_internal-subpackage: ${_PACKAGE_COOKIES${SUBPACKAGE}}

# Separate target for each file fetch-all will retrieve

.for p f m u in ${_FULL_FETCH_LIST}
${DISTDIR}/$p:
.  if ${FETCH_MANUALLY:L} != "no"
.    if !empty(MISSING_FILES)
	@@echo "*** You're missing files: ${MISSING_FILES}"
.    endif
.    for _M in ${FETCH_MANUALLY}
	@@echo "*** ${_M}"
.    endfor
	@@exit 1
.  else
	@@lock=${@@:T}.dist; ${_SIMPLE_LOCK}; install -d ${DISTDIR_MODE} ${@@:H}; \
	cd ${@@:H}; \
	test -f ${@@:T} && exit 0; \
	f=$f; \
	if ! ${_MAKESUM} && test ! -f ${CHECKSUM_FILE}; then \
		${ECHO_MSG} ">> Checksum file does not exist"; \
		exit 1; \
	fi; \
	for site in ${$m}; do \
		file=$@@.part; \
		${ECHO_MSG} ">> Fetch $${site}$u"; \
		if ${FETCH_CMD} -o $$file $${site}$u; then \
				if ${_MAKESUM}; then \
					mv $$file $@@; \
					exit 0; \
				else \
					ck=`${_size_fragment} $$file $p`; \
					if grep -q "^$$ck\$$" ${CHECKSUM_FILE}; then \
						mv $$file $@@; \
						exit 0; \
					else \
						if grep -q "SIZE ($p)" ${CHECKSUM_FILE}; then \
							${ECHO_MSG} ">> Size does not match for $p"; \
							rm -f $$file; \
						else \
							${ECHO_MSG} ">> No size recorded for $p"; \
							rm -f $$file; \
							exit 1; \
						fi; \
					fi; \
				fi; \
		fi; \
	done; exit 1
.  endif
.endfor

.for _l _o in ${_PACKAGE_LINKS}
${PACKAGE_REPOSITORY}/${_l}: ${PACKAGE_REPOSITORY}/${_o}
	@@echo "Link to $@@"
	@@install -d ${PACKAGE_REPOSITORY_MODE} ${@@D}
	@@rm -f $@@
	@@ln $? $@@ 2>/dev/null || \
	  cp -p $? $@@
.endfor

# Cleaning up

_internal-clean:
.if ${_clean:Mdepends} && ${_CLEANDEPENDS:L} == "yes"
	@@PKGPATH=${PKGPATH} ${MAKE} all-dir-depends|${_sort_dependencies}|while read subdir; do \
		${_flavor_fragment}; \
		eval $$toset ${MAKE} _CLEANDEPENDS=No clean; \
	done
.endif
	@@${ECHO_MSG} "===>  Cleaning for ${FULLPKGNAME${SUBPACKAGE}}"
.if ${_clean:Mfake}
	@@if cd ${WRKINST} 2>/dev/null; then ${_FAKESUDO} rm -rf ${WRKINST}; fi
.endif
.if ${_clean:Mwork} || (${_clean:Mbuild} && ${SEPARATE_BUILD:L} == "no")
.  if ${_clean:Mflavors}
	@@for i in ${.CURDIR}/w-*; do \
		if [ -L $$i ]; then ${SUDO} rm -rf `readlink $$i`; fi; \
		${SUDO} rm -rf $$i; \
	done
.  endif
.  for l in ${_WRKDIRS}
.    if "$l" != ""
	@@if [ -L $l ]; then rm -rf `readlink $l`; fi
	@@if [ -e $l ]; then rm -rf $l; fi
.    endif
.  endfor
.  if !empty(WRKDIR_LINKNAME)
	@@if [ -L ${WRKDIR_LINKNAME} ]; then rm -f ${.CURDIR}/${WRKDIR_LINKNAME}; fi
.  endif
.elif ${_clean:Mbuild} && ${SEPARATE_BUILD:L} != "no"
	@@rm -rf ${WRKBUILD} ${_CONFIGURE_COOKIE} ${_BUILD_COOKIE}
.endif
.if ${_clean:Mdist}
	@@${ECHO_MSG} "===>  Dist cleaning for ${FULLPKGNAME${SUBPACKAGE}}"
	@@if cd ${DISTDIR} 2>/dev/null; then \
		rm -f ${MAKESUMFILES}; \
	fi
.  if !empty(DIST_SUBDIR)
	-@@rmdir ${FULLDISTDIR}
.  endif
.endif
.if ${_clean:Minstall}
.  if ${_clean:Msub}
	-${SUDO} ${_PKG_DELETE} ${PKGNAMES}
.  else
	-${SUDO} ${_PKG_DELETE} ${FULLPKGNAME${SUBPACKAGE}}
.  endif
.endif
.if ${_clean:Mpackages} || ${_clean:Mpackage} && ${_clean:Msub}
	rm -f ${_PACKAGE_COOKIES} ${_UPDATE_COOKIES} ${_CACHE_PACKAGE_COOKIES}
.elif ${_clean:Mpackage}
	rm -f ${_PACKAGE_COOKIES${SUBPACKAGE}} ${_UPDATE_COOKIE${SUBPACKAGE}}
.endif
.if ${_clean:Mbulk}
	rm -f ${_BULK_COOKIE}
.endif
.if ${_clean:Mplist}
.  for _d in ${PLIST_DB:S/:/ /}
.    for _p in ${PKGNAMES}
	rm -f ${_d}/${_p}
.    endfor
.  endfor
.endif

# This target generates an index entry suitable for aggregation into
# a large index.  Format is:
#
# distribution-name|port-path|installation-prefix|comment| \
#  description-file|maintainer|categories|lib-deps|build-deps|run-deps| \
#  for-arch|package-cdrom|package-ftp|distfiles-ftp
#
describe:
.for _S in ${MULTI_PACKAGES}
	@@echo -n "${FULLPKGNAME${_S}}|${FULLPKGPATH${_S}}|"
.  if ${PREFIX${_S}} == ${LOCALBASE}
	@@echo -n "|"
.  else
	@@echo -n "${PREFIX${_S}}|"
.  endif
	@@echo -n ${_COMMENT${_S}:S/^"//:S/"$//:S/^'//:S/'$//:Q}"|"; \
	if [ -f ${DESCR${_S}} ]; then \
		echo -n `PORTSDIR_PATH=${PORTSDIR_PATH} ${_PERLSCRIPT}/getpkgpath ${DESCR${_S}}`'|';  \
	else \
		echo -n "/dev/null|"; \
	fi; \
	echo -n "${MAINTAINER}|${CATEGORIES${_S}}|"
.  for _d in LIB BUILD RUN
	@@echo -n '${_${_d}_DEP3${_S}:C/ +/ /g}'| tr '\040' '\012'|sort -u|tr '\012' '\040' | sed -e 's, $$,,'
	@@echo -n '|'
.  endfor
.  if defined(ONLY_FOR_ARCHS${_S})
	@@echo -n "${ONLY_FOR_ARCHS${_S}}|"
.  elif defined(NOT_FOR_ARCHS${_S})
	@@echo -n "!${NOT_FOR_ARCHS${_S}}|"
.  else
	@@echo -n "any|"
.  endif
.  if defined(_BAD_LICENSING)
	@@echo "?|?|?|?"
.  else
.    if ${PERMIT_PACKAGE_CDROM${_S}:L} == "yes"
	@@echo -n "y|"
.    else
	@@echo -n "n|"
.    endif
.    if ${PERMIT_PACKAGE_FTP${_S}:L} == "yes"
	@@echo -n "y|"
.    else
	@@echo -n "n|"
.    endif
.    if ${PERMIT_DISTFILES_FTP:L} == "yes"
	@@echo "y"
.    else
	@@echo "n"
.    endif
.  endif
.endfor

print-build-depends:
.if !empty(_BUILD_DEP)
	@@echo -n 'This port requires package(s) "'
	@@PKGPATH=${PKGPATH} ${MAKE} full-build-depends| ${_lines2list}
	@@echo '" to build.'
.endif

print-run-depends:
.if !empty(_RUN_DEP)
	@@echo -n 'This port requires package(s) "'
	@@PKGPATH=${PKGPATH} ${MAKE} full-run-depends| ${_lines2list}
	@@echo '" to run.'
.endif

# full-build-depends, full-all-depends, full-run-depends full-test-depends
.for _i in build all run test
full-${_i}-depends:
	@@PKGPATH=${PKGPATH} ${MAKE} ${_i}-dir-depends|${_sort_dependencies}|while read subdir; do \
		${_flavor_fragment}; \
		eval $$toset ${MAKE} _print-packagename ; \
	done
.endfor

license-check:
.for _S in ${MULTI_PACKAGES}
.  if ${PERMIT_PACKAGE_CDROM${_S}:L} == "yes" || \
	${PERMIT_PACKAGE_FTP${_S}:L} == "yes"
	@@SUBPACKAGE=${_S} PKGPATH=${PKGPATH} ${MAKE} all-dir-depends|${_sort_dependencies}|while read subdir; do \
		${_flavor_fragment}; \
		_MASTER_PERMIT_CDROM=${PERMIT_PACKAGE_CDROM${_S}:Q}; \
		_MASTER_PERMIT_FTP=${PERMIT_PACKAGE_FTP${_S}:Q}; \
		export _MASTER_PERMIT_CDROM _MASTER_PERMIT_FTP; \
		eval $$toset ${MAKE} _license-check; \
	done
.  endif
.endfor

_license-check:
.for _i in FTP CDROM
.  if defined(_MASTER_PERMIT_${_i}) && ${_MASTER_PERMIT_${_i}:L} == "yes" && \
	${PERMIT_PACKAGE_${_i}:L} != "yes"
	@@echo >&2 "Warning: dependency ${PKGPATH} is not allowed for ${_i}"
.  endif
.endfor

# run-depends-list, build-depends-list, lib-depends-list, test-depends-list
.for _i in RUN BUILD LIB TEST
${_i:L}-depends-list:
.  if !empty(_${_i}_DEP3)
	@@echo -n "This port requires \""
	@@echo -n '${_${_i}_DEP3:C/ +/ /g}'| tr '\040' '\012'|sort -u|tr '\012' '\040' | sed -e 's, $$,,'
	@@echo "\" for ${_i:L}."
.  endif
.endfor

# recursive depend targets

print-package-signature print-update-signature:
	@@echo -n ${FULLPKGNAME${SUBPACKAGE}}
.if !empty(_DEPRUNLIBS)
	@@${_cache_fragment}; cd ${.CURDIR} && ${MAKE} _print-package-signature-lib _print-package-signature-run| \
		sort -u| \
		while read i; do echo -n ",$$i"; done
.else
	@@cd ${.CURDIR} && PKGPATH=${PKGPATH} ${MAKE} _print-package-signature-run | \
		sort -u| \
		while read i; do echo -n ",$$i"; done
.endif
	@@echo


print-package-args: run-depends-args

print-package-args: ${lib_depends_args} ${wantlib_args}

run-depends-args:
	@@${_emit_run_depends} | while ${_read_spec}; do \
		${_parse_spec}; \
		${_complete_pkgspec}; \
		echo "-P $$pkgpath:$$pkg:$$default"; \
	done

# waive checks for WANTLIB when we're running lib-depends-check
# since we're trying to figure out what's actually needed
all-lib-depends-args:
	@@${_emit_lib_depends} |while ${_read_spec}; do \
		${_parse_spec}; \
		${_complete_pkgspec}; \
		echo "-P $$pkgpath:$$pkg:$$default"; \
	done

# - remove lib-depends-args if we're only scanning for common dirs in
# update-plist and we're not shared only
# - zap wantlib-args when we're only solving for @@depends in pkg_create(1).
no-lib-depends-args no-wantlib-args:
	@@:

# those are expensive computations, so don't do them if we don't have to
.if empty(_DEPRUNLIBS)
lib-depends-args wantlib-args port-wantlib-args fake-wantlib-args:
.else

lib-depends-args:
	@@${_cache_fragment}; ${_emit_lib_depends}| while ${_read_spec}; do \
		${_if_check_needed}; then \
			${_complete_pkgspec}; \
			echo "-P $$pkgpath:$$pkg:$$default"; \
		else \
			echo "LIB_DEPENDS $$d not needed for ${FULLPKGPATH${SUBPACKAGE}} ?" 1>&2; \
		fi; \
	done

wantlib-args:
	@@${_cache_fragment}; \
	a=$${_DEPENDS_CACHE}/portstree-${FULLPKGNAME${SUBPACKAGE}}; \
	b=$${_DEPENDS_CACHE}/inst-${FULLPKGNAME${SUBPACKAGE}}; \
	if cd ${.CURDIR} && \
	${MAKE} port-wantlib-args >$$a && \
	${MAKE} fake-wantlib-args >$$b; then \
		if ! cmp -s $$a $$b; \
		then \
			echo 1>&2 "${_check_msg}: Libraries in packing-lists in the ports tree"; \
			echo 1>&2 "       and libraries from installed packages don't match"; \
			diff 1>&2 -u $$a $$b ${_check_error}; \
		fi; \
		cat $$b; \
		rm $$a $$b; \
	else \
		exit 1; \
	fi

port-wantlib-args:
	@@${_cache_fragment}; \
	if found=`${_list_port_libs} | ${_resolve_lib} ${_DEPRUNLIBS:QL}`; \
	then \
		${_show_found}; \
	else \
		exit 1; \
	fi

fake-wantlib-args:
	@@if found=`{ \
		echo {${WRKINST},}${LOCALBASE}/lib${_lib} /usr/lib${_lib} ${X11BASE}/lib${_lib}; \
		for d in ${_DEPRUNLIBS:QL}; do \
			case "$$d" in \
			/*) echo {${WRKINST},}$${d%/*}${_lib};; \
			*/*) echo {${WRKINST},}${LOCALBASE}/$${d%/*}${_lib};; \
			esac; \
		done } | perl -pe 's,\Q${WRKINST}\E,,g' | \
			${_resolve_lib} ${_DEPRUNLIBS:QL}`; then \
				${_show_found}; \
		else \
			exit 1; \
		fi
.endif

_print-package-signature-run:
	@@${_emit_run_depends} |while ${_read_spec}; do \
		${_parse_spec}; \
		${_compute_default}; \
		echo "@@$$default"; \
	done

_print-package-signature-lib:
	@@${_list_port_libs}| ${_resolve_lib} ${_DEPRUNLIBS:QL}; \
	${_emit_lib_depends}| while ${_read_spec}; do \
		${_if_check_needed}; then \
			${_complete_pkgspec}; \
			echo "@@$$default"; \
		fi; \
	done

# recursively build a list of dirs for package running, ready for tsort
_recurse-run-dir-depends:
.for _dir in ${_RUN_DEP}
	@@echo "$$self ${_dir}"; \
	if ! fgrep -q -e "r|${_dir}|" -e "a|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "r|${_dir}|" >> $${_DEPENDS_FILE}; \
		subdir=${_dir}; ${_flavor_fragment}; \
		toset="$$toset self=\"${_dir}\""; \
		if ! eval $$toset ${MAKE} _recurse-run-dir-depends; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
	fi
.endfor

run-dir-depends:
.if !empty(_RUN_DEP)
	@@${_depfile_fragment}; \
	if ! fgrep -q -e "r|${_FULLPKGPATH}|" -e "a|${_FULLPKGPATH}" $${_DEPENDS_FILE}; then \
		echo "r|${_FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${_FULLPKGPATH} PKGPATH=${PKGPATH} ${MAKE} _recurse-run-dir-depends; \
	fi
.else
	@@echo "${_FULLPKGPATH} ${_FULLPKGPATH}"
.endif

# recursively build a list of dirs for package regression tests, ready for tsort
_recurse-test-dir-depends:
.for _dir in ${_TEST_DEP}
	@@echo "$$self ${_dir}"; \
	if ! fgrep -q -e "R|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "R|${_dir}|" >> $${_DEPENDS_FILE}; \
		subdir=${_dir}; ${_flavor_fragment}; \
		toset="$$toset self=\"${_dir}\""; \
		if ! eval $$toset ${MAKE} _recurse-run-dir-depends; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
	fi
.endfor

test-dir-depends:
.if !empty(_TEST_DEP)
	@@${_depfile_fragment}; \
	if ! fgrep -q -e "R|${_FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "R|${_FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${_FULLPKGPATH} PKGPATH=${PKGPATH} ${MAKE} _recurse-test-dir-depends; \
	fi
.else
	@@echo "${_FULLPKGPATH} ${_FULLPKGPATH}"
.endif

# recursively build a list of dirs for package building, ready for tsort
# second and further stages need _RUN_DEP.
_recurse-all-dir-depends:
.for _dir in ${_BUILD_DEP} ${_RUN_DEP}
	@@echo "$$self ${_dir}"; \
	if ! fgrep -q "a|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "a|${_dir}|" >> $${_DEPENDS_FILE}; \
		subdir=${_dir}; ${_flavor_fragment}; \
		toset="$$toset self=\"${_dir}\""; \
		if ! eval $$toset ${MAKE} _recurse-all-dir-depends; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
	fi
.endfor

# first stage does not need _RUN_DEP
_build-dir-depends:
.for _dir in ${_BUILD_DEP}
	@@echo "$$self ${_dir}"; \
	if ! fgrep -q -e "b|${_dir}|" -e "a|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "b|${_dir}|" >> $${_DEPENDS_FILE}; \
		subdir=${_dir}; ${_flavor_fragment}; \
		toset="$$toset self=\"${_dir}\""; \
		if ! eval $$toset ${MAKE} _recurse-all-dir-depends; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
	fi
.endfor

build-dir-depends:
.if !empty(_BUILD_DEP)
	@@${_depfile_fragment}; \
	if ! fgrep -q -e "b|${_FULLPKGPATH}|" -e "a|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "b|${_FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${_FULLPKGPATH} PKGPATH=${PKGPATH} ${MAKE} _build-dir-depends; \
	fi
.else
	@@echo "${_FULLPKGPATH} ${_FULLPKGPATH}"
.endif

all-dir-depends:
.if !empty(_BUILD_DEP) || !empty(_RUN_DEP)
	@@${_depfile_fragment}; \
	if ! fgrep -q "|${_FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "|${_FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${_FULLPKGPATH} PKGPATH=${PKGPATH} ${MAKE} _recurse-all-dir-depends; \
	fi
.else
	@@echo "${_FULLPKGPATH} ${_FULLPKGPATH}"
.endif

# simpler list of package depends, no need to tsort, no duplicates
_recurse-show-run-depends:
	@@for d in ${_RUN_DEP}; do \
		fgrep -q -e "|$$d|" $${_DEPENDS_FILE} && continue; \
		echo "$$d"; \
		echo "|$$d|" >> $${_DEPENDS_FILE}; \
		subdir=$$d; ${_flavor_fragment}; \
		if ! eval $$toset ${MAKE} _recurse-show-run-depends; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
	done

show-run-depends:
.if !empty(_RUN_DEP)
	@@${_depfile_fragment}; \
	echo "|${_FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
	for d in ${_RUN_DEP}; do \
		fgrep -q -e "|$$d|" $${_DEPENDS_FILE} && continue; \
		echo "$$d"; \
		echo "|$$d|" >> $${_DEPENDS_FILE}; \
		subdir=$$d; ${_flavor_fragment}; \
		if ! eval $$toset ${MAKE} _recurse-show-run-depends; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
	done
.endif

#####################################################
# convenience targets, not really needed
#####################################################

checkpatch:
	@@${_MAKE} PATCH_CHECK_ONLY=Yes patch

clean-depends:
	@@${_MAKE} clean=depends

distclean:
	@@${_MAKE} clean=dist

reinstall:
	@@${_MAKE} clean='install force'
	@@cd ${.CURDIR} && _DEPENDS_TARGET=reinstall PKGPATH=${PKGPATH} exec ${MAKE} install

repackage:
	@@${_MAKE} clean=packages
	@@${_MAKE} package

rebuild:
	@@rm -f ${_BUILD_COOKIE}
	@@${_MAKE} build

uninstall deinstall:
	@@${ECHO_MSG} "===> Deinstalling for ${FULLPKGNAME${SUBPACKAGE}}"
	@@${SUDO} ${_PKG_DELETE} ${FULLPKGNAME${SUBPACKAGE}}

peek-ftp:
	@@echo "DISTFILES=${DISTFILES}"
	@@install -d ${DISTDIR_MODE} ${FULLDISTDIR}; \
	cd ${FULLDISTDIR}; echo "cd ${FULLDISTDIR}"; \
	for i in ${MASTER_SITES:Mftp*}; do \
		echo "Connecting to $$i"; ${FETCH_CMD} $$i ; break; \
	done

show-required-by:
	@@cd ${PORTSDIR} && make all-dir-depends | ${_PERLSCRIPT}/extract-dependencies -r ${_ALLPKGPATHS}


show:
.for _s in ${show}
	@@echo ${${_s}:Q}
.endfor

# avoid sudo and avoid modifying dir (if possible):
# du fails if it can't access everything
show-size:
	@@if du -ks ${WRKDIR} 2>/dev/null >${WRKDIR}/wrkdir-size; then \
		cat ${WRKDIR}/wrkdir-size && rm -f ${WRKDIR}/wrkdir-size; \
	else \
		chmod -R u+rX ${WRKDIR}; \
		du -ks ${WRKDIR}; \
	fi

show-fake-size:
	@@if du -ks ${WRKINST} 2>/dev/null >${WRKINST}/wrkdir-size; then \
		cat ${WRKINST}/wrkdir-size && rm -f ${WRKINST}/wrkdir-size; \
	else \
		chmod -R u+rX ${WRKINST}; \
		du -ks ${WRKINST}; \
	fi

verbose-show:
.for _s in ${verbose-show}
. if defined(${_s})
	@@echo ${_s}=${${_s}:Q}
. endif
.endfor

_all_phony = ${_recursive_depends_targets} \
	${_recursive_targets} ${_dangerous_recursive_targets} \
	_build-dir-depends _hook-post-install \
	_internal-all _internal-build _internal-build-depends \
	_internal-checksum _internal-clean _internal-configure \
	_internal-distpatch _internal-extract _internal-fake _internal-fetch \
	_internal-fetch-all _internal-install-depends \
	_internal-install-all _internal-manpages-check \
	_internal-package _internal-package-only _internal-plist _internal-prepare \
	_internal-test _internal-test-depends \
	_internal-subpackage _internal-subupdate \
	_internal-update _internal-update _internal-update-plist \
	_internal_install _license-check \
	print-package-args _print-package-signature-lib \
	_print-package-signature-run _print-packagename _recurse-all-dir-depends \
	_recurse-test-dir-depends _recurse-run-dir-depends _refetch \
	build-depends-list checkpatch clean clean-depends \
	delete-package distpatch do-build do-configure do-distpatch \
	do-extract do-install do-test fetch-all \
	install-all lib-depends lib-depends-list \
	peek-ftp port-lib-depends-check post-build post-configure \
	post-distpatch post-extract post-install \
	post-patch post-test pre-build pre-configure pre-extract pre-fake \
	pre-install pre-patch pre-test prepare \
	print-build-depends print-run-depends rebuild \
	test-depends test-depends-list run-depends-list \
    show-required-by subpackage uninstall _print-metadata \
	run-depends-args lib-depends-args all-lib-depends-args wantlib-args \
	port-wantlib-args fake-wantlib-args no-wantlib-args no-lib-depends-args \
	_recurse-show-run-depends show-run-depends

.if defined(_DEBUG_TARGETS)
.  for _t in ${_all_phony}
.    if !target(${_t})
ERRORS += "Fatal: phony target ${_t} does not exist"
.    endif
.  endfor
.endif

.if defined(ERRORS)
.BEGIN:
.  for _m in ${ERRORS}
	@@echo 1>&2 ${_m} "(in ${PKGPATH})"
.  endfor
.  if !empty(ERRORS:M"Fatal\:*") || !empty(ERRORS:M'Fatal\:*')
	@@exit 1
.  endif
.endif

.PHONY: ${_all_phony}
@


1.1340
log
@add cached packages to the list of cleaned packages when make clean=packages
I agree with rpe@@, this was odd.

Also remove an extra / in constructed package names.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1339 2017/02/28 21:31:46 edd Exp $
d267 22
@


1.1339
log
@Fix a typo in a variable name.

OK espie@@, landry@@. Thanks.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1338 2017/02/26 18:54:48 espie Exp $
d669 1
a669 1
	${_PACKAGE_COOKIES} \
d857 1
d1854 1
a1854 1
${_CACHE_REPO}/${_PKGFILE${_S}}:
d1871 1
a1871 1
	@@f=${_CACHE_REPO}/${_PKGFILE${_S}}; \
d2925 1
a2925 1
	rm -f ${_PACKAGE_COOKIES} ${_UPDATE_COOKIES}
@


1.1338
log
@makesum: when distinfo changes, display a diff.
okay aja@@ landry@@

(think multiple distfiles)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1337 2017/02/26 11:18:25 espie Exp $
d1936 1
a1936 1
		   ${SUDO} ${SETENV} ${_TERM_ ENV} ${_PKG_ADD_LOCAL} ${_PKG_ADD_AUTO} -r ${_PKG_ADD_FORCE} ${PKGFILE${_S}};; \
@


1.1337
log
@GC old stuff
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1336 2017/02/21 13:55:16 espie Exp $
d1958 1
a1958 1
	@@rm -f ${CHECKSUM_FILE}
d1967 2
@


1.1336
log
@TRUSTED_PKG_PATH has been there long enough, so use it as intended
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1335 2017/02/21 13:53:40 espie Exp $
a757 5
OLD_WRKDIR_NAME = w-${_WRKDIR_STEM}

_WRKDIRS = ${.CURDIR}/${OLD_WRKDIR_NAME}

.if !empty(WRKOBJDIR_${PKGPATH})
d759 1
a759 1
_WRKDIRS += ${WRKOBJDIR_${PKGPATH}}/${_WRKDIR_STEM}
a761 3
.else
WRKDIR ?= ${.CURDIR}/${OLD_WRKDIR_NAME}
.endif
a1176 15
# OpenBSD code to handle ports distfiles on a CDROM.
#
#CDROM_SITE ?= /cdrom/distfiles/${DIST_SUBDIR}
CDROM_SITE ?=

.if !empty(CDROM_SITE)
.  if defined(FETCH_SYMLINK_DISTFILES)
_CDROM_OVERRIDE = if ln -s ${CDROM_SITE}/$$f .; then exit 0; fi
.  else
_CDROM_OVERRIDE = if cp -f ${CDROM_SITE}/$$f .; then exit 0; fi
.  endif
.else
_CDROM_OVERRIDE =:
.endif

a2831 1
	${_CDROM_OVERRIDE}; \
a3294 29
.endif

link-categories:
.for _CAT in ${CATEGORIES}
	@@linkname=${PORTSDIR}/${_CAT}/`basename ${.CURDIR}`; \
	if [ ! -e $$linkname ]; then \
		echo "$$linkname -> ${.CURDIR}"; \
		mkdir -p ${PORTSDIR}/${_CAT}; \
		ln -s ${.CURDIR} $$linkname; \
	fi
.endfor

unlink-categories:
.for _CAT in ${CATEGORIES}
	@@linkname=${PORTSDIR}/${_CAT}/`basename ${.CURDIR}`; \
	if [ -L $$linkname ]; then \
		echo "rm $$linkname"; \
		rm $$linkname; \
		if rmdir ${PORTSDIR}/${_CAT} 2>/dev/null; then \
			echo "rmdir ${PORTSDIR}/${_CAT}"; \
	    fi; \
	fi
.endfor

homepage-links:
.if defined(HOMEPAGE)
	@@echo '<li><A HREF="${HOMEPAGE}">${PKGNAME}</A>'
.else
	@@echo '<li>${PKGNAME}'
@


1.1335
log
@explain the very intricate logic that handles all fetched files
simplify one variable
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1334 2017/02/21 13:49:34 espie Exp $
d203 1
a203 1
_PKG_ADD_LOCAL = PKG_PATH=${_PKG_REPO} ${_PKG_ADD} -Dunsigned
@


1.1334
log
@instead of
VAR=
.for x in <maybe empty>
VAR += value
.endfor

do
.for x in <maybe empty>
VAR += value
.endfor
VAR ?=

(avoid an extra empty value at front)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1333 2017/02/21 13:46:18 espie Exp $
d1211 12
d1231 1
a1231 1
_FULL_$v += $f $f $m $u
d1234 1
a1234 1
_FULL_$v += ${DIST_SUBDIR}/$f $f $m $u
a1241 1
_FULL_$v =
d1246 1
d2840 1
a2840 1
.for p f m u in ${_FULL_DISTFILES} ${_FULL_PATCHFILES} ${_FULL_SUPDISTFILES}
@


1.1333
log
@unbreak checksum. Simplify messages
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1332 2017/02/21 13:31:56 espie Exp $
a1535 1
_DEP${_DEP}_COOKIES =
d1539 1
@


1.1332
log
@comment tweaks
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1331 2017/02/21 13:15:01 espie Exp $
d2236 2
a2237 8
		set -- $$(grep -i "^${_CIPHER} ($$file)" ${CHECKSUM_FILE}) \
		  && break || \
		  ${ECHO_MSG} ">> No ${_CIPHER} checksum recorded for $$file."; \
		case "$$4" in \
		  "") \
			${ECHO_MSG} ">> No checksum recorded for $$file."; \
			OK=false;; \
		  *) \
d2240 1
a2240 2
				echo ">> Checksum mismatch for $$file. ($$cipher)"; \
				list="$$list $$file $$cipher $$4"; \
d2242 5
a2246 2
			fi;; \
		esac; \
d2253 4
a2256 4
		  echo "Make sure the Makefile and checksum file (${CHECKSUM_FILE})"; \
		  echo "are up to date.  If you want to fetch a good copy of this"; \
		  echo "file from the OpenBSD main archive, type"; \
		  echo "\"make REFETCH=true [other args]\"."; \
@


1.1331
log
@kill some old ghosts:
FTP_KEEP_ALIVE, README_TOPS, _FETCH*, RECURSIVE_FETCH_LIST
detection of old INSTALL/DEINSTALL/REQ scripts
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1330 2017/02/20 13:45:17 espie Exp $
a16 18
# Enquiries as to the bsd.port.mk framework should usually be directed
# to ports@@openbsd.org.


.if ${.MAKEFLAGS:MFLAVOR=*}
ERRORS += "Fatal: Use 'env FLAVOR=${FLAVOR} ${MAKE}' instead."
.endif
.if ${.MAKEFLAGS:MSUBPACKAGE=*}
ERRORS += "Fatal: Use 'env SUBPACKAGE=${SUBPACKAGE} ${MAKE}' instead."
.endif

.for f v in bsd.port.mk _BSD_PORT_MK bsd.port.subdir.mk _BSD_PORT_SUBDIR_MK
.  if defined($v)
ERRORS += "Fatal: inclusion of bsd.port.mk from $f"
.  endif
.endfor

_BSD_PORT_MK = Done
d25 6
d32 1
a32 1
# Default sequence for "all" is:  fetch checksum extract patch configure build
d47 19
d90 1
a90 1
# All variables relevant to the port's description
d98 2
a99 1

d127 1
a127 1
# special purpose user settings
a131 2
# Constants used by the ports tree

d161 3
a163 1
# local path locations
d217 1
d231 1
a231 2
# need to go through an extra var because clean is set in stone,
# on the cmdline.
d248 1
a248 1
# check that clean is clean
d373 2
d385 3
a387 2
# Intermediate variable because some tools like python to not properly
# parse variables with trailing spaces and add a bogus "" argument.
d396 1
d410 1
d417 4
d434 1
a434 1

a677 1
# Miscellaneous overridable commands:
d682 1
a682 1
# Don't touch !!! Used for generating checksums.
d698 2
d959 1
a1247 2
# XXX note that we DON'T set EXTRACT_SUFX.

d1249 1
d1358 2
d1464 1
a1464 1
# XXX save result pre-normalization, just for checking
@


1.1330
log
@remove quite a few old targets, introduce a new one
- 'prepare' is what gets dependencies in place to build a port
- install-depends is what the install/update cookies do internally
before installing a port.

older / intermediate targets are not really needed, namely:
build-depends, run-depends, runlib-depends, runwantlib-depends,
lib-depends, buildlib-depends, buildwantlib-depends

They redirect to cookies, so just depend on the cookies directly

okay aja@@, sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1329 2017/02/18 15:15:07 espie Exp $
a62 1
RECURSIVE_FETCH_LIST ?= No
a63 1
_FETCH_MAKEFILE ?= /dev/stdout
a172 2
FTP_KEEPALIVE ?= 0

d180 1
a180 1
FETCH_CMD ?= /usr/bin/ftp -V ${_PROGRESS} -k ${FTP_KEEPALIVE} -C
a1043 9
.  if exists(${PKGDIR}/INSTALL)
ERRORS += "Fatal: INSTALL script support is obsolete"
.  endif
.  if exists(${PKGDIR}/DEINSTALL)
ERRORS += "Fatal: DEINSTALL script support is obsolete"
.  endif
.  if exists(${PKGDIR}/REQ)
ERRORS += "Fatal: REQ script support is obsolete"
.  endif
a1070 9
.    if exists(${PKGDIR}/INSTALL${_S})
ERRORS += "Fatal: INSTALL script support is obsolete"
.    endif
.    if exists(${PKGDIR}/DEINSTALL${_S})
ERRORS += "Fatal: DEINSTALL script support is obsolete"
.    endif
.    if exists(${PKGDIR}/REQ${_S})
ERRORS += "Fatal: REQ script support is obsolete"
.    endif
a1422 2
PORT_LD_LIBRARY_PATH = ${LOCALBASE}/lib:${X11BASE}/lib:/usr

a1539 4

.for _S in ${MULTI_PACKAGES}
_FETCH_MAKEFILE_NAMES += ${PKGPATH}/${FULLPKGNAME${_S}}
.endfor
@


1.1329
log
@list-distinfo never got used so kill it
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1328 2017/02/18 15:00:02 espie Exp $
d1930 1
a1930 2
		exec ${MAKE} _internal-run-depends _internal-runlib-depends \
		_internal-runwantlib-depends
d1953 1
a1953 2
		     ${MAKE} _internal-run-depends _internal-runlib-depends \
			   _internal-runwantlib-depends; \
d1962 1
a1962 2
		exec ${MAKE} _internal-run-depends _internal-runlib-depends \
		_internal-runwantlib-depends
d1994 2
a1995 4
_internal-depends: _internal-lib-depends _internal-build-depends \
	_internal-buildlib-depends \
	_internal-run-depends _internal-buildwantlib-depends \
	_internal-runwantlib-depends _internal-test-depends
d1997 4
a2000 2
_internal-prepare: _internal-build-depends _internal-buildlib-depends \
	_internal-buildwantlib-depends
a2105 7
_internal-build-depends: ${_DEPBUILD_COOKIES}
_internal-run-depends: ${_DEPRUN_COOKIES}
_internal-lib-depends: ${_DEPBUILDLIB_COOKIES}
_internal-test-depends: ${_DEPTEST_COOKIES}
_internal-buildlib-depends: ${_DEPBUILDLIB_COOKIES}
_internal-runlib-depends: ${_DEPRUNLIB_COOKIES}

a2146 1
_internal-${_m:L}wantlib-depends: ${_DEP${_m}WANTLIB_COOKIE}
d2360 2
a2361 3
	subupdate fetch fetch-all checksum test prepare \
	depends lib-depends build-depends run-depends test-depends \
	clean manpages-check plist update-plist \
d3425 1
a3425 2
	_internal-buildlib-depends _internal-buildwantlib-depends \
	_internal-checksum _internal-clean _internal-configure _internal-depends \
d3427 2
a3428 2
	_internal-fetch-all \
	_internal-install-all _internal-lib-depends _internal-manpages-check \
d3430 2
a3431 2
	_internal-test _internal-test-depends _internal-run-depends \
	_internal-runwantlib-depends _internal-subpackage _internal-subupdate \
d3433 1
a3433 1
	_internal_install _internal_runlib-depends _license-check \
d3437 2
a3438 2
	build-depends build-depends-list checkpatch clean clean-depends \
	delete-package depends distpatch do-build do-configure do-distpatch \
d3446 1
a3446 1
	test-depends test-depends-list run-depends run-depends-list \
@


1.1328
log
@more simplification, there is no reason for having several crypto ciphers
in the ports tree at any one time.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1327 2017/02/17 23:17:43 espie Exp $
a1988 5
.endif

list-distinfo:
.if !empty(MAKESUMFILES)
	@@cat ${CHECKSUM_FILE} 2>/dev/null 
@


1.1327
log
@cleanup checksum/makesum

- fix DISTFILES/CHECKSUMFILES
- simplify list-distinfo
- zap IGNORE lines in distinfo (can't generate, not used)
- internal _MAKESUM=true/false -> simplify actual size check in
fetching makefiles
- NO_CHECKSUM applies only to checksum, not makesum, ever.

okay aja@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1326 2017/02/13 12:56:50 espie Exp $
d185 3
d671 1
a671 4
_CIPHERS = sha256

# This is the one you can override
PREFERRED_CIPHERS ?= ${_CIPHERS}
d1983 1
a1983 1
	@@cd ${DISTDIR} && cksum -b -a "${_CIPHERS}" ${MAKESUMFILES} >> ${CHECKSUM_FILE}
d2250 6
a2255 5
.  if !defined(NO_CHECKSUM)
	@@if [ -z "${CHECKSUMFILES}" ]; then \
	  ${ECHO_MSG} ">> No distfiles."; \
	elif [ ! -f ${CHECKSUM_FILE} ]; then \
	  ${ECHO_MSG} ">> No checksum file."; \
d2257 32
a2288 34
	else \
	  cd ${DISTDIR}; OK=true; list=''; \
		for file in ${CHECKSUMFILES}; do \
		  for cipher in ${PREFERRED_CIPHERS}; do \
			set -- $$(grep -i "^$$cipher ($$file)" ${CHECKSUM_FILE}) \
			  && break || \
			  ${ECHO_MSG} ">> No $$cipher checksum recorded for $$file."; \
		  done; \
		  case "$$4" in \
			"") \
			  ${ECHO_MSG} ">> No checksum recorded for $$file."; \
			  OK=false;; \
			*) \
			  echo -n '>> '; \
			  if ! echo "$$@@" | cksum -c; then \
				  echo ">> Checksum mismatch for $$file. ($$cipher)"; \
				  list="$$list $$file $$cipher $$4"; \
				  OK=false; \
			  fi;; \
		  esac; \
		done; \
		set --; \
		if ! $$OK; then \
		  if ${REFETCH}; then \
		  	cd ${.CURDIR} && PKGPATH=${PKGPATH} ${MAKE} _refetch _PROBLEMS="$$list"; \
		  else \
			echo "Make sure the Makefile and checksum file (${CHECKSUM_FILE})"; \
			echo "are up to date.  If you want to fetch a good copy of this"; \
			echo "file from the OpenBSD main archive, type"; \
			echo "\"make REFETCH=true [other args]\"."; \
			exit 1; \
		  fi; \
		fi ; \
  fi
@


1.1326
log
@we generally don't use subshells, comment that explicitly. I had to read back
the log to remember that one :)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1325 2016/12/13 07:25:47 landry Exp $
d185 1
d1978 1
a1978 1
makesum: fetch-all
a1979 1
.if !defined(NO_CHECKSUM) && !empty(MAKESUMFILES)
d1981 2
d1992 3
a1994 8
	@@if test -e ${CHECKSUM_FILE}; then cat ${CHECKSUM_FILE}; \
	else \
		if ! test -z "${DISTFILES}"; then \
			echo 1>&2 "${CHECKSUM_FILE} not found"; \
			exit 1; \
		fi; \
	fi

d2251 1
a2251 1
	@@if [ -z "${DISTFILES}" ]; then \
a2267 3
			"IGNORE") \
			  echo ">> Error: checksum for $$file is set to IGNORE in distinfo"; \
			  OK=false;; \
d2874 4
d2882 1
a2882 6
				ck=`${_size_fragment} $$file $p`; \
				if [ ! -f ${CHECKSUM_FILE} ]; then \
					${ECHO_MSG} ">> Checksum file does not exist"; \
					mv $$file $@@; \
					exit 0; \
				elif grep -q "^$$ck\$$" ${CHECKSUM_FILE}; then \
d2886 2
a2887 5
					if grep -q "SIZE ($p)" ${CHECKSUM_FILE}; then \
						${ECHO_MSG} ">> Size does not match for $p"; \
						rm -f $$file; \
					else \
						${ECHO_MSG} ">> No size recorded for $p"; \
d2890 9
@


1.1325
log
@Add support for MODFOO_post-extract so that modules can hook up commands
after post-extract.

From semarie@@, ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1324 2016/10/31 11:08:34 jasper Exp $
d2406 1
@


1.1324
log
@silence the creation of the msgfmt wrapper just like the other wrapper scripts
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1323 2016/10/28 15:46:48 sthen Exp $
d313 1
a313 1
.for _t in post-patch pre-configure configure pre-fake post-install
d2495 5
@


1.1323
log
@Poison gettext-tools with "echo && exit 1" scripts in WRKDIR/bin if the
dependency is not in BUILD_DEPENDS, to make it more obvious if the dep has
been missed. OK ajacoutot
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1322 2016/09/06 10:31:12 espie Exp $
d2475 1
a2475 1
	printf '#!/bin/sh\n\
d2478 1
a2478 1
	chmod 555 ${WRKDIR}/bin/msgfmt
@


1.1322
log
@dismantle SIGNING_PARAMETERS, no longer possible nor advisable to sign
stuff on the fly
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1321 2016/09/03 13:29:59 sthen Exp $
d2471 11
@


1.1321
log
@set PATCH_DEBUG=Yes by default, to make it easier to notice patches which
get misapplied after an update (fuzz etc). ok giovanni@@ landry@@ danj@@ edd@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1320 2016/08/18 12:28:53 sthen Exp $
d194 2
a195 2
_PKG_CREATE = ${PKG_CREATE} ${_PROGRESS} ${SIGNING_PARAMETERS}
_PKG_ADD_LOCAL = PKG_PATH=${_PKG_REPO} ${_PKG_ADD}
a196 8

SIGNING_PARAMETERS ?=
.if empty(SIGNING_PARAMETERS)
_PKG_ADD_LOCAL += -Dunsigned
.else
_PKG_ADD_LOCAL += ${SIGNING_PARAMETERS:M-DSIGNER=*}
.endif

@


1.1320
log
@Add an USE_WXNEEDED flag for ports, to write an ld wrapper script in
${WRKDIR}/bin that adds -z wxneeded to linker command lines. It won't work
everywhere but provides an easy (and easily identifiable) way to add this
flag without fiddling with build systems.

Feedback/ok jca@@ jasper@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1319 2016/07/10 18:51:03 espie Exp $
d707 1
a707 1
PATCH_DEBUG ?= No
@


1.1319
log
@@@pkgname does not exist.
For dynamic plists, we can still do slightly better, namely trick
pkg_create into spewing out what it knows by zapping the plists it knows
(generated under fake typically) and replacing them with /dev/null

This fixes check-problems when you run it purely based on the ports tree
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1318 2016/06/22 10:13:17 ajacoutot Exp $
d113 1
a113 1
	PORTROACH_COMMENT MAKEFILE_LIST
d364 1
d2599 4
@


1.1318
log
@Remove references to SHARED_ONLY; it's unused nowadays.
Not touching make-plist too much because espie@@ already has local changes in that file.

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1317 2016/05/17 13:38:25 espie Exp $
d2823 1
a2823 1
		@@echo "@@pkgname ${FULLPKGNAME${_S}}"
@


1.1317
log
@propagate emptyness property from PLIST_DB into PACKAGE_REPOSITORY
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1316 2016/05/17 13:33:21 espie Exp $
a2366 1
	SHARED_ONLY=Yes \
@


1.1316
log
@Introduce PLIST_REPOSITORY, to be more similar to PACKAGE_REPOSITORY
(makes sense in cluster bulk setup contexts)
okay sthen@@, landry@@ (after thinko fix)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1315 2016/05/01 09:12:27 ajacoutot Exp $
d138 1
d140 1
@


1.1315
log
@Be consistent whether we're using FAKE_AS_ROOT (the default) or not and
always use the same BINMODE and NONBINMODE; ours are a bit different from the
ones from base (bsd.own.mk) (755 vs 555 and 644 vs 444).
Fix a typo while here: SHAREMORE -> SHAREMODE

tested in a bulk
ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1314 2016/04/27 20:41:04 espie Exp $
a135 1
PLIST_DB ?= ${PORTSDIR}/plist/${MACHINE_ARCH}
d137 2
@


1.1314
log
@-Dinstalled -Ddowngrade is useless without -r
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1313 2016/04/27 18:13:09 espie Exp $
d81 4
a901 4
BINMODE = 755
NONBINMODE = 644
MANMODE = ${NONBINMODE}
SHAREMORE = ${NONBINMODE}
@


1.1313
log
@zap vax support
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1312 2016/04/26 17:35:35 naddy Exp $
d1878 1
a1878 1
	@@if ${SETENV} ${_TERM_ENV} PKG_CACHE=${_CACHE_REPO} PKG_PATH=${_CACHE_REPO}:${_PKG_REPO}:${PACKAGE_REPOSITORY}/${NO_ARCH}/:${PKG_PATH} ${_PKG_ADD} -n -q ${_PKG_ADD_FORCE} -D installed -D downgrade ${_PKGFILE${_S}} >/dev/null 2>&1; then \
@


1.1312
log
@remove DEPBASE, DEPDIR; nothing in the tree uses this; ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1311 2016/04/26 10:56:59 sthen Exp $
a531 2

_PKG_ARGS += -DSHARED_LIBS=1
@


1.1311
log
@Clean up some bits missed in yesterday's systrace removal.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1310 2016/03/20 20:07:20 naddy Exp $
d369 1
a369 1
LIBTOOL ?= ${DEPBASE}/bin/libtool
d674 1
a674 1
PORTPATH ?= ${WRKDIR}/bin:/usr/bin:/bin:/usr/sbin:/sbin:${DEPBASE}/bin:${LOCALBASE}/bin:${X11BASE}/bin
d690 1
a690 1
	LOCALBASE='${LOCALBASE}' DEPBASE='${DEPBASE}' X11BASE='${X11BASE}' \
a1450 2
DEPBASE = ${LOCALBASE}
DEPDIR =
d2465 1
a2465 1
	@@mkdir -p ${WRKDIR} ${WRKDIR}/bin ${DEPDIR}
@


1.1310
log
@remove SHARED_ONLY
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1309 2016/03/15 22:56:27 naddy Exp $
a61 1
USE_SYSTRACE ?= No
a66 6
.if ${USE_SYSTRACE:L} == "yes"
WRKOBJDIR_MFS ?!= readlink -fn /tmp/pobj
.else
WRKOBJDIR_MFS ?= /tmp/pobj
.endif

a67 3
.if ${USE_SYSTRACE:L} == "yes"
WRKOBJDIR ?!= readlink -fn ${PORTSDIR}/pobj
.else
d69 1
a69 1
.endif
a617 1
_SYSTRACE_COOKIE =		${WRKDIR}/systrace.policy
d654 1
a654 1
	${_SYSTRACE_COOKIE} ${_PACKAGE_COOKIES} \
a949 19
# setup systrace variables
NO_SYSTRACE ?= No
.if ${USE_SYSTRACE:L} == "yes" && ${NO_SYSTRACE:L} == "no"
_SYSTRACE_CMD ?= /bin/systrace -e -i -a -f ${_SYSTRACE_COOKIE}
.else
_SYSTRACE_CMD =
.endif
SYSTRACE_FILTER ?= ${PORTSDIR}/infrastructure/db/systrace.filter
SYSTRACE_FILTER_CCACHE ?= ${PORTSDIR}/infrastructure/db/systrace.filter.ccache
_SYSTRACE_POLICIES += /bin/sh /usr/bin/env /usr/bin/make \
	/usr/bin/patch ${DEPBASE}/bin/gmake
SYSTRACE_SUBST_VARS += DISTDIR PKG_TMPDIR PORTSDIR TMPDIR WRKDIR
.if ${USE_CCACHE:L} == "yes" && ${NO_CCACHE:L} == "no"
SYSTRACE_SUBST_VARS += CCACHE_DIR
.endif
.for _v in ${SYSTRACE_SUBST_VARS}
_SYSTRACE_SED_SUBST += -e 's,$${${_v}},${${_v}},g'
.endfor

d1557 1
a1557 1
	cd ${WRKCONF} && ${_SYSTRACE_CMD} ${SETENV} \
a1984 16
${_SYSTRACE_COOKIE}: ${_WRKDIR_COOKIE}
	@@rm -f $@@
.for _i in ${_SYSTRACE_POLICIES}
	@@echo "Policy: ${_i}, Emulation: native" >> $@@
	@@if [ -f ${.CURDIR}/systrace.filter ]; then \
		sed ${_SYSTRACE_SED_SUBST} ${.CURDIR}/systrace.filter >> $@@; \
	fi
	@@sed ${_SYSTRACE_SED_SUBST} ${SYSTRACE_FILTER} >> $@@
.  if ${USE_CCACHE:L} == "yes" && ${NO_CCACHE:L} == "no"
	@@sed ${_SYSTRACE_SED_SUBST} ${SYSTRACE_FILTER_CCACHE} >> $@@
.  endif
.endfor
	@@if [ -f ${.CURDIR}/systrace.policy ]; then \
		sed ${_SYSTRACE_SED_SUBST} ${.CURDIR}/systrace.policy >> $@@; \
	fi

d2483 1
a2483 1
${_EXTRACT_COOKIE}: ${_WRKDIR_COOKIE} ${_SYSTRACE_COOKIE}
d2582 1
a2582 1
							${_SYSTRACE_CMD} ${PATCH} ${PATCH_ARGS} < $$i || \
d2675 1
a2675 1
	@@cd ${WRKBUILD} && exec ${_SYSTRACE_CMD} ${SETENV} ${MAKE_ENV} \
d2763 1
a2763 1
	@@cd ${WRKBUILD} && umask 022 && exec ${_FAKESUDO} ${_SYSTRACE_CMD} \
@


1.1309
log
@tell make-plist to never generate PFRAG.shared; ok sthen@@ espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1308 2016/03/15 20:58:58 naddy Exp $
d114 1
a114 1
	NO_BUILD SHARED_ONLY PSEUDO_FLAVORS \
a331 1
SHARED_ONLY ?= No
@


1.1308
log
@remove NO_SHARED_LIBS; ok espie@@ and successful bulk build
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1307 2016/03/11 20:32:22 naddy Exp $
d2415 1
a2415 1
	SHARED_ONLY="${SHARED_ONLY}" \
@


1.1307
log
@retire and poison CONFIGURE_SHARED
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1306 2016/03/09 17:21:44 naddy Exp $
a543 3
.if ${NO_SHARED_LIBS:L} == "yes"
_PKG_ARGS += -DSHARED_LIBS=0
.else
d545 1
a545 1
.endif
a1427 4
.if ${SHARED_ONLY:L} == "yes" && ${NO_SHARED_LIBS:L} == "yes"
IGNORE += "requires shared libraries"
.endif

a1461 4
.if ${NO_SHARED_LIBS:L} == "yes"
_resolve_lib += -noshared
.endif

a1619 1
.  if ${NO_SHARED_LIBS:L} != "yes"
a1621 3
.  else
_LIB_DEP3 =
.  endif
a1627 1
.    if ${NO_SHARED_LIBS:L} != "yes"
a1628 3
.    else
_LIB_DEP3${_S} =
.    endif
a1803 6
.if ${NO_SHARED_LIBS:L} == "yes"
_warn_if_shared = :
.else
_warn_if_shared = echo "LIB_DEPENDS $$d not needed for ${FULLPKGPATH${SUBPACKAGE}} ?" 1>&2
.endif

a2397 6
.  if ${SHARED_ONLY:L} == "yes"
_do_libs_too =
.  else
_do_libs_too = NO_SHARED_LIBS=Yes
.  endif

d2401 1
a2401 1
_extra_info += DEPPATHS${_s}="$$(${SETENV} FLAVOR=${FLAVOR:Q} SUBPACKAGE=${_s} PKGPATH=${PKGPATH} ${MAKE} show-run-depends ${_do_libs_too})"
a3141 1
.if ${NO_SHARED_LIBS:L} != "yes"
a3142 1
.endif
d3177 1
a3177 1
			${_warn_if_shared}; \
@


1.1306
log
@We are done providing support for the vax.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1305 2016/01/06 19:51:54 jasper Exp $
a1386 6

.if ${NO_SHARED_LIBS:L} == "yes"
CONFIGURE_SHARED ?= --disable-shared
.else
CONFIGURE_SHARED ?= --enable-shared
.endif
@


1.1305
log
@strip leading 'v' from GH_TAGNAME when constructing DISTNAME

suggested by sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1304 2015/12/29 19:48:08 jasper Exp $
a1600 5
LIBM_CHECK ?=
.if ${MACHINE_ARCH} == "vax" && !empty(LIBM_CHECK)
_DEPBUILDLIB_COOKIES += ${WRKDIR}/.libm-check
.endif

a2195 8

${WRKDIR}/.libm-check:
	@@nm /usr/lib/libm.a >${WRKDIR}/.libm-list
.for f in ${LIBM_CHECK}
	@@${ECHO_MSG} "===> checking for $f in libm"
	@@fgrep -wq $f ${WRKDIR}/.libm-list
.endfor
	@@touch $@@
@


1.1304
log
@for ports that have GH_PROJECT and GH_TAGNAME, populate DISTNAME automatically

looks ok to sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1303 2015/12/24 18:29:35 jasper Exp $
d788 1
a788 1
DISTNAME ?=	${GH_PROJECT}-${GH_TAGNAME}
@


1.1303
log
@remove commented link for pkg-config which is no longer relevant since
it moved to base long time ago
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1302 2015/11/18 16:37:31 sthen Exp $
d785 4
@


1.1302
log
@adjust format of INDEX in comment; distfiles-cdrom was removed
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1301 2015/11/07 09:54:46 espie Exp $
a2560 1
#	@@ln -s ${LOCALBASE}/bin/pkg-config ${WRKDIR}/bin
@


1.1301
log
@use -B in SUBST_CMD, so that relying on cvs updates modes is no longer
possible (requires explicit -m coming from FILESDIR)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1300 2015/10/18 14:05:05 naddy Exp $
d3067 1
a3067 1
#  for-arch|package-cdrom|package-ftp|distfiles-cdrom|distfiles-ftp
@


1.1300
log
@for decompressing .xz (.lzma) distfiles, switch to the simpler xzdec
(lzmadec) program; ok espie@@ sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1299 2015/10/16 20:07:39 naddy Exp $
d1046 1
a1046 1
.if ${FAKE_AS_ROOT:L} == "no"
d1048 2
a1049 1
.endif
d1059 2
@


1.1299
log
@Replace "decompressor file | ..." with "decompressor <file | ..."
to run the decompressors as pure filters that can potentially be
pledge(2)d down to "stdio".

Get rid of the useless and mostly unused GZCAT and GUNZIP_CMD
variables while there.

ok sthen@@ espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1298 2015/07/19 17:31:44 naddy Exp $
d1295 4
a1298 2
EXTRACT_CASES += *.tar.xz|*.tar.lzma) \
	xz -d <${FULLDISTDIR}/$$archive | ${TAR} xf -;;
@


1.1298
log
@pass PORTSDIR_PATH through to make-plist so it will be honored by
update-plist; ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1297 2015/06/11 09:26:01 espie Exp $
a1151 2
GUNZIP_CMD ?= /usr/bin/gunzip -f
GZCAT ?= /usr/bin/gzcat
d1296 1
a1296 1
	xzcat ${FULLDISTDIR}/$$archive| ${TAR} xf -;;
d1302 1
a1302 1
	lunzip -c ${FULLDISTDIR}/$$archive| ${TAR} xf -;;
d1304 1
a1304 1
	lunzip -c $$patchfile | ${PATCH} ${PATCH_DIST_ARGS};;
d1312 1
a1312 1
	${BZIP2} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf -;;
d1314 1
a1314 1
	${BZIP2} -dc $$patchfile | ${PATCH} ${PATCH_DIST_ARGS};;
d1323 1
a1323 1
	${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | ${_PERL_FIX_SHAR} | /bin/sh;;
d1327 1
a1327 1
	${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf -;;
d1329 1
a1329 1
	${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive >$$(basename $$archive .gz);;
d1331 1
a1331 1
	${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf -;;
d1334 1
a1334 1
	${GZCAT} $$patchfile | ${PATCH} ${PATCH_DIST_ARGS};;
@


1.1297
log
@save PKGPATHS in stride with PKGNAMES, to be used for quick introspection
purposes.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1296 2015/05/23 10:53:24 czarkoff Exp $
d2455 1
@


1.1296
log
@Set HOMEPAGE to https://github.com/${GH_ACCOUNT}/${GH_PROJECT} for ports that
use GH_* variables.

OK sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1295 2015/05/16 17:04:51 espie Exp $
d830 1
@


1.1295
log
@if the build-user of dpb can't get to bulk/update directories, it's
not really an issue. This is probably the issue aja saw earlier today,
and I just ran into it myself.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1294 2015/05/14 18:00:27 jasper Exp $
d1188 1
@


1.1294
log
@add PORTROACH_COMMENT, requested by sthen@@:
"For use when there's a specific reason why you have been slacking on the
update and want an easy place to make a note of it :-)"
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1293 2015/05/11 12:07:17 espie Exp $
d1981 1
a1981 1
	@@rm -f ${_BULK_COOKIE} ${_UPDATE_COOKIE${_S}} ${_FUPDATE_COOKIE${_S}}
@


1.1293
log
@move obsolete stuff check AFTER Makefile.inc and modules handling, so it
catches issues in there as well
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1292 2015/05/03 08:06:03 espie Exp $
d119 1
a119 1
	MAKEFILE_LIST
@


1.1292
log
@create "common" dirs using install -d and a knob for changing ownership
This should help people working on communalized machines (and also dpb
in round-robin mode).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1291 2015/04/27 12:52:01 espie Exp $
a27 14
.for v in PKGREPOSITORY PKGREPOSITORYBASE CDROM_PACKAGES FTP_PACKAGES \
	SED_PLIST IGNORE_FILES NO_REGRESS REGRESS_IS_INTERACTIVE REGRESS_DEPENDS \
	PERMIT_DISTFILES_CDROM
.  if defined($v)
ERRORS += "Fatal: Variable $v is obsolete, see bsd.port.mk(5)"
.  endif
.endfor

.for t in pre-fetch do-fetch post-fetch pre-package do-package post-package
.  if target($t)
ERRORS += "Fatal: you're not allowed to override $t"
.  endif
.endfor

d299 14
@


1.1291
log
@move the check for sudo to "just-in-time" when actually used, so that
we can build WITHOUT sudo.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1290 2015/04/22 07:07:19 zhuk Exp $
d944 6
d1694 1
a1694 1
_LOCK = echo "Locking $$lock (${BUILD_PKGPATH}) from $@@"; ${LOCK_CMD} ${LOCKDIR}/$$lock.lock ${BUILD_PKGPATH}
d1697 1
a1697 1
_LOCK = ${LOCK_CMD} ${LOCKDIR}/$$lock.lock ${BUILD_PKGPATH}
d1728 1
a1728 1
	mkdir -p ${_PACKAGE_CHECKSUM_DIR} && \
d1857 1
a1857 1
_register_plist = mkdir -p ${PLIST_DB:S/:/ /g} && ${_PERLSCRIPT}/register-plist ${PLIST_DB}
d1938 1
a1938 1
	@@mkdir -p ${@@D}
d1952 1
a1952 1
	@@mkdir -p ${@@D} ${_TMP_REPO}
d2121 1
d2187 1
d2553 1
d2951 1
a2951 1
	@@lock=${@@:T}.dist; ${_SIMPLE_LOCK}; mkdir -p ${@@:H}; \
d2986 1
a2986 1
	@@mkdir -p ${@@D}
d3478 2
a3479 1
	@@mkdir -p ${FULLDISTDIR}; cd ${FULLDISTDIR}; echo "cd ${FULLDISTDIR}"; \
@


1.1290
log
@Mark PKG_ARCH as indexed (i.e., MULTI_PACKAGE-specific) as it should be.
Tested in a bulk build by landry@@ - thanks!

okay espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1289 2015/04/05 13:32:16 sthen Exp $
d825 1
a825 1
_PACKAGE_COOKIE_DEPS=${_FAKE_COOKIE}
d900 1
a900 1
_FAKESUDO = ${SUDO}
d906 1
d2280 1
a2280 1
${WRKINST}/.saved_libs: ${_FAKE_COOKIE}
d2291 1
a2291 1
_internal-manpages-check: ${_FAKE_COOKIE}
d2437 1
a2437 1
_internal-plist _internal-update-plist: _internal-fake
d2528 8
a2544 5
	@@if [ x`SUDO_PORT_V1=ah ${SUDO} /bin/sh -c 'eval echo $${SUDO_PORT_V1}'` \
		!= xah ]; then \
			echo >&2 "Error: sudo does not let env variables through"; \
			exit 1; \
	fi
d2808 1
a2808 1
${_FAKE_COOKIE}: ${_BUILD_COOKIE}
@


1.1289
log
@Make it fatal to specify both GH_TAGNAME and GH_COMMIT, when this happens the
GH_COMMIT is quietly ignored. Problem noted by Adam Wolk, discussed with a few
in the room.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1288 2015/01/04 05:47:07 brad Exp $
d132 1
a132 1
	PKG_ARCH GH_ACCOUNT GH_COMMIT GH_PROJECT GH_TAGNAME PORTROACH \
d139 1
a139 1
	EPOCH REVISION STATIC_PLIST
@


1.1288
log
@garbage collect ELF_TOOLCHAIN
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1287 2014/12/13 11:08:15 espie Exp $
d1171 3
@


1.1287
log
@a few defined/empty clean-ups for regularity
- always add COPTS/CXXOPTS/CXXDIAGFLAGS. they're not defined, so what ?
the result is empty.
- always define WARNINGS and MODULES
- fix a small misoptimization after the recent DISTFILES handling cleanup
- regroup obsolete variables under a generic heading. bsd.port.mk(5) is
enough.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1286 2014/12/10 22:39:24 espie Exp $
d737 1
a737 1
MAKE_ENV += ELF_TOOLCHAIN=Yes COMPILER_VERSION=${COMPILER_VERSION} \
@


1.1286
log
@tweak the 'auto-detect archive types' checks.
The extra _USE_* variables are a remnant of the original code (with manual
checks), they're not really needed.

Reorg things to be simpler/more consistent: group PATCHFILES and EXTRACT_ONLY
together, activate BUILD_DEPENDS on simpler patterns.

Also, conform to more style, have PATCHFILES/SUPDISTFILES always defined,
and test on empty.

shown to naddy@@ and sthen@@, fixed a few issues, and passes a full bulk
build.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1285 2014/11/22 10:07:38 espie Exp $
d28 3
a30 1
.for v in PKGREPOSITORY PKGREPOSITORYBASE CDROM_PACKAGES FTP_PACKAGES SED_PLIST
d32 1
a32 9
ERRORS += "Fatal: Variable $v is obsolete, use PACKAGE_REPOSITORY instead."
.  endif
.endfor
.if defined(PERMIT_DISTFILES_CDROM)
ERRORS += "Fatal: Variable PERMIT_DISTFILES_CDROM is obsolete."
.endif
.for v in NO_REGRESS REGRESS_IS_INTERACTIVE REGRESS_DEPENDS
.  if defined($v)
ERRORS += "Fatal: $v has been replaced with ${v:S/REGRESS/TEST/}."
d304 2
a305 1
.if defined(MODULES)
a693 1
.if defined(COPTS)
a694 2
.endif
.if defined(CXXOPTS)
d696 2
a697 3
.endif
.if defined(WARNINGS) && ${WARNINGS:L} == "yes"
.  if defined(CDIAGFLAGS)
a698 2
.  endif
.  if defined(CXXDIAGFLAGS)
a699 1
.  endif
a1263 4
.if defined(IGNOREFILES)
ERRORS += "Fatal: don't use IGNOREFILES"
.endif

d2331 1
a2331 1
.  if ! defined(NO_CHECKSUM)
d2637 1
a2637 1
.  if target(do-distpatch) || target(post-distpatch) || defined(PATCHFILES)
@


1.1285
log
@tweak show*-size so that it doesn't need to run as root. If some dirs
are -rx, we change them back as a last resort. :-/
Okay sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1284 2014/11/03 16:35:05 espie Exp $
d1245 3
d1250 1
a1250 1
.  if defined($v)
d1266 4
d1284 1
a1284 19
# okay, time for some guess work
.if !empty(EXTRACT_ONLY:M*.zip)
_USE_ZIP ?= Yes
.endif
.if !empty(EXTRACT_ONLY:M*.tar.xz) || !empty(EXTRACT_ONLY:M*.tar.lzma)
_USE_XZ ?= Yes
.endif
.if !empty(EXTRACT_ONLY:M*.tar.lz)
_USE_LZIP ?= Yes
.endif
.if !empty(EXTRACT_ONLY:M*.tar.bz2) || !empty(EXTRACT_ONLY:M*.tbz2) || !empty(EXTRACT_ONLY:M*.tbz) || \
	(defined(PATCHFILES) && !empty(_LIST_PATCHFILES:M*.bz2))
_USE_BZIP2 ?= Yes
.endif
_USE_XZ ?= No
_USE_LZIP ?= No
_USE_ZIP ?= No
_USE_BZIP2 ?= No

d1287 1
a1287 1
_PERL_FIX_SHAR ?= perl -ne 'print if $$s || ($$s = m:^\#(\!\s*/bin/sh\s*| This is a shell archive):)'
d1290 10
a1299 1
.if ${_USE_XZ:L} != "no"
d1304 2
a1305 1
.if ${_USE_LZIP:L} != "no"
d1309 2
d1312 4
a1315 6
.if ${_USE_ZIP:L} != "no"
BUILD_DEPENDS += archivers/unzip
EXTRACT_CASES += *.zip) \
	${UNZIP} -oq ${FULLDISTDIR}/$$archive -d ${WRKDIR};;
.endif
.if ${_USE_BZIP2:L} != "no"
d1319 2
d1322 4
a1338 9
PATCH_CASES ?=
.if ${_USE_BZIP2:L} != "no"
PATCH_CASES += *.bz2) \
	${BZIP2} -dc $$patchfile | ${PATCH} ${PATCH_DIST_ARGS};;
.endif
.if ${_USE_LZIP:L} != "no"
PATCH_CASES += *.lz) \
	lunzip -c $$patchfile | ${PATCH} ${PATCH_DIST_ARGS};;
.endif
d2625 1
a2625 1
.  if defined(_LIST_PATCHFILES)
@


1.1284
log
@dump-vars MAKEFILE_LIST
(no synchronization issue, as it will simply not show up with old make)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1283 2014/09/16 19:10:54 espie Exp $
d3496 2
d3499 6
a3504 1
	@@-du -ks ${WRKDIR}
d3507 6
a3512 1
	@@-du -ks ${WRKINST}
@


1.1283
log
@FAKE_AS_ROOT=No as a default.

"just turn it on!" naddy@@

happy to oblige.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1282 2014/09/13 15:09:24 naddy Exp $
d138 2
a139 1
	PKG_ARCH GH_ACCOUNT GH_COMMIT GH_PROJECT GH_TAGNAME PORTROACH
@


1.1282
log
@add default support for extracting *.tar.lzma; ok juanfra@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1281 2014/09/09 09:34:04 espie Exp $
d909 1
a909 1
FAKE_AS_ROOT ?= Yes
@


1.1281
log
@force umask 022 in fake !sudo situations.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1280 2014/09/05 14:45:02 jasper Exp $
d1280 1
a1280 1
.if !empty(EXTRACT_ONLY:M*.tar.xz)
d1302 1
a1302 1
EXTRACT_CASES += *.tar.xz) \
@


1.1280
log
@PORTSCOUT -> PORTROACH
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1279 2014/09/03 09:05:25 espie Exp $
d2822 1
a2822 1
	@@if [ x`${_FAKESUDO} /bin/sh -c umask` != x022 ]; then \
d2854 1
a2854 1
	@@cd ${WRKBUILD} && exec ${_FAKESUDO} ${_SYSTRACE_CMD} \
@


1.1279
log
@fix FAKE_AS_ROOT=Yes... don't create links in that case.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1278 2014/09/02 14:26:39 jasper Exp $
d138 1
a138 1
	PKG_ARCH GH_ACCOUNT GH_COMMIT GH_PROJECT GH_TAGNAME PORTSCOUT
d149 1
a149 1
PORTSCOUT ?=
@


1.1278
log
@hookup PORTSCOUT

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1277 2014/08/11 11:34:42 sthen Exp $
d929 4
a933 1
_INSTALL ?= ${WRKDIR}/bin/install
d2566 1
a2566 3
.if ${FAKE_AS_ROOT:L} == "yes"
	@@ln -sf /usr/bin/install ${WRKDIR}/bin/install
.else
d2833 1
a2833 1
.if ${FAKE_AS_ROOT:L} == "no"
@


1.1277
log
@When copying pkg/README{,-*} from the port directory, pass -m to SUBST_CMD
to ensure that a sane file mode are set.

Also use SUBST_CMD -m for rc.d scripts (it wasn't available at the time the
current code using a separate chmod was written).

Discussed with espie, slight tweaks to previous diff to take _FAKESUDO into
account.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1276 2014/08/10 11:34:27 jasper Exp $
d138 1
a138 1
	PKG_ARCH GH_ACCOUNT GH_COMMIT GH_PROJECT GH_TAGNAME 
d149 1
@


1.1276
log
@fix path to install(1)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1275 2014/08/10 09:02:21 espie Exp $
d2867 1
a2867 1
		${_FAKESUDO} ${SUBST_CMD} ${_SHAREOWNGRP} -c ${PKGDIR}/README $$r; \
d2874 1
a2874 1
		${_FAKESUDO} ${SUBST_CMD${_s}} ${_SHAREOWNGRP} -c ${PKGDIR}/README${_s} $$r; \
d2883 1
a2883 2
			${_FAKESUDO} ${SUBST_CMD} ${_BINOWNGRP} -c $$i $$r; \
			${_FAKESUDO} chmod ${BINMODE} $$r; \
@


1.1275
log
@okay, SUBST_DATA/SUBST_PROGRAM/SUBST_MAN are always -c, so encode it as well
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1274 2014/08/10 08:59:48 espie Exp $
d2563 1
a2563 1
	@@ln -sf /usr/sbin/install ${WRKDIR}/bin/install
@


1.1274
log
@framework to allow fake as non-root, based on an idea and initial patch by
naddy.

Not turned on yet, as it involves a critical new file.

Basically:
- introduce new variations on SUBST cmds to install various files
- use pkg_subst -i in !root mode
- unhardcode install path where possible, to allow for an install-wrapper
that disregards owner/groups.
- do links during fake to disable chown/chgrp/install.

Extra tweak (always-wrap) to actually encode "perl ${PORTSDIR}/infra/bin/install-wrapper"  as an install script, required by a few ports that keep track of
the install script for later (eg., ruby, postgres).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1273 2014/07/23 10:19:08 espie Exp $
d1057 3
a1059 3
SUBST_PROGRAM = ${SUBST_CMD} ${_BINOWNGRP} -m ${BINMODE}
SUBST_DATA = ${SUBST_CMD} ${_SHAREOWNGRP} -m ${SHAREMODE}
SUBST_MAN = ${SUBST_CMD} ${_MANOWNGRP} -m ${MANMODE}
@


1.1273
log
@fix a remnant of MULTI_PACKAGES reorg, a few years ago: there's no reason
to count LIB_DEPENDS and WANTLIB in build-deps, only the actual subpackaged
version count (reminder: even single package ports are actually multi-packaged,
with SUBPACKAGE=-, hence we will count LIB_DEPENDS- and WANTLIB-).

This was actually a discrepancy between manual builds and dpb builds, as the
output of dump-vars won't show plain LIB_DEPENDS. This caused a bit of
confusion wrt multimedia/mlt. Hence the actual fix.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1272 2014/07/14 08:21:00 zhuk Exp $
d749 2
a750 1
	BINGRP=bin BINOWN=root BINMODE=555 NONBINMODE=444 DIRMODE=755 \
d752 1
a752 1
	MANGRP=bin MANOWN=root MANMODE=444
d908 23
d933 1
a933 1
	${INSTALL} ${INSTALL_COPY} ${INSTALL_STRIP} -o ${BINOWN} -g ${BINGRP} -m ${BINMODE}
d935 1
a935 1
	${INSTALL} ${INSTALL_COPY} -o ${BINOWN} -g ${BINGRP} -m ${BINMODE}
d937 1
a937 1
	${INSTALL} ${INSTALL_COPY} -o ${SHAREOWN} -g ${SHAREGRP} -m ${SHAREMODE}
d939 1
a939 1
	${INSTALL} ${INSTALL_COPY} -o ${MANOWN} -g ${MANGRP} -m ${MANMODE}
d942 1
a942 1
	${INSTALL} -d -o ${BINOWN} -g ${BINGRP} -m ${DIRMODE}
d946 1
a946 1
	${INSTALL} -d -o ${SHAREOWN} -g ${SHAREGRP} -m ${DIRMODE}
d948 1
a948 1
	${INSTALL} -d -o ${MANOWN} -g ${MANGRP} -m ${DIRMODE}
d1045 3
d1054 6
d1609 2
a1610 2
		INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
		ac_given_INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
d1616 2
a1617 2
FAKE_SETUP = TRUEPREFIX=${PREFIX} PREFIX=${WRKINST}${PREFIX} \
	${DESTDIRNAME}=${WRKINST}
d1972 1
a1972 1
		${SUDO} ${_PKG_CREATE} -DPORTSDIR="${PORTSDIR}" \
d1979 1
a1979 1
		${SUDO} chown $${mode} ${_PACKAGE_COOKIE${_S}}; then \
d1982 1
a1982 1
		${SUDO} rm -f $$tmp; \
d2292 1
a2292 1
	@@${SUDO} ${_CHECK_LIB_DEPENDS} -O $@@t && ${SUDO} mv $@@t $@@
d2304 1
a2304 1
		${SUDO} /usr/libexec/makewhatis -p . && \
d2461 1
a2461 1
	${SUDO} ${_PERLSCRIPT}/make-plist \
d2557 9
a2565 4
	@@ln -s ${LOCALBASE}/bin/ccache ${WRKDIR}/bin/gcc
	@@ln -s ${LOCALBASE}/bin/ccache ${WRKDIR}/bin/g++
	@@ln -s ${LOCALBASE}/bin/ccache ${WRKDIR}/bin/cc
	@@ln -s ${LOCALBASE}/bin/ccache ${WRKDIR}/bin/c++
d2820 2
a2821 2
	@@if [ x`${SUDO} /bin/sh -c umask` != x022 ]; then \
		echo >&2 "Error: your umask is \"`${SUDO} /bin/sh -c umask`"\".; \
d2824 5
a2828 1
	@@${SUDO} install -d -m 755 -o root -g wheel ${WRKINST}
d2830 6
a2835 1
		${SUDO} /usr/sbin/mtree -U -e -d -n -p ${WRKINST} >/dev/null
d2844 1
a2844 1
	@@${SUDO} ${_MAKE_COOKIE} ${_INSTALL_PRE_COOKIE}
d2852 1
a2852 1
	@@cd ${WRKBUILD} && exec ${SUDO} ${_SYSTRACE_CMD} \
d2867 1
a2867 1
		${SUDO} ${SUBST_CMD} -o ${SHAREOWN} -g ${SHAREGRP} -c ${PKGDIR}/README $$r; \
d2874 1
a2874 1
		${SUDO} ${SUBST_CMD${_s}} -o ${SHAREOWN} -g ${SHAREGRP} -c ${PKGDIR}/README${_s} $$r; \
d2883 2
a2884 2
			${SUDO} ${SUBST_CMD} -o ${BINOWN} -g ${BINGRP} -c $$i $$r; \
			${SUDO} chmod ${BINMODE} $$r; \
d2888 1
a2888 1
	@@${SUDO} ${_MAKE_COOKIE} $@@
d3005 1
a3005 1
	@@if cd ${WRKINST} 2>/dev/null; then ${SUDO} rm -rf ${WRKINST}; fi
@


1.1272
log
@Add TEST_ENV, working on same principle as TEST_FLAGS. Needed, e.g., when
we're not using g?make, like CMake+Ninja. Also helps to simplify some
do-test constructions, including upcoming multimedia/mlt.

Documentation bits to follow.

okay espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1271 2014/07/12 19:22:34 espie Exp $
d1517 2
a1518 2
_BUILDLIB_DEPENDS = ${LIB_DEPENDS}
_BUILDWANTLIB = ${WANTLIB}
@


1.1271
log
@prevent that specific fuckup, since sqlports will catch it...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1270 2014/07/12 17:35:32 espie Exp $
d820 2
a821 1
TEST_FLAGS ?=
d823 1
d830 1
a830 1
TEST_FLAGS += DISPLAY=${DISPLAY} XAUTHORITY=${XAUTHORITY}
d2759 1
a2759 1
		(exec; set +e; ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} \
@


1.1270
log
@support GH_* variables
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1269 2014/07/10 23:19:55 sthen Exp $
d1310 3
@


1.1269
log
@strip ^v from WRKDISTs when generated from a github tag name, ok dcoppa,
discussed with rpe "looks like a viable solution"

FreeBSD handles this differently as they use codeload.github.com rather
than github.com/.../archive/ URLs which seem to be structured differently
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1268 2014/07/09 10:28:42 robert Exp $
d138 1
a138 1
	PKG_ARCH
@


1.1268
log
@trailing whitespace cleanup
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1267 2014/07/09 10:27:11 robert Exp $
d789 1
a789 1
WRKDIST ?= ${WRKDIR}/${GH_PROJECT}-${GH_TAGNAME}
@


1.1267
log
@add support for fetching distfiles from github

the following variables can be used, all of them besides
GH_TAGNAME is mandatory

GH_TAGNAME ?=
GH_COMMIT ?=
GH_ACCOUNT ?=
GH_PROJECT ?=

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1266 2014/06/05 10:06:09 sthen Exp $
d85 1
a85 1
WRKDIR_LINKNAME ?= 
d114 1
a114 1
	MULTI_PACKAGES 
d116 1
a116 1
_ALL_VARIABLES_INDEXED = FULLPKGNAME RUN_DEPENDS LIB_DEPENDS IGNORE 
d216 1
a216 1
_PKG_ADD_LOCAL = PKG_PATH=${_PKG_REPO} ${_PKG_ADD} 
d579 1
a579 1
_DEPENDENCY_STACK ?= 
d820 1
a820 1
TEST_FLAGS ?= 
d1060 1
a1060 1
.else 
d1353 1
a1353 1
MISSING_FILES = 
d1406 1
a1406 1
.  if defined(BROKEN) 
d1417 1
a1417 1
IGNORE${SUBPACKAGE} ?= 
d1431 1
a1431 1
			${_PERLSCRIPT}/resolve-lib 
d1449 1
a1449 1
_check_error = 
d1827 1
a1827 1
_check_lib_depends = ${_CHECK_LIB_DEPENDS} 
d2469 1
a2469 1
_internal-package: 
d2473 1
a2473 1
.  if ${BULK_$p:L} == "yes" 
d3153 1
a3153 1
# - remove lib-depends-args if we're only scanning for common dirs in 
@


1.1266
log
@tweak the message used when a file is present in distinfo but not
DISTFILES/SUPDISTFILES; noticed by naddy, also discussed with (and this
diff from) espie
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1265 2014/04/25 15:28:52 espie Exp $
d782 11
d794 1
d1142 9
d1153 2
d1199 3
d1203 1
@


1.1265
log
@nope, the chosen file is intentionally the last file built during a normal
xenocara build, to prevent screw up.

Whine loudly for whatis.db, as things are normally built with current.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1264 2014/04/25 15:13:51 sthen Exp $
d2276 1
a2276 1
			echo 1>&2 "!!! File '$$i' not found in ${CHECKSUM_FILE}"; \
@


1.1264
log
@check for X11BASE/include/X11/X.h instead of X11BASE/man/mandoc.db, which
isn't yet in all package snapshots.  ok aja@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1263 2014/04/18 21:14:20 kili Exp $
d169 4
a172 1
.  if !exists(${X11BASE}/include/X11/X.h)
d174 1
@


1.1263
log
@Follow the makewhatis(8) switch (s/whatis\.db/mandoc\.db/).

ok espie@@, naddy said he did the same changes.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1262 2014/04/15 08:52:35 ajacoutot Exp $
d169 1
a169 1
.  if !exists(${X11BASE}/man/mandoc.db)
@


1.1262
log
@Add ^LOCALSTATEDIR to the default SUBST_VARS.

bulk testing by jasper@@ (thanks!)
ok for now espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1261 2014/04/08 13:29:34 espie Exp $
d169 1
a169 1
.  if !exists(${X11BASE}/man/whatis.db)
d2236 1
a2236 1
		cat whatis.db
@


1.1261
log
@makes it impossible to build ports if your sudo setup is incorrect, instead
of working haphazardly half the time.

NOTE: you *must* fix your sudoers for ports to keep working, make sure you
are able to pass thru SUDO_PORT_V1 ! (and the rest that's already there)

okay matthieu@@, sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1260 2014/04/01 18:41:33 jasper Exp $
d949 1
a949 1
	^RCDIR
@


1.1260
log
@this easter egg wasn't supposed to go in (yet)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1258 2014/03/09 21:40:57 ajacoutot Exp $
d2479 5
@


1.1259
log
@switch over port to MODGNOME_TOOLS that didnt have it yet
@
text
@a40 5
.for t in pre-regress do-regress post-regress
.  if target($t)
ERRORS += "Fatal: $t has been replaced with ${t:S/regress/test/}."
.  endif
.endfor
@


1.1258
log
@Add an intermediate variable because some tools like python to not
properly parse variables with trailing spaces and add a bogus "" argument.

input/ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1257 2014/03/09 20:03:27 espie Exp $
d39 5
@


1.1257
log
@- replace `` with $$() in most places.
stylistically, I tend to prefer ``, but since we use a lot of fragments,
the parenthetical nature of $() is better.
- give a more complete name to portstree-/inst-  depends lists, so that several
"make package" can run in the same cache.
- create temp dependency files atomically by using mktemp/chmod/mv
(global cache)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1256 2014/02/11 10:34:34 espie Exp $
d385 9
a393 3
CONFIGURE_ENV += LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}" ${_lt_libs}
MAKE_ENV += LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}" ${_lt_libs}
MAKE_FLAGS += LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}" ${_lt_libs}
@


1.1256
log
@cosmetic: print-package-signature -> print-update-signature

(to be referenced by documentation, to stop confusing crypto signatures
with other signatures).

(old name kept over release, to be scraped completely afterwards, user-visible
change only)

okay sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1255 2014/01/09 10:44:33 espie Exp $
d1253 1
a1253 1
	${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive >`basename $$archive .gz`;;
d1661 1
a1661 1
		>${_PACKAGE_CHECKSUM_DIR}/`basename $$pkgname .tgz`.sha256
d1706 1
a1706 1
	if set -- `eval $$toset exec ${MAKE} _print-metadata`; then \
d1720 1
a1720 1
		stem=`echo $$default|${_version2stem}`; \
d1733 2
d1738 6
a1743 2
		if ! eval $$toset ${MAKE} print-plist-libs >$$cached_libs; \
		then \
d1895 2
a1896 2
	if deps=`SUBPACKAGE=${_S} wantlib_args=${_pkg_wantlib_args} \
			${MAKE} print-package-args` && \
d1903 1
a1903 1
		mode=`id -u`:`id -g` && \
d1944 2
a1945 2
	@@b=`cd ${.CURDIR} && SUBPACKAGE=${_S} ${MAKE} print-plist|sed -ne '/^@@pkgpath /s,,-e ,p'`; \
	a=`${PKG_INFO} -e ${FULLPKGPATH${_S}} $$b 2>/dev/null |sort -u`; \
d2068 1
a2068 1
				if `${PKG_INFO} -e "$$pkg" -r "$$pkg" $$default >$@@t`; then \
d2281 2
a2282 1
			set -- `grep -i "^$$cipher ($$file)" ${CHECKSUM_FILE}` && break || \
d2370 1
a2370 1
_extra_info += DEPPATHS${_s}="`${SETENV} FLAVOR=${FLAVOR:Q} SUBPACKAGE=${_s} PKGPATH=${PKGPATH} ${MAKE} show-run-depends ${_do_libs_too}`"
d2384 2
a2385 2
	OWNER=`id -u` \
	GROUP=`id -g` \
d3134 2
a3135 2
	a=$${_DEPENDS_CACHE}/portstree${SUBPACKAGE}; \
	b=$${_DEPENDS_CACHE}/inst${SUBPACKAGE}; \
d3146 1
@


1.1255
log
@pass -DSIGNER thru from SIGNING_PARAMETERS to pkg_add.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1254 2014/01/07 10:39:17 espie Exp $
d3068 1
a3068 1
print-package-signature:
@


1.1254
log
@record history
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1253 2013/12/30 12:33:07 espie Exp $
d218 2
@


1.1253
log
@new internal _PKG_ADD_LOCAL, that's stricly used to add packages built on
*this* machine.
Visible: SIGNING_PARAMETERS. Set for signing every package on the fly.
(if SIGNING_PARAMETERS is not empty, don't wave -Dunsigned)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1252 2013/12/07 15:41:47 espie Exp $
d507 3
@


1.1252
log
@fix initial size match for DIST_SUBDIRS
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1251 2013/12/02 21:47:37 espie Exp $
d211 2
a212 1
_PKG_CREATE = ${PKG_CREATE} ${_PROGRESS}
d215 6
d1920 1
a1920 1
		${SUDO} ${SETENV} ${_TERM_ENV} PKG_PATH=${_PKG_REPO} ${_PKG_ADD} ${_PKG_ADD_AUTO} ${PKGFILE${_S}}; \
d1941 1
a1941 1
		   ${SUDO} ${SETENV} PKG_PATH=${_PKG_REPO} PKG_TMPDIR=${PKG_TMPDIR} ${_PKG_ADD} ${_PKG_ADD_AUTO} -r ${_PKG_ADD_FORCE} ${PKGFILE${_S}};; \
d1956 1
a1956 1
	@@${SUDO} ${SETENV} ${_TERM_ENV} PKG_PATH=${_PKG_REPO} ${_PKG_ADD} ${_PKG_ADD_AUTO} -r ${_PKG_ADD_FORCE} ${PKGFILE${_S}}
@


1.1251
log
@zap extra experiment, noticed by rpe@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1250 2013/12/02 08:23:16 espie Exp $
d2849 1
a2849 1
				ck=`${_size_fragment} $$file $f`; \
d2858 2
a2859 2
					if grep -q "SIZE ($f)" ${CHECKSUM_FILE}; then \
						${ECHO_MSG} ">> Size does not match for $f"; \
d2862 1
a2862 1
						${ECHO_MSG} ">> No size recorded for $f"; \
@


1.1250
log
@adjust distfiles handling to allow for filename{url}sufx
to become
filenamesufx (stored name)
urlsufx (fetched url)

to be documented

okay sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1249 2013/11/30 16:06:56 espie Exp $
d1170 1
a1170 1
_LIST_$v += $f$r
@


1.1249
log
@add "show-prepare-test-results" target, to be used by dpb for running tests
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1248 2013/11/25 14:13:33 sthen Exp $
d1160 1
a1160 1
.      for f m u in ${e:C/:[0-9]$//:C/\{.*\}$//} MASTER_SITES${e:M*\:[0-9]:C/.*:([0-9])/\1/} ${e:C/:[0-9]$//:C/.*\{(.*)\}$/\1/}
d1170 1
a1170 1
_LIST_$v += $f
@


1.1248
log
@Remove support for VMEM_WARNING, as it's manually "maintained" it isn't
very accurate, and isn't sensitive to differences between arches.
ok ajacoutot dcoppa zhuk espie
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1247 2013/11/07 01:23:19 juanfra Exp $
d2113 3
@


1.1247
log
@Add lzip support to the ports framework.

ok espie@@ sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1246 2013/11/03 15:45:00 espie Exp $
d138 1
a138 1
	VMEM_WARNING PKG_ARCH 
a1528 2
VMEM_WARNING ?= No

a2649 13
.  if ${VMEM_WARNING:L} == "yes"
	@@echo ""; \
	echo "*** WARNING: you may see an error such as"; \
	echo "***       virtual memory exhausted"; \
	echo "*** when building this package.  If you do you must increase"; \
	echo "*** your limits.  See the man page for your shell and look"; \
	echo "*** for the 'limit' or 'ulimit' command. You may also want to"; \
	echo "*** see the login.conf(5) manual page."; \
	echo "*** Some examples are: "; \
	echo "*** 	csh(1) and tcsh(1): limit datasize <kbytes of memory>"; \
	echo "***	ksh(1), zsh(1) and bash(1): ulimit -d <kbytes of memory>"; \
	echo ""
.  endif
@


1.1246
log
@fix some subtle case of BULK=auto (for instance, non-regression tests in
lang/icon/interp): needs more information than just "we're solving deps"
to know whether to clean things or not.

-> similar problems as locking oneself, similar solution, replace
_SOLVING_DEP with _DEPENDENCY_STACK that tracks the dependencies.

okay mbalmer^Waja
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1245 2013/08/07 07:20:24 espie Exp $
d1195 3
d1203 1
d1217 5
d1249 4
@


1.1245
log
@turn on TRUST_PACKAGES by default, zap knob
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1244 2013/07/09 19:48:56 espie Exp $
d557 1
a557 1
_SOLVING_DEP ?= No
d935 1
a935 1
.if ${_SOLVING_DEP:L} != "no"
d2030 1
a2030 4
		case X"$$dir" in \
			X${PKGPATH}) toset="$$toset _SOLVING_DEP=self";; \
			*) toset="$$toset _SOLVING_DEP=Yes";; \
		esac; \
d2401 7
a2407 1
.if ${BULK_${PKGPATH}:L} == "yes" || (${BULK_${PKGPATH}:L} == "auto" && ${_SOLVING_DEP:L} == "yes")
d2409 4
a2412 1
.endif
@


1.1244
log
@vax does not have all libm functions (yet), don't waste time building
stuff that will not link anyways.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1243 2013/07/08 18:37:18 landry Exp $
a79 1
TRUST_PACKAGES ?= No
a1898 1
.  if ${TRUST_PACKAGES:L} == "yes"
a1903 3
.  else
	@@${SUDO} ${SETENV} ${_TERM_ENV} PKG_PATH=${_PKG_REPO} ${_PKG_ADD} ${_PKG_ADD_AUTO} ${PKGFILE${_S}}
.  endif
@


1.1243
log
@Doh, fix typo.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1242 2013/07/08 18:27:30 landry Exp $
d1498 5
d2099 8
@


1.1242
log
@Restore previous behaviour wrt PKG_CREATE_NO_CHECKS. Keep it to 'no' by
default (for production/bulks), setting it to 'yes' disables the check
as it was before (for slow archs), and setting it to 'warn' will now
show the differences between wantlib lists, but as a warning and not an
error (which was the behaviour introduced in previous commit for 'yes'
case)
ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1241 2013/07/08 12:45:56 espie Exp $
d1379 1
a1379 1
.elif ${PKG_CREATE_CHECKS:L} == "warn"
@


1.1241
log
@tweak PKG_CREATE_NO_CHECKS: the check is always useful and
inexpensive, so do it anyway. PKG_CREATE_NO_CHECKS=Yes turns
it into a warning.

Test bunny landry@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1240 2013/07/05 21:48:01 espie Exp $
d1378 3
d1385 1
d1862 1
a1862 1
	if deps=`SUBPACKAGE=${_S} wantlib_args=wantlib-args \
@


1.1240
log
@no longer depend upon base's elf toolchain
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1239 2013/07/04 08:04:04 jasper Exp $
d1378 7
a1384 3
_pkg_wantlib_args = fake-wantlib-args
.else
_pkg_wantlib_args = wantlib-args
d1858 1
a1858 1
	if deps=`SUBPACKAGE=${_S} wantlib_args=${_pkg_wantlib_args} \
d3101 1
a3101 1
		if cmp -s $$a $$b; \
d3103 1
a3103 3
			cat $$a; \
		else \
			echo 1>&2 "Error: Libraries in packing-lists in the ports tree"; \
d3105 1
a3105 2
			diff 1>&2 -u $$a $$b; \
			exit 1; \
d3107 1
@


1.1239
log
@if LOCALBASE isn't the default /usr/local, pass -L to pkg_add so we can still
install packages with 'make install'

w/ and ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1238 2013/06/25 20:21:03 espie Exp $
d726 1
a726 1
MAKE_ENV += ELF_TOOLCHAIN=${ELF_TOOLCHAIN} COMPILER_VERSION=${COMPILER_VERSION} \
a1755 3
.  if ${ELF_TOOLCHAIN:L} == "no"
_CHECK_LIB_DEPENDS += -o
.  endif
@


1.1238
log
@okay, remove dumb optimization
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1237 2013/06/25 19:47:49 espie Exp $
d396 3
@


1.1237
log
@document the reason why fetch should see everything
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1236 2013/06/25 08:46:55 espie Exp $
a119 1
_DPB_MULTI = ${BUILD_PACKAGES}
a126 2
# XXX don't let extra subpackage disappear for fetch, as this could be mirror
_DPB_MULTI = ${MULTI_PACKAGES}
a145 1
_DPB_MULTI = ${MULTI_PACKAGES}
d1769 1
a1769 1
.if ${_DPB_MULTI} == "-"
d1787 1
a1787 1
.  for _S in ${_DPB_MULTI}
@


1.1236
log
@dpb still needs MULTI_PACKAGES
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1235 2013/06/21 12:28:54 espie Exp $
d128 1
@


1.1235
log
@introduce a VARBASE, so that all 3 directories where package install stuff
(/etc, /usr/local, /var) can be overridden eventually
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1234 2013/06/21 12:27:32 espie Exp $
d114 2
a115 1
	SUBPACKAGE FLAVOR BUILD_PACKAGES DPB_PROPERTIES
d141 1
a141 1
	VMEM_WARNING MULTI_PACKAGES PKG_ARCH 
@


1.1234
log
@expose FAKE_SETUP so that modules that want to do their own
"do-install" can do so in a proper way.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1232 2013/06/15 19:45:11 espie Exp $
d159 1
d356 1
a356 1
BASELOCALSTATEDIR ?= /var
@


1.1233
log
@somehow, I forgot to dump-vars PREFIX
@
text
@d1504 1
a1504 1
_FAKE_SETUP = TRUEPREFIX=${PREFIX} PREFIX=${WRKINST}${PREFIX} \
d2707 1
a2707 1
	@@${_SUDOMAKESYS} pre-fake ${_FAKE_SETUP}
d2711 1
a2711 1
	@@${_SUDOMAKESYS} pre-install ${_FAKE_SETUP}
d2714 1
a2714 1
	@@${_SUDOMAKESYS} do-install ${_FAKE_SETUP}
d2718 1
a2718 1
		${SETENV} ${MAKE_ENV} ${_FAKE_SETUP} \
d2723 1
a2723 1
	@@${_SUDOMAKESYS} post-install ${_FAKE_SETUP}
d2726 1
a2726 1
	@@${_SUDOMAKESYS} _hook-post-install ${_FAKE_SETUP}
@


1.1232
log
@revert work-around, USE CURRENT SHELL!!
(fix message thinkos noticed by naddy@@)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1231 2013/06/13 18:13:54 espie Exp $
d144 1
a144 1
	ONLY_FOR_ARCHS NOT_FOR_ARCHS PKGSPEC \
@


1.1231
log
@work around what's probably a bug in our ksh in sh mode.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1230 2013/06/11 10:59:24 espie Exp $
d1611 1
a1611 1
	trap 'if $$locked; then ${_UNLOCK}; locked=false; fi; exit 1' 1 2 3 13 15
d2837 1
a2837 1
						${ECHO_MSG} ">> Size does not match for $$file"; \
d2840 1
a2840 1
						${ECHO_MSG} ">> No size recorded for $$file"; \
@


1.1230
log
@cater to weird posix semantics. Check that we generated both wantlib files
before comparing them. In case there's a former error, there's no point
in adding to the confusion by having diff chime in one of the files doesn't
exist.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1229 2013/06/10 15:43:04 espie Exp $
d1611 1
a1611 1
	trap 'exit 1' 1 2 3 13 15
@


1.1229
log
@work-around should no longer be necessary...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1228 2013/06/04 19:35:04 naddy Exp $
d3095 1
a3095 1
	cd ${.CURDIR} && \
d3097 10
a3106 4
	${MAKE} fake-wantlib-args >$$b; \
	if cmp -s $$a $$b; \
	then \
		cat $$a; \
a3107 3
		echo 1>&2 "Error: Libraries in packing-lists in the ports tree"; \
		echo 1>&2 "       and libraries from installed packages don't match"; \
		diff 1>&2 -u $$a $$b; \
@


1.1228
log
@remove the nagging about xz being unavailable on vax, which has accomplished
exactly nothing in two years; requested by many
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1227 2013/05/27 16:06:51 espie Exp $
a52 4

.if !defined(PIE_ARCH)
PIE_ARCH = alpha amd64 hppa mips64 mips64el sh sparc64
.endif
@


1.1227
log
@I could swear I committed this already: have DPB in-synch with future dpb
work.

also, warn for MASTER_SITES that don't end with /, as this is usually
an issue (but not always), as discussed with rpe@@

In case successful fetch yields wrong size, always remove the partial for
later MASTER_SITES to pick it up, the 'cute' code that keeps partials over
30K is not really all that useful...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1226 2013/05/21 12:38:06 ajacoutot Exp $
a2439 5
.if ${_USE_XZ:L} != "no" && ${SHARED_ONLY:L} != "yes"
	@@echo ""; \
	echo "*** WARNING: this port uses xz distfiles: it will not build on vax."; \
	echo ""
.endif
@


1.1226
log
@Allow /usr/ports to be a symlink without the need to set PORTSDIR.
chromium was one of the ports that failed to build without PORTSDIR
being set and /usr/ports being a symlink -- but this is not the case
anymore.
If any other port fails because of this, I'll fix it.

ok espie@@ todd@@ sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1225 2013/05/15 16:32:16 sthen Exp $
d111 1
a111 1
DPB ?= All Fetch
d125 1
a125 1
.if ${DPB:L:Mfetch}
d133 3
d139 2
a140 3
	TEST_DEPENDS USE_GMAKE USE_GROFF MODULES FLAVORS \
	NO_BUILD NO_TEST SHARED_ONLY PSEUDO_FLAVORS \
	TEST_IS_INTERACTIVE \
d1121 5
d1128 3
d1958 1
d2213 1
d2847 1
a2847 1
						test `{ wc -c "$$file" 2>/dev/null || echo 0 ; }| awk '{print $$1}'` -lt 30000 && rm -f $$file; \
@


1.1225
log
@Move the recently-added -C from the hardcoded arguments passed to FETCH_CMD,
to the user-definable FETCH_CMD variable itself, allowing this to be used with
curl again (FETCH_CMD = /usr/local/bin/curl -C -) for those that need/want it
(e.g. some less common cases with proxies, or for better https support).
"go ahead" espie@@, makes sense to naddy.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1224 2013/05/14 13:38:59 gsoares Exp $
a2403 5
	@@if test -h ${PORTSDIR}; then \
		echo 1>&2 "Fatal: ${PORTSDIR} is a symlink."; \
		echo 1>&2 "Please point PORTSDIR to the real directory (in /etc/mk.conf)"; \
		exit 1; \
	fi
@


1.1224
log
@zap whitespace
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1223 2013/05/08 08:38:36 espie Exp $
d205 1
a205 1
FETCH_CMD ?= /usr/bin/ftp -V ${_PROGRESS} -k ${FTP_KEEPALIVE}
d2828 1
a2828 1
		if ${FETCH_CMD} -C -o $$file $${site}$u; then \
@


1.1223
log
@revisit old codes, rewrite DISTFILES handling using
.for v1 v2 in list
techniques, which make it clearer.

Add new syntax to distfiles, which is not painful to do now, and support it
for dpb fetch as well: a distfile can now be file{url} to specify a different
result from the url (this allows really weird naming scheme on http sites
to give us consistent files, which has become a nagging problem).

This still doesn't mean you shouldn't encourage upstream to do the right thing
and provide nice archive urls.

extend the fetch process in bsd.port.mk to work more like dpb does, namely
download to intermediate "part" files that don't vanish and use -C if
necessary.

Both those mean that FETCH_CMD has to work like ftp, including the -C and
-o support...

discussed with various people.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1222 2013/04/08 16:45:06 espie Exp $
d204 1
a204 1
 
@


1.1222
log
@work around bob
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1221 2013/04/01 13:11:34 espie Exp $
a1118 4
# _SITE_SELECTOR chooses the value of sites based on select.
_SITE_SELECTOR = case $$select in


a1125 3
_SITE_SELECTOR += *:${_I}) sites="${MASTER_SITES${_I}}";;
.  else
_SITE_SELECTOR += *:${_I}) echo >&2 "Error: MASTER_SITES${_I} not defined";;
a1127 1
_SITE_SELECTOR += *) sites="${MASTER_SITES}";; esac
d1149 18
a1166 17
_EVERYTHING = ${DISTFILES}
_DISTFILES = ${DISTFILES:C/:[0-9]$//}

.if defined(PATCHFILES)
_PATCHFILES = ${PATCHFILES:C/:[0-9]$//}
_EVERYTHING += ${PATCHFILES}
.endif

.if defined(SUPDISTFILES)
_EVERYTHING += ${SUPDISTFILES}
.endif

__CKSUMFILES =
# First, remove duplicates
.for _file in ${_DISTFILES} ${_PATCHFILES}
.  if empty(__CKSUMFILES:M${_file})
__CKSUMFILES += ${_file}
d1170 2
a1171 23
# List of all files, with ${DIST_SUBDIR} in front.  Used for checksum.
.if !empty(DIST_SUBDIR)
CHECKSUMFILES = ${__CKSUMFILES:S/^/${DIST_SUBDIR}\//}
.else
CHECKSUMFILES = ${__CKSUMFILES}
.endif

__MKSUMFILES = ${__CKSUMFILES}
.if defined(SUPDISTFILES)
# First, remove duplicates
.  for _file in ${SUPDISTFILES:C/:[0-9]$//}
.    if empty(__MKSUMFILES:M${_file})
__MKSUMFILES += ${_file}
.    endif
.  endfor
.endif

# List of all files, with ${DIST_SUBDIR} in front.  Used for makesum.
.if !empty(DIST_SUBDIR)
MAKESUMFILES = ${__MKSUMFILES:S/^/${DIST_SUBDIR}\//}
.else
MAKESUMFILES = ${__MKSUMFILES}
.endif
d1178 2
a1179 2
#  by user.
EXTRACT_ONLY ?= ${_DISTFILES}
d1189 1
a1189 1
	(defined(PATCHFILES) && !empty(_PATCHFILES:M*.bz2))
d1636 1
a1636 2
_size_fragment = wc -c $$file 2>/dev/null| \
	awk '{print "SIZE (" $$2 ") = " $$1}'
d1953 1
a1953 1
			${_size_fragment} >> ${CHECKSUM_FILE}; \
d2489 1
a2489 1
.  if defined(_PATCHFILES)
d2492 1
a2492 1
	  for patchfile in ${_PATCHFILES}; do \
d2809 2
a2810 2
.for _F in ${MAKESUMFILES:S@@^@@${DISTDIR}/@@}
${_F}:
d2820 4
a2823 5
	@@lock=${_F:T}.dist; ${_SIMPLE_LOCK}; mkdir -p ${_F:H}; \
	cd ${_F:H}; \
	test -f ${_F:T} && exit 0; \
	select='${_EVERYTHING:M*${_F:S@@^${FULLDISTDIR}/@@@@}\:[0-9]}'; \
	f=${_F:S@@^${FULLDISTDIR}/@@@@}; \
d2825 5
a2829 6
	${_SITE_SELECTOR}; \
	for site in $$sites; do \
		${ECHO_MSG} ">> Fetch $${site}$$f"; \
		if ${FETCH_CMD} $${site}$$f; then \
				file=${_F:S@@^${DISTDIR}/@@@@}; \
				ck=`cd ${DISTDIR} && ${_size_fragment}`; \
d2832 1
d2835 1
d2838 2
a2839 2
					if grep -q "SIZE ($$file)" ${CHECKSUM_FILE}; then \
						${ECHO_MSG} ">> Size does not match for ${_F}"; \
d2842 2
a2843 1
						${ECHO_MSG} ">> No size recorded for ${_F}"; \
@


1.1221
log
@make the distinfo check silent, for ports without distfiles (and no distinfo
either)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1220 2013/03/21 08:28:33 ajacoutot Exp $
d53 4
@


1.1220
log
@Change USE_LIBTOOL default from No to Yes.
libtool(1) is part of the base system now so it does not add any
dependency. Also it is a good way to not miss ports using their own
bundled libtool.

discussed with and ok jasper@@ landry@@ espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1219 2013/03/20 10:48:00 espie Exp $
d2227 2
a2228 1
	@@fgrep SIZE ${CHECKSUM_FILE} | sed -e '/SIZE (\(.*\)).*/s//\1/'|\
@


1.1219
log
@redo the PERMIT_PACKAGE_CDROM -> PERMIT_PACKAGE_FTP in a slightly more
paranoid way for multi-packages.
Specifically, do the implication separately for each multi-packages, so
if you set e.g.,
PERMIT_PACKAGE_CDROM-foo = no
then you *don't* inherit a PERMIT_PACKAGE_FTP = Yes into
PERMIT_PACKAGE_FTP-foo

(also default *first* to a restrictive PERMIT_PACKAGE_FTP for
PERMIT_PACKAGE_FTP-foo  before copying a PERMIT_PACKAGE_CDROM-foo=Yes)

as a consequence, check that PERMIT_* is correctly setup for each
subpackage of MULTI_PACKAGES
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1218 2013/03/17 10:35:05 espie Exp $
d366 1
a366 1
USE_LIBTOOL ?= No
@


1.1218
log
@aggressively refuse ports which didn't see the recent changes
move PERMIT_* settings after modules and arch support, so we can
access MULTI_PACKAGES better.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1217 2013/03/12 06:56:27 ajacoutot Exp $
d414 14
d438 4
a443 1
_BAD_LICENSING = Yes
d447 4
d804 2
a805 2
.  for _v in PKG_ARCH PERMIT_PACKAGE_FTP PERMIT_PACKAGE_CDROM \
	RUN_DEPENDS WANTLIB LIB_DEPENDS PREFIX CATEGORIES STATIC_PLIST
@


1.1217
log
@check -> test

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1216 2013/03/10 22:27:15 espie Exp $
d33 9
a224 19

.if defined(PERMIT_PACKAGE_CDROM) && ${PERMIT_PACKAGE_CDROM:L} == "yes"
PERMIT_PACKAGE_FTP ?= Yes
PERMIT_DISTFILES_FTP ?= Yes
.elif defined(PERMIT_PACKAGE_FTP) && ${PERMIT_PACKAGE_FTP:L} == "yes"
PERMIT_DISTFILES_FTP ?= Yes
.endif

.if !defined(PERMIT_PACKAGE_CDROM) || !defined(PERMIT_PACKAGE_FTP) || \
	!defined(PERMIT_DISTFILES_FTP)
ERRORS += "The licensing info for ${FULLPKGNAME} is incomplete."
ERRORS += "Please notify the OpenBSD port maintainer:"
ERRORS += "    ${MAINTAINER}"
_BAD_LICENSING = Yes
PERMIT_PACKAGE_CDROM = No
PERMIT_PACKAGE_FTP = No
PERMIT_DISTFILES_FTP = No
.endif

a273 1
NO_REGRESS ?= No
d304 1
d414 18
d2655 1
a2655 1
	@@${ECHO_MSG} "===>  Regression check for ${FULLPKGNAME}${_MASTER}"
d2685 1
a2685 1
	@@echo 1>&2 "No regression test for ${FULLPKGNAME}"
d3179 1
a3179 1
# recursively build a list of dirs for package regression, ready for tsort
@


1.1216
log
@rename REGRESS -> TEST
shorter, less ambiguous (as discussed with some porters)
there will be a sweep to fix all regress.

keep "make regress" as an alias for "make test".
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1215 2013/03/09 00:09:14 espie Exp $
d2677 1
a2677 1
	@@echo 1>&2 "No regression check for ${FULLPKGNAME}"
@


1.1215
log
@simplify PERMIT_*:
- if PERMIT_PACKAGE_CDROM == Yes, have
PERMIT_PACKAGE_FTP and PERMIT_DISTFILES_FTP default to Yes
- if PERMIT_PACKAGE_FTP == Yes, have
PERMIT_DISTFILES_FTP default to Yes.

okay sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1214 2013/03/08 10:06:13 espie Exp $
d123 3
a125 3
	REGRESS_DEPENDS USE_GMAKE USE_GROFF MODULES FLAVORS \
	NO_BUILD NO_REGRESS SHARED_ONLY PSEUDO_FLAVORS \
	REGRESS_IS_INTERACTIVE \
d283 1
d443 2
a444 2
.if !empty(FLAVORS:Mregress) && empty(FLAVOR:Mregress)
NO_REGRESS = Yes
d609 1
a609 1
_REGRESS_COOKIE =		${WRKBUILD}/.regress_done
d613 1
a613 1
_REGRESS_COOKIE =		${WRKDIR}/.regress_done
d617 1
a617 1
	${_INSTALL_PRE_COOKIE} ${_BUILD_COOKIE} ${_REGRESS_COOKIE} \
d621 1
a621 1
	${_DEPRUN_COOKIES} ${_DEPREGRESS_COOKIES} ${_UPDATE_COOKIES} \
d753 5
a757 5
REGRESS_TARGET ?= regress
REGRESS_FLAGS ?= 
ALL_REGRESS_FLAGS = ${MAKE_FLAGS} ${REGRESS_FLAGS}
REGRESS_LOGFILE ?= ${WRKDIR}/regress.log
REGRESS_LOG ?= | tee ${REGRESS_LOGFILE}
d759 1
a759 1
REGRESS_IS_INTERACTIVE ?= No
d761 2
a762 2
.if ${REGRESS_IS_INTERACTIVE:L} == "x11"
REGRESS_FLAGS += DISPLAY=${DISPLAY} XAUTHORITY=${XAUTHORITY}
d1305 5
a1309 5
_IGNORE_REGRESS ?=
.if ${REGRESS_IS_INTERACTIVE:L} != "no" && defined(BATCH)
_IGNORE_REGRESS += "has interactive tests"
.elif ${REGRESS_IS_INTERACTIVE:L} == "no" && defined(INTERACTIVE)
_IGNORE_REGRESS += "does not have interactive tests"
d1401 1
a1401 1
.for _v in BUILD LIB RUN REGRESS
d1417 1
a1417 1
.for _v in BUILD LIB RUN REGRESS
d1420 1
a1420 1
.for _v in BUILD REGRESS
d1461 1
a1461 1
_REGRESS_DEPLIST = ${REGRESS_DEPENDS}
d1466 1
a1466 1
_DEPLIST = ${_BUILD_DEPLIST} ${_RUN_DEPLIST} ${_REGRESS_DEPLIST} \
d1470 1
a1470 1
.for _DEP in BUILD RUN BUILDLIB RUNLIB REGRESS
d1512 2
a1513 2
_REGRESS_DEP2 = ${REGRESS_DEPENDS:${_mod}}
_REGRESS_DEP3 = ${_REGRESS_DEP2}
d1561 1
a1561 1
_REGRESS_DEP = ${_REGRESS_DEP2:C,^[^:/]*:,,}
d1973 1
a1973 1
	_internal-runwantlib-depends _internal-regress-depends
d2083 1
a2083 1
_internal-regress-depends: ${_DEPREGRESS_COOKIES}
d2144 1
a2144 1
	_internal-package _internal-patch _internal-plist _internal-regress \
d2286 1
d2288 2
a2289 2
.  if !empty(_IGNORE_REGRESS)
_internal-regress:
d2291 1
a2291 1
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} ${_IGNORE_REGRESS}."
d2294 1
a2294 1
_internal-regress: ${_BUILD_COOKIE} ${_DEPREGRESS_COOKIES} ${_REGRESS_COOKIE}
d2349 2
a2350 2
	subupdate fetch fetch-all checksum regress prepare \
	depends lib-depends build-depends run-depends regress-depends \
d2645 2
a2646 2
${_REGRESS_COOKIE}: ${_BUILD_COOKIE}
.if ${NO_REGRESS:L} == "no"
d2649 1
a2649 1
.  if ${REGRESS_IS_INTERACTIVE:L} == "x11"
d2658 2
a2659 2
.  if target(pre-regress)
	@@${_MAKE} pre-regress
d2661 1
a2661 1
.  if target(do-regress)
d2663 2
a2664 2
		(exec; set +e; PKGPATH=${PKGPATH} ${MAKE} do-regress; \
		echo $$? >&4) 2>&1 ${REGRESS_LOG}`
d2666 1
a2666 1
# What REGRESS normally does:
d2669 3
a2671 3
		${ALL_REGRESS_FLAGS} -f ${MAKE_FILE} ${REGRESS_TARGET}; \
		echo $$? >&4) 2>&1 ${REGRESS_LOG}`
# End of REGRESS
d2673 2
a2674 2
.  if target(post-regress)
	@@${_MAKE} post-regress
d2987 2
a2988 2
# full-build-depends, full-all-depends, full-run-depends full-regress-depends
.for _i in build all run regress
d3018 2
a3019 2
# run-depends-list, build-depends-list, lib-depends-list, regress-depends-list
.for _i in RUN BUILD LIB REGRESS
d3172 2
a3173 2
_recurse-regress-dir-depends:
.for _dir in ${_REGRESS_DEP}
d3186 2
a3187 2
regress-dir-depends:
.if !empty(_REGRESS_DEP)
d3191 1
a3191 1
		self=${_FULLPKGPATH} PKGPATH=${PKGPATH} ${MAKE} _recurse-regress-dir-depends; \
d3376 1
a3376 1
	_internal-regress _internal-regress-depends _internal-run-depends \
d3382 1
a3382 1
	_recurse-regress-dir-depends _recurse-run-dir-depends _refetch \
d3385 1
a3385 1
	do-extract do-install do-regress fetch-all \
d3389 2
a3390 2
	post-patch post-regress pre-build pre-configure pre-extract pre-fake \
	pre-install pre-patch pre-regress prepare \
d3392 1
a3392 1
	regress-depends regress-depends-list run-depends run-depends-list \
@


1.1214
log
@bye bye PERMIT_DISTFILES_CDROM
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1213 2013/03/02 13:08:49 espie Exp $
d215 7
@


1.1213
log
@minor tweaks:
- make sure PKGDIR exists prior to making READMES, allows using update-plist
before creating DESCR and stuff
- list-distinfo target, to allow dpb to fetch stuff non locally eventually
- zap addsum
- check that all files in distinfo are actually accounted for in DISTFILES
and SUPDISTFILES
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1210 2013/02/10 13:42:38 sthen Exp $
d117 1
a117 1
	PERMIT_DISTFILES_CDROM PERMIT_DISTFILES_FTP
d218 1
a218 1
	!defined(PERMIT_DISTFILES_CDROM) || !defined(PERMIT_DISTFILES_FTP)
a223 1
PERMIT_DISTFILES_CDROM = No
a2951 5
	@@echo -n "y|"
.    else
	@@echo -n "n|"
.    endif
.    if ${PERMIT_DISTFILES_CDROM:L} == "yes"
@


1.1212
log
@give a clue to clueless people

okay sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1211 2013/02/11 14:31:14 jasper Exp $
d1947 2
a1948 16

addsum: fetch-all
.if !defined(NO_CHECKSUM)
	@@touch ${CHECKSUM_FILE}
	@@cd ${DISTDIR} && \
	 	for cipher in ${_CIPHERS}; do \
			cksum -b -a $$cipher ${MAKESUMFILES} >> ${CHECKSUM_FILE}; \
	    done
	@@cd ${DISTDIR} && \
		for file in ${MAKESUMFILES}; do \
			${_size_fragment} >> ${CHECKSUM_FILE}; \
		done
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE}
	@@if [ `sed -e 's/\=.*$$//' ${CHECKSUM_FILE} | uniq -d | wc -l` -ne 0 ]; then \
		echo "Inconsistent checksum in ${CHECKSUM_FILE}"; \
		exit 1; \
d1950 4
a1953 1
		${ECHO_MSG} "${CHECKSUM_FILE} updated okay, don't forget to remove cruft"; \
d1955 1
a1955 1
.endif
d2191 16
d2732 1
d3379 1
a3379 1
	_recurse-regress-dir-depends _recurse-run-dir-depends _refetch addsum \
@


1.1211
log
@- deal with ports that have STATIC_PLIST=no in print-plist-all, this unbreaks
check-conflicts -p.

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1210 2013/02/10 13:42:38 sthen Exp $
d2387 2
a2388 1
		echo 1>&2 "Fatal: ${PORTSDIR} is a symlink. Please set to the real directory"; \
@


1.1210
log
@change NO_ARCH default to ${MACHINE_ARCH}/no-arch, discussed with espie & naddy
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1209 2013/02/05 11:22:50 espie Exp $
d2758 6
a2763 2
	@@${ECHO_MSG} "===> ${FULLPKGNAME${_S}}"
	@@${_PKG_CREATE} -n -q ${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}}
@


1.1209
log
@restore read-only behavior: only clean stuff that exists.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1208 2013/02/04 20:44:41 espie Exp $
d783 1
a783 1
NO_ARCH ?= no-arch
@


1.1208
log
@surprisingly some targets still have problems with pseudo-flavors
problem noticed by naddy@@, turns out the *-dir-depends targets should use
build stuff preferentially...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1207 2013/02/02 13:23:24 espie Exp $
d2859 1
a2859 1
	@@rm -rf $l
@


1.1207
log
@zap duplicate line spotted by naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1206 2013/02/02 12:29:20 espie Exp $
d820 1
d829 1
d3149 3
a3151 3
	if ! fgrep -q -e "r|${FULLPKGPATH}|" -e "a|${FULLPKGPATH}" $${_DEPENDS_FILE}; then \
		echo "r|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${FULLPKGPATH} PKGPATH=${PKGPATH} ${MAKE} _recurse-run-dir-depends; \
d3154 1
a3154 1
	@@echo "${FULLPKGPATH} ${FULLPKGPATH}"
d3175 3
a3177 3
	if ! fgrep -q -e "R|${FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "R|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${FULLPKGPATH} PKGPATH=${PKGPATH} ${MAKE} _recurse-regress-dir-depends; \
d3180 1
a3180 1
	@@echo "${FULLPKGPATH} ${FULLPKGPATH}"
d3217 3
a3219 3
	if ! fgrep -q -e "b|${FULLPKGPATH}|" -e "a|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "b|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${FULLPKGPATH} PKGPATH=${PKGPATH} ${MAKE} _build-dir-depends; \
d3222 1
a3222 1
	@@echo "${FULLPKGPATH} ${FULLPKGPATH}"
d3228 3
a3230 3
	if ! fgrep -q "|${FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${FULLPKGPATH} PKGPATH=${PKGPATH} ${MAKE} _recurse-all-dir-depends; \
d3233 1
a3233 1
	@@echo "${FULLPKGPATH} ${FULLPKGPATH}"
d3252 1
a3252 1
	echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
@


1.1206
log
@add proper support for mfs builds, namely WRKOBJDIR_MFS and friends
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1204 2013/01/19 11:34:11 espie Exp $
a172 1
WRKOBJDIR_${PKGPATH} ?= ${WRKOBJDIR}
@


1.1205
log
@fix ALL_FAKE_FLAGS to not contain -jN twice
@
text
@d79 8
d93 1
d168 5
d175 1
d704 1
a704 1
OLD_WRKDIR_NAME = w-${PKGNAME}
d706 1
a706 1
OLD_WRKDIR_NAME = w-${PKGNAME}${_FLAVOR_EXT2}
d709 4
d714 4
a717 5
.  if ${SEPARATE_BUILD:L:Mflavored}
WRKDIR ?= ${WRKOBJDIR_${PKGPATH}}/${PKGNAME}
.  else
WRKDIR ?= ${WRKOBJDIR_${PKGPATH}}/${PKGNAME}${_FLAVOR_EXT2}
.  endif
d2855 6
a2860 2
	@@if [ -L ${WRKDIR} ]; then rm -rf `readlink ${WRKDIR}`; fi
	@@rm -rf ${WRKDIR}
@


1.1204
log
@zap :L for clean like we did for flavors. Same argument applies.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1203 2013/01/07 17:46:14 espie Exp $
d382 1
a382 1
ALL_FAKE_FLAGS=	${MAKE_FLAGS} ${DESTDIRNAME}=${WRKINST} ${FAKE_FLAGS}
@


1.1203
log
@don't bother outputting empty but defined variables.
this trims 1/3 of the lines from a dump-vars output...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1202 2013/01/06 11:57:21 espie Exp $
d231 1
a231 1
.if empty(_clean) || ${_clean:L} == "depends"
d234 1
a234 1
.if ${_clean:L:Mall}
d240 1
a240 1
.if ${_clean:L:Mwork} || ${_clean:L:Mbuild}
d243 1
a243 1
.if ${_clean:L:Mforce}
d249 1
a249 1
.for _w in ${_clean:L}
d2820 1
a2820 1
.if ${_clean:L:Mdepends} && ${_CLEANDEPENDS:L} == "yes"
d2827 1
a2827 1
.if ${_clean:L:Mfake}
d2830 2
a2831 2
.if ${_clean:L:Mwork} || (${_clean:L:Mbuild} && ${SEPARATE_BUILD:L} == "no")
.  if ${_clean:L:Mflavors}
d2842 1
a2842 1
.elif ${_clean:L:Mbuild} && ${SEPARATE_BUILD:L} != "no"
d2845 1
a2845 1
.if ${_clean:L:Mdist}
d2854 2
a2855 2
.if ${_clean:L:Minstall}
.  if ${_clean:L:Msub}
d2861 1
a2861 1
.if ${_clean:L:Mpackages} || ${_clean:L:Mpackage} && ${_clean:L:Msub}
d2863 1
a2863 1
.elif ${_clean:L:Mpackage}
d2866 1
a2866 1
.if ${_clean:L:Mbulk}
d2869 1
a2869 1
.if ${_clean:L:Mplist}
@


1.1202
log
@allow unlock to be called with SUBDIR=
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1201 2012/12/31 09:14:07 espie Exp $
d1733 40
a3327 39

dump-vars:
.if ${_DPB_MULTI} == "-"
.  for _v in ${_ALL_VARIABLES} ${_ALL_VARIABLES_INDEXED}
.   if defined(${_v}-)
	@@echo ${FULLPKGPATH}.${_v}=${${_v}-:Q}
.   elif defined(${_v})
	@@echo ${FULLPKGPATH}.${_v}=${${_v}:Q}
.   endif
.  endfor
.  for _v in ${_ALL_VARIABLES_PER_ARCH}
.    for _a in ${ALL_ARCHS}
.      if defined(${_v}-${_a})
	@@echo ${FULLPKGPATH}.${_v}-${_a}=${${_v}-${_a}:Q}
.      endif
.    endfor
.  endfor
.else
.  for _S in ${_DPB_MULTI}
.    for _v in ${_ALL_VARIABLES}
.     if defined(${_v})
	@@echo ${FULLPKGPATH${_S}}.${_v}=${${_v}:Q}
.     endif
.    endfor
.    for _v in ${_ALL_VARIABLES_PER_ARCH}
.      for _a in ${ALL_ARCHS}
.        if defined(${_v}-${_a})
	@@echo ${FULLPKGPATH${_S}}.${_v}-${_a}=${${_v}-${_a}:Q}
.        endif
.      endfor
.    endfor
.    for _v in ${_ALL_VARIABLES_INDEXED}
.      if defined(${_v}${_S})
	@@echo ${FULLPKGPATH${_S}}.${_v}=${${_v}${_S}:Q}
.      endif
.    endfor
.  endfor
.endif

@


1.1201
log
@following landry's suggestion, add module hooks for post-install

I'm not too happy about stuff that will remove .la automatically though,
seems to me this shouldn't be generated in the first place.

ETOOMUCHMAGIC ?
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1200 2012/12/30 20:40:40 espie Exp $
a3355 1
	lock unlock \
@


1.1200
log
@forgot to GC this along with the imake weirdness.

seen by landry@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1199 2012/11/27 11:35:57 espie Exp $
d303 1
a303 1
.for _t in post-patch pre-configure configure pre-fake
d2608 8
a2629 1

d2649 3
d3330 1
a3330 1
	_build-dir-depends \
@


1.1199
log
@be a bit more specific in _SOLVING_DEP, so that ports that regress-depend
on themselves won't clean themselves when BULK=Auto.
problem reported by sthen@@, okay sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1198 2012/11/19 14:19:35 espie Exp $
d303 1
a303 1
.for _t in post-patch pre-configure configure pre-fake pre-install
@


1.1198
log
@fix reverted lock logic. From Vadim Zhukov.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1197 2012/11/19 12:24:50 espie Exp $
d877 1
a877 1
.if ${_SOLVING_DEP:L} == "yes"
a1955 1
		toset="$$toset _SOLVING_DEP=Yes"; \
d1957 4
@


1.1197
log
@add a new value for BULK and use it as default:
BULK=auto  will invoke bulk behavior on dependencies, but not during
normal build.
(internally, deps have _SOLVING_DEP=yes, so we can distinguish them)

okay ajacoutot@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1196 2012/11/19 12:19:30 espie Exp $
d1557 2
a1559 2
.  else
_LOCKNAME = ${FULLPKGNAME}
@


1.1196
log
@remove some old cruft
checked by naddy@@ for no incidence on current builds
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1195 2012/11/05 20:29:35 espie Exp $
d75 1
a75 1
BULK ?= No
d2301 1
a2301 1
.if ${BULK_${PKGPATH}:L} == "yes"
@


1.1195
log
@waive the other xenocara check if we're building it, as noticed by naddy.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1194 2012/11/03 09:40:05 espie Exp $
a1811 7
.  for _m in ${MODULES:T:U}
.    if defined(MOD${_m}_pre-install)
	@@${MOD${_m}_pre-install}
.    elif defined(MOD${_m}_pre_install)
	@@${MOD${_m}_pre_install}
.    endif
.  endfor
@


1.1194
log
@determine the xenocara makefile name directly, as it is inconvenient
to do if you're not sure you have the right WRKSRC.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1193 2012/11/01 09:58:53 espie Exp $
d2335 1
d2341 1
@


1.1193
log
@fix base/xenocara location
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1192 2012/10/29 22:27:05 espie Exp $
a636 1
MAKE_FILE ?= Makefile
d715 10
a999 1
XENOCARA_COMPONENT ?= No
@


1.1192
log
@add a bit of experimental scaffolding to build xenocara from ports
- resurrect USE_X11 in a smart way: auto-determine it correctly from
WANTLIBS (accounts for most ports)
- define a BUILD_XENOCARA knob that builds fake based on mtree for
X11BASE.
- if BUILD_XENOCARA_TOO=Yes, prepare to hook to a xenocara "fake" meta
package.

All of this off by default, the xenocara shadow tree is not in yet
anyways. Zero impact on regular builds.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1191 2012/10/11 08:07:10 espie Exp $
d1421 1
a1421 1
BUILD_DEPENDS += xenocara/meta
@


1.1191
log
@optimize a bit for dpb: remove extra variables we don't ever use
in "pure dpb mode", only write out variables for BUILD_PACKAGES, not
MULTI. This should reduce the number of pkgpaths generated, among other
things.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1190 2012/09/24 15:49:00 espie Exp $
d146 6
a151 1
.if !exists(${X11BASE}/man/whatis.db)
d153 1
d991 1
d993 4
d998 1
d1407 16
@


1.1190
log
@fix typo
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1189 2012/09/22 19:00:04 espie Exp $
d96 1
a96 2
	SUBPACKAGE MULTI_PACKAGES FLAVOR BUILD_PACKAGES \
	DPB_PROPERTIES
d98 1
a98 2
_ALL_VARIABLES_INDEXED = FULLPKGNAME RUN_DEPENDS LIB_DEPENDS \
	PKG_ARCH IGNORE 
d101 2
d109 1
d120 1
a120 1
	VMEM_WARNING
d127 1
d3246 1
a3246 1
.if ${MULTI_PACKAGES} == "-"
d3262 1
a3262 1
.  for _S in ${MULTI_PACKAGES}
@


1.1189
log
@some more data for dpb, special for naddy's killer box.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1188 2012/08/31 16:48:26 espie Exp $
d97 1
a97 1
	DPB_PROPERTIES \
@


1.1188
log
@go back partially on SUBST_CMD: keep the SUBST_CMD-sub stuff, but
have a "default" SUBST_CMD that will substitute the non-subpackage version
of the variables.

SUBST_CMD = ${SUBST_CMD${SUBPACKAGE}}
is a bad idea, because SUBPACKAGE may vary in unexpected ways, like you
get the 'default' value when building manually, and you might get a
different subpackage when building with dpb, leading to weird errors.

So, old users/users during patch/configure/build can use base SUBST_CMD
without much surprise.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1187 2012/08/19 22:30:36 ajacoutot Exp $
d92 1
d96 2
a97 1
	SUBPACKAGE MULTI_PACKAGES FLAVOR
@


1.1187
log
@RCS id cleanup; also add OpenBSD RCS Id where missing...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1186 2012/08/19 10:36:35 espie Exp $
d909 5
a913 1
SUBST_CMD = ${SUBST_CMD${SUBPACKAGE}}
@


1.1186
log
@well, another error...
@
text
@d3 1
a3 3
#	$OpenBSD: bsd.port.mk,v 1.1185 2012/08/18 07:58:20 espie Exp $
#	$FreeBSD: bsd.port.mk,v 1.264 1996/12/25 02:27:44 imp Exp $
#	$NetBSD: bsd.port.mk,v 1.62 1998/04/09 12:47:02 hubertf Exp $
@


1.1185
log
@slow architectures might clean /tmp too eagerly, move the default
LOCKDIR to a local location that's less susceptible to surreptitious
cleanup, that is under WRKOBJDIR

after discussion with sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1184 2012/08/17 22:32:29 espie Exp $
d2174 1
a2174 1
_internal-update-or-install: ${_FUPDATE_COOKIE${SUBPACKAGE}
@


1.1184
log
@fix subpackage bugs.
- correct syntax for variable (Vadim Zhukov)
- both _DO_LOCK and _cache_fragment want to use traps.
Since that's the only place where the problem occurs, simply put the second
trap in a subshell...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1183 2012/08/04 14:23:30 espie Exp $
d1500 1
@


1.1183
log
@- make SUBST_CMD be subpackage dependent, fixes substitution problems in
README-sub (as noticed by aja@@)
- stronger checks for X correctly installed: don't ignore ports if X11
is not there, error out right away. Make sure /usr/local/lib/X11/app-defaults
is a link, and that whatis.db is there (as should be fixed  by release in
xenocara)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1182 2012/07/10 12:04:25 naddy Exp $
d2261 1
a2261 1
	@@${_DO_LOCK}; ${_cache_fragment}; cd ${.CURDIR} && ${MAKE} _internal-subpackage
d2671 1
a2671 1
_internal-subpackage: ${_PACKAGE_COOKIES${SUBPACKAGE}
@


1.1182
log
@Remove message digest algorithms other than SHA-256 for checksumming
distfiles.  MD5 is known to be insecure and RIPEMD-160 and SHA-1
are considered inferior to SHA-256.

Also, the concatenation of different hashes is not more secure than
its strongest component; see Antoine Joux, "Multicollisions in
iterated hash functions. Application to cascased constructions"
http://www.iacr.org/cryptodb/archive/2004/CRYPTO/1472/1472.pdf

Discussed with many, ok sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1181 2012/07/06 12:00:52 espie Exp $
d144 4
d890 1
a890 1
PKG_ARGS${_S} += -D${_v}=${${_v:S/^^//}${_S}:Q}
d893 1
a893 1
PKG_ARGS${_S} += -D${_v}=${${_v:S/^^//}:Q}
d898 1
a907 1
.endfor
d909 1
a909 3
SUBST_CMD = ${_PERLSCRIPT}/pkg_subst
.for _v in ${SUBST_VARS}
SUBST_CMD += -D${_v}=${${_v:S/^^//}:Q}
d911 1
a1268 4
.if !exists(${X11BASE})
IGNORE += "building ports requires X11 but ${X11BASE} not found"
.endif

d2292 5
d2612 1
a2612 1
		${SUDO} ${SUBST_CMD} -o ${SHAREOWN} -g ${SHAREGRP} -c ${PKGDIR}/README${_s} $$r; \
@


1.1181
log
@prepare for new pkg_add switch
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1180 2012/06/20 13:26:17 espie Exp $
d600 1
a600 1
_CIPHERS = sha256 sha1 rmd160 md5
@


1.1180
log
@allow users to say MESSAGE-main=
to have empty messages, useful in a multi-package context
(as noticed by aja@@)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1179 2012/06/19 16:43:47 espie Exp $
d175 1
a175 1
_PKG_ADD = ${PKG_ADD} ${_PROGRESS}
@


1.1179
log
@switch to libtool from src, since it will now be in the snaps.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1178 2012/06/18 12:15:52 espie Exp $
d983 1
a983 1
.  if defined(MESSAGE${_S})
d986 1
a986 1
.  if defined(UNMESSAGE${_S})
@


1.1178
log
@handle the very special case of ports-readmes, after discussion with
landry, sthen
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1177 2012/06/15 10:31:52 espie Exp $
d350 1
a350 1
LIBTOOL ?= ${PORTSDIR}/infrastructure/bin/libtool
@


1.1177
log
@fix sig for LIB_DEPENDS
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1176 2012/06/14 13:34:24 espie Exp $
d125 1
a125 1
	EPOCH REVISION
d728 1
d731 1
a731 1
	RUN_DEPENDS WANTLIB LIB_DEPENDS PREFIX CATEGORIES
d1680 7
d1742 1
a1742 1
		${_register_plist} $$tmp && \
@


1.1176
log
@match src/ change.
*keep ports and src in synch* or out-of-date won't work at all.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1175 2012/06/09 21:14:43 espie Exp $
d3001 1
a3001 1
			echo "$$default"; \
@


1.1175
log
@Use :Q, it will quote a lot more in a correct way.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1174 2012/06/08 23:51:21 sthen Exp $
d2993 1
a2993 1
		echo "$$default"; \
@


1.1174
log
@quote the permit_cdrom and permit_ftp variables used in the new checksum
code, as they can contain spaces.  ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1173 2012/06/08 15:17:02 espie Exp $
d1728 1
a1728 1
	tmp=${_TMP_REPO}${_PKGFILE${_S}} pkgname=${_PKGFILE${_S}} permit_ftp="${PERMIT_PACKAGE_FTP${_S}:L}" permit_cdrom="${PERMIT_PACKAGE_CDROM${_S}:L}" && \
@


1.1173
log
@typo
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1172 2012/06/08 14:46:54 espie Exp $
d1728 1
a1728 1
	tmp=${_TMP_REPO}${_PKGFILE${_S}} pkgname=${_PKGFILE${_S}} permit_ftp=${PERMIT_PACKAGE_FTP${_S}:L} permit_cdrom=${PERMIT_PACKAGE_CDROM${_S}:L} && \
@


1.1172
log
@add support for sha256 packages as they're built.
after discussion with aja@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1171 2012/05/28 09:54:18 espie Exp $
d1553 1
a1553 1
.elif ${CHECKSUM_PACKAGE:L} == "cdrom"
@


1.1171
log
@this is tricky enough to warrant an actual comment
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1170 2012/05/28 09:38:04 espie Exp $
d1537 25
d1728 1
a1728 1
	tmp=${_TMP_REPO}${_PKGFILE${_S}} && \
d1735 1
@


1.1170
log
@zap old readmes infrastructure, replaced by new age databases/ports-readmes
which is ways more accurate anyways.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1169 2012/05/26 12:04:35 espie Exp $
d2900 4
a2903 3
# remove lib-depends-args if we're only scanning for common dirs in update-plist
# and we're not shared only
no-lib-depends-args:
a2961 2

no-wantlib-args:
@


1.1169
log
@make it possible for print-plist-with-depends to control lib-depends entirely
(useful for future update-plist)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1168 2012/05/16 06:36:56 jasper Exp $
a139 1
TEMPLATES ?= ${PORTSDIR}/infrastructure/templates
d236 1
a236 1
	readmes bulk force plist build all
a493 2
_READMES =

a514 1
_READMES += ${READMES_TOP}/${PKGPATH}/${FULLPKGNAME}.html
a544 1
_READMES += ${READMES_TOP}/${PKGPATH}/${FULLPKGNAME${_s}}.html
a1494 2
README_NAME ?= ${TEMPLATES}/README.port

a2736 3
.if ${_clean:L:Mreadmes}
	rm -f ${_READMES}
.endif
a2806 57
readme:
	@@tmpdir=`mktemp -d ${TMPDIR}/readme.XXXXXX`; \
	trap "rm -r $$tmpdir" 0; \
	trap 'exit 1' 1 2 3 13 15; \
	cd ${.CURDIR} && PKGPATH=${PKGPATH} ${MAKE} TMPDIR=$$tmpdir README_NAME=${README_NAME} \
		${READMES_TOP}/${PKGPATH}/${FULLPKGNAME${SUBPACKAGE}}.html

readmes:
	@@tmpdir=`mktemp -d ${TMPDIR}/readme.XXXXXX`; \
	trap "rm -r $$tmpdir" 0; \
	trap 'exit 1' 1 2 3 13 15; \
	cd ${.CURDIR} && PKGPATH=${PKGPATH} ${MAKE} TMPDIR=$$tmpdir README_NAME=${README_NAME} \
		${_READMES}

.for _S in ${MULTI_PACKAGES}
${READMES_TOP}/${PKGPATH}/${FULLPKGNAME${_S}}.html:
	@@mkdir -p ${@@D}
	@@echo ${_COMMENT${_S}:Q} | ${HTMLIFY} >${TMPDIR}/comment${_S}
	@@echo ${FULLPKGNAME${_S}} | ${HTMLIFY} > ${TMPDIR}/pkgname${_S}
.  if defined(HOMEPAGE)
	@@echo 'See <a href="${HOMEPAGE}">${HOMEPAGE}</a> for details.' >${TMPDIR}/home${_S}
.  else
	@@echo "" >${TMPDIR}/home${_S}
.  endif
.  if ${MULTI_PACKAGES} != "-"
	@@echo "<h2>Part of a Multi-Package set</h2>" >${TMPDIR}/subpackages${_S}
	@@echo "<ul>" >>${TMPDIR}/subpackages${_S}
.    for _T in ${MULTI_PACKAGES}
	@@echo "<li><a href=\"${FULLPKGNAME${_T}}.html\">${FULLPKGNAME${_T}}</a>" >>${TMPDIR}/subpackages${_S}
.    endfor
	@@echo "</ul>" >>${TMPDIR}/subpackages${_S}
.  else
	@@>${TMPDIR}/subpackages${_S}
.  endif
.  for _I in build run
.    if !empty(_${_I:U}_DEP)
	@@cd ${.CURDIR} && SUBPACKAGE=${_S} PKGPATH=${PKGPATH} ${MAKE} full-${_I}-depends _FULL_PACKAGE_NAME=Yes| \
		while read n; do \
			j=`dirname $$n|${HTMLIFY}`; k=`basename $$n|${HTMLIFY}`; \
			echo "<li><a href=\"${PKGDEPTH}$$j/$$k.html\">$$k</a>"; \
		 done  >${TMPDIR}/${_I}${_S}
.    else
	@@echo "<li>none" >${TMPDIR}/${_I}${_S}
.    endif
.  endfor
	@@sed -e 's|%%PORT%%|'"`echo ${FULLPKGPATH${_S}}  | ${HTMLIFY}`"'|g' \
		-e '/%%PKG%%/r${TMPDIR}/pkgname${_S}' -e '//d' \
		-e '/%%COMMENT%%/r${TMPDIR}/comment${_S}' -e '//d' \
		-e '/%%DESCR%%/r${DESCR${_S}}' -e '//d' \
		-e '/%%HOMEPAGE%%/r${TMPDIR}/home${_S}' -e '//d' \
		-e '/%%BUILD_DEPENDS%%/r${TMPDIR}/build${_S}' -e '//d' \
		-e '/%%RUN_DEPENDS%%/r${TMPDIR}/run${_S}' -e '//d' \
		-e '/%%SUBPACKAGES%%/r${TMPDIR}/subpackages${_S}' -e '//d' \
		${README_NAME} > $@@
	@@rm -f ${TMPDIR}/*${_S}
.endfor

d3265 1
a3265 1
	print-build-depends print-run-depends readme readmes rebuild \
@


1.1168
log
@don't append ccache to BUILD_DEPENDS if NO_BUILD is set to Yes

ok sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1167 2012/05/08 17:38:21 jasper Exp $
d2967 5
d3337 1
a3337 1
	port-wantlib-args fake-wantlib-args no-wantlib-args \
@


1.1167
log
@"fix" a line which emacs loudly complains about...

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1166 2012/05/07 21:11:43 halex Exp $
d361 1
a361 1
.if ${USE_CCACHE:L} == "yes" && ${NO_CCACHE:L} == "no"
@


1.1166
log
@call exit 1 after cleanup in signal traps, or the shell keeps running after
SIGINT and friends

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1165 2012/04/28 10:50:35 ajacoutot Exp $
d1642 1
a1642 1
 	done; ${_list_system_libs}; }
@


1.1165
log
@Set localstatedir (i.e. BASELOCALSTATEDIR) to /var by default if
CONFIGURE_STYLE is gnu.
Works the same way as SYSCONFDIR, one can append a subdirectory to
change the default localstatedir by using the following construct in the
port Makefile:
LOCALSTATEDIR=	${BASELOCALSTATEDIR}/foobar

Note that this variable in not substituted in PLIST.

bulk tested by landry (on a previous diff)
ok jasper@@ sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1164 2012/04/22 10:39:48 espie Exp $
d1536 3
a1538 1
	${_LOCK}; locked=true; trap 'if $$locked; then ${_UNLOCK}; locked=false; fi' 0 1 2 3 13 15
d2819 2
a2820 1
	trap "rm -r $$tmpdir" 0 1 2 3 13 15; \
d2826 2
a2827 1
	trap "rm -r $$tmpdir" 0 1 2 3 13 15; \
@


1.1164
log
@dump-vars should show VMEM_WARNING
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1163 2012/04/17 09:31:47 espie Exp $
d329 5
@


1.1163
log
@handle modbuild (perl module) stuff similarly to what gnu does.
there's no actual reason not to do it.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1162 2012/04/16 09:21:39 espie Exp $
d118 2
a119 1
	MAINTAINER AUTOCONF_VERSION AUTOMAKE_VERSION CONFIGURE_ARGS
@


1.1162
log
@strip PORTSDIR (or equivalent) from DESCR the same way we compute PKGPATH.

avoids random changes of INDEX depending on where the ports tree is installed
and configured.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1161 2012/03/22 14:08:50 espie Exp $
d258 6
@


1.1161
log
@error out if PORTSDIR is not set to the real directory.
There are at least two or three ports that don't like symlinks. ;/
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1160 2012/02/23 08:32:17 espie Exp $
d2761 1
a2761 1
		echo -n "${DESCR${_S}:S,^${PORTSDIR}/,,}|"; \
@


1.1160
log
@give FULLPKGPATH in warning message. Redundant, but may be useful for multi.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1159 2012/02/17 07:33:04 espie Exp $
d2248 4
@


1.1159
log
@scrap old fetch targets
add a warning when LIB_DEPENDS doesn't register (for sthen@@)
tweak FLAVOR message for consistency
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1158 2012/01/29 11:29:51 espie Exp $
d1604 1
a1604 1
_warn_if_shared = echo "LIB_DEPENDS $$d not needed ?" 1>&2
@


1.1158
log
@PKGFILES, why not ?
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1157 2012/01/28 08:39:40 espie Exp $
d467 2
a468 1
ERRORS += "Fatal: no flavors for this port."
d1601 6
a2739 86
# mirroring utilities
fetch-makefile:
	@@mk=`mktemp ${TMPDIR}/mk.XXXXXXX`; \
	trap "rm -f $$mk" 0 1 2 3 13 15; \
	if PKGPATH=${PKGPATH} ${MAKE} _fetch-makefile >$$mk; then \
		cat $$mk >>${_FETCH_MAKEFILE}; \
	else \
		echo >&2 "Problem in ${PKGPATH}"; \
	fi

mirror-maker-fetch:
	@@mk=`mktemp ${TMPDIR}/mk.XXXXXXXX`; \
	PKGPATH=${PKGPATH} ${MAKE} fetch-makefile >$$mk; \
	echo "Check and remove $$mk"; \
	cd ${DISTDIR} && \
		${MAKE} -f $$mk all FETCH=${_SHSCRIPT}/fetch-all

_fetch-makefile:
.if !defined(COMES_WITH)
	@@echo -n "all"
.  if ${PERMIT_DISTFILES_FTP:L} == "yes"
	@@echo -n " ftp"
.  endif
.  if ${PERMIT_DISTFILES_CDROM:L} == "yes"
	@@echo -n " cdrom"
.  endif
	@@echo ": ${_FETCH_MAKEFILE_NAMES}"
# write generic package dependencies
	@@echo ".PHONY: ${_FETCH_MAKEFILE_NAMES}"
.  if ${RECURSIVE_FETCH_LIST:L} == "yes"
	@@echo "${_FETCH_MAKEFILE_NAMES}: ${MAKESUMFILES} "`_FULL_PACKAGE_NAME=Yes PKGPATH=${PKGPATH} ${MAKE} full-all-depends|fgrep -v ${PKGPATH}/`
.  else
	@@echo "${_FETCH_MAKEFILE_NAMES}: ${MAKESUMFILES}"
.  endif
.endif
.if !empty(MAKESUMFILES)
.  for _F in ${MAKESUMFILES}
	@@: $${_DONE_FILES:=/dev/null}; if ! fgrep -q "|${_F}|" $${_DONE_FILES}; then \
		echo "|${_F}|" >>$${_DONE_FILES}; \
		PKGPATH=${PKGPATH} ${MAKE} _fetch-onefile _file=${_F}; \
	fi
.  endfor
.endif
	@@echo


_fetch-onefile:
# XXX loop so that M${_F} will work
.for _F in ${_file}
	@@echo '${_F}: $$F'
	@@echo '\t@@lock=$${@@F}; $${SIMPLE_LOCK}; \\'
	@@echo -n '\t MAINTAINER="${MAINTAINER}" '
.  if !empty(DIST_SUBDIR)
	@@echo -n 'DIST_SUBDIR="${DIST_SUBDIR}" '
.  endif
	@@echo '\\'
	@@select='${_EVERYTHING:M*${_F:S@@^${DIST_SUBDIR}/@@@@}\:[0-9]}'; \
	${_SITE_SELECTOR}; \
	echo "\t SITES=\"$$sites\" \\"
.  if ${FETCH_MANUALLY:L} != "no"
	@@echo '\t FETCH_MANUALLY="Yes" \\'
.  endif
.  if !defined(NO_CHECKSUM) && !empty(MAKESUMFILES:M${_F})
	@@if [ ! -f ${CHECKSUM_FILE} ]; then \
	  echo >&2 "Missing checksum file: ${CHECKSUM_FILE}"; \
	  echo '\t ERROR="no checksum file" \\'; \
	else \
	  for c in ${PREFERRED_CIPHERS}; do \
		if set -- `grep -i "^$$c (${_F})" ${CHECKSUM_FILE}`; then break; fi; \
	  done; \
	  case "$$4" in \
		"") \
		  echo >&2 "No checksum recorded for ${_F}."; \
		  echo '\t ERROR="no checksum" \\';; \
		"IGNORE") \
		  echo >&2 "Checksum for ${_F} is IGNORE in ${CHECKSUM_FILE}"; \
		  echo >&2 'but file is not in $${IGNORE_FILES}'; \
		  echo '\t ERROR="IGNORE inconsistent" \\';; \
		*) \
		  echo "\t CIPHER=\"$$c\" CKSUM=\"$$4\" CHECK=\""$$@@"\" \\";; \
	  esac; \
	fi
.  endif
	@@echo '\t $${EXEC} $${FETCH} "$$@@"'
.endfor

d2957 2
d3284 1
a3284 1
	_build-dir-depends _fetch-makefile _fetch-onefile \
d3309 1
a3309 1
    show-required-by subpackage uninstall mirror-maker-fetch _print-metadata \
@


1.1157
log
@now that update sees all pkgpaths, we can still remove duplicates.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1156 2012/01/21 14:44:40 espie Exp $
d717 1
@


1.1156
log
@prevent some errors I've run into recently
- add ERRORS framework to bsd.port.subdir.mk
- trying to add a FLAVOR or a SUBPACKAGE to an intermediate SUBDIR is an
error (see editors/vim-spell,af recently)
- re-including bsd.port.mk/bsd.port.subdir.mk after either of them is an
error (can happen when one moves stuff to Makefile.inc without really thinking
about it, ends up with PKG_ARGS holding some contents twice and make package
erroring out with duplicate contents)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1155 2012/01/14 12:22:07 espie Exp $
d1749 1
a1749 1
	a=`${PKG_INFO} -e ${FULLPKGPATH${_S}} $$b 2>/dev/null || true`; \
@


1.1155
log
@pass PERMIT_DISTFILES* to dpb fetch
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1154 2012/01/14 12:21:13 espie Exp $
d41 7
@


1.1154
log
@recognize pkgpath changes when updating
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1153 2011/12/21 05:16:04 miod Exp $
d100 2
a101 1
	CHECKSUM_FILE FETCH_MANUALLY MISSING_FILES
a108 1
	PERMIT_DISTFILES_CDROM PERMIT_DISTFILES_FTP \
@


1.1153
log
@In MAKE_ENV, quote PICFLAG as it may contain spaces. Other variables might
require similar quoting in the future, but so far this is enough to repair
port building operation on m68k.
ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1152 2011/12/10 11:15:16 espie Exp $
d1741 2
a1742 1
	@@a=`${PKG_INFO} -e ${FULLPKGPATH${_S}} 2>/dev/null || true`; \
@


1.1152
log
@- tweak CONFIG_SITE_LIST to run under infra/db.
- recognize absence of dependencies on gsed, gtar, ggrep,
and prevent more tests from seeing these.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1151 2011/12/09 09:42:44 espie Exp $
d647 1
a647 1
	PICFLAG=${PICFLAG} ASPICFLAG=${ASPICFLAG} \
@


1.1151
log
@make it possible to assemble a CONFIG_SITE instead of having one
single file.
approved by aja@@, sthen@@, jasper@@...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1150 2011/12/08 08:15:36 espie Exp $
d2403 1
a2403 1
	@@cat ${CONFIG_SITE_LIST} >${_CONFIG_SITE}
@


1.1150
log
@move the architecture *constants* to a private arch-defines.mk file
That way, bsd.port.arch.mk can still make available in a Makefile, but
we can also include them early in bsd.port.mk, so that they will always
be available from modules and Makefile.inc.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1149 2011/12/02 15:14:20 espie Exp $
d2402 4
@


1.1149
log
@sort -u requires one parameter to not hang on stdin...
allow SUBDIR=archivers/arc make show-prepare-results to work
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1148 2011/11/27 21:04:34 sthen Exp $
d171 5
@


1.1148
log
@replace "!defined(MASTER_SITE_OVERRIDE)" check for MASTER_SITES[0..9] with the
new ${MASTER_SITE_OVERRIDE:L} == "no" construct, problem reported by naddy@@.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1147 2011/11/27 17:21:44 espie Exp $
d1923 1
a1923 1
	@@sort -u ${_DEPBUILD_COOKIES} ${_DEPBUILDLIB_COOKIES}
d3372 1
a3372 1
	_recurse-show-run-depends show-run-depends show-prepare-results
@


1.1147
log
@generate a tempfile, THEN move to saved_libs if things are okay
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1146 2011/11/27 16:52:04 espie Exp $
d1015 1
a1015 1
.    if !defined(MASTER_SITE_OVERRIDE)
@


1.1146
log
@explicitly ask for stdin
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1145 2011/11/26 13:52:52 espie Exp $
d2007 1
a2007 1
	@@${SUDO} ${_CHECK_LIB_DEPENDS} -O $@@
@


1.1145
log
@for :patch ports, show-prepare-results should also include the list of
installed dependent ports, so we have no choice but ask, which is fairly
easy to do.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1144 2011/11/25 13:58:13 espie Exp $
d2014 1
a2014 1
			${_CHECK_LIB_DEPENDS} -s ${WRKINST}/.saved_libs; \
@


1.1144
log
@- tweak "prepare" stage to give more accurate default/dependency result directly
code should still work with older pkg_info, but you need uptodate pkg_info
for best messages, e.g.,:
===> kdelibs-3.5.10p14 depends on: gettext->=0.10.38 -> gettext-0.18.1p0
===> kdelibs-3.5.10p14 depends on: metaauto-* -> metaauto-1.0
===> kdelibs-3.5.10p14 depends on: autoconf-2.61 -> autoconf-2.61p3
===> kdelibs-3.5.10p14 depends on: gmake-* -> gmake-3.82

- adds target: show-prepare-results that yields the list of installed packages
deduced by prepare

- kill undocumented CLEAN_PLIST_OUTPUT
- remove old internals
- ensure IS_INTERACTIVE and REGRESS_IS_INTERACTIVE are always defined
- fix a bug in FETCH_MANUALLY and BATCH interaction
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1143 2011/11/24 19:24:54 espie Exp $
d1848 2
a1849 2
		Xinstall|Xreinstall) check_installed=true; try_install=true;; \
		Xpackage|Xfake) check_installed=true; try_install=false;; \
d1851 1
a1851 1
			check_installed=false; try_install=false; \
d1906 3
@


1.1143
log
@grmf, managed to reintroduce two PKG_DBLOCK
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1142 2011/11/24 18:12:28 espie Exp $
d693 2
d696 1
a696 1
.if defined(REGRESS_IS_INTERACTIVE) && ${REGRESS_IS_INTERACTIVE:L} == "x11"
d1202 1
a1203 1
MISSING_FILES = 
d1229 1
a1229 1
.if defined(REGRESS_IS_INTERACTIVE) && defined(BATCH)
d1231 1
a1231 1
.elif !defined(REGRESS_IS_INTERACTIVE) && defined(INTERACTIVE)
d1235 1
a1235 1
.if defined(IS_INTERACTIVE) && defined(BATCH)
d1237 1
a1237 1
.elif !(defined(IS_INTERACTIVE)||defined(MISSING_FILES)) && defined(INTERACTIVE)
d1240 1
a1240 1
.if defined(MISSING_FILES) && defined(BATCH)
d1268 2
a1269 1
# XXX even if subpackage is invalid, define this
a1301 1
_set_ld_library_path = :
a1620 9
CLEAN_PLIST_OUTPUT?=No
.if ${CLEAN_PLIST_OUTPUT:L} == "yes"
_plist_header=echo "@@+++ new plist"
_plist_footer=echo "@@--- end plist"
.else
_plist_header=:
_plist_footer=:
.endif

d1869 6
a1874 2
				if ${PKG_INFO} -q -e "$$pkg" -r "$$pkg" $$default; then \
					${ECHO_MSG} "$$h found"; \
d1877 12
a1888 2
					${ECHO_MSG} "$$h not found"; \
					${ECHO_MSG} "     (or default $$default does not match)"; \
a1898 6
				if ! ${PKG_INFO} -q -r "$$pkg" $$default; then \
					${ECHO_MSG} "     - default $$default does not match"; \
				fi; \
				if ! ${PKG_INFO} -q -e "$$pkg"; then \
					${ECHO_MSG} "     - not found in installed packages"; \
				fi; \
d1919 3
a2258 1
	${_set_ld_library_path}; \
d2458 1
a2458 1
.  if defined(REGRESS_IS_INTERACTIVE) && ${REGRESS_IS_INTERACTIVE:L} == "x11"
d2551 1
a2551 1
	@@${_plist_header}; ${_PKG_CREATE} -n -q ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}; ${_plist_footer}
d2554 1
a2554 2
	@@${_plist_header}; \
	if a=`SUBPACKAGE=${SUBPACKAGE} PKGPATH=${PKGPATH} ${MAKE} print-package-args`; \
d2559 1
a2559 2
	fi ; \
	${_plist_footer}
d2562 1
a2562 2
	@@${_plist_header}; \
	if a=`SUBPACKAGE=${SUBPACKAGE} PKGPATH=${PKGPATH} ${MAKE} print-package-args`; \
d2567 1
a2567 2
	fi ; \
	${_plist_footer}
d2572 1
a2572 1
	@@${_plist_header}; ${_PKG_CREATE} -n -q ${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}};${_plist_footer}
d2578 1
a2578 2
	@@${_plist_header}; \
	if a=`SUBPACKAGE=${_S} PKGPATH=${PKGPATH} ${MAKE} print-package-args`; \
d2583 1
a2583 2
	fi; \
	${_plist_footer}
d2587 1
a2587 1
	@@${_plist_header}; ${_PKG_CREATE} -n -Q ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}};${_plist_footer}
d2590 1
a2590 1
	@@${_plist_header}; ${_PKG_CREATE} -DLIBS_ONLY -n -Q ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}|${_grab_libs_from_plist}; ${_plist_footer}
a3253 3
delete-package:
	@@${_MAKE} clean=package

d3369 1
a3369 1
	_recurse-show-run-depends show-run-depends
@


1.1142
log
@bug-fix, behavior for dependency check with "_DEPENDS_TARGET=package" is
disturbingly complicated (as reported by aja@@, naddy@@, and others. Sorry,
was looking at the wrong code, so I didn't see the bug)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1141 2011/11/24 17:49:58 espie Exp $
d1876 1
a1876 1
				if ${PKG_INFO} ${PKGDB_LOCK} -q -e "$$pkg" -r "$$pkg" $$default; then \
d1884 1
a1884 1
				if ! ${PKG_INFO} ${PKGDB_LOCK} -q -r "$$pkg" $$default; \
d1892 1
a1892 1
				if ! ${PKG_INFO} ${PKGDB_LOCK} -q -r "$$pkg" $$default; then \
d1895 1
a1895 1
				if ! ${PKG_INFO} ${PKGDB_LOCK} -q -e "$$pkg"; then \
@


1.1141
log
@zap/protect some stuff.

keep FTP_KEEP_ALIVE for now, until we sort it out.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1140 2011/11/21 16:42:52 espie Exp $
d1855 2
a1856 2
		Xinstall|Xreinstall) check_install=true;; \
		Xpackage|Xfake) check_install=false;; \
d1858 2
a1859 1
			check_install=false; mkdir -p ${WRKDIR}/$$dir; \
d1870 1
a1870 1
			if $$check_install; then \
d1875 1
a1875 1
				${_force_update_fragment}; \
d1910 1
a1910 1
			$$check_install || break; \
@


1.1140
log
@BASESYSCONFDIR points to /etc (global user settings), and SYSCONFDIR
is derived from it.
old march discussion, prodded by fgs@@ about it.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1139 2011/11/21 12:26:05 espie Exp $
a48 6
#
# Variables to change if you want a special behavior:
#
# DEPENDS_TARGET - The target to execute when a port is calling a
#				  dependency (default: "install").
#
a162 1
PKGDB_LOCK ?=
a170 8
_PKG_QUERY = ${PKG_INFO} ${PKGDB_LOCK} -e
_PKG_ADD += ${PKG_DBLOCK}
_PKG_CREATE += ${PKGDB_LOCK}
_PKG_DELETE += ${PKGDB_LOCK}

# remount those mount points ro before fake.
# XXX tends to panic the OS
PROTECT_MOUNT_POINTS ?=
a230 3
NOMANCOMPRESS ?= Yes
DEF_UMASK ?= 022

a464 2
PKG_SUFX ?= .tgz

a692 1
REGRESS_STATUS_IGNORE ?=
d728 1
a728 1
_PKGFILE${_S} = ${FULLPKGNAME${_S}}${PKG_SUFX}
d989 2
a996 5
# XXX temporary, until people have correct network.conf
MASTER_SITE_OPENBSD ?= \
	ftp://ftp.openbsd.org/pub/OpenBSD/distfiles/ \
	ftp://ftp.usa.openbsd.org/pub/OpenBSD/distfiles/

d1001 1
a1001 1
.if !defined(MASTER_SITE_OVERRIDE)
d1273 1
a1273 7
.if !defined(DEPENDS_TARGET)
.  if make(reinstall)
DEPENDS_TARGET = reinstall
.  else
DEPENDS_TARGET = install
.  endif
.endif
d1712 1
a1712 1
	@@cd ${.CURDIR} && SUBPACKAGE=${_S} DEPENDS_TARGET=install PKGPATH=${PKGPATH} \
d1724 1
a1724 1
	@@if ${_PKG_QUERY} ${FULLPKGNAME${_S}}; then \
d1743 1
a1743 1
	@@a=`${_PKG_QUERY} ${FULLPKGPATH${_S}} 2>/dev/null || true`; \
d1746 1
a1746 1
		*) cd ${.CURDIR} && SUBPACKAGE=${_S} DEPENDS_TARGET=package PKGPATH=${PKGPATH} \
d1756 1
a1756 1
	@@cd ${.CURDIR} && SUBPACKAGE=${_S} DEPENDS_TARGET=package PKGPATH=${PKGPATH} \
d1848 1
a1848 1
	@@unset DEPENDS_TARGET _MASTER WRKDIR|| true; \
d1853 1
a1853 1
		case "X$$target" in X) target=${DEPENDS_TARGET};; esac; \
d2467 1
a2467 1
	@@${REGRESS_STATUS_IGNORE}cd ${.CURDIR} && exec 3>&1 && exit `exec 4>&1 1>&3; \
d2472 1
a2472 1
	@@${REGRESS_STATUS_IGNORE}cd ${WRKBUILD} && exec 3>&1 && exit `exec 4>&1 1>&3; \
d2488 2
a2489 2
	@@if [ x`${SUDO} /bin/sh -c umask` != x${DEF_UMASK} ]; then \
		echo >&2 "Error: your umask is \"`/bin/sh -c umask`"\".; \
a2494 3
.for _p in ${PROTECT_MOUNT_POINTS}
	@@${SUDO} mount -u -r ${_p}
.endfor
a2519 3
.for _p in ${PROTECT_MOUNT_POINTS}
	@@${SUDO} mount -u -w ${_p}
.endfor
d3261 1
a3261 1
	@@cd ${.CURDIR} && DEPENDS_TARGET=${DEPENDS_TARGET} PKGPATH=${PKGPATH} exec ${MAKE} install
@


1.1139
log
@nicer less confusing messages
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1138 2011/11/21 12:20:53 espie Exp $
d324 5
a328 2
# where configuration files should go
SYSCONFDIR ?= /etc
@


1.1138
log
@better check for PREPARE_CHECK_ONLY: assume we're second_pass already in
the check_install case.
That way, we get the full error report.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1137 2011/11/21 12:16:42 espie Exp $
d1907 1
a1907 1
					${ECHO_MSG} "     (or $$default does not match)"; \
d1912 1
a1912 1
					${ECHO_MSG} "$$h $$default does not match"; \
d1919 4
a1922 4
					${ECHO_MSG} "$$h $$default does not match"; \
					if ! ${PKG_INFO} ${PKGDB_LOCK} -q -e "$$pkg"; then \
						${ECHO_MSG} "$$h not found"; \
					fi; \
@


1.1137
log
@Speed up prepare stage: simplify the old loop, remove old cruft.
In the case where we want an install, run one single pkg_info instead of two.
If this fails during the second pass, we will run it again to figure out
whether the install or the default is wrong, but this is an error condition,
so this need not slow down the general case.

Add PREPARE_CHECK_ONLY knob, to be used by dpb: dpb already installs what
it needs, so for install dependencies to be missing during the "prepare"
stage is an error in dpb's logic...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1136 2011/11/19 11:33:39 espie Exp $
d1897 4
a1907 5
					case ${PREPARE_CHECK_ONLY:L} in \
					yes) \
							${REPORT_PROBLEM}; \
							exit 1;; \
					esac; \
@


1.1136
log
@mv _cache_fragment to pkgpath.mk
create a new category of recursive targets that can use this fragment,
and use them, e.g., print-package-signature from top-level should benefit
a lot.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1135 2011/11/18 11:01:47 espie Exp $
d91 1
d1332 1
a1332 1
		${ECHO_MSG} "===>  Verifying update for $$what in $$dir"; \
a1877 1
		checkinstall=true; \
d1882 5
a1886 10
		Xinstall|Xreinstall) early_exit=false;; \
		Xpackage|Xfake) early_exit=true;; \
		Xpatch|Xconfigure|Xlicense-check|Xbuild) \
			early_exit=true; mkdir -p ${WRKDIR}/$$dir; \
			toset="$$toset _MASTER='[${FULLPKGNAME${SUBPACKAGE}}]${_MASTER}' WRKDIR=${WRKDIR}/$$dir"; \
			checkinstall=false;; \
		Xextract) \
			${ECHO_MSG} "===> Error: bad dependency ${_i}"; \
			${REPORT_PROBLEM}; \
			exit 1;; \
d1888 1
a1888 1
			${ECHO_MSG} "===> Error: don't know how to depend on $$target"; \
d1894 31
a1924 10
		what=$$pkg; \
		if ! ${PKG_INFO} ${PKGDB_LOCK} -q -r "$$pkg" $$default; \
		then \
			: $${msg:= $$default does not match}; \
			${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} depends on: $$what -$$msg"; \
			${REPORT_PROBLEM}; \
			exit 1; \
		fi; \
		for abort in false false true; do \
			if $$abort; then \
d1929 1
a1929 12
			found=false; \
			if $$checkinstall; then \
				$$early_exit || ${_force_update_fragment}; \
				if ${_PKG_QUERY} "$$pkg" -q; then \
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} depends on: $$what - found"; \
					break; \
				else \
					: $${msg:= not found}; \
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} depends on: $$what -$$msg"; \
				fi; \
			fi; \
			${ECHO_MSG} "===>  Verifying $$target for $$what in $$dir"; \
d1937 1
a1937 3
			if $$early_exit; then \
				break; \
			fi; \
@


1.1135
log
@do the no_mips64 dance here, no need to duplicate it in lots of Makefiles
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1134 2011/11/17 17:53:22 espie Exp $
a1590 9

# the cache may be filled in as root, so try to remove as normal user, THEN
# sudo only if it fails.
_cache_fragment = \
	case X$${_DEPENDS_CACHE} in \
		X) _DEPENDS_CACHE=`mktemp -d /tmp/dep_cache.XXXXXXXXX|| exit 1`; \
		export _DEPENDS_CACHE; \
		trap "rm -rf 2>/dev/null $${_DEPENDS_CACHE} || ${SUDO} rm -rf $${_DEPENDS_CACHE}" 0 1 2 3 13 15;; \
	esac; PKGPATH=${PKGPATH}; export PKGPATH
@


1.1134
log
@setting PKGPATH in pkgpath.mk is not enough, pass it thru the environment
as appropriate.

(typical make package would call getpkgpath 15 times instead of 1!)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1133 2011/11/16 14:40:59 espie Exp $
d859 7
@


1.1133
log
@try to avoid SUDO while cleaning up the cache.
this avoids prompting for password during make extract.
problem noticed by rpointel@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1132 2011/11/16 10:57:23 espie Exp $
d1592 1
a1592 1
	esac
d1670 1
a1670 1
	@@if cd ${.CURDIR} && ${MAKE} print-plist-with-depends | ${_PERLSCRIPT}/register-plist -p ${PLIST_DB}; then \
d1679 1
a1679 1
	@@cd ${.CURDIR} && SUBPACKAGE=${_S} ${MAKE} check-register
d1704 1
a1704 1
		${_cache_fragment} && cd ${.CURDIR} && ${MAKE} _TRIED_FETCHING_${_PACKAGE_COOKIE${_S}}=Yes _internal-package-only
d1735 1
a1735 1
	@@cd ${.CURDIR} && SUBPACKAGE=${_S} exec ${MAKE} subpackage
d1740 1
a1740 1
	@@cd ${.CURDIR} && SUBPACKAGE=${_S} DEPENDS_TARGET=install \
d1766 1
a1766 1
	@@exec ${MAKE} ${WRKDIR}
d1774 1
a1774 1
		*) cd ${.CURDIR} && SUBPACKAGE=${_S} DEPENDS_TARGET=package \
d1784 1
a1784 1
	@@cd ${.CURDIR} && SUBPACKAGE=${_S} DEPENDS_TARGET=package \
d1788 1
a1788 1
	@@exec ${MAKE} ${WRKDIR}
d2094 1
a2094 1
		  	cd ${.CURDIR} && ${MAKE} _refetch _PROBLEMS="$$list"; \
d2159 1
a2159 1
_extra_info += DEPPATHS${_s}="`${SETENV} FLAVOR=${FLAVOR:Q} SUBPACKAGE=${_s} ${MAKE} show-run-depends ${_do_libs_too}`"
d2202 1
a2202 1
	@@${_DO_LOCK}; cd ${.CURDIR} && ${MAKE} _internal-${_t}
d2495 1
a2495 1
		(exec; set +e; ${MAKE} do-regress; \
d2584 1
a2584 1
	if a=`SUBPACKAGE=${SUBPACKAGE} ${MAKE} print-package-args`; \
d2594 1
a2594 1
	if a=`SUBPACKAGE=${SUBPACKAGE} ${MAKE} print-package-args`; \
d2612 1
a2612 1
	if a=`SUBPACKAGE=${_S} ${MAKE} print-package-args`; \
d2688 1
a2688 1
	@@${MAKE} all-dir-depends|tsort -r|${_zap_last_line}|while read subdir; do \
d2751 1
a2751 1
	if ${MAKE} _fetch-makefile >$$mk; then \
d2758 2
a2759 1
	@@mk=`mktemp ${TMPDIR}/mk.XXXXXXXX`; ${MAKE} fetch-makefile >$$mk; \
d2777 1
a2777 1
	@@echo "${_FETCH_MAKEFILE_NAMES}: ${MAKESUMFILES} "`_FULL_PACKAGE_NAME=Yes ${MAKE} full-all-depends|fgrep -v ${PKGPATH}/`
d2786 1
a2786 1
		${MAKE} _fetch-onefile _file=${_F}; \
d2895 1
a2895 1
	cd ${.CURDIR} && ${MAKE} TMPDIR=$$tmpdir README_NAME=${README_NAME} \
d2901 1
a2901 1
	cd ${.CURDIR} && ${MAKE} TMPDIR=$$tmpdir README_NAME=${README_NAME} \
d2926 1
a2926 1
	@@cd ${.CURDIR} && SUBPACKAGE=${_S} ${MAKE} full-${_I}-depends _FULL_PACKAGE_NAME=Yes| \
d2950 1
a2950 1
	@@${MAKE} full-build-depends| ${_lines2list}
d2957 1
a2957 1
	@@${MAKE} full-run-depends| ${_lines2list}
d2964 1
a2964 1
	@@${MAKE} ${_i}-dir-depends|${_sort_dependencies}|while read subdir; do \
d2974 1
a2974 1
	@@SUBPACKAGE=${_S} ${MAKE} all-dir-depends|${_sort_dependencies}|while read subdir; do \
d3011 1
a3011 1
	@@cd ${.CURDIR} && ${MAKE} _print-package-signature-run | \
d3133 1
a3133 1
		self=${FULLPKGPATH} ${MAKE} _recurse-run-dir-depends; \
d3159 1
a3159 1
		self=${FULLPKGPATH} ${MAKE} _recurse-regress-dir-depends; \
d3201 1
a3201 1
		self=${FULLPKGPATH} ${MAKE} _build-dir-depends; \
d3212 1
a3212 1
		self=${FULLPKGPATH} ${MAKE} _recurse-all-dir-depends; \
d3294 1
a3294 1
	@@cd ${.CURDIR} && DEPENDS_TARGET=${DEPENDS_TARGET} exec ${MAKE} install
@


1.1132
log
@add comments to a few thing
be more precise into recreating $d, using bizarre shell patterns
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1131 2011/11/16 10:30:47 espie Exp $
d1582 1
a1582 1
# computing libraries from the ports tree is expenive, so cache as many of
d1584 3
d1591 1
a1591 1
		trap "${SUDO} rm -rf $${_DEPENDS_CACHE}" 0 1 2 3 13 15;; \
@


1.1131
log
@flatten the DEPENDS_CACHE structure, at the expense of one extra sed.
avoids problems with ownership of various directories, as seen by naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1130 2011/11/15 20:41:41 espie Exp $
d1548 3
d1553 1
a1553 1
	d="$$pkg:$$subdir:$$target"; \
d1582 2
d1591 2
d1610 2
a1611 1
# both wantlib-args use this
@


1.1130
log
@rephrase to remove unneeded needed variable.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1129 2011/11/15 20:32:35 espie Exp $
a1585 1
_cached_libs = $${_DEPENDS_CACHE}/$$subdir/libs
d1588 3
a1590 3
	if ! test -f ${_cached_libs}; then \
		mkdir -p $${_DEPENDS_CACHE}/$$subdir; \
		if ! eval $$toset ${MAKE} print-plist-libs >${_cached_libs}; \
d1601 1
a1601 1
	if ${_resolve_lib} -needed ${_DEPRUNLIBS:QL} <${_cached_libs}
d1622 1
a1622 1
		cat ${_cached_libs}; \
d1959 1
a1959 1
				cat ${_cached_libs}; \
d2011 2
a2012 2
	@@${_MAKE} package
	@@${_CHECK_LIB_DEPENDS} ${_PACKAGE_COOKIE}
@


1.1129
log
@same code
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1128 2011/11/15 20:08:36 espie Exp $
d1599 1
a1599 2
_check_needed = \
	needed=false; \
d1602 1
a1602 3
	if ${_resolve_lib} -needed ${_DEPRUNLIBS:QL} <${_cached_libs}; then \
		needed=true; \
	fi
d3036 1
a3036 2
		${_check_needed}; \
		if $$needed; then \
d3096 1
a3096 2
		${_check_needed}; \
		if $$needed; then \
@


1.1128
log
@speed-up dependency checking a bit:
- resolve-lib -needed, less perl invocations (gains a lot)
- show-run-depends, less fancy than run-dir-depends, a bit faster...
- don't create cache for internal targets (external stuff already did it)

define _PERLSCRIPT in pkgpath.mk since getpkgpath should use it...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1127 2011/11/14 22:02:15 espie Exp $
d1607 8
d3067 1
a3067 5
		for k in $$found; do \
			case $$k in *.a) ;; \
			*) echo "-W $$k";; \
			esac; \
		done; \
d3082 1
a3082 5
			for k in $$found; do \
				case $$k in *.a) ;; \
				*) echo "-W $$k";; \
				esac; \
			done; \
@


1.1127
log
@rework the dependency code to be slightly simpler.
systematically use a cache while scanning for libraries.
This speeds up MULTI_PACKAGES a bit...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1126 2011/11/14 16:18:36 espie Exp $
a91 1
_PERLSCRIPT = perl ${PORTSDIR}/infrastructure/bin
d1603 3
a1605 13
	exec 3>&2; \
	for d in ${_DEPRUNLIBS:QL}; do \
		exec 2>/dev/null; \
		if check=`${_resolve_lib} $$d <${_cached_libs}`; \
		then \
			case "$$check" in \
				*.a) ;; \
				*) needed=true; \
					break;; \
			esac; \
		fi; \
	done; \
	exec 2>&3
d1615 1
a1615 1
	{ ${MAKE} run-dir-depends|${_sort_dependencies}|while read subdir; do \
d2144 1
a2144 1
_extra_info += DEPPATHS${_s}="`${SETENV} FLAVOR=${FLAVOR:Q} SUBPACKAGE=${_s} ${MAKE} run-dir-depends ${_do_libs_too}|${_sort_dependencies}`"
d3098 1
a3098 2
	@@${_cache_fragment}; \
	${_list_port_libs}| ${_resolve_lib} ${_DEPRUNLIBS:QL}; \
d3212 29
d3400 2
a3401 1
	port-wantlib-args fake-wantlib-args no-wantlib-args
@


1.1126
log
@we have :QL, so make depends handling a bit saner.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1125 2011/11/14 13:12:20 espie Exp $
a1316 8
# fairly good approximation of libraries we want
# XXX this is ksh, be less perfect with pure sh
_lib=/lib*.{so.+([0-9]).+([0-9]),a}

_libresolve_fragment = \
	check=`for _lib in $$libs; do echo $$_lib; done | \
		${_resolve_lib} $$d` \
			|| check=Failed
d1580 51
d1700 1
a1700 1
		cd ${.CURDIR} && ${MAKE} _TRIED_FETCHING_${_PACKAGE_COOKIE${_S}}=Yes _internal-package-only
d1961 1
a1961 1
	@@if found=`{ \
d1965 2
a1966 1
				eval $$toset ${MAKE} print-plist-libs; \
d1968 2
a1969 1
		echo ${LOCALBASE}/lib${_lib} /usr/lib${_lib} ${X11BASE}/lib${_lib}; \
d2025 1
a2025 1
	@@-for s in ${MULTI_PACKAGES}; do \
d2215 1
a2215 1
	@@${_DO_LOCK}; cd ${.CURDIR} && ${MAKE} _internal-subpackage
d2218 1
a2218 1
	@@${_MAKE} _internal-package-only
d2225 1
a2225 1
	@@${_MAKE} _internal-package-only
d3002 1
a3002 1
	@@cd ${.CURDIR} && LIST_LIBS=`${MAKE} _list-port-libs` ${MAKE} _print-package-signature-lib _print-package-signature-run| \
d3041 6
a3046 19
	@@${_emit_lib_depends}| while ${_read_spec}; do \
		${_parse_spec}; \
		${_complete_pkgspec}; \
		libs=`eval $$toset ${MAKE} print-plist-libs`; \
		needed=false; \
		exec 3>&2; \
		for d in ${_DEPRUNLIBS:QL}; do \
			if $$needed; then continue; fi; \
			exec 2>/dev/null; \
			${_libresolve_fragment}; \
			case "$$check" in \
			*.a|Failed) \
				continue;; \
			*) \
				needed=true;; \
			esac; \
		done; \
		exec 2>&3; \
		if $$needed; then echo "-P $$pkgpath:$$pkg:$$default"; fi; \
d3050 3
a3052 1
	@@a=`mktemp /tmp/portstree.XXXXXX`; b=`mktemp /tmp/inst.XXXXXX`; \
a3058 1
		rm -f $$a $$b; \
d3067 11
a3077 19
	@@if found=`{ \
		${MAKE} run-dir-depends|${_sort_dependencies}|while read subdir; do \
			${_flavor_fragment}; \
			if ! eval $$toset ${MAKE} print-plist-libs; \
			then \
				echo 1>&2 "Problem with dependency $$subdir"; \
				exit 1; \
			fi; done; \
		echo /usr/lib${_lib} ${X11BASE}/lib${_lib}; } | \
		${_resolve_lib} ${_DEPRUNLIBS:QL}`; \
		then \
			for k in $$found; do \
				case $$k in *.a) ;; \
				*) echo "-W $$k";; \
				esac; \
			done; \
		else \
			exit 1; \
		fi
a3100 24
_list-port-libs:
.if defined(_PORT_LIBS_CACHE) && defined(_DEPENDS_CACHE) && \
	defined(_DEPENDS_FILE)
	@@if ! fgrep -q -e "r|${FULLPKGPATH}|" -e "a|${FULLPKGPATH}" $${_DEPENDS_FILE}; then \
		${MAKE} run-dir-depends >>${_DEPENDS_CACHE}; \
	fi
	@@${_PERLSCRIPT}/extract-dependencies ${FULLPKGPATH} <${_DEPENDS_CACHE}|while read subdir; do \
		fulldir=${_PORT_LIBS_CACHE}/$$subdir; \
		if test -f $$fulldir; then \
			cat $$fulldir; \
		else \
			mkdir -p $${fulldir%/*}; \
			${_flavor_fragment}; \
			eval $$toset ${MAKE} print-plist-libs | tee $$fulldir; \
		fi; \
	done
.else
	@@${MAKE} run-dir-depends|${_sort_dependencies}|while read subdir; do \
		${_flavor_fragment}; \
		eval $$toset ${MAKE} print-plist-libs ; \
	done
.endif
	@@echo /usr/lib/lib* ${X11BASE}/lib/lib*

d3109 8
a3116 20
	@@echo $$LIST_LIBS| ${_resolve_lib} ${_DEPRUNLIBS:QL}
	@@${_emit_lib_depends}| while ${_read_spec}; do \
		${_parse_spec}; \
		${_complete_pkgspec}; \
		libs=`eval $$toset ${MAKE} print-plist-libs`; \
		needed=false; \
		exec 3>&2; \
		for d in ${_DEPRUNLIBS:QL}; do \
			if $$needed; then continue; fi; \
			exec 2>/dev/null; \
			${_libresolve_fragment}; \
			case "$$check" in \
			*.a|Failed) \
				continue;; \
			*) \
				needed=true;; \
			esac; \
		done; \
		exec 2>&3; \
		if $$needed; then echo "$$default"; fi; \
d3367 1
a3367 1
	_list-port-libs print-package-args _print-package-signature-lib \
@


1.1125
log
@IFS setting can be local to the read
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1124 2011/11/14 12:10:27 espie Exp $
d1557 1
d1559 2
a1560 2
	IFS=: read pkg subdir target; \
	extra_msg="(DEPENDS was $$pkg $$subdir $$target) in ${FULLPKGPATH}"; \
d1585 4
d1830 1
a1830 2
	d='${_i}'; \
	echo '${_i}'|{ \
d1891 1
a1891 1
	}
d1919 6
a1924 5
		for i in ${_LIB4:QL}; do echo "$$i"| { \
			${_parse_spec}; \
			eval $$toset ${MAKE} print-plist-libs; \
			}; \
		done; echo ${LOCALBASE}/lib${_lib} /usr/lib${_lib} ${X11BASE}/lib${_lib}; \
d1980 2
a1981 2
.  for _S in ${MULTI_PACKAGES}
	@@-SUBPACKAGE=${_S} ${MAKE} print-plist-with-depends \
d1984 2
a1985 2
	 ${_CHECK_LIB_DEPENDS} -s ${WRKINST}/.saved_libs
.  endfor
d2975 1
a2975 2
.for _i in ${RUN_DEPENDS${SUBPACKAGE}}
	@@d='${_i}'; echo '${_i}' |{ \
d2979 1
a2979 2
	}
.endfor
d2984 1
a2984 2
.for _i in ${LIB_DEPENDS${SUBPACKAGE}}
	@@d='${_i}'; echo '${_i}' |{ \
d2988 1
a2988 2
	}
.endfor
d2996 1
a2996 2
.  for _i in ${LIB_DEPENDS${SUBPACKAGE}}
	@@d='${_i}'; echo '${_i}'|{ \
d3015 1
a3015 2
	}
.  endfor
d3101 1
a3101 2
.for _i in ${RUN_DEPENDS${SUBPACKAGE}}
	@@echo '${_i}' |{ \
d3105 1
a3105 2
	}
.endfor
d3109 1
a3109 2
.for _i in ${LIB_DEPENDS${SUBPACKAGE}}
	@@d='${_i}'; echo '${_i}'|{ \
d3128 1
a3128 2
	}
.endfor
@


1.1124
log
@nit pick some very old stuff
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1123 2011/11/14 10:29:58 espie Exp $
d1558 1
a1558 1
	IFS=:; read pkg subdir target; \
d1562 1
a1562 1
	esac; unset IFS; ${_flavor_fragment}
@


1.1123
log
@a bit more micro-optimization: allow print-plist-libs-with-depends
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1122 2011/11/13 10:34:35 espie Exp $
d2839 1
a2839 1
	trap 'rm -r $$tmpdir' 0 1 2 3 13 15; \
d2845 1
a2845 1
	trap 'rm -r $$tmpdir' 0 1 2 3 13 15; \
@


1.1122
log
@better FETCH_MANUALLY handling:
- expose MISSING_FILES
- treat them as a special kind of IGNORE
- handle that in DPB
that way, ports that are IGNORE'd for other reasons (not correct arch)
stay ignored, and relevant ports with missing distfiles get better error
messages
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1121 2011/11/02 17:16:30 avsm Exp $
d2533 10
@


1.1121
log
@add .tbz to the list of known EXTRACT_SUFX entries
ok espie@@ brad@@ dcoppa@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1120 2011/10/25 15:08:10 espie Exp $
d106 1
a106 1
	CHECKSUM_FILE FETCH_MANUALLY
d1215 1
a1215 1
_MISSING_FILES = 
d1218 1
a1218 1
_MISSING_FILES += ${_F}
a1220 3
.  if !empty(_MISSING_FILES)
IS_INTERACTIVE = Yes
.  endif
d1249 1
a1249 1
.elif !defined(IS_INTERACTIVE) && defined(INTERACTIVE)
d1252 4
d1282 1
a1282 1
.if !empty(IGNORE${SUBPACKAGE}) && ${IGNORE_IS_FATAL:L} == "yes"
d1284 1
a1284 1
ERRORS += ${IGNORE${SUBPACKAGE}}
d1950 1
a1950 1
.if !empty(IGNORE${SUBPACKAGE}) && !defined(NO_IGNORE)
d1960 1
a1960 1
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} ${IGNORE${SUBPACKAGE}}."
d1963 1
a1963 1
	@@echo "${IGNORE${SUBPACKAGE}}" >${_IGNORE_COOKIE}
d2572 2
a2573 2
.    if !empty(_MISSING_FILES)
	@@echo "*** You're missing files: ${_MISSING_FILES}"
@


1.1120
log
@make signatures conform to the way packages get built.
This does slow down signature computations (I will try to address that),
but it removes all false positives from dpb -R.

tested by nigel@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1119 2011/10/24 12:34:08 espie Exp $
d1118 1
a1118 1
.if !empty(EXTRACT_ONLY:M*.tar.bz2) || !empty(EXTRACT_ONLY:M*.tbz2) || \
d1143 1
a1143 1
EXTRACT_CASES += *.tar.bz2|*.tbz2) \
@


1.1119
log
@zap pre,do,post fetch & package.
speed up print-plist-libs a wee little bit
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1118 2011/10/21 16:52:05 espie Exp $
d3102 1
a3102 1
	@@echo '${_i}' |{ \
d3104 17
a3120 2
		${_compute_default}; \
		echo "$$default"; \
@


1.1118
log
@missed one
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1117 2011/10/21 16:35:14 espie Exp $
d35 2
a36 2
.for t in do-fetch
.  if target(do-fetch)
a993 1
SH ?= /bin/sh
a1653 6
.    if target(pre-package)
	@@${_MAKE} pre-package
.    endif
.  if target(do-package)
	@@${_MAKE} do-package
.    else
a1673 4
.    endif
.    if target(post-package)
	@@${_MAKE} post-package
.    endif
a1942 3
.if target(pre-fetch)
	@@${_MAKE} pre-fetch __FETCH_ALL=Yes
.endif
a1947 3
.if target(post-fetch)
	@@${_MAKE} post-fetch __FETCH_ALL=Yes
.endif
a1994 2
# IMPORTANT: pre-fetch/do-fetch/post-fetch MUST be designed so that they
# can be run several times in a row.
a1998 6
.  if target(pre-fetch)
	@@${_MAKE} pre-fetch
.  endif
.  if target(do-fetch)
	@@${_MAKE} do-fetch
.  else
d2000 1
a2000 1
.    if !empty(CHECKSUMFILES)
d2002 1
a2002 1
.    endif
a2003 4
.  endif
.  if target(post-fetch)
	@@${_MAKE} post-fetch
.  endif
d2560 1
a2560 1
	@@${_plist_header}; ${_PKG_CREATE} -n -Q ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}|${_grab_libs_from_plist}; ${_plist_footer}
d3362 1
a3362 1
	do-extract do-fetch do-install do-package do-regress fetch-all \
d3365 1
a3365 1
	post-distpatch post-extract post-fetch post-install post-package \
d3367 1
a3367 1
	pre-fetch pre-install pre-package pre-patch pre-regress prepare \
@


1.1117
log
@zap CHOWN/CHMOD, as prompted by a question from stu
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1116 2011/10/16 07:51:27 espie Exp $
d1674 1
a1674 1
		${SUDO} ${CHOWN} $${mode} ${_PACKAGE_COOKIE${_S}}; then \
@


1.1116
log
@minor cleanup: there's no reason for these variables to be intermixed
with targets.
lib-depends-check should be defined as ignored along with the rest.
errors-handling should occur last, so that the last block of errors gets
used.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1115 2011/10/16 07:12:35 espie Exp $
a981 2
CHMOD ?= /bin/chmod
CHOWN ?= /usr/sbin/chown
@


1.1115
log
@- fix position of Makefile.inc include guard to allow arbitrary intermixing of
Makefile.inc and bsd.port.arch.mk without infinite recursion.

- use simpler pattern to test for arch stuff, we just need the values, so
.for A B in ${MACHINE_ARCH} ${ARCH}
is enough and avoids the setting of intermediate variables.

- new PROPERTIES variable that's easy to test with e.g. if ${PROPERTIES:Mapm}
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1114 2011/10/03 15:46:33 espie Exp $
d1586 26
d1976 1
a1976 1
	port-lib-depends-check update-patches:
a1984 6
_CHECK_LIB_DEPENDS = PORTSDIR=${PORTSDIR} ${_PERLSCRIPT}/check-lib-depends
_CHECK_LIB_DEPENDS += -d ${_PKG_REPO} -B ${WRKINST}
.  if ${ELF_TOOLCHAIN:L} == "no"
_CHECK_LIB_DEPENDS += -o
.  endif

a2554 20
.if empty(PLIST_DB)
_register_plist =:
.else
_register_plist = mkdir -p ${PLIST_DB:S/:/ /g} && ${_PERLSCRIPT}/register-plist ${PLIST_DB}
.endif
.if ${CHECK_LIB_DEPENDS:L} == "yes"
_check_lib_depends = ${_CHECK_LIB_DEPENDS} 
.else
_check_lib_depends =:
.endif

CLEAN_PLIST_OUTPUT?=No
.if ${CLEAN_PLIST_OUTPUT:L} == "yes"
_plist_header=echo "@@+++ new plist"
_plist_footer=echo "@@--- end plist"
.else
_plist_header=:
_plist_footer=:
.endif

a3305 10
.if defined(ERRORS)
.BEGIN:
.  for _m in ${ERRORS}
	@@echo 1>&2 ${_m} "(in ${PKGPATH})"
.  endfor
.  if !empty(ERRORS:M"Fatal\:*") || !empty(ERRORS:M'Fatal\:*')
	@@exit 1
.  endif
.endif

d3412 10
@


1.1114
log
@There's no actual reason to accept flavors with non-lowercase spelling,
so kill the misfeature, as agreed by mostly everyone.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1113 2011/09/30 05:35:52 espie Exp $
d189 1
a191 1
_MAKEFILE_INC_DONE = Yes
@


1.1113
log
@oops
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1112 2011/09/28 10:20:19 espie Exp $
d402 1
a402 1
.if !empty(FLAVORS:L:Mregress) && empty(FLAVOR:L:Mregress)
d432 2
a433 2
.  for _i in ${FLAVORS:L}
.    if empty(FLAVOR:L:M${_i})
d438 1
a438 1
.    if empty(PSEUDO_FLAVORS:L:M${_i})
d463 2
a464 2
.    for _i in ${FLAVOR:L}
.      if empty(FLAVORS:L:M${_i})
@


1.1112
log
@more default flavors cleanup:
- if there is no flavor in BUILD_PKGPATH, it's not necessarily the default,
make sure there's an empty flavor by appending a ,
- pass FLAVOR to dump-vars, so that eventually dpb can match "no flavor
specified" to "this is the default flavor", thus getting a bit smarter
(this should speed up the LISTING job by not traversing as many subdirs).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1111 2011/09/25 21:30:04 naddy Exp $
d448 1
a448 1
.if !${BUILD_PKGPATH:M,}
@


1.1111
log
@use ${TAR} when extracting .tar.xz, too
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1110 2011/09/25 07:59:49 espie Exp $
d96 1
a96 1
	SUBPACKAGE MULTI_PACKAGES
d448 3
a450 3
#.if empty(FLAVOR)
#BUILD_PKGPATH := ${BUILD_PKGPATH},
#.endif
d1368 1
a1368 3
# normalization of depends to remove extra :

# also, the C,...., part basically does this:
@


1.1110
log
@regroup everything having to do with MD stuff and split it off into
its own file.

*this requires current src as well*, to have the glue in /usr/share/mk
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1109 2011/09/21 09:02:09 espie Exp $
d1137 1
a1137 1
	xzcat ${FULLDISTDIR}/$$archive| tar xf -;;
@


1.1109
log
@kill some very old knobs we do not use at all.
okay ETOOMANYPEOPLE
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1108 2011/09/20 09:36:13 sthen Exp $
a129 21
ARCH ?!= uname -m

ALL_ARCHS = alpha amd64 arm armish arm hppa hppa64 i386 landisk \
	loongson luna88k m68k m88k mac68k macppc mips64 mips64el \
	mvme68k mvme88k palm sgi socppc sparc sparc64 vax zaurus
# not all powerpc have apm(4), hence the use of macppc
APM_ARCHS = amd64 arm i386 loongson macppc sparc sparc64
LP64_ARCHS = alpha amd64 hppa64 sparc64 mips64 mips64el
NO_SHARED_ARCHS = m88k vax
GCC4_ARCHS = amd64 arm armish beagle gumstix i386 hppa loongson macppc mips64 \
	mips64el mvmeppc palm powerpc sgi socppc sparc sparc64 zaurus
GCC3_ARCHS = alpha hppa64 landisk sh
GCC2_ARCHS = aviion luna88k m68k m88k mac68k mvme68k mvme88k vax

# Set NO_SHARED_LIBS for those machines that don't support shared libraries.
.for _m in ${MACHINE_ARCH}
.  if !empty(NO_SHARED_ARCHS:M${_m})
NO_SHARED_LIBS ?= Yes
.  endif
.endfor
NO_SHARED_LIBS ?= No
d187 5
a191 2
.if exists(${.CURDIR}/../Makefile.inc)
.include "${.CURDIR}/../Makefile.inc"
a298 6
.if ${MACHINE_ARCH} != ${ARCH}
PKG_ARCH ?= ${MACHINE_ARCH},${ARCH}
.else
PKG_ARCH ?= ${MACHINE_ARCH}
.endif

d378 7
a384 4
.if !defined(MULTI_PACKAGES) || empty(MULTI_PACKAGES)
# XXX let's cheat so we always have MULTI_PACKAGES
MULTI_PACKAGES = -
SUBPACKAGE ?= -
d386 1
a386 1
SUBPACKAGE ?= -main
a388 2
_MULTI_PACKAGES =

a394 41

# ONLY_FOR_ARCHS/NOT_FOR_ARCHS are special
.  if defined(ONLY_FOR_ARCHS)
ONLY_FOR_ARCHS${_s} ?= ${ONLY_FOR_ARCHS}
.  endif
.  if defined(NOT_FOR_ARCHS)
NOT_FOR_ARCHS${_s} ?= ${NOT_FOR_ARCHS}
.  endif

IGNORE${_s} ?=
IGNORE${_s} += ${IGNORE}

# compute _ARCH_OK for ignore
.  if defined(ONLY_FOR_ARCHS${_s})
_ARCH_OK = 0
.    for __ARCH in ${MACHINE_ARCH} ${ARCH}
.      if !empty(ONLY_FOR_ARCHS${_s}:M${__ARCH})
_ARCH_OK = 1
.      endif
.    endfor
.    if ${_ARCH_OK} == 0
.      if ${MACHINE_ARCH} == "${ARCH}"
IGNORE${_s} += "is only for ${ONLY_FOR_ARCHS${_s}}, not ${MACHINE_ARCH}"
.      else
IGNORE${_s} += "is only for ${ONLY_FOR_ARCHS${_s}}, not ${MACHINE_ARCH} \(${ARCH}\)"
.      endif
.    endif
.  endif
.  if defined(NOT_FOR_ARCHS${_s})
.    for __ARCH in ${MACHINE_ARCH} ${ARCH}
.      if !empty(NOT_FOR_ARCHS${_s}:M${__ARCH})
IGNORE${_s} += "is not for ${NOT_FOR_ARCHS${_s}}"
.      endif
.    endfor
.  endif

# allow subpackages to vanish on architectures that don't
# support them
.  if empty(IGNORE${_s})
_MULTI_PACKAGES += ${_s}
.  endif
d448 4
d557 1
a557 1
.for _S in ${_MULTI_PACKAGES}
d719 1
a719 1
.for _s in ${_MULTI_PACKAGES}
d754 1
a754 1
.for _S in ${_MULTI_PACKAGES}
d1391 1
a1391 1
.  for _s in ${_MULTI_PACKAGES}
@


1.1108
log
@no need to warn about xz for SHARED_ONLY ports, they don't work on vax anyway.
ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1107 2011/09/16 20:02:20 kili Exp $
a266 6
.if exists(${.CURDIR}/Makefile.${ARCH})
.include "${.CURDIR}/Makefile.${ARCH}"
.elif exists(${.CURDIR}/Makefile.${MACHINE_ARCH})
.include "${.CURDIR}/Makefile.${MACHINE_ARCH}"
.endif

a333 5
.if exists(${.CURDIR}/patches.${ARCH})
PATCHDIR ?= ${.CURDIR}/patches.${ARCH}
.elif exists(${.CURDIR}/patches.${MACHINE_ARCH})
PATCHDIR ?= ${.CURDIR}/patches.${MACHINE_ARCH}
.else
a334 2
.endif

a335 6

.if exists(${.CURDIR}/files.${ARCH})
FILESDIR ?= ${.CURDIR}/files.${ARCH}
.elif exists(${.CURDIR}/files.${MACHINE_ARCH})
FILESDIR ?= ${.CURDIR}/files.${MACHINE_ARCH}
.else
a336 7
.endif

.if exists(${.CURDIR}/pkg.${ARCH})
PKGDIR ?= ${.CURDIR}/pkg.${ARCH}
.elif exists(${.CURDIR}/pkg.${MACHINE_ARCH})
PKGDIR ?= ${.CURDIR}/pkg.${MACHINE_ARCH}
.else
a337 1
.endif
@


1.1107
log
@Temporarily disable globbing in _compute_default, to fix
all kind of weird shit happening (welcome to quoting hell).

Problem noticed first by jasper, globbing fix suggested by
espie.

ok espie
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1106 2011/09/16 08:26:11 espie Exp $
d2308 1
a2308 1
.if ${_USE_XZ:L} != "no"
@


1.1106
log
@normalize pkgpath in bsd.port.mk
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1105 2011/09/15 17:19:36 espie Exp $
d1656 1
d1662 2
a1663 1
	fi
@


1.1105
log
@tweak dependency handling: use set -- `make _print-metadata` to get
all properties of the depending port we want.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1104 2011/09/10 08:20:56 espie Exp $
d3081 1
a3081 1
		echo "-P $$subdir:$$pkg:$$default"; \
d3092 1
a3092 1
		echo "-P $$subdir:$$pkg:$$default"; \
d3121 1
a3121 1
		if $$needed; then echo "-P $$subdir:$$pkg:$$default"; fi; \
@


1.1104
log
@better: define PSEUDO_FLAVOR as something to add to the fullpkgpath
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1103 2011/09/10 08:05:12 espie Exp $
d1656 4
a1659 2
	if ! default=`eval $$toset exec ${MAKE} _print-packagename`; then \
		echo 1>&2 "Problem with dependency ${_i}"; \
a1662 4
_set_pkg2default= pkg=`eval $$toset exec ${MAKE} _print-pkgspec`
_set_stem2default=stem=`echo $$default|${_version2stem}`; \
		pkg="$$stem$${pkg\#STEM}"

d1666 5
a1670 2
	X) ${_set_pkg2default};; \
	XSTEM*) ${_set_stem2default};; \
d1884 2
a1885 2
_print-pkgspec:
	@@echo '${PKGSPEC${SUBPACKAGE}}'
d1898 1
d1922 1
a1922 12
		${_compute_default}; \
		case "X$$pkg" in \
		X) \
			if ! ${_set_pkg2default}; \
			then \
				${ECHO_MSG} "===> Error in evaluating dependency ${_i}"; \
				${REPORT_PROBLEM}; \
				exit 1; \
			fi;; \
		XSTEM*) \
			${_set_stem2default};; \
		esac; \
d3078 1
a3078 1
	@@echo '${_i}' |{ \
d3089 1
a3089 1
	@@echo '${_i}' |{ \
d3103 1
a3103 1
	@@echo '${_i}'|{ \
d3498 1
a3498 1
    show-required-by subpackage uninstall mirror-maker-fetch _print-pkgspec \
@


1.1103
log
@show FLAVOR to dump-vars.
This is occasionally useful for pseudo-flavors: these do not get encoded
in the pkgpath, so taking (for instance) sqlports, this generates lines
which are later impossible to exploit based only on the fullpkgpath, as
opposed to fullpkgpath,flavor  (which might contain the flavor twice, but
this is not an issue).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1102 2011/09/03 13:39:56 espie Exp $
d116 1
a116 1
	SHARED_LIBS TARGETS FLAVOR \
d520 1
d532 2
@


1.1102
log
@name construct as OLD_WRKDIR_NAME, to be used as WRKDIR_LINKNAME
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1101 2011/07/20 08:46:20 sthen Exp $
d116 1
a116 1
	SHARED_LIBS TARGETS \
@


1.1101
log
@Check NO_CCACHE everywhere that USE_CCACHE is checked, I missed it in
one small but necessary place.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1100 2011/07/15 23:11:00 fgsch Exp $
d758 6
d771 1
a771 5
.  if ${SEPARATE_BUILD:L:Mflavored}
WRKDIR ?= ${.CURDIR}/w-${PKGNAME}
.  else
WRKDIR ?= ${.CURDIR}/w-${PKGNAME}${_FLAVOR_EXT2}
.  endif
a1672 1

@


1.1100
log
@add regress-depends-list.
input and ok espie@@.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1099 2011/07/12 10:04:00 espie Exp $
d2296 1
a2296 1
.if ${USE_CCACHE:L} == "yes"
@


1.1099
log
@for depends, always run checks on fullpkgname vs pkgspec upfront.
exit if the dependency doesn't match.
then do the actual dependency and the normal tests.

stop looking at full pkgnames list, makes no sense, even configure depends
can use the required ,-subpackage if they want.

This allows stuff such as BUILD_DEPENDS = dir>=5.0:configure
to get out early if the tree is not uptodate, instead of first configuring
then getting out (problem noticed by landry@@).

tested by landry@@ and jasper@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1098 2011/07/12 08:08:01 ajacoutot Exp $
d1536 1
d3049 2
a3050 2
# run-depends-list, build-depends-list, lib-depends-list
.for _i in RUN BUILD LIB
d3502 2
a3503 2
	regress-depends run-depends run-depends-list show-required-by \
	subpackage uninstall mirror-maker-fetch _print-pkgspec \
@


1.1098
log
@When cleaning packages, remove the ones under PORTSDIR/update as well.

ok jasper@@ sthen@@ espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1097 2011/07/12 04:26:47 ajacoutot Exp $
d1650 1
a1650 1
	if ! default=`eval $$toset ${MAKE} _print-packagename`; then \
d1655 1
a1655 1
_set_pkg2default= pkg=`eval $$toset ${MAKE} _print-pkgspec`
d1915 1
d1918 1
a1918 1
			if ! pkg=`eval $$toset ${MAKE} _print-pkgspec`; \
d1925 1
a1925 4
			if default=`eval $$toset ${MAKE} _print-packagename`; \
			then \
				${_set_stem2default}; \
			fi;; \
d1927 8
a1941 1
			what=$$pkg; \
d1961 1
a1961 10
				list=`eval $$toset exec ${MAKE} show=PKGNAMES`; \
				if ${PKG_INFO} ${PKGDB_LOCK} -q -r "$$pkg" $$list; \
				then \
						break; \
				else \
					: $${msg:= not found}; \
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} depends on: $$what -$$msg"; \
					${REPORT_PROBLEM}; \
					exit 1; \
				fi; \
d2065 3
a2067 1
	@@-SUBPACKAGE=${_S} ${MAKE} print-plist-with-depends lib_depends_args=all-lib-depends-args| \
@


1.1097
log
@Make the xz warning fit on one line.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1096 2011/07/11 12:21:53 jasper Exp $
d2788 1
a2788 1
	rm -f ${_PACKAGE_COOKIES}
d2790 1
a2790 1
	rm -f ${_PACKAGE_COOKIES${SUBPACKAGE}}
@


1.1096
log
@xz doesn't need gcc3 anymore on sparc, so no need to scare people anymore
about it being a pain to build on sparc.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1095 2011/07/10 17:15:08 jasper Exp $
d2314 1
a2314 2
	echo "*** WARNING: this port uses xz distfiles."; \
	echo "*** It will not build on vax."; \
@


1.1095
log
@- move arm platforms to GCC4_ARCHS
- zap mvmeppc
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1094 2011/07/08 22:44:16 ajacoutot Exp $
d2315 1
a2315 2
	echo "*** It will not build on vax and"; \
	echo "*** will be a pain to build on sparc."; \
@


1.1094
log
@Move sparc from GCC2_ARCHS to GCC4_ARCHS.

"sounds like a good plan to me" sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1093 2011/07/08 05:17:40 naddy Exp $
d134 1
a134 1
	mvme68k mvme88k mvmeppc palm sgi socppc sparc sparc64 vax zaurus
d139 3
a141 4
GCC4_ARCHS = amd64 i386 hppa loongson macppc mips64 mips64el mvmeppc powerpc \
	sgi socppc sparc sparc64
GCC3_ARCHS = alpha arm armish beagle gumstix hppa64 \
	landisk palm sh zaurus
@


1.1093
log
@treat .tgz like .tar.gz for extraction and don't rely on the fallback
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1092 2011/07/05 15:11:20 sthen Exp $
d140 1
a140 1
	sgi socppc sparc64
d143 1
a143 1
GCC2_ARCHS = aviion luna88k m68k m88k mac68k mvme68k mvme88k sparc vax
@


1.1092
log
@Add infrastructure for ccache in port builds.
"now is probably a good time to commit" espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1091 2011/06/26 14:40:21 espie Exp $
d1238 1
a1238 1
EXTRACT_CASES += *.tar.gz) \
@


1.1091
log
@expose print-package-args and friends
create an all-lib-depends-args target that's ways less hackish
than _print-plist-with-extra-depends
for port-lib-depends-check
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1090 2011/06/24 14:44:05 espie Exp $
d402 11
d906 1
d910 3
d1823 3
d2298 7
@


1.1090
log
@clean-up
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1089 2011/06/24 14:34:15 espie Exp $
d1384 1
d1709 2
a1710 2
	if deps=`SUBPACKAGE=${_S} _wantlib_args=_wantlib-args \
			${MAKE} _print-package-args` && \
d2052 1
a2052 1
	@@-SUBPACKAGE=${_S} ${MAKE} _print-plist-with-extra-depends | \
d2631 1
a2631 1
	if a=`SUBPACKAGE=${SUBPACKAGE} ${MAKE} _print-package-args`; \
a2638 16
# XXX this helps for port-lib-depends-check
# create "extra" depends lines that correspond to LIB_DEPENDS that would
# be stripped because there is no lib depending on them in WANTLIB

_print-plist-with-extra-depends:
.if ${NO_SHARED_LIBS:L} != "yes"
.  for _i in ${LIB_DEPENDS${SUBPACKAGE}}
	@@echo '${_i}'|{ \
		${_parse_spec}; \
		${_complete_pkgspec}; \
		echo "@@depend $$subdir:$$pkg:$$default"; \
	}
.  endfor
.endif
	@@${_MAKE} print-plist-with-depends

d2649 1
a2649 1
	if a=`SUBPACKAGE=${_S} ${MAKE} _print-package-args`; \
d3054 1
a3054 1
_print-package-args: _run-depends-args
d3057 1
a3057 1
_print-package-args: _lib-depends-args ${wantlib_args}
d3060 1
a3060 1
_run-depends-args:
d3069 12
d3082 1
a3082 1
_lib-depends-args wantlib-args port-wantlib-args fake-wantlib-args:
d3085 1
a3085 1
_lib-depends-args:
d3112 2
a3113 2
	${MAKE} _port-wantlib-args >$$a && \
	${MAKE} _fake-wantlib-args >$$b; \
d3469 1
a3469 1
	_list-port-libs _print-package-args _print-package-signature-lib \
d3483 2
a3484 2
	lock unlock _print-plist-with-extra-depends \
	_run-depends-args _lib-depends-args wantlib-args \
@


1.1089
log
@optimize newwantlib:

- if _DEPRUNLIB is empty, there's no need for any computation since the
result will be empty.

- zap the loop on _LIB4* for port-wantlib-args, as run-dir-depends already
grabs them.

- expose wantlib_args and corresponding targets for pkg_create to take
advantage of.

- add a dirty way for developers to waive the fake vs. ports check (PLEASE
use with EXTRA CAUTION).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1088 2011/06/23 22:03:15 espie Exp $
a652 2
_P_WANTLIB_COOKIE =	${WRKDIR}/.portstree-${FULLPKGNAME${SUBPACKAGE}}
_I_WANTLIB_COOKIE =	${WRKDIR}/.installed-${FULLPKGNAME${SUBPACKAGE}}
a660 1
	${_P_WANTLIB_COOKIE} ${_I_WANTLIB_COOKIE} \
@


1.1088
log
@turns out WKRDIR is not quite as constant as I wished...
found out by naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1087 2011/06/23 21:49:18 espie Exp $
d1379 9
a1387 1
_wantlib_args ?= _port-wantlib-args
d3075 1
a3075 1
_print-package-args: _lib-depends-args ${_wantlib_args}
d3087 4
d3092 1
a3092 1
.for _i in ${LIB_DEPENDS${SUBPACKAGE}}
d3113 1
a3113 1
.endfor
d3115 1
a3115 1
_wantlib-args:
d3131 2
a3132 10
_port-wantlib-args:
	@@if found=`{ for i in ${_LIB4${SUBPACKAGE}:QL}; do \
			echo "$$i"| { \
				${_parse_spec}; \
				if ! eval $$toset ${MAKE} print-plist-libs; \
				then \
					echo 1>&2 "Problem with dependency $$i"; \
					exit 1; \
				fi; }; \
			done; \
d3152 1
a3152 1
_fake-wantlib-args:
d3170 3
d3490 2
a3491 2
	_run-depends-args _lib-depends-args _wantlib-args \
	_port-wantlib-args _fake-wantlib-args
@


1.1087
log
@decent error message
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1086 2011/06/21 17:11:45 espie Exp $
d3104 5
a3108 3
	@@${_MAKE} _port-wantlib-args >${_P_WANTLIB_COOKIE}
	@@${_MAKE} _fake-wantlib-args >${_I_WANTLIB_COOKIE}
	@@if cmp -s ${_P_WANTLIB_COOKIE} ${_I_WANTLIB_COOKIE}; \
d3110 2
a3111 1
		cat ${_P_WANTLIB_COOKIE}; \
d3115 1
a3115 1
		diff 1>&2 -u ${_P_WANTLIB_COOKIE} ${_I_WANTLIB_COOKIE}; \
@


1.1086
log
@oops
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1085 2011/06/21 17:04:32 espie Exp $
d1353 2
@


1.1085
log
@save the wantlibs into files before comparison and give a more useful
error message. This was always intended, I wanted to make things work
before making them beautiful.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1084 2011/06/15 16:31:11 espie Exp $
a3103 1
	@@echo zoinx >>${_I_WANTLIB_COOKIE}
@


1.1084
log
@zap old legacy compat with old depends with lots of leading :::
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1083 2011/06/15 16:29:48 espie Exp $
d653 2
d663 1
d3102 4
a3105 2
	@@a=`${_MAKE} _port-wantlib-args`; b=`${_MAKE} _fake-wantlib-args`; \
	if test "X$$a" = "X$$b"; \
d3107 1
a3107 1
		echo $$a; \
d3109 3
a3111 2
		echo 1>&2 "Error: packing-lists and reality don't match"; \
		echo 1>&2 "Compare make _port-wantlib-args _fake-wantlib-args"; \
@


1.1083
log
@fix some limitations of _print-package-args
* cut it into separate targets for readability and better testing
* filter libraries more efficiently
* use internal variable for resolve-lib

create two targets for solving wantlib: one (_fake-wantlib-args) which uses
the information under the fake directory and installed packages, and another
(_port-wantlib-args) which walks packing-lists. The second one can be used
to collect meta-info even when nothing is installed, and thus provide better
package-signature accuracy, or help with lib-depends-check.
The first one uses what's actually in place when a package is built.
For now, we're paranoid and use both when building a package, erroring out
if they don't match, even though _port-wantlib-args is somewhat slower.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1082 2011/06/01 16:04:12 ajacoutot Exp $
d1432 1
a1432 1
${_v}_DEPENDS := ${${_v}_DEPENDS:S/^://:S/^://:C,^([^:]+/[^:<=>]+)([<=>][^:]+)$,STEM-\2:\1,}
d1439 1
a1439 1
${_v}_DEPENDS${_s} := ${${_v}_DEPENDS${_s}:S/^://:S/^://:C,^([^:]+/[^:<=>]+)([<=>][^:]+)$,STEM-\2:\1,}
@


1.1082
log
@Punctuation in the xz WARNING.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1081 2011/06/01 12:04:06 espie Exp $
d1368 2
d1372 1
a1372 3
_noshared = -noshared
.else
_noshared =
d1374 5
d1382 1
a1382 3
		LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} \
			${_PERLSCRIPT}/resolve-lib \
				${_noshared} $$d` \
d1698 2
a1699 1
	if deps=`SUBPACKAGE=${_S} ${MAKE} _print-package-args` && \
d1967 13
a1979 15
	@@libs=`for i in ${_LIB4:QL}; do echo "$$i"| { \
		${_parse_spec}; \
		eval $$toset ${MAKE} print-plist-libs; \
		}; \
		done;`; \
	listlibs="echo $$libs; echo ${LOCALBASE}/lib/lib* /usr/lib/lib* ${X11BASE}/lib/lib*"; \
	for d in ${_DEP${_m}LIBS:QL}; do \
		case "$$d" in \
		/*) listlibs="$$listlibs $${d%/*}/lib*";; \
		*/*) listlibs="$$listlibs ${DEPBASE}/$${d%/*}/lib*";; \
		esac; \
	done; \
	if found=`eval $$listlibs 2>/dev/null| \
		LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} \
		${_PERLSCRIPT}/resolve-lib ${_noshared} ${_DEP${_m}LIBS:QL}`; then \
d2667 1
a2667 1
	@@${_plist_header}; ${_PKG_CREATE} -n -Q ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}|${_grab_libs_from_plist};${_plist_footer}
d3059 7
a3065 1
_print-package-args:
d3073 3
a3075 2
.if ${NO_SHARED_LIBS:L} != "yes"
.  for _i in ${LIB_DEPENDS${SUBPACKAGE}}
d3096 32
a3127 4
.  endfor
	@@libs=`for i in ${_LIB4${SUBPACKAGE}:QL}; do echo "$$i"| { \
		${_parse_spec}; \
		if ! eval $$toset ${MAKE} print-plist-libs; \
d3129 6
a3134 1
			echo 1>&2 "Problem with dependency ${_i}"; \
d3136 9
a3144 15
		fi; }; \
		done;`; \
	listlibs="echo $$libs; echo ${LOCALBASE}/lib/lib* /usr/lib/lib* ${X11BASE}/lib/lib*"; \
	for d in ${_DEPRUNLIBS:QL}; do \
		case "$$d" in \
		/*) listlibs="$$listlibs $${d%/*}/lib*";; \
		*/*) listlibs="$$listlibs ${LOCALBASE}/$${d%/*}/lib*";; \
		esac; \
	done; \
	if found=`eval $$listlibs 2>/dev/null| \
		LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} \
		${_PERLSCRIPT}/resolve-lib ${_noshared} ${_DEPRUNLIBS:QL}`; then \
		for k in $$found; do \
			case $$k in *.a) ;; \
			*) echo "-W $$k";; \
d3146 10
a3155 6
		done; \
	else \
		echo 1>&2 "Can't resolve libspec"; \
		exit 1; \
	fi
.endif
d3191 1
a3191 1
	@@echo $$LIST_LIBS| LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} ${_PERLSCRIPT}/resolve-lib ${_DEPRUNLIBS:QL}
d3472 3
a3474 1
	lock unlock _print-plist-with-extra-depends
@


1.1081
log
@initial support of xz, to be polished.
most important part is nagging the user that this WILL not build on
some architectures and be very inconvenient on some others.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1080 2011/05/16 23:40:24 espie Exp $
d2278 2
a2279 2
	echo "*** so it won't build on vax."; \
	echo "*** and it will be a pain to build on sparc."; \
@


1.1080
log
@dpb -f will need  FETCH_MANUALL to tell people to fetch those
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1079 2011/04/23 08:25:50 kili Exp $
d1186 3
d1193 1
d1202 5
d2275 7
@


1.1079
log
@Fix missing quote around $$pkg.

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1078 2011/04/16 12:21:44 espie Exp $
d106 1
a106 1
	CHECKSUM_FILE
@


1.1078
log
@prefer the V- version for non-MULTI_PACKAGES vars.
fixes E on libf2c-old on i386.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1077 2011/04/16 10:31:20 espie Exp $
d1916 1
a1916 1
				if ${PKG_INFO} ${PKGDB_LOCK} -q -r $$pkg $$list; \
@


1.1077
log
@redo the IGNORE dance in a smarter way:
derive IGNORE-sub from IGNORE, and then test IGNORE-sub

Define complete value for IGNORE very late, _MULTI_PACKAGES trimming only
requires subpackage-specific info.

fix bug in describe, correctly differentiate  between empty and !defined
ONLY_FOR_ARCHS.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1076 2011/04/10 17:55:41 jasper Exp $
d3352 3
a3354 1
.   if defined(${_v})
@


1.1076
log
@remove USE_MOTIF bits

ok aja@@ sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1075 2011/04/03 07:19:05 espie Exp $
d444 3
d449 1
a449 1
_ARCH_OK${_s} = 0
d452 1
a452 1
_ARCH_OK${_s} = 1
d455 7
a461 2
.  else
_ARCH_OK${_s} = 1
d466 1
a466 1
_ARCH_OK${_s} = 0
d473 1
a473 1
.  if ${_ARCH_OK${_s}} == 1
d1312 16
a1327 20
.for _s in ${MULTI_PACKAGES}
IGNORE${_s} ?=
.  if defined(IS_INTERACTIVE) && defined(BATCH)
IGNORE${_s} += "is an interactive port"
.  elif !defined(IS_INTERACTIVE) && defined(INTERACTIVE)
IGNORE${_s} += "is not an interactive port"
.  endif
.  if !exists(${X11BASE})
IGNORE${_s} += "building ports requires X11 but ${X11BASE} not found"
.  endif
.  if !defined(_ARCH_OK${_s}) || ${_ARCH_OK${_s}} == 0
.    if defined(ONLY_FOR_ARCHS${_s})
.      if ${MACHINE_ARCH} == "${ARCH}"
IGNORE${_s} += "is only for ${ONLY_FOR_ARCHS${_s}}, not ${MACHINE_ARCH}"
.      else
IGNORE${_s} += "is only for ${ONLY_FOR_ARCHS${_s}}, not ${MACHINE_ARCH} \(${ARCH}\)"
.      endif
.    else
IGNORE${_s} += "is not for ${NOT_FOR_ARCHS}"
.    endif
d1329 2
a1330 14
.  if ${SHARED_ONLY:L} == "yes" && ${NO_SHARED_LIBS:L} == "yes"
IGNORE${_s} += "requires shared libraries"
.  endif

.  if ${TRY_BROKEN:L} != "yes"
.    if defined(BROKEN-${ARCH})
IGNORE${_s} += "is marked as broken for ${ARCH}: ${BROKEN-${ARCH}:Q}"
.    endif
.    if ${MACHINE_ARCH} != ${ARCH} && defined(BROKEN-${MACHINE_ARCH})
IGNORE${_s} += "is marked as broken for ${MACHINE_ARCH}: ${BROKEN-${MACHINE_ARCH}:Q}"
.    endif
.    if defined(BROKEN) 
IGNORE${_s} += "is marked as broken: ${BROKEN:Q}"
.    endif
d1332 2
a1333 2
.  if defined(COMES_WITH)
IGNORE${_s} += "-- ${FULLPKGNAME${SUBPACKAGE}:C/-[0-9].*//g} comes with OpenBSD as of release ${COMES_WITH}"
d1335 4
a1338 1
.endfor
a1339 1
IGNORE = ${IGNORE${SUBPACKAGE}}
d1341 1
a1341 1
.if !empty(IGNORE) && ${IGNORE_IS_FATAL:L} == "yes"
d1343 1
a1343 1
ERRORS += ${IGNORE}
d1998 1
a1998 1
.if !empty(IGNORE) && !defined(NO_IGNORE)
d2008 1
a2008 1
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} ${IGNORE}."
d2011 1
a2011 1
	@@echo "${IGNORE}" >${_IGNORE_COOKIE}
d2882 7
a2888 8
	@@case "${ONLY_FOR_ARCHS}" in \
	 "") case "${NOT_FOR_ARCHS}" in \
		 "") echo -n "any|";; \
		 *) echo -n "!${NOT_FOR_ARCHS}|";; \
		 esac;; \
	 *) echo -n "${ONLY_FOR_ARCHS}|";; \
	 esac

@


1.1075
log
@define IGNORE${SUBPACKAGE} for each SUBPACKAGE.
Prevents dpb from building subpackages that are NOT_FOR_ARCHS or
ONLY_FOR_ARCHS, as tested by quite a few porters.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1074 2011/03/28 00:16:13 fgsch Exp $
d116 1
a116 1
	SHARED_LIBS USE_MOTIF TARGETS \
a478 27
USE_MOTIF ?= No

.if ${USE_MOTIF:L} != "no"
.  if ${USE_MOTIF:L} == "lesstif"
LIB_DEPENDS += x11/lesstif
WANTLIB +=	Xm>=1
.  elif ${USE_MOTIF:L} == "openmotif"
LIB_DEPENDS += x11/openmotif
WANTLIB += Xm>=2
.  elif ${USE_MOTIF:L} == "any" || ${USE_MOTIF:L} == "yes"
FLAVORS += lesstif
.    if ${FLAVOR:L:Mlesstif} && ${FLAVOR:L:Mmotif}
ERRORS += "Fatal: choose motif or lesstif, not both."
.    endif
.    if ${FLAVOR:L:Mlesstif}
LIB_DEPENDS += x11/lesstif
WANTLIB +=	Xm>=1
.    else
LIB_DEPENDS += x11/openmotif
WANTLIB += Xm>=2
.    endif
.  else
ERRORS += "Fatal: Unknown USE_MOTIF=${USE_MOTIF} settings."
.  endif
MOTIFLIB = -L${DEPBASE}/lib -lXm
.endif

d693 1
a693 1
	MOTIFLIB='${MOTIFLIB}' CFLAGS='${CFLAGS:C/ *$//}' \
@


1.1074
log
@add repackage to the recursive targets.
with input and ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1073 2011/03/21 09:38:53 sthen Exp $
d95 1
a95 1
_ALL_VARIABLES = BUILD_DEPENDS IGNORE IS_INTERACTIVE \
d99 1
a99 1
	PKG_ARCH
a1322 1
IGNORE ?=
d1330 18
a1347 12
.if defined(IS_INTERACTIVE) && defined(BATCH)
IGNORE += "is an interactive port"
.elif !defined(IS_INTERACTIVE) && defined(INTERACTIVE)
IGNORE += "is not an interactive port"
.endif
.if !exists(${X11BASE})
IGNORE += "building ports requires X11 but ${X11BASE} not found"
.endif
.if !defined(_ARCH_OK${SUBPACKAGE}) || ${_ARCH_OK${SUBPACKAGE}} == 0
.  if defined(ONLY_FOR_ARCHS${SUBPACKAGE})
.    if ${MACHINE_ARCH} == "${ARCH}"
IGNORE += "is only for ${ONLY_FOR_ARCHS${SUBPACKAGE}}, not ${MACHINE_ARCH}"
d1349 1
a1349 1
IGNORE += "is only for ${ONLY_FOR_ARCHS${SUBPACKAGE}}, not ${MACHINE_ARCH} \(${ARCH}\)"
a1350 2
.  else
IGNORE += "is not for ${NOT_FOR_ARCHS}"
d1352 3
a1354 4
.endif
.if ${SHARED_ONLY:L} == "yes" && ${NO_SHARED_LIBS:L} == "yes"
IGNORE += "requires shared libraries"
.endif
d1356 10
a1365 3
.if ${TRY_BROKEN:L} != "yes"
.  if defined(BROKEN-${ARCH})
IGNORE += "is marked as broken for ${ARCH}: ${BROKEN-${ARCH}:Q}"
d1367 2
a1368 2
.  if ${MACHINE_ARCH} != ${ARCH} && defined(BROKEN-${MACHINE_ARCH})
IGNORE += "is marked as broken for ${MACHINE_ARCH}: ${BROKEN-${MACHINE_ARCH}:Q}"
d1370 1
a1370 7
.  if defined(BROKEN) 
IGNORE += "is marked as broken: ${BROKEN:Q}"
.  endif
.endif
.if defined(COMES_WITH)
IGNORE += "-- ${FULLPKGNAME${SUBPACKAGE}:C/-[0-9].*//g} comes with OpenBSD as of release ${COMES_WITH}"
.endif
d1372 1
@


1.1073
log
@adjust the BUILD_DEPENDS for USE_GROFF to require 1.21; ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1072 2011/03/20 19:28:07 espie Exp $
d3442 1
a3442 1
	regress-depends repackage run-depends run-depends-list show-required-by \
@


1.1072
log
@allow things to proceed after flavor_fragment in SUBDIR handling.
Also puts the FULLPKGPATH in extra_msg to figure out where bad dependencies
come from
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1071 2011/01/16 20:36:49 ajacoutot Exp $
d569 1
a569 1
BUILD_DEPENDS += textproc/groff>=1.15.4.7p2
@


1.1071
log
@Make clean=plist consistent with the other clean targets, do not error
out if the plistdb directory does not exist.

ok jasper@@ espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1070 2011/01/10 12:59:36 espie Exp $
d1636 1
a1636 1
	extra_msg="(DEPENDS was $$pkg $$subdir $$target)"; \
@


1.1070
log
@pass an extra -q to pkg_info -r... that way, we can have "the human version"
be more verbose...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1069 2011/01/09 13:07:53 espie Exp $
d2794 3
a2796 1
	cd ${_d} && rm -f ${PKGNAMES}
@


1.1069
log
@allow BUILD_DEPENDS = somepath>=version:patch

THIS REQUIRES A pkg_info WITH THE -r OPTION, e.g., current !
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1068 2011/01/04 21:54:36 espie Exp $
d1945 1
a1945 1
				if ${PKG_INFO} ${PKGDB_LOCK} -r $$pkg $$list; \
@


1.1068
log
@totally forgot about PATCHFILES
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1067 2010/12/20 13:05:40 espie Exp $
d1944 10
a1953 1
				break; \
@


1.1067
log
@pass PORTSDIR to pkg_create so that it can check more things
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1066 2010/12/14 11:37:38 espie Exp $
d103 1
a103 1
_ALL_VARIABLES += DISTFILES SUPDISTFILES DIST_SUBDIR MASTER_SITES \
@


1.1066
log
@- pass PORTSDIR for libtool, since people seem to want to stuff their
ports tree in weird places.
- show CHECKSUM_FILES if DPB=fetch or better.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1065 2010/12/07 11:26:37 espie Exp $
d1716 2
a1717 1
		${SUDO} ${_PKG_CREATE} $$deps ${PKG_ARGS${_S}} $$tmp && \
@


1.1065
log
@dpb does not need EPOCH + REVISION
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1064 2010/11/25 18:06:37 espie Exp $
d105 2
a106 1
	MASTER_SITES5 MASTER_SITES6 MASTER_SITES7 MASTER_SITES8 MASTER_SITES9
d395 1
@


1.1064
log
@show the old-style depend.
fix :configure depends for versions.
move PKGSPEC to !dpb dump-vars
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1063 2010/11/23 18:34:20 espie Exp $
d99 1
a99 1
	PKG_ARCH EPOCH REVISION
d121 2
a122 1
	PERMIT_PACKAGE_FTP PERMIT_PACKAGE_CDROM WANTLIB CATEGORIES DESCR
@


1.1063
log
@fix quoting (spotted by jeremy@@), make old style depends an error
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1062 2010/11/20 19:57:59 espie Exp $
d99 1
a99 1
	PKG_ARCH EPOCH REVISION PKGSPEC
d120 1
a120 1
	ONLY_FOR_ARCHS NOT_FOR_ARCHS \
d1436 1
a1436 1
ERRORS += "Fatal: old style depends"
d1447 3
@


1.1062
log
@tweak where stem-* is computed, to be documented and used later
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1061 2010/11/16 19:26:18 espie Exp $
d1435 3
d1860 1
a1860 1
	@@echo ${PKGSPEC${SUBPACKAGE}}
@


1.1061
log
@small tweaks:
 compute _CHECK_DEPENDS earlier
 set extra_msg to have flavor_fragment show something better than empty
directories
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1060 2010/11/16 09:39:45 espie Exp $
d99 1
a99 1
	PKG_ARCH EPOCH REVISION
d597 2
d630 1
a1620 1
_version2default = sed -e 's,-[0-9].*,-*,'
d1638 1
a1638 1
_set_pkg2default= pkg=`echo $$default|${_version2default}`
d1856 3
d1895 1
a1895 1
			if default=`eval $$toset ${MAKE} _print-packagename`; \
a1896 2
				${_set_pkg2default}; \
			else \
d3422 1
a3422 1
	subpackage uninstall mirror-maker-fetch \
@


1.1060
log
@missed _print-plist-with-extra-depends, noticed by jasper@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1059 2010/11/16 09:16:26 espie Exp $
d1424 8
a1439 1
_CHECK_DEPENDS +:= ${${_v}_DEPENDS}
a1443 1
_CHECK_DEPENDS +:= ${${_v}_DEPENDS${_s}}
d1625 1
a1866 1
		extra_msg="(DEPENDS ${_i})"; \
@


1.1059
log
@most abreviated format for depends. there's a consensus that it's good,
and it works.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1058 2010/11/14 11:17:36 espie Exp $
d2031 1
a2031 1
	-@@SUBPACKAGE=${_S} ${MAKE} _print-plist-with-extra-depends | \
d2619 3
a2621 10
		IFS=:; read dep pkg subdir target; \
		${_flavor_fragment}; \
		if default=`eval $$toset ${MAKE} _print-packagename`; then \
			case "X$$pkg" in X) pkg=`echo "$$default" |${_version2default}`;; \
			esac; \
			echo "@@depend $$subdir:$$pkg:$$default"; \
		else \
			echo 1>&2 "Problem with dependency ${_i}"; \
			exit 1; \
		fi; \
@


1.1058
log
@revamp the way dependencies work
- strip extra : at start of depends (old LIB_DEPENDS are gone, right)
- rely on the fact, :extra is only patch|configure|build for any depends.
- use _parse_pkgspec to do things intelligently.
- _set_stem2default to handle STEM-*.

- switch internal stuff to new style.

This is backwards compatible. But this does require -current dpb, -current
sqlports, and -current pkg_add to work !
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1057 2010/11/11 19:03:25 espie Exp $
d566 1
a566 1
BUILD_DEPENDS += groff->=1.15.4.7p2:textproc/groff
d1426 5
d1433 1
a1433 1
${_v}_DEPENDS := ${${_v}_DEPENDS:S/^://:S/^://}
d1438 1
a1438 1
${_v}_DEPENDS${_s} := ${${_v}_DEPENDS${_s}:S/^://:S/^://}
@


1.1057
log
@all old LIB_DEPENDS=libspec:pkg:path should be gone, so the warning becomes
an error.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1056 2010/11/11 12:38:51 espie Exp $
d379 1
a379 1
BUILD_DEPENDS += ::devel/gmake
d390 1
a390 1
BUILD_DEPENDS += ::devel/libtool
d480 2
a481 2
LIB_DEPENDS += ::x11/lesstif
WANTLIB +=	Xm.>=1
d483 2
a484 2
LIB_DEPENDS += ::x11/openmotif
WANTLIB += Xm.>=2
d491 2
a492 2
LIB_DEPENDS += ::x11/lesstif
WANTLIB +=	Xm.>=1
d494 2
a495 2
LIB_DEPENDS += ::x11/openmotif
WANTLIB += Xm.>=2
d566 1
a566 1
BUILD_DEPENDS += :groff->=1.15.4.7p2:textproc/groff
d1212 1
a1212 1
BUILD_DEPENDS += :unzip-*:archivers/unzip
d1217 1
a1217 1
BUILD_DEPENDS += :bzip2-*:archivers/bzip2
d1422 16
d1443 1
a1443 1
_BUILDLIB_DEPENDS += ${LIB_DEPENDS${_s}:N*\:${_path}:N*\:${_path},*}
d1445 1
a1445 1
_LIB4${_s} = ${LIB_DEPENDS${_s}:M*\:${_path}} ${LIB_DEPENDS${_s}:M*\:${_path},*}
d1451 5
a1455 5
_BUILD_DEPLIST = ${BUILD_DEPENDS:S/^://}
_RUN_DEPLIST = ${RUN_DEPENDS${SUBPACKAGE}:S/^://}
_REGRESS_DEPLIST = ${REGRESS_DEPENDS:S/^://}
_BUILDLIB_DEPLIST = ${_BUILDLIB_DEPENDS:C/^[^:]*://}
_RUNLIB_DEPLIST = ${LIB_DEPENDS${SUBPACKAGE}:C/^[^:]*://}
d1457 1
d1461 1
d1465 1
a1465 1
_DEP${_DEP}_COOKIES += ${WRKDIR}/.dep${_i:C,[|:/<=>*],-,g}
d1495 1
a1495 1
# Only keep pkg:dir spec
d1497 3
a1499 2
_BUILD_DEP2 = ${BUILD_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_BUILD_DEP3 = ${BUILD_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d1501 2
a1502 2
_RUN_DEP2 = ${RUN_DEPENDS${SUBPACKAGE}:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_RUN_DEP3 = ${RUN_DEPENDS${SUBPACKAGE}:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d1504 1
a1504 1
_REGRESS_DEP2 = ${REGRESS_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d1506 2
a1507 2
.if ${NO_SHARED_LIBS:L} != "yes"
_RUN_DEP2 += ${LIB_DEPENDS${SUBPACKAGE}:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d1509 1
a1509 2
_DEPRUNLIBS = ${LIB_DEPENDS${SUBPACKAGE}:C/:.*//:S/,/ /g}
.else
d1511 13
a1523 2
_DEPRUNLIBS =
.endif
d1525 1
a1525 2
_BUILD_DEP2 += ${_BUILDLIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_DEPBUILDLIBS = ${_BUILDLIB_DEPENDS:C/:.*//:S/,/ /g}
d1527 2
a1528 2
_DEPBUILDLIBS += ${_BUILDWANTLIB}
_DEPRUNLIBS += ${WANTLIB${SUBPACKAGE}}
d1534 1
a1534 1
.  for i in ${_DEPBUILDLIBS:C,[|:/<=>*],-,g}
d1538 1
a1538 1
.  for i in ${_DEPRUNLIBS:C,[|:/<=>*],-,g}
d1549 4
a1552 13
_BUILD_DEP = ${_BUILD_DEP2:C/[^:]*://}
_RUN_DEP = ${_RUN_DEP2:C/[^:]*://}
_REGRESS_DEP = ${_REGRESS_DEP2:C/[^:]*://}

.for _S in ${MULTI_PACKAGES}
_BUILD_DEP3${_S} = ${_BUILD_DEP3}
_RUN_DEP3${_S} = ${RUN_DEPENDS${_S}:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
.  if ${NO_SHARED_LIBS:L} != "yes"
_LIB_DEP3${_S} = ${LIB_DEPENDS${_S}}
.  else
_LIB_DEP3${_S} =
.  endif
.endfor
d1606 1
d1612 23
a1688 5
.  if ${LIB_DEPENDS${_S}:M?*\:*\:*}
	@@${ECHO_MSG} "Error: Old style LIB_DEPENDS:"
	@@${ECHO_MSG} "LIB_DEPENDS${_S} = ${LIB_DEPENDS${_S}}"
	@@exit 1
.  endif
d1850 2
a1851 2
.  if !target(${WRKDIR}/.dep${_i:C,[|:/<=>*],-,g})
${WRKDIR}/.dep${_i:C,[|:/<=>*],-,g}: ${_WRKDIR_COOKIE}
d1854 1
a1854 1
		IFS=:; read pkg subdir target; \
d1856 1
a1856 1
		${_flavor_fragment}; defaulted=false; checkinstall=true; \
d1877 3
a1879 2
		case "X$$pkg" in X) \
			if pkg=`eval $$toset ${MAKE} _print-packagename`; \
d1881 1
a1881 2
				defaulted=true; \
				pkg=`echo $$pkg|${_version2default}`; \
d1886 7
a1892 1
			fi;; esac; \
d1951 1
a1951 2
		IFS=:; read dep pkg subdir target; \
		${_flavor_fragment}; \
d3042 1
d3046 3
a3048 10
		IFS=:; read dep pkg subdir target; \
		${_flavor_fragment}; \
		if default=`eval $$toset ${MAKE} _print-packagename`; then \
			case "X$$pkg" in X) pkg=`echo $$default|${_version2default}`;; \
			esac; \
			echo "-P $$subdir:$$pkg:$$default"; \
		else \
			echo 1>&2 "Problem with dependency ${_i}"; \
			exit 1; \
		fi; \
d3054 14
a3067 4
		IFS=:; read dep pkg subdir target; \
		${_flavor_fragment}; \
		if default=`eval $$toset ${MAKE} _print-packagename`; then \
			case "X$$pkg" in X) pkg=`echo "$$default" |${_version2default}`;; \
d3069 3
a3071 31
			libs=`eval $$toset ${MAKE} print-plist-libs`; \
			needed=false; \
			IFS=,; for d in $$dep; do \
 				${_libresolve_fragment}; \
 				case "$$check" in \
				*.a) continue;; \
				Failed) \
					echo 1>&2 "Can't resolve libspec $$d (for ${_i} in ${SUBPACKAGE})"; \
					exit 1;; \
 				*) \
					needed=true;; \
				esac; \
			done; \
			exec 3>&2; \
			unset IFS; for d in ${_DEPRUNLIBS:QL}; do \
				if $$needed; then continue; fi; \
				exec 2>/dev/null; \
				${_libresolve_fragment}; \
				case "$$check" in \
				*.a|Failed) \
					continue;; \
				*) \
					needed=true;; \
				esac; \
			done; \
			exec 2>&3; \
			if $$needed; then echo "-P $$subdir:$$pkg:$$default"; fi; \
		else \
			echo 1>&2 "Problem with dependency ${_i}"; \
			exit 1; \
		fi; \
d3075 1
a3075 2
		IFS=:; read dep pkg subdir target; \
		${_flavor_fragment}; \
d3130 2
a3131 3
		IFS=:; read dep pkg subdir target; \
		${_flavor_fragment}; \
		default=`eval $$toset ${MAKE} _print-packagename`; \
d3140 2
a3141 3
		IFS=:; read dep pkg subdir target; \
		${_flavor_fragment}; \
		default=`eval $$toset ${MAKE} _print-packagename`; \
@


1.1056
log
@"fake" extra @@depend lines for LIB_DEPENDS in port-lib-depends-check, so
that they show up even if there's no WANTLIB for them yet
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1055 2010/11/09 23:55:28 espie Exp $
d1647 1
a1647 1
	@@${ECHO_MSG} "WARNING: Old style LIB_DEPENDS:"
d1649 1
@


1.1055
log
@oops. noticed by sthen@@/jasper@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1054 2010/11/09 11:18:47 espie Exp $
d1982 1
a1982 1
	-@@SUBPACKAGE=${_S} ${MAKE} print-plist-with-depends | \
d2562 23
d3399 1
a3399 1
	lock unlock
@


1.1054
log
@trap does not exit, avoid unlocking twice, even though it's harmless
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1053 2010/11/07 00:03:38 espie Exp $
d2164 1
a2164 1
	${_DO_LOCK}; cd ${.CURDIR} && ${MAKE} _internal-${_t}
@


1.1053
log
@- add check-register, that basically does print-plist
- switch motif to WANTLIB
- start warning about old style LIB_DEPENDS. It's time !
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1052 2010/10/28 22:39:44 sthen Exp $
d1571 1
a1571 1
	${_LOCK}; trap '${_UNLOCK}' 0 1 2 3 13 15
d2164 1
a2164 1
	@@${_DO_LOCK}; cd ${.CURDIR} && ${MAKE} _internal-${_t}
@


1.1052
log
@Let pkg/README-subpackage work, before this we looked for README--subpackage.
ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1051 2010/10/28 21:09:52 jasper Exp $
d480 2
a481 1
LIB_DEPENDS += Xm.>=1::x11/lesstif
d483 2
a484 1
LIB_DEPENDS += Xm.>=2::x11/openmotif
d491 2
a492 1
LIB_DEPENDS += Xm.>=1::x11/lesstif
d494 2
a495 1
LIB_DEPENDS += Xm.>=2::x11/openmotif
d1597 16
d1646 4
@


1.1051
log
@- remove "suspicious empty line" emacs whines about
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1050 2010/10/28 14:26:36 espie Exp $
d2487 1
a2487 1
	@@if test -e ${PKGDIR}/README-${_s}; then \
d2489 2
a2490 2
		echo "Installing ${PKGDIR}/README-${_s} as $$r"; \
		${SUDO} ${SUBST_CMD} -o ${SHAREOWN} -g ${SHAREGRP} -c ${PKGDIR}/README-${_s} $$r; \
@


1.1050
log
@give readmes to SHAREOWN/SHAREGRP
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1049 2010/10/28 11:14:23 espie Exp $
d2502 1
a2502 1
			
@


1.1049
log
@turns out dpb doesn't need this in the end...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1048 2010/10/27 17:38:18 espie Exp $
d2483 1
a2483 1
		${SUDO} ${SUBST_CMD} -c ${PKGDIR}/README $$r; \
d2490 1
a2490 1
		${SUDO} ${SUBST_CMD} -c ${PKGDIR}/README-${_s} $$r; \
@


1.1048
log
@pass FULLPKGNAME to SUBST_VAR (impossible to do readmes otherwise)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1047 2010/10/27 14:34:33 espie Exp $
d96 1
a96 1
	SUBPACKAGE MULTI_PACKAGES FULLSUBDIR
@


1.1047
log
@tweak readme: say that we're installing something
put that into mtree (to be done in src as well)
install in LOCALBASE, independently from PREFIX (newer pkg_adds are happy
with @@cwd outside of PREFIX)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1046 2010/10/27 14:29:01 espie Exp $
d922 2
a923 1
	MAINTAINER ^BASE_PKGPATH ^LOCALBASE ^X11BASE ^TRUEPREFIX ^RCDIR
@


1.1046
log
@scaffolding for /etc/rc.d, okay robert@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1045 2010/10/26 17:04:20 espie Exp $
d520 1
a520 1
_README_DIR = ${PREFIX}/share/doc/pkg-readmes/
d2480 3
a2482 2
		${INSTALL_DATA_DIR} ${WRKINST}${_README_DIR}; \
		${SUDO} ${SUBST_CMD} -c ${PKGDIR}/README ${WRKINST}${_README_DIR}/${FULLPKGNAME}; \
d2487 3
a2489 2
		${INSTALL_DATA_DIR} ${WRKINST}${_README_DIR}; \
		${SUDO} ${SUBST_CMD} -c ${PKGDIR}/README-${_s} ${WRKINST}${_README_DIR}/${FULLPKGNAME${_s}}; \
@


1.1045
log
@also register pre/do module hooks as targets.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1044 2010/10/26 10:39:22 ajacoutot Exp $
d376 1
d922 1
a922 1
	MAINTAINER ^BASE_PKGPATH ^LOCALBASE ^X11BASE ^TRUEPREFIX
d2491 9
@


1.1044
log
@Add a MODFOO_pre-configure hook so that MODULES can add some steps at
pre-configure time even when a pre-configure target already exists.

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1043 2010/10/24 20:41:23 ajacoutot Exp $
d311 7
@


1.1043
log
@Bye bye USE_X11.
From now on, building ports requires X11BASE.

* lots of ports missed this variable (porters always have X11 installed)
  jasper made a first pass on fixing these, but no doubt it will drift
  away soon
* users should use packages
* people building ports should know what they are doing and having
  X11BASE as a requirement is perfectly reasonnable
* we are merging config.x11.site into config.site because of a stupid
  autofoo bug ; currently when USE_X11 is set, some ports may loose the
  ability to even load config.site

tested on a bulk by landry@@
ok robert@@ jasper@@ landry@@ sthen@@ naddy@@ "I won't cry if it dies" espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1042 2010/10/22 15:51:07 espie Exp $
d2338 5
@


1.1042
log
@insist on "latest" groff so that mdoc macros get pulled in.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1041 2010/10/18 08:32:21 espie Exp $
a277 1
USE_X11 ?= No
d1317 2
a1318 2
.if ${USE_X11:L} == "yes" && !exists(${X11BASE})
IGNORE += "uses X11, but ${X11BASE} not found"
@


1.1041
log
@pass FULLSUBDIR around, to eventually allow dpb to distinguish between
empty and default stuff.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1040 2010/10/02 10:25:21 espie Exp $
d555 1
a555 1
BUILD_DEPENDS += ::textproc/groff
@


1.1040
log
@new read-only variable TARGETS for introspection purpose (list of targets
specific to a given port, e.g, {pre,do,post}-*
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1039 2010/09/25 13:39:02 steven Exp $
d96 1
a96 1
	SUBPACKAGE MULTI_PACKAGES
@


1.1039
log
@if we are not using gnu libtool, it's not needed in build depends
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1037 2010/09/24 13:37:53 jasper Exp $
d115 1
a115 1
	SHARED_LIBS USE_MOTIF \
d305 10
@


1.1038
log
@- mips64(el) switched to gcc4

ok phessler@@
@
text
@a375 1
BUILD_DEPENDS += ::devel/libtool
@


1.1037
log
@- finally works as intended now
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1036 2010/09/24 13:13:46 espie Exp $
d137 2
a138 1
GCC4_ARCHS = amd64 i386 hppa macppc mvmeppc powerpc socppc sparc64
d140 1
a140 1
	landisk loongson mips64 mips64el palm sgi sh zaurus
@


1.1036
log
@clean-up "normal" dir even after cleaning flavors.
note that clean=flavors can't work with WRKOBJDIR set
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1035 2010/09/24 09:20:16 espie Exp $
d242 1
a242 1
_clean += work build flavors packages plist
@


1.1035
log
@works better when you put the test where it belongs
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1034 2010/09/22 18:43:30 landry Exp $
d2605 1
a2605 1
.  else
d2608 1
a2608 1
.   if !empty(WRKDIR_LINKNAME)
a2609 1
.   endif
@


1.1034
log
@Switch to steven@@/bernd@@'s perl libtool living under infrastructure/
by default for ports that set USE_LIBTOOL=Yes. Faster, better,
stronger, and cuts bulk builds time by ~15% in my tests on amd64.
Volunteers welcomed to fix the few USE_LIBTOOL=gnu users in the tree.
Report any oddities to ports@@...

'Go ahead' espie@@ 'Please proceed' steven@@
ok ajacoutot@@ jasper@@ phessler@@ sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1033 2010/09/21 15:18:03 sthen Exp $
d241 3
a251 3
.endif
.if ${_clean:L:Mall}
_clean += work build flavors packages plist
@


1.1033
log
@output EPOCH and REVISION in dump-vars, and use it in sqlports.
ok espie@@ (with a reminder to add EPOCH, my first diff just had REVISION).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1032 2010/09/13 11:04:31 espie Exp $
d374 1
a374 1
LIBTOOL ?= ${DEPBASE}/bin/libtool
@


1.1032
log
@basic support for READMEs, to be documented
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1031 2010/09/09 15:06:42 jasper Exp $
d98 2
a99 1
_ALL_VARIABLES_INDEXED = FULLPKGNAME RUN_DEPENDS LIB_DEPENDS PKG_ARCH
@


1.1031
log
@have clean=all zap builddir too. req'd by antoine
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1030 2010/09/06 12:06:29 jasper Exp $
d502 1
d2455 13
@


1.1030
log
@- add clean=all, which takes care of cleaning work, flavors, packages and plist.
just a shorthand for adding the above words to a list.

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1029 2010/08/31 19:30:43 sthen Exp $
d250 1
a250 1
_clean += work flavors packages plist
@


1.1029
log
@let port-lib-depends-check work with an alternative PORTSDIR;
debugged with Brad, better fix after a suggestion from espie@@
ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1028 2010/08/20 23:11:07 espie Exp $
d249 3
d254 1
a254 1
	readmes bulk force plist build
@


1.1028
log
@move LOCKDIR default to pkgpath.mk since it's shared with Makefile.
fix one missed dolock.

Thanks naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1027 2010/08/20 14:53:18 espie Exp $
d1920 1
a1920 1
_CHECK_LIB_DEPENDS = ${_PERLSCRIPT}/check-lib-depends
d1928 1
a1928 1
	@@PORTSDIR=${PORTSDIR} ${_CHECK_LIB_DEPENDS} ${_PACKAGE_COOKIE}
d1936 1
a1936 1
	 PORTSDIR=${PORTSDIR} ${_CHECK_LIB_DEPENDS} -s ${WRKINST}/.saved_libs
@


1.1027
log
@use scripts from their new locations
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1026 2010/08/07 19:41:21 espie Exp $
a1515 1
LOCKDIR ?= ${TMPDIR}/portslocks
@


1.1026
log
@turn on PLIST_DB by default, as discussed with landry/aja/sthen
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1025 2010/07/24 10:35:38 espie Exp $
d91 2
d946 1
a946 1
SUBST_CMD = perl ${PORTSDIR}/infrastructure/build/pkg_subst
d1365 1
a1365 1
			perl ${PORTSDIR}/infrastructure/build/resolve-lib \
d1517 1
a1517 1
LOCK_CMD ?= perl ${PORTSDIR}/infrastructure/build/dolock
d1873 2
a1874 2
		LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} perl \
		${PORTSDIR}/infrastructure/build/resolve-lib ${_noshared} ${_DEP${_m}LIBS:QL}`; then \
d1921 1
a1921 1
_CHECK_LIB_DEPENDS = perl ${PORTSDIR}/infrastructure/package/check-lib-depends
d2091 1
a2091 1
	${SUDO} perl ${PORTSDIR}/infrastructure/install/make-plist \
d2098 1
a2098 1
		/bin/sh ${PORTSDIR}/infrastructure/build/update-patches`; \
d2457 1
a2457 1
_register_plist = mkdir -p ${PLIST_DB:S/:/ /g} && perl ${PORTSDIR}/infrastructure/package/register-plist ${PLIST_DB}
d2645 1
a2645 1
		${MAKE} -f $$mk all FETCH=${PORTSDIR}/infrastructure/fetch/fetch-all
d2974 2
a2975 2
		LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} perl \
		${PORTSDIR}/infrastructure/build/resolve-lib ${_noshared} ${_DEPRUNLIBS:QL}`; then \
d2993 1
a2993 1
	@@perl ${PORTSDIR}/infrastructure/build/extract-dependencies ${FULLPKGPATH} <${_DEPENDS_CACHE}|while read subdir; do \
d3022 1
a3022 1
	@@echo $$LIST_LIBS| LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} perl ${PORTSDIR}/infrastructure/build/resolve-lib ${_DEPRUNLIBS:QL}
d3216 1
a3216 1
	@@cd ${PORTSDIR} && make all-dir-depends | perl ${PORTSDIR}/infrastructure/build/extract-dependencies -r ${_ALLPKGPATHS}
@


1.1025
log
@use new make feature :QL  for safer quoting.
helps getting past shell quoting errors, so that the infrastructure
will report actual trouble (is also simpler than :S/<...>/ for pkgspecs).

REQUIRES CURRENT MAKE TO WORK!!!
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1024 2010/07/21 17:11:48 steven Exp $
d155 1
a155 1
PLIST_DB ?=
@


1.1024
log
@pass COMPILER_VERSION in MAKE_ENV instead of USE_GCC3.
this removes the last instance of USE_GCC3 in ports.

from brad
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1022 2010/07/10 15:21:15 espie Exp $
d1857 1
a1857 1
	@@libs=`for i in ${_LIB4:S/>/\>/g:S/</\</g}; do echo "$$i"| { \
d1864 1
a1864 1
	for d in ${_DEP${_m}LIBS:S/>/\>/g}; do \
d1872 1
a1872 1
		${PORTSDIR}/infrastructure/build/resolve-lib ${_noshared} ${_DEP${_m}LIBS:S/>/\>/g}`; then \
d2936 1
a2936 1
			unset IFS; for d in ${_DEPRUNLIBS:S/>/\>/g}; do \
d2955 1
a2955 1
	@@libs=`for i in ${_LIB4${SUBPACKAGE}:S/>/\>/g:S/</\</g}; do echo "$$i"| { \
d2965 1
a2965 1
	for d in ${_DEPRUNLIBS:S/>/\>/g}; do \
d2973 1
a2973 1
		${PORTSDIR}/infrastructure/build/resolve-lib ${_noshared} ${_DEPRUNLIBS:S/>/\>/g}`; then \
d3020 1
a3020 1
	@@echo $$LIST_LIBS| LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} perl ${PORTSDIR}/infrastructure/build/resolve-lib ${_DEPRUNLIBS:S/>/\>/g}
@


1.1023
log
@Remove redundant variables OPSYS and OPSYS_VER.
OPSYS was always "OpenBSD", the ports tree doesn't cover other
operating systems.
OPSYS_VER was the same as OSREV.

ok espie@@
@
text
@d717 1
a717 1
MAKE_ENV += ELF_TOOLCHAIN=${ELF_TOOLCHAIN} USE_GCC3=${USE_GCC3} \
@


1.1022
log
@fix fix
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1021 2010/07/10 15:17:40 espie Exp $
a125 2
OPSYS = OpenBSD
OPSYS_VER = ${OSREV}
d1331 1
a1331 1
IGNORE += "-- ${FULLPKGNAME${SUBPACKAGE}:C/-[0-9].*//g} comes with ${OPSYS} as of release ${COMES_WITH}"
d2061 1
a2061 1
# Note: add @@comment PACKAGE(arch=${MACHINE_ARCH}, opsys=${OPSYS}, vers=${OPSYS_VER})
d2264 1
a2264 1
							*) ${ECHO_MSG} "===>   Applying ${OPSYS} patch $$i" ;; \
@


1.1021
log
@some recursive scenarios would break, let _ARCH_OK be undefined, catch it
later.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1020 2010/07/10 13:29:48 espie Exp $
d428 2
a430 1
_ARCH_OK${_s} ?= 1
d1306 1
a1306 1
.if !defined(${_ARCH_OK${SUBPACKAGE}}) || ${_ARCH_OK${SUBPACKAGE}} == 0
@


1.1020
log
@always define _ARCH_OK${SUBPACKAGE} (to 0 by default), so
that bsd.port.mk can rightfully complain about wrong subpackages.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1019 2010/07/10 09:11:10 espie Exp $
a436 2
# XXX
_ARCH_OK${SUBPACKAGE} ?= 0
d1305 1
a1305 1
.if ${_ARCH_OK${SUBPACKAGE}} == 0
@


1.1019
log
@new support for REVISION/EPOCH
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1018 2010/07/09 13:11:59 espie Exp $
d437 2
@


1.1018
log
@logic of ONLY_FOR_ARCHS was slightly broken: always define individual
PACKAGE_COOKIE, so that print-plist-contents keeps working.
Only the packaging part (e.g., PACKAGE_COOKIES) should be affected.
Alter PKGNAMES while we're there, as it's only used for debugging, and
it's better that way.

(fixes pkgmklocatedb)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1017 2010/07/08 20:48:39 espie Exp $
d404 4
d409 2
d412 1
a412 1
# ONLY_FOR_ARCHS is special, since it can be undefined
d551 1
d553 17
d585 16
d937 6
@


1.1017
log
@synch with src
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1016 2010/07/06 12:38:26 espie Exp $
d737 1
a737 1
.for _s in ${MULTI_PACKAGES}
d763 1
a763 1
.for _S in ${_MULTI_PACKAGES}
d767 7
a775 2
.  else
_PACKAGE_COOKIE${_S} = ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/all/${_PKGFILE${_S}}
@


1.1016
log
@make ONLY_FOR_ARCHS and NOT_FOR_ARCHS subpackage-dependent
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1015 2010/07/06 12:09:55 espie Exp $
d136 3
a138 4
GCC4_ARCHS = amd64 sparc64
GCC3_ARCHS = alpha arm armish beagle gumstix hppa hppa64 i386 \
	landisk loongson macppc mips64 mips64el mvmeppc palm powerpc sgi sh \
	socppc zaurus
@


1.1015
log
@print-plist-contents | grablibs appears often enough: combine them as
print-plist-libs
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1014 2010/07/06 12:02:35 espie Exp $
d106 1
a106 1
	ONLY_FOR_ARCHS NOT_FOR_ARCHS BROKEN COMES_WITH \
d117 1
d404 36
d578 1
a578 1
.for _S in ${MULTI_PACKAGES}
d764 1
a764 1
.for _S in ${MULTI_PACKAGES}
d1255 2
a1256 8
.if defined(ONLY_FOR_ARCHS)
_ARCH_OK = 0
.  for __ARCH in ${MACHINE_ARCH} ${ARCH}
.    if !empty(ONLY_FOR_ARCHS:M${__ARCH})
_ARCH_OK = 1
.    endif
.  endfor
.  if ${_ARCH_OK} == 0
d1258 1
a1258 1
IGNORE += "is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH}"
d1260 1
a1260 1
IGNORE += "is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH} \(${ARCH}\)"
d1262 1
a1262 10
.  endif
.endif
.if defined(NOT_FOR_ARCHS)
_ARCH_OK = 1
.  for __ARCH in ${MACHINE_ARCH} ${ARCH}
.    if !empty(NOT_FOR_ARCHS:M${__ARCH})
_ARCH_OK = 0
.    endif
.  endfor
.  if ${_ARCH_OK} == 0
d1348 1
a1348 1
.  for _s in ${MULTI_PACKAGES}
@


1.1014
log
@allow libspecs to come from current ports internal dependencies (even if
they're not installed yet)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1013 2010/07/06 11:50:57 espie Exp $
d1789 1
a1789 1
		eval $$toset ${MAKE} print-plist-contents|${_grab_libs_from_plist}; \
d2436 3
d2851 1
a2851 1
			libs=`eval $$toset ${MAKE} print-plist-contents|${_grab_libs_from_plist}`; \
d2887 1
a2887 1
		if ! eval $$toset ${MAKE} print-plist-contents|${_grab_libs_from_plist}; \
d2927 1
a2927 2
			eval $$toset ${MAKE} print-plist-contents | \
				${_grab_libs_from_plist}|tee $$fulldir; \
d2933 2
a2934 2
		eval $$toset ${MAKE} print-plist-contents ; \
	done | ${_grab_libs_from_plist}
@


1.1013
log
@explicitly document that the .spec files are just there to force reevaluation
of cookie during development
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1012 2010/07/06 11:27:38 espie Exp $
d1330 1
d1786 7
a1792 1
	@@listlibs="echo ${LOCALBASE}/lib/lib* /usr/lib/lib* ${X11BASE}/lib/lib*"; \
@


1.1012
log
@don't bother computing pkgname if all we want is the plist from the pkgpath
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1011 2010/07/05 09:00:28 espie Exp $
d1401 3
d1771 2
d1778 1
@


1.1011
log
@SUBST_CMD is not subpackage dependent, so don't.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1010 2010/07/05 08:58:09 espie Exp $
d2871 2
a2872 5
		if default=$$(eval $$toset ${MAKE} _print-packagename); then \
			case "X$$pkg" in X) pkg=$$(echo "$$default" |${_version2default});; \
			esac; \
			eval $$toset ${MAKE} print-plist-contents|${_grab_libs_from_plist}; \
		else \
@


1.1010
log
@some libs may be only static libs. we find them correctly, but passing these
as -W makes no sense.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1009 2010/07/04 17:26:14 espie Exp $
d853 5
a860 5
.endfor

PKG_ARGS${_S} += -DFULLPKGPATH=${FULLPKGPATH${_S}}
PKG_ARGS${_S} += -DPERMIT_PACKAGE_CDROM=${PERMIT_PACKAGE_CDROM${_S}:Q}
PKG_ARGS${_S} += -DPERMIT_PACKAGE_FTP=${PERMIT_PACKAGE_FTP${_S}:Q}
@


1.1009
log
@tweak the way LIB_DEPENDS and WANTLIB interact.
More precisely:
- for "older" libspec in LIB_DEPENDS, only compare them against
the libs from the LIB_DEPENDS.
- check LIB_DEPENDS against all libspecs for the package (both from WANTLIB
and LIB_DEPENDS) to turn them into LIB_DEPENDS.
- create a full list of installed libs and of 'inter-package' libraries to
solve all WANTLIB in one go.
This is actually faster than the old code, but a bit more complicated.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1008 2010/07/04 08:45:02 espie Exp $
d2890 5
a2894 1
		for k in $$found; do echo "-W $$k"; done; \
@


1.1008
log
@slightly cleaner logic structure for building packages.
In particular, create a tmp package until we're certain it is okay
(thanks to register-plist). -> remove race condition in dpb3, which
assumes a package existing is enough for it to proceed.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1007 2010/06/20 07:48:20 espie Exp $
d1290 1
a1290 5
	case "$$d" in \
	*/*) shdir="${LOCALBASE}/$${d%/*}";; \
	*) shdir="${LOCALBASE}/lib";; \
	esac; \
	check=`eval $$listlibs 2>/dev/null| \
a1295 16
_syslibresolve_fragment = \
	case "$$d" in \
	/*) \
		shdir="$${d%/*}/";; \
	*/*) \
		shdir="${DEPBASE}/$${d%/*}";; \
	*) \
		shdir="${DEPBASE}/lib"; \
		listlibs="$$listlibs /usr/lib/lib* ${X11BASE}/lib/lib*";; \
	esac; \
	check=`eval $$listlibs 2>/dev/null| \
		LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} \
		perl ${PORTSDIR}/infrastructure/build/resolve-lib ${_noshared} $$d` \
		|| check=Failed


d1329 1
a2831 1
		libspecs='';comma=''; \
d2835 2
a2836 8
			if ${_PKG_QUERY} "$$pkg" -q; then \
				listlibs='echo ${DEPDIR}$$shdir/lib*'; \
				case "$$dir" in ${PKGPATH}) \
					listlibs="$$toset ${MAKE} print-plist-contents|${_grab_libs_from_plist}; $$listlibs";; \
				esac; \
			else \
				listlibs="$$toset ${MAKE} print-plist-contents|${_grab_libs_from_plist}"; \
			fi; \
d2838 2
a2839 2
				${_libresolve_fragment}; \
				case "$$check" in \
d2842 1
a2842 1
					echo 1>&2 "Can't resolve libspec $$d (in ${SUBPACKAGE})"; \
d2844 12
d2857 1
a2857 1
					echo "-W $$check";; \
d2860 2
a2861 1
			echo "-P $$subdir:$$pkg:$$default"; \
d2868 27
a2894 12
.  for _i in ${WANTLIB${SUBPACKAGE}}
	@@d='${_i}'; listlibs='echo $$shdir/lib*'; \
	${_syslibresolve_fragment}; \
	case "$$check" in \
	*.a) ;; \
	Failed) \
		echo 1>&2 "Can't resolve libspec $$d"; \
		exit 1;; \
	*) \
		echo "-W $$check";; \
	esac
.   endfor
@


1.1007
log
@activate locks by default, in /tmp/portslock
from a strong suggestion by ajacoutot@@, after discussion with various
people.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1006 2010/06/17 03:31:33 william Exp $
d723 1
d1530 1
a1530 1
	@@mkdir -p ${@@D}
d1548 13
a1560 10
      deps=`SUBPACKAGE=${_S} ${MAKE} _print-package-args` && \
	  if ${SUDO} ${_PKG_CREATE} $$deps ${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}}; then \
	    mode=`id -u`:`id -g`; ${SUDO} ${CHOWN} $${mode} ${_PACKAGE_COOKIE${_S}}; \
		if ${_check_lib_depends} ${_PACKAGE_COOKIE${_S}} && \
			${_register_plist} ${_PACKAGE_COOKIE${_S}}; then \
				exit 0; \
		fi; \
	  fi && \
	  ${SUDO} ${MAKE} _internal-clean=package && \
	  exit 1
@


1.1006
log
@Remove the WRKDIR_LINKNAME symlink at 'make clean' if present
help and ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1005 2010/06/16 12:22:20 espie Exp $
d1455 1
a1455 1
# nothing happens unless LOCKDIR is defined to a non-empty value
d1457 1
a1457 1
LOCKDIR ?=
@


1.1005
log
@zap old stuff (can't work, since -m is used for something else now)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1004 2010/06/16 12:06:46 espie Exp $
d2517 3
@


1.1004
log
@remove PKG_CMD, set up PKG_ADD/PKG_CREATE/PKG_DELETE/PKG_INFO
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1003 2010/06/15 11:42:21 kili Exp $
a887 3
.  endif
.  if exists(${PKGDIR}/MODULE.pm)
PKG_ARGS- += -m ${PKGDIR}/MODULE.pm
@


1.1003
log
@Move `-q' flag for pkg_info(8) from PKG_QUERY back to the two places
where it's really needed. Fixes ${_UPDATE_COOKIE${_S}} (i.e. make
update).

"oh oops. yep. Fuck." espie@@ :-)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1002 2010/06/14 12:02:43 espie Exp $
d188 3
a190 1
PKG_CMD ?= /usr/sbin/pkg_create
d193 2
a194 2
_PKG_ADD = /usr/sbin/pkg_add ${_PROGRESS}
_PKG_CREATE = ${PKG_CMD} ${_PROGRESS}
d196 1
a196 1
_PKG_QUERY = /usr/sbin/pkg_info ${PKGDB_LOCK} -e
@


1.1002
log
@fix directory creation so that PLIST_DB can be a path, as should be.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1001 2010/06/14 12:01:19 espie Exp $
d194 1
a194 1
_PKG_QUERY = /usr/sbin/pkg_info ${PKGDB_LOCK} -q -e
d1751 1
a1751 1
				if ${_PKG_QUERY} "$$pkg"; then \
d2849 1
a2849 1
			if ${_PKG_QUERY} "$$pkg"; then \
@


1.1001
log
@reorg pkg* thru _PKG*, so that we can add a PROGRESS_METER user settings
(defaults to yes, as for ftp).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.1000 2010/06/14 11:49:03 espie Exp $
d2387 1
a2387 1
_register_plist = mkdir -p ${PLIST_DB} && perl ${PORTSDIR}/infrastructure/package/register-plist ${PLIST_DB}
@


1.1000
log
@simplify check-lib-depends run
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.999 2010/05/28 12:34:22 espie Exp $
d175 9
a183 1
FETCH_CMD ?= /usr/bin/ftp -V -m -k ${FTP_KEEPALIVE}
a187 1
_PKG_QUERY = pkg_info ${PKGDB_LOCK} -e
d190 8
a197 2
PKG_CMD += ${PKGDB_LOCK}
PKG_DELETE += ${PKGDB_LOCK}
a925 3
.    if exists(${PKGDIR}/MODULE${_S}.pm)
PKG_ARGS${_S} += -m ${PKGDIR}/MODULE${_S}.pm
.    endif
d1518 1
a1518 1
	@@if ${SETENV} ${_TERM_ENV} PKG_CACHE=${_CACHE_REPO} PKG_PATH=${_CACHE_REPO}:${_PKG_REPO}:${PACKAGE_REPOSITORY}/${NO_ARCH}/:${PKG_PATH} pkg_add -n -q ${_PKG_ADD_FORCE} -D installed -D downgrade ${_PKGFILE${_S}} >/dev/null 2>&1; then \
d1549 1
a1549 1
	  if ${SUDO} ${PKG_CMD} $$deps ${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}}; then \
d1591 1
a1591 1
		${SUDO} ${SETENV} ${_TERM_ENV} PKG_PATH=${_PKG_REPO} pkg_add ${_PKG_ADD_AUTO} ${PKGFILE${_S}}; \
d1594 1
a1594 1
	@@${SUDO} ${SETENV} ${_TERM_ENV} PKG_PATH=${_PKG_REPO} pkg_add ${_PKG_ADD_AUTO} ${PKGFILE${_S}}
d1614 1
a1614 1
		   ${SUDO} ${SETENV} PKG_PATH=${_PKG_REPO} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} -r ${_PKG_ADD_FORCE} ${PKGFILE${_S}};; \
d1629 1
a1629 1
	@@${SUDO} ${SETENV} ${_TERM_ENV} PKG_PATH=${_PKG_REPO} pkg_add ${_PKG_ADD_AUTO} -r ${_PKG_ADD_FORCE} ${PKGFILE${_S}}
d1751 1
a1751 1
				if ${_PKG_QUERY} "$$pkg" -q; then \
d2405 1
a2405 1
	@@${_plist_header}; ${PKG_CMD} -n -q ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}; ${_plist_footer}
d2411 1
a2411 1
		${PKG_CMD} -n -q $$a ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}; \
d2420 1
a2420 1
	@@${_plist_header}; ${PKG_CMD} -n -q ${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}};${_plist_footer}
d2429 1
a2429 1
		${PKG_CMD} -n -q $$a ${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}}; \
d2437 1
a2437 1
	@@${_plist_header}; ${PKG_CMD} -n -Q ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}};${_plist_footer}
d2533 1
a2533 1
	-${SUDO} ${PKG_DELETE} ${PKGNAMES}
d2535 1
a2535 1
	-${SUDO} ${PKG_DELETE} ${FULLPKGNAME${SUBPACKAGE}}
d2849 1
a2849 1
			if ${_PKG_QUERY} "$$pkg" -q; then \
d3099 1
a3099 1
	@@${SUDO} ${PKG_DELETE} ${FULLPKGNAME${SUBPACKAGE}}
@


1.999
log
@if IGNORE'd ports are used as dependencies, write the IGNORE message in an
_IGNORE_COOKIE file.

React accordingly in dependency handling, namely fault the port that tries
to use IGNORE'd stuff.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.998 2010/05/28 10:09:58 espie Exp $
d1841 2
d1844 1
a1844 3
_LIB_DEPENDS_FLAGS=-o
.  else
_LIB_DEPENDS_FLAGS=
d1849 1
a1849 2
	@@PORTSDIR=${PORTSDIR} perl ${PORTSDIR}/infrastructure/package/check-lib-depends \
		${_LIB_DEPENDS_FLAGS} -d ${_PKG_REPO} ${_PACKAGE_COOKIE}
d1852 1
a1852 1
	@@${SUDO} perl ${PORTSDIR}/infrastructure/package/check-lib-depends -F ${WRKINST} -O $@@
d1856 2
a1857 3
	@@-SUBPACKAGE=${_S} ${MAKE} print-plist-with-depends | \
	 PORTSDIR=${PORTSDIR} perl ${PORTSDIR}/infrastructure/package/check-lib-depends \
		${_LIB_DEPENDS_FLAGS} -d ${_PKG_REPO} -B ${WRKINST} -s ${WRKINST}/.saved_libs
d2380 1
a2380 1
_check_lib_depends = perl ${PORTSDIR}/infrastructure/package/check-lib-depends -d ${_PKG_REPO} -B ${WRKINST}
@


1.998
log
@amd64 and sparc64 have switched
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.997 2010/05/23 09:22:50 espie Exp $
d1701 2
d1750 2
a1751 1
			if (eval $$toset exec ${MAKE} $$target); then \
d1836 3
a1838 1

@


1.997
log
@only warn for empty patches, instead of erroring out.
Simplify the task of testing patches that remove patches.
Don't forget to cvs rm though !
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.996 2010/05/16 10:33:32 espie Exp $
d135 2
a136 2
GCC4_ARCHS =
GCC3_ARCHS = alpha amd64 arm armish beagle gumstix hppa hppa64 i386 \
d138 1
a138 1
	socppc sparc64 zaurus
@


1.996
log
@classify machines per compiler arch. May occasionally be useful if you're
looking for something like this.

some help from miod@@ for hw that's been forgotten by every human. ;-)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.995 2010/04/24 09:54:42 ajacoutot Exp $
d2185 7
a2191 3
						${_SYSTRACE_CMD} ${PATCH} ${PATCH_ARGS} < $$i || \
							{ echo "***>   $$i did not apply cleanly"; \
							error=true; }\
@


1.995
log
@Override MAKE in CONFIGURE_ENV when USE_GMAKE is set to Yes. Some ports
seem to need this more and more and it makes sense anyway.

tested in a bulk by jasper@@, ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.994 2010/04/20 21:00:35 espie Exp $
d135 5
@


1.994
log
@fix and recommit, my bad.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.992 2010/04/20 10:15:09 espie Exp $
d339 1
@


1.993
log
@Revert to r1.991, this temporarly broke the portstree..
agreed by kili@@ and sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.991 2010/04/17 10:16:11 espie Exp $
d1521 1
a1521 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
d1523 1
a1523 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-package
d1526 1
a1526 1
	@@cd ${.CURDIR} && exec ${MAKE} do-package
d1545 1
a1545 1
	@@cd ${.CURDIR} && exec ${MAKE} post-package
d1558 1
a1558 1
	@@cd ${.CURDIR} && exec ${MAKE} package
d1584 1
a1584 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-package
d1603 1
a1603 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-package
d1804 1
a1804 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-fetch __FETCH_ALL=Yes
d1808 1
a1808 1
	@@cd ${.CURDIR} && exec ${MAKE} ${MAKESUMFILES:S@@^@@${DISTDIR}/@@}
d1812 1
a1812 1
	@@cd ${.CURDIR} && exec ${MAKE} post-fetch __FETCH_ALL=Yes
d1837 1
a1837 1
	@@cd ${.CURDIR} && exec ${MAKE} package
d1872 1
a1872 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-fetch
d1875 1
a1875 1
	@@cd ${.CURDIR} && exec ${MAKE} do-fetch
d1879 1
a1879 1
	@@cd ${.CURDIR} && exec ${MAKE} ${CHECKSUMFILES:S@@^@@${DISTDIR}/@@}
d1884 1
a1884 1
	@@cd ${.CURDIR} && exec ${MAKE} post-fetch
d1936 1
a1936 1
	@@cd ${.CURDIR} && exec ${MAKE} ${DISTDIR}/${file} \
d1939 1
a1939 1
	cd ${.CURDIR} && exec ${MAKE} _internal-checksum REFETCH=false
d2049 1
a2049 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-package-only
d2051 1
a2051 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_BULK_COOKIE}
d2056 1
a2056 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-package-only
d2060 1
a2060 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_i} ${BULK_FLAGS}
d2065 1
a2065 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} _internal-clean
d2081 1
a2081 2
	@@cd ${.CURDIR} && exec ${MAKE} \
		_internal-checksum _internal-prepare
d2084 1
a2084 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-extract
d2086 1
a2086 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-extract
d2088 1
a2088 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-extract
d2110 1
a2110 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-patch
d2122 1
a2122 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_PREPATCH_COOKIE}
d2124 1
a2124 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-distpatch
d2126 1
a2126 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-distpatch
d2156 1
a2156 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_PREPATCH_COOKIE}
d2159 1
a2159 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-patch
d2164 1
a2164 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-distpatch
d2196 1
a2196 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-patch
d2230 1
a2230 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-configure
d2233 1
a2233 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-configure
d2244 1
a2244 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-configure
d2267 1
a2267 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-build
d2270 1
a2270 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-build
d2278 1
a2278 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-build
d2297 1
a2297 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-regress
d2312 1
a2312 1
	@@cd ${.CURDIR} && exec ${MAKE} post-regress
d2338 1
a2338 2
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
		${MAKE} pre-fake ${_FAKE_SETUP}
d2342 1
a2342 2
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
		${MAKE} pre-install ${_FAKE_SETUP}
d2345 1
a2345 2
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
		${MAKE} do-install ${_FAKE_SETUP}
d2354 1
a2354 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} ${MAKE} post-install ${_FAKE_SETUP}
d3051 1
a3051 1
	@@cd ${.CURDIR} && exec ${MAKE} PATCH_CHECK_ONLY=Yes patch
d3054 1
a3054 1
	@@cd ${.CURDIR} && exec ${MAKE} clean=depends
d3057 1
a3057 1
	@@cd ${.CURDIR} && exec ${MAKE} clean=dist
d3060 1
a3060 1
	@@cd ${.CURDIR} && exec ${MAKE} clean=package
d3063 1
a3063 1
	@@cd ${.CURDIR} && exec ${MAKE} clean='install force'
d3067 2
a3068 2
	@@cd ${.CURDIR} && exec ${MAKE} clean=packages
	@@cd ${.CURDIR} && exec ${MAKE} package
d3072 1
a3072 1
	@@cd ${.CURDIR} && exec ${MAKE} build
@


1.992
log
@use _MAKE and _MAKESYS, simpler to read
@
text
@d1521 1
a1521 1
	@@${_MAKE} ${_PACKAGE_COOKIE_DEPS}
d1523 1
a1523 1
	@@${_MAKE} pre-package
d1526 1
a1526 1
	@@${_MAKE} do-package
d1545 1
a1545 1
	@@${_MAKE} post-package
d1558 1
a1558 1
	@@${_MAKE} package
d1584 1
a1584 1
	@@${_MAKE} _internal-package
d1603 1
a1603 1
	@@${_MAKE} _internal-package
d1804 1
a1804 1
	@@${_MAKE} pre-fetch __FETCH_ALL=Yes
d1808 1
a1808 1
	@@${_MAKE} ${MAKESUMFILES:S@@^@@${DISTDIR}/@@}
d1812 1
a1812 1
	@@${_MAKE} post-fetch __FETCH_ALL=Yes
d1837 1
a1837 1
	@@${_MAKE} package
d1872 1
a1872 1
	@@${_MAKE} pre-fetch
d1875 1
a1875 1
	@@${_MAKE} do-fetch
d1879 1
a1879 1
	@@${_MAKE} ${CHECKSUMFILES:S@@^@@${DISTDIR}/@@}
d1884 1
a1884 1
	@@${_MAKE} post-fetch
d1936 1
a1936 1
	@@${_MAKE} ${DISTDIR}/${file} \
d1939 1
a1939 1
	${_MAKE} _internal-checksum REFETCH=false
d2049 1
a2049 1
	@@${_MAKE} _internal-package-only
d2051 1
a2051 1
	@@${_MAKE} ${_BULK_COOKIE}
d2056 1
a2056 1
	@@${_MAKE} _internal-package-only
d2060 1
a2060 1
	@@${_MAKE} ${_i} ${BULK_FLAGS}
d2065 1
a2065 1
	@@${SUDO} ${_MAKE} _internal-clean
d2081 2
a2082 1
	@@${_MAKE} _internal-checksum _internal-prepare
d2085 1
a2085 1
	@@${_MAKESYS} pre-extract
d2087 1
a2087 1
	@@${_MAKESYS} do-extract
d2089 1
a2089 1
	@@${_MAKESYS} post-extract
d2111 1
a2111 1
	@@${_MAKESYS} pre-patch
d2123 1
a2123 1
	@@${_MAKE} ${_PREPATCH_COOKIE}
d2125 1
a2125 1
	@@${_MAKESYS} do-distpatch
d2127 1
a2127 1
	@@${_MAKESYS} post-distpatch
d2157 1
a2157 1
	@@${_MAKE} ${_PREPATCH_COOKIE}
d2160 1
a2160 1
	@@${_MAKESYS} do-patch
d2165 1
a2165 1
	@@${_MAKE} _internal-distpatch
d2197 1
a2197 1
	@@${_MAKESYS} post-patch
d2231 1
a2231 1
	@@${_MAKESYS} pre-configure
d2234 1
a2234 1
	@@${_MAKESYS} do-configure
d2245 1
a2245 1
	@@${_MAKESYS} post-configure
d2268 1
a2268 1
	@@${_MAKESYS} pre-build
d2271 1
a2271 1
	@@${_MAKESYS} do-build
d2279 1
a2279 1
	@@${_MAKESYS} post-build
d2298 1
a2298 1
	@@${_MAKE} pre-regress
d2313 1
a2313 1
	@@${_MAKE} post-regress
d2339 2
a2340 1
	@@${SUDO} ${_MAKESYS} pre-fake ${_FAKE_SETUP}
d2344 2
a2345 1
	@@${SUDO} ${_MAKESYS} pre-install ${_FAKE_SETUP}
d2348 2
a2349 1
	@@${SUDO} ${_MAKESYS} do-install ${_FAKE_SETUP}
d2358 1
a2358 1
	@@${SUDO} ${_MAKESYS} post-install ${_FAKE_SETUP}
d3055 1
a3055 1
	@@${_MAKE} PATCH_CHECK_ONLY=Yes patch
d3058 1
a3058 1
	@@${_MAKE} clean=depends
d3061 1
a3061 1
	@@${_MAKE} clean=dist
d3064 1
a3064 1
	@@${_MAKE} clean=package
d3067 1
a3067 1
	@@${_MAKE} clean='install force'
d3071 2
a3072 2
	@@${_MAKE} clean=packages
	@@${_MAKE} package
d3076 1
a3076 1
	@@${_MAKE} build
@


1.991
log
@fix logic, so that BROKEN-arch shows in the correct places
when MULTI_PACKAGES is set.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.990 2010/04/17 09:49:52 espie Exp $
d1521 1
a1521 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
d1523 1
a1523 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-package
d1526 1
a1526 1
	@@cd ${.CURDIR} && exec ${MAKE} do-package
d1545 1
a1545 1
	@@cd ${.CURDIR} && exec ${MAKE} post-package
d1558 1
a1558 1
	@@cd ${.CURDIR} && exec ${MAKE} package
d1584 1
a1584 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-package
d1603 1
a1603 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-package
d1804 1
a1804 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-fetch __FETCH_ALL=Yes
d1808 1
a1808 1
	@@cd ${.CURDIR} && exec ${MAKE} ${MAKESUMFILES:S@@^@@${DISTDIR}/@@}
d1812 1
a1812 1
	@@cd ${.CURDIR} && exec ${MAKE} post-fetch __FETCH_ALL=Yes
d1837 1
a1837 1
	@@cd ${.CURDIR} && exec ${MAKE} package
d1872 1
a1872 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-fetch
d1875 1
a1875 1
	@@cd ${.CURDIR} && exec ${MAKE} do-fetch
d1879 1
a1879 1
	@@cd ${.CURDIR} && exec ${MAKE} ${CHECKSUMFILES:S@@^@@${DISTDIR}/@@}
d1884 1
a1884 1
	@@cd ${.CURDIR} && exec ${MAKE} post-fetch
d1936 1
a1936 1
	@@cd ${.CURDIR} && exec ${MAKE} ${DISTDIR}/${file} \
d1939 1
a1939 1
	cd ${.CURDIR} && exec ${MAKE} _internal-checksum REFETCH=false
d2049 1
a2049 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-package-only
d2051 1
a2051 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_BULK_COOKIE}
d2056 1
a2056 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-package-only
d2060 1
a2060 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_i} ${BULK_FLAGS}
d2065 1
a2065 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} _internal-clean
d2081 1
a2081 2
	@@cd ${.CURDIR} && exec ${MAKE} \
		_internal-checksum _internal-prepare
d2084 1
a2084 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-extract
d2086 1
a2086 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-extract
d2088 1
a2088 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-extract
d2110 1
a2110 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-patch
d2122 1
a2122 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_PREPATCH_COOKIE}
d2124 1
a2124 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-distpatch
d2126 1
a2126 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-distpatch
d2156 1
a2156 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_PREPATCH_COOKIE}
d2159 1
a2159 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-patch
d2164 1
a2164 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-distpatch
d2196 1
a2196 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-patch
d2230 1
a2230 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-configure
d2233 1
a2233 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-configure
d2244 1
a2244 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-configure
d2267 1
a2267 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-build
d2270 1
a2270 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-build
d2278 1
a2278 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-build
d2297 1
a2297 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-regress
d2312 1
a2312 1
	@@cd ${.CURDIR} && exec ${MAKE} post-regress
d2338 1
a2338 2
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
		${MAKE} pre-fake ${_FAKE_SETUP}
d2342 1
a2342 2
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
		${MAKE} pre-install ${_FAKE_SETUP}
d2345 1
a2345 2
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
		${MAKE} do-install ${_FAKE_SETUP}
d2354 1
a2354 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} ${MAKE} post-install ${_FAKE_SETUP}
d3051 1
a3051 1
	@@cd ${.CURDIR} && exec ${MAKE} PATCH_CHECK_ONLY=Yes patch
d3054 1
a3054 1
	@@cd ${.CURDIR} && exec ${MAKE} clean=depends
d3057 1
a3057 1
	@@cd ${.CURDIR} && exec ${MAKE} clean=dist
d3060 1
a3060 1
	@@cd ${.CURDIR} && exec ${MAKE} clean=package
d3063 1
a3063 1
	@@cd ${.CURDIR} && exec ${MAKE} clean='install force'
d3067 2
a3068 2
	@@cd ${.CURDIR} && exec ${MAKE} clean=packages
	@@cd ${.CURDIR} && exec ${MAKE} package
d3072 1
a3072 1
	@@cd ${.CURDIR} && exec ${MAKE} build
@


1.990
log
@forgot vax
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.989 2010/04/12 13:08:20 espie Exp $
d3128 7
d3142 7
a3155 7
.for _v in ${_ALL_VARIABLES_PER_ARCH}
.  for _a in ${ALL_ARCHS}
.    if defined(${_v}-${_a})
	@@echo ${FULLPKGPATH}.${_v}-${_a}=${${_v}-${_a}:Q}
.    endif
.  endfor
.endfor
@


1.989
log
@add a list of ALL_ARCHS so that I can dump BROKEN-<arch> in dump-vars.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.988 2010/04/05 14:03:26 espie Exp $
d130 1
a130 1
	mvme68k mvme88k mvmeppc palm sgi socppc sparc sparc64 zaurus
@


1.988
log
@fix buglet
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.987 2010/04/05 14:02:50 espie Exp $
d97 1
d114 1
d128 3
d3142 8
@


1.987
log
@USE_GROFF framework for the mandoc switch
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.986 2010/03/22 20:19:12 espie Exp $
d1550 1
a1550 1
	@@cd ${.CURDIR} && exec ${MAKE} subpackage
d1552 1
@


1.986
log
@typo, noticed by Andreas Khri <ak@@ebi.ac.uk>
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.985 2010/03/21 17:12:10 espie Exp $
d106 1
a106 1
	REGRESS_DEPENDS USE_GMAKE MODULES FLAVORS \
a336 1

d467 6
@


1.985
log
@use :Q to avoid any problem
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.984 2010/03/21 17:00:46 espie Exp $
d1305 1
a1305 1
_PKG_ADD_FORCE = -D update -D updatedepends -D
@


1.984
log
@ouch, pass TERM only if it's defined. Add TERMCAP while there. And do the same
thing to http_proxy/ftp_proxy, please...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.983 2010/03/21 11:34:38 ajacoutot Exp $
d797 1
a797 1
_TERM_ENV += ${_v}='${${_v}}'
@


1.983
log
@Add a new APM_ARCHS variable.

comments from espie@@ naddy@@ jasper@@
"looks good" jasper@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.982 2010/03/20 19:14:49 espie Exp $
d794 7
d1492 1
a1492 1
	@@if ${SETENV} TERM=${TERM} ftp_proxy=${ftp_proxy} http_proxy=${http_proxy} PKG_CACHE=${_CACHE_REPO} PKG_PATH=${_CACHE_REPO}:${_PKG_REPO}:${PACKAGE_REPOSITORY}/${NO_ARCH}/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n -q ${_PKG_ADD_FORCE} -D installed -D downgrade ${_PKGFILE${_S}} >/dev/null 2>&1; then \
d1564 1
a1564 1
		${SUDO} ${SETENV} TERM=${TERM} PKG_PATH=${_PKG_REPO} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} ${PKGFILE${_S}}; \
d1567 1
a1567 1
	@@${SUDO} ${SETENV} TERM=${TERM} PKG_PATH=${_PKG_REPO} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} ${PKGFILE${_S}}
d1602 1
a1602 1
	@@${SUDO} ${SETENV} TERM=${TERM} PKG_PATH=${_PKG_REPO} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} -r ${_PKG_ADD_FORCE} ${PKGFILE${_S}}
@


1.982
log
@move to newer style -D for pkg_add.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.981 2010/03/20 19:14:06 espie Exp $
d126 2
@


1.981
log
@pass TERM to pkg_add so that Term::Cap will be able to use more capabilities
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.980 2010/03/20 19:11:51 espie Exp $
d1296 1
a1296 1
_PKG_ADD_FORCE = -F update -F updatedepends -r
d1298 1
a1298 1
_PKG_ADD_FORCE += -F installed
@


1.980
log
@introduce BROKEN-arch
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.979 2010/03/05 07:49:29 espie Exp $
d1483 1
a1483 1
	@@if ${SETENV} ftp_proxy=${ftp_proxy} http_proxy=${http_proxy} PKG_CACHE=${_CACHE_REPO} PKG_PATH=${_CACHE_REPO}:${_PKG_REPO}:${PACKAGE_REPOSITORY}/${NO_ARCH}/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n -q ${_PKG_ADD_FORCE} ${_PKGFILE${_S}} >/dev/null 2>&1; then \
d1555 1
a1555 1
		${SUDO} ${SETENV} PKG_PATH=${_PKG_REPO} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} ${PKGFILE${_S}}; \
d1558 1
a1558 1
	@@${SUDO} ${SETENV} PKG_PATH=${_PKG_REPO} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} ${PKGFILE${_S}}
d1593 1
a1593 1
	@@${SUDO} ${SETENV} PKG_PATH=${_PKG_REPO} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} -r ${_PKG_ADD_FORCE} ${PKGFILE${_S}}
@


1.979
log
@support for more stats in dpb, basically harmless
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.978 2010/02/26 19:20:24 espie Exp $
d1213 8
a1220 1
.if defined(BROKEN) && ${TRY_BROKEN:L} != "yes"
d1222 1
@


1.978
log
@TRY_BROKEN, idea from FreeBSD (by popular demand, jasper + phessler)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.977 2010/02/26 19:05:23 espie Exp $
d3079 6
@


1.977
log
@warn about FULLPKGNAME without FULLPKGPATH, as it is a bit difficult to spot
in complicated ports
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.976 2010/02/13 21:11:35 espie Exp $
d1168 1
d1213 1
a1213 1
.if defined(BROKEN)
@


1.976
log
@don't iterate on IGNORE, this breaks java's jrl message
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.975 2010/02/12 12:00:19 espie Exp $
d481 5
a485 1
.    if !defined(FULLPKGNAME${_s})
@


1.975
log
@some important improvements to bsd.port.mk
- simplify IGNORE handling, always define it, even when NO_IGNORE is set,
and only use it for the targets it's meant to influence.
- make it possible to multiply-IGNORE a port, so stuff that's BROKEN and
NOT_FOR_ARCH will show up as both.
- DESCRIBE_TARGETs can die, since we no longer need special IGNORE dance
for them.
- add an IGNORE_IS_FATAL tweak, so that ignored ports can actually error out.
- reorg dump-vars to choose what to show, including new IGNORE, and COMES_WITH.
- name an explicit prepare step, which does check build dependencies and
install them (useful for build timing purposes)
- move the do-fetch test out, so that we can add pre-extract and do-extract
there eventually.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.974 2010/02/05 13:06:03 jasper Exp $
d1792 1
a1792 3
.    for i in ${IGNORE}
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} $i."
.    endfor
@


1.974
log
@- mention mips64el where applicable

ok espie@@ ajacoutot@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.973 2010/01/28 10:09:06 espie Exp $
d35 6
d90 2
d93 13
a105 1
_ALL_VARIABLES ?= HOMEPAGE DISTNAME BUILD_DEPENDS \
d107 2
a108 3
	NO_BUILD NO_REGRESS SHARED_ONLY ONLY_FOR_ARCHS NOT_FOR_ARCHS IS_INTERACTIVE \
	BROKEN MULTI_PACKAGES PSEUDO_FLAVORS \
	REGRESS_IS_INTERACTIVE DISTFILES DIST_SUBDIR \
d111 2
a112 5
	SHARED_LIBS USE_MOTIF MASTER_SITES \
	MASTER_SITES0 MASTER_SITES1 MASTER_SITES2 MASTER_SITES3 MASTER_SITES4 \
	MASTER_SITES5 MASTER_SITES6 MASTER_SITES7 MASTER_SITES8 MASTER_SITES9 \
	MAINTAINER SUPDISTFILES SUBPACKAGE \
	AUTOCONF_VERSION AUTOMAKE_VERSION CONFIGURE_ARGS
d114 3
a116 4
_ALL_VARIABLES_INDEXED ?= COMMENT FULLPKGNAME PKGNAME PKG_ARCH \
	PERMIT_PACKAGE_FTP PERMIT_PACKAGE_CDROM RUN_DEPENDS LIB_DEPENDS \
	WANTLIB CATEGORIES DESCR

d1163 31
a1193 16

.if !defined(NO_IGNORE) && !defined(DESCRIBE_TARGET)
.  if defined(REGRESS_IS_INTERACTIVE) && defined(BATCH)
_IGNORE_REGRESS = "has interactive tests"
.  elif !defined(REGRESS_IS_INTERACTIVE) && defined(INTERACTIVE)
_IGNORE_REGRESS = "does not have interactive tests"
.  endif
.  if defined(IS_INTERACTIVE) && defined(BATCH)
IGNORE = "is an interactive port"
.  elif !defined(IS_INTERACTIVE) && defined(INTERACTIVE)
IGNORE = "is not an interactive port"
.  elif ${USE_X11:L} == "yes" && !exists(${X11BASE})
IGNORE = "uses X11, but ${X11BASE} not found"
.  elif defined(ONLY_FOR_ARCHS)
.    for __ARCH in ${MACHINE_ARCH} ${ARCH}
.      if !empty(ONLY_FOR_ARCHS:M${__ARCH})
d1195 3
a1197 8
.      endif
.    endfor
.    if !defined(_ARCH_OK)
.      if ${MACHINE_ARCH} == "${ARCH}"
IGNORE = "is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH}"
.      else
IGNORE = "is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH} \(${ARCH}\)"
.      endif
d1199 3
a1201 8
.  elif defined(NOT_FOR_ARCHS)
.    for __ARCH in ${MACHINE_ARCH} ${ARCH}
.      if !empty(NOT_FOR_ARCHS:M${__ARCH})
IGNORE = "is not for ${NOT_FOR_ARCHS}"
.      endif
.    endfor
.  elif ${SHARED_ONLY:L} == "yes" && ${NO_SHARED_LIBS:L} == "yes"
IGNORE = "requires shared libraries"
d1203 4
a1206 1
.endif		# NO_IGNORE
d1208 11
a1218 6
.if !defined(NO_IGNORE)
.  if defined(BROKEN)
IGNORE = "is marked as broken: ${BROKEN:Q}"
.  elif defined(COMES_WITH)
IGNORE = "-- ${FULLPKGNAME${SUBPACKAGE}:C/-[0-9].*//g} comes with ${OPSYS} as of release ${COMES_WITH}"
.  endif
d1638 1
d1642 3
a1772 3
.if target(do-fetch)
ERRORS += "Fatal: you're not allowed to override do-fetch"
.else
a1777 1
.endif
d1782 1
a1782 1
.if defined(IGNORE) && !defined(NO_IGNORE)
d1789 1
a1789 1
	_internal-update-or-install-all _internal-update-plist describe dump-vars \
d1792 3
a1794 1
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} ${IGNORE}."
d1931 1
a1931 1
.  if defined(_IGNORE_REGRESS)
d1946 1
a1946 1
.if ${SHARED_ONLY:L} == "yes"
d1948 1
a1948 1
.else
d1950 1
a1950 1
.endif
d1953 1
a1953 1
.for _s in ${MULTI_PACKAGES}
d1956 1
a1956 1
.endfor
d1992 1
a1992 1
	subupdate fetch fetch-all checksum regress \
d2051 1
a2051 2
		_internal-checksum _internal-build-depends \
		_internal-buildlib-depends _internal-buildwantlib-depends
a2589 1

d3106 1
a3106 1
_all_phony = ${_recursive_depends_targets} ${_recursive_describe_targets} \
d3115 1
a3115 1
	_internal-package _internal-package-only _internal-plist \
d3130 1
a3130 1
	pre-fetch pre-install pre-package pre-patch pre-regress \
@


1.973
log
@duplicate RUN_DEPENDS, it should be indexed only.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.972 2009/10/14 13:01:03 steven Exp $
d111 1
a111 1
LP64_ARCHS = alpha amd64 hppa64 sparc64 mips64
@


1.972
log
@allow USE_LIBTOOL to be set to 'gnu';  'gnu' and 'yes' do the same for now.

ok espie
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.971 2009/10/13 14:39:23 landry Exp $
d85 1
a85 1
_ALL_VARIABLES ?= HOMEPAGE DISTNAME BUILD_DEPENDS RUN_DEPENDS \
@


1.971
log
@Change WRKOBJDIR (again...) to default to ${PORTSDIR}/pobj instead of obj,
it confuses make mirror-maker (among others..)
req'd by espie@@, agreed by several@@ in budapest.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.970 2009/07/26 12:14:05 espie Exp $
d323 2
a324 1
.if ${USE_LIBTOOL:L} == "yes"
d327 4
@


1.970
log
@maintainer usability: some targets are usually not invoked recursively,
but they can (sometimes) be useful: add DANGEROUS knob to prevent running
them accidentally, but allow people to run makesum/update-plist/update-patches
recursively.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.969 2009/07/15 23:44:36 espie Exp $
d75 1
a75 1
WRKOBJDIR ?!= readlink -fn ${PORTSDIR}/obj
d77 1
a77 1
WRKOBJDIR ?= ${PORTSDIR}/obj
@


1.969
log
@small mirror-maker tweaks:
- there's no need for :: on pure dependencies, : works just fine for
accumulating (and :: is not 100% standard on all systems)
- append directly to _FETCH_MAKEFILE_NAMES. This avoids an untidy blank space
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.968 2009/07/13 12:21:44 espie Exp $
d3074 2
a3075 1
	${_recursive_targets} _build-dir-depends _fetch-makefile _fetch-onefile \
d3093 2
a3094 2
	install-all lib-depends lib-depends-list makesum \
	peek-ftp plist port-lib-depends-check post-build post-configure \
d3100 1
a3100 1
	subpackage uninstall update-patches update-plist mirror-maker-fetch \
@


1.968
log
@when using peek-ftp, I often start with make show=DISTFILES, so save myself
the trouble.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.967 2009/06/17 13:42:49 landry Exp $
a355 1
_FETCH_MAKEFILE_NAMES =
d2496 1
a2496 1
	@@echo ":: ${_FETCH_MAKEFILE_NAMES}"
@


1.967
log
@systrace isn't too happy when WRKOBJDIR contains a symlink, which can
happen often (/usr/ports NFS mounted & /usr/ports/obj a symlink to a
local dir, /usr/ports as a symlink to /home/wherever..)
Use readlink -fn only if USE_SYSTRACE is set so less things are run when
bsd.port.mk is included. Should make everyone happy.

Issue reported by and original fix ajacoutot@@, sounds reasonable to espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.966 2009/06/12 17:26:51 sthen Exp $
d3030 1
@


1.966
log
@set RECURSIVE_FETCH_LIST to No by default. ok sturm, ajacoutot, espie.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.965 2009/06/12 13:39:30 landry Exp $
d74 3
d78 1
@


1.965
log
@Provide saner defaults for WRKOBJDIR, using ${PORTSDIR}/obj. No more w-*
dirs forgotten all around. One can still unset it in /etc/mk.conf to get
back to the older behaviour, or still override it with /usr/obj/ports or
/usr/wobj or whatever. At least, now it can be a separate partition.
Most of us were already overriding this value, OpenBSD is all about sane
& simple default settings.
${PORTSDIR}/obj suggestion from jakemsr@@.
Discussed at length with several, 'Works for me' krw@@ ok todd@@ wcmaier@@.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.964 2009/06/09 17:46:58 espie Exp $
d71 1
a71 1
RECURSIVE_FETCH_LIST ?= Yes
@


1.964
log
@don't export brutally everything from bsd.own.mk into each port's Makefile,
but select some variables instead.

checked by naddy@@ on a bulk-build.

(apart from making stuff less easy to break, it also means Makefiles stop
inheriting a WIDE set of .PHONY targets, which is a good thing)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.963 2009/05/16 22:18:50 simon Exp $
d74 1
a74 1
WRKOBJDIR ?=
@


1.963
log
@allow ports to set REGRESS_IS_INTERACTIVE=X11 in order to get rid of
redundant makefile parts found at many places in the tree

DISPLAY and XAUTHORITY variables/checks to be nuked soon from many ports

ok ajacoutot@@, sthen@@, jasper@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.962 2009/05/05 20:58:38 martynas Exp $
d581 9
a589 1
MAKE_ENV += EXTRA_SYS_MK_INCLUDES="<bsd.own.mk>"
@


1.962
log
@make "doesn't seem to exist on this system" and "Size matches for"
implicit;  since they filled the whole screen making important stuff
unnoticable.  ok espie@@, sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.961 2009/04/24 08:53:33 espie Exp $
d626 5
d2211 10
@


1.961
log
@remove trailing dot
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.960 2009/04/11 14:55:31 espie Exp $
a2350 1
	${ECHO_MSG} ">> $$f doesn't seem to exist on this system."; \
a2361 1
					${ECHO_MSG} ">> Size matches for ${_F}"; \
@


1.960
log
@minor tweaks:
- totally forbid overriding do-fetch
- slightly better diagnostics in a few cases
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.959 2009/01/05 12:43:49 ajacoutot Exp $
d2355 1
a2355 1
		${ECHO_MSG} ">> Fetch $${site}$$f."; \
@


1.959
log
@- fix some unquoted shell expansions
this fixes an old bug where package creation would fail if one has some
particular file under PKGPATH because it would give pkg_create the wrong
args

from Wim Lewis on ports@@, thank you!
"looks right" sthen@@, "sounds reasonable" landry@@, ok jasper@@ espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.958 2008/11/18 11:45:41 espie Exp $
d208 1
a208 1
ERRORS += "Fatal: unknown clean command: ${_w}"
d1721 1
a1721 1
	@@cd ${.CURDIR} && exec ${MAKE} do-fetch __FETCH_ALL=Yes
d2755 1
a2755 1
					echo 1>&2 "Can't resolve libspec $$d"; \
@


1.958
log
@somewhat better error indications after some user feedback ;)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.957 2008/10/25 15:06:26 bernd Exp $
d2740 1
a2740 1
			case "X$$pkg" in X) pkg=`echo $$default|${_version2default}`;; \
d2742 1
a2742 1
			if ${_PKG_QUERY} $$pkg -q; then \
d2744 1
a2744 1
				case $$dir in ${PKGPATH}) \
@


1.957
log
@Add SUBPACKAGE to _ALL_VARIABLES. ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.956 2008/09/19 13:00:30 espie Exp $
d869 1
a869 1
ERRORS += "Fatal: Missing comment for ${_S}."
d1070 4
a1073 1
ERRORS += "Fatal: no category to match pkgpath"
d2173 1
a2173 1
.if ${VMEM_WARNING:L} == "yes"
d2185 1
a2185 1
.endif
@


1.956
log
@add a possible convenience link to the WRKDIR
*solely* as a facility for people working on the ports tree.
not to be used for anything at all in the ports tree itself !!!
since it's not protected against any kind of race.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.955 2008/09/17 13:42:10 ajacoutot Exp $
d91 1
a91 1
	MAINTAINER SUPDISTFILES \
@


1.955
log
@- add ^TRUEPREFIX to the generic SUBST_VARS

"go ahead" espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.954 2008/08/20 10:33:50 simon Exp $
d72 1
d1990 3
@


1.954
log
@Redirect regression output so we get the actual exit code instead of the
last one in the pipe to make sure failed regression tests don't bake a
cookie when REGRESS_LOG is set (default).
Also redirect stderr to regress log and introduce REGRESS_STATUS_IGNORE
variable so post-regress targets like found in cpan.port.mk can do the
actual failure detection.

Problem noticed by bluhm@@, latching of exit code suggested by steven@@

Testing, feedback and ok on earlier version by bluhm@@, 'go for it' espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.953 2008/08/20 08:56:53 espie Exp $
d743 1
a743 1
	MAINTAINER ^BASE_PKGPATH ^LOCALBASE ^X11BASE
@


1.953
log
@add clean=build: incentive to use SEPARATE_BUILD, as this allows you to not clean up the source, but only phases from configure up...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.952 2008/08/19 23:49:32 espie Exp $
d623 1
d2203 3
a2205 1
	@@cd ${.CURDIR} && exec ${MAKE} do-regress ${REGRESS_LOG}
d2208 4
a2211 2
	@@cd ${WRKBUILD} && exec ${SETENV} ${MAKE_ENV} \
		${MAKE_PROGRAM} ${ALL_REGRESS_FLAGS} -f ${MAKE_FILE} ${REGRESS_TARGET} ${REGRESS_LOG}
@


1.952
log
@NOT_FOR_ARCHS as dump-vars, to allow sqlports to perform better
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.951 2008/07/29 17:54:52 espie Exp $
d196 1
a196 1
.if ${_clean:L:Mwork}
d204 1
a204 1
	readmes bulk force plist
d2389 1
a2389 1
.if ${_clean:L:Mwork}
d2399 2
@


1.951
log
@typo
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.950 2008/07/29 11:25:44 espie Exp $
d82 1
a82 1
	NO_BUILD NO_REGRESS SHARED_ONLY ONLY_FOR_ARCHS IS_INTERACTIVE \
@


1.950
log
@we have too many old distfiles -> too many links.
instead of storing links directly as
sha1/digest
allow them to be in
by_digest/sha1/di/digest

so the number of links will not grow that fast
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.949 2008/07/26 12:23:43 espie Exp $
d1850 1
a1850 1
		MASTER_SITE_OVERRIDE="${MASTER_SITE_OPENBSD:=by_cypher/${cipher}/${value:C/(..).*/\1/}/${value}/} ${MASTER_SITE_OPENBSD:=${cipher}/${value}/}"
@


1.949
log
@new update-or-install target needs to have dependent subpackages built as
well.

Incidentally, this is also an issue with update: in some cases, the update
target wouldn't work (specifically, when dependencies had changed).
Fix it as well.

There might be a need to revisit the DEPENDS_TARGET stuff later, this is
a bit of a kludge...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.948 2008/07/26 11:22:59 espie Exp $
d898 5
d1850 1
a1850 1
		MASTER_SITE_OVERRIDE="ftp://ftp.openbsd.org/pub/OpenBSD/distfiles/${cipher}/${value}/"
@


1.948
log
@INSTALL/DEINSTALL obsolete for multi-packages as well
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.947 2008/07/26 11:16:04 espie Exp $
d1502 4
a1505 1
		*) ${ECHO_MSG} "Upgrading from $$a"; \
d1512 3
@


1.947
log
@_FMN is a terrible acronym
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.946 2008/07/26 11:14:07 espie Exp $
d838 1
a838 2
ERRORS += "INSTALL script support is deprecated"
PKG_ARGS${_S} += -i ${PKGDIR}/INSTALL${_S}
d841 1
a841 2
ERRORS += "DEINSTALL script support is deprecated"
PKG_ARGS${_S} += -k ${PKGDIR}/DEINSTALL${_S}
d983 1
a983 1
# List of all files, with ${DIST_SUBDIR} in front.  Used for checksum.
@


1.946
log
@INSTALL/DEINSTALL are completely obsolete now (been deprecated for over
a year)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.945 2008/07/26 10:59:20 espie Exp $
d351 1
a351 1
_FMN =
d1286 1
a1286 1
_FMN += ${PKGPATH}/${FULLPKGNAME${_S}}
d2449 1
a2449 1
	@@echo ":: ${_FMN}"
d2451 1
a2451 1
	@@echo ".PHONY: ${_FMN}"
d2453 1
a2453 1
	@@echo "${_FMN}: ${MAKESUMFILES} "`_FULL_PACKAGE_NAME=Yes ${MAKE} full-all-depends|fgrep -v ${PKGPATH}/`
d2455 1
a2455 1
	@@echo "${_FMN}: ${MAKESUMFILES}"
@


1.945
log
@new "convenience target": update-or-install (all)

Basically, make update without the tests that prevent it from running when
stuff is not installed yet.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.944 2008/07/03 17:36:47 sturm Exp $
d799 1
a799 2
ERRORS += "INSTALL script support is deprecated"
PKG_ARGS- += -i ${PKGDIR}/INSTALL
d802 1
a802 2
ERRORS += "DEINSTALL script support is deprecated"
PKG_ARGS- += -k ${PKGDIR}/DEINSTALL
@


1.944
log
@honour ftp_ and http_proxy for FETCH_PACKAGES
ok espie
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.943 2008/07/03 15:43:22 espie Exp $
d478 1
d483 1
d486 1
d490 1
d1460 1
a1460 1
	@@rm -f ${_BULK_COOKIE} ${_UPDATE_COOKIE${_S}}
d1510 11
d1727 2
a1728 1
	_internal-update _internal-update-plist describe dump-vars \
d1864 2
d1929 4
a1932 4
	subupdate fetch fetch-all checksum regress depends lib-depends \
	build-depends \
	run-depends regress-depends clean manpages-check \
	plist update-plist update package install-all
@


1.943
log
@make full-*-depends targets invocable at the subdir level, as requested
by ajacoutot@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.942 2008/06/06 01:17:13 fgsch Exp $
d1411 1
a1411 1
	@@if ${SETENV} PKG_CACHE=${_CACHE_REPO} PKG_PATH=${_CACHE_REPO}:${_PKG_REPO}:${PACKAGE_REPOSITORY}/${NO_ARCH}/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n -q ${_PKG_ADD_FORCE} ${_PKGFILE${_S}} >/dev/null 2>&1; then \
@


1.942
log
@fix fetching files from MASTER_SITE[0-9]. found earlier by me during
a full port-lib-depends-check and later reported on ports
by Tim Donahue (tdonahue at vonsystems dot com). espie@@ ok.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.941 2008/06/05 08:14:00 fgsch Exp $
d3028 1
a3028 2
	full-all-depends full-build-depends full-regress-depends \
	full-run-depends install-all lib-depends lib-depends-list makesum \
@


1.941
log
@ignore ports marked as such on port-lib-depends-check. rearrange targets
while im here. espie@@ ok.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.940 2008/05/18 11:22:14 espie Exp $
d2312 1
a2312 1
	select=${_EVERYTHING:M*${_F:S@@^${FULLDISTDIR}/@@@@}\:[0-9]}; \
@


1.940
log
@add a bit of glue so that mirror-maker will be able to use the same locks
as the rest of the tree
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.939 2008/05/18 10:05:21 espie Exp $
d1707 7
a1713 7
_internal-fetch _internal-checksum _internal-extract _internal-patch \
	_internal-configure _internal-all _internal-build _internal-install \
	_internal-regress _internal-uninstall _internal-deinstall _internal-fake \
	_internal-update _internal-plist _internal-package _internal-install-all \
	_internal-update-plist update-patches _internal-subupdate \
	dump-vars describe _internal-subpackage \
	_internal-manpages-check:
@


1.939
log
@remove intermediate targets we're no longer needing
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.938 2008/05/18 09:58:09 espie Exp $
d2457 2
a2458 1
	@@echo -n '\t@@MAINTAINER="${MAINTAINER}" '
@


1.938
log
@compute a set of missing files to show a better message for FETCH_MANUALLY
(got annoyed at java each time I had to figure out WHICH file got updated
and I had to fetch out of... the ten of them)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.937 2008/05/15 10:09:29 espie Exp $
a947 1
_ALLFILES = ${_DISTFILES}
a951 1
_ALLFILES += ${_PATCHFILES}
d960 1
a960 1
.for _file in ${_ALLFILES}
a964 1
_ALLFILES := ${__CKSUMFILES}
a981 1
_REALLY_ALLFILES := ${__MKSUMFILES}
d1697 2
a1698 2
.  if !empty(_REALLY_ALLFILES)
	@@cd ${.CURDIR} && exec ${MAKE} ${_REALLY_ALLFILES:S@@^@@${FULLDISTDIR}/@@}
d1768 2
a1769 2
.    if !empty(_ALLFILES)
	@@cd ${.CURDIR} && exec ${MAKE} ${_ALLFILES:S@@^@@${FULLDISTDIR}/@@}
d2298 1
a2298 1
.for _F in ${_REALLY_ALLFILES:S@@^@@${FULLDISTDIR}/@@}
@


1.937
log
@simplify computation of MAKESUMFILES: start with what's already been done,
and just append to it.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.936 2008/05/15 09:57:03 espie Exp $
d1094 4
a1097 4
_ALLFILES_PRESENT = Yes
.  for _F in ${_ALLFILES:S@@^@@${FULLDISTDIR}/@@}
.    if !exists(${_F})
_ALLFILES_PRESENT = No
d1100 1
a1100 1
.  if ${_ALLFILES_PRESENT:L} == "no"
d2305 3
@


1.936
log
@hide ALLFILES and REALLY_ALLFILES, they have confusing names anyways
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.935 2008/05/15 09:51:17 espie Exp $
d976 2
a977 3
_REALLY_ALLFILES = ${_ALLFILES} ${SUPDISTFILES:C/:[0-9]$//}

__MKSUMFILES =
d979 2
a980 2
.for _file in ${_REALLY_ALLFILES}
.  if empty(__MKSUMFILES:M${_file})
d982 3
a984 2
.  endif
.endfor
@


1.935
log
@clean-up fetch/fetch-all framework
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.934 2008/05/12 14:45:48 deanna Exp $
d948 1
a948 1
ALLFILES = ${_DISTFILES}
d953 1
a953 1
ALLFILES += ${_PATCHFILES}
d962 1
a962 1
.for _file in ${ALLFILES}
d967 1
a967 1
ALLFILES := ${__CKSUMFILES}
d976 1
a976 1
REALLY_ALLFILES = ${ALLFILES} ${SUPDISTFILES:C/:[0-9]$//}
d980 1
a980 1
.for _file in ${REALLY_ALLFILES}
d985 1
a985 1
REALLY_ALLFILES := ${__MKSUMFILES}
d1095 1
a1095 1
.  for _F in ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
d1700 3
a1702 3
# What FETCH normally does:
.  if !empty(REALLY_ALLFILES)
	@@cd ${.CURDIR} && exec ${MAKE} ${REALLY_ALLFILES:S@@^@@${FULLDISTDIR}/@@}
d1772 2
a1773 2
.    if !empty(ALLFILES)
	@@cd ${.CURDIR} && exec ${MAKE} ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
d2302 1
a2302 1
.for _F in ${REALLY_ALLFILES:S@@^@@${FULLDISTDIR}/@@}
@


1.934
log
@Add X11BASE to SUBST_VARS

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.933 2008/05/11 19:36:12 espie Exp $
d956 1
a956 2
.if make(makesum) || make(addsum) || defined(__FETCH_ALL)
.  if defined(SUPDISTFILES)
a957 2
ALLFILES += ${SUPDISTFILES:C/:[0-9]$//}
.  endif
d969 5
a973 2
.if defined(IGNOREFILES)
ERRORS += "Fatal: don't use IGNOREFILES"
d976 11
d989 1
a989 1
_CKSUMFILES = ${__CKSUMFILES:S/^/${DIST_SUBDIR}\//}
d991 5
a995 1
_CKSUMFILES = ${__CKSUMFILES}
a1286 7
# mirroring utilities
.if !empty(DIST_SUBDIR)
_ALLFILES = ${ALLFILES:S/^/${DIST_SUBDIR}\//}
.else
_ALLFILES = ${ALLFILES}
.endif

d1528 1
a1528 1
.if !defined(NO_CHECKSUM) && !empty(_CKSUMFILES)
d1530 1
a1530 1
	@@cd ${DISTDIR} && cksum -b -a "${_CIPHERS}" ${_CKSUMFILES} >> ${CHECKSUM_FILE}
d1532 1
a1532 1
		for file in ${_CKSUMFILES}; do \
d1544 1
a1544 1
			cksum -b -a $$cipher ${_CKSUMFILES} >> ${CHECKSUM_FILE}; \
d1547 1
a1547 1
		for file in ${_CKSUMFILES}; do \
d1691 19
d1791 1
a1791 1
		for file in ${_CKSUMFILES}; do \
d1915 2
a1916 1
	subupdate fetch checksum regress depends lib-depends build-depends \
d2300 1
a2300 2
fetch-all:
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes fetch
d2302 1
a2302 3
# Separate target for each file fetch will retrieve

.for _F in ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
a2376 3
.  if defined(SUPDISTFILES) && !empty(SUPDISTFILES) && !defined(__FETCH_ALL)
	@@exec ${MAKE} clean=dist __FETCH_ALL=Yes ECHO_MSG=:
.  else
d2379 1
a2379 1
		rm -f ${_CKSUMFILES}; \
d2381 1
a2381 1
.    if !empty(DIST_SUBDIR)
a2382 1
.    endif
d2413 1
a2413 1
	if ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes _fetch-makefile >$$mk; then \
d2438 1
a2438 1
	@@echo "${_FMN}: ${_ALLFILES} "`_FULL_PACKAGE_NAME=Yes ${MAKE} full-all-depends|fgrep -v ${PKGPATH}/`
d2440 1
a2440 1
	@@echo "${_FMN}: ${_ALLFILES}"
d2443 2
a2444 2
.if !empty(ALLFILES)
.  for _F in ${_ALLFILES}
d2469 1
a2469 1
.  if !defined(NO_CHECKSUM) && !empty(_CKSUMFILES:M${_F})
d3015 1
@


1.933
log
@slightly simpler hook loops: use :U just once, since it applies to
every word. Also use :T to select the final word of the PKGPATH, so
that hooks work seamlessly for `non-core' modules, thus removing the
need for most modules to be core.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.932 2008/05/11 11:19:19 espie Exp $
d738 1
a738 1
	MAINTAINER ^BASE_PKGPATH ^LOCALBASE
@


1.932
log
@put back a default definition of FAKE_FLAGS, for style, since this did not
break anything.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.931 2008/05/11 11:12:09 espie Exp $
d1468 5
a1472 5
.  for _m in ${MODULES}
.    if defined(MOD${_m:U}_pre-install)
	@@${MOD${_m:U}_pre-install}
.    elif defined(MOD${_m:U}_pre_install)
	@@${MOD${_m:U}_pre_install}
d2061 3
a2063 3
.for _m in ${MODULES}
.  if defined(MOD${_m:U}_post-patch)
	@@${MOD${_m:U}_post-patch}
d2099 3
a2101 3
.  for _c in ${CONFIGURE_STYLE:L}
.    if defined(MOD${_c:U}_configure)
	@@${MOD${_c:U}_configure}
d2180 3
a2182 3
.for _m in ${MODULES}
.  if defined(MOD${_m:U}_pre-fake)
	@@${MOD${_m:U}_pre-fake}
@


1.931
log
@conform to other hook naming.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.930 2008/05/08 22:35:51 espie Exp $
d303 1
@


1.930
log
@sanity check: one CATEGORY should match the PKGPATH.
Surprisingly, this catches about 20 ports with their pants down.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.929 2008/05/06 19:20:16 ajacoutot Exp $
d1468 3
a1470 1
.    if defined(MOD${_m:U}_pre_install)
@


1.929
log
@- add ^LOCALBASE to SUBST_VARS; now that SUBST_CMD is here, this will
become handy

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.928 2008/05/04 12:58:03 espie Exp $
d1040 13
d1054 1
@


1.928
log
@use a trap to remove the tmp file, thus helping making sure it does not
stay around
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.927 2008/05/04 12:53:14 espie Exp $
d737 1
a737 1
	MAINTAINER ^BASE_PKGPATH
@


1.927
log
@make the lock on distfile more useful. In case we got stuck in the
SIMPLE_LOCK for a while, this means something else isfetching
the same distfile, so first check whether our target actually exists
before we try to fetch it all over again.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.926 2008/04/12 13:04:21 espie Exp $
d2374 1
d2379 1
a2379 2
	fi; \
	rm -f $$mk
@


1.926
log
@extend VAR_SUBST syntax slightly: a supplementary ^ at the beginning of
the variable subst means the subst shouldn't occur anywhere, but only at
beginning of name... useful for backsubst of SYSCONFDIR, since etc is so
frequent. Extended to other variables such as PREFIX.

tweak make-plist to use OpenBSD::Subst.

*this means this only works with current, but you've had a week to update...*
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.925 2008/04/07 11:12:42 espie Exp $
d2270 1
@


1.925
log
@add support for SUBST_CMD
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.924 2008/03/29 01:58:33 pvalchev Exp $
d736 2
a737 2
SUBST_VARS += MACHINE_ARCH ARCH HOMEPAGE PREFIX SYSCONFDIR FLAVOR_EXT \
	MAINTAINER BASE_PKGPATH
d756 3
a758 3
.    if defined(${_v}${_S})
PKG_ARGS${_S} += -D${_v}=${${_v}${_S}:Q}
_tmpvars += ${_v}${_S}=${${_v}${_S}:Q}
d760 2
a761 2
PKG_ARGS${_S} += -D${_v}=${${_v}:Q}
_tmpvars += ${_v}=${${_v}:Q}
d767 1
a767 1
SUBST_CMD += -D${_v}=${${_v}:Q}
@


1.924
log
@'sh' now has shared libs; from brad
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.923 2008/01/12 14:12:43 espie Exp $
d764 6
@


1.923
log
@make it possible to lock/unlock manually a given directory.
This can be used to work on a port update while building other stuff
without risking the global build from interfering until the update is
finished.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.922 2008/01/04 18:38:51 espie Exp $
d107 1
a107 1
NO_SHARED_ARCHS = m88k sh vax
@


1.922
log
@do the same thing with REGRESS_FLAGS as FAKE_FLAGS
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.921 2008/01/04 17:48:35 espie Exp $
d1876 10
d2990 2
a2991 1
	subpackage uninstall update-patches update-plist mirror-maker-fetch
@


1.921
log
@tweak FAKE_FLAGS semantics to saner defaults.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.920 2007/12/28 12:49:12 espie Exp $
d614 2
a615 1
REGRESS_FLAGS ?= ${MAKE_FLAGS}
d2124 1
a2124 1
		${MAKE_PROGRAM} ${REGRESS_FLAGS} -f ${MAKE_FILE} ${REGRESS_TARGET} ${REGRESS_LOG}
@


1.920
log
@scaffold for running make in parallel, to be documented soon.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.919 2007/12/28 12:46:03 espie Exp $
a303 3
.if !defined(FAKE_FLAGS)
FAKE_FLAGS = ${DESTDIRNAME}=${WRKINST}
.endif
a322 1
FAKE_FLAGS += LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}" ${_lt_libs}
d326 3
d338 1
a338 1
FAKE_FLAGS += -j${MAKE_JOBS}
d2168 1
a2168 1
		${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
@


1.919
log
@add a PKGDB_LOCK that can be used by pkg_add to -F nolock in src/ build
mode.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.918 2007/12/05 06:55:41 jolan Exp $
d329 13
@


1.918
log
@support .tbz2, ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.917 2007/12/01 14:44:47 merdely Exp $
d146 3
d151 3
d1440 1
a1440 1
	@@if pkg_info -q -e ${FULLPKGNAME${_S}}; then \
d1459 1
a1459 1
	@@a=`pkg_info -e ${FULLPKGPATH${_S}} 2>/dev/null || true`; \
d1580 1
a1580 1
				if pkg_info -q -e "$$pkg"; then \
d2635 1
a2635 1
			if pkg_info -q -e $$pkg; then \
@


1.917
log
@Create $PLIST_DB directory if defined.
Fix a spacing nit.

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.916 2007/09/30 15:07:40 steven Exp $
d965 1
a965 1
.if !empty(EXTRACT_ONLY:M*.tar.bz2) || \
d984 1
a984 1
EXTRACT_CASES += *.tar.bz2) \
@


1.916
log
@protect FLAVOR with :Q when passed to the shell, since it may contain
whitespace.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.915 2007/09/21 08:04:06 steven Exp $
d2164 1
a2164 1
_register_plist = perl ${PORTSDIR}/infrastructure/package/register-plist ${PLIST_DB}
d2167 1
a2167 1
_check_lib_depends =perl ${PORTSDIR}/infrastructure/package/check-lib-depends -d ${_PKG_REPO} -B ${WRKINST}
@


1.915
log
@pass FLAVOR to update-plist.

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.914 2007/09/21 06:58:21 steven Exp $
d1809 1
a1809 1
_extra_info += DEPPATHS${_s}="`${SETENV} FLAVOR=${FLAVOR} SUBPACKAGE=${_s} ${MAKE} run-dir-depends ${_do_libs_too}|${_sort_dependencies}`"
@


1.914
log
@use :Q for BROKEN

ok sturm@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.913 2007/09/16 21:38:34 naddy Exp $
d1809 1
a1809 1
_extra_info += DEPPATHS${_s}="`${SETENV} SUBPACKAGE=${_s} ${MAKE} run-dir-depends ${_do_libs_too}|${_sort_dependencies}`"
@


1.913
log
@quote shell meta characters when generating readmes; ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.912 2007/07/28 12:58:34 espie Exp $
d1105 1
a1105 1
IGNORE = "is marked as broken: ${BROKEN}"
@


1.912
log
@make mirror-maker sturdier:
- pass an argument for the file into which we want to save the result, to
avoid getting it polluted with error messages (defaults to /dev/stdout for
debug).
- create the makefile fragment as a temp file and only copy it when complete.
- copy it in one chunk, so that one can read a partial mirror-maker file
and have it be usable.

This does allow for people to start a make mirror-maker in one shell, and
start fetching stuff right away, before mirror-maker is finished.

This also produces usable mirror-maker Makefiles even if the ports tree
contains bogus entries.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.911 2007/07/09 13:32:56 espie Exp $
d2495 1
a2495 1
	@@echo ${_COMMENT${_S}} | ${HTMLIFY} >${TMPDIR}/comment${_S}
@


1.911
log
@make sure ARCH gets defined also for individual port.
Noticed by Stuart Henderson
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.910 2007/07/08 17:57:56 espie Exp $
d72 1
d2337 7
a2343 1
	@@exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes _fetch-makefile
@


1.910
log
@avoid recomputing ARCH all the time.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.909 2007/06/30 14:48:04 espie Exp $
d101 1
a101 1
#ARCH ?!= uname -m
@


1.909
log
@better, make it fetch file under DISTDIR
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.908 2007/06/30 14:43:49 espie Exp $
d101 1
a101 1
ARCH != uname -m
@


1.908
log
@debug target for mirror-maker: allows one to check quickly whether a given port
generates correct mirror-maker fragments.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.907 2007/06/29 10:24:23 espie Exp $
d2341 2
a2342 1
	${MAKE} -f $$mk all FETCH=${PORTSDIR}/infrastructure/fetch/fetch-all
@


1.907
log
@add support for FTP_KEEPALIVE.
You need a somewhat current ftp(1) for this to work !!!
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.906 2007/06/23 09:39:18 steven Exp $
d2338 5
d2953 1
a2953 1
	subpackage uninstall update-patches update-plist
@


1.906
log
@log results of regression tests into a file.

ok simon@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.905 2007/06/18 23:04:02 jakemsr Exp $
d141 2
a142 1
FETCH_CMD ?= /usr/bin/ftp -V -m
@


1.905
log
@pass $PORTSDIR to ${PORTSDIR}/infrastructure/package/check-lib-depends

"Sure" espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.904 2007/06/16 09:57:03 espie Exp $
d595 2
d2099 1
a2099 1
	@@cd ${.CURDIR} && exec ${MAKE} do-regress
d2103 1
a2103 1
		${MAKE_PROGRAM} ${REGRESS_FLAGS} -f ${MAKE_FILE} ${REGRESS_TARGET}
@


1.904
log
@tweak FETCH_PACKAGES: do not fetch all multi-packages to satisfy a
dependency, but only the ones actually required.
If we end up needing to rebuild them from source, then change back
to _internal-package-only, so that we benefit from the whole build
and get all packages again.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.903 2007/06/04 12:15:09 espie Exp $
d1659 1
a1659 1
	@@perl ${PORTSDIR}/infrastructure/package/check-lib-depends \
d1668 1
a1668 1
	 perl ${PORTSDIR}/infrastructure/package/check-lib-depends \
@


1.903
log
@put all phony targets inside a variable, so I can check quickly that those
targets do still exist.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.902 2007/06/03 22:30:25 espie Exp $
d1380 1
a1380 1
		cd ${.CURDIR} && ${MAKE} _TRIED_FETCHING_${_PACKAGE_COOKIE${_S}}=Yes $@@
d1415 3
d1419 1
@


1.902
log
@since we no longer have to tsort the output of _print-package-args,
we can compute it first, and only start pkg_create if it didn't error
out.

This gets rid of the very verbose and confusing error messages
pkg_create meets when the ports tree cannot solve some dependencies.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.901 2007/06/03 12:51:59 espie Exp $
d2915 9
a2923 11
.PHONY: \
	${_recursive_targets} ${_recursive_describe_targets}  \
	${_recursive_depends_targets} \
	_build-dir-depends _fetch-makefile _fetch-onefile _internal-all \
	_internal-build _internal-build-depends _internal-buildlib-depends \
	_internal-buildwantlib-depends _internal-checksum _internal-clean \
	_internal-configure _internal-depends _internal-distpatch \
	_internal-extract _internal-fake _internal-fetch _internal-install-all \
	_internal-lib-depends _internal-manpages-check _internal-package \
	_internal-package-only _internal-plist _internal-regress \
	_internal-regress-depends _internal-run-depends \
d2942 10
@


1.901
log
@reorganize to avoid repeating lists of targets:
classify stuff that is used in bsd.port.subdir.mk, name them in pkgpath.mk,
and use them as .PHONY targets in both bsd.port.mk and bsd.port.subdir.mk.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.900 2007/06/03 11:06:41 espie Exp $
d2177 8
a2184 1
	@@${_plist_header}; ${PKG_CMD} -n -q `SUBPACKAGE=${SUBPACKAGE} ${MAKE} _print-package-args` ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}};${_plist_footer}
d2195 8
a2202 1
	@@${_plist_header}; ${PKG_CMD} -n -q `SUBPACKAGE=${_S} ${MAKE} _print-package-args` ${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}};${_plist_footer}
@


1.900
log
@tell make-plist about .saved-libs
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.899 2007/06/03 11:03:06 espie Exp $
d2902 28
a2929 55
	_build-dir-depends _fetch-makefile _fetch-onefile \
	_print-packagename \
	_recurse-all-dir-depends \
	_recurse-run-dir-depends _refetch \
	addsum _print-package-args \
	all all-dir-depends build \
	build-depends build-depends-list build-dir-depends \
	checkpatch checksum clean \
	clean-depends configure deinstall \
	delete-package \
	depends \
	describe distclean distpatch \
	do-build do-configure do-distpatch \
	do-extract do-fetch do-install \
	do-package do-regress extract \
	fake fetch fetch-all \
	fetch-makefile full-all-depends full-build-depends \
	full-run-depends homepage-links install \
	lib-depends lib-depends-check lib-depends-list \
	link-categories makesum manpages-check \
	package patch \
	plist post-build post-configure \
	post-distpatch post-extract post-fetch \
	post-install post-package post-patch \
	post-regress pre-build pre-configure \
	pre-extract pre-fake pre-fetch \
	pre-install pre-package pre-patch \
	pre-regress print-build-depends print-package-signature \
	print-run-depends \
	readmes readme rebuild \
	regress regress-depends \
	reinstall repackage run-depends \
	run-depends-list run-dir-depends show verbose-show dump-vars \
	uninstall unlink-categories update-patches \
	update-plist port-lib-depends-check \
	license-check _license-check \
	_internal-extract _internal-distpatch _internal-configure \
	_internal-build _internal-all _internal_install _internal-fake \
	_internal-package _internal-package-only \
	_internal-fetch _internal-checksum \
	_internal-depends _internal-lib-depends _internal-buildwantlib-depends \
	_internal-runwantlib-depends \
	_internal-buildlib-depends _internal_runlib-depends \
	_internal-build-depends \
	_internal-run-depends _internal-regress-depends \
	_internal-regress _internal-clean \
	_internal-manpages-check _internal-plist _internal-update-plist \
	_internal-update update print-plist print-plist-contents \
	_list-port-libs _print-package-signature-lib _print-package-signature-run \
	show-required-by peek-ftp _internal-subpackage \
	_internal-install-all install-all \
	subpackage _internal-subupdate _internal-update \
	regress-dir-depends _recurse-regress-dir-depends \
	full-regress-depends print-plist-all \
	print-plist-with-depends print-plist-all-with-depends
@


1.899
log
@Let lock save the BUILD_PKGPATH.

Do port-lib-depends-check in two steps: first generate a list of
binary: lib1,lib2,lib3
in WRKINST/.saved_libs
then run check-lib-depends on it.

Speeds up tweaks to WANTLIB quite a lot, as we do not rescan every
binary all the time...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.898 2007/06/01 13:15:21 espie Exp $
d1813 1
a1813 1
	OKAY_FILES='${_FAKE_COOKIE} ${_INSTALL_PRE_COOKIE}' \
@


1.898
log
@finish renaming check-newlib-depends -> check-lib-depends
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.897 2007/05/31 10:52:16 espie Exp $
d1310 1
a1310 1
_LOCK = echo "Locking $$lock from $@@"; ${LOCK_CMD} ${LOCKDIR}/$$lock.lock
d1313 1
a1313 1
_LOCK = ${LOCK_CMD} ${LOCKDIR}/$$lock.lock
d1658 4
a1661 1
port-lib-depends-check: ${_FAKE_COOKIE}
d1665 1
a1665 1
		${_LIB_DEPENDS_FLAGS} -d ${_PKG_REPO} -B ${WRKINST}
@


1.897
log
@kill REQ script support, flag INSTALL/DEINSTALL as warnings.
Remove obsolete _PKG_PREREQ cruft.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.896 2007/05/27 11:53:39 espie Exp $
d1648 1
a1648 1
_NEWLIB_DEPENDS_FLAGS=-o
d1650 1
a1650 1
_NEWLIB_DEPENDS_FLAGS=
d1655 2
a1656 2
	@@perl ${PORTSDIR}/infrastructure/package/check-newlib-depends \
		${_NEWLIB_DEPENDS_FLAGS} -d ${_PKG_REPO} ${_PACKAGE_COOKIE}
d1661 2
a1662 2
	 perl ${PORTSDIR}/infrastructure/package/check-newlib-depends \
		${_NEWLIB_DEPENDS_FLAGS} -d ${_PKG_REPO} -B ${WRKINST}
d2156 1
a2156 1
_check_lib_depends =perl ${PORTSDIR}/infrastructure/package/check-newlib-depends -d ${_PKG_REPO} -B ${WRKINST}
@


1.896
log
@use the same rules to represent comments in describe that are used to
build packages.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.895 2007/05/25 13:07:41 espie Exp $
d765 1
d769 1
d773 1
a773 1
PKG_ARGS- += -r ${PKGDIR}/REQ
d806 1
d810 1
d814 1
a814 1
PKG_ARGS${_S} += -r ${PKGDIR}/REQ${_S}
a824 2
_PKG_PREREQ =

d1382 1
a1382 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS} ${_PKG_PREREQ}
@


1.895
log
@use the new features of pkg_create. A few packages may no longer build
without a packagename bump, or because they have too long comments.

steven@@ and I cleaned up most of them.

As a result, there's no longer any WRKPKG directory with their temporary
files.

We also use the `sort -u' feature of pkg_create for dependencies, so that
the command lines to pkg_create get simpler, which will allow for easier
error-checking later on.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.894 2007/05/21 11:18:10 steven Exp $
d2396 1
a2396 1
	@@echo -n ${_COMMENT${_S}}"|"; \
@


1.894
log
@add clean=plist to clean a port's registered plists.

fine with bernd@@, ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.893 2007/05/01 17:17:54 sturm Exp $
a583 1
WRKPKG ?= ${WRKBUILD}/pkg
a585 1
WRKPKG ?= ${WRKDIR}/pkg
a715 1
_SED_SUBST = sed
d722 2
a723 3
_PKG_ARGS += -DFLAVORS='${FLAVOR_EXT}'
_tmpvars += FLAVORS='${FLAVOR_EXT}'
_SED_SUBST += -e 's,$${FLAVORS},${FLAVOR_EXT},g' -e 's,$$\\,$$,g'
a729 1
_SED_SUBST${_S} = ${_SED_SUBST}
d734 2
a735 3
PKG_ARGS${_S} += -D${_v}='${${_v}${_S}}'
_SED_SUBST${_S} += -e 's|$${${_v}}|${${_v}${_S}}|g'
_tmpvars += ${_v}${_S}='${${_v}${_S}}'
d737 2
a738 3
_SED_SUBST${_S} += -e 's|$${${_v}}|${${_v}}|g'
PKG_ARGS${_S} += -D${_v}='${${_v}}'
_tmpvars += ${_v}='${${_v}}'
d825 1
a825 2
_PKG_PREREQ += ${WRKPKG}/DESCR${_S} ${WRKPKG}/COMMENT${_S}
PKG_ARGS${_S} += -c '${WRKPKG}/COMMENT${_S}' -d ${WRKPKG}/DESCR${_S}
d1392 1
a1392 1
	  if ${SUDO} ${PKG_CMD} `echo "$$deps"|sort -u` ${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}}; then \
a1434 11
# create the packing stuff from source
${WRKPKG}/COMMENT${_S}:
	@@echo ${_COMMENT${_S}} >$@@

${WRKPKG}/DESCR${_S}: ${DESCR${_S}}
	@@${_SED_SUBST${_S}} <$? >$@@.tmp && mv -f $@@.tmp $@@
	@@echo "\nMaintainer: ${MAINTAINER}" >>$@@
.  if defined(HOMEPAGE)
	@@fgrep -q '$${HOMEPAGE}' $? || echo "\nWWW: ${HOMEPAGE}" >>$@@
.  endif

d2026 1
a2026 1
	@@mkdir -p ${WRKBUILD} ${WRKPKG}
d2110 1
a2110 1
	@@${_SED_SUBST} ${MTREE_FILE}| \
d2172 1
a2172 1
	@@${_plist_header}; ${PKG_CMD} -n -q `SUBPACKAGE=${SUBPACKAGE} ${MAKE} _print-package-args|sort -u` ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}};${_plist_footer}
d2183 1
a2183 1
	@@${_plist_header}; ${PKG_CMD} -n -q `SUBPACKAGE=${_S} ${MAKE} _print-package-args|sort -u` ${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}};${_plist_footer}
d2303 3
a2305 1
	cd ${PLIST_DB} && rm -f ${PKGNAMES}
@


1.893
log
@fix the recursive case for FETCH_PACKAGES by appending the PACKAGE_COOKIE
to _TRIED_FETCHING, this broke in 1.774

ok bernd, espie
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.892 2007/04/30 12:44:46 espie Exp $
d196 1
a196 1
	readmes bulk force
d2320 3
@


1.892
log
@pedantic fix: typo without actual consequences.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.891 2007/04/08 11:26:39 espie Exp $
d1382 1
a1382 1
.  if ${FETCH_PACKAGES:L} == "yes" && !defined(_TRIED_FETCHING)
d1386 1
a1386 1
		cd ${.CURDIR} && ${MAKE} _TRIED_FETCHING=Yes $@@
@


1.891
log
@port-lib-depends-check should ignore errors, because it's much less useful
that way.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.890 2007/04/05 18:32:26 espie Exp $
d2202 1
a2202 1
	@@${_plist_header}; ${PKG_CMD} -n -q `SUBPACKAGE=${_S} ${MAKE} _print-package-args|sort -u `${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}};${_plist_footer}
@


1.890
log
@sha256 by default
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.889 2007/04/03 13:32:45 espie Exp $
d1677 1
a1677 1
	@@SUBPACKAGE=${_S} ${MAKE} print-plist-with-depends | \
@


1.889
log
@revert order of tests, if CHECK_LIB_DEPENDS is active, do not register plist
until we're satisfied.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.888 2007/04/03 10:14:14 espie Exp $
d495 1
a495 1
_CIPHERS = sha1 rmd160 md5 sha256
@


1.888
log
@allow people to run check-lib-depends automatically, grabbing the files
from WRKINST and the packing-list from the just built package.
Reuse the register_plist pattern.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.887 2007/03/31 15:36:43 espie Exp $
d1402 2
a1403 2
		if ${_register_plist} ${_PACKAGE_COOKIE${_S}} && \
			${_check_lib_depends} ${_PACKAGE_COOKIE${_S}}; then \
@


1.887
log
@new target: port-lib-depends-check, can verify libraries directly from the
fake area, without needing to build bogus packages first.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.886 2007/03/30 13:44:50 espie Exp $
d76 1
d1402 3
a1404 2
		if ${_register_plist} ${_PACKAGE_COOKIE${_S}}; then \
			exit 0; \
d1489 1
a1489 1
	@@cd ${DISTDIR} && cksum -a "${_CIPHERS}" ${_CKSUMFILES} >> ${CHECKSUM_FILE}
d1503 1
a1503 1
			cksum -a $$cipher ${_CKSUMFILES} >> ${CHECKSUM_FILE}; \
d2171 5
@


1.886
log
@like xenocara: REORDER_DEPENDENCIES has been tested enough, silence it
by default.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.885 2007/03/30 13:41:44 espie Exp $
d1673 7
d2938 1
a2938 1
	update-plist \
d2949 1
a2949 2
	_internal-regress _internal-clean _internal-lib-depends-check \
	_internal-newlib-depends-check \
@


1.885
log
@CHECKSUM_FILE never changes -> can be used directly
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.884 2007/03/28 15:45:03 espie Exp $
d1303 1
d2018 1
a2018 1
				do echo "Touching $$i"; touch $$i; done \
d2022 1
a2022 1
				echo "Touching $$f"; touch $$f; \
@


1.884
log
@tweak the way mirror-maker emits stuff, so that the Makefile contains lines
suitable for cksum -c.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.883 2007/03/28 13:21:43 espie Exp $
d1711 1
a1711 2
	@@checksum_file=${CHECKSUM_FILE}; \
	if [ -z "${DISTFILES}" ]; then \
d1713 1
a1713 1
	elif [ ! -f $$checksum_file ]; then \
d1720 1
a1720 1
			set -- `grep -i "^$$cipher ($$file)" $$checksum_file` && break || \
d1744 1
a1744 1
			echo "Make sure the Makefile and checksum file ($$checksum_file)"; \
d2356 2
a2357 3
	@@checksum_file=${CHECKSUM_FILE}; \
	if [ ! -f $$checksum_file ]; then \
	  echo >&2 "Missing checksum file: $$checksum_file"; \
d2361 1
a2361 1
		if set -- `grep -i "^$$c (${_F})" $$checksum_file`; then break; fi; \
d2368 1
a2368 1
		  echo >&2 "Checksum for ${_F} is IGNORE in $$checksum_file"; \
@


1.883
log
@use cksum -c so we can get `magic' base64/hex matching.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.882 2007/03/15 18:11:54 naddy Exp $
d2374 1
a2374 1
		  echo "\t CIPHER=\"$$c\" CKSUM=\"$$4\" \\";; \
@


1.882
log
@makesum: don't try to create distinfo if there are no distfiles; ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.881 2007/02/16 19:08:54 espie Exp $
d1732 2
a1733 5
			  CKSUM=`cksum -a $$cipher < $$file`; \
			  case "$$CKSUM" in \
			  	"$$4") \
				  ${ECHO_MSG} ">> Checksum OK for $$file. ($$cipher)";; \
				*) \
d1736 2
a1737 2
				  OK=false;; \
			  esac;; \
@


1.881
log
@use _CKSUMFILES in clean=dist, and recurse if we notice there are
SUPDISTFILES, so we get them as well.

This misbehavior noticed by Mikolaj Kucharski.

(the intention is obviously to regrab everything to verify whether
anything changed, and that includes SUPDISTFILES)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.880 2007/02/11 11:44:17 espie Exp $
d1484 1
a1484 1
.if !defined(NO_CHECKSUM)
@


1.880
log
@use cksum -a $$cipher instead of $$cipher to compute crypto hashes.

Only functional change:
Add sha256 at the end of the list of supported ciphers, so that new
makesums will add the new cipher.

The rest is business as usual.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.879 2007/02/06 20:04:01 espie Exp $
d2280 3
d2284 2
a2285 2
	@@if cd ${FULLDISTDIR} 2>/dev/null; then \
		rm -f ${_DISTFILES} ${_PATCHFILES}; \
d2287 1
a2287 1
.  if !empty(DIST_SUBDIR)
d2289 1
@


1.879
log
@minor tidbit: define FULLPKGPATH based on FULLPKGPATH${SUBPACKAGE} in
the multi-packages case, as should be.

introduce _ALLPKGPATHS, and use it in show-required-by, so that
show-required-by works for multi-packages.

problem noticed by bernd@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.878 2007/01/15 13:43:52 espie Exp $
d494 1
a494 1
_CIPHERS = sha1 rmd160 md5
d1486 1
a1486 4
	@@cd ${DISTDIR} && \
		for cipher in ${_CIPHERS}; do \
			$$cipher ${_CKSUMFILES} >> ${CHECKSUM_FILE}; \
	    done
d1500 1
a1500 1
			$$cipher ${_CKSUMFILES} >> ${CHECKSUM_FILE}; \
d1732 1
a1732 1
			  CKSUM=`$$cipher < $$file`; \
@


1.878
log
@add the ability to cleanly delimit embedded plist info.
will help unconfuse lib-depends-check and make-plist wrt error messages.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.877 2007/01/04 11:34:14 bernd Exp $
d650 1
d652 1
a652 1
FULLPKGPATH = ${PKGPATH},${SUBPACKAGE}${FLAVOR_EXT:S/-/,/g}
d655 1
d657 1
d2862 2
a2863 1
	@@cd ${PORTSDIR} && make all-dir-depends | perl ${PORTSDIR}/infrastructure/build/extract-dependencies -r ${FULLPKGPATH}
@


1.877
log
@Fix typo. This unbreaks 'make update'.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.876 2006/12/31 13:12:35 espie Exp $
d2167 9
d2177 1
a2177 1
	@@${PKG_CMD} -n -q ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}
d2180 1
a2180 1
	@@${PKG_CMD} -n -q `SUBPACKAGE=${SUBPACKAGE} ${MAKE} _print-package-args|sort -u` ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}
d2185 1
a2185 1
	@@${PKG_CMD} -n -q ${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}}
d2191 1
a2191 1
	@@${PKG_CMD} -n -q `SUBPACKAGE=${_S} ${MAKE} _print-package-args|sort -u `${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}}
d2195 1
a2195 1
	@@${PKG_CMD} -n -Q ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}
@


1.876
log
@prefer subpackage-dependent version of variables for substitutions.
this lets the correct PREFIX be substituted in packages, among other things.

Problem discovered in php5-extensions
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.875 2006/12/18 12:52:34 espie Exp $
d1460 1
a1460 1
		   ${SUDO} ${SETENV} PKG_PATH=${_PKG_REPO} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} -r ${_PKG_ADD_FORCE} ${PKGFILE${S_}};; \
@


1.875
log
@duplicate the print-plist targets, add a version -with-depends, which is
slower, but shows dependency lines as well...

Also fix target evaluation to work like it does elsewhere
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.874 2006/12/16 11:53:46 espie Exp $
a720 5
.for _v in ${SUBST_VARS}
_SED_SUBST += -e 's|$${${_v}}|${${_v}}|g'
_PKG_ARGS += -D${_v}='${${_v}}'
_tmpvars += ${_v}='${${_v}}'
.endfor
d730 1
d733 11
d1442 1
a1442 1
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
a1807 1
_extra_info += PREFIX${_s}='${PREFIX${_s}}'
@


1.874
log
@activate our pkg-config.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.873 2006/12/11 15:52:14 espie Exp $
d2164 3
d2173 6
d2935 2
a2936 1
	full-regress-depends print-plist-all
@


1.873
log
@repair pkg_mklocatedb from src
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.872 2006/12/11 14:01:03 steven Exp $
d1880 1
a1880 1
	@@ln -s ${LOCALBASE}/bin/pkg-config ${WRKDIR}/bin
@


1.872
log
@DEPPATHS per subpackage,  ok espie
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.871 2006/12/11 13:36:06 espie Exp $
d2166 2
a2167 1
	${PKG_CMD} -n -q ${PKG_ARGS${_S}} ${_PACKAGE_COOKIE${_S}} >/dev/null
@


1.871
log
@pass all subpackage information to make-plist.
Adapt make-plist to use the same code as pkg_create to deduce fragment
names, remove some old special cases that should no longer matter.

Zap directories from dependencies in a way depending on the dependency.
Far from perfect yet, as directories should be registered multiple times
in packages that do not depend on each other, and could also be used to
figure out where to put new files...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.870 2006/12/11 11:05:43 espie Exp $
d1803 1
a1803 1
_extra_info += DEPPATHS${_s}="`${MAKE} run-dir-depends ${_do_libs_too}|${_sort_dependencies}`"
@


1.870
log
@missed a few = signs.
Avoid writing anything when no libspecs.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.869 2006/12/09 14:56:41 espie Exp $
d1799 1
a1799 1
_extra_prefixes =
d1801 3
a1803 1
_extra_prefixes += PREFIX${_s}=`cd ${.CURDIR} && SUBPACKAGE=${_s} ${MAKE} show=PREFIX${_s}`
d1809 2
a1810 2
	@@DESTDIR=${WRKINST} PREFIX=${WRKINST}${PREFIX} \
	TRUEPREFIX=${TRUEPREFIX} \
a1811 1
	DEPPATHS="`${MAKE} run-dir-depends ${_do_libs_too}|${_sort_dependencies}`" \
a1813 2
	PLIST=${PLIST${SUBPACKAGE}} \
	PFRAG=${PKGDIR}/PFRAG \
d1820 1
a1820 1
	${_extra_prefixes} ${_tmpvars}
@


1.869
log
@Add proper "Returning to build of..." to unconfuse the logger in the case
of FORCE_UPDATE.   Also break out in case update fails (otherwise the old
installed package would be enough to continue building).

Sprinkle REPORT_PROBLEM to know more precisely what stuff is breaking.

replace some
if eval cmd; then
with
if (eval exec cmd); then

because if eval... seems to break early, even with the test guard, thus
giving a chance to REPORT_PROBLEM to do stuff instead of having to wait.

(Note: a trap would probably be simpler ?)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.868 2006/12/08 10:19:08 espie Exp $
d1614 1
d1633 1
d1794 1
a1794 1
_do_libs_too=
d1796 1
a1796 1
_do_libs_too=NO_SHARED_LIBS=Yes
d1799 1
a1799 1
_extra_prefixes=
d1801 1
a1801 1
_extra_prefixes+=PREFIX${_s}=`cd ${.CURDIR} && SUBPACKAGE=${_s} ${MAKE} show=PREFIX${_s}`
d2157 1
a2157 1
_register_plist=:
d2159 1
a2159 1
_register_plist=perl ${PORTSDIR}/infrastructure/package/register-plist ${PLIST_DB}
@


1.868
log
@wrap calls for _print-package-args to print reliable errors (better than:
`some Makefile somewhere is broken ! find it')
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.867 2006/12/05 19:23:42 espie Exp $
d1157 6
a1162 1
		eval $$toset ${MAKE} subupdate; \
d1545 1
d1549 1
d1560 1
d1566 1
d1582 1
a1582 1
			if eval $$toset ${MAKE} $$target; then \
d1585 1
@


1.867
log
@ending up with an empty SUBPACKAGE is an explicit error.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.866 2006/12/02 11:27:46 espie Exp $
d2535 8
a2542 3
		default=`eval $$toset ${MAKE} _print-packagename`; \
		case "X$$pkg" in X) pkg=`echo $$default|${_version2default}`;; esac; \
		echo "-P $$subdir:$$pkg:$$default"; \
d2551 2
a2552 6
		default=`eval $$toset ${MAKE} _print-packagename`; \
		case "X$$pkg" in X) pkg=`echo $$default|${_version2default}`;; esac; \
		if pkg_info -q -e $$pkg; then \
			listlibs='echo ${DEPDIR}$$shdir/lib*'; \
			case $$dir in ${PKGPATH}) \
				listlibs="$$toset ${MAKE} print-plist-contents|${_grab_libs_from_plist}; $$listlibs";; \
d2554 20
d2575 2
a2576 1
		    listlibs="$$toset ${MAKE} print-plist-contents|${_grab_libs_from_plist}"; \
a2577 12
		IFS=,; for d in $$dep; do \
			${_libresolve_fragment}; \
			case "$$check" in \
			*.a) continue;; \
			Failed) \
				echo 1>&2 "Can't resolve libspec $$d"; \
				exit 1;; \
			*) \
				echo "-W $$check";; \
			esac; \
		done; \
		echo "-P $$subdir:$$pkg:$$default"; \
@


1.866
log
@move TMPDIR to pkgpath.mk to allow its use from both bsd.port.mk and
bsd.port.subdir.mk

Use absolute paths to build readmes files, based on READMES_TOP, which
can be (or not) PORTSDIR.

Generate category readmes in tmp directory as well.

minor clean-ups
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.865 2006/12/02 11:08:49 espie Exp $
d362 3
a364 1
.if !empty(SUBPACKAGE)
@


1.865
log
@move the generated readme stuff to a temporary directory, much cleaner that way.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.864 2006/12/02 10:27:40 espie Exp $
a122 1
TMPDIR ?= /tmp
d430 1
a430 1
_READMES += ${FULLPKGNAME}.html
d440 1
a440 1
_READMES += ${FULLPKGNAME${_s}}.html
d2404 4
a2407 1
	@@tmpdir=`mktemp -d ${TMPDIR}/readme.XXXXXX`; trap 'rm -r $$tmpdir' 0 1 2 3 13 15; cd ${.CURDIR} && ${MAKE} TMPDIR=$$tmpdir README_NAME=${README_NAME} ${FULLPKGNAME${SUBPACKAGE}}.html
d2410 4
a2413 1
	@@tmpdir=`mktemp -d ${TMPDIR}/readme.XXXXXX`; trap 'rm -r $$tmpdir' 0 1 2 3 13 15; cd ${.CURDIR} && ${MAKE} TMPDIR=$$tmpdir README_NAME=${README_NAME} ${_READMES}
d2416 2
a2417 1
${FULLPKGNAME${_S}}.html:
@


1.864
log
@fix READMES again
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.863 2006/12/01 17:56:38 espie Exp $
d2405 1
a2405 1
	@@cd ${.CURDIR} && exec ${MAKE} README_NAME=${README_NAME} ${FULLPKGNAME${SUBPACKAGE}}.html
d2408 1
a2408 1
	@@cd ${.CURDIR} && exec ${MAKE} README_NAME=${README_NAME} ${_READMES}
d2412 2
a2413 2
	@@echo ${_COMMENT${_S}} | ${HTMLIFY} >$@@.tmp-comment
	@@echo ${FULLPKGNAME${_S}} | ${HTMLIFY} > $@@.tmp3
d2415 1
a2415 1
	@@echo 'See <a href="${HOMEPAGE}">${HOMEPAGE}</a> for details.' >$@@.tmp4
d2417 1
a2417 1
	@@echo "" >$@@.tmp4
d2420 2
a2421 2
	@@echo "<h2>Part of a Multi-Package set</h2>" >$@@.tmp-subpackages
	@@echo "<ul>" >>$@@.tmp-subpackages
d2423 1
a2423 1
	@@echo "<li><a href=\"${FULLPKGNAME${_T}}.html\">${FULLPKGNAME${_T}}</a>" >>$@@.tmp-subpackages
d2425 1
a2425 1
	@@echo "</ul>" >>$@@.tmp-subpackages
d2427 1
a2427 1
	@@>$@@.tmp-subpackages
d2435 1
a2435 1
		 done  >$@@.tmp-${_I}
d2437 1
a2437 1
	@@echo "<li>none" >$@@.tmp-${_I}
d2440 10
a2449 11
	@@cat ${README_NAME} | \
		sed -e 's|%%PORT%%|'"`echo ${FULLPKGPATH${_S}}  | ${HTMLIFY}`"'|g' \
			-e '/%%PKG%%/r$@@.tmp3' -e '//d' \
			-e '/%%COMMENT%%/r$@@.tmp-comment' -e '//d' \
			-e '/%%DESCR%%/r${DESCR${_S}}' -e '//d' \
			-e '/%%HOMEPAGE%%/r$@@.tmp4' -e '//d' \
			-e '/%%BUILD_DEPENDS%%/r$@@.tmp-build' -e '//d' \
			-e '/%%RUN_DEPENDS%%/r$@@.tmp-run' -e '//d' \
 			-e '/%%SUBPACKAGES%%/r$@@.tmp-subpackages' -e '//d' \
		>> $@@
	@@rm -f $@@.tmp*
@


1.863
log
@let license-check recurse correctly, thus we are checking ALL licences,
finally.

Remove work-around for undefined SUBPACKAGE stuff, since we're no longer
hardcoding it at the Makefile level, and thus the ERROR check works.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.862 2006/12/01 17:37:15 espie Exp $
a2264 1
.    endfor
d2419 1
a2419 1
.  if ${MULTI_PACKAGES} != "!-"
@


1.862
log
@use the pkg-config in /usr/local preferably, until we get a decent
pkg-config in /usr/bin...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.861 2006/12/01 17:33:16 espie Exp $
d602 1
a602 1
.for _s in ${MULTI_PACKAGES} ${SUBPACKAGE}
d609 1
a609 1
.for _s in ${MULTI_PACKAGES} ${SUBPACKAGE}
d2478 4
a2481 3
.if ${PERMIT_PACKAGE_CDROM${SUBPACKAGE}:L} == "yes" || \
	${PERMIT_PACKAGE_FTP${SUBPACKAGE}:L} == "yes"
	@@${MAKE} all-dir-depends|${_sort_dependencies}|while read subdir; do \
d2483 2
a2484 2
		_MASTER_PERMIT_CDROM=${PERMIT_PACKAGE_CDROM${SUBPACKAGE}:Q}; \
		_MASTER_PERMIT_FTP=${PERMIT_PACKAGE_FTP${SUBPACKAGE}:Q}; \
d2488 2
a2489 1
.endif
@


1.861
log
@remove the last redirectors, regenerate readmes on the fly...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.860 2006/12/01 11:34:04 espie Exp $
d1868 1
@


1.860
log
@make it possible to override a FULLPKGPATH if you REALLY know what you're
doing... DO NOT USE, unless you really know.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.859 2006/11/30 23:08:07 espie Exp $
d428 1
d431 1
d441 1
a1841 14
# Redirectors for top-level targets involving subpackages
.for _t _r in readmes _readme
${_t}:
.  if ${MULTI_PACKAGES} == "-"
	@@cd ${.CURDIR} && exec ${MAKE} ${_r}
.  else
.    for _s in ${MULTI_PACKAGES}
	@@${ECHO_MSG} "===> ${PKGPATH}${FLAVOR_EXT:S/-/,/g},${_s}"
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' exec ${MAKE} ${_r}
.    endfor
.  endif
.endfor


d2263 1
a2263 2
.    for _s in ${MULTI_PACKAGES}
	rm -f ${.CURDIR}/${FULLPKGNAME${_s}}.html
d2404 1
a2404 1
_readme:
d2407 8
a2414 4
${FULLPKGNAME${SUBPACKAGE}}.html:
	@@echo ${_COMMENT${SUBPACKAGE}} | ${HTMLIFY} >$@@.tmp-comment
	@@echo ${FULLPKGNAME${SUBPACKAGE}} | ${HTMLIFY} > $@@.tmp3
.if defined(HOMEPAGE)
d2416 1
a2416 1
.else
d2418 3
a2420 4
.endif
.if defined(MULTI_PACKAGES)
.  if empty(SUBPACKAGE)
	@@echo "<h2>Subpackages</h2>" >$@@.tmp-subpackages
d2422 2
a2423 4

.    for _S in ${MULTI_PACKAGES}
	@@name=`SUBPACKAGE=${_S} ${MAKE} _print-packagename _FULL_PACKAGE_NAME=No`; \
	echo "<li><a href=\"$$name.html\">$$name</a>" >>$@@.tmp-subpackages
d2427 1
a2427 2
	@@name=`unset SUBPACKAGE; ${MAKE} _print-packagename _FULL_PACKAGE_NAME=No`; \
	echo "<h2>Subpackage of <a href=\"$$name.html\">$$name</a></h2>" >$@@.tmp-subpackages
d2429 3
a2431 6
.else
	@@>$@@.tmp-subpackages
.endif
.for _I in build run
.  if !empty(_${_I:U}_DEP)
	@@cd ${.CURDIR} && ${MAKE} full-${_I}-depends _FULL_PACKAGE_NAME=Yes| \
d2436 1
a2436 1
.  else
d2438 2
a2439 2
.  endif
.endfor
d2441 1
a2441 1
		sed -e 's|%%PORT%%|'"`echo ${FULLPKGPATH}  | ${HTMLIFY}`"'|g' \
d2444 1
a2444 1
			-e '/%%DESCR%%/r${PKGDIR}/DESCR${SUBPACKAGE}' -e '//d' \
d2451 1
a2451 1

d2870 1
a2870 1
	readmes _readme rebuild \
@


1.859
log
@fix describe
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.858 2006/11/29 09:42:08 espie Exp $
d644 1
a644 1
FULLPKGPATH = ${PKGPATH}${FLAVOR_EXT:S/-/,/g}
d649 1
a649 1
FULLPKGPATH${_S} = ${PKGPATH},${_S}${FLAVOR_EXT:S/-/,/g}
@


1.858
log
@un-recursive dump-vars, remove vars that don't make a lot of sense now.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.857 2006/11/28 23:13:30 espie Exp $
d2365 1
a2365 1
	@@echo -n "${FULLPKGNAME${_S}}|${FULLPKGPATH}|"
@


1.857
log
@hidden SUBPACKAGE in _register_plist: put it back into ${_PACKAGE_COOKIE${_S}}
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.856 2006/11/28 20:40:55 espie Exp $
d85 1
a85 1
	SHARED_LIBS USE_MOTIF PACKAGES MASTER_SITES \
d88 1
a88 1
	MAINTAINER SUBPACKAGE SUPDISTFILES \
d1840 1
a1840 1
.for _t _r in dump-vars subdump-vars readmes _readme
d2833 21
a2853 11
subdump-vars:
.for _s in ${_ALL_VARIABLES}
. if defined(${_s})
	@@echo ${FULLPKGPATH}.${_s}=${${_s}:Q}
. endif
.endfor
.for _s in ${_ALL_VARIABLES_INDEXED}
. if defined(${_s}${SUBPACKAGE})
	@@echo ${FULLPKGPATH}.${_s}=${${_s}${SUBPACKAGE}:Q}
. endif
.endfor
d2907 1
a2907 1
	sublib-depends-check subdump-vars _internal-install-all install-all \
@


1.856
log
@apply the same transformation to install/install-all
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.855 2006/11/28 20:31:25 espie Exp $
d1381 1
a1381 1
		if ${_register_plist}; then \
d2156 1
a2156 1
_register_plist=perl ${PORTSDIR}/infrastructure/package/register-plist ${PLIST_DB} ${_PACKAGE_COOKIE${SUBPACKAGE}}
@


1.855
log
@move a few things around inside one single MULTI_PACKAGES loop
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.854 2006/11/28 20:26:38 espie Exp $
a447 1
_INSTALL_COOKIE =		${PKG_DBDIR}/${FULLPKGNAME${SUBPACKAGE}}/+CONTENTS
d452 1
d455 1
a455 1
_UPDATE_COOKIE${_S} =		${UPDATE_COOKIES_DIR}/${FULLPKGNAME${_S}}
d457 1
a457 1
_UPDATE_COOKIE${_S} =		${WRKDIR}/.update_${FULLPKGNAME${_S}}
d459 3
a461 1
_UPDATE_COOKIES += ${_UPDATE_COOKIE${_S}}
d1356 3
d1395 26
d1449 1
a1449 1
.PRECIOUS: ${_PACKAGE_COOKIES} ${_INSTALL_COOKIE}
d1755 2
a1756 1
_internal-install: ${_INSTALL_COOKIE}
d1840 1
a1840 3
.for _t _r in \
	dump-vars subdump-vars _internal-install-all _internal-install \
	readmes _readme
a2152 24
# The real install

${_INSTALL_COOKIE}:
	@@cd ${.CURDIR} && exec ${MAKE} package
	@@cd ${.CURDIR} && DEPENDS_TARGET=install exec ${MAKE} _internal-run-depends _internal-runlib-depends _internal-runwantlib-depends
	@@${ECHO_MSG} "===>  Installing ${FULLPKGNAME${SUBPACKAGE}} from ${_PKG_REPO}"
.for _m in ${MODULES}
.  if defined(MOD${_m:U}_pre_install)
	@@${MOD${_m:U}_pre_install}
.  endif
.endfor
.if ${TRUST_PACKAGES:L} == "yes"
	@@if pkg_info -q -e ${FULLPKGNAME${SUBPACKAGE}}; then \
		echo "Package ${FULLPKGNAME${SUBPACKAGE}} is already installed"; \
	else \
		${SUDO} ${SETENV} PKG_PATH=${_PKG_REPO} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} ${PKGFILE}; \
	fi
.else
	@@${SUDO} ${SETENV} PKG_PATH=${_PKG_REPO} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} ${PKGFILE}
.endif
	@@-${SUDO} ${_MAKE_COOKIE} $@@

# The real package

d2263 1
a2263 3
.    for _s in ${MULTI_PACKAGES}
	-${SUDO} ${PKG_DELETE} ${FULLPKGNAME${_s}}
.    endfor
@


1.854
log
@fix a typo
mv some PKG_ARGS where they belong, and s/SUBPACKAGE/_S
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.853 2006/11/28 20:20:25 espie Exp $
d1390 26
a1432 13
.for _S in ${MULTI_PACKAGES}
# create the packing stuff from source
${WRKPKG}/COMMENT${_S}:
	@@echo ${_COMMENT${_S}} >$@@

${WRKPKG}/DESCR${_S}: ${DESCR${_S}}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
	@@echo "\nMaintainer: ${MAINTAINER}" >>$@@
.  if defined(HOMEPAGE)
	@@fgrep -q '$${HOMEPAGE}' $? || echo "\nWWW: ${HOMEPAGE}" >>$@@
.  endif
.endfor

a2143 18

.for _S in ${MULTI_PACKAGES}
${_UPDATE_COOKIE${_S}}:
	@@cd ${.CURDIR} && exec ${MAKE} _internal-package
.  if empty(UPDATE_COOKIES_DIR)
	@@exec ${MAKE} ${WRKDIR}
.  else
	@@mkdir -p ${UPDATE_COOKIES_DIR}
.  endif
	@@${ECHO_MSG} "===> Updating for ${FULLPKGNAME${_S}}"
	@@a=`pkg_info -e ${FULLPKGPATH${_S}} 2>/dev/null || true`; \
	case $$a in \
		'') ${ECHO_MSG} "Not installed, no update";; \
		*) ${ECHO_MSG} "Upgrading from $$a"; \
		   ${SUDO} ${SETENV} PKG_PATH=${_PKG_REPO} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} -r ${_PKG_ADD_FORCE} ${PKGFILE${S_}};; \
	esac
	@@${_MAKE_COOKIE} $@@
.endfor
@


1.853
log
@remove a lot of redirectors, add a lot more loops, build stuff based
on internal variables mostly.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.852 2006/11/28 19:59:15 espie Exp $
d371 1
a371 1
ERRORS += "Fatal: SUBPACKAGES should always beging with -: ${MULTI_PACKAGES:N-*}."
d792 13
a817 12
.  if exists(${PKGDIR}/INSTALL${_S})
PKG_ARGS${_S} += -i ${PKGDIR}/INSTALL${_S}
.  endif
.  if exists(${PKGDIR}/DEINSTALL${SUBPACKAGE})
PKG_ARGS${_S} += -k ${PKGDIR}/DEINSTALL${SUBPACKAGE}
.  endif
.  if exists(${PKGDIR}/REQ${SUBPACKAGE})
PKG_ARGS${_S} += -r ${PKGDIR}/REQ${SUBPACKAGE}
.  endif
.  if exists(${PKGDIR}/MODULE${SUBPACKAGE}.pm)
PKG_ARGS${_S} += -m ${PKGDIR}/MODULE${SUBPACKAGE}.pm
.  endif
@


1.852
log
@let PKG_ARGS be SUBPACKAGE dependent, define them all
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.850 2006/11/28 18:25:42 espie Exp $
d452 9
a460 5
.if !empty(UPDATE_COOKIES_DIR)
_UPDATE_COOKIE =		${UPDATE_COOKIES_DIR}/${FULLPKGNAME${SUBPACKAGE}}
.else
_UPDATE_COOKIE =		${WRKDIR}/.update_${FULLPKGNAME${SUBPACKAGE}}
.endif
d476 1
a476 1
	${_DEPRUN_COOKIES} ${_DEPREGRESS_COOKIES} ${_UPDATE_COOKIE} \
a612 1
_PKGFILE${SUBPACKAGE} = ${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
a613 7
.if ${PKG_ARCH${SUBPACKAGE}} == "*" && ${NO_ARCH} != ${MACHINE_ARCH}/all
_PACKAGE_COOKIE${SUBPACKAGE} = ${PACKAGE_REPOSITORY}/${NO_ARCH}/${_PKGFILE${SUBPACKAGE}}
_PACKAGE_LINKS += ${MACHINE_ARCH}/all/${_PKGFILE${SUBPACKAGE}} ${NO_ARCH}/${_PKGFILE${SUBPACKAGE}}
_PACKAGE_COOKIES += ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/all/${_PKGFILE${SUBPACKAGE}}
.else
_PACKAGE_COOKIE${SUBPACKAGE} = ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/all/${_PKGFILE${SUBPACKAGE}}
.endif
d618 22
a639 9
_PACKAGE_COOKIES += ${_PACKAGE_COOKIE${SUBPACKAGE}}
.if ${PERMIT_PACKAGE_FTP${SUBPACKAGE}:L} == "yes"
_PACKAGE_COOKIES += ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/ftp/${_PKGFILE${SUBPACKAGE}}
_PACKAGE_LINKS += ${MACHINE_ARCH}/ftp/${_PKGFILE${SUBPACKAGE}} ${MACHINE_ARCH}/all/${_PKGFILE${SUBPACKAGE}}
.endif
.if ${PERMIT_PACKAGE_CDROM${SUBPACKAGE}:L} == "yes"
_PACKAGE_COOKIES += ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/cdrom/${_PKGFILE${SUBPACKAGE}}
_PACKAGE_LINKS += ${MACHINE_ARCH}/cdrom/${_PKGFILE${SUBPACKAGE}} ${MACHINE_ARCH}/all/${_PKGFILE${SUBPACKAGE}}
.endif
d798 2
a799 1
_PKG_PREREQ = ${WRKPKG}/DESCR${SUBPACKAGE} ${WRKPKG}/COMMENT${SUBPACKAGE}
d802 1
d1340 1
d1342 1
a1342 1
${_CACHE_REPO}/${_PKGFILE${SUBPACKAGE}}:
d1344 2
a1345 2
	@@${ECHO_MSG} -n "===>  Looking for ${_PKGFILE${SUBPACKAGE}} in \$$PKG_PATH - "
	@@if ${SETENV} PKG_CACHE=${_CACHE_REPO} PKG_PATH=${_CACHE_REPO}:${_PKG_REPO}:${PACKAGE_REPOSITORY}/${NO_ARCH}/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n -q ${_PKG_ADD_FORCE} ${_PKGFILE${SUBPACKAGE}} >/dev/null 2>&1; then \
d1353 1
a1353 1
${_PACKAGE_COOKIE${SUBPACKAGE}}:
d1355 2
a1356 2
.if ${FETCH_PACKAGES:L} == "yes" && !defined(_TRIED_FETCHING)
	@@f=${_CACHE_REPO}/${_PKGFILE${SUBPACKAGE}}; \
d1360 1
a1360 1
.else
d1362 1
a1362 1
.  if target(pre-package)
d1364 1
a1364 1
.  endif
d1367 1
a1367 1
.  else
d1369 2
a1370 2
	@@${ECHO_MSG} "===>  Building package for ${FULLPKGNAME${SUBPACKAGE}}"
	@@${ECHO_MSG} "Create ${_PACKAGE_COOKIE${SUBPACKAGE}}"
d1372 3
a1374 3
      deps=`${MAKE} _print-package-args` && \
	  if ${SUDO} ${PKG_CMD} `echo "$$deps"|sort -u` ${PKG_ARGS${SUBPACKAGE}} ${_PACKAGE_COOKIE${SUBPACKAGE}}; then \
	    mode=`id -u`:`id -g`; ${SUDO} ${CHOWN} $${mode} ${_PACKAGE_COOKIE${SUBPACKAGE}}; \
d1382 2
a1383 2
.  endif
.  if target(post-package)
d1385 2
d1388 2
a1389 2
	@@rm -f ${_BULK_COOKIE} ${_UPDATE_COOKIE}
.endif
d1406 1
d1408 2
a1409 2
${WRKPKG}/COMMENT${SUBPACKAGE}:
	@@echo ${_COMMENT${SUBPACKAGE}} >$@@
d1411 1
a1411 1
${WRKPKG}/DESCR${SUBPACKAGE}: ${DESCR${SUBPACKAGE}}
d1414 1
a1414 1
.if defined(HOMEPAGE)
d1416 2
a1417 1
.endif
d1585 1
a1585 1
	dump-vars describe _internal-subpackage sublib-depends-check \
d1599 2
a1600 2
sublib-depends-check:
	@@cd ${.CURDIR} && exec ${MAKE} subpackage
d1602 1
a1602 1
		${_NEWLIB_DEPENDS_FLAGS} -d ${_PKG_REPO} ${_PACKAGE_COOKIE${SUBPACKAGE}}
d1712 3
a1714 1
_internal-subupdate: ${_UPDATE_COOKIE}
d1794 1
a1794 2
.for _t _r in _internal-package-only _internal-subpackage \
	lib-depends-check sublib-depends-check \
d1796 1
a1796 2
	print-plist-all print-plist \
	readmes _readme _internal-update _internal-subupdate
d1809 2
a1810 4
_internal-package:
.for _s in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' exec ${MAKE} _internal-subpackage
.endfor
d2131 2
a2132 1
${_UPDATE_COOKIE}:
d2134 1
a2134 1
.if empty(UPDATE_COOKIES_DIR)
d2136 1
a2136 1
.else
d2138 3
a2140 3
.endif
	@@${ECHO_MSG} "===> Updating for ${FULLPKGNAME${SUBPACKAGE}}"
	@@a=`pkg_info -e ${FULLPKGPATH} 2>/dev/null || true`; \
d2144 1
a2144 1
		   ${SUDO} ${SETENV} PKG_PATH=${_PKG_REPO} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} -r ${_PKG_ADD_FORCE} ${PKGFILE};; \
d2147 1
d2160 5
d2168 1
a2168 1
_internal-subpackage: ${_PACKAGE_COOKIES}
d2170 1
d2269 1
a2269 3
.  for _s in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' exec ${MAKE} clean=package
.  endfor
d2271 1
a2271 1
	rm -f ${_PACKAGE_COOKIES}
@


1.851
log
@fix for xview
@
text
@d381 1
d387 1
a387 1
PKG_ARGS += -D${_i}=0
d395 1
a395 1
PKG_ARGS += -D${_i}=1
d400 1
a400 1
PKG_ARGS += -DSHARED_LIBS=0
d402 1
a402 1
PKG_ARGS += -DSHARED_LIBS=1
d634 1
d637 3
d708 1
a708 1
PKG_ARGS += -D${_v}='${${_v}}'
d711 1
a711 4
PKG_ARGS += -DFLAVORS='${FLAVOR_EXT}'
PKG_ARGS += -DFULLPKGPATH=${FULLPKGPATH}
PKG_ARGS += -DPERMIT_PACKAGE_CDROM=${PERMIT_PACKAGE_CDROM${SUBPACKAGE}:Q}
PKG_ARGS += -DPERMIT_PACKAGE_FTP=${PERMIT_PACKAGE_FTP${SUBPACKAGE}:Q}
d714 12
d745 12
d789 2
d792 25
a816 29
_PKG_PREREQ = ${WRKPKG}/DESCR${SUBPACKAGE} ${WRKPKG}/COMMENT${SUBPACKAGE}
PKG_ARGS += -c '${WRKPKG}/COMMENT${SUBPACKAGE}' -d ${WRKPKG}/DESCR${SUBPACKAGE}
PKG_ARGS += -f ${PLIST${SUBPACKAGE}} -p ${PREFIX${SUBPACKAGE}}
.if exists(${PKGDIR}/INSTALL${SUBPACKAGE})
PKG_ARGS += -i ${PKGDIR}/INSTALL${SUBPACKAGE}
.endif
.if exists(${PKGDIR}/DEINSTALL${SUBPACKAGE})
PKG_ARGS += -k ${PKGDIR}/DEINSTALL${SUBPACKAGE}
.endif
.if exists(${PKGDIR}/REQ${SUBPACKAGE})
PKG_ARGS += -r ${PKGDIR}/REQ${SUBPACKAGE}
.endif
.if exists(${PKGDIR}/MODULE${SUBPACKAGE}.pm)
PKG_ARGS += -m ${PKGDIR}/MODULE${SUBPACKAGE}.pm
.endif
.if defined(MESSAGE${SUBPACKAGE})
PKG_ARGS += -M ${MESSAGE${SUBPACKAGE}}
.endif
.if defined(UNMESSAGE${SUBPACKAGE})
PKG_ARGS += -U ${UNMESSAGE${SUBPACKAGE}}
.endif
PKG_ARGS += -B ${WRKINST}
PKG_ARGS += -A'${PKG_ARCH${SUBPACKAGE}}'
.if ${LOCALBASE} != "/usr/local"
PKG_ARGS += -L${LOCALBASE}
.endif
.if !defined(_COMMENT${SUBPACKAGE})
ERRORS += "Fatal: Missing comment for ${SUBPACKAGE}."
.endif
d1361 1
a1361 1
	  if ${SUDO} ${PKG_CMD} `echo "$$deps"|sort -u` ${PKG_ARGS} ${_PACKAGE_COOKIE${SUBPACKAGE}}; then \
d2142 1
a2142 1
	@@${PKG_CMD} -n -q ${PKG_ARGS} ${_PACKAGE_COOKIE${SUBPACKAGE}}
d2145 1
a2145 1
	@@${PKG_CMD} -n -Q ${PKG_ARGS} ${_PACKAGE_COOKIE${SUBPACKAGE}}
@


1.850
log
@big internal changes: if MULTI_PACKAGES is not defined, define it to '-',
so that the `normal' cases is MULTI_PACKAGES, (with possibly one
special '-' subpackage).

Adjust a few tests accordingly so that people don't notice the '-'
SUBPACKAGE: mostly do not print some directory changes, adjust FULLPKGPATH,
and set up PLIST- templates correctly.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.848 2006/11/28 16:28:56 espie Exp $
d1445 1
a1445 1
		Xpatch|Xconfigure|Xlicense-check) \
@


1.849
log
@display something when switching directories during updates
@
text
@d322 4
a325 4
.if !defined(MULTI_PACKAGES)
SUBPACKAGE ?=
PKGNAMES = ${FULLPKGNAME}
_FMN = ${PKGPATH}/${FULLPKGNAME}
d328 2
a330 1
.endif
d365 1
a365 1
.    if !defined(MULTI_PACKAGES) || empty(MULTI_PACKAGES:M${_i})
d370 1
a370 1
.if defined(MULTI_PACKAGES) && !empty(MULTI_PACKAGES:N-*)
d427 3
a429 1
.if defined(MULTI_PACKAGES)
d611 1
a611 1
_PACKAGE_COOKIE = ${PACKAGE_REPOSITORY}/${NO_ARCH}/${_PKGFILE${SUBPACKAGE}}
d615 1
a615 1
_PACKAGE_COOKIE = ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/all/${_PKGFILE${SUBPACKAGE}}
d621 1
a621 1
_PACKAGE_COOKIES += ${_PACKAGE_COOKIE}
d631 1
a631 1
.if empty(SUBPACKAGE)
d713 19
a731 1
PLIST${SUBPACKAGE} ?= ${PKGDIR}/PLIST${SUBPACKAGE}
d733 18
a750 6
# Likewise for DESCR/MESSAGE/COMMENT
.if defined(COMMENT${SUBPACKAGE}${FLAVOR_EXT})
_COMMENT${SUBPACKAGE} = ${COMMENT${SUBPACKAGE}${FLAVOR_EXT}}
.elif defined(COMMENT${SUBPACKAGE})
_COMMENT${SUBPACKAGE} = ${COMMENT${SUBPACKAGE}}
.endif
d752 3
a754 3
.if exists(${PKGDIR}/MESSAGE${SUBPACKAGE})
MESSAGE${SUBPACKAGE} ?= ${PKGDIR}/MESSAGE${SUBPACKAGE}
.endif
d756 2
a757 2
.if exists(${PKGDIR}/UNMESSAGE${SUBPACKAGE})
UNMESSAGE${SUBPACKAGE} ?= ${PKGDIR}/UNMESSAGE${SUBPACKAGE}
a759 2
DESCR${SUBPACKAGE} ?= ${PKGDIR}/DESCR${SUBPACKAGE}

d1183 1
a1183 2
.if defined(MULTI_PACKAGES)
.  for _S in ${MULTI_PACKAGES}
d1185 1
a1185 2
.  endfor
.endif
d1233 1
a1233 2
.if defined(MULTI_PACKAGES)
.  for _S in ${MULTI_PACKAGES}
d1236 1
a1236 1
.    if ${NO_SHARED_LIBS:L} != "yes"
d1238 1
a1238 1
.    else
d1240 2
a1241 3
.    endif
.  endfor
.endif
d1317 1
a1317 1
${_PACKAGE_COOKIE}:
d1334 1
a1334 1
	@@${ECHO_MSG} "Create ${_PACKAGE_COOKIE}"
d1337 2
a1338 2
	  if ${SUDO} ${PKG_CMD} `echo "$$deps"|sort -u` ${PKG_ARGS} ${_PACKAGE_COOKIE}; then \
	    mode=`id -u`:`id -g`; ${SUDO} ${CHOWN} $${mode} ${_PACKAGE_COOKIE}; \
d1562 1
a1562 1
		${_NEWLIB_DEPENDS_FLAGS} -d ${_PKG_REPO} ${_PACKAGE_COOKIE}
d1696 1
a1696 2
.if defined(MULTI_PACKAGES)
.  for _s in ${MULTI_PACKAGES}
d1698 1
a1698 2
.  endfor
.endif
d1753 1
a1753 1
	describe subdescribe lib-depends-check sublib-depends-check \
d1758 3
a1760 1
.  if defined(MULTI_PACKAGES)
a1764 2
.  else
	@@cd ${.CURDIR} && exec ${MAKE} ${_r}
d1770 1
a1770 2
.if defined(MULTI_PACKAGES)
.  for _s in ${MULTI_PACKAGES}
d1772 1
a1772 4
.  endfor
.else
	@@cd ${.CURDIR} && exec ${MAKE} _internal-subpackage
.endif
d2114 1
a2114 1
_register_plist=perl ${PORTSDIR}/infrastructure/package/register-plist ${PLIST_DB} ${_PACKAGE_COOKIE}
d2118 1
a2118 1
	@@${PKG_CMD} -n -q ${PKG_ARGS} ${_PACKAGE_COOKIE}
d2121 1
a2121 1
	@@${PKG_CMD} -n -Q ${PKG_ARGS} ${_PACKAGE_COOKIE}
d2223 1
a2223 2
.  if defined(MULTI_PACKAGES)
.    for _s in ${MULTI_PACKAGES}
d2225 1
a2225 4
.    endfor
.  else
	@@cd ${.CURDIR} && exec ${MAKE} clean=package
.  endif
d2230 1
a2230 2
.    if defined(MULTI_PACKAGES)
.      for _s in ${MULTI_PACKAGES}
d2232 1
a2232 4
.      endfor
.    else
	rm -f ${.CURDIR}/${FULLPKGNAME}.html
.    endif
d2319 4
a2322 3
subdescribe:
	@@echo -n "${FULLPKGNAME${SUBPACKAGE}}|${FULLPKGPATH}|"
.if ${PREFIX${SUBPACKAGE}} == ${LOCALBASE}
d2324 6
a2329 6
.else
	@@echo -n "${PREFIX${SUBPACKAGE}}|"
.endif
	@@echo -n ${_COMMENT${SUBPACKAGE}}"|"; \
	if [ -f ${DESCR${SUBPACKAGE}} ]; then \
		echo -n "${DESCR${SUBPACKAGE}:S,^${PORTSDIR}/,,}|"; \
d2333 3
a2335 3
	echo -n "${MAINTAINER}|${CATEGORIES${SUBPACKAGE}}|"
.for _d in LIB BUILD RUN
	@@echo -n '${_${_d}_DEP3${SUBPACKAGE}:C/ +/ /g}'| tr '\040' '\012'|sort -u|tr '\012' '\040' | sed -e 's, $$,,'
d2337 1
a2337 1
.endfor
d2346 1
a2346 1
.if defined(_BAD_LICENSING)
d2348 2
a2349 2
.else
.  if ${PERMIT_PACKAGE_CDROM${SUBPACKAGE}:L} == "yes"
d2351 1
a2351 1
.  else
d2353 2
a2354 2
.  endif
.  if ${PERMIT_PACKAGE_FTP${SUBPACKAGE}:L} == "yes"
d2356 1
a2356 1
.  else
d2358 2
a2359 2
.  endif
.  if ${PERMIT_DISTFILES_CDROM:L} == "yes"
d2361 1
a2361 1
.  else
d2363 2
a2364 2
.  endif
.  if ${PERMIT_DISTFILES_FTP:L} == "yes"
d2366 1
a2366 1
.  else
d2368 1
d2370 1
a2370 1
.endif
d2852 1
a2852 1
	show-required-by peek-ftp _internal-subpackage subdescribe \
@


1.848
log
@prepare to be able to have every subpackage present at once.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.847 2006/11/28 16:24:00 espie Exp $
d1082 4
a1085 1
_force_update_fragment = eval $$toset ${MAKE} subupdate
@


1.847
log
@explicitly duplicate stuff to SUBPACKAGE, often a nop, but make sure
people get correct information.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.846 2006/11/27 20:29:50 espie Exp $
d605 1
a605 1
_PKGFILE = ${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
d608 3
a610 3
_PACKAGE_COOKIE = ${PACKAGE_REPOSITORY}/${NO_ARCH}/${_PKGFILE}
_PACKAGE_LINKS += ${MACHINE_ARCH}/all ${NO_ARCH}
_PACKAGE_COOKIES += ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/all/${_PKGFILE}
d612 1
a612 1
_PACKAGE_COOKIE = ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/all/${_PKGFILE}
d616 1
a616 1
PKGFILE = ${_PKG_REPO}${_PKGFILE}
d620 2
a621 2
_PACKAGE_COOKIES += ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/ftp/${_PKGFILE}
_PACKAGE_LINKS += ${MACHINE_ARCH}/ftp ${MACHINE_ARCH}/all
d624 2
a625 2
_PACKAGE_COOKIES += ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/cdrom/${_PKGFILE}
_PACKAGE_LINKS += ${MACHINE_ARCH}/cdrom ${MACHINE_ARCH}/all
d1276 1
a1276 1
${_CACHE_REPO}/${_PKGFILE}:
d1278 2
a1279 2
	@@${ECHO_MSG} -n "===>  Looking for ${_PKGFILE} in \$$PKG_PATH - "
	@@if ${SETENV} PKG_CACHE=${_CACHE_REPO} PKG_PATH=${_CACHE_REPO}:${_PKG_REPO}:${PACKAGE_REPOSITORY}/${NO_ARCH}/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n -q ${_PKG_ADD_FORCE} ${_PKGFILE} >/dev/null 2>&1; then \
d1290 1
a1290 1
	@@f=${_CACHE_REPO}/${_PKGFILE}; \
d2148 1
a2148 1
${PACKAGE_REPOSITORY}/${_l}/${_PKGFILE}: ${PACKAGE_REPOSITORY}/${_o}/${_PKGFILE}
@


1.846
log
@unbreak xplanet for now
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.845 2006/11/27 19:09:19 espie Exp $
d589 1
a589 1
.for _s in ${MULTI_PACKAGES}
d596 1
a596 1
.for _s in ${MULTI_PACKAGES}
d760 1
a760 1
ERRORS += "Fatal: Missing comment."
@


1.845
log
@zap the last special case of PLIST, we do not use that either
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.844 2006/11/27 17:30:18 espie Exp $
d1415 1
a1415 1
		Xpatch|Xconfigure) \
@


1.844
log
@zap some older ways to define PLIST which we haven't used ever since
pkg_add groks fragments.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.843 2006/11/27 16:08:05 espie Exp $
d710 1
a710 8
# find out the most appropriate PLIST  source
.if !defined(PLIST${SUBPACKAGE})
.  if exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT})
PLIST${SUBPACKAGE} = ${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}
.  else
PLIST${SUBPACKAGE} = ${PKGDIR}/PLIST${SUBPACKAGE}
.  endif
.endif
@


1.843
log
@white space police
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.842 2006/11/27 15:28:40 espie Exp $
d712 1
a712 8
.  if exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${ARCH})
PLIST${SUBPACKAGE} = ${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${ARCH}
.  elif exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${MACHINE_ARCH})
PLIST${SUBPACKAGE} = ${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${MACHINE_ARCH}
.  elif ${NO_SHARED_LIBS:L} == "yes" && \
	exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.noshared)
PLIST${SUBPACKAGE} = ${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.noshared
.  elif exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT})
a713 7
.  elif exists(${PKGDIR}/PLIST${SUBPACKAGE}.${ARCH})
PLIST${SUBPACKAGE} = ${PKGDIR}/PLIST${SUBPACKAGE}.${ARCH}
.  elif exists(${PKGDIR}/PLIST${SUBPACKAGE}.${MACHINE_ARCH})
PLIST${SUBPACKAGE} = ${PKGDIR}/PLIST${SUBPACKAGE}.${MACHINE_ARCH}
.  elif ${NO_SHARED_LIBS:L} == "yes" && \
	exists(${PKGDIR}/PLIST${SUBPACKAGE}.noshared)
PLIST${SUBPACKAGE} = ${PKGDIR}/PLIST${SUBPACKAGE}.noshared
@


1.842
log
@some white space and reformat (style)
make sure every variable assignement is surrounded by spaces
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.841 2006/11/26 23:39:41 espie Exp $
d93 1
a93 1
	WANTLIB CATEGORIES DESCR 
d179 1
a179 1
# need to go through an extra var because clean is set in stone, 
d653 1
a653 1
_INSTALL_MACROS =	BSD_INSTALL_PROGRAM="${INSTALL_PROGRAM}" \
d661 1
a661 1
MAKE_ENV +=	${_INSTALL_MACROS}
d670 2
a671 2
SYSTRACE_FILTER ?=	${PORTSDIR}/infrastructure/db/systrace.filter
_SYSTRACE_POLICIES +=	/bin/sh /usr/bin/env /usr/bin/make \
d673 1
a673 1
SYSTRACE_SUBST_VARS +=	DISTDIR PKG_TMPDIR PORTSDIR TMPDIR WRKDIR
d743 1
d756 1
a756 1
PKG_ARGS += -f ${PLIST${SUBPACKAGE}} -p ${PREFIX${SUBPACKAGE}} 
d1277 1
a1277 1
	awk '{print "SIZE (" $$2 ") = " $$1}' 
d1765 1
a1765 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' exec ${MAKE} _internal-subpackage 
d1775 1
a1775 1
${_BULK_COOKIE}: 
d2090 1
a2090 1
${_UPDATE_COOKIE}: 
d2386 1
a2386 1
.if defined(MULTI_PACKAGES) 
@


1.841
log
@fix so that variable definitions work even in the presence of subpackage=c++
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.840 2006/11/26 20:02:28 espie Exp $
d24 1
a24 1
ERRORS+= "Fatal: Use 'env FLAVOR=${FLAVOR} ${MAKE}' instead."
d27 1
a27 1
ERRORS+= "Fatal: Use 'env SUBPACKAGE=${SUBPACKAGE} ${MAKE}' instead."
d32 1
a32 1
ERRORS+= "Fatal: Variable $v is obsolete, use PACKAGE_REPOSITORY instead."
d66 11
a76 11
TRUST_PACKAGES?=No
FETCH_PACKAGES?=No
CLEANDEPENDS?=No
USE_SYSTRACE?=	No
BULK?=No
RECURSIVE_FETCH_LIST?=	Yes
WRKOBJDIR?=
FAKEOBJDIR?=
BULK_TARGETS?=
BULK_DO?=
FORCE_UPDATE?=No
d78 12
a89 12
_ALL_VARIABLES?=HOMEPAGE DISTNAME \
BUILD_DEPENDS RUN_DEPENDS REGRESS_DEPENDS USE_GMAKE MODULES FLAVORS \
NO_BUILD NO_REGRESS SHARED_ONLY ONLY_FOR_ARCHS IS_INTERACTIVE \
BROKEN MULTI_PACKAGES PSEUDO_FLAVORS \
REGRESS_IS_INTERACTIVE DISTFILES DIST_SUBDIR \
PERMIT_DISTFILES_CDROM PERMIT_DISTFILES_FTP \
CONFIGURE_STYLE USE_LIBTOOL SEPARATE_BUILD \
SHARED_LIBS USE_MOTIF PACKAGES MASTER_SITES \
MASTER_SITES0 MASTER_SITES1 MASTER_SITES2 MASTER_SITES3 MASTER_SITES4 \
MASTER_SITES5 MASTER_SITES6 MASTER_SITES7 MASTER_SITES8 MASTER_SITES9 \
MAINTAINER SUBPACKAGE SUPDISTFILES \
AUTOCONF_VERSION AUTOMAKE_VERSION CONFIGURE_ARGS
d91 3
a93 3
_ALL_VARIABLES_INDEXED?=COMMENT FULLPKGNAME PKGNAME PKG_ARCH \
PERMIT_PACKAGE_FTP PERMIT_PACKAGE_CDROM RUN_DEPENDS LIB_DEPENDS WANTLIB \
CATEGORIES DESCR 
d96 2
a97 2
PATCH_CHECK_ONLY?=No
REFETCH?=false
d100 3
a102 3
ARCH!=	uname -m
OPSYS=	OpenBSD
OPSYS_VER=	${OSREV}
d104 2
a105 2
LP64_ARCHS=alpha amd64 hppa64 sparc64 mips64
NO_SHARED_ARCHS=m88k sh vax
d110 1
a110 1
NO_SHARED_LIBS?=	Yes
d113 1
a113 1
NO_SHARED_LIBS?=	No
d116 9
a124 9
PORTSDIR?=		/usr/ports
LOCALBASE?=		/usr/local
X11BASE?=		/usr/X11R6
DISTDIR?=		${PORTSDIR}/distfiles
BULK_COOKIES_DIR?= ${PORTSDIR}/bulk/${MACHINE_ARCH}
UPDATE_COOKIES_DIR?= ${PORTSDIR}/update/${MACHINE_ARCH}
TEMPLATES?=		${PORTSDIR}/infrastructure/templates
TMPDIR?=		/tmp
PLIST_DB?=
d126 1
a126 1
PACKAGE_REPOSITORY?=${PORTSDIR}/packages
d131 6
a136 6
WRKOBJDIR_${PKGPATH}?= ${WRKOBJDIR}
FAKEOBJDIR_${PKGPATH}?= ${FAKEOBJDIR}
BULK_${PKGPATH}?= ${BULK}
BULK_TARGETS_${PKGPATH}?= ${BULK_TARGETS}
BULK_DO_${PKGPATH}?= ${BULK_DO}
CLEANDEPENDS_${PKGPATH}?= ${CLEANDEPENDS}
d139 1
a139 1
PKG_DBDIR?=		/var/db/pkg
d141 1
a141 1
FETCH_CMD?=		/usr/bin/ftp -V -m
d143 3
a145 3
PKG_TMPDIR?=	/var/tmp
PKG_CMD?=		/usr/sbin/pkg_create
PKG_DELETE?=	/usr/sbin/pkg_delete
d148 1
a148 1
PROTECT_MOUNT_POINTS?=
d155 5
a159 5
  !defined(PERMIT_DISTFILES_CDROM) || !defined(PERMIT_DISTFILES_FTP)
ERRORS+="The licensing info for ${FULLPKGNAME} is incomplete."
ERRORS+="Please notify the OpenBSD port maintainer:"
ERRORS+="    ${MAINTAINER}"
_BAD_LICENSING=Yes
d173 1
a173 1
clean=${_internal-clean}
a178 2
FAKE?=Yes

d181 1
a181 1
_clean=${clean}
d183 1
a183 1
_clean+=work
d186 1
a186 1
_clean+=depends
d189 1
a189 1
_clean+=fake
d192 1
a192 1
_clean+=-f
d195 1
a195 1
_okay_words=depends work fake -f flavors dist install sub packages package \
d199 1
a199 1
ERRORS+="Fatal: unknown clean command: ${_w}"
d203 2
a204 2
NOMANCOMPRESS?=	Yes
DEF_UMASK?=		022
d217 6
a222 6
CONFIGURE_STYLE?=
USE_X11?= No
NO_DEPENDS?= No
NO_BUILD?= No
NO_REGRESS?= No
INSTALL_TARGET?=	install
d224 2
a225 1
.if ${CONFIGURE_STYLE:L:Mautomake} || ${CONFIGURE_STYLE:L:Mautoconf} || ${CONFIGURE_STYLE:L:Mautoupdate}
d227 1
a227 1
CONFIGURE_STYLE+=gnu
d233 1
a233 1
MODULES+=${_i}
d238 1
a238 1
_MODULES_DONE=
d247 1
a247 1
PKG_ARCH?=${MACHINE_ARCH},${ARCH}
d249 1
a249 1
PKG_ARCH?=${MACHINE_ARCH}
d252 2
a253 2
SHARED_ONLY?=	No
SEPARATE_BUILD?=	No
d255 1
a255 1
DIST_SUBDIR?=
d258 1
a258 1
FULLDISTDIR?=	${DISTDIR}/${DIST_SUBDIR}
d260 1
a260 1
FULLDISTDIR?=	${DISTDIR}
d264 1
a264 1
PATCHDIR?=		${.CURDIR}/patches.${ARCH}
d266 1
a266 1
PATCHDIR?=		${.CURDIR}/patches.${MACHINE_ARCH}
d268 1
a268 1
PATCHDIR?=		${.CURDIR}/patches
d271 1
a271 1
PATCH_LIST?=    patch-*
d274 1
a274 1
FILESDIR?=		${.CURDIR}/files.${ARCH}
d276 1
a276 1
FILESDIR?=		${.CURDIR}/files.${MACHINE_ARCH}
d278 1
a278 1
FILESDIR?=		${.CURDIR}/files
d282 1
a282 1
PKGDIR?=		${.CURDIR}/pkg.${ARCH}
d284 1
a284 1
PKGDIR?=		${.CURDIR}/pkg.${MACHINE_ARCH}
d286 1
a286 1
PKGDIR?=		${.CURDIR}/pkg
d289 4
a292 4
PREFIX?=		${LOCALBASE}
TRUEPREFIX?=	${PREFIX}
DESTDIRNAME?=	DESTDIR
DESTDIR?=		${WRKINST}
d294 2
a295 2
MAKE_FLAGS?=
LIBTOOL_FLAGS?=
d297 1
a297 1
FAKE_FLAGS=${DESTDIRNAME}=${WRKINST}
d301 2
a302 2
SYSCONFDIR?=	/etc
USE_GMAKE?=		No
d304 2
a305 2
BUILD_DEPENDS+=		::devel/gmake
MAKE_PROGRAM=		${GMAKE}
d307 1
a307 1
MAKE_PROGRAM=		${MAKE}
d310 2
a311 2
USE_LIBTOOL?=No
_lt_libs=
d313 6
a318 6
LIBTOOL?=			${DEPBASE}/bin/libtool
BUILD_DEPENDS+=		::devel/libtool
CONFIGURE_ENV+=		LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}" ${_lt_libs}
MAKE_ENV+=			LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}" ${_lt_libs}
MAKE_FLAGS+=		LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}" ${_lt_libs}
FAKE_FLAGS+=		LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}" ${_lt_libs}
d320 1
a320 1
MAKE_FLAGS+=		SHARED_LIBS_LOG=${WRKBUILD}/shared_libs.log
d323 11
a333 11
SUBPACKAGE?=
PKGNAMES=${FULLPKGNAME}
_FMN=${PKGPATH}/${FULLPKGNAME}
.else
SUBPACKAGE?=-main
_FMN=
.endif
FLAVOR?=
FLAVORS?=
PSEUDO_FLAVORS?=
FLAVORS+=${PSEUDO_FLAVORS}
d336 1
a336 1
NO_REGRESS= Yes
d339 1
a339 1
USE_MOTIF?=No
d343 1
a343 1
LIB_DEPENDS+=		Xm.>=1::x11/lesstif
d345 1
a345 1
LIB_DEPENDS+=		Xm.>=2::x11/openmotif
d347 1
a347 1
FLAVORS+=lesstif
d349 1
a349 1
ERRORS+="Fatal: choose motif or lesstif, not both."
d352 1
a352 1
LIB_DEPENDS+=		Xm.>=1::x11/lesstif
d354 1
a354 1
LIB_DEPENDS+=		Xm.>=2::x11/openmotif
d357 1
a357 1
ERRORS+= "Fatal: Unknown USE_MOTIF=${USE_MOTIF} settings."
d359 1
a359 1
MOTIFLIB=-L${DEPBASE}/lib -lXm
d365 1
a365 1
ERRORS+= "Fatal: Subpackage ${SUBPACKAGE} does not exist."
d370 1
a370 1
ERRORS+= "Fatal: SUBPACKAGES should always beging with -: ${MULTI_PACKAGES:N-*}."
d374 2
a375 2
FLAVOR_EXT:=
BASE_PKGPATH:=${PKGPATH}
d378 2
a379 2
_FLAVOR_EXT2:=
BUILD_PKGPATH:=${PKGPATH}
d385 1
a385 1
PKG_ARGS+=-D${_i}=0
d387 2
a388 2
_FLAVOR_EXT2:=${_FLAVOR_EXT2}-${_i}
BUILD_PKGPATH:=${BUILD_PKGPATH},${_i}
d390 2
a391 2
FLAVOR_EXT:=${FLAVOR_EXT}-${_i}
BASE_PKGPATH:=${BASE_PKGPATH},${_i}
d393 1
a393 1
PKG_ARGS+=-D${_i}=1
d398 1
a398 1
PKG_ARGS+=-DSHARED_LIBS=0
d400 1
a400 1
PKG_ARGS+=-DSHARED_LIBS=1
d403 1
a403 1
ERRORS+="Fatal: flavor should never start with a digit"
d410 2
a411 2
ERRORS+=	"Fatal: Unknown flavor: ${_i}"
ERRORS+= "   (Possible flavors are: ${FLAVORS})."
d415 1
a415 1
ERRORS+=	"Fatal: no flavors for this port."
d419 1
a419 1
PKG_SUFX?=		.tgz
d421 4
a424 4
PKGNAME?=${DISTNAME}
FULLPKGNAME?=${PKGNAME}${FLAVOR_EXT}
_MASTER?=
_SOLVING_DEP?=No
d438 10
a447 10
_SYSTRACE_COOKIE=	${WRKDIR}/systrace.policy
_WRKDIR_COOKIE=		${WRKDIR}/.extract_started
_EXTRACT_COOKIE=	${WRKDIR}/.extract_done
_PATCH_COOKIE=		${WRKDIR}/.patch_done
_DISTPATCH_COOKIE=	${WRKDIR}/.distpatch_done
_PREPATCH_COOKIE=	${WRKDIR}/.prepatch_done
_INSTALL_COOKIE=	${PKG_DBDIR}/${FULLPKGNAME${SUBPACKAGE}}/+CONTENTS
_BULK_COOKIE=		${BULK_COOKIES_DIR}/${FULLPKGNAME}
_FAKE_COOKIE=		${WRKINST}/.fake_done
_INSTALL_PRE_COOKIE=${WRKINST}/.install_started
d449 1
a449 1
_UPDATE_COOKIE=		${UPDATE_COOKIES_DIR}/${FULLPKGNAME${SUBPACKAGE}}
d451 1
a451 1
_UPDATE_COOKIE=		${WRKDIR}/.update_${FULLPKGNAME${SUBPACKAGE}}
d454 17
a470 17
_CONFIGURE_COOKIE=	${WRKBUILD}/.configure_done
_BUILD_COOKIE=		${WRKBUILD}/.build_done
_REGRESS_COOKIE=	${WRKBUILD}/.regress_done
.else
_CONFIGURE_COOKIE=	${WRKDIR}/.configure_done
_BUILD_COOKIE=		${WRKDIR}/.build_done
_REGRESS_COOKIE=	${WRKDIR}/.regress_done
.endif

_ALL_COOKIES=${_EXTRACT_COOKIE} ${_PATCH_COOKIE} ${_CONFIGURE_COOKIE} \
${_INSTALL_PRE_COOKIE} ${_BUILD_COOKIE} ${_REGRESS_COOKIE} \
${_SYSTRACE_COOKIE} ${_PACKAGE_COOKIES} \
${_DISTPATCH_COOKIE} ${_PREPATCH_COOKIE} ${_FAKE_COOKIE} \
${_WRKDIR_COOKIE} ${_DEPBUILD_COOKIES} \
${_DEPRUN_COOKIES} ${_DEPREGRESS_COOKIES} ${_UPDATE_COOKIE} \
${_DEPBUILDLIB_COOKIES} ${_DEPRUNLIB_COOKIES} \
${_DEPBUILDWANTLIB_COOKIE} ${_DEPRUNWANTLIB_COOKIE} ${_DEPLIBSPECS_COOKIES}
d472 1
a472 1
_MAKE_COOKIE=touch
d475 1
a475 1
GMAKE?=			gmake
d477 1
a477 1
CHECKSUM_FILE?=	${.CURDIR}/distinfo
d480 1
a480 1
_CIPHERS=		sha1 rmd160 md5
d483 1
a483 1
PREFERRED_CIPHERS?= ${_CIPHERS}
d485 1
a485 1
PORTPATH?= ${WRKDIR}/bin:/usr/bin:/bin:/usr/sbin:/sbin:${DEPBASE}/bin:${LOCALBASE}/bin:${X11BASE}/bin
d491 1
a491 1
CFLAGS+=		${COPTS}
d494 1
a494 1
CXXFLAGS+=		${CXXOPTS}
d498 1
a498 1
CFLAGS+=		${CDIAGFLAGS}
d501 1
a501 1
CXXFLAGS+=		${CXXDIAGFLAGS}
d505 2
a506 2
MAKE_FILE?=		Makefile
PORTHOME?=		/${PKGNAME}_writes_to_HOME
d508 1
a508 1
MAKE_ENV+=		PATH='${PORTPATH}' PREFIX='${PREFIX}' \
d514 5
a518 5
DISTORIG?=	.bak.orig
PATCH?=			/usr/bin/patch
PATCHORIG?=	.orig
PATCH_STRIP?=	-p0
PATCH_DIST_STRIP?=	-p0
d520 1
a520 1
PATCH_DEBUG?=No
d522 2
a523 2
PATCH_ARGS?=	-d ${WRKDIST} -z ${PATCHORIG} -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-z ${DISTORIG} -d ${WRKDIST} -E ${PATCH_DIST_STRIP}
d525 3
a527 2
PATCH_ARGS?=	-d ${WRKDIST} -z ${PATCHORIG} --forward --quiet -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-z ${DISTORIG} -d ${WRKDIST} --forward --quiet -E ${PATCH_DIST_STRIP}
d531 2
a532 2
PATCH_ARGS+=	-C
PATCH_DIST_ARGS+=	-C
d535 3
a537 3
TAR?=	/bin/tar
UNZIP?=	unzip
BZIP2?=	bzip2
d540 1
a540 1
MAKE_ENV+=	EXTRA_SYS_MK_INCLUDES="<bsd.own.mk>"
d544 1
a544 1
WRKINST?=	${FAKEOBJDIR_${PKGPATH}}/${PKGNAME}${_FLAVOR_EXT2}
d546 1
a546 1
WRKINST?=	${WRKDIR}/fake-${ARCH}${_FLAVOR_EXT2}
d551 1
a551 1
WRKDIR?=		${WRKOBJDIR_${PKGPATH}}/${PKGNAME}
d553 1
a553 1
WRKDIR?=		${WRKOBJDIR_${PKGPATH}}/${PKGNAME}${_FLAVOR_EXT2}
d557 1
a557 1
WRKDIR?=		${.CURDIR}/w-${PKGNAME}
d559 1
a559 1
WRKDIR?=		${.CURDIR}/w-${PKGNAME}${_FLAVOR_EXT2}
d563 1
a563 1
WRKDIST?=		${WRKDIR}/${DISTNAME}
d565 1
a565 1
WRKSRC?=	   ${WRKDIST}
d568 2
a569 2
WRKBUILD?=		${WRKDIR}/build-${MACHINE_ARCH}${_FLAVOR_EXT2}
WRKPKG?=		${WRKBUILD}/pkg
d571 2
a572 2
WRKBUILD?=		${WRKSRC}
WRKPKG?=		${WRKDIR}/pkg
d574 1
a574 1
WRKCONF?=		${WRKBUILD}
d576 1
a576 1
ALL_TARGET?=		all
d604 3
a606 3
_PACKAGE_LINKS=
_PKGFILE=		${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
NO_ARCH?=		no-arch
d608 9
a616 9
_PACKAGE_COOKIE=	${PACKAGE_REPOSITORY}/${NO_ARCH}/${_PKGFILE}
_PACKAGE_LINKS+=	${MACHINE_ARCH}/all ${NO_ARCH}
_PACKAGE_COOKIES+=	${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/all/${_PKGFILE}
.else
_PACKAGE_COOKIE=	${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/all/${_PKGFILE}
.endif
_PKG_REPO=		${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/all/
_CACHE_REPO=	${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/cache/
PKGFILE=${_PKG_REPO}${_PKGFILE}
d629 1
a629 1
FULLPKGPATH=${PKGPATH}${FLAVOR_EXT:S/-/,/g}
d631 1
a631 1
FULLPKGPATH=${PKGPATH},${SUBPACKAGE}${FLAVOR_EXT:S/-/,/g}
d635 1
a635 1
INSTALL_PROGRAM= \
d637 1
a637 1
INSTALL_SCRIPT= \
d639 1
a639 1
INSTALL_DATA= \
d641 1
a641 1
INSTALL_MAN= \
d644 1
a644 1
INSTALL_PROGRAM_DIR= \
d646 1
a646 1
INSTALL_SCRIPT_DIR= \
d648 1
a648 1
INSTALL_DATA_DIR= \
d650 1
a650 1
INSTALL_MAN_DIR= \
d653 9
a661 9
_INSTALL_MACROS=	BSD_INSTALL_PROGRAM="${INSTALL_PROGRAM}" \
			BSD_INSTALL_SCRIPT="${INSTALL_SCRIPT}" \
			BSD_INSTALL_DATA="${INSTALL_DATA}" \
			BSD_INSTALL_MAN="${INSTALL_MAN}" \
			BSD_INSTALL_PROGRAM_DIR="${INSTALL_PROGRAM_DIR}" \
			BSD_INSTALL_SCRIPT_DIR="${INSTALL_SCRIPT_DIR}" \
			BSD_INSTALL_DATA_DIR="${INSTALL_DATA_DIR}" \
			BSD_INSTALL_MAN_DIR="${INSTALL_MAN_DIR}"
MAKE_ENV+=	${_INSTALL_MACROS}
d664 1
a664 1
NO_SYSTRACE?=	No
d666 1
a666 1
_SYSTRACE_CMD?=	/bin/systrace -e -i -a -f ${_SYSTRACE_COOKIE}
d668 1
a668 1
_SYSTRACE_CMD=
d670 2
a671 2
SYSTRACE_FILTER?=	${PORTSDIR}/infrastructure/db/systrace.filter
_SYSTRACE_POLICIES+=	/bin/sh /usr/bin/env /usr/bin/make \
d673 1
a673 1
SYSTRACE_SUBST_VARS+=	DISTDIR PKG_TMPDIR PORTSDIR TMPDIR WRKDIR
d675 1
a675 1
_SYSTRACE_SED_SUBST+=-e 's,$${${_v}},${${_v}},g'
d678 1
a678 1
SHARED_LIBS?=
d681 4
a684 4
LIB${_n}_VERSION=${_v}
SUBST_VARS+=LIB${_n}_VERSION
_lt_libs+=LIB${_n}_LTVERSION='-version-info ${_v:S/./:/}:0'
_lt_libs+=lib${_n:S/+/_/g:S/-/_/g:S/./_/g}_ltversion=${_v}
d688 4
a691 4
SUBST_VARS+=MACHINE_ARCH ARCH HOMEPAGE PREFIX SYSCONFDIR FLAVOR_EXT \
			MAINTAINER BASE_PKGPATH
_tmpvars=
_SED_SUBST=sed
d693 1
a693 1
_PKG_ADD_AUTO?=
d695 1
a695 1
_PKG_ADD_AUTO+=-a
d699 2
a700 2
_SED_SUBST+=-e 's|$${${_v}}|${${_v}}|g'
PKG_ARGS+=-D${_v}='${${_v}}'
d703 4
a706 4
PKG_ARGS+=-DFLAVORS='${FLAVOR_EXT}'
PKG_ARGS+=-DFULLPKGPATH=${FULLPKGPATH}
PKG_ARGS+=-DPERMIT_PACKAGE_CDROM=${PERMIT_PACKAGE_CDROM${SUBPACKAGE}:Q}
PKG_ARGS+=-DPERMIT_PACKAGE_FTP=${PERMIT_PACKAGE_FTP${SUBPACKAGE}:Q}
d708 1
a708 1
_SED_SUBST+=-e 's,$${FLAVORS},${FLAVOR_EXT},g' -e 's,$$\\,$$,g'
d713 1
a713 1
PLIST${SUBPACKAGE} =		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${ARCH}
d715 4
a718 3
PLIST${SUBPACKAGE} =		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${MACHINE_ARCH}
.  elif ${NO_SHARED_LIBS:L} == "yes" && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.noshared)
PLIST${SUBPACKAGE} =		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.noshared
d720 1
a720 1
PLIST${SUBPACKAGE} =		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}
d722 1
a722 1
PLIST${SUBPACKAGE} =		${PKGDIR}/PLIST${SUBPACKAGE}.${ARCH}
d724 4
a727 3
PLIST${SUBPACKAGE} =		${PKGDIR}/PLIST${SUBPACKAGE}.${MACHINE_ARCH}
.  elif ${NO_SHARED_LIBS:L} == "yes" && exists(${PKGDIR}/PLIST${SUBPACKAGE}.noshared)
PLIST${SUBPACKAGE} =		${PKGDIR}/PLIST${SUBPACKAGE}.noshared
d729 1
a729 1
PLIST${SUBPACKAGE} =		${PKGDIR}/PLIST${SUBPACKAGE}
d735 1
a735 1
_COMMENT${SUBPACKAGE}=${COMMENT${SUBPACKAGE}${FLAVOR_EXT}}
d737 1
a737 1
_COMMENT${SUBPACKAGE}=${COMMENT${SUBPACKAGE}}
d741 1
a741 1
MESSAGE${SUBPACKAGE}?= ${PKGDIR}/MESSAGE${SUBPACKAGE}
d744 1
a744 1
UNMESSAGE${SUBPACKAGE}?= ${PKGDIR}/UNMESSAGE${SUBPACKAGE}
d747 1
a747 1
DESCR${SUBPACKAGE} ?=		${PKGDIR}/DESCR${SUBPACKAGE}
d749 2
a750 2
MTREE_FILE?=
MTREE_FILE+=${PORTSDIR}/infrastructure/db/fake.mtree
d753 3
a755 3
_PKG_PREREQ= ${WRKPKG}/DESCR${SUBPACKAGE} ${WRKPKG}/COMMENT${SUBPACKAGE}
PKG_ARGS+= -c '${WRKPKG}/COMMENT${SUBPACKAGE}' -d ${WRKPKG}/DESCR${SUBPACKAGE}
PKG_ARGS+=-f ${PLIST${SUBPACKAGE}} -p ${PREFIX${SUBPACKAGE}} 
d757 1
a757 1
PKG_ARGS+=		-i ${PKGDIR}/INSTALL${SUBPACKAGE}
d760 1
a760 1
PKG_ARGS+=		-k ${PKGDIR}/DEINSTALL${SUBPACKAGE}
d763 1
a763 1
PKG_ARGS+=		-r ${PKGDIR}/REQ${SUBPACKAGE}
d766 1
a766 1
PKG_ARGS+=		-m ${PKGDIR}/MODULE${SUBPACKAGE}.pm
d769 1
a769 1
PKG_ARGS+=		-M ${MESSAGE${SUBPACKAGE}}
d772 1
a772 1
PKG_ARGS+=		-U ${UNMESSAGE${SUBPACKAGE}}
d774 2
a775 2
PKG_ARGS+=		-B ${WRKINST}
PKG_ARGS+=-A'${PKG_ARCH${SUBPACKAGE}}'
d777 1
a777 1
PKG_ARGS+=-L${LOCALBASE}
d780 1
a780 1
ERRORS+="Fatal: Missing comment."
d783 8
a790 8
CHMOD?=		/bin/chmod
CHOWN?=		/usr/sbin/chown
GUNZIP_CMD?=	/usr/bin/gunzip -f
GZCAT?=		/usr/bin/gzcat
GZIP?=		-9
GZIP_CMD?=	/usr/bin/gzip -nf ${GZIP}
M4?=		/usr/bin/m4
STRIP?=		/usr/bin/strip
d793 1
a793 1
YACC?=yacc
d796 2
a797 2
SETENV?=	/usr/bin/env -i
SH?=		/bin/sh
d800 1
a800 1
ECHO_MSG?=		echo
d811 1
a811 1
MASTER_SITES?=
d815 1
a815 1
MASTER_SITES:=	${MASTER_SITES} ${MASTER_SITE_BACKUP}
d817 1
a817 1
MASTER_SITES:=	${MASTER_SITE_OVERRIDE} ${MASTER_SITES}
d821 1
a821 1
_SITE_SELECTOR=case $$select in
d827 1
a827 1
MASTER_SITES${_I}:=	${MASTER_SITES${_I}} ${MASTER_SITE_BACKUP}
d829 1
a829 1
MASTER_SITES${_I}:= ${MASTER_SITE_OVERRIDE} ${MASTER_SITES${_I}}
d831 1
a831 1
_SITE_SELECTOR+=*:${_I}) sites="${MASTER_SITES${_I}}";;
d833 1
a833 1
_SITE_SELECTOR+=*:${_I}) echo >&2 "Error: MASTER_SITES${_I} not defined";;
d836 1
a836 1
_SITE_SELECTOR+=*) sites="${MASTER_SITES}";; esac
d841 2
a842 2
#CDROM_SITE?=	/cdrom/distfiles/${DIST_SUBDIR}
CDROM_SITE?=
d846 1
a846 1
_CDROM_OVERRIDE=if ln -s ${CDROM_SITE}/$$f .; then exit 0; fi
d848 1
a848 1
_CDROM_OVERRIDE=if cp -f ${CDROM_SITE}/$$f .; then exit 0; fi
d851 1
a851 1
_CDROM_OVERRIDE=:
d854 1
a854 1
EXTRACT_SUFX?=		.tar.gz
d856 1
a856 1
DISTFILES?=		${DISTNAME}${EXTRACT_SUFX}
d858 3
a860 3
_EVERYTHING=${DISTFILES}
_DISTFILES=	${DISTFILES:C/:[0-9]$//}
ALLFILES=	${_DISTFILES}
d863 3
a865 3
_PATCHFILES=${PATCHFILES:C/:[0-9]$//}
_EVERYTHING+=${PATCHFILES}
ALLFILES+=	${_PATCHFILES}
d870 2
a871 2
_EVERYTHING+= ${SUPDISTFILES}
ALLFILES+= ${SUPDISTFILES:C/:[0-9]$//}
d875 1
a875 1
__CKSUMFILES=
d879 1
a879 1
__CKSUMFILES+=${_file}
d882 1
a882 1
ALLFILES:=${__CKSUMFILES}
d885 1
a885 1
ERRORS+= "Fatal: don't use IGNOREFILES"
d890 1
a890 1
_CKSUMFILES=	${__CKSUMFILES:S/^/${DIST_SUBDIR}\//}
d892 1
a892 1
_CKSUMFILES=	${__CKSUMFILES}
d897 1
a897 1
EXTRACT_ONLY?=	${_DISTFILES}
d901 1
a901 1
_USE_ZIP?=	Yes
d903 3
a905 2
.if !empty(EXTRACT_ONLY:M*.tar.bz2) || (defined(PATCHFILES) && !empty(_PATCHFILES:M*.bz2))
_USE_BZIP2?=	Yes
d907 2
a908 2
_USE_ZIP?=	No
_USE_BZIP2?=	No
d910 1
a910 1
EXTRACT_CASES?=
d912 1
a912 1
_PERL_FIX_SHAR?=perl -ne 'print if $$s || ($$s = m:^\#(\!\s*/bin/sh\s*| This is a shell archive):)'
d916 3
a918 2
BUILD_DEPENDS+=		:unzip-*:archivers/unzip
EXTRACT_CASES+= *.zip) ${UNZIP} -oq ${FULLDISTDIR}/$$archive -d ${WRKDIR};;
d921 16
a936 9
BUILD_DEPENDS+=		:bzip2-*:archivers/bzip2
EXTRACT_CASES+= *.tar.bz2) ${BZIP2} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf -;;
.endif
EXTRACT_CASES+= *.tar) ${TAR} xf ${FULLDISTDIR}/$$archive;;
EXTRACT_CASES+= *.shar.gz|*.shar.Z|*.sh.gz|*.sh.Z) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | ${_PERL_FIX_SHAR} | /bin/sh;;
EXTRACT_CASES+= *.shar | *.sh) ${_PERL_FIX_SHAR} ${FULLDISTDIR}/$$archive | /bin/sh;;
EXTRACT_CASES+= *.tar.gz) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf -;;
EXTRACT_CASES+= *.gz) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive >`basename $$archive .gz`;;
EXTRACT_CASES+= *) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf -;;
d938 1
a938 1
PATCH_CASES?=
d940 2
a941 1
PATCH_CASES+= *.bz2) ${BZIP2} -dc $$patchfile | ${PATCH} ${PATCH_DIST_ARGS};;
d943 4
a946 2
PATCH_CASES+= *.Z|*.gz) ${GZCAT} $$patchfile | ${PATCH} ${PATCH_DIST_ARGS};;
PATCH_CASES+= *) ${PATCH} ${PATCH_DIST_ARGS} < $$patchfile;;
d949 1
a949 1
MAINTAINER?=	The OpenBSD ports mailing-list <ports@@openbsd.org>
d952 1
a952 1
ERRORS+=	"Fatal: CATEGORIES is mandatory."
d956 1
a956 1
CONFIGURE_SCRIPT?=	configure
d958 1
a958 1
_CONFIGURE_SCRIPT=${CONFIGURE_SCRIPT}
d961 1
a961 1
_CONFIGURE_SCRIPT=${WRKSRC}/${CONFIGURE_SCRIPT}
d963 1
a963 1
_CONFIGURE_SCRIPT=./${CONFIGURE_SCRIPT}
d967 1
a967 1
CONFIGURE_ENV+=		PATH=${PORTPATH}
d970 1
a970 1
CONFIGURE_SHARED?=	--disable-shared
d972 1
a972 1
CONFIGURE_SHARED?=	--enable-shared
d975 1
a975 1
FETCH_MANUALLY?=No
d977 1
a977 1
_ALLFILES_PRESENT=Yes
d980 1
a980 1
_ALLFILES_PRESENT=No
d984 1
a984 1
IS_INTERACTIVE=Yes
d1006 9
a1014 9
.  if (defined(REGRESS_IS_INTERACTIVE) && defined(BATCH))
_IGNORE_REGRESS=	"has interactive tests"
.  elif (!defined(REGRESS_IS_INTERACTIVE) && defined(INTERACTIVE))
_IGNORE_REGRESS=	"does not have interactive tests"
.  endif
.  if (defined(IS_INTERACTIVE) && defined(BATCH))
IGNORE=	"is an interactive port"
.  elif (!defined(IS_INTERACTIVE) && defined(INTERACTIVE))
IGNORE=	"is not an interactive port"
d1016 1
a1016 1
IGNORE=	"uses X11, but ${X11BASE} not found"
d1020 1
a1020 1
_ARCH_OK=1
d1025 1
a1025 1
IGNORE= "is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH}"
d1027 1
a1027 1
IGNORE= "is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH} \(${ARCH}\)"
d1033 1
a1033 1
IGNORE= "is not for ${NOT_FOR_ARCHS}"
d1037 1
a1037 1
IGNORE="requires shared libraries"
d1043 1
a1043 1
IGNORE=	"is marked as broken: ${BROKEN}"
d1045 1
a1045 1
IGNORE= "-- ${FULLPKGNAME${SUBPACKAGE}:C/-[0-9].*//g} comes with ${OPSYS} as of release ${COMES_WITH}"
d1051 1
a1051 1
DEPENDS_TARGET=	reinstall
d1053 1
a1053 1
DEPENDS_TARGET=	install
d1064 1
a1064 1
_noshared=-noshared
d1066 1
a1066 1
_noshared=
d1070 8
a1077 6
		case "$$d" in \
		*/*) shdir="${LOCALBASE}/$${d%/*}";; \
		*) shdir="${LOCALBASE}/lib";; \
		esac; \
		check=`eval $$listlibs 2>/dev/null| LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} perl \
			${PORTSDIR}/infrastructure/build/resolve-lib ${_noshared} $$d` \
d1081 13
a1093 8
		case "$$d" in \
		/*) shdir="$${d%/*}/";; \
		*/*) shdir="${DEPBASE}/$${d%/*}";; \
		*) shdir="${DEPBASE}/lib"; listlibs="$$listlibs /usr/lib/lib* ${X11BASE}/lib/lib*";; \
		esac; \
		check=`eval $$listlibs 2>/dev/null| LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} perl \
			${PORTSDIR}/infrastructure/build/resolve-lib ${_noshared} $$d` \
			|| check=Failed
d1096 4
a1099 4
PORT_LD_LIBRARY_PATH=${LOCALBASE}/lib:${X11BASE}/lib:/usr
_set_ld_library_path=:
DEPBASE=${LOCALBASE}
DEPDIR=
d1102 2
a1103 2
_force_update_fragment=eval $$toset ${MAKE} subupdate
_PKG_ADD_FORCE=-F update -F updatedepends -r
d1105 1
a1105 1
_PKG_ADD_FORCE+= -F installed
d1108 2
a1109 2
_force_update_fragment=:
_PKG_ADD_FORCE=
d1112 1
a1112 1
_FULL_PACKAGE_NAME?=No
d1114 2
a1115 2
_BUILDLIB_DEPENDS=	${LIB_DEPENDS}
_BUILDWANTLIB=		${WANTLIB}
d1119 2
a1120 2
_BUILDLIB_DEPENDS+=	${LIB_DEPENDS${_s}:N*\:${_path}:N*\:${_path},*}
_BUILDWANTLIB+=		${WANTLIB${_s}}
d1125 5
a1129 5
_BUILD_DEPLIST=		${BUILD_DEPENDS:S/^://}
_RUN_DEPLIST=		${RUN_DEPENDS${SUBPACKAGE}:S/^://}
_REGRESS_DEPLIST=	${REGRESS_DEPENDS:S/^://}
_BUILDLIB_DEPLIST=	${_BUILDLIB_DEPENDS:C/^[^:]*://}
_RUNLIB_DEPLIST=	${LIB_DEPENDS${SUBPACKAGE}:C/^[^:]*://}
d1131 2
a1132 1
_DEPLIST=			${_BUILD_DEPLIST} ${_RUN_DEPLIST} ${_REGRESS_DEPLIST} ${_BUILDLIB_DEPLIST} ${_RUNLIB_DEPLIST}
d1135 1
a1135 1
_DEP${_DEP}_COOKIES=
d1137 1
a1137 1
_DEP${_DEP}_COOKIES+=${WRKDIR}/.dep${_i:C,[|:/<=>*],-,g}
d1144 1
a1144 1
MODSIMPLE_configure= \
d1155 1
a1155 1
VMEM_WARNING?=	No
d1157 2
a1158 1
_FAKE_SETUP=TRUEPREFIX=${PREFIX} PREFIX=${WRKINST}${PREFIX} ${DESTDIRNAME}=${WRKINST}
d1160 1
a1160 1
_CLEANDEPENDS?=Yes
d1164 1
a1164 1
_ALLFILES=${ALLFILES:S/^/${DIST_SUBDIR}\//}
d1166 1
a1166 1
_ALLFILES=${ALLFILES}
d1171 1
a1171 1
_FMN+= ${PKGPATH}/${FULLPKGNAME${_S}}
d1178 2
a1179 2
_BUILD_DEP2=	${BUILD_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_BUILD_DEP3=	${BUILD_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d1181 2
a1182 2
_RUN_DEP2=	 	${RUN_DEPENDS${SUBPACKAGE}:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_RUN_DEP3=	 	${RUN_DEPENDS${SUBPACKAGE}:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d1184 1
a1184 1
_REGRESS_DEP2=	${REGRESS_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d1187 3
a1189 3
_RUN_DEP2+= 	${LIB_DEPENDS${SUBPACKAGE}:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_LIB_DEP3=		${LIB_DEPENDS${SUBPACKAGE}}
_DEPRUNLIBS=	${LIB_DEPENDS${SUBPACKAGE}:C/:.*//:S/,/ /g}
d1191 2
a1192 2
_LIB_DEP3=
_DEPRUNLIBS=
d1195 2
a1196 2
_BUILD_DEP2+= 	${_BUILDLIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_DEPBUILDLIBS=	${_BUILDLIB_DEPENDS:C/:.*//:S/,/ /g}
d1198 2
a1199 2
_DEPBUILDLIBS+=	${_BUILDWANTLIB}
_DEPRUNLIBS+=	${WANTLIB${SUBPACKAGE}}
d1203 1
a1203 1
_DEPBUILDLIBSPECS_COOKIES+=${WRKDIR}/.spec-$i
d1205 1
a1205 1
_DEPBUILDWANTLIB_COOKIE=${WRKDIR}/.buildwantlibs
d1207 1
a1207 1
_DEPRUNLIBSPECS_COOKIES+=${WRKDIR}/.spec-$i
d1209 1
a1209 1
_DEPRUNWANTLIB_COOKIE=${WRKDIR}/.runwantlibs${SUBPACKAGE}
d1211 2
a1212 2
_DEPBUILDWANTLIB_COOKIE=
_DEPRUNWANTLIB_COOKIE=
d1215 1
a1215 1
_DEPLIBSPECS_COOKIES=${_DEPBUILDLIBSPECS_COOKIES} ${_DEPRUNLIBSPECS_COOKIES}
d1217 3
a1219 3
_BUILD_DEP=		${_BUILD_DEP2:C/[^:]*://}
_RUN_DEP= 		${_RUN_DEP2:C/[^:]*://}
_REGRESS_DEP=	${_REGRESS_DEP2:C/[^:]*://}
d1223 2
a1224 2
_BUILD_DEP3${_S} =${_BUILD_DEP3}
_RUN_DEP3${_S} =	 	${RUN_DEPENDS${_S}:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d1226 1
a1226 1
_LIB_DEP3${_S} =		${LIB_DEPENDS${_S}}
d1233 1
a1233 1
README_NAME?=	${TEMPLATES}/README.port
d1235 1
a1235 1
REORDER_DEPENDENCIES?=
d1240 5
a1244 5
LOCKDIR?=
LOCK_CMD?=	perl ${PORTSDIR}/infrastructure/build/dolock
UNLOCK_CMD?=rm -f
_LOCKS_HELD?=
LOCK_VERBOSE?=No
d1247 2
a1248 2
_LOCK=echo "Locking $$lock from $@@"; ${LOCK_CMD} ${LOCKDIR}/$$lock.lock
_UNLOCK=echo "Unlocking $$lock from $@@"; ${UNLOCK_CMD} ${LOCKDIR}/$$lock.lock
d1250 2
a1251 2
_LOCK=${LOCK_CMD} ${LOCKDIR}/$$lock.lock
_UNLOCK=${UNLOCK_CMD} ${LOCKDIR}/$$lock.lock
d1254 1
a1254 1
_LOCKNAME=${PKGNAME}
d1256 1
a1256 1
_LOCKNAME=${FULLPKGNAME}
d1261 1
a1261 1
_DO_LOCK=\
d1268 1
a1268 1
_SIMPLE_LOCK= \
d1272 2
a1273 2
_SIMPLE_LOCK?=:
_DO_LOCK?=:
d1275 2
a1276 1
_size_fragment=wc -c $$file 2>/dev/null| awk '{print "SIZE (" $$2 ") = " $$1}' 
d1279 1
a1279 1
_lines2list= tr '\012' '\040' | sed -e 's, $$,,'
d1281 1
a1281 1
_zap_last_line= sed -e '$$d'
d1283 1
a1283 1
_sort_dependencies=tsort -r|${_zap_last_line}
d1285 1
a1285 1
_version2default= sed -e 's,-[0-9].*,-*,'
d1287 1
a1287 1
_grab_libs_from_plist= sed -n -e '/^@@lib /{ s///; p; }' \
d1503 2
a1504 1
${_DEP${_m}WANTLIB_COOKIE}: ${_DEP${_m}LIBSPECS_COOKIES} ${_DEP${_m}LIB_COOKIES} ${_DEPBUILD_COOKIES} ${_WRKDIR_COOKIE}
d1531 6
a1536 6
_internal-configure _internal-all _internal-build _internal-install \
_internal-regress _internal-uninstall _internal-deinstall _internal-fake \
_internal-update _internal-plist _internal-package _internal-install-all \
_internal-update-plist update-patches _internal-subupdate \
dump-vars describe _internal-subpackage sublib-depends-check \
_internal-manpages-check:
d1652 6
a1657 6
_internal-patch: ${_DEPBUILD_COOKIES} ${_DEPBUILDLIB_COOKIES} ${_DEPBUILDWANTLIB_COOKIE} \
	${_PATCH_COOKIE}
_internal-distpatch: ${_DEPBUILD_COOKIES} ${_DEPBUILDLIB_COOKIES} ${_DEPBUILDWANTLIB_COOKIE} \
	${_DISTPATCH_COOKIE}
_internal-configure: ${_DEPBUILD_COOKIES} ${_DEPBUILDLIB_COOKIES} ${_DEPBUILDWANTLIB_COOKIE} \
	${_CONFIGURE_COOKIE}
d1729 3
a1731 3
subupdate fetch checksum regress depends lib-depends build-depends \
run-depends regress-depends clean manpages-check \
plist update-plist update package install-all
d1745 4
a1748 4
describe subdescribe lib-depends-check sublib-depends-check \
dump-vars subdump-vars _internal-install-all _internal-install \
print-plist-all print-plist \
readmes _readme _internal-update _internal-subupdate
d1796 3
a1798 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-checksum _internal-build-depends _internal-buildlib-depends _internal-buildwantlib-depends
d1990 2
a1991 1
	@@cd ${WRKBUILD} && exec ${_SYSTRACE_CMD} ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} ${ALL_TARGET}
d2010 2
a2011 1
	@@cd ${WRKBUILD} && exec ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${REGRESS_FLAGS} -f ${MAKE_FILE} ${REGRESS_TARGET}
d2041 2
a2042 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} ${MAKE} pre-fake ${_FAKE_SETUP}
d2046 2
a2047 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} ${MAKE} pre-install ${_FAKE_SETUP}
d2050 2
a2051 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} ${MAKE} do-install ${_FAKE_SETUP}
d2054 3
a2056 1
	@@cd ${WRKBUILD} && exec ${SUDO} ${_SYSTRACE_CMD} ${SETENV} ${MAKE_ENV} ${_FAKE_SETUP} ${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
d2450 2
a2451 1
.if ${PERMIT_PACKAGE_CDROM${SUBPACKAGE}:L} == "yes" || ${PERMIT_PACKAGE_FTP${SUBPACKAGE}:L} == "yes"
d2463 2
a2464 1
.  if defined(_MASTER_PERMIT_${_i}) && ${_MASTER_PERMIT_${_i}:L} == "yes" && ${PERMIT_PACKAGE_${_i}:L} != "yes"
d2549 2
a2550 1
.if defined(_PORT_LIBS_CACHE) && defined(_DEPENDS_CACHE) && defined(_DEPENDS_FILE)
d2772 3
a2774 1
	for i in ${MASTER_SITES:Mftp*}; do echo "Connecting to $$i"; ${FETCH_CMD} $$i ; break; done
@


1.840
log
@minor tweaks: make internal _COMMENT and *_DEP3 depend on SUBPACKAGE,
so that subdescribe looks cool...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.839 2006/11/26 19:46:16 espie Exp $
d713 1
a713 1
PLIST${SUBPACKAGE}=		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${ARCH}
d715 1
a715 1
PLIST${SUBPACKAGE}=		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${MACHINE_ARCH}
d717 1
a717 1
PLIST${SUBPACKAGE}=		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.noshared
d719 1
a719 1
PLIST${SUBPACKAGE}=		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}
d721 1
a721 1
PLIST${SUBPACKAGE}=		${PKGDIR}/PLIST${SUBPACKAGE}.${ARCH}
d723 1
a723 1
PLIST${SUBPACKAGE}=		${PKGDIR}/PLIST${SUBPACKAGE}.${MACHINE_ARCH}
d725 1
a725 1
PLIST${SUBPACKAGE}=		${PKGDIR}/PLIST${SUBPACKAGE}.noshared
d727 1
a727 1
PLIST${SUBPACKAGE}=		${PKGDIR}/PLIST${SUBPACKAGE}
d745 1
a745 1
DESCR${SUBPACKAGE}?=		${PKGDIR}/DESCR${SUBPACKAGE}
d1200 2
a1201 2
_BUILD_DEP3${_S}=${_BUILD_DEP3}
_RUN_DEP3${_S}=	 	${RUN_DEPENDS${_S}:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d1203 1
a1203 1
_LIB_DEP3${_S}=		${LIB_DEPENDS${_S}}
d1205 1
a1205 1
_LIB_DEP3${_S}=
@


1.839
log
@avoid recursion in subdescribe.
make things simple in *-depends-list.

fix LIB_DEP3 (this one from steven)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.838 2006/11/26 19:12:20 espie Exp $
d733 1
a733 1
_COMMENT=${COMMENT${SUBPACKAGE}${FLAVOR_EXT}}
d735 1
a735 1
_COMMENT=${COMMENT${SUBPACKAGE}}
d777 1
a777 1
.if !defined(_COMMENT)
d1198 12
d1336 1
a1336 1
	@@echo ${_COMMENT} >$@@
d2296 1
a2296 1
	@@echo -n ${_COMMENT}"|"; \
d2304 2
a2305 1
	@@echo -n '${_${_d}_DEP3}'| tr '\040' '\012'|sort -u|tr '\012' '\040' | sed -e 's, $$,|,'
d2344 1
a2344 1
	@@echo ${_COMMENT} | ${HTMLIFY} >$@@.tmp-comment
d2438 1
a2438 1
	@@echo -n '${_${_i}_DEP3}'| tr '\040' '\012'|sort -u|tr '\012' '\040' | sed -e 's, $$,,'
@


1.838
log
@repair describe
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.837 2006/11/26 17:45:59 espie Exp $
d1165 1
a1165 1
_LIB_DEP3=		${LIB_DEPENDS${SUBPACKAGE}:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d2292 1
a2292 4
.  if !empty(_${_d}_DEP3)
	@@cd ${.CURDIR} && _FINAL_ECHO=: _INITIAL_ECHO=: exec ${MAKE} ${_d:L}-depends-list
.  endif
	@@echo -n "|"
d2424 3
a2426 10
	@@unset FLAVOR SUBPACKAGE || true; \
	: $${_INITIAL_ECHO:='echo -n "This port requires \""'}; \
	: $${_ECHO='echo -n'}; \
	: $${_FINAL_ECHO:='echo "\" for ${_i:L}."'}; space=''; \
	eval $${_INITIAL_ECHO}; \
	for spec in `echo '${_${_i}_DEP3}' \
		| tr '\040' '\012' | sort -u`; do \
		$${_ECHO} "$$space$${spec}"; \
		space=' '; \
	done; eval $${_FINAL_ECHO}
@


1.837
log
@completely remove PACKAGING, it's no longer needed
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.836 2006/11/26 17:36:07 espie Exp $
d2285 2
a2286 2
	if [ -f ${DESCR} ]; then \
		echo -n "${DESCR:S,^${PORTSDIR}/,,}|"; \
@


1.836
log
@all MULTI_PACKAGES are new, stop testing -main.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.835 2006/11/25 19:47:53 espie Exp $
d88 1
a88 1
MAINTAINER SUBPACKAGE PACKAGING SUPDISTFILES \
a1271 3
.if !defined(PACKAGING)
	@@echo "Error: can't make $@@ without PACKAGING set"; exit 1
.endif
d1279 1
a1279 1
	@@cd ${.CURDIR} && unset PACKAGING || true && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS} ${_PKG_PREREQ}
d1390 1
a1390 1
	@@unset PACKAGING DEPENDS_TARGET _MASTER WRKDIR|| true; \
d1651 1
a1651 1
_extra_prefixes+=PREFIX${_s}=`cd ${.CURDIR} && SUBPACKAGE=${_s} PACKAGING=${_s} ${MAKE} show=PREFIX${_s}`
d1704 1
a1704 1
	@@${_DO_LOCK}; cd ${.CURDIR} && PACKAGING='${SUBPACKAGE}' ${MAKE} _internal-subpackage
d1716 1
a1716 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' PACKAGING='${_s}' exec ${MAKE} ${_r}
d1719 1
a1719 1
	@@cd ${.CURDIR} && SUBPACKAGE='' PACKAGING='' exec ${MAKE} ${_r}
d1727 1
a1727 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' PACKAGING='${_s}' exec ${MAKE} _internal-subpackage 
d1730 1
a1730 1
	@@cd ${.CURDIR} && SUBPACKAGE='' PACKAGING='' exec ${MAKE} _internal-subpackage
d2025 1
a2025 1
	@@cd ${.CURDIR} && DEPENDS_TARGET=install PACKAGING='${SUBPACKAGE}' exec ${MAKE} _internal-run-depends _internal-runlib-depends _internal-runwantlib-depends
d2134 1
a2134 1
	@@PACKAGING='${SUBPACKAGE}' ${MAKE} all-dir-depends|tsort -r|${_zap_last_line}|while read subdir; do \
d2175 1
a2175 1
	@@cd ${.CURDIR} && PACKAGING='${_s}' SUBPACKAGE='${_s}' exec ${MAKE} clean=package
d2178 1
a2178 1
	@@cd ${.CURDIR} && PACKAGING='' SUBPACKAGE='' exec ${MAKE} clean=package
d2445 1
a2445 1
	@@cd ${.CURDIR} && PACKAGING='${SUBPACKAGE}' LIST_LIBS=`${MAKE} _list-port-libs` ${MAKE} _print-package-signature-lib _print-package-signature-run| \
d2449 1
a2449 1
	@@cd ${.CURDIR} && PACKAGING='${SUBPACKAGE}' ${MAKE} _print-package-signature-run | \
d2574 1
a2574 1
		self=${FULLPKGPATH} PACKAGING='${SUBPACKAGE}' ${MAKE} _recurse-run-dir-depends; \
d2600 1
a2600 1
		self=${FULLPKGPATH} PACKAGING='${SUBPACKAGE}' ${MAKE} _recurse-regress-dir-depends; \
@


1.835
log
@add BASE_PKGPATH to SUBST_VARS
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.834 2006/11/25 18:31:23 espie Exp $
d323 1
a323 1
.if !defined(MULTI_PACKAGES) || empty(MULTI_PACKAGES:M-main)
a1715 3
.  if !defined(MULTI_PACKAGES) || empty(MULTI_PACKAGES:M-main)
	@@cd ${.CURDIR} && SUBPACKAGE='' PACKAGING='' exec ${MAKE} ${_r}
.  endif
d1721 2
a1727 3
.if !defined(MULTI_PACKAGES) || empty(MULTI_PACKAGES:M-main)
	@@cd ${.CURDIR} && SUBPACKAGE='' PACKAGING='' exec ${MAKE} _internal-subpackage
.endif
d1732 2
a2175 3
.    if !defined(MULTI_PACKAGES) || empty(MULTI_PACKAGES:M-main)
	@@cd ${.CURDIR} && PACKAGING='' SUBPACKAGE='' exec ${MAKE} clean=package
.    endif
d2180 2
d2187 5
a2191 1
.    if !defined(MULTI_PACKAGES) || empty(MULTI_PACKAGES:M-main)
a2193 3
.    for _s in ${MULTI_PACKAGES}
	rm -f ${.CURDIR}/${FULLPKGNAME${_s}}.html
.    endfor
@


1.834
log
@define BUILD_PKGPATH/BASE_PKGPATH, to document later
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.833 2006/11/24 16:49:37 espie Exp $
d688 2
a689 1
SUBST_VARS+=MACHINE_ARCH ARCH HOMEPAGE PREFIX SYSCONFDIR FLAVOR_EXT MAINTAINER
@


1.833
log
@repair update-plist
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.832 2006/11/24 00:10:00 espie Exp $
d376 1
d380 1
d389 1
d392 1
@


1.832
log
@let PLIST, DESCR, MESSAGE, UNMESSAGE be subpackage-dependent.

careful: they do not get defined to a default value unless the `main'
variable is defined, because they get set later otherwise...

remove the .if defined(MULTI_PACKAGES) guards as they don't serve any purpose.

Simplify the PLIST tests to make them more uniform.

Move SED_PLIST to the list of obsolete variables instead of giving it special
treatment.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.831 2006/11/22 12:40:50 espie Exp $
d1662 1
a1662 1
	PLIST=${PLIST} \
@


1.831
log
@no need to generate an intermediate mtree.spec
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.830 2006/11/22 08:20:20 espie Exp $
d30 1
a30 1
.for v in PKGREPOSITORY PKGREPOSITORYBASE CDROM_PACKAGES FTP_PACKAGES
d88 1
a88 1
MAINTAINER SUBPACKAGE PACKAGING DESCR SUPDISTFILES \
d93 1
a93 1
CATEGORIES 
a373 4
.if defined(SED_PLIST)
ERRORS+="Fatal: SED_PLIST deprecated"
.endif

d585 2
a586 3
.if defined(MULTI_PACKAGES)
.  for _s in ${MULTI_PACKAGES}
.    for _v in PKG_ARCH PERMIT_PACKAGE_FTP PERMIT_PACKAGE_CDROM \
a588 1
.    endfor
d590 9
a598 1
.endif
d706 17
a722 5
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${ARCH})
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${ARCH}
.else
.  if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${MACHINE_ARCH})
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${MACHINE_ARCH}
a724 17
.if !defined(PLIST) && ${NO_SHARED_LIBS:L} == "yes" && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.noshared)
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.noshared
.endif
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT})
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}
.endif
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}.${ARCH})
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}.${ARCH}
.else
.  if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}.${MACHINE_ARCH})
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}.${MACHINE_ARCH}
.  endif
.endif
.if !defined(PLIST) && ${NO_SHARED_LIBS:L} == "yes" && exists(${PKGDIR}/PLIST${SUBPACKAGE}.noshared)
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}.noshared
.endif
PLIST?=		${PKGDIR}/PLIST${SUBPACKAGE}
d734 1
a734 1
MESSAGE?= ${PKGDIR}/MESSAGE${SUBPACKAGE}
d737 1
a737 1
UNMESSAGE?= ${PKGDIR}/UNMESSAGE${SUBPACKAGE}
d740 1
a740 1
DESCR?=		${PKGDIR}/DESCR${SUBPACKAGE}
d748 1
a748 1
PKG_ARGS+=-f ${PLIST} -p ${PREFIX${SUBPACKAGE}} 
d761 2
a762 2
.if defined(MESSAGE)
PKG_ARGS+=		-M ${MESSAGE}
d764 2
a765 2
.if defined(UNMESSAGE)
PKG_ARGS+=		-U ${UNMESSAGE}
d1324 1
a1324 1
${WRKPKG}/DESCR${SUBPACKAGE}: ${DESCR}
@


1.830
log
@filter out the current PKGPATH in fetch_makefile, prevents infinite
recursion.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.829 2006/11/21 10:32:51 bernd Exp $
a1333 4
${WRKPKG}/mtree.spec: ${MTREE_FILE}
	@@${_SED_SUBST} ${MTREE_FILE}>$@@.tmp && mv -f $@@.tmp $@@


a1660 1
	MTREE_FILE=${WRKPKG}/mtree.spec \
d1984 1
a1984 1
${_FAKE_COOKIE}: ${_BUILD_COOKIE} ${WRKPKG}/mtree.spec
d1991 2
a1992 2
	@@${SUDO} /usr/sbin/mtree -U -e -d -n -p ${WRKINST} \
		-f ${WRKPKG}/mtree.spec  >/dev/null
@


1.829
log
@Disallow "nasm::devel/nasm" pkgspecs for BUILD, RUN and REGRESS_DEPENDS again.

All _DEPENDS should be correct now.

'go for it' espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.828 2006/11/20 23:18:25 steven Exp $
d2221 1
a2221 1
	@@echo "${_FMN}: ${_ALLFILES} "`_FULL_PACKAGE_NAME=Yes ${MAKE} full-all-depends`
@


1.828
log
@enable config.x11.site if USE_X11 is set.

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.827 2006/11/20 13:50:16 espie Exp $
d1102 3
a1104 3
_BUILD_DEPLIST=		${BUILD_DEPENDS:C/^[^:]*://}
_RUN_DEPLIST=		${RUN_DEPENDS${SUBPACKAGE}:C/^[^:]*://}
_REGRESS_DEPLIST=	${REGRESS_DEPENDS:C/^[^:]*://}
@


1.827
log
@allows PREFIX and CATEGORIES to be subpackage dependent
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.826 2006/11/20 12:34:52 espie Exp $
d220 1
a957 2

USE_X11?=No
@


1.826
log
@re-allow BUILD_DEPENDS=nasm::devel/nasm temporarily.

until this gets killed... we haven't used the front part of : for a very
long time now !
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.825 2006/11/20 12:04:40 espie Exp $
d81 1
a81 1
BROKEN MULTI_PACKAGES PSEUDO_FLAVORS CATEGORIES \
d92 2
a93 1
PERMIT_PACKAGE_FTP PERMIT_PACKAGE_CDROM RUN_DEPENDS LIB_DEPENDS WANTLIB
d591 1
a591 1
	RUN_DEPENDS WANTLIB LIB_DEPENDS
d750 1
a750 1
PKG_ARGS+=-f ${PLIST} -p ${PREFIX} 
d1657 1
a1657 1
_extra_prefixes+=PREFIX${_s}=`cd ${.CURDIR} && SUBPACKAGE=${_s} PACKAGING=${_s} ${MAKE} show=PREFIX`
d2288 1
a2288 1
.if ${PREFIX} == ${LOCALBASE}
d2291 1
a2291 1
	@@echo -n "${PREFIX}|"
d2299 1
a2299 1
	echo -n "${MAINTAINER}|${CATEGORIES}|"
@


1.825
log
@typo
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.824 2006/11/20 11:15:39 espie Exp $
d1102 3
a1104 3
_BUILD_DEPLIST=		${BUILD_DEPENDS:S/^://}
_RUN_DEPLIST=		${RUN_DEPENDS${SUBPACKAGE}:S/^://}
_REGRESS_DEPLIST=	${REGRESS_DEPENDS:S/^://}
@


1.824
log
@fix NO_SHARED_LIBS case, found out by bernd@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.823 2006/11/20 11:11:38 espie Exp $
d469 1
a469 1
${_DEPBUILDWANTLIB_COOKIE} ${_DEPRUNWANTLIB_COOKIE}${_DEPLIBSPECS_COOKIES}
@


1.823
log
@clone LIB_DEPENDS${SUBPACKAGE}/WANTLIB${SUBPACKAGE} as expected.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.822 2006/11/20 10:49:22 espie Exp $
d1166 1
@


1.822
log
@let LIB_DEPENDS and WANTLIB depend on the SUBPACKAGE.

Build a special list of _BUILDLIB_DEPENDS, so that separate subpackages
can depend on each other without making an infinite loop...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.821 2006/11/20 10:38:31 espie Exp $
d589 2
a590 1
.    for _v in PKG_ARCH PERMIT_PACKAGE_FTP PERMIT_PACKAGE_CDROM RUN_DEPENDS
@


1.821
log
@forgot one DEPRUNLIBS
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.820 2006/11/20 10:36:13 espie Exp $
d78 1
a78 1
_ALL_VARIABLES?=HOMEPAGE DISTNAME LIB_DEPENDS \
d84 1
a84 1
CONFIGURE_STYLE USE_LIBTOOL SEPARATE_BUILD WANTLIB \
d92 1
a92 1
PERMIT_PACKAGE_FTP PERMIT_PACKAGE_CDROM RUN_DEPENDS
d1092 7
d1105 1
a1105 1
_RUNLIB_DEPLIST=	${LIB_DEPENDS:C/^[^:]*://}
d1161 3
a1163 3
_RUN_DEP2+= 	${LIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_LIB_DEP3=		${LIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_DEPRUNLIBS=	${LIB_DEPENDS:C/:.*//:S/,/ /g}
d1172 1
a1172 1
_DEPRUNLIBS+=	${WANTLIB}
d2472 1
a2472 1
.  for _i in ${LIB_DEPENDS}
d2501 1
a2501 1
.  for _i in ${WANTLIB}
d2551 1
a2551 1
.for _i in ${LIB_DEPENDS}
@


1.820
log
@distinguish between _BUILDLIB_DEPENDS and LIB_DEPENDS, and _BUILDWANTLIB
and WANTLIB.

Get the rules for the LIBSPECS_COOKIES out of the loop that dictates their
usage.

Introduce *DEP3 variables, to keep *-depends-list compatible with old stuff.

Use _BUILDLIB_DEPENDS and _BUILDWANTLIB everywhere this makes sense.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.819 2006/11/20 09:59:11 espie Exp $
d2543 1
a2543 1
	@@echo $$LIST_LIBS| LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} perl ${PORTSDIR}/infrastructure/build/resolve-lib ${_DEPLIBS:S/>/\>/g}
@


1.819
log
@simplify xxx-dir-depends: only rely on _BUILD_DEP/_RUN_DEP.
Fold _ALWAYS_DEP.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.818 2006/11/20 09:46:56 espie Exp $
d466 1
a466 1
${_WRKDIR_COOKIE} ${_DEPLIB_COOKIES} ${_DEPBUILD_COOKIES} \
a467 1
${_DEPLIBSPECS_COOKIES} \
d469 1
a469 2
${_DEPBUILDWANTLIB_COOKIE} ${_DEPBUILDLIBSPECS_COOKIES} \
${_DEPRUNWANTLIB_COOKIE} ${_DEPRUNLIBSPECS_COOKIES} \
d1090 3
d1094 5
a1098 4
_BUILD_DEPLIST=${BUILD_DEPENDS:S/^://}
_RUN_DEPLIST=${RUN_DEPENDS${SUBPACKAGE}:S/^://}
_REGRESS_DEPLIST=${REGRESS_DEPENDS:S/^://}
_LIB_DEPLIST=${LIB_DEPENDS:C/^[^:]*://}
d1100 1
a1100 1
_DEPLIST=${_BUILD_DEPLIST} ${_RUN_DEPLIST} ${_REGRESS_DEPLIST} ${_LIB_DEPLIST}
d1102 1
a1102 1
.for _DEP in BUILD RUN LIB REGRESS
a1107 2
_DEPBUILDLIB_COOKIES=${_DEPLIB_COOKIES}
_DEPRUNLIB_COOKIES=${_DEPLIB_COOKIES}
d1145 2
a1146 1
_BUILD_DEP2 = ${BUILD_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d1148 2
a1149 1
_RUN_DEP2 = ${RUN_DEPENDS${SUBPACKAGE}:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d1151 1
a1151 1
_REGRESS_DEP2 = ${REGRESS_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d1154 3
a1156 2
_RUN_DEP2 += ${LIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_DEPLIBS=${LIB_DEPENDS:C/:.*//:S/,/ /g}
d1158 1
a1158 1
_DEPLIBS=
d1161 2
a1162 1
_BUILD_DEP2 += ${LIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d1164 2
a1165 3
.if defined(WANTLIB)
_DEPLIBS+=${WANTLIB}
.endif
d1167 3
a1169 4
_DEPLIBSPECS_COOKIES=
.if !empty(_DEPLIBS) && ${NO_DEPENDS:L} == "no"
.  for i in ${WANTLIB:C,[|:/<=>*],-,g}
_DEPLIBSPECS_COOKIES+=${WRKDIR}/.spec-$i
d1172 3
a1179 5
_DEPBUILDLIBS=${_DEPLIBS}
_DEPRUNLIBS=${_DEPLIBS}

_DEPBUILDLIBSPECS_COOKIES=${_DEPLIBSPECS_COOKIES}
_DEPRUNLIBSPECS_COOKIES=${_DEPLIBSPECS_COOKIES}
d1181 1
a1181 1
_LIB_DEP2= ${LIB_DEPENDS}
d1183 3
a1185 3
_BUILD_DEP = ${_BUILD_DEP2:C/[^:]*://}
_RUN_DEP = ${_RUN_DEP2:C/[^:]*://}
_REGRESS_DEP = ${_REGRESS_DEP2:C/[^:]*://}
d1451 1
a1451 1
_internal-lib-depends: ${_DEPLIB_COOKIES}
d1456 5
a1462 3
${_DEP${_m}LIBSPECS_COOKIES}: ${_WRKDIR_COOKIE}
	@@${_MAKE_COOKIE} $@@

d2291 1
a2291 1
.  if !empty(_${_d}_DEP2)
d2425 1
a2425 1
.  if !empty(_${_i}_DEP2)
d2431 1
a2431 1
	for spec in `echo '${_${_i}_DEP2}' \
d2443 1
a2443 1
.if !empty(_DEPLIBS)
@


1.818
log
@remove extra subpackage that crept in
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.817 2006/11/19 19:52:03 sturm Exp $
d1144 9
a1152 3
.if defined(LIB_DEPENDS) && ${NO_SHARED_LIBS:L} != "yes"
_ALWAYS_DEP2 = ${LIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_ALWAYS_DEP= ${_ALWAYS_DEP2:C/[^:]*://}
a1154 2
_ALWAYS_DEP2=
_ALWAYS_DEP=
d1158 2
a1163 16
.if defined(RUN_DEPENDS${SUBPACKAGE})
_RUN_DEP2 = ${RUN_DEPENDS${SUBPACKAGE}:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_RUN_DEP = ${_RUN_DEP2:C/[^:]*://}
.else
_RUN_DEP2=
_RUN_DEP=
.endif

.if defined(REGRESS_DEPENDS)
_REGRESS_DEP2 = ${REGRESS_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_REGRESS_DEP = ${_REGRESS_DEP2:C/[^:]*://}
.else
_REGRESS_DEP2=
_REGRESS_DEP=
.endif

d1181 2
a1182 2
.if defined(BUILD_DEPENDS)
_BUILD_DEP2 = ${BUILD_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d1184 2
a1185 6
.else
_BUILD_DEP2=
_BUILD_DEP=
.endif

_LIB_DEP2= ${LIB_DEPENDS}
d2356 1
a2356 1
.  if !empty(_ALWAYS_DEP) || !empty(_${_I:U}_DEP)
d2380 1
a2380 1
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
d2387 1
a2387 1
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
d2553 1
a2553 1
.for _dir in ${_ALWAYS_DEP} ${_RUN_DEP}
d2567 1
a2567 1
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
d2606 1
a2606 1
.for _dir in ${_ALWAYS_DEP} ${_BUILD_DEP} ${_RUN_DEP}
d2621 1
a2621 1
.for _dir in ${_ALWAYS_DEP} ${_BUILD_DEP}
d2635 1
a2635 1
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
d2646 1
a2646 1
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
@


1.817
log
@add sh to NO_SHARED_ARCHS for now
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.816 2006/11/19 18:20:01 espie Exp $
d1160 1
a1160 1
_RUN_DEP = ${_RUN_DEP2${SUBPACKAGE}:C/[^:]*://}
@


1.816
log
@rephrase dependency evaluation without $$dep.
Also, more error checking, check specifically for which dependency targets
are allowed.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.815 2006/11/19 18:07:38 espie Exp $
d104 1
a104 1
NO_SHARED_ARCHS=m88k vax
@


1.815
log
@Now that all dependencies are evaluated in the same way, build the cookies
in one single loop, based on _DEPLIST.

Extract dependencies off the loop.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.814 2006/11/19 18:01:44 espie Exp $
d1404 1
a1404 1
		${_flavor_fragment}; defaulted=false; \
d1409 1
a1409 1
		*) \
d1412 7
a1418 1
			dep="/nonexistent";; \
d1437 1
a1437 3
			case "$$dep" in \
			"/nonexistent") ;; \
			*)  \
d1445 2
a1446 2
				fi;; \
			esac; \
@


1.814
log
@remove confusing FAKE=lib scaffolding that's not finished, and that won't
work in that way in any case...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.813 2006/11/19 17:52:32 espie Exp $
d1098 1
d1397 2
a1398 3
.for _DEP in BUILD RUN LIB REGRESS
.  for _i in ${_${_DEP}_DEPLIST}
.    if !target(${WRKDIR}/.dep${_i:C,[|:/<=>*],-,g})
d1403 1
a1403 1
		extra_msg="(${_DEP}_DEPENDS ${_i})"; \
d1456 1
a1456 3
.    endif
.  endfor
_internal-${_DEP:L}-depends: ${_DEP${_DEP}_COOKIES}
d1458 5
@


1.813
log
@avoid redefining the same dependency cookie twice
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.812 2006/11/19 17:48:14 espie Exp $
a178 1
USE_FAKE_LIB?=No
a1073 9
.if (${FAKE:L} == "lib" || ${FAKE:L} == "all") && ${USE_FAKE_LIB:L} == "yes"
PORT_LD_LIBRARY_PATH=${DEPBASE}/lib:${LOCALBASE}/lib:${X11BASE}/lib:/usr
_set_ld_library_path=export LD_LIBRARY_PATH=${PORT_LD_LIBRARY_PATH}
MAKE_ENV+=LD_LIBRARY_PATH=${PORT_LD_LIBRARY_PATH}
CONFIGURE_ENV+=LD_LIBRARY_PATH=${PORT_LD_LIBRARY_PATH}
DEPBASE=${DEPDIR}${LOCALBASE}
DEPDIR?=${WRKDIR}/dependencies
_lib_depends_target=pseudofake
.else
a1077 9
.endif
.if ${FAKE:L} == "all" && ${USE_FAKE_LIB:L} == "yes"
_build_depends_target=pseudofake
.endif

_lib_depends_target?=${DEPENDS_TARGET}
_build_depends_target?=${DEPENDS_TARGET}
_run_depends_target=${DEPENDS_TARGET}
_regress_depends_target=${DEPENDS_TARGET}
d1405 1
a1405 1
		case "X$$target" in X) target=${_${_DEP:L}_depends_target};; esac; \
a1408 1
		Xpseudofake) early_exit=true; dep="/fake";; \
a1432 15
			"/fake") \
				${ECHO_MSG} "===>  Verifying package for $$what in $$dir"; \
				if eval $$toset ${MAKE} package; then \
					${ECHO_MSG} "===> Returning to build of ${FULLPKGNAME${SUBPACKAGE}}${_MASTER}"; \
				else \
					${ECHO_MSG} "===> Error in evaluating dependency ${_i}"; \
					${REPORT_PROBLEM}; \
					exit 1; \
				fi; \
				$$defaulted || pkg=`eval $$toset ${MAKE} _print-packagename`; \
				mkdir -p ${DEPDIR}/pkgdb ${DEPDIR}/usr ${DEPDIR}/usr/X11R6; \
				ln -sfh /usr/lib ${DEPDIR}/usr/lib; \
				ln -sfh /usr/X11R6/lib ${DEPDIR}/usr/X11R6/lib; \
				test -e ${DEPDIR}/pkgdb/$$pkg && exit 0; \
				cd ${_PKG_REPO} && PKG_DBDIR=${DEPDIR}/pkgdb PKG_PATH=${_PKG_REPO} pkg_add -F nonroot -Q ${DEPDIR} $$pkg && exit 0;; \
@


1.812
log
@simplify dep cookies names. Since we no longer use the dep part, let
it vanish completely.

Also, stop converting . to -, as it's useless and makes for less readable
names.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.811 2006/11/19 17:40:35 espie Exp $
d1417 1
d1491 1
@


1.811
log
@also defaults to stem-* for build depends, thus simplifying code a bit...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.809 2006/11/19 16:39:41 espie Exp $
d1112 4
a1115 4
_BUILD_DEPLIST=${BUILD_DEPENDS}
_RUN_DEPLIST=${RUN_DEPENDS${SUBPACKAGE}}
_REGRESS_DEPLIST=${REGRESS_DEPENDS}
_LIB_DEPLIST=${LIB_DEPENDS}
d1121 1
a1121 1
_DEP${_DEP}_COOKIES+=${WRKDIR}/.dep${_i:C,[|:./<=>*],-,g}
d1194 1
a1194 1
.  for i in ${WANTLIB:C,[|:./<=>*],-,g}
d1417 1
a1417 1
${WRKDIR}/.dep${_i:C,[|:./<=>*],-,g}: ${_WRKDIR_COOKIE}
d1420 1
a1420 1
		IFS=:; read dep pkg subdir target; \
@


1.810
log
@oops typo. make sure lib depends are done
@
text
@a1048 8
_build_depends_fragment= \
	if pkg_info -q -e "$$pkg"; then \
		found=true; \
	fi
_run_depends_fragment=${_build_depends_fragment}

_regress_depends_fragment=${_build_depends_fragment}

a1073 8
_lib_depends_fragment = \
	if $$defaulted; then \
		pkg=`echo $$pkg|${_version2default}`; \
	fi; \
	what="$$pkg"; \
	if pkg_info -q -e "$$pkg"; then \
		found=true; \
	fi
d1438 1
d1469 1
a1469 2
				${_${_DEP:L}_depends_fragment}; \
				if $$found; then \
@


1.809
log
@start making a big distinction between lib depends evaluated at build time
and at `run(packaging)' time.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.808 2006/11/19 12:37:55 espie Exp $
d1140 2
a1141 2
_DEP_BUILDLIB_COOKIES=${_DEPLIB_COOKIES}
_DEP_RUNLIB_COOKIES=${_DEPLIB_COOKIES}
@


1.808
log
@also use RUN_DEPENDS${SUBPACKAGE} in the simple parts.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.807 2006/11/19 12:32:53 espie Exp $
d469 4
a472 1
${_DEPWANTLIB_COOKIE} ${_DEPLIBSPECS_COOKIES}
d1140 2
d1213 2
a1214 1
_DEPWANTLIB_COOKIE=${WRKDIR}/.wantlibs
d1216 2
a1217 1
_DEPWANTLIB_COOKIE=
d1219 2
d1222 2
d1419 2
a1420 1
	_internal-run-depends _internal-wantlib-depends _internal-regress-depends
d1509 2
d1512 3
a1514 2
.if !empty(_DEPWANTLIB_COOKIE)
${_DEPLIBSPECS_COOKIES}: ${_WRKDIR_COOKIE}
d1517 2
a1518 2
${_DEPWANTLIB_COOKIE}: ${_DEPLIBSPECS_COOKIES} ${_DEPLIB_COOKIES} ${_DEPBUILD_COOKIES} ${_WRKDIR_COOKIE}
	@@${ECHO_MSG} "===>  Verifying specs: ${_DEPLIBS}"
d1520 1
a1520 1
	for d in ${_DEPLIBS:S/>/\>/g}; do \
d1528 1
a1528 1
		${PORTSDIR}/infrastructure/build/resolve-lib ${_noshared} ${_DEPLIBS:S/>/\>/g}`; then \
d1537 1
a1537 1
.endif
d1539 2
a1540 1
_internal-wantlib-depends: ${_DEPWANTLIB_COOKIE}
d1665 1
a1665 1
_internal-patch: ${_DEPBUILD_COOKIES} ${_DEPLIB_COOKIES} ${_DEPWANTLIB_COOKIE} \
d1667 1
a1667 1
_internal-distpatch: ${_DEPBUILD_COOKIES} ${_DEPLIB_COOKIES} ${_DEPWANTLIB_COOKIE} \
d1669 1
a1669 1
_internal-configure: ${_DEPBUILD_COOKIES} ${_DEPLIB_COOKIES} ${_DEPWANTLIB_COOKIE} \
d1671 2
a1672 2
_internal-build _internal-all: ${_DEPBUILD_COOKIES} ${_DEPLIB_COOKIES} \
	${_DEPWANTLIB_COOKIE} ${_BUILD_COOKIE}
d1812 1
a1812 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-checksum _internal-build-depends _internal-lib-depends _internal-wantlib-depends
d2078 1
a2078 1
	@@cd ${.CURDIR} && DEPENDS_TARGET=install PACKAGING='${SUBPACKAGE}' exec ${MAKE} _internal-run-depends _internal-lib-depends
d2855 3
a2857 1
	_internal-depends _internal-lib-depends _internal-wantlib-depends \
@


1.807
log
@add an extra level of indirection for dependency lists: _xxx_DEPLIST.
allows us to get rid of some NO_DEPENDS tests later, also allows for
RUN_DEPENDS to become indexed on SUBPACKAGE.

LIB_DEPENDS and WANTLIB are going to need more surgery, since they need
to be checked during build and packaging...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.806 2006/11/19 12:11:30 espie Exp $
d1187 3
a1189 3
.if defined(RUN_DEPENDS)
_RUN_DEP2 = ${RUN_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_RUN_DEP = ${_RUN_DEP2:C/[^:]*://}
d2493 1
a2493 1
.for _i in ${RUN_DEPENDS}
d2571 1
a2571 1
.for _i in ${RUN_DEPENDS}
@


1.806
log
@rename more internal stuff to make it less visually confusing:
_DEPlibs_COOKIE => _DEPWANTLIB_COOKIE
_DEPlibs_COOKIES => _DEPLIBSPECS_COOKIES
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.805 2006/11/19 12:05:10 espie Exp $
d91 2
a92 2
_ALL_VARIABLES2?=COMMENT FULLPKGNAME PKGNAME PKG_ARCH \
PERMIT_PACKAGE_FTP PERMIT_PACKAGE_CDROM
d589 1
a589 1
.    for _v in PKG_ARCH PERMIT_PACKAGE_FTP PERMIT_PACKAGE_CDROM
d1124 7
d1133 1
a1133 2
.  if ${NO_DEPENDS:L} == "no"
.    for _i in ${${_DEP}_DEPENDS}
d1135 1
a1135 2
.    endfor
.  endif
d1420 1
a1420 2
.  if ${NO_DEPENDS:L} == "no"
.    for _i in ${${_DEP}_DEPENDS}
d1494 1
a1494 2
.    endfor
.  endif
d2792 1
a2792 1
.for _s in ${_ALL_VARIABLES2}
@


1.805
log
@rename some internal variables: _DEPlib_COOKIES -> _DEPLIB_COOKIES.

simplify some
.if defined(A)
.  for i in $A
      ...
.  endfor
.endfor

into

.for i in $A
      ...
.  endfor
.endfor

since empty loops work just fine.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.804 2006/11/18 00:15:33 espie Exp $
d469 1
a469 1
${_DEPlibs_COOKIE} ${_DEPlibs_COOKIES}
d1198 1
a1198 1
_DEPlibs_COOKIES=
d1201 1
a1201 1
_DEPlibs_COOKIES+=${WRKDIR}/.wantlib-$i
d1203 1
a1203 1
_DEPlibs_COOKIE=${WRKDIR}/.wantlibs
d1205 1
a1205 1
_DEPlibs_COOKIE=
d1403 1
a1403 1
	_internal-run-depends _internal-libs-depends _internal-regress-depends
d1495 2
a1496 2
.if !empty(_DEPlibs_COOKIE)
${_DEPlibs_COOKIES}: ${_WRKDIR_COOKIE}
d1499 1
a1499 1
${_DEPlibs_COOKIE}: ${_DEPlibs_COOKIES} ${_DEPLIB_COOKIES} ${_DEPBUILD_COOKIES} ${_WRKDIR_COOKIE}
d1521 1
a1521 1
_internal-libs-depends: ${_DEPlibs_COOKIE}
d1646 1
a1646 1
_internal-patch: ${_DEPBUILD_COOKIES} ${_DEPLIB_COOKIES} ${_DEPlibs_COOKIE} \
d1648 1
a1648 1
_internal-distpatch: ${_DEPBUILD_COOKIES} ${_DEPLIB_COOKIES} ${_DEPlibs_COOKIE} \
d1650 1
a1650 1
_internal-configure: ${_DEPBUILD_COOKIES} ${_DEPLIB_COOKIES} ${_DEPlibs_COOKIE} \
d1653 1
a1653 1
	${_DEPlibs_COOKIE} ${_BUILD_COOKIE}
d1793 1
a1793 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-checksum _internal-build-depends _internal-lib-depends _internal-libs-depends
d2836 1
a2836 1
	_internal-depends _internal-lib-depends _internal-libs-depends \
@


1.804
log
@start of multi-packages simplification: if MULTI_PACKAGES contains -main,
consider it to be the main package, and do some equal treatment for each
package.

(to do: add subpackage where needed to WANTLIB, RUN_DEPENDS, LIB_DEPENDS
and act on them accordingly).

Also define _DONE_FILES for _fetch-makefile to avoid blocking if it's
not invoked from a higher level target.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.803 2006/11/17 17:16:16 espie Exp $
d467 2
a468 2
${_WRKDIR_COOKIE} ${_DEPlib_COOKIES} ${_DEPbuild_COOKIES} \
${_DEPrun_COOKIES} ${_DEPregress_COOKIES} ${_UPDATE_COOKIE} \
d1124 1
a1124 1
.for _DEP in build run lib regress
d1126 2
a1127 2
.  if defined(${_DEP:U}_DEPENDS) && ${NO_DEPENDS:L} == "no"
.    for _i in ${${_DEP:U}_DEPENDS}
d1414 3
a1416 3
.for _DEP in build run lib regress
.  if defined(${_DEP:U}_DEPENDS) && ${NO_DEPENDS:L} == "no"
.    for _i in ${${_DEP:U}_DEPENDS}
d1421 1
a1421 1
		extra_msg="(${_DEP:U}_DEPENDS ${_i})"; \
d1423 1
a1423 1
		case "X$$target" in X) target=${_${_DEP}_depends_target};; esac; \
d1468 1
a1468 1
				${_${_DEP}_depends_fragment}; \
d1492 1
a1492 1
_internal-${_DEP}-depends: ${_DEP${_DEP}_COOKIES}
d1499 1
a1499 1
${_DEPlibs_COOKIE}: ${_DEPlibs_COOKIES} ${_DEPlib_COOKIES} ${_DEPbuild_COOKIES} ${_WRKDIR_COOKIE}
d1646 1
a1646 1
_internal-patch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} ${_DEPlibs_COOKIE} \
d1648 1
a1648 1
_internal-distpatch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} ${_DEPlibs_COOKIE} \
d1650 1
a1650 1
_internal-configure: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} ${_DEPlibs_COOKIE} \
d1652 1
a1652 1
_internal-build _internal-all: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
d1664 1
a1664 1
_internal-regress: ${_BUILD_COOKIE} ${_DEPregress_COOKIES} ${_REGRESS_COOKIE}
@


1.803
log
@allows one to short-circuit PKG_ARCH=* in the build process
by setting NO_ARCH to MACHINE_ARCH/all
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.802 2006/11/13 14:14:57 espie Exp $
a76 1
PKGNAMES=${FULLPKGNAME}
d322 1
d324 6
a1159 1
_FMN=${PKGPATH}/${FULLPKGNAME}
d1745 1
d1747 1
d1758 1
d1760 1
d2207 1
d2209 1
d2219 1
d2221 1
d2254 1
a2254 1
	@@if ! fgrep -q "|${_F}|" $${_DONE_FILES}; then \
@


1.802
log
@index PKG_ARCH, PERMIT_PACKAGE_FTP, PERMIT_PACKAGE_CDROM on SUBPACKAGE name.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.801 2006/11/13 13:55:10 espie Exp $
d592 1
a592 1
.if ${PKG_ARCH${SUBPACKAGE}} == "*"
@


1.801
log
@avoid ignoring ports while running a `describe' target.
triggered by setting DESCRIBE_TARGET=Yes in bsd.port.subdir.mk
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.800 2006/11/12 10:52:59 espie Exp $
d81 1
a81 1
NO_BUILD NO_REGRESS PKG_ARCH SHARED_ONLY ONLY_FOR_ARCHS IS_INTERACTIVE \
a84 1
PERMIT_PACKAGE_CDROM PERMIT_PACKAGE_FTP \
d92 2
a93 1
_ALL_VARIABLES2?=COMMENT FULLPKGNAME PKGNAME
d581 8
d592 1
a592 1
.if ${PKG_ARCH} == "*"
d604 1
a604 1
.if ${PERMIT_PACKAGE_FTP:L} == "yes"
d608 1
a608 1
.if ${PERMIT_PACKAGE_CDROM:L} == "yes"
d689 2
a690 2
PKG_ARGS+=-DPERMIT_PACKAGE_CDROM=${PERMIT_PACKAGE_CDROM:Q}
PKG_ARGS+=-DPERMIT_PACKAGE_FTP=${PERMIT_PACKAGE_FTP:Q}
d762 1
a762 1
PKG_ARGS+=-A'${PKG_ARCH}'
d2329 1
a2329 1
.  if ${PERMIT_PACKAGE_CDROM:L} == "yes"
d2334 1
a2334 1
.  if ${PERMIT_PACKAGE_FTP:L} == "yes"
d2427 1
a2427 1
.if ${PERMIT_PACKAGE_CDROM:L} == "yes" || ${PERMIT_PACKAGE_FTP:L} == "yes"
d2430 2
a2431 2
		_MASTER_PERMIT_CDROM=${PERMIT_PACKAGE_CDROM:Q}; \
		_MASTER_PERMIT_FTP=${PERMIT_PACKAGE_FTP:Q}; \
@


1.800
log
@move PKG_ARCH after MODULES
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.799 2006/11/11 16:32:12 espie Exp $
d974 1
a974 1
.if !defined(NO_IGNORE)
a985 2
.  elif defined(BROKEN)
IGNORE=	"is marked as broken: ${BROKEN}"
d1008 6
a1013 2
.  if !defined(IGNORE) && defined(COMES_WITH)
.    if ( ${OPSYS_VER} >= ${COMES_WITH} )
a1014 1
.    endif
d1016 1
a1016 2

.endif		# NO_IGNORE
@


1.799
log
@Top-level redirectors which recurse for multi-packages should display where
they are. This does unconfuse pkg_mklocatedb
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.798 2006/11/11 16:10:36 espie Exp $
a145 6
.if ${MACHINE_ARCH} != ${ARCH}
PKG_ARCH?=${MACHINE_ARCH},${ARCH}
.else
PKG_ARCH?=${MACHINE_ARCH}
.endif

d246 6
@


1.798
log
@shorten dependency names, so that regress and run can share.
add print-plist-all, for better introspection (to be used by pkg_mklocatedb).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.795 2006/11/05 20:20:28 espie Exp $
d1735 1
@


1.797
log
@zap uses of ${SH}
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.796 2006/11/09 08:16:22 espie Exp $
d1114 1
a1114 1
_DEP${_DEP}_COOKIES+=${WRKDIR}/.${_DEP}${_i:C,[|:./<=>*],-,g}
d1404 1
a1404 1
${WRKDIR}/.${_DEP}${_i:C,[|:./<=>*],-,g}: ${_WRKDIR_COOKIE}
d1729 1
d2826 1
a2826 1
	full-regress-depends
@


1.796
log
@remove the dependency of make-plist on dependent packages: instead, go
directly use `make print-plist' to find these lists in the ports tree.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.795 2006/11/05 20:20:28 espie Exp $
d1998 2
a1999 2
	@@if [ x`${SUDO} ${SH} -c umask` != x${DEF_UMASK} ]; then \
		echo >&2 "Error: your umask is \"`${SH} -c umask`"\".; \
@


1.795
log
@have _internal-regress depend on the _BUILD_COOKIE, so that build is
performed before regress dependencies.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.794 2006/11/05 15:46:51 espie Exp $
d1673 1
a1673 1
_internal-plist _internal-update-plist: _internal-fake ${_DEPrun_COOKIES}
d1680 3
a1682 2
	DEPS="`${MAKE} full-run-depends ${_do_libs_too}`" \
	PKGREPOSITORY=${_PKG_REPO} \
@


1.794
log
@add regress-dir-depends/full-regress-depends, similar mechanism to
run-depends, only the basic test changes.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.793 2006/11/03 17:03:28 espie Exp $
d1651 1
a1651 1
_internal-regress: ${_DEPregress_COOKIES} ${_REGRESS_COOKIE}
@


1.793
log
@bye, bye SCRIPTS_ENV,
bye, bye SCRIPTDIR
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.792 2006/11/01 12:41:34 espie Exp $
d1177 8
d2406 2
a2407 2
# full-build-depends, full-all-depends, full-run-depends
.for _i in build all run
d2590 26
d2822 3
a2824 1
	subpackage _internal-subupdate _internal-update
@


1.792
log
@zap a few non relevant lines, make _ALL_VARIABLES* internal.
Use TMPDIR in pkgpath.mk
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.791 2006/10/23 14:33:01 espie Exp $
a43 3
# SCRIPTS_ENV	- Additional environment vars passed to scripts in
#                 ${SCRIPTDIR} executed by bsd.port.mk.
#
a273 8
.if exists(${.CURDIR}/scripts.${ARCH})
SCRIPTDIR?=		${.CURDIR}/scripts.${ARCH}
.elif exists(${.CURDIR}/scripts.${MACHINE_ARCH})
SCRIPTDIR?=		${.CURDIR}/scripts.${MACHINE_ARCH}
.else
SCRIPTDIR?=		${.CURDIR}/scripts
.endif

a638 1
SCRIPTS_ENV+=	${_INSTALL_MACROS}
a941 13
# Passed to configure invocations, and user scripts
SCRIPTS_ENV+= CURDIR=${.CURDIR} DISTDIR=${DISTDIR} \
          PATH=${PORTPATH} WRKDIR=${WRKDIR} WRKDIST=${WRKDIST} \
		  WRKSRC=${WRKSRC} WRKBUILD=${WRKBUILD} \
		  PATCHDIR=${PATCHDIR} SCRIPTDIR=${SCRIPTDIR} FILESDIR=${FILESDIR} \
		  PORTSDIR=${PORTSDIR} DEPENDS="${DEPENDS}" \
		  PREFIX=${PREFIX} LOCALBASE=${LOCALBASE} DEPBASE='${DEPBASE}' \
		  X11BASE=${X11BASE}

.if defined(BATCH)
SCRIPTS_ENV+=	BATCH=yes
.endif

a1919 4
	@@if [ -f ${SCRIPTDIR}/configure ]; then \
		cd ${.CURDIR} &&  ${_SYSTRACE_CMD} ${SETENV} \
			${SCRIPTS_ENV} ${SH} ${SCRIPTDIR}/configure; \
	fi
@


1.791
log
@generic BULK_DO fragment that can do anything, invoked right before clean.

can be used to run targets that may fail without impacting further stuff,
or to collect stats on anything.
For instance

BULK_DO= mkdir -p ${PORTSDIR}/config/${FULLPKGPATH}; \
	cp -f ${WRKBUILD}/config.{log,status} ${PORTSDIR}/config/${FULLPKGPATH} || true; \
	cd ${PACKAGE_REPOSITORY}/${MACHINE_ARCH}/all && perl ${PORTSDIR}/infrastructure/package/check-modes ${PKGNAMES} || true
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.790 2006/10/23 13:42:50 espie Exp $
a43 1
# NO_PKG_REGISTER - Don't register a port install as a package.
a69 1
BIN_PACKAGES?=No
d82 1
a82 1
ALL_VARIABLES?=HOMEPAGE DISTNAME LIB_DEPENDS \
d95 2
a96 1
ALL_VARIABLES2?=COMMENT FULLPKGNAME PKGNAME
d2755 1
a2755 1
.for _s in ${ALL_VARIABLES}
d2760 1
a2760 1
.for _s in ${ALL_VARIABLES2}
@


1.790
log
@fix a bunch of issues:
- make sure locks happen when they should, including for lib-depends-check.
- make sure various targets set PACKAGING as they should.
- let BULK=Yes be invoked only from make package.

Fix for the BULK_COOKIE and UPDATE_COOKIE issue. They can no longer depend
on PACKAGE_COOKIES, since this needs to get built with PACKAGING set. So
instead, simply remove the cookies when we create a new package succesfully.

By any kind of reasoning, both bulk and update are `reset' when a new
package appears, so this seems to be the right semantics in most cases.

Thanks for wilfried and nikolay for error spotting. Hoping this will be
what's needed, finally.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.789 2006/10/21 12:46:09 espie Exp $
d80 1
d139 1
d1776 3
@


1.789
log
@work-around for infinite recursion... gonna fix bulk stuff for real soon.
thanks nikolay
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.788 2006/10/21 12:10:35 espie Exp $
a1145 9
_INSTALL_DEPS=${_INSTALL_COOKIE}
_PACKAGE_DEPS=${_PACKAGE_COOKIES}
_UPDATE_DEPS=${_UPDATE_COOKIE}
_BULK__internal-package=Yes
.if ${BULK_${PKGPATH}:L} == "yes"
_INSTALL_DEPS+=${_BULK_COOKIE}
_UPDATE_DEPS+=${_BULK_COOKIE}
.endif

d1331 1
d1546 2
a1547 1
sublib-depends-check: ${_PACKAGE_COOKIES}
d1657 1
a1657 1
_internal-install: ${_INSTALL_DEPS}
d1659 1
a1659 1
_internal-subupdate: ${_UPDATE_DEPS}
d1725 4
a1728 7
_TOP_TARGETS=extract patch distpatch configure build all install fake \
subpackage subupdate \
fetch checksum regress depends lib-depends build-depends run-depends \
regress-depends clean manpages-check \
plist update-plist update package \
install-all
.for _t in ${_TOP_TARGETS}
d1737 3
d1741 4
a1744 1
.for _t _r in _internal-package _internal-subpackage describe subdescribe lib-depends-check sublib-depends-check dump-vars subdump-vars _internal-install-all _internal-install readmes _readme _internal-update _internal-subupdate
d1752 11
a1762 1
.  if defined(_BULK_${_t}) && ${BULK_${PKGPATH}:L} == "yes"
d1764 2
a1765 2
.  endif
.endfor
d1768 1
a1768 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-package BULK=No
d2104 1
a2104 1
_internal-subpackage: ${_PACKAGE_DEPS}
d2801 2
a2802 1
	_internal-package _internal-fetch _internal-checksum \
@


1.788
log
@can not depend directly on PACKAGE_COOKIES.
Found out by nikolay, fun to debug...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.787 2006/10/21 11:50:48 espie Exp $
d1762 1
a1762 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-package
@


1.787
log
@move SHARED_LIBS_LOG into WRKBUILD
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.786 2006/10/21 11:20:36 espie Exp $
d1761 2
a1762 1
${_BULK_COOKIE}: ${_PACKAGE_COOKIES}
@


1.786
log
@define SHARED_LIBS_LOG for libtool (and other stuff) use
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.785 2006/10/18 16:53:04 sturm Exp $
d331 1
a331 1
MAKE_FLAGS+=		SHARED_LIBS_LOG=${WRKDIR}/shared.log
@


1.785
log
@don't throw an error in fetch, when no distinfo file exists
but error out in _internal-checksum, when there should be one

ok espie
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.784 2006/10/18 11:09:30 espie Exp $
d331 1
@


1.784
log
@special case: if PKGPATH is the LIB_DEPENDS base, then it means we're
building a subpackage, and then we definitely want the `current' stuff,
not the stuff that's already installed.

Allows shared libs updates in MULTI_PACKAGES to proceed gracefully without
having to uninstall stuff.

(we do not do this stuff in general, because in other cases, builds are
`staggered', e.g., a port is built against the existing base, not the stuff
in other WRKDIRS)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.783 2006/10/18 10:51:39 espie Exp $
d1597 3
a1599 1
	if [ ! -f $$checksum_file ]; then \
d1601 1
d2124 4
a2127 1
				if grep -q "^$$ck\$$" ${CHECKSUM_FILE}; then \
@


1.783
log
@put no-arch into a variable, so that people can override it.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.782 2006/10/17 22:32:45 espie Exp $
d2488 3
@


1.782
log
@let peek-ftp cd ${FULLDISTDIR} first.
Add a message to that effect so that users don't get confused.
(specifically, make itself does not change dirs, so if you do ^Z,
you're not where you think you are...)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.781 2006/10/16 10:39:40 espie Exp $
d592 1
d594 2
a595 2
_PACKAGE_COOKIE=	${PACKAGE_REPOSITORY}/no-arch/${_PKGFILE}
_PACKAGE_LINKS+=	${MACHINE_ARCH}/all no-arch
d1295 1
a1295 1
	@@if ${SETENV} PKG_CACHE=${_CACHE_REPO} PKG_PATH=${_CACHE_REPO}:${_PKG_REPO}:${PACKAGE_REPOSITORY}/no-arch/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n -q ${_PKG_ADD_FORCE} ${_PKGFILE} >/dev/null 2>&1; then \
@


1.781
log
@protect against further bugs, refuse to build the _PACKAGE_COOKIE if we
end up there with PACKAGING not set.
We do not try to `fix it' ourselves, because PACKAGING not set may have
some non obvious issues, like PKG_ARCH or PERMIT_PACKAGE_* not set correctly
at all.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.780 2006/10/15 19:29:06 espie Exp $
d2714 2
a2715 1
	@@for i in ${MASTER_SITES:Mftp*}; do echo "Connecting to $$i"; ${FETCH_CMD} $$i ; break; done
@


1.780
log
@say goodbye for FAKE=no, for real.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.779 2006/10/15 09:22:49 espie Exp $
d1303 3
@


1.779
log
@-Q implies -q, anyways.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.778 2006/10/15 09:20:53 espie Exp $
a448 1
.if ${FAKE:L} != "no"
a450 6
.elif ${SEPARATE_BUILD:L} != "no"
_INSTALL_PRE_COOKIE=${WRKBUILD}/.install_started
.else
_INSTALL_PRE_COOKIE=${WRKDIR}/.install_started
_FAKE_COOKIE=		${WRKDIR}/.fake_done
.endif
a583 1
.if ${FAKE:L} != "no"
a584 3
.else
_PACKAGE_COOKIE_DEPS=${_INSTALL_COOKIE}
.endif
a761 1
.if ${FAKE:L} != "no"
a762 1
.endif
d1675 1
a1675 2
.if ${FAKE:L} != "no"
.  if ${SHARED_ONLY:L} == "yes"
d1677 1
a1677 1
.  else
d1679 1
a1679 1
.  endif
a1705 1
.endif
a1996 1
.if ${FAKE:L} != "no"
d2006 1
a2006 1
.  for _p in ${PROTECT_MOUNT_POINTS}
d2008 3
a2010 3
.  endfor
.  for _m in ${MODULES}
.    if defined(MOD${_m:U}_pre-fake)
d2012 2
a2013 2
.    endif
.  endfor
d2015 1
a2015 1
.  if target(pre-fake)
d2017 1
a2017 1
.  endif
d2019 1
a2019 1
.  if target(pre-install)
d2021 2
a2022 2
.  endif
.  if target(do-install)
d2024 1
a2024 1
.  else
d2028 2
a2029 2
.  endif
.  if target(post-install)
d2031 2
a2032 2
.  endif
.  for _p in ${PROTECT_MOUNT_POINTS}
d2034 1
a2034 1
.  endfor
d2043 2
a2044 2
.  for _m in ${MODULES}
.    if defined(MOD${_m:U}_pre_install)
d2046 3
a2048 3
.    endif
.  endfor
.  if ${TRUST_PACKAGES:L} == "yes"
d2054 1
a2054 1
.  else
d2056 1
a2056 1
.  endif
a2057 1
.endif
a2665 4
.endif

.if ${FAKE:L} == "no"
.  include "${PORTSDIR}/infrastructure/mk/old-install.mk"
@


1.778
log
@also mention -n along -q on `print-plist' commands.
I've started documenting it, and having -q do things on its own
is quirky...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.777 2006/10/12 08:45:56 espie Exp $
d2104 1
a2104 1
	@@${PKG_CMD} -n -q -Q ${PKG_ARGS} ${_PACKAGE_COOKIE}
@


1.777
log
@quick-fix for make install, as reported by stevens@@ and naddy@@.
Need more thinking about...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.776 2006/10/09 18:11:38 espie Exp $
d2101 1
a2101 1
	@@${PKG_CMD} -q ${PKG_ARGS} ${_PACKAGE_COOKIE}
d2104 1
a2104 1
	@@${PKG_CMD} -q -Q ${PKG_ARGS} ${_PACKAGE_COOKIE}
@


1.776
log
@cheat a bit: make sure the right variables are used for MULTI_PACKAGES.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.775 2006/10/02 17:26:34 espie Exp $
d2055 1
a2055 1
${_INSTALL_COOKIE}: ${_PACKAGE_COOKIES}
@


1.775
log
@oops, do not unset SUBPACKAGE

Move BULK_COOKIE for package to the redirector, so that we do not
clean in subpackage cases, but instead wait for all the packages to be built.

Also, introduce FORCE_UPDATE=hard: with signatures, -F installed is
most often not necessary...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.774 2006/10/02 09:37:14 espie Exp $
d83 1
a83 1
ALL_VARIABLES?=PKGNAME HOMEPAGE DISTNAME COMMENT LIB_DEPENDS \
d96 1
d2753 5
@


1.774
log
@fix FETCH_PACKAGES: create a real target (packages/arch/cache/pkgname.tgz)
and link to it from elsewhere.

Fixes the no-arch case, and makes it ways easier to find out what was
retrieved through the cache.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.773 2006/09/27 10:09:34 espie Exp $
d1131 1
a1131 1
.if ${FORCE_UPDATE:L} == "yes"
d1133 4
a1136 1
_PKG_ADD_FORCE=-F update -F updatedepends -F installed -r
d1159 1
a1161 1
_PACKAGE_DEPS+=${_BULK_COOKIE}
d1322 1
a1322 1
	@@cd ${.CURDIR} && unset PACKAGING SUBPACKAGE|| true && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS} ${_PKG_PREREQ}
d1761 3
@


1.773
log
@more fixes for new issues: let the update cookie depend on the `full'
package cookie, so that an update will get all subpackages built.

And a fix for an old issue: let make update proceed to update ALL subpackages,
as seems the most natural. Create a subupdate target if one specifically
wants to update a single package (and use it as dependency in the FORCE_UPDATE
case).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.772 2006/09/23 09:40:06 espie Exp $
d610 1
d1295 4
d1300 4
a1303 3
_fetch_packages_fragment= \
	${ECHO_MSG} -n "===>  Looking for $$fullpkgname in \$$PKG_PATH - "; \
	if ${SETENV} PKG_CACHE=${_PKG_REPO} PKG_PATH=${_PKG_REPO}/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n -q ${_PKG_ADD_FORCE} $$fullpkgname >/dev/null 2>&1; then \
a1304 9
		if [ ! -f $$pkg_cookie ]; then \
			for _d in ${PKG_PATH:S,/:,/ ,g}; do \
				if [ -f $${_d}$$fullpkgname${PKG_SUFX} ]; then \
 					ln $${_d}$$fullpkgname${PKG_SUFX} ${_PKG_REPO} 2>/dev/null || \
 					  cp -p $${_d}$$fullpkgname${PKG_SUFX} ${_PKG_REPO}; \
					break; \
				fi; \
			done; \
		fi; \
d1306 4
a1309 3
	fi; \
	${ECHO_MSG} "not found"; \
	cd ${.CURDIR} && exec ${MAKE} $$tried=Yes $$pkg_cookie
a1310 5
###
### end of variable setup. Only targets now
###

.if ${FETCH_PACKAGES:L} == "yes" && !defined(_TRIED_FETCHING_${_PACKAGE_COOKIE})
d1313 5
a1317 4
	@@fullpkgname=${FULLPKGNAME${SUBPACKAGE}}; \
	pkg_cookie=${_PACKAGE_COOKIE} \
	tried=_TRIED_FETCHING_${_PACKAGE_COOKIE}; \
	${_fetch_packages_fragment}
d1319 1
a1319 3
${_PACKAGE_COOKIE}:
	@@cd ${.CURDIR} && unset PACKAGING || true && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS} ${_PKG_PREREQ}
	@@mkdir -p ${@@D}
@


1.772
log
@Fix install, as noticed by fgs: just do a partial depend on the package
cookies, and also insist on running make package, which is necessary to
make sure all MULTI_PACKAGES get built.

Repair make clean=packages: make sure all packages get named using the same
scheme as other multi-packages targets (that way, arch-indep subpackages
get cleaned properly)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.771 2006/09/21 11:31:33 bernd Exp $
d1131 1
a1131 1
_force_update_fragment=eval $$toset ${MAKE} update
d1551 1
a1551 1
_internal-update-plist update-patches \
d1675 1
a1675 1
_internal-update: ${_UPDATE_DEPS}
d1744 1
a1744 1
subpackage \
d1759 1
a1759 1
.for _t _r in _internal-package _internal-subpackage describe subdescribe lib-depends-check sublib-depends-check dump-vars subdump-vars _internal-install-all _internal-install readmes _readme
d2078 1
a2078 1
	@@cd ${.CURDIR} && SUBPACKAGE=${SUBPACKAGE} PACKAGING='${SUBPACKAGE}' exec ${MAKE} _internal-subpackage
d2807 1
a2807 1
	subpackage
@


1.771
log
@Don't error out if 'unset PACKAGING' returns false. Unbreaks 'make install'.

Noticed by many.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.770 2006/09/19 20:10:40 espie Exp $
a1154 3
.if defined(ALWAYS_PACKAGE)
_INSTALL_DEPS+=${_PACKAGE_COOKIES}
.endif
d2056 2
a2057 1
${_INSTALL_COOKIE}:  ${_PACKAGE_COOKIES}
d2204 1
a2204 1
	rm -f ${_PACKAGE_COOKIES}
d2207 1
a2207 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' exec ${MAKE} clean=package
@


1.770
log
@readmes is yet another target that should recurse.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.769 2006/09/19 19:54:14 espie Exp $
d1329 1
a1329 1
	@@cd ${.CURDIR} && unset PACKAGING && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS} ${_PKG_PREREQ}
@


1.769
log
@unset PACKAGING before iterating from PACKAGE_COOKIE.
This forces BIN_PACKAGES=Yes always, probably a good thing.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.768 2006/09/19 11:25:17 espie Exp $
d206 1
a206 1
	readme bulk force
d1762 1
a1762 1
.for _t _r in _internal-package _internal-subpackage describe subdescribe lib-depends-check sublib-depends-check dump-vars subdump-vars _internal-install-all _internal-install
d2359 1
a2359 10
readmes:
.if defined(MULTI_PACKAGES) && !defined(PACKAGING)
	@@cd ${.CURDIR} && SUBPACKAGE='${SUBPACKAGE}' PACKAGING='${SUBPACKAGE}' exec ${MAKE} readmes
.  if empty(SUBPACKAGE)
.    for _sub in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' PACKAGING='${_sub}' exec ${MAKE} readmes
.    endfor
.  endif
.else
	@@rm -f ${FULLPKGNAME${SUBPACKAGE}}.html
a2360 2
.endif

d2789 1
a2789 1
	readmes rebuild \
@


1.768
log
@fix update: now that we no longer recurse at the cookie level, we have
to recurse higher.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.767 2006/09/18 18:17:30 espie Exp $
a1327 1
.  if ${BIN_PACKAGES:L} == "yes"
d1329 1
a1329 4
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS} ${_PKG_PREREQ}
.  else
${_PACKAGE_COOKIE}: ${_PACKAGE_COOKIE_DEPS} ${_PKG_PREREQ}
.  endif
@


1.767
log
@typo, found by Mikolaj Kucharski <eth0@@o2.pl>
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.766 2006/09/18 08:16:19 espie Exp $
d2083 2
a2084 1
${_UPDATE_COOKIE}: ${_PACKAGE_COOKIES}
@


1.766
log
@fix describe/dump-vars
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.765 2006/09/17 22:08:19 espie Exp $
d1300 1
a1300 1
	if ${SETENV} PKG_CACHE=${_PKGREPOSITORY} PKG_PATH=${_PKGREPOSITORY}/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n -q ${_PKG_ADD_FORCE} $$fullpkgname >/dev/null 2>&1; then \
d1305 2
a1306 2
 					ln $${_d}$$fullpkgname${PKG_SUFX} ${_PKGREPOSITORY} 2>/dev/null || \
 					  cp -p $${_d}$$fullpkgname${PKG_SUFX} ${_PKGREPOSITORY}; \
@


1.765
log
@somewhat big change: zap the package-link/package-unlink stuff, turn these
into real targets.

- now make package will create missing ftp/cdrom links when PERMIT says so.
- PKG_ARCH=* packages get built into packages/no-arch, and linked from
elsewhere.

Everything gets based off PACKAGE_REPOSITORY, PKGREPOSITORYBASE and friends
get ditched.

All `package' targets go through the same routine: iterate through every
subpackage with PACKAGING set.

This includes describe, lib-depends-check, package, dump-vars, install-all,
which will iterate through subdescribe, sublib-depends-check, subpackage,
subdump-vars, and install.
(names are subject to change).

Much simpler logic, plus hey, you get an install-all target !

Might be some minor breakage, most stuff appear to work just fine...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.763 2006/08/07 08:57:18 espie Exp $
d1751 1
a1751 1
subpackage subdescribe sublib-depends-check subdump-vars \
d1754 1
a1754 1
plist update-plist update package describe dump-vars \
@


1.764
log
@more generic protection against multiple locking: instead of one
_MASTER_LOCK, we keep a list of _LOCKS_HELD by one port builder in
an env variable, and we don't relock stuff that's already locked.

This allows us to, e.g., have fake depend on regress without issue
(even though, internally, it's more efficient to use the _internal-*
targets to avoid testing locks).
@
text
@d30 6
d128 1
a128 4
PKGREPOSITORYBASE?=	${PORTSDIR}/packages/${MACHINE_ARCH}
PKGREPOSITORY?=		${PKGREPOSITORYBASE}/all
CDROM_PACKAGES?=	${PKGREPOSITORYBASE}/cdrom
FTP_PACKAGES?=		${PKGREPOSITORYBASE}/ftp
a424 1
PKGFILE=${PKGREPOSITORY}/${FULLPKGNAME}${PKG_SUFX}
a436 1
PKGFILE${_s} = ${PKGREPOSITORY}/${FULLPKGNAME${_s}}${PKG_SUFX}
a456 1
_PACKAGE_COOKIE=	${PKGFILE}
a595 1
_PACKAGE_COOKIES= ${_PACKAGE_COOKIE}
a596 2
_PACKAGE_COOKIE${_s} = ${PKGFILE${_s}}
_PACKAGE_COOKIES += ${_PACKAGE_COOKIE${_s}}
d600 22
d1300 1
a1300 1
	if ${SETENV} PKG_CACHE=${PKGREPOSITORY} PKG_PATH=${PKGREPOSITORY}/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n -q ${_PKG_ADD_FORCE} $$fullpkgname >/dev/null 2>&1; then \
d1305 2
a1306 2
 					ln $${_d}$$fullpkgname${PKG_SUFX} ${PKGREPOSITORY} 2>/dev/null || \
 					  cp -p $${_d}$$fullpkgname${PKG_SUFX} ${PKGREPOSITORY}; \
a1315 8
_pkgrepository_fragment= \
	if [ ! -d ${PKGREPOSITORY} ]; then \
		if ! mkdir -p ${PKGREPOSITORY}; then \
			echo ">> Cannot create directory ${PKGREPOSITORY}."; \
			exit 1; \
		fi; \
	fi

d1322 3
a1324 3
	@@${_pkgrepository_fragment}
	@@fullpkgname=${FULLPKGNAME}; \
	pkg_cookie=${_PACKAGE_COOKIE}; \
d1330 1
a1330 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
d1332 1
a1332 1
${_PACKAGE_COOKIE}: ${_PACKAGE_COOKIE_DEPS}
d1334 3
a1336 4
	@@${_pkgrepository_fragment}
	@@cd ${.CURDIR} && SUBPACKAGE='' PACKAGING='' exec ${MAKE} _package
.  if !defined(PACKAGE_NOINSTALL)
	@@${_MAKE_COOKIE} $@@
d1338 2
a1339 10
.endif

.for _s in ${MULTI_PACKAGES}
.  if ${FETCH_PACKAGES:L} == "yes" && !defined(_TRIED_FETCHING_${_PACKAGE_COOKIE${_s}})
${_PACKAGE_COOKIE${_s}}:
	@@${_pkgrepository_fragment}
	@@fullpkgname=${FULLPKGNAME${_s}}; \
	pkg_cookie=${_PACKAGE_COOKIE${_s}}; \
	tried=_TRIED_FETCHING_${_PACKAGE_COOKIE${_s}}; \
	${_fetch_packages_fragment}
d1341 17
a1357 8
.    if ${BIN_PACKAGES:L} == "yes"
${_PACKAGE_COOKIE${_s}}:
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
.    else
${_PACKAGE_COOKIE${_s}}: ${_PACKAGE_COOKIE_DEPS}
.    endif
	@@${_pkgrepository_fragment}
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' PACKAGING='${_s}' exec ${MAKE} _package
d1359 1
a1359 1
.endfor
d1495 1
a1495 1
				cd ${PKGREPOSITORY} && PKG_DBDIR=${DEPDIR}/pkgdb PKG_PATH=${PKGREPOSITORY}/ pkg_add -F nonroot -Q ${DEPDIR} $$pkg && exit 0;; \
d1557 1
a1557 1
_internal-update _internal-newlib-depends-check _internal-plist \
d1559 2
a1560 1
_internal-package _internal-lib-depends-check _internal-manpages-check:
d1572 2
a1573 1
_internal-lib-depends-check _internal-newlib-depends-check: ${_PACKAGE_COOKIES}
d1575 1
a1575 1
		${_NEWLIB_DEPENDS_FLAGS} -d ${PKGREPOSITORY} ${_PACKAGE_COOKIES}
a1681 1
_internal-package: ${_PACKAGE_DEPS}
a1683 1

d1721 1
a1721 1
	PKGREPOSITORY=${PKGREPOSITORY} \
d1750 2
a1751 1
_TOP_TARGETS=extract patch distpatch configure build all install fake package \
d1753 5
a1757 4
regress-depends clean lib-depends-check newlib-depends-check manpages-check \
plist update-plist update
.if defined(_LOCK)
.  for _t in ${_TOP_TARGETS}
d1760 1
a1760 3
.  endfor
.else
.    for _t in ${_TOP_TARGETS}
d1762 13
a1774 2
.  endfor
.endif
d2065 1
a2065 1
	@@${ECHO_MSG} "===>  Installing ${FULLPKGNAME${SUBPACKAGE}} from ${PKGFILE${SUBPACKAGE}}"
d2075 1
a2075 1
		${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}/ PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} ${PKGFILE${SUBPACKAGE}}; \
d2078 1
a2078 1
	@@${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}/ PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} ${PKGFILE${SUBPACKAGE}}
d2094 1
a2094 1
		   ${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}/ PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} -r ${_PKG_ADD_FORCE} ${PKGFILE${SUBPACKAGE}};; \
d2103 1
a2103 1
_register_plist=perl ${PORTSDIR}/infrastructure/package/register-plist ${PLIST_DB} ${PKGFILE${SUBPACKAGE}}
d2107 1
a2107 1
	@@${PKG_CMD} -q ${PKG_ARGS} ${PKGFILE${SUBPACKAGE}}
d2110 3
a2112 1
	@@${PKG_CMD} -q -Q ${PKG_ARGS} ${PKGFILE${SUBPACKAGE}}
a2113 25
_package: ${_PKG_PREREQ}
.if target(pre-package)
	@@cd ${.CURDIR} && exec ${MAKE} pre-package
.endif
.if target(do-package)
	@@cd ${.CURDIR} && exec ${MAKE} do-package
.else
# What PACKAGE normally does:
	@@${ECHO_MSG} "===>  Building package for ${FULLPKGNAME${SUBPACKAGE}}"
	@@cd ${.CURDIR} && \
      deps=`${MAKE} _print-package-args` && \
	  if ${SUDO} ${PKG_CMD} `echo "$$deps"|sort -u` ${PKG_ARGS} ${PKGFILE${SUBPACKAGE}}; then \
	    mode=`id -u`:`id -g`; ${SUDO} ${CHOWN} $${mode} ${PKGFILE${SUBPACKAGE}}; \
		if ${_register_plist}; then \
			${MAKE} _package-links; \
			exit 0; \
		fi; \
	  fi && \
	  ${SUDO} ${MAKE} _internal-clean=package && \
	  exit 1
# End of PACKAGE.
.endif
.if target(post-package)
	@@cd ${.CURDIR} && exec ${MAKE} post-package
.endif
d2157 7
a2163 19
# Some support rules for do-package

_package-links:
	@@cd ${.CURDIR} && exec ${MAKE} _delete-package-links
.for _l in FTP CDROM
.  if ${PERMIT_PACKAGE_${_l}:L} == "yes"
	@@echo "Link to ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}"
	@@mkdir -p ${${_l}_PACKAGES}
	@@rm -f ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
	@@ln ${PKGFILE${SUBPACKAGE}} \
	  ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX} 2>/dev/null || \
	  cp -p ${PKGFILE${SUBPACKAGE}} \
	  ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
.  endif
.endfor

_delete-package-links:
.for _l in FTP CDROM
	@@rm -f ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
d2212 1
a2212 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' exec ${MAKE} _delete-package-links
d2216 1
a2216 2
	@@cd ${.CURDIR} && exec ${MAKE} _delete-package-links
	rm -f ${PKGFILE${SUBPACKAGE}}
d2309 1
a2309 9
describe:
.if defined(MULTI_PACKAGES) && !defined(PACKAGING)
	@@cd ${.CURDIR} && SUBPACKAGE='${SUBPACKAGE}' PACKAGING='${SUBPACKAGE}' exec ${MAKE} describe
.  if empty(SUBPACKAGE)
.    for _sub in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' PACKAGING='${_sub}' exec ${MAKE} describe
.    endfor
.  endif
.else
d2311 1
a2311 1
.  if ${PREFIX} == ${LOCALBASE}
d2313 1
a2313 1
.  else
d2315 1
a2315 1
.  endif
d2323 2
a2324 2
.  for _d in LIB BUILD RUN
.    if !empty(_${_d}_DEP2)
d2326 1
a2326 1
.    endif
d2328 1
a2328 1
.  endfor
d2337 1
a2337 1
.  if defined(_BAD_LICENSING)
d2339 3
a2342 3
.    if ${PERMIT_PACKAGE_CDROM:L} == "yes"
	@@echo -n "y|"
.    else
d2344 2
a2345 2
.    endif
.    if ${PERMIT_PACKAGE_FTP:L} == "yes"
d2347 1
a2347 1
.    else
d2349 2
a2350 2
.    endif
.    if ${PERMIT_DISTFILES_CDROM:L} == "yes"
d2352 1
a2352 1
.    else
d2354 2
a2355 2
.    endif
.    if ${PERMIT_DISTFILES_FTP:L} == "yes"
d2357 1
a2357 1
.    else
a2358 1
.    endif
d2766 1
a2766 1
dump-vars:
a2771 6
.if defined(MULTI_PACKAGES) && !defined(PACKAGING)
	@@cd ${.CURDIR} && SUBPACKAGE='' PACKAGING='Yes' exec ${MAKE} $@@
.  for _sub in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' PACKAGING='${_sub}' exec ${MAKE} $@@
.  endfor
.endif
d2774 2
a2775 2
	_build-dir-depends _delete-package-links _fetch-makefile _fetch-onefile \
	_package _package-links _print-packagename \
d2792 1
a2792 1
	lib-depends lib-depends-check newlib-depends-check lib-depends-list \
d2821 3
a2823 1
	show-required-by peek-ftp
@


1.763
log
@let fake not touch the WRKDIR, since it's an `install' type target.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.762 2006/08/07 08:47:28 espie Exp $
d1231 1
d1246 3
d1250 9
a1258 9
	: $${lock:=${_LOCKNAME}}; \
	case X$$lock in \
	X${_MASTER_LOCK}) \
		;; \
	*) \
		${_LOCK}; trap '${_UNLOCK}' 0 1 2 3 13 15;; \
	esac
.else
_DO_LOCK=:
d1260 2
a1442 1
		toset="$$toset _MASTER_LOCK=${_LOCKNAME}"; \
d2129 1
a2129 1
	@@lock=${_F:T}.dist; ${_DO_LOCK}; mkdir -p ${_F:H}; \
d2185 1
a2185 1
		eval $$toset ${MAKE} _CLEANDEPENDS=No clean _MASTER_LOCK=${_LOCKNAME}; \
@


1.762
log
@remove special meaning of fake in dependencies so that it can be used
correctly for regress depends targets.

problem pointed out by nikolay.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.761 2006/08/04 23:29:47 espie Exp $
d1440 1
a1440 1
		Xpackage) early_exit=true;; \
@


1.761
log
@add missing quote, fix WANTLIB fuck-up
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.760 2006/08/01 10:50:19 espie Exp $
d1095 1
a1095 1
_lib_depends_target=fake
d1103 1
a1103 1
_build_depends_target=fake
d1441 1
a1441 1
		Xfake) early_exit=true; dep="/fake";; \
@


1.760
log
@convert a few libspecs to new style.

Note: no package bump, those are only BUILD dependencies,
the pkg_create code will create the correct wantlib specs.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.759 2006/08/01 10:00:54 espie Exp $
d2554 1
a2554 1
	@@d=${_i}; listlibs='echo $$shdir/lib*'; \
@


1.759
log
@allows >= for lib-specs, needs some quoting for shell...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.758 2006/07/17 16:23:14 steven Exp $
d342 1
a342 1
LIB_DEPENDS+=		Xm.1::x11/lesstif
d344 1
a344 1
LIB_DEPENDS+=		Xm.2::x11/openmotif
d351 1
a351 1
LIB_DEPENDS+=		Xm.1::x11/lesstif
d353 1
a353 1
LIB_DEPENDS+=		Xm.2::x11/openmotif
@


1.758
log
@remove MASTER_SITE_LOCAL which is no longer used.

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.757 2006/07/13 14:43:25 steven Exp $
d1516 1
a1516 1
	for d in ${_DEPLIBS}; do \
d1524 1
a1524 1
		${PORTSDIR}/infrastructure/build/resolve-lib ${_noshared} ${_DEPLIBS}`; then \
d2602 1
a2602 1
	@@echo $$LIST_LIBS| LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} perl ${PORTSDIR}/infrastructure/build/resolve-lib ${_DEPLIBS}
@


1.757
log
@peek only in real ftp sites.

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.756 2006/07/11 06:34:32 espie Exp $
a788 6
# Where to put distfiles that don't have any other master site
# ;;; This is referenced in a few Makefiles -- we'd like to get rid of it
#
MASTER_SITE_LOCAL?= \
	ftp://ftp.netbsd.org/pub/NetBSD/packages/distfiles/LOCAL_PORTS/ \
	ftp://ftp.freebsd.org/pub/FreeBSD/distfiles/LOCAL_PORTS/
@


1.756
log
@move modules reading ways higher, after checking it doesn't affect a bulk
build.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.755 2006/07/10 10:52:08 espie Exp $
d2773 1
a2773 1
	@@for i in ${MASTER_SITES}; do echo "Connecting to $$i"; ${FETCH_CMD} $$i ; break; done
@


1.755
log
@+CONFIGURE_ARGS
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.754 2006/07/10 10:35:50 espie Exp $
a169 4
# MODULES support
# reserved name spaces: for module=NAME, modname*, _modname* variables and
# targets.

d219 6
d228 23
a306 2
CONFIGURE_STYLE?=

a316 6
.if ${CONFIGURE_STYLE:L:Mautomake} || ${CONFIGURE_STYLE:L:Mautoconf} || ${CONFIGURE_STYLE:L:Mautoupdate}
.  if !${CONFIGURE_STYLE:L:Mgnu}
CONFIGURE_STYLE+=gnu
.  endif
.endif

a583 1
INSTALL_TARGET?=	install
a585 15

.for _i in perl gnu imake
.  if ${CONFIGURE_STYLE:L:M${_i}}
MODULES+=${_i}
.  endif
.endfor

.if defined(MODULES)
_MODULES_DONE=
.  include "${PORTSDIR}/infrastructure/mk/modules.port.mk"
.endif

###
### Variable setup that can happen after modules
###
@


1.754
log
@add AUTOCONF/AUTOMAKE_VERSION
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.753 2006/07/09 11:23:50 espie Exp $
d89 1
a89 1
AUTOCONF_VERSION AUTOMAKE_VERSION
@


1.753
log
@also dump SUPDISTFILES
do not store empty values which are always defined, but can be empty.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.752 2006/07/09 11:10:16 espie Exp $
d88 2
a89 1
MAINTAINER SUBPACKAGE PACKAGING DESCR SUPDISTFILES
@


1.752
log
@introspection mechanism: dump-vars
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.751 2006/07/08 09:20:30 espie Exp $
d88 1
a88 1
MAINTAINER SUBPACKAGE PACKAGING DESCR
@


1.751
log
@move REPORT_PROBLEM to pkgpath.mk so that we can use it from bsd.port.mk
as well.

Add the target to the default problem reporter.
Report problems while building dependencies.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.750 2006/07/01 11:08:05 espie Exp $
d76 13
d173 3
a175 1
.if defined(show)
a176 5

show:
.  for _s in ${show}
	@@echo ${${_s}:Q}
.  endfor
d2776 25
d2834 1
a2834 1
	run-depends-list run-dir-depends show \
@


1.750
log
@convenience target for porters: peek-ftp connects to the first MASTER_SITES
and leaves you at the ftp prompt in the directory where stuff is fetched
from.

(I find myself using this quite often to figure out which version of stuff
exists, especially for CPAN).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.749 2006/06/18 10:10:04 sturm Exp $
d1465 1
@


1.749
log
@protect patch targets with systrace as well

no objection from espie, looks good steven
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.747 2006/06/04 14:56:10 espie Exp $
d2759 3
d2813 1
a2813 1
	show-required-by
@


1.748
log
@substitute variables in a port's systrace.filter file as well
@
text
@d636 1
a636 1
	${DEPBASE}/bin/gmake
d1789 1
a1789 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-patch
d1803 10
a1812 3
.if target(do-distpatch)
	@@cd ${.CURDIR} && exec ${MAKE} do-distpatch
.else
a1828 6
.if target(post-distpatch)
	@@cd ${.CURDIR} && exec ${MAKE} post-distpatch
.endif
.if ${PATCH_CHECK_ONLY:L} != "yes"
	@@${_MAKE_COOKIE} $@@
.endif
d1838 1
a1838 1
	@@cd ${.CURDIR} && exec ${MAKE} do-patch
d1858 1
a1858 1
						${PATCH} ${PATCH_ARGS} < $$i || \
d1875 1
a1875 1
	@@cd ${.CURDIR} && exec ${MAKE} post-patch
@


1.747
log
@fed up of merge errors in dependency makefiles, output a decent error
message if cd dir && make print-pkgname does not work.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.746 2006/03/24 19:28:13 espie Exp $
d1345 1
a1345 1
		cat ${.CURDIR}/systrace.filter >> $@@; \
@


1.746
log
@fix size test finally (|| > |)

check that MULTI_PACKAGES do begin with -.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.745 2006/02/06 22:01:48 steven Exp $
d1442 8
a1449 2
		case "X$$pkg" in X) pkg=`eval $$toset ${MAKE} _print-packagename`; \
			defaulted=true;; esac; \
d1464 1
@


1.745
log
@fix typo in target name.

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.744 2006/02/06 17:09:08 jolan Exp $
d340 3
d2127 1
a2127 1
						test `wc -c "$$file" 2>/dev/null || echo 0 | awk '{print $$1}'` -lt 30000 && rm -f $$file; \
@


1.744
log
@pass -o to unzip so it doesn't prompt when overwriting a file

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.743 2006/01/05 19:33:17 espie Exp $
d2790 1
a2790 1
	_internal-package _internal_fetch _internal-checksum \
@


1.743
log
@prepare to pass stuff over to libtool.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.742 2005/12/29 12:48:04 espie Exp $
d887 1
a887 1
EXTRACT_CASES+= *.zip) ${UNZIP} -q ${FULLDISTDIR}/$$archive -d ${WRKDIR};;
@


1.742
log
@set LIBname_LTVERSION=-version-info <major>:<minor>:0
in MAKE_ENV/MAKE_FLAGS/FAKE_FLAGS if USE_LIBTOOL=Yes.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.741 2005/12/23 12:41:37 espie Exp $
d645 1
@


1.741
log
@basic framework to have control over shared libs numbers:
SHARED_LIBS enumerates the libraries like so:
SHARED_LIBS=	foo 1.0 \
		zop 2.5 \
		tag 3.0

This just defines LIBfoo_VERSION=1.0, LIBzop_VERSION=2.5, LIBtag_VERSION=3.0
and adds these to SUBST_VAR, further tweaks must be done, usually at the
MAKE_FLAGS/MAKE_ENV level.

For gnu ports that use automake, the supplementary MODGNU_SHARED_LIBS
variable can be used like this:
MODGNU_SHARED_LIBS=	foo	'-no-undefined'

and it will define libfoo_la_LD_FLAGS=--version-info 1:0:0 -no-undefined

Some gnu ports have weird variable names for libraries. For instance,
the libORBit-2 is set using libORBit_2.
LIBORbit-2_ALIAS=ORBit_2
will make sure the correct name is used.

much feedback from bernd@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.740 2005/11/27 12:31:18 espie Exp $
d290 1
d294 4
a297 4
CONFIGURE_ENV+=		LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}"
MAKE_ENV+=			LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}"
MAKE_FLAGS+=		LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}"
FAKE_FLAGS+=		LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}"
d644 1
@


1.740
log
@move comment accordingly
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.739 2005/11/27 12:15:59 sturm Exp $
d636 7
@


1.739
log
@don't duplicate code, use _fetch_packages_fragment and
_pkgrepository_fragment instead
copy packages in local components of PKG_PATH to ${PKGREPOSITORY}

feedback and ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.738 2005/11/15 18:14:56 espie Exp $
a1253 4
###
### end of variable setup. Only targets now
###

d1279 4
@


1.738
log
@now that pkg_add does the right thing when confronted with stuff that's
already installed, use it directly for updates.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.737 2005/11/11 11:31:53 espie Exp $
d1258 3
a1260 4
.if ${FETCH_PACKAGES:L} == "yes" && !defined(_TRIED_FETCHING_${_PACKAGE_COOKIE})
${_PACKAGE_COOKIE}:
	@@${ECHO_MSG} -n "===>  Looking for ${FULLPKGNAME} in \$$PKG_PATH - "
	@@if ${SETENV} PKG_CACHE=${PKGREPOSITORY} PKG_PATH=${PKGREPOSITORY}/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n -q ${_PKG_ADD_FORCE} ${FULLPKGNAME} >/dev/null 2>&1; then \
d1262 9
d1274 17
a1290 1
	cd ${.CURDIR} && exec ${MAKE} _TRIED_FETCHING_${_PACKAGE_COOKIE}=Yes ${_PACKAGE_COOKIE}
d1298 1
d1306 1
a1306 1
.  if ${FETCH_PACKAGES:L} == "yes" && !defined(_TRIED_FETCHING_${_PACKAGE_COOKIE_${_s}})
d1308 5
a1312 7
	@@${ECHO_MSG} -n "===>  Looking for ${FULLPKGNAME${_s}} in \$$PKG_PATH - "
	@@if ${SETENV} PKG_CACHE=${PKGREPOSITORY} PKG_PATH=${PKGREPOSITORY}/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n -q ${_PKG_ADD_FORCE} ${FULLPKGNAME${_s}} >/dev/null 2>&1; then \
		${ECHO_MSG} "found"; \
		exit 0; \
	fi; \
	${ECHO_MSG} "not found"; \
	cd ${.CURDIR} && exec ${MAKE} _TRIED_FETCHING_${_PACKAGE_COOKIE_${_s}}=Yes ${_PACKAGE_COOKIE${_s}}
d1320 1
a2065 6
	@@if [ ! -d ${PKGREPOSITORY} ]; then \
	   if ! mkdir -p ${PKGREPOSITORY}; then \
	      echo ">> Can't create directory ${PKGREPOSITORY}."; \
		  exit 1; \
	   fi; \
	fi
@


1.737
log
@tweak the depends clean recursion, so that it does not recurse into
the main directory... since pseudo-flavors are not entered as pkgpath,
this is necessary to ensure the top-level directory gets cleaned up
correctly...

Problem reported by Moritz Grimm.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.736 2005/11/05 23:54:53 espie Exp $
a2010 8
.if ${FORCE_UPDATE:L} == "yes"
	@@a=`pkg_info -e ${FULLPKGPATH} 2>/dev/null || true`; \
	case $$a in \
		'') ${ECHO_MSG} "Not installed, no update";; \
		*) ${ECHO_MSG} "Upgrading from $$a"; \
		   ${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}/ PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} ${_PKG_ADD_FORCE} ${PKGFILE${SUBPACKAGE}};; \
	esac
.else
a2013 1
		'${FULLPKGNAME${SUBPACKAGE}}') ${ECHO_MSG} "Already installed, no update";; \
d2015 1
a2015 1
		   ${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}/ PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKG_ADD_AUTO} -r ${PKGFILE${SUBPACKAGE}};; \
a2016 1
.endif
@


1.736
log
@zap old test that's no longer needed since 2001.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.735 2005/11/05 23:41:36 espie Exp $
d2142 1
a2142 1
	@@PACKAGING='${SUBPACKAGE}' ${MAKE} all-dir-depends|tsort -r|while read subdir; do \
d2146 1
a2146 1
.else
d2148 1
a2148 1
.  if ${_clean:L:Mfake}
d2150 3
a2152 3
.  endif
.  if ${_clean:L:Mwork}
.    if ${_clean:L:Mflavors}
d2157 1
a2157 1
.    else
a2159 1
.    endif
d2161 2
a2162 1
.  if ${_clean:L:Mdist}
d2167 1
a2167 1
.    if !empty(DIST_SUBDIR)
a2168 1
.    endif
d2170 4
a2173 3
.  if ${_clean:L:Minstall}
.    if ${_clean:L:Msub}
.      for _s in ${MULTI_PACKAGES}
d2175 2
a2176 2
.      endfor
.    else
a2177 1
.    endif
d2179 2
a2180 1
.  if ${_clean:L:Mpackages} || ${_clean:L:Mpackage} && ${_clean:L:Msub}
d2182 2
a2183 2
.    if defined(MULTI_PACKAGES)
.      for _s in ${MULTI_PACKAGES}
d2185 3
a2187 3
.      endfor
.    endif
.  elif ${_clean:L:Mpackage}
d2190 2
a2191 2
.  endif
.  if ${_clean:L:Mreadmes}
d2193 1
a2193 1
.      for _s in ${MULTI_PACKAGES}
d2195 3
a2197 3
.      endfor
.  endif
.  if ${_clean:L:Mbulk}
a2198 1
.  endif
@


1.735
log
@touch -f ? what's that ?
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.734 2005/11/05 23:39:51 espie Exp $
d2165 1
a2165 3
		if [ "${_DISTFILES}" -o "${_PATCHFILES}" ]; then \
			rm -f ${_DISTFILES} ${_PATCHFILES}; \
		fi \
@


1.734
log
@comment to /targets
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.733 2005/11/05 11:16:17 espie Exp $
d448 1
a448 1
_MAKE_COOKIE=touch -f
@


1.733
log
@better naming, discussed with nikolay
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.732 2005/11/05 11:11:17 espie Exp $
d2424 1
d2451 1
@


1.732
log
@introduce new  macros to make things more readable.

Kill really old stuff: LD_CONFIG,
that's no longer used.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.731 2005/11/05 10:35:02 sturm Exp $
d643 1
a643 1
_PKGADD_AUTO?=
d645 1
a645 1
_PKGADD_AUTO+=-a
d1094 1
a1094 1
_PKGADD_FORCE=-F update -F updatedepends -F installed -r
d1097 1
d1261 1
a1261 1
	@@if ${SETENV} PKG_CACHE=${PKGREPOSITORY} PKG_PATH=${PKGREPOSITORY}/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n -q ${_PKGADD_FORCE} ${FULLPKGNAME} >/dev/null 2>&1; then \
d1284 1
a1284 1
	@@if ${SETENV} PKG_CACHE=${PKGREPOSITORY} PKG_PATH=${PKGREPOSITORY}/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n -q ${_PKGADD_FORCE} ${FULLPKGNAME${_s}} >/dev/null 2>&1; then \
d1996 1
a1996 1
		${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}/ PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKGADD_AUTO} ${PKGFILE${SUBPACKAGE}}; \
d1999 1
a1999 1
	@@${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}/ PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKGADD_AUTO} ${PKGFILE${SUBPACKAGE}}
d2016 1
a2016 1
		   ${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}/ PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKGADD_AUTO} ${_PKGADD_FORCE} ${PKGFILE${SUBPACKAGE}};; \
d2024 1
a2024 1
		   ${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}/ PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKGADD_AUTO} -r ${PKGFILE${SUBPACKAGE}};; \
@


1.731
log
@better tests when looking for packages in $PKG_PATH
use ${ECHO_MSG} where applicable

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.730 2005/11/04 09:40:30 espie Exp $
a743 2
LDCONFIG?=	[ ! -x /sbin/ldconfig ] || /sbin/ldconfig
LDCONFIG_SED_SCRIPT?=${PORTSDIR}/infrastructure/install/ldconfig-new.sed
d1062 1
a1062 1
		pkg=`echo $$pkg|sed -e 's,-[0-9].*,-*,'`; \
d1238 15
d2412 1
a2412 1
	@@${MAKE} full-build-depends|tr '\012' '\040'|sed -e 's, $$,,'
d2419 1
a2419 1
	@@${MAKE} full-run-depends|tr '\012' '\040'|sed -e 's, $$,,'
d2425 1
a2425 1
	@@${MAKE} ${_i}-dir-depends|tsort -r|sed -e '$$d'|while read subdir; do \
d2433 1
a2433 1
	@@${MAKE} all-dir-depends|tsort -r|sed -e '$$d'|while read subdir; do \
d2486 1
a2486 1
		case "X$$pkg" in X) pkg=`echo $$default|sed -e 's,-[0-9].*,-*,'`;; esac; \
d2497 1
a2497 1
		case "X$$pkg" in X) pkg=`echo $$default|sed -e 's,-[0-9].*,-*,'`;; esac; \
d2501 1
a2501 1
		    listlibs="$$toset ${MAKE} print-plist-contents|grep -e '^@@lib ' -e '^@@file .*/lib/lib.*\.a'|sed -e 's:@@lib ::' -e 's:@@file ::'"; \
d2544 1
a2544 2
				grep -e '^@@lib ' -e '^@@file .*/lib/lib.*\.a$$'| \
				sed -e 's:@@lib ::' -e 's:@@file ::' |tee $$fulldir; \
d2548 1
a2548 1
	@@${MAKE} run-dir-depends|tsort -r|sed -e '$$d'|while read subdir; do \
d2551 1
a2551 2
	done | grep -e '^@@lib ' -e '^@@file .*/lib/.*\.a$$'| \
	sed -e 's:@@lib ::' -e 's:@@file ::'
@


1.730
log
@zap unneeded FLAVOR=

prompted by a question from sturm@@
`why do we need to set this ?'

answer: we don't. ;)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.729 2005/11/04 09:34:50 sturm Exp $
d1096 1
d1246 3
a1248 3
	@@echo -n "===>  Looking for ${FULLPKGNAME} in \$$PKG_PATH - "
	@@if ${SETENV} PKG_CACHE=${PKGREPOSITORY} PKG_PATH=${PKGREPOSITORY}/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n ${FULLPKGNAME} >/dev/null 2>&1; then \
		echo "found"; \
d1251 1
a1251 1
	echo "not found"; \
d1269 3
a1271 3
	@@echo -n "===>  Looking for ${FULLPKGNAME${_s}} in \$$PKG_PATH - "
	@@if ${SETENV} PKG_CACHE=${PKGREPOSITORY} PKG_PATH=${PKGREPOSITORY}/:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add -n ${FULLPKGNAME${_s}} >/dev/null 2>&1; then \
		echo "found"; \
d1274 1
a1274 1
	echo "not found"; \
d2002 1
a2002 1
		   ${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}/ PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKGADD_AUTO} -F update -F updatedepends -F installed -r ${PKGFILE${SUBPACKAGE}};; \
@


1.729
log
@try fetching missing packages from PKG_PATH, activated by setting
FETCH_PACKAGES

set PKG_PATH consistently when calling pkg_add

idea, help and ok espie
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.728 2005/11/03 22:33:04 david Exp $
d1282 1
a1282 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' FLAVOR='${FLAVOR}' PACKAGING='${_s}' exec ${MAKE} _package
d2272 1
a2272 1
	@@cd ${.CURDIR} && SUBPACKAGE='${SUBPACKAGE}' FLAVOR='${FLAVOR}' PACKAGING='${SUBPACKAGE}' exec ${MAKE} describe
d2275 1
a2275 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' PACKAGING='${_sub}' exec ${MAKE} describe
d2334 1
a2334 1
	@@cd ${.CURDIR} && SUBPACKAGE='${SUBPACKAGE}' FLAVOR='${FLAVOR}' PACKAGING='${SUBPACKAGE}' exec ${MAKE} readmes
d2337 1
a2337 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' PACKAGING='${_sub}' exec ${MAKE} readmes
@


1.728
log
@check the correct exit code which fetching non-existent files; ok bernd@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.727 2005/11/03 19:32:25 espie Exp $
d66 1
d1243 11
a1253 1
.if ${BIN_PACKAGES:L} == "yes"
d1256 1
a1256 1
.else
d1258 3
a1260 3
.endif
	@@cd ${.CURDIR} && SUBPACKAGE='' FLAVOR='${FLAVOR}' PACKAGING='' exec ${MAKE} _package
.if !defined(PACKAGE_NOINSTALL)
d1262 1
d1266 11
a1276 1
.  if ${BIN_PACKAGES:L} == "yes"
d1279 1
a1279 1
.  else
d1281 2
a1283 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' FLAVOR='${FLAVOR}' PACKAGING='${_s}' exec ${MAKE} _package
d1413 1
a1413 1
				cd ${PKGREPOSITORY} && PKG_DBDIR=${DEPDIR}/pkgdb pkg_add -F nonroot -Q ${DEPDIR} $$pkg && exit 0;; \
d1981 1
a1981 1
		${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKGADD_AUTO} ${PKGFILE${SUBPACKAGE}}; \
d1984 1
a1984 1
	@@${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKGADD_AUTO} ${PKGFILE${SUBPACKAGE}}
d2001 1
a2001 1
		   ${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKGADD_AUTO} -F update -F updatedepends -F installed -r ${PKGFILE${SUBPACKAGE}};; \
d2009 1
a2009 1
		   ${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKGADD_AUTO} -r ${PKGFILE${SUBPACKAGE}};; \
@


1.727
log
@alek@@-friendly error messages.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.726 2005/11/03 17:23:30 espie Exp $
d2068 1
a2068 1
						test `wc -c "$$file" 2>/dev/null|awk '{print $$1}' || echo 0` -lt 30000 && rm -f $$file; \
@


1.726
log
@duh. found by naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.725 2005/11/02 20:30:12 espie Exp $
d1353 1
@


1.725
log
@streamline flavor_fragment after trying to explain it to sturm@@.
it makes more sense to have a subdir variable as input, split it
into toset and dir as output, and to unsetenv FLAVOR SUBPACKAGE along
the lines.

End result should be equivalent, but slightly more readable.

no objection from my neighbors either...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.724 2005/11/02 20:28:11 espie Exp $
d1187 1
a1187 1
_DEPlibs_COOKIE=${WRKDIR}/.wantlibs
@


1.724
log
@* move the dependency computation out of PKG_ARGS, so that we can check
for errors (and get rid of _NODEPS since it's not needed any more)
* set check  to Failed in *libresolve_fragment, so that we can test
for it and report properly.

guys here have no objection...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.723 2005/11/01 20:39:00 espie Exp $
d1350 1
a1350 1
	@@unset PACKAGING DEPENDS_TARGET FLAVOR SUBPACKAGE _MASTER WRKDIR|| true; \
d1352 1
a1352 1
		IFS=:; read dep pkg dir target; \
d2103 1
a2103 2
	@@PACKAGING='${SUBPACKAGE}' ${MAKE} all-dir-depends|tsort -r|while read dir; do \
		unset FLAVOR SUBPACKAGE || true; \
d2387 1
a2387 2
	@@${MAKE} ${_i}-dir-depends|tsort -r|sed -e '$$d'|while read dir; do \
		unset FLAVOR SUBPACKAGE || true; \
d2395 1
a2395 2
	@@${MAKE} all-dir-depends|tsort -r|sed -e '$$d'|while read dir; do \
		unset FLAVOR SUBPACKAGE || true; \
d2444 3
a2446 4
	@@unset FLAVOR SUBPACKAGE || true; \
	echo '${_i}' |{ \
		IFS=:; read dep pkg pkgpath target; \
		dir=$$pkgpath; ${_flavor_fragment}; \
d2449 1
a2449 1
		echo "-P $$pkgpath:$$pkg:$$default"; \
d2454 3
a2456 4
	@@unset FLAVOR SUBPACKAGE || true; \
	echo '${_i}'|{ \
		IFS=:; read dep pkg pkgpath target; \
		dir=$$pkgpath; ${_flavor_fragment}; \
d2476 1
a2476 1
		echo "-P $$pkgpath:$$pkg:$$default"; \
d2498 2
a2499 2
	@@perl ${PORTSDIR}/infrastructure/build/extract-dependencies ${FULLPKGPATH} <${_DEPENDS_CACHE}|while read dir; do \
		fulldir=${_PORT_LIBS_CACHE}/$$dir; \
a2503 1
			unset FLAVOR SUBPACKAGE || true; \
d2511 1
a2511 2
	@@${MAKE} run-dir-depends|tsort -r|sed -e '$$d'|while read dir; do \
		unset FLAVOR SUBPACKAGE || true; \
d2521 3
a2523 4
	@@unset FLAVOR SUBPACKAGE || true; \
	echo '${_i}' |{ \
		IFS=:; read dep pkg pkgpath target; \
		dir=$$pkgpath; ${_flavor_fragment}; \
d2532 3
a2534 4
	@@unset FLAVOR SUBPACKAGE || true; \
	echo '${_i}' |{ \
		IFS=:; read dep pkg pkgpath target; \
		dir=$$pkgpath; ${_flavor_fragment}; \
d2543 1
a2543 2
	@@unset FLAVOR SUBPACKAGE || true; \
	echo "$$self ${_dir}"; \
d2546 1
a2546 2
		dir=${_dir}; \
		${_flavor_fragment}; \
d2570 1
a2570 2
	@@unset FLAVOR SUBPACKAGE || true; \
	echo "$$self ${_dir}"; \
d2573 1
a2573 2
		dir=${_dir}; \
		${_flavor_fragment}; \
d2585 1
a2585 2
	@@unset FLAVOR SUBPACKAGE || true; \
	echo "$$self ${_dir}"; \
d2588 1
a2588 2
		dir=${_dir}; \
		${_flavor_fragment}; \
@


1.723
log
@fix weird  recursion lock issue... the way the rest of the file deals with
them.

`looks much cleaner to me and this one I understand' sturm@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.722 2005/11/01 14:15:01 espie Exp $
a703 1
_NODEPS?=no
a707 3
.if ${_NODEPS:L} == "no"
PKG_ARGS+=`${MAKE} _print-package-args|sort -u`
.endif
d1049 1
a1049 1
			|| true
d1059 1
a1059 1
			|| true
d2020 2
a2021 1
	  if ${SUDO} ${PKG_CMD} ${PKG_ARGS} ${PKGFILE${SUBPACKAGE}}; then \
d2468 1
a2468 1
		    listlibs="$$toset _NODEPS=Yes ${MAKE} print-plist-contents|grep -e '^@@lib ' -e '^@@file .*/lib/lib.*\.a'|sed -e 's:@@lib ::' -e 's:@@file ::'"; \
d2474 1
a2474 1
			Missing\ library|Error:*) \
d2489 1
a2489 1
	Missing\ library|Error:*) \
d2511 1
a2511 1
			eval $$toset _NODEPS=Yes ${MAKE} print-plist-contents | \
d2520 1
a2520 1
		eval $$toset _NODEPS=Yes ${MAKE} print-plist-contents ; \
@


1.722
log
@set PACKAGING before computing RUN and LIB_DEPENDS, so that the needed
packages are built JIT.

noticed by sturm@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.721 2005/11/01 14:04:21 espie Exp $
d2106 1
a2106 2
	@@${MAKE} all-dir-depends|tsort -r|while read dir; do \
		case "$$dir" in ${FULLPKGPATH}) t=_internal-clean;; *) t=clean;; esac; \
d2109 1
a2109 1
		eval $$toset ${MAKE} _CLEANDEPENDS=No $$t; \
@


1.721
log
@new target, show-required-by, that can give you a full list of everything
a port will affect.

name by mbalmer@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.719 2005/10/10 19:20:00 espie Exp $
d1950 1
a1950 1
	@@cd ${.CURDIR} && DEPENDS_TARGET=install exec ${MAKE} _internal-run-depends _internal-lib-depends
@


1.720
log
@add comment so that we can grep for _internal-XXX-depends targets.
@
text
@a1349 2
# _internal-build-depends, _internal-run-depends,
# _internal-lib-depends, _internal-regress-depends
d2713 3
d2763 2
a2764 1
	_list-port-libs _print-package-signature-lib _print-package-signature-run
@


1.719
log
@don't bother building default package, just ask print-plist-contents
for its contents.

avoid dirname in print-package-signature, use sh built-ins.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.718 2005/10/10 16:07:33 bernd Exp $
d1350 2
@


1.718
log
@output cosmetics

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.717 2005/10/10 00:29:38 espie Exp $
d2472 1
a2472 2
			eval 1>&2 $$toset ${MAKE} ${PKGREPOSITORY}/$$default.tgz; \
			listlibs='pkg_info -L -K ${PKGREPOSITORY}/$$default.tgz|grep -e "^@@lib $$shdir/lib" -e "^$$shdir/lib.*.a"|sed -e "s:@@lib "'; \
d2508 3
a2510 3
		fulldir=$$dir; \
		if test -f ${_PORT_LIBS_CACHE}/$$fulldir; then \
			cat ${_PORT_LIBS_CACHE}/$$fulldir; \
d2512 1
a2512 1
			mkdir -p `dirname ${_PORT_LIBS_CACHE}/$$fulldir`; \
d2516 2
a2517 2
				grep -e '^@@lib ' -e '^@@file .*/lib/.*\.a$$'| \
				sed -e 's:@@lib ::' -e 's:@@file ::' |tee ${_PORT_LIBS_CACHE}/$$fulldir; \
@


1.717
log
@need an extra indirection: the complete wantlib cookie can easily grow
over 256 characters, so we create an extra file for each wantlib, and
depend on it. That way the full _DEPlibs_COOKIE is regenerated (and retested)
each time WANTLIB changes.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.716 2005/10/09 23:22:41 espie Exp $
d1428 1
a1428 1
	@@${ECHO_MSG} "===> Verifying specs: ${_DEPLIBS}"
d1439 1
a1439 1
		line="===> found"; \
@


1.716
log
@remove intervening comma, so that stuff works.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.715 2005/10/09 13:31:50 espie Exp $
d445 1
a445 1
${_DEPlibs_COOKIE}
d1184 1
a1184 3
# build a deplibs cookie that changes each time WANTLIB is modified
# we do not need to include LIB_DEPENDS, as DEPlibs_COOKIE depends on
# DEPlibs_COOKIES, and that would make a too long filename for some ports
a1185 1
_DEPlibs_COOKIE=${WRKDIR}/.
d1187 1
a1187 1
_DEPlibs_COOKIE:=${_DEPlibs_COOKIE}$i
d1189 1
d1191 1
a1191 1
_DEPlibs_COOKIE=
d1424 4
a1427 1
${_DEPlibs_COOKIE}: ${_DEPlib_COOKIES} ${_DEPbuild_COOKIES} ${_WRKDIR_COOKIE}
@


1.715
log
@better semantics for library checking: just check the pkgspec for recursive
building, and then do one big check of all specs in LIB_DEPENDS and
wantlib. This should be faster and more accurate.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.714 2005/10/09 12:01:22 espie Exp $
d1190 1
a1190 1
_DEPlibs_COOKIE:=${_DEPlibs_COOKIE},$i
@


1.714
log
@tweak the way library dependencies are resolved to speed them up.
Now, resolve-lib can take a big list of libraries with full paths,
and it can solve a big list of spec at once.
Basically, we move most of the parsing of spec paths into resolve-lib.

Since print-package-signature does build a full list of libs, let's solve
it all at once, instead of invoking a costly perl script repeatedly.

Add some caching possibilities for out-of-date. Specifically:
- store libraries for each package under the directory _PORT_LIBS_CACHE
- use the dependency cache _DEPENDS_FILE to avoid recreating dependency
chains, add a new file _DEPENDS_CACHE that will accumulate all dependencies,
and extract these with a simple script extract-dependencies.

Use echo to build libraries lists instead of ls, that's a bit simpler...

Some more clean-up will happen: it's probably simpler to parse libspecs
at once, extract the libraries needed and go fetch the corresponding libraries
just once.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.712 2005/09/25 09:43:09 espie Exp $
d444 2
a445 1
${_DEPrun_COOKIES} ${_DEPregress_COOKIES} ${_UPDATE_COOKIE}
d1069 2
a1070 11
	found2=false; \
	what="$$dep ($$pkg)"; \
	IFS=,; bad=false; for d in $$dep; do \
		listlibs='echo $$shdir/lib*'; \
		${_libresolve_fragment}; \
		case "$$check" in \
		Missing\ library) bad=true; msg="$$msg $$d missing...";; \
		Error:*) bad=true; msg="$$msg $$d unsolvable...";; \
		esac; \
	done; $$bad || found2=true; \
	if pkg_info -q -e "$$pkg" && $$found2; then \
d1184 12
d1341 1
a1341 1
	_internal-run-depends _internal-regress-depends
d1425 25
d1567 1
a1567 1
_internal-patch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
d1569 1
a1569 1
_internal-distpatch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
d1571 1
a1571 1
_internal-configure: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
d1574 1
a1574 1
	${_BUILD_COOKIE}
d1680 1
a1680 1
	@@cd ${.CURDIR} && exec ${MAKE} _internal-checksum _internal-build-depends _internal-lib-depends
d2753 2
a2754 1
	_internal-depends _internal-lib-depends _internal-build-depends \
@


1.713
log
@overeager code cloning.
noticed by matthieu@@/mbalmer@@
@
text
@d1047 2
a1048 3
		*/*) shprefix="$${d%/*}/"; shdir="${LOCALBASE}/$${d%/*}"; \
			d=$${d\#\#*/};; \
		*) shprefix="" shdir="${LOCALBASE}/lib";; \
d1050 1
a1050 1
		check=`eval $$listlibs| perl \
d1056 3
a1058 4
		/*) shdir="$${d%/*}/"; shprefix=""; d=$${d\#\#*/};; \
		*/*) shprefix="$${d%/*}/"; shdir="${DEPBASE}/$${d%/*}"; \
			d=$${d\#\#*/};; \
		*) shprefix="" shdir="${DEPBASE}/lib"; listlibs="$$listlibs; ls /usr/lib /usr/X11R6/lib 2>/dev/null";; \
d1060 1
a1060 1
		check=`eval $$listlibs| perl \
d1071 1
a1071 1
		listlibs='ls $$shdir 2>/dev/null'; \
d1173 1
d1177 5
d2408 6
a2413 1
	@@cd ${.CURDIR} && PACKAGING='${SUBPACKAGE}' LIST_LIBS=`${MAKE} _list-port-libs` ${MAKE} _print-package-signature-helper | \
d2416 1
d2440 1
a2440 1
			listlibs='ls ${DEPDIR}$$shdir 2>/dev/null'; \
d2443 1
a2443 1
			listlibs='pkg_info -L -K ${PKGREPOSITORY}/$$default.tgz|grep "^@@lib $$shdir" |sed -e "s:@@lib $$shdir/::"'; \
d2453 1
a2453 1
				echo "-W $$shprefix$$check";; \
d2460 1
a2460 1
	@@d=${_i}; listlibs='ls $$shdir 2>/dev/null'; \
d2468 1
a2468 1
		echo "-W $$shprefix$$check";; \
d2474 18
d2498 2
d2501 1
a2501 1
_print-package-signature-helper:
a2507 1
		case "X$$pkg" in X) pkg=`echo $$default|sed -e 's,-[0-9].*,-*,'`;; esac; \
d2511 4
a2514 2
.if ${NO_SHARED_LIBS:L} != "yes"
.  for _i in ${LIB_DEPENDS}
d2516 1
a2516 1
	echo '${_i}'|{ \
a2518 1
		libspecs='';comma=''; \
a2519 13
		case "X$$pkg" in X) pkg=`echo $$default|sed -e 's,-[0-9].*,-*,'`;; esac; \
		listlibs='echo $$LIST_LIBS|tr "\040" "\012"|fgrep "$$shdir" |sed -e "s:$$shdir/::"'; \
		IFS=,; for d in $$dep; do \
			${_libresolve_fragment}; \
			case "$$check" in \
			*.a) continue;; \
			Missing\ library|Error:*) \
				echo 1>&2 "Can't resolve libspec $$d"; \
				exit 1;; \
			*) \
				echo "$$shprefix$$check";; \
			esac; \
		done; \
d2522 1
a2522 14
.  endfor
.  for _i in ${WANTLIB}
	@@d=${_i}; listlibs='echo $$LIST_LIBS|tr "\040" "\012"|fgrep "$$shdir" |sed -e "s:$$shdir/::"'; \
	${_syslibresolve_fragment}; \
	case "$$check" in \
	*.a) continue;; \
	Missing\ library|Error:*) \
		echo 1>&2 "Can't resolve libspec $$d"; \
		exit 1;; \
	*) \
		echo "$$shprefix$$check";; \
	esac
.   endfor
.endif
d2730 1
a2730 1
	_list-port-libs _print-package-signature-helper
@


1.712
log
@need to list static libraries as well.
problem reported by bernd@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.711 2005/09/24 19:46:56 espie Exp $
d2453 1
a2453 1
	*.a) continue;; \
@


1.711
log
@tweak _print-package-args a bit.
Add internal NODEPS to turn off computing dependencies.

Write code similar to _print-package-args that is strictly ports based,
and hence really walks the wantlibs, and needs the pkg_create stuff
to get at the real ports contents.

Recode print-package-signature to refer to the ports tree contents
exclusively (pkg_info -S for the package).

Thx bernd@@ for trying that out.

This should make for a slow, but accurate, out-of-date printer.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.710 2005/09/18 12:20:00 espie Exp $
d2468 2
a2469 1
	done | grep '^@@lib '| sed -e 's:@@lib ::'
@


1.710
log
@simplify locks
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.709 2005/09/17 14:47:40 espie Exp $
d703 1
d707 4
a710 1
PKG_ARGS+=-f ${PLIST} -p ${PREFIX} `${MAKE} _print-package-args|sort -u`
d1060 1
a1060 1
		*) shprefix="" shdir="/usr/lib /usr/X11R6/lib ${DEPBASE}/lib";; \
d1968 6
d2404 2
a2405 2
	@@cd ${.CURDIR} && PACKAGING='${SUBPACKAGE}' ${MAKE} _print-package-args | \
		sed -e 's,^-W ,,' -e 's,^-P .*:,,'|sort -u| \
d2433 1
a2433 1
			listlibs='pkg_info -L -K ${PKGREPOSITORY}/$$default.tgz|grep "@@lib $$shdir" |sed -e "s:@@lib $$shdir/::"'; \
d2463 56
d2724 2
a2725 1
	_internal-update update
@


1.709
log
@oops
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.708 2005/09/16 09:51:25 espie Exp $
d1200 1
a1200 1
# nothing happens unless LOCKDIR, LOCK_CMD and UNLOCK_CMD are defined
d1202 3
d1206 1
a1206 1
.if defined(LOCKDIR) && defined(LOCK_CMD) && defined(UNLOCK_CMD)
@


1.708
log
@Fix a buglet in bsd.port.mk where the PSEUDO_FLAVORS get encoded into
the FULLPKGPATH, thus providing changes to packing-lists which shouldn't
happen, and making update more difficult.

Accordingly, bump all pkgnames with PSEUDO_FLAVORS, and provide an
update @@pkgpath for the bug for most of them (left out the ones with 3
or 4 pseudo flavors for space constraints...)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.707 2005/09/10 18:07:47 naddy Exp $
d586 1
a586 1
FULLPKGPATH=${PKGPATH}${_FLAVOR_EXT:S/-/,/g}
d588 1
a588 1
FULLPKGPATH=${PKGPATH},${SUBPACKAGE}${_FLAVOR_EXT:S/-/,/g}
@


1.707
log
@don't hardcode /usr/ports, use PORTSDIR; ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.706 2005/09/05 12:43:07 espie Exp $
d586 1
a586 1
FULLPKGPATH=${PKGPATH}${_FLAVOR_EXT2:S/-/,/g}
d588 1
a588 1
FULLPKGPATH=${PKGPATH},${SUBPACKAGE}${_FLAVOR_EXT2:S/-/,/g}
@


1.706
log
@clean-up register-plist logic, so that package is uniformously deleted
if a problem occurs.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.705 2005/09/04 22:32:37 espie Exp $
d1958 1
a1958 1
_register_plist=perl /usr/ports/infrastructure/package/register-plist ${PLIST_DB} ${PKGFILE${SUBPACKAGE}}
@


1.705
log
@- new read-only variable, PKGNAMES.
- plist repository under PLIST_DB (optional).
- print-package-signatures shows what's used for signatures.
- make fetch shows full url you can copy/paste, simpler to look for typos
that way.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.704 2005/07/04 12:32:51 espie Exp $
d161 1
d1955 6
d1979 7
a1985 8
	    ${MAKE} _package-links; \
	  else \
	    ${SUDO} ${MAKE} _internal-clean=package; \
	    exit 1; \
	  fi
.if !empty(PLIST_DB)
	@@perl /usr/ports/infrastructure/package/register-plist ${PLIST_DB} ${PKGFILE${SUBPACKAGE}}
.endif
@


1.704
log
@distfiles with spaces ? wow...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.703 2005/06/27 12:48:56 espie Exp $
d74 1
d105 1
d581 1
d715 3
d1977 3
d2007 1
a2007 1
		${ECHO_MSG} ">> Attempting to fetch ${_F} from $${site}."; \
d2383 7
d2632 2
a2633 1
	pre-regress print-build-depends print-run-depends \
@


1.703
log
@fix wc shit.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.702 2005/06/25 22:12:09 espie Exp $
d2008 1
a2008 1
						test `wc -c $$file 2>/dev/null|awk '{print $$1}' || echo 0` -lt 30000 && rm -f $$file; \
@


1.702
log
@bigger threshold, some sourceforge mirrors have 20K of html error page.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.701 2005/06/25 22:01:46 espie Exp $
d2008 1
a2008 1
						test  0`wc -c $$file 2>/dev/null` -lt 30000 && rm -f $$file; \
@


1.701
log
@zap small files whose sizes don't match, so the next mirror gets a chance
to go at it.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.700 2005/06/25 10:51:32 espie Exp $
d2008 1
a2008 1
						test  0`wc -c $$file 2>/dev/null` -lt 10000 && rm -f $$file; \
@


1.700
log
@restore library check into working order, ouch...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.699 2005/06/25 10:40:50 espie Exp $
d2008 1
@


1.699
log
@remove -v in pkg_create(1) since pkg_create is going to become
much more verbose.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.698 2005/04/30 10:43:55 alek Exp $
d1059 1
@


1.698
log
@Add LIBTOOL to FAKE_FLAGS.

ok sturm@@, espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.697 2005/04/24 18:02:45 espie Exp $
d701 1
a701 1
PKG_ARGS+= -v -c '${WRKPKG}/COMMENT${SUBPACKAGE}' -d ${WRKPKG}/DESCR${SUBPACKAGE}
@


1.697
log
@missed test.
found out (more or less) by alek@@.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.696 2005/04/23 15:24:49 espie Exp $
d292 1
@


1.696
log
@fiddle a bit with LD_LIBRARY_PATH: allow mixed fake/non-fake.
and create a _set_ld_library_path internal, so that bzip2 can be installed
only as a dependency.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.695 2005/04/23 15:12:19 espie Exp $
d1085 1
a1085 1
.if ${FAKE:L} == "all"
@


1.695
log
@fake case is special, directly check if the exact package is already installed
(avoid errors in multiple installs of the same dependency)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.694 2005/04/23 14:31:38 espie Exp $
d1072 2
a1073 1
PORT_LD_LIBRARY_PATH=${DEPBASE}/lib:${X11BASE}/lib:/usr
d1080 2
d1646 1
@


1.694
log
@allows a mode FAKE=all where BUILD_DEPENDS get also installed under
DEPDIR.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.693 2005/04/21 01:44:50 alek Exp $
d1367 1
@


1.693
log
@Do not check if SEPARATE_BUILD is defined but check what is its value
(defaults to No)

help & blessing from espie@@, ok naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.692 2005/04/19 09:21:42 espie Exp $
d1071 1
a1071 1
.if ${FAKE:L} == "lib" && ${USE_FAKE_LIB:L} == "yes"
d1081 3
a1083 1
_lib_depends_target=${DEPENDS_TARGET}
d1086 2
a1087 1
_build_depends_target=${DEPENDS_TARGET}
@


1.692
log
@need to use a default target for fake=lib. gettext->=0.10.38 is not an
installable package name...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.691 2005/04/17 22:51:16 espie Exp $
d212 1
d413 1
a413 1
.elif defined(SEPARATE_BUILD)
d425 1
a425 1
.if defined(SEPARATE_BUILD)
d519 1
a519 1
.  if defined(SEPARATE_BUILD) && ${SEPARATE_BUILD:L:Mflavored}
d525 1
a525 1
.  if defined(SEPARATE_BUILD) && ${SEPARATE_BUILD:L:Mflavored}
d536 1
a536 1
.if defined(SEPARATE_BUILD)
d901 1
a901 1
.  if defined(SEPARATE_BUILD)
d1196 1
a1196 1
.  if defined(SEPARATE_BUILD) && ${SEPARATE_BUILD:L:Mflavored}
@


1.691
log
@look in the correct place if FAKE=lib
found out by naddy while working on xloadimage.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.690 2005/04/17 18:31:58 espie Exp $
d1359 1
@


1.690
log
@use  both DEPBASE and LOCALBASE in PORTSPATH since we don't fake everything yet.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.689 2005/04/17 13:21:14 espie Exp $
d1045 1
a1045 1
		*/*) shprefix="$${d%/*}/"; shdir="${LOCALBASE}/$${d%/*}"; \
d1047 1
a1047 1
		*) shprefix="" shdir="/usr/lib /usr/X11R6/lib ${LOCALBASE}/lib";; \
d2382 1
a2382 1
			listlibs='ls $$shdir 2>/dev/null'; \
@


1.689
log
@move BUILD_DEPENDS outside of FAKE=lib scope, because it's really hard
to convince autoconf to work...

Also, ln -sf -> ln -sfh
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.688 2005/04/17 10:10:07 espie Exp $
d454 1
a454 1
PORTPATH?= ${WRKDIR}/bin:/usr/bin:/bin:/usr/sbin:/sbin:${DEPBASE}/bin:${X11BASE}/bin
@


1.688
log
@Add DEPBASE for dependencies.
Add USE_FAKE_LIB to turn on FAKE=LIB for ports that have been converted.

Tweak buil/lib depends and LD_LIBRARY_PATH in FAKE=lib case.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.687 2005/04/01 15:55:36 jolan Exp $
a1075 1
_build_depends_target=fake
a1079 1
_build_depends_target=${DEPENDS_TARGET}
d1083 1
d1360 2
a1361 2
				ln -sf /usr/lib ${DEPDIR}/usr/lib; \
				ln -sf /usr/X11R6/lib ${DEPDIR}/usr/X11R6/lib; \
@


1.687
log
@add humppa64 to lp64_archs
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.686 2005/03/30 08:14:01 espie Exp $
d173 1
d286 1
a286 1
LIBTOOL?=			${LOCALBASE}/bin/libtool
d323 1
a323 1
MOTIFLIB=-L${LOCALBASE}/lib -lXm
d454 1
a454 1
PORTPATH?= ${WRKDIR}/bin:/usr/bin:/bin:/usr/sbin:/sbin:${LOCALBASE}/bin:${X11BASE}/bin
d478 1
a478 1
	LOCALBASE='${LOCALBASE}' X11BASE='${X11BASE}' \
d624 1
a624 1
	${LOCALBASE}/bin/gmake
d921 2
a922 1
		  PREFIX=${PREFIX} LOCALBASE=${LOCALBASE} X11BASE=${X11BASE}
d1070 11
d1082 3
a1085 1
_lib_depends_target=${DEPENDS_TARGET}
d1335 1
d1353 11
d1619 1
a1619 1
	@@mkdir -p ${WRKDIR} ${WRKDIR}/bin
@


1.686
log
@let RUN_DEPENDS register itself in built package as stem-* if no pkgspec
has been requested.

Simplifies package updates a great deal, needs porters to be more careful.

okay naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.685 2005/03/13 22:51:34 espie Exp $
d84 1
a84 1
LP64_ARCHS=alpha amd64 sparc64 mips64
@


1.685
log
@allow WANTLIB to be / something, to cater to expat.
okay pvalchev@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.684 2005/03/09 15:40:37 espie Exp $
d2342 1
a2342 1
		: $${pkg:=$$default}; \
@


1.684
log
@move targets around so they get handled gracefully in BROKEN case.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.683 2005/03/09 15:21:07 espie Exp $
d1042 1
@


1.683
log
@Finally rephrase what's going on.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.682 2005/03/06 12:03:58 espie Exp $
d1369 2
a1370 1
_internal-update _internal-newlib-depends-check \
d1505 51
a2066 51

# packing list utilities.  This generates a packing list from a recently
# installed port.  Not perfect, but pretty close.  The generated file
# will have to have some tweaks done by hand.
# Note: add @@comment PACKAGE(arch=${MACHINE_ARCH}, opsys=${OPSYS}, vers=${OPSYS_VER})
# when port is installed or package created.
#
.if ${FAKE:L} != "no"
.  if ${SHARED_ONLY:L} == "yes"
_do_libs_too=
.  else
_do_libs_too=NO_SHARED_LIBS=Yes
.  endif

_extra_prefixes=
.if defined(MULTI_PACKAGES)
.  for _s in ${MULTI_PACKAGES}
_extra_prefixes+=PREFIX${_s}=`cd ${.CURDIR} && SUBPACKAGE=${_s} PACKAGING=${_s} ${MAKE} show=PREFIX`
.  endfor
.endif

_internal-plist _internal-update-plist: _internal-fake ${_DEPrun_COOKIES}
	@@${ECHO_MSG} "===>  Updating plist for ${FULLPKGNAME}${_MASTER}"
	@@mkdir -p ${PKGDIR}
	@@DESTDIR=${WRKINST} PREFIX=${WRKINST}${PREFIX} \
	TRUEPREFIX=${TRUEPREFIX} \
	MTREE_FILE=${WRKPKG}/mtree.spec \
	INSTALL_PRE_COOKIE=${_INSTALL_PRE_COOKIE} \
	DEPS="`${MAKE} full-run-depends ${_do_libs_too}`" \
	PKGREPOSITORY=${PKGREPOSITORY} \
	PLIST=${PLIST} \
	PFRAG=${PKGDIR}/PFRAG \
	FLAVORS='${FLAVORS}' MULTI_PACKAGES='${MULTI_PACKAGES}' \
	OKAY_FILES='${_FAKE_COOKIE} ${_INSTALL_PRE_COOKIE}' \
	SHARED_ONLY="${SHARED_ONLY}" \
	OWNER=`id -u` \
	GROUP=`id -g` \
	${SUDO} perl ${PORTSDIR}/infrastructure/install/make-plist \
	${_extra_prefixes} ${_tmpvars}
.endif

update-patches:
	@@toedit=`WRKDIST=${WRKDIST} PATCHDIR=${PATCHDIR} \
		PATCH_LIST='${PATCH_LIST}' DIFF_ARGS='${DIFF_ARGS}' \
		DISTORIG=${DISTORIG} PATCHORIG=${PATCHORIG} \
		/bin/sh ${PORTSDIR}/infrastructure/build/update-patches`; \
	case $$toedit in "");; \
	*) read i?'edit patches: '; \
	cd ${PATCHDIR} && $${VISUAL:-$${EDITOR:-/usr/bin/vi}} $$toedit;; esac


@


1.682
log
@inform newlib-depends-check about the repository location
(needs RECENT newlib-depends-check).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.681 2005/01/31 10:12:24 espie Exp $
d1840 1
a1840 1
		'') ;; \
d1847 2
a1848 2
		'') ;; \
		'${FULLPKGNAME${SUBPACKAGE}}') ;; \
@


1.681
log
@flag for a.out
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.680 2005/01/31 09:58:22 espie Exp $
d1384 1
a1384 1
		${_NEWLIB_DEPENDS_FLAGS} ${_PACKAGE_COOKIES}
@


1.680
log
@remove source-based lib-depends-check. We always check the package now.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.679 2005/01/31 09:52:53 espie Exp $
d1376 6
d1383 2
a1384 1
	@@perl ${PORTSDIR}/infrastructure/package/check-newlib-depends ${_PACKAGE_COOKIES}
@


1.679
log
@switch to package checking for newlib-depends.
let force update force depends as well.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.678 2005/01/13 11:54:55 espie Exp $
a172 4
_LIBLIST=${WRKDIR}/.liblist-${ARCH}${_FLAVOR_EXT2}
_BUILDLIBLIST=${WRKDIR}/.buildliblist-${ARCH}${_FLAVOR_EXT2}
_SYSBUILDLIBLIST=${WRKDIR}/.sysbuildliblist-${ARCH}${_FLAVOR_EXT2}

a1364 37
# Do a brute-force ldd/objdump on all files under WRKINST.
.if ${ELF_TOOLCHAIN:L} == "no"
${_LIBLIST}: ${_FAKE_COOKIE}
	@@${SUDO} mkdir -p ${WRKINST}/usr/libexec
	@@-${SUDO} cp -f /usr/libexec/ld.so ${WRKINST}/usr/libexec
	@@-${SUDO} cp -f /usr/lib/libc.so.* ${WRKINST}
	@@-${SUDO} cp -f /usr/bin/ldd ${WRKINST}
	@@cd ${WRKINST} && ${SUDO} find . -type f|\
		${SUDO} env LD_LIBRARY_PATH=. xargs chroot ${WRKINST} \
		./ldd -f '\tlibrary: %o %m %n\n' -f '\tlibrary: %o %m %n\n' 2>/dev/null|\
		grep '^	'|\
		sort -u >$@@
.else
${_LIBLIST}: ${_FAKE_COOKIE}
	@@cd ${WRKINST} && ${SUDO} find . -type f|\
		${SUDO} xargs objdump -p 2>/dev/null |\
		sed -n \
			-e '/^ *NEEDED *\(.*\)\.so\.\([0-9][0-9]*\)\.\([0-9][0-9]*\)$$/s//\1 \2 \3/p' \
			-e '/^ *NEEDED *\(.*\)\.so$$/s//\1/p'| \
		sort -u >$@@
.endif

# list of libraries that can be used: libraries just built, and system libs.
${_BUILDLIBLIST}: ${_FAKE_COOKIE}
	@@${SUDO} find ${WRKINST} -type f -o -type l | \
		egrep '(\.so\.|\.so$$)'|${SUDO} xargs file -L|fgrep 'shared'|cut -d\: -f1|sort -u >$@@

${_SYSBUILDLIBLIST}: ${_FAKE_COOKIE}
	@@{ \
		${SUDO} find ${WRKINST} -type f -o -type l; \
		find /usr/lib -path /usr/lib -o -type d -prune -o -type f -print; \
		find ${X11BASE}/lib -path ${X11BASE}/lib -o -type d -prune -o -type f -print; \
	}|\
		egrep '(\.so\.|\.so$$)'|${SUDO} xargs file -L|fgrep 'shared'|cut -d\: -f1|sort -u >$@@



d1369 1
a1369 1
_internal-update \
d1376 1
a1376 16
# For now, just check all libnames are present
# The check is done on the fake area, be wary of multi-packages situation,
# since we don't take it into account yet.
#
# Note that we cache needed library names, and libraries we're allowed to
# depend upon, but not the actual list of lib depends, since this list is
# going to be tweaked as a result of running lib-depends-check.
#
_internal-lib-depends-check: ${_LIBLIST} ${_SYSBUILDLIBLIST}
	@@${_depfile_fragment}; \
	LIB_DEPENDS="`${MAKE} _recurse-lib-depends-check`" \
	PKG_DBDIR='${PKG_DBDIR}' \
		perl ${PORTSDIR}/infrastructure/install/check-libs-elf \
		${_LIBLIST} ${_SYSBUILDLIBLIST}

_internal-newlib-depends-check: ${_PACKAGE_COOKIES}
a2325 27
# Print list of all libraries that we may depend upon.
_recurse-lib-depends-check:
.for _i in  ${LIB_DEPENDS}
	@@unset FLAVOR SUBPACKAGE  || true; \
	echo '${_i}' | { \
		IFS=:; read dep pkg dir target; \
		IFS=,; for j in $$dep; do echo $$j; done; \
		if ! fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then \
			echo "|$$dir|" >>$${_DEPENDS_FILE}; \
			${_flavor_fragment}; \
			eval $$toset ${MAKE} _recurse-lib-depends-check; \
		fi; \
	}
.endfor
.for _i in  ${RUN_DEPENDS}
	@@unset FLAVOR SUBPACKAGE  || true; \
	echo '${_i}' | { \
		IFS=:; read dep pkg dir target; \
		if ! fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then \
			echo "|$$dir|" >>$${_DEPENDS_FILE}; \
			${_flavor_fragment}; \
			eval $$toset ${MAKE} _recurse-lib-depends-check; \
		fi; \
	}
.endfor


d2543 1
a2543 1
	_recurse-all-dir-depends _recurse-lib-depends-check \ 
@


1.678
log
@pkg_add -f -> pkg_add -F prior to killing the old option.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.677 2005/01/06 19:30:34 espie Exp $
d1432 2
a1433 6
_internal-newlib-depends-check: ${_LIBLIST} ${_BUILDLIBLIST}
	@@LIB_DEPENDS='${LIB_DEPENDS:C/:.*//}' \
	WANTLIB='${WANTLIB}' \
	PKG_DBDIR='${PKG_DBDIR}' \
		perl ${PORTSDIR}/infrastructure/install/check-libs-elf \
		${_LIBLIST} ${_BUILDLIBLIST}
d1891 1
a1891 1
		   ${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKGADD_AUTO} -F update -F installed -r ${PKGFILE${SUBPACKAGE}};; \
@


1.677
log
@switch to right directory before checking.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.676 2005/01/04 20:44:45 espie Exp $
d1895 1
a1895 1
		   ${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKGADD_AUTO} -f update -f installed -r ${PKGFILE${SUBPACKAGE}};; \
@


1.676
log
@let fetch check the size of the retrieved file, if this is recorded in
distinfo.

This allows ftp to skip files which return 404 error files and other
such nonsense...

(note that if you want to really grab a file with the wrong size, you
can just say CHECKSUM_FILE=/dev/null)


with input from by xsa, sturm, ian..
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.675 2005/01/02 23:33:09 couderc Exp $
d1963 1
a1963 1
				ck=`${_size_fragment}`; \
@


1.675
log
@MODULES is prefered to CONFIGURE_SCRIPT, undo last changes, asked by espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.674 2005/01/02 20:54:02 couderc Exp $
d1200 2
d1264 4
d1279 4
d1962 13
a1974 1
				exit 0; \
@


1.674
log
@add pmk config style support.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.673 2004/12/29 14:30:53 naddy Exp $
d552 1
a552 1
.for _i in perl gnu imake pmk
@


1.673
log
@use double quotes to permit expansion of shell variable in message
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.672 2004/12/21 20:56:54 espie Exp $
d552 1
a552 1
.for _i in perl gnu imake
@


1.672
log
@forgot clean=force, reminded by msf.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.671 2004/12/19 12:20:12 espie Exp $
d2149 1
a2149 1
	  echo >&2 'Missing checksum file: $$checksum_file'; \
@


1.671
log
@verify the spelling of clean options.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.670 2004/11/28 11:44:00 espie Exp $
d195 1
a195 1
	readme bulk
@


1.670
log
@must run objdump through sudo as well...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.669 2004/11/27 14:07:19 espie Exp $
d193 8
@


1.669
log
@kill code that is no longer used.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.668 2004/11/27 12:36:14 espie Exp $
d1366 1
a1366 1
		xargs objdump -p 2>/dev/null |\
@


1.668
log
@still need to look in the default package for multi-package cases.
use -K that we now have...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.667 2004/11/27 09:59:35 espie Exp $
a1235 13
${WRKPKG}/PLIST${SUBPACKAGE}: ${WRKPKG}/depends${SUBPACKAGE}
	@@echo "@@comment subdir=${FULLPKGPATH} cdrom=${PERMIT_PACKAGE_CDROM:L} ftp=${PERMIT_PACKAGE_FTP:L}" >$@@.tmp
	@@sort -u <${WRKPKG}/depends${SUBPACKAGE}>>$@@.tmp
	@@mv -f $@@.tmp $@@

${WRKPKG}/depends${SUBPACKAGE}:
	@@mkdir -p ${WRKPKG}
	@@>$@@
.if (defined(RUN_DEPENDS) && !empty(RUN_DEPENDS)) || (${NO_SHARED_LIBS:L} != "yes" && defined(LIB_DEPENDS) && !empty(LIB_DEPENDS))
	@@${_depfile_fragment}; \
	_depends_result=$@@ ${MAKE} _solve-package-depends
.endif

a2436 47
# Write a correct list of dependencies for packages.
_solve-package-depends:
.for _i in ${RUN_DEPENDS}
	@@unset FLAVOR SUBPACKAGE || true; \
	echo '${_i}' |{ \
		IFS=:; read dep pkg pkgpath target; \
		dir=$$pkgpath; ${_flavor_fragment}; \
		default=`eval $$toset ${MAKE} _print-packagename`; \
		: $${pkg:=$$default}; \
		echo "@@newdepend $$pkgpath:$$pkg:$$default" >>$${_depends_result}; }
.endfor
.if ${NO_SHARED_LIBS:L} != "yes"
.  for _i in ${LIB_DEPENDS}
	@@unset FLAVOR SUBPACKAGE || true; \
	echo '${_i}'|{ \
		IFS=:; read dep pkg pkgpath target; \
		dir=$$pkgpath; ${_flavor_fragment}; \
		libspecs='';comma=''; \
		default=`eval $$toset ${MAKE} _print-packagename`; \
		case "X$$pkg" in X) pkg=`echo $$default|sed -e 's,-[0-9].*,-*,'`;; esac; \
		if pkg_info -q -e $$pkg; then \
			listlibs='ls $$shdir 2>/dev/null'; \
		else \
			eval $$toset ${MAKE} ${PKGREPOSITORY}/$$default.tgz; \
			listlibs='pkg_info -L ${PKGREPOSITORY}/$$default.tgz|grep $$shdir|sed -e "s,^$$shdir/,,"'; \
		fi; \
		IFS=,; for d in $$dep; do \
			${_libresolve_fragment}; \
			case "$$check" in \
			*.a) continue;; \
			Missing\ library|Error:*) \
				echo 1>&2 "Can't resolve libspec $$d"; \
				exit 1;; \
			*) \
				libspecs="$$libspecs$$comma$$shprefix$$check"; \
				comma=',';; \
			esac; \
		done; \
		case "X$$libspecs" in \
		X) ;;\
		*) \
			echo "@@libdepend $$pkgpath:$$libspecs:$$pkg:$$default" >>$${_depends_result}; \
		esac; \
	}
.  endfor
.endif

d2601 1
a2601 1
	_recurse-run-dir-depends _solve-package-depends _refetch \
@


1.667
log
@switch to using @@wantlib and @@depends, say byebye to libdepends and newdepends.
(this will break your machine if you don't have reasonably current pkg_add)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.666 2004/11/21 15:59:25 espie Exp $
d2416 6
a2421 1
		listlibs='ls $$shdir 2>/dev/null'; \
@


1.666
log
@ready-to-go switch to @@wantlib/@@depend
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.665 2004/11/21 11:26:22 espie Exp $
d693 1
a693 1
_PKG_PREREQ= ${WRKPKG}/PLIST${SUBPACKAGE} ${WRKPKG}/DESCR${SUBPACKAGE} ${WRKPKG}/COMMENT${SUBPACKAGE}
d695 1
a695 2
PKG_ARGS+=-f ${WRKPKG}/PLIST${SUBPACKAGE} -f ${PLIST} -p ${PREFIX}
#PKG_ARGS+=-f ${PLIST} -p ${PREFIX} `${MAKE} _print-package-args`
@


1.665
log
@newlib-depends-check that takes the semantics-to-be into account.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.664 2004/11/21 10:43:48 espie Exp $
d696 1
@


1.664
log
@new support routine _print-package-args, that prints new-style package
dependencies.
_syslib_resolve_fragment that can resolve system libs.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.663 2004/11/19 22:12:28 sturm Exp $
d175 1
d1017 1
d1388 4
d1420 1
a1420 1
_internal-lib-depends-check: ${_LIBLIST} ${_BUILDLIBLIST}
d1425 7
d1560 2
a1561 1
regress-depends clean lib-depends-check manpages-check plist update-plist update
d2671 1
a2671 1
	lib-depends lib-depends-check lib-depends-list \
d2694 1
@


1.663
log
@use TRUEPREFIX locally
sort SYSTRACE_SUBST_VARS while here
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.662 2004/11/17 11:09:44 espie Exp $
d1034 9
d2382 49
d2643 1
a2643 1
	addsum \
@


1.662
log
@can't depend on WRKDIR unconditionally, throws update off when
UPDATE_COOKIES_DIR is set.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.661 2004/11/17 10:38:37 espie Exp $
d616 1
a616 1
SYSTRACE_FILTER?=		${PORTSDIR}/infrastructure/db/systrace.filter
d619 1
a619 1
SYSTRACE_SUBST_VARS+=	WRKDIR PORTSDIR DISTDIR TMPDIR PKG_TMPDIR TRUEPREFIX
@


1.661
log
@add missing stuff around update so that BULK works for it too.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.660 2004/11/16 02:08:59 espie Exp $
d1855 4
a1858 2
${_UPDATE_COOKIE}: ${_WRKDIR_COOKIE} ${_PACKAGE_COOKIES}
.if !empty(UPDATE_COOKIES_DIR)
@


1.660
log
@only pass FULLPKGPATH, PERMIT_PACKAGE_CDROM, PERMIT_PACKAGE_FTP to
pkg_create, and quote the later properly...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.659 2004/11/15 16:31:28 espie Exp $
d1079 1
d1086 1
d1518 1
a1518 1
_internal-update: ${_UPDATE_COOKIE}
@


1.659
log
@Pass PERMIT_PACKAGE_CDROM, PERMIT_PACKAGE_FTP, FULLPKGPATH as parameters
to pkg_create... This should allow the automatic generation of ExtraInfo
without needing to do it manually.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.658 2004/11/15 13:52:03 espie Exp $
a625 1
SUBST_VARS+=FULLPKGPATH PERMIT_PACKAGE_CDROM PERMIT_PACKAGE_FTP
d640 3
@


1.658
log
@industrial-strength updates:
- separate UPDATE_COOKIES_DIR, unless set to empty.
Makes for easier management.
- FORCE_UPDATE variable, that makes certain packages are updated when
a dependency is run, and that forces the replacement of packages that are
already there.  Still uses the update cookie, so that this update occurs
just once unless you wipe out yur UPDATE_COOKIES_DIR (which justifies putting
update cookies in a separate directory).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.657 2004/11/15 11:49:05 espie Exp $
d626 1
@


1.657
log
@use pkg_info -q -e   instead of pkg dependencies check now that it does
what it should.

Use the exact same rules for checking LIB_DEPENDS that will later be used
to build the package itself, e.g., add the pkg dependency check.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.656 2004/11/10 23:40:42 espie Exp $
d73 1
d101 1
d413 3
d417 1
a993 1

d1054 6
d1320 1
d1851 3
d1855 8
d1870 1
@


1.656
log
@rename _UPDATE_COOKIE to always be defined (wilfried) and to have a name
changing when the FULLPKGNAME changes.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.655 2004/11/10 10:16:41 espie Exp $
d1004 1
a1004 1
	if pkg dependencies check "$$pkg"; then \
d1028 4
a1031 1
	what=$$dep; \
d1039 4
a1042 1
	done; $$bad || found=true
d1827 1
a1827 1
	@@if pkg dependencies check ${FULLPKGNAME${SUBPACKAGE}}; then \
d2362 1
a2362 1
		if pkg dependencies check $$pkg; then \
@


1.655
log
@Add a simple update target, that relies on pkg_info -e pkgpath to know
if there is something to update...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.654 2004/10/26 06:16:53 pvalchev Exp $
d411 1
a419 1
_UPDATE_COOKIE=     ${WRKDIR}/.update_done
@


1.654
log
@add mips64 to LP64_ARCHS
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.653 2004/10/23 10:02:51 espie Exp $
d419 1
d427 1
a427 1
${_DEPrun_COOKIES} ${_DEPregress_COOKIES}
d1367 1
d1495 1
d1515 1
a1515 1
regress-depends clean lib-depends-check manpages-check plist update-plist
d1832 11
d2585 2
a2586 1
	_internal-manpages-check _internal-plist _internal-update-plist
@


1.653
log
@allow us to specialize DEPENDS_TARGET depending on whether this is
a LIB/RUN/BUILD/REGRESS_DEPENDS.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.652 2004/10/23 09:58:13 espie Exp $
d83 1
a83 1
LP64_ARCHS=alpha amd64 sparc64
@


1.652
log
@switch FAKE's test from == "yes" to != "no"
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.651 2004/10/11 10:32:04 espie Exp $
d1037 5
d1279 1
a1279 1
		case "X$$target" in X) target=${DEPENDS_TARGET};; esac; \
@


1.651
log
@UNMESSAGE
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.650 2004/10/08 19:58:30 sturm Exp $
d401 1
a401 1
.if ${FAKE:L} == "yes"
d554 1
a554 1
.if ${FAKE:L} == "yes"
d700 1
a700 1
.if ${FAKE:L} == "yes"
d1761 1
a1761 1
.if ${FAKE:L} == "yes"
d1979 1
a1979 1
.if ${FAKE:L} == "yes"
@


1.650
log
@add TRUEPREFIX to SYSTRACE_SUBST_VARS
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.649 2004/09/19 09:00:15 pvalchev Exp $
d672 3
d696 3
@


1.649
log
@change CDROM_SITE to default to empty; ok espie
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.648 2004/09/18 13:48:43 espie Exp $
d612 1
a612 1
SYSTRACE_SUBST_VARS+=	WRKDIR PORTSDIR DISTDIR TMPDIR PKG_TMPDIR
@


1.648
log
@kill old check-libs script, after checking the new one handles a.out
just fine.

Kill old subst that's not used anymore as well.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.647 2004/09/18 13:45:23 espie Exp $
d769 1
a769 3
# OpenBSD code to handle ports distfiles on a CDROM.  The distfiles
# are located in /cdrom/distfiles/${DIST_SUBDIR}/ (assuming that the
# CDROM is mounted on /cdrom).
d771 2
a772 1
CDROM_SITE?=	/cdrom/distfiles/${DIST_SUBDIR}
@


1.647
log
@Strip spaces from CFLAGS everywhere.
Pass off -a to pkg_add if used to solve dependencies.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.646 2004/09/15 18:58:49 espie Exp $
a1320 1
_CHECK_LIBS_SCRIPT=${PORTSDIR}/infrastructure/install/check-libs
a1331 1
_CHECK_LIBS_SCRIPT=${PORTSDIR}/infrastructure/install/check-libs-elf
d1374 1
a1374 1
		perl ${_CHECK_LIBS_SCRIPT} \
@


1.646
log
@WRKCONF?=${WRKBUILD}
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.645 2004/09/15 18:57:31 espie Exp $
d378 1
d621 6
d1058 2
a1059 2
		CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
		CXX="${CXX}" ac_cv_path_CXX="${CXX}" CXXFLAGS="${CXXFLAGS}" \
d1279 1
d1813 1
a1813 1
		${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${PKGFILE${SUBPACKAGE}}; \
d1816 1
a1816 1
	@@${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${PKGFILE${SUBPACKAGE}}
@


1.645
log
@remove all SED_PLIST work, since pkg_create handles it now.
defines appropriate PKG_ARG arguments instead.
Move message to -M ${MESSAGE}.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.644 2004/09/14 23:07:20 espie Exp $
d528 1
d1050 1
a1050 1
	cd ${WRKBUILD} && ${_SYSTRACE_CMD} ${SETENV} \
@


1.644
log
@remove trailing spaces from CFLAGS/CXXFLAGS, to please autoconf...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.643 2004/09/14 23:06:02 espie Exp $
d326 3
a328 3
# Support architecture and flavor dependent packing lists
#
SED_PLIST?=
a335 1
# Create the basic sed substitution pipeline for fragments
d340 1
a340 1
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/r${PKGDIR}/PFRAG.no-${_i}${SUBPACKAGE}' -e '//d' -e '/^%%${_i}%%$$/d'
d346 1
a346 1
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/d' -e '/^%%${_i}%%$$/r${PKGDIR}/PFRAG.${_i}${SUBPACKAGE}' -e '//d'
d350 5
a354 1

d358 1
a358 1
 
d621 1
d624 2
a626 3
_tmpvars += FLAVORS='${FLAVOR_EXT}'
# and append it to the PLIST substitution pipeline
SED_PLIST+=|${_SED_SUBST}
d672 13
a684 20
# Note that if you override PKG_ARGS, you will not get correct dependencies
.if !defined(PKG_ARGS)
PKG_ARGS= -v -c '${WRKPKG}/COMMENT${SUBPACKAGE}' -d ${WRKPKG}/DESCR${SUBPACKAGE}
PKG_ARGS+=-f ${WRKPKG}/PLIST${SUBPACKAGE} -p ${PREFIX}
.  if exists(${PKGDIR}/INSTALL${SUBPACKAGE})
PKG_ARGS+=		-i ${WRKPKG}/INSTALL${SUBPACKAGE}
_PKG_PREREQ+=${WRKPKG}/INSTALL${SUBPACKAGE}
.  endif
.  if exists(${PKGDIR}/DEINSTALL${SUBPACKAGE})
PKG_ARGS+=		-k ${WRKPKG}/DEINSTALL${SUBPACKAGE}
_PKG_PREREQ+=${WRKPKG}/DEINSTALL${SUBPACKAGE}
.  endif
.  if exists(${PKGDIR}/REQ${SUBPACKAGE})
PKG_ARGS+=		-r ${WRKPKG}/REQ${SUBPACKAGE}
_PKG_PREREQ+=${WRKPKG}/REQ${SUBPACKAGE}
.  endif
.  if defined(MESSAGE)
PKG_ARGS+=		-D ${WRKPKG}/MESSAGE${SUBPACKAGE}
_PKG_PREREQ+=${WRKPKG}/MESSAGE${SUBPACKAGE}
.  endif
d1184 1
a1184 1
${WRKPKG}/PLIST${SUBPACKAGE}: ${PLIST} ${WRKPKG}/depends${SUBPACKAGE}
d1187 1
a1187 20
.if ${NO_SHARED_LIBS:L} == "yes"
	@@sed -e '/^!%%SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' -e '//d' \
		-e '/^%%!SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' -e '//d' \
		-e '/^%%SHARED%%$$/d' <${PLIST} \
		${SED_PLIST} >>$@@.tmp && mv -f $@@.tmp $@@
.else
	@@if [ -x /sbin/ldconfig ]; then \
		sed -e '/^!%%SHARED%%$$/d' \
			-e '/^%%!SHARED%%$$/d' \
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' -e '//d' \
			<${PLIST} ${SED_PLIST} \
			| sed -f ${LDCONFIG_SED_SCRIPT} >>$@@.tmp && mv -f $@@.tmp $@@; \
	else \
		sed -e '/^!%%SHARED%%$$/d' \
			-e '/^%%!SHARED%%$$/d' \
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' -e '//d' \
			<${PLIST} \
			${SED_PLIST} >>$@@.tmp && mv -f $@@.tmp $@@; \
	fi
.endif
a1206 12
# substitute 
.for _subst_file in INSTALL DEINSTALL REQ
.  if exists(${PKGDIR}/${_subst_file}${SUBPACKAGE})
${WRKPKG}/${_subst_file}${SUBPACKAGE}: ${PKGDIR}/${_subst_file}${SUBPACKAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
.  endif
.endfor

.if defined(MESSAGE)
${WRKPKG}/MESSAGE${SUBPACKAGE}: ${MESSAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
.endif
@


1.643
log
@explicitly forbid flavors starting with [0-9].
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.642 2004/08/13 23:28:40 brad Exp $
d462 1
a462 1
	MOTIFLIB='${MOTIFLIB}' CFLAGS='${CFLAGS}' \
@


1.642
log
@Side-effect of BULK=Yes: WRKDIR gets wiped out before the depend cookie
is written.

So, we simply recreate WRKDIR manually.
This is a kluge, but it should do the trick.

From espie@@

ok pvalchev@@ espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.641 2004/08/12 19:02:45 espie Exp $
d352 4
@


1.641
log
@set _MASTER_LOCK in the correct location.
fix postgresql locking *for good*.
okay pvalchev@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.640 2004/08/11 22:42:47 espie Exp $
d1334 1
@


1.640
log
@obvious mistake, FULLPKGPATH for recursive clean, duh!
problem found by brad@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.639 2004/08/11 22:25:23 espie Exp $
d1293 1
d1299 1
a1299 1
			toset="$$toset _MASTER='[${FULLPKGNAME${SUBPACKAGE}}]${_MASTER}' _MASTER_LOCK=${_LOCKNAME} WRKDIR=${WRKDIR}/$$dir"; \
@


1.639
log
@fix postgresql lock issue: in recursive locking, don't relock the same
port.

okay pvalchev@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.638 2004/08/10 13:48:21 espie Exp $
d1927 1
a1927 1
		case "$$dir" in ${PKGPATH}) t=_internal-clean;; *) t=clean;; esac; \
@


1.638
log
@prefer pkg_create -B
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.637 2004/08/08 23:14:03 espie Exp $
d1125 1
a1125 1
_DO_LOCK=: $${lock:=${PKGNAME}}; ${_LOCK}; trap '${_UNLOCK}' 0 1 2 3 13 15
d1127 1
a1127 1
_DO_LOCK=: $${lock:=${FULLPKGNAME}}; ${_LOCK}; trap '${_UNLOCK}' 0 1 2 3 13 15
d1129 8
d1298 1
a1298 1
			toset="$$toset _MASTER='[${FULLPKGNAME${SUBPACKAGE}}]${_MASTER}' _MASTER_LOCK=${FULLPKGNAME} WRKDIR=${WRKDIR}/$$dir"; \
@


1.637
log
@lock distfile as distfile.dist, since some ports have FULLPKGPATH=DISTFILE.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.636 2004/08/08 16:43:15 espie Exp $
d687 1
a687 1
PKG_ARGS+=		-S ${WRKINST}
@


1.636
log
@run update-plist as root, to catch all files.
pass OWNER/GROUP around and setuid/gid to them before writing
files to keep ownership.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.635 2004/08/06 11:31:22 espie Exp $
d1877 1
a1877 1
	@@lock=${_F:T}; ${_DO_LOCK}; mkdir -p ${_F:H}; \
@


1.635
log
@tag updating-plist case for logging.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.634 2004/08/05 23:43:45 espie Exp $
d1290 1
a1290 1
			toset="$$toset _MASTER='[${FULLPKGNAME${SUBPACKAGE}}]${_MASTER}' WRKDIR=${WRKDIR}/$$dir"; \
d2016 3
a2018 1
	perl ${PORTSDIR}/infrastructure/install/make-plist \
@


1.634
log
@almost completely new make-plist.
The new version uses the pkg_* infrastructure to read existing plists
and produced new plists.
Lots and lots of improvements:
- copy most stuff over from original lists correctly. For instance,
attach @@exec/@@unexec/@@sample to other files and copy them in the right
location.
- generic post-treatment of @@commnent, using stringize(), so that most
things can be commented out and will stay commented out.
- parse all packing-lists using relevant PREFIXes. Grab PFRAG.xx if %xx%
is seen.
- walk through all of fake, and distpatch files according to PREFIXes
if nothing else works.
- identifies man, libraries, info, handling symlink correctly.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.633 2004/08/03 21:18:24 espie Exp $
d2003 1
@


1.633
log
@tag error messages with PKGPATH, as they get hard to decipher
when walking the tree.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.632 2004/08/03 19:30:25 espie Exp $
d610 1
d614 1
d617 1
a1064 5
_tmpvars:=
.  for _v in ${SUBST_VARS}
_tmpvars += ${_v}='${${_v}}'
.  endfor

d1994 8
d2015 2
a2016 1
	perl ${PORTSDIR}/infrastructure/install/make-plist ${PKGDIR} ${_tmpvars}
@


1.632
log
@Move SHARED_ONLY default definition down so that it can be inherited
from Makefile.inc/MODULES.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.631 2004/08/03 16:18:51 espie Exp $
d2516 1
a2516 1
	@@echo 1>&2 ${_m}
@


1.631
log
@pass TRUEPREFIX around, don't pass LDCONFIG.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.630 2004/08/03 11:16:30 espie Exp $
a93 2
SHARED_ONLY?=	No

d203 2
@


1.630
log
@pass SHARED_ONLY to update-plist
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.629 2004/08/03 08:04:02 espie Exp $
d1998 2
a1999 1
	@@DESTDIR=${WRKINST} PREFIX=${WRKINST}${PREFIX} LDCONFIG="${LDCONFIG}" \
@


1.629
log
@Introduce SHARED_ONLY variable, as a more specific semantic way
to say port works only with shared libraries.

Mostly useful for `update-plist' which will recurse differently if
LIB_DEPENDS are only BUILD_DEPENDS or if they becomes RUN_DEPENDS.
okay pvalchev@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.628 2004/08/02 13:01:52 espie Exp $
d2007 1
@


1.628
log
@Always define NO_SHARED_LIBS.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.627 2004/08/02 12:10:17 espie Exp $
d94 2
d960 2
d1991 5
d2001 1
a2001 1
	DEPS="`${MAKE} full-run-depends`" \
@


1.627
log
@store PKGPATH instead of self name in dependencies.  pkg_add handles
recursion itself, so it does not need the self name.

Packages created require -current pkg_* tools to work !
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.626 2004/07/24 13:53:12 espie Exp $
d86 1
a86 1
# Define NO_SHARED_LIBS for those machines that don't support shared libraries.
d89 1
a89 1
NO_SHARED_LIBS=	Yes
d92 1
d620 1
a620 1
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${MACHINE_ARCH})
d622 1
d624 1
a624 2
.endif
.if !defined(PLIST) && defined(NO_SHARED_LIBS) && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.noshared)
d633 1
a633 1
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}.${MACHINE_ARCH})
d635 1
d637 1
a637 2
.endif
.if !defined(PLIST) && defined(NO_SHARED_LIBS) && exists(${PKGDIR}/PLIST${SUBPACKAGE}.noshared)
d875 1
a875 1
.if defined(NO_SHARED_LIBS)
d989 1
a989 1
.if defined(NO_SHARED_LIBS)
d1079 1
a1079 1
.if defined(LIB_DEPENDS)
d1177 1
a1177 1
.if defined(NO_SHARED_LIBS)
d1201 1
a1201 1
.if (defined(RUN_DEPENDS) && !empty(RUN_DEPENDS)) || (!defined(NO_SHARED_LIBS) && defined(LIB_DEPENDS) && !empty(LIB_DEPENDS))
d2316 1
a2316 1
.if !defined(NO_SHARED_LIBS)
@


1.626
log
@tag cache entries with b(uild), r(un), a(ll).
Fixes a rare logic error, where recursive build depends would not trigger
all depends because an existing build depends was taken instead.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.624 2004/07/20 14:23:32 espie Exp $
d1202 1
a1202 1
	self=${FULLPKGNAME${SUBPACKAGE}} _depends_result=$@@ ${MAKE} _solve-package-depends
d2309 2
a2310 2
		IFS=:; read dep pkg dir target; \
		${_flavor_fragment}; \
d2313 1
a2313 1
		echo "@@newdepend $$self:$$pkg:$$default" >>$${_depends_result}; }
d2319 2
a2320 2
		IFS=:; read dep pkg dir target; \
		${_flavor_fragment}; \
d2345 1
a2345 1
			echo "@@libdepend $$self:$$libspecs:$$pkg:$$default" >>$${_depends_result}; \
@


1.625
log
@clean=depends is naturally recursive, make a little dance so that it
goes to _internal-clean for itself.

found out by brad@@
@
text
@d2356 2
a2357 2
	if ! fgrep -q "|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >> $${_DEPENDS_FILE}; \
d2371 2
a2372 2
	if ! fgrep -q "|${FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
d2385 2
a2386 2
	if ! fgrep -q "|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >> $${_DEPENDS_FILE}; \
d2402 2
a2403 2
	if ! fgrep -q "|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >> $${_DEPENDS_FILE}; \
d2417 2
a2418 2
	if ! fgrep -q "|${FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
@


1.624
log
@since _solve-package-depends no longer recurses, it does not need a
cache file.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.623 2004/07/18 22:45:14 espie Exp $
d1916 1
d1919 1
a1919 1
		eval $$toset ${MAKE} _CLEANDEPENDS=No clean; \
@


1.623
log
@REORDER_DEPENDENCY missing a silent @@.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.622 2004/07/18 22:44:36 espie Exp $
a1201 1
	echo "|${FULLPKGNAME${SUBPACKAGE}}|" >>$${_DEPENDS_FILE}; \
@


1.622
log
@Lock infrastructure for the ports tree.

If LOCK_CMD, UNLOCK_CMD and LOCK_DIR are defined, those are used to
perform `big-lock' style locking on top-level targets, such as
extract, patch, build.

The internals of the ports tree do not use any finer grained locking.
Those top-level targets now redirect to _internal-targets, without
any behavioral change.

Any dependency computation will recurse to another directory, and
invoke a top-level target, thus triggering the locking of the dependency.

All locking is done using FULLPKGNAME, except for fetch with uses
the DISTFILES names for independent files.

If no locking is desired, the top-level targets simply redirect to
the _internal-targets. The cost is close to zero: make just needs to
handle an extra ~20 phony targets.

Much testing and approval by brad@@, naddy@@, pval@@, fries@@ and other
people. Thanks to niklas@@ for some useful discussion.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.621 2004/07/12 08:45:32 espie Exp $
d1665 1
a1665 1
	sed -e '/^#/d' ${REORDER_DEPENDENCIES} | \
@


1.621
log
@move everything to _fetch-makefile, so that __FETCH_ALL can put all
file names where it should.
noticed by jolan@@, okay sturm@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.620 2004/07/11 20:44:33 espie Exp $
d162 3
d1108 21
d1262 2
a1263 1
depends: lib-depends build-depends run-depends regress-depends
d1326 1
a1326 1
${_DEP}-depends: ${_DEP${_DEP}_COOKIES}
d1365 4
a1368 2
fetch checksum extract patch configure all build install regress \
uninstall deinstall fake package lib-depends-check manpages-check license-check:
d1382 1
a1382 1
lib-depends-check: ${_LIBLIST} ${_BUILDLIBLIST}
d1389 1
a1389 1
manpages-check: ${_FAKE_COOKIE}
d1406 1
a1406 1
fetch:
d1426 1
a1426 1
checksum: fetch
d1478 1
a1478 1
	cd ${.CURDIR} && exec ${MAKE} checksum REFETCH=false
d1483 2
a1484 2
extract: ${_EXTRACT_COOKIE}
patch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
d1486 1
a1486 1
distpatch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
d1488 1
a1488 1
configure: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
d1490 1
a1490 1
all build: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
d1492 3
a1494 3
install: ${_INSTALL_DEPS}
fake: ${_FAKE_COOKIE}
package: ${_PACKAGE_DEPS}
d1498 1
a1498 1
regress:
d1503 1
a1503 1
regress: ${_DEPregress_COOKIES} ${_REGRESS_COOKIE}
d1508 18
d1532 1
a1532 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} clean
d1544 1
a1544 1
	@@cd ${.CURDIR} && exec ${MAKE} checksum build-depends lib-depends
d1625 1
a1625 1
	@@cd ${.CURDIR} && exec ${MAKE} distpatch
d1812 1
a1812 1
	@@cd ${.CURDIR} && DEPENDS_TARGET=install exec ${MAKE} run-depends lib-depends
d1853 1
a1853 1
	    ${SUDO} ${MAKE} clean=package; \
d1875 1
a1875 1
	@@mkdir -p ${_F:H}; \
d1914 1
a1914 1
clean:
d1986 1
a1986 1
plist update-plist: fake ${_DEPrun_COOKIES}
d2546 8
a2553 1
	license-check _license-check
@


1.620
log
@byebye IGNOREFILES
Okay naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.619 2004/06/22 20:05:46 sturm Exp $
d1968 3
a1986 1
	@@exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes _fetch-makefile
a1987 2

_fetch-makefile:
@


1.619
log
@add _SYSTRACE_COOKIE to _ALL_COOKIES

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.618 2004/06/22 16:09:05 espie Exp $
d799 1
a799 3
.  for _file in ${IGNOREFILES}
__CKSUMFILES:=${__CKSUMFILES:N${_file}}
.  endfor
a804 1
_IGNOREFILES=	${IGNOREFILES:S/^/${DIST_SUBDIR}\//}
a806 1
_IGNOREFILES=	${IGNOREFILES}
a1211 3
	@@for file in ${_IGNOREFILES}; do \
		echo "MD5 ($$file) = IGNORE" >> ${CHECKSUM_FILE}; \
	done
a1222 3
	@@for file in ${_IGNOREFILES}; do \
		echo "MD5 ($$file) = IGNORE" >> ${CHECKSUM_FILE}; \
	done
d1416 1
a1416 2
			  echo ">> Checksum for $$file is set to IGNORE in md5 file even though"; \
			  echo "   the file is not in the "'$$'"{IGNOREFILES} list."; \
a1430 12
		for file in ${_IGNOREFILES}; do \
		  set -- `grep "($$file)" $$checksum_file` || \
			  { echo ">> No checksum recorded for $$file, file is in "'$$'"{IGNOREFILES} list." && \
			  OK=false; } ; \
		  case "$$4" in \
		  	"IGNORE") : ;; \
			*) \
			  echo ">> Checksum for $$file is not set to IGNORE in md5 file even though"; \
			  echo "   the file is in the "'$$'"{IGNOREFILES} list."; \
			  OK=false;; \
		  esac; \
		done; \
@


1.618
log
@missing dependency
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.617 2004/06/06 11:49:08 espie Exp $
d409 1
a409 1
${_PACKAGE_COOKIES} \
@


1.617
log
@move the automake inter-dependencies to another file.
checked by naddy@@ on a full build.
idea okay'ed by naddy and pvalchev.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.616 2004/06/01 21:06:29 jolan Exp $
d1136 1
a1136 1
${_SYSTRACE_COOKIE}:
@


1.616
log
@sort lp64_archs alphabetically, remove hppa from no_shared_archs
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.615 2004/05/31 12:27:07 sturm Exp $
d1108 1
d1642 16
@


1.615
log
@honour TMPDIR and PKG_TMPDIR in systrace policies

prodded by jolan@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.614 2004/05/16 23:14:44 pvalchev Exp $
d83 2
a84 2
LP64_ARCHS=sparc64 alpha amd64
NO_SHARED_ARCHS=hppa m88k vax
@


1.614
log
@provide LP64_ARCHS, a list of 64-bit architectures (to be used for
NOT_FOR_ARCHS and such); ok naddy
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.613 2004/05/01 14:27:07 sturm Exp $
d100 1
d597 1
a597 1
SYSTRACE_SUBST_VARS+=	WRKDIR PORTSDIR DISTDIR
@


1.613
log
@allow for additional port specific systrace policies, needed to make
jdk-linux and netscape build with systrace

ok espie and others
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.612 2004/04/19 18:57:54 espie Exp $
d83 1
@


1.612
log
@move -e '//d' around so that it's more readable...
... and add the missing one that was noticed by jolan@@ !
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.611 2004/02/07 22:36:13 espie Exp $
d1142 3
a1144 1

@


1.611
log
@always define DIST_SUBDIR, simplifies logic.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.610 2004/02/07 22:34:02 espie Exp $
d1152 3
a1154 3
	@@sed -e '/^!%%SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
		-e '/^%%!SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
		-e '//d' -e '/^%%SHARED%%$$/d' <${PLIST} \
d1160 2
a1161 2
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
			-e '//d' <${PLIST} ${SED_PLIST} \
d1166 2
a1167 2
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
			-e '//d' <${PLIST} \
@


1.610
log
@move up pkgpath.mk, so that PKGPATH is available.
Use it to define per-PKGPATH user-settings: BULK, WRKOBJDIR, ...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.609 2004/02/07 22:18:49 espie Exp $
d197 1
d199 1
a199 1
.if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
d803 1
a803 1
.if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
d1062 1
a1062 1
.if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
d1901 1
a1901 1
.    if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
d2006 1
a2006 1
.  if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
@


1.609
log
@always define WRKOBJDIR, FAKEOBJDIR (simpler logic).
change tests to !empty instead of defined.
Move BULK_TARGETS up with other user settings.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.608 2004/02/07 22:14:21 espie Exp $
d105 9
d175 1
a175 1
.if ${CLEANDEPENDS:L} == "yes"
d481 2
a482 2
.if !empty(FAKEOBJDIR)
WRKINST?=	${FAKEOBJDIR}/${PKGNAME}${_FLAVOR_EXT2}
d487 1
a487 1
.if !empty(WRKOBJDIR)
d489 1
a489 1
WRKDIR?=		${WRKOBJDIR}/${PKGNAME}
d491 1
a491 1
WRKDIR?=		${WRKOBJDIR}/${PKGNAME}${_FLAVOR_EXT2}
d1033 1
a1033 1
.if ${BULK:L} == "yes"
a1104 2
.include "${PORTSDIR}/infrastructure/mk/pkgpath.mk"

d1500 1
a1500 1
.for _i in ${BULK_TARGETS}
@


1.608
log
@.if                     .if
.else                   .elif
.  if            -->    .else
.  else                 .endif
.  endif
.endif
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.607 2004/02/07 22:02:40 espie Exp $
d70 3
d472 1
a472 1
.if defined(FAKEOBJDIR)
d478 1
a478 1
.if defined(WRKOBJDIR)
a1027 2

BULK_TARGETS?=
@


1.607
log
@let show be a list of variables
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.606 2004/02/01 23:07:30 espie Exp $
d194 1
a194 2
.else
.if exists(${.CURDIR}/patches.${MACHINE_ARCH})
a198 1
.endif
d204 2
a206 3
.  if exists(${.CURDIR}/scripts.${MACHINE_ARCH})
SCRIPTDIR?=		${.CURDIR}/scripts.${MACHINE_ARCH}
.  else
a207 1
.  endif
d212 1
a212 2
.else
.if exists(${.CURDIR}/files.${MACHINE_ARCH})
a216 1
.endif
d220 1
a220 2
.else
.if exists(${.CURDIR}/pkg.${MACHINE_ARCH})
a223 1
.endif
@


1.606
log
@better elf libs checker.
okay pvalchev@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.605 2004/01/28 22:15:21 espie Exp $
d143 3
a145 1
	@@echo ${${show}:Q}
@


1.605
log
@use -L if necessary.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.604 2004/01/28 22:13:40 espie Exp $
d1308 1
d1320 1
d1324 3
a1326 5
		grep NEEDED |\
		sed 's/\ lib//g' |\
		sed 's/  NEEDED     /	library: /g' |\
		sed 's/\.so\./ /g' |\
		sed 's/^\(.*\)\ \([^\.]*\)\.\([^\.]*\)/\1\ \2\ \3/g' |\
d1337 1
a1337 1
		fgrep .so.|${SUDO} xargs file -L|fgrep 'shared'|cut -d\: -f1|sort -u >$@@
d1361 1
a1361 1
		perl ${PORTSDIR}/infrastructure/install/check-libs \
@


1.604
log
@slight semantic change in CDROM_SITE.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.603 2004/01/28 20:16:14 sturm Exp $
d672 3
@


1.603
log
@remove "-f" from calls to pkg_delete, fixes "make uninstall"

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.602 2004/01/22 21:28:49 espie Exp $
d744 1
a744 3
.if exists(/cdrom/distfiles)
CDROM_SITE=	/cdrom/distfiles/${DIST_SUBDIR}
.endif
d746 1
a746 1
.if defined(CDROM_SITE)
@


1.602
log
@tag packages with @@arch
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.601 2004/01/20 17:42:12 sturm Exp $
d1904 1
a1904 1
	-${SUDO} ${PKG_DELETE} ${_clean:M-f} ${FULLPKGNAME${_s}}
d1907 1
a1907 1
	-${SUDO} ${PKG_DELETE} ${_clean:M-f} ${FULLPKGNAME${SUBPACKAGE}}
d2452 1
a2452 1
	@@${SUDO} ${PKG_DELETE} -f ${FULLPKGNAME${SUBPACKAGE}}
@


1.601
log
@make flavor PFRAGs SUBPACKAGE aware as described in bsd.port.mk(5)

from Kurt Miller <truk at optonline.net>
tested by naddy@@, ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.600 2004/01/18 07:52:49 sturm Exp $
d110 5
d671 1
@


1.600
log
@allow for port specific additional systrace filter rules in
${.CURDIR}/systrace.filter

ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.599 2004/01/11 15:04:01 sturm Exp $
d321 1
a321 1
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/r${PKGDIR}/PFRAG.no-${_i}' -e '//d' -e '/^%%${_i}%%$$/d'
d327 1
a327 1
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/d' -e '/^%%${_i}%%$$/r${PKGDIR}/PFRAG.${_i}' -e '//d'
@


1.599
log
@let systrace log to stderr
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.598 2004/01/11 00:49:01 espie Exp $
d1127 3
@


1.598
log
@reorder the bottom part of bsd.port.mk so that all variable tweaks are
done before any target is evaluated.  This makes sure a whole series
of bugs can't happen.

Tests and comments by naddy@@ and sturm@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.597 2004/01/06 16:27:11 espie Exp $
d576 1
a576 1
_SYSTRACE_CMD?=	/bin/systrace -i -a -f ${_SYSTRACE_COOKIE}
@


1.597
log
@use .elif
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.596 2004/01/06 15:02:57 espie Exp $
d518 4
a531 11
.if ${BIN_PACKAGES:L} == "yes"
${_PACKAGE_COOKIE}:
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
.else
${_PACKAGE_COOKIE}: ${_PACKAGE_COOKIE_DEPS}
.endif
	@@cd ${.CURDIR} && SUBPACKAGE='' FLAVOR='${FLAVOR}' PACKAGING='' exec ${MAKE} _package
.if !defined(PACKAGE_NOINSTALL)
	@@${_MAKE_COOKIE} $@@
.endif

a534 7
.  if ${BIN_PACKAGES:L} == "yes"
${_PACKAGE_COOKIE${_s}}:
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
.  else
${_PACKAGE_COOKIE${_s}}: ${_PACKAGE_COOKIE_DEPS}
.  endif
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' FLAVOR='${FLAVOR}' PACKAGING='${_s}' exec ${MAKE} _package
a536 4
.PRECIOUS: ${_PACKAGE_COOKIES} ${_INSTALL_COOKIE}

.include "${PORTSDIR}/infrastructure/mk/pkgpath.mk"

d573 1
a573 1
# setup systrace
a587 7
${_SYSTRACE_COOKIE}:
	@@rm -f $@@
.for _i in ${_SYSTRACE_POLICIES}
	@@echo "Policy: ${_i}, Emulation: native" >> $@@
	@@sed ${_SYSTRACE_SED_SUBST} ${SYSTRACE_FILTER} >> $@@
.endfor

a630 7
${WRKPKG}/COMMENT${SUBPACKAGE}:
.if defined(_COMMENT)
	@@echo ${_COMMENT} >$@@
.else
ERRORS+="Fatal: Missing comment."
.endif

a636 34
# And create the actual files from sources
${WRKPKG}/PLIST${SUBPACKAGE}: ${PLIST} ${WRKPKG}/depends${SUBPACKAGE}
	@@echo "@@comment subdir=${FULLPKGPATH} cdrom=${PERMIT_PACKAGE_CDROM:L} ftp=${PERMIT_PACKAGE_FTP:L}" >$@@.tmp
	@@sort -u <${WRKPKG}/depends${SUBPACKAGE}>>$@@.tmp
.if defined(NO_SHARED_LIBS)
	@@sed -e '/^!%%SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
		-e '/^%%!SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
		-e '//d' -e '/^%%SHARED%%$$/d' <${PLIST} \
		${SED_PLIST} >>$@@.tmp && mv -f $@@.tmp $@@
.else
	@@if [ -x /sbin/ldconfig ]; then \
		sed -e '/^!%%SHARED%%$$/d' \
			-e '/^%%!SHARED%%$$/d' \
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
			-e '//d' <${PLIST} ${SED_PLIST} \
			| sed -f ${LDCONFIG_SED_SCRIPT} >>$@@.tmp && mv -f $@@.tmp $@@; \
	else \
		sed -e '/^!%%SHARED%%$$/d' \
			-e '/^%%!SHARED%%$$/d' \
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
			-e '//d' <${PLIST} \
			${SED_PLIST} >>$@@.tmp && mv -f $@@.tmp $@@; \
	fi
.endif

${WRKPKG}/depends${SUBPACKAGE}:
	@@mkdir -p ${WRKPKG}
	@@>$@@
.if (defined(RUN_DEPENDS) && !empty(RUN_DEPENDS)) || (!defined(NO_SHARED_LIBS) && defined(LIB_DEPENDS) && !empty(LIB_DEPENDS))
	@@${_depfile_fragment}; \
	echo "|${FULLPKGNAME${SUBPACKAGE}}|" >>$${_DEPENDS_FILE}; \
	self=${FULLPKGNAME${SUBPACKAGE}} _depends_result=$@@ ${MAKE} _solve-package-depends
.endif

a639 10
${WRKPKG}/DESCR${SUBPACKAGE}: ${DESCR}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
	@@echo "\nMaintainer: ${MAINTAINER}" >>$@@
.if defined(HOMEPAGE)
	@@fgrep -q '$${HOMEPAGE}' $? || echo "\nWWW: ${HOMEPAGE}" >>$@@
.endif

${WRKPKG}/mtree.spec: ${MTREE_FILE}
	@@${_SED_SUBST} ${MTREE_FILE}>$@@.tmp && mv -f $@@.tmp $@@

a648 2
${WRKPKG}/INSTALL${SUBPACKAGE}: ${PKGDIR}/INSTALL${SUBPACKAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
a652 2
${WRKPKG}/DEINSTALL${SUBPACKAGE}: ${PKGDIR}/DEINSTALL${SUBPACKAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
a656 2
${WRKPKG}/REQ${SUBPACKAGE}: ${PKGDIR}/REQ${SUBPACKAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
a660 2
${WRKPKG}/MESSAGE${SUBPACKAGE}: ${MESSAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
d666 3
a959 33
makesum: fetch-all
.if !defined(NO_CHECKSUM)
	@@rm -f ${CHECKSUM_FILE}
	@@cd ${DISTDIR} && \
		for cipher in ${_CIPHERS}; do \
			$$cipher ${_CKSUMFILES} >> ${CHECKSUM_FILE}; \
	 done
	@@for file in ${_IGNOREFILES}; do \
		echo "MD5 ($$file) = IGNORE" >> ${CHECKSUM_FILE}; \
	done
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE}
.endif


addsum: fetch-all
.if !defined(NO_CHECKSUM)
	@@touch ${CHECKSUM_FILE}
	@@cd ${DISTDIR} && \
	 	for cipher in ${_CIPHERS}; do \
			$$cipher ${_CKSUMFILES} >> ${CHECKSUM_FILE}; \
	 done
	@@for file in ${_IGNOREFILES}; do \
		echo "MD5 ($$file) = IGNORE" >> ${CHECKSUM_FILE}; \
	done
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE}
	@@if [ `sed -e 's/\=.*$$//' ${CHECKSUM_FILE} | uniq -d | wc -l` -ne 0 ]; then \
		echo "Inconsistent checksum in ${CHECKSUM_FILE}"; \
		exit 1; \
	else \
		${ECHO_MSG} "${CHECKSUM_FILE} updated okay, don't forget to remove cruft"; \
	fi
.endif

a963 1

d1001 228
a1233 1
_FULL_PACKAGE_NAME?=No
a1241 1
_DEP${_DEP}_COOKIES=
a1290 1
_DEP${_DEP}_COOKIES+=${WRKDIR}/.${_DEP}${_i:C,[|:./<=>*],-,g}
a1458 13
# Normal user-mode targets are PHONY targets, e.g., don't create the
# corresponding file. However, there is nothing phony about the cookie.

_INSTALL_DEPS=${_INSTALL_COOKIE}
_PACKAGE_DEPS=${_PACKAGE_COOKIES}
.  if defined(ALWAYS_PACKAGE)
_INSTALL_DEPS+=${_PACKAGE_COOKIES}
.  endif
.  if ${BULK:L} == "yes"
_INSTALL_DEPS+=${_BULK_COOKIE}
_PACKAGE_DEPS+=${_BULK_COOKIE}
.  endif

a1485 2
BULK_TARGETS?=

a1628 11
MODSIMPLE_configure= \
	cd ${WRKBUILD} && ${_SYSTRACE_CMD} ${SETENV} \
		CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
		CXX="${CXX}" ac_cv_path_CXX="${CXX}" CXXFLAGS="${CXXFLAGS}" \
		INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
		ac_given_INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
		INSTALL_PROGRAM="${INSTALL_PROGRAM}" INSTALL_MAN="${INSTALL_MAN}" \
		INSTALL_SCRIPT="${INSTALL_SCRIPT}" INSTALL_DATA="${INSTALL_DATA}" \
		YACC="${YACC}" \
		${CONFIGURE_ENV} ${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS}

a1656 2
VMEM_WARNING?=	No

a1711 2
_FAKE_SETUP=TRUEPREFIX=${PREFIX} PREFIX=${WRKINST}${PREFIX} ${DESTDIRNAME}=${WRKINST}

a1857 2
_CLEANDEPENDS?=Yes

a1929 4
_tmp:=
.  for _v in ${SUBST_VARS}
_tmp += ${_v}='${${_v}}'
.  endfor
d1941 1
a1941 1
	perl ${PORTSDIR}/infrastructure/install/make-plist ${PKGDIR} ${_tmp}
a1953 4
################################################################
# The special package-building targets
# You probably won't need to touch these
################################################################
a1955 13
.if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
_ALLFILES=${ALLFILES:S/^/${DIST_SUBDIR}\//}
.else
_ALLFILES=${ALLFILES}
.endif

_FMN=${PKGPATH}/${FULLPKGNAME}
.if defined(MULTI_PACKAGES)
.  for _S in ${MULTI_PACKAGES}
_FMN+= ${PKGPATH}/${FULLPKGNAME${_S}}
.  endfor
.endif

a2028 29
# Internal variables, used by dependencies targets
# Only keep pkg:dir spec
.if defined(LIB_DEPENDS)
_ALWAYS_DEP2 = ${LIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_ALWAYS_DEP= ${_ALWAYS_DEP2:C/[^:]*://}
.else
_ALWAYS_DEP2=
_ALWAYS_DEP=
.endif

.if defined(RUN_DEPENDS)
_RUN_DEP2 = ${RUN_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_RUN_DEP = ${_RUN_DEP2:C/[^:]*://}
.else
_RUN_DEP2=
_RUN_DEP=
.endif


.if defined(BUILD_DEPENDS)
_BUILD_DEP2 = ${BUILD_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_BUILD_DEP = ${_BUILD_DEP2:C/[^:]*://}
.else
_BUILD_DEP2=
_BUILD_DEP=
.endif

_LIB_DEP2= ${LIB_DEPENDS}

a2096 2

README_NAME?=	${TEMPLATES}/README.port
@


1.596
log
@move variables that only users can tweak, or that are constants, to
the front of bsd.port.mk.

This allows Makefile.inc and modules to use them more easily, and also
cleans up things slightly.

Also kill .include ${PORTSDIR}/../Makefile.inc (???)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.595 2004/01/04 09:07:19 sturm Exp $
d171 1
a171 2
.else
.if exists(${.CURDIR}/Makefile.${MACHINE_ARCH})
a172 1
.endif
@


1.595
log
@use WRKDIR instead of WRKOBJDIR for systrace, as the latter is not defined
unconditionally

found by Michael Coulter <mjc at bitz dot ca>
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.594 2003/12/26 00:26:01 espie Exp $
d63 51
a145 2
TRUST_PACKAGES?=No
BIN_PACKAGES?=No
a149 18
# Get the architecture
ARCH!=	uname -m

# Get the operating system type and version
OPSYS=	OpenBSD
OPSYS_VER=	${OSREV}

NO_SHARED_ARCHS=hppa m88k vax

# Define NO_SHARED_LIBS for those machines that don't support shared libraries.
.for _m in ${MACHINE_ARCH}
.  if !empty(NO_SHARED_ARCHS:M${_m})
NO_SHARED_LIBS=	Yes
.  endif
.endfor

CLEANDEPENDS?=No

a180 7
# These need to be absolute since we don't know how deep in the ports
# tree we are and thus can't go relative.  They can, of course, be overridden
# by individual Makefiles or local system make configuration.
PORTSDIR?=		/usr/ports
LOCALBASE?=		/usr/local
X11BASE?=		/usr/X11R6
DISTDIR?=		${PORTSDIR}/distfiles
a185 5
PKGREPOSITORYBASE?=	${PORTSDIR}/packages/${MACHINE_ARCH}
TEMPLATES?=		${PORTSDIR}/infrastructure/templates

CDROM_PACKAGES?=	${PKGREPOSITORYBASE}/cdrom
FTP_PACKAGES?=		${PKGREPOSITORYBASE}/ftp
d202 1
a202 1
.if exists(${.CURDIR}/scripts.${MACHINE_ARCH})
d204 1
a204 1
.else
d206 1
a206 1
.endif
a266 4
.if exists(${PORTSDIR}/../Makefile.inc)
.include "${PORTSDIR}/../Makefile.inc"
.endif

a347 3
PKGREPOSITORY?=		${PKGREPOSITORYBASE}/all
PKG_DBDIR?=		/var/db/pkg
BULK_COOKIES_DIR?= ${PORTSDIR}/bulk/${MACHINE_ARCH}
a443 2
FETCH_CMD?=		/usr/bin/ftp -V -m

a458 1
PATCH_CHECK_ONLY?=No
a593 1
USE_SYSTRACE?=	No
a717 4
PKG_TMPDIR?=	/var/tmp
PKG_CMD?=		/usr/sbin/pkg_create
PKG_DELETE?=	/usr/sbin/pkg_delete

a1282 5
# Set to true to try to retrieve older distfiles from ftp.openbsd.org if
# checksums no longer match.

REFETCH?=false

a1353 1
BULK?=No
a1633 2
PROTECT_MOUNT_POINTS?=

a1845 2

RECURSIVE_FETCH_LIST?=	Yes
@


1.594
log
@Report files and directories installed in WRKINST outside of PREFIX,
usually a good indication the fake process is screwing up.
Okay naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.593 2003/12/24 00:08:48 espie Exp $
d595 1
a595 1
SYSTRACE_SUBST_VARS+=	WRKOBJDIR PORTSDIR DISTDIR
@


1.593
log
@Use somewhat dirty trick.
Repairs mirror-maker for multiple MASTER_SITES.
Noticed by naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.592 2003/12/16 19:05:23 espie Exp $
d1874 1
@


1.592
log
@two
if cmd; then ;; else cmd2; fi  -> if ! cmd; then cmd2; fi
I missed
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.591 2003/12/15 17:56:40 espie Exp $
d1931 1
a1931 1
		${MAKE} _fetch-onefile _F=${_F}; \
d1939 2
d1943 1
a1943 1
.if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
d1945 1
a1945 1
.endif
d1950 1
a1950 1
.if ${FETCH_MANUALLY:L} != "no"
d1952 2
a1953 2
.endif
.if !defined(NO_CHECKSUM) && !empty(_CKSUMFILES:M${_F})
d1974 1
a1974 1
.endif
d1976 1
@


1.591
log
@Check for duplicates in mirror-maker entries, build Makefiles that won't
heap tons of warnings with gnu-make (and that will be slightly smaller as well).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.590 2003/12/11 08:55:24 espie Exp $
d2206 1
a2206 1
		if fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then :; else \
d2217 1
a2217 1
		if fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then :; else \
@


1.590
log
@Kill the recursive part of package dependencies recording, since the
new pkg_add deals computes recursive dependencies on the fly.

okay naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.589 2003/11/22 12:03:44 espie Exp $
d1929 10
d1941 1
a1941 1
.    if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
d1943 1
a1943 1
.    endif
d1948 1
a1948 1
.    if ${FETCH_MANUALLY:L} != "no"
d1950 2
a1951 2
.    endif
.    if !defined(NO_CHECKSUM) && !empty(_CKSUMFILES:M${_F})
d1972 1
a1972 1
.    endif
a1973 3
.  endfor
.endif
	@@echo
d2434 1
a2434 1
	_build-dir-depends _delete-package-links _fetch-makefile \
@


1.589
log
@zap some packing-lists sanity check. These are now donw by pkg_create
in a more precise and faster way.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.588 2003/09/28 10:57:01 espie Exp $
d694 1
a694 1
	self=${FULLPKGNAME${SUBPACKAGE}} _depends_result=$@@ ${MAKE} _recurse-solve-package-depends
d2220 1
a2220 1
_recurse-solve-package-depends:
d2228 1
a2228 9
		echo "@@newdepend $$self:$$pkg:$$default" >>$${_depends_result}; \
		if fgrep -q "|$$default|" $${_DEPENDS_FILE}; then : ; else \
			echo "|$$default|" >>$${_DEPENDS_FILE}; \
			toset="$$toset self=\"$$default\""; \
			if ! eval $$toset ${MAKE} _recurse-solve-package-depends; then  \
				echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
				exit 1; \
			fi; \
		fi; }
a2260 8
			if ! fgrep -q "|$$default|" $${_DEPENDS_FILE}; then \
				echo "lib|$$default|" >>$${_DEPENDS_FILE}; \
				toset="$$toset self=\"$$default\""; \
				if ! eval $$toset ${MAKE} _recurse-solve-package-depends; then  \
					echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
					exit 1; \
				fi; \
			fi;; \
d2430 1
a2430 1
	_recurse-run-dir-depends _recurse-solve-package-depends _refetch \
@


1.588
log
@set PACKAGING in RUN_DEPENDS, to avoid picking up bogus subpackages
dependencies.

Tests by sturm@@, noticed by pval@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.587 2003/08/28 23:42:44 naddy Exp $
a1676 4
	@@if ${SUDO} find ${WRKINST} -type l -ls|fgrep -- '-> ${WRKINST}'; then \
		echo >&2 "*** bad links in ${WRKINST}"; \
		exit 1; \
	fi
a1717 7
# PLIST should normally hold no duplicates.
# This is left as a warning, because stuff such as @@exec %F/%D
# completion may cause legitimate dups.
	@@duplicates=`sort <${WRKPKG}/PLIST${SUBPACKAGE}|egrep -v '@@(comment|mode|owner)'|uniq -d`; \
	case "$${duplicates}" in "");; \
		*) echo "\n*** WARNING *** Duplicates in PLIST:\n$$duplicates\n";; \
	esac
@


1.587
log
@* force uninstall in reinstall
* fix typo in clean=install handling

discussed with sturm@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.586 2003/08/28 16:19:00 sturm Exp $
d2315 1
a2315 1
		self=${FULLPKGPATH} ${MAKE} _recurse-run-dir-depends; \
@


1.586
log
@don't try to fetch distfiles of ports marked FETCH_MANUALLY

ok naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.585 2003/08/21 20:22:45 espie Exp $
d1834 1
a1834 1
	-${SUDO} ${PKG_DELETE} ${clean:M-f} ${FULLPKGNAME${_s}}
d1837 1
a1837 1
	-${SUDO} ${PKG_DELETE} ${clean:M-f} ${FULLPKGNAME${SUBPACKAGE}}
d2428 1
a2428 1
	@@cd ${.CURDIR} && exec ${MAKE} clean=install
@


1.585
log
@Add FAKEOBJDIR support
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.584 2003/08/15 00:04:45 espie Exp $
d1949 3
@


1.584
log
@Use -S${WRKINST} for pkg_create.
YOU MUST HAVE A CURRENT pkg_create FOR THIS TO WORK !!!
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.583 2003/08/14 15:29:20 naddy Exp $
a96 1
WRKINST?=${WRKDIR}/fake-${ARCH}${_FLAVOR_EXT2}
d462 6
@


1.583
log
@Fix a typo that caused ports marked with FETCH_MANUALLY always to be skipped
for BATCH=Yes.  Reported by Kurt Miller <truk@@optonline.net>.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.582 2003/08/13 19:41:01 espie Exp $
d741 1
a741 1
PKG_ARGS+=		-s ${WRKINST}${PREFIX}
@


1.582
log
@missed two readme, thanks Nick.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.581 2003/08/11 20:10:41 espie Exp $
d956 1
a956 1
.  for _F in ${ALLFILES:S@@^@@${FULLDISTDIR}@@}
@


1.581
log
@advisory license-check: warns if a package is apparently built from bad
sources.  Will returns some false positives.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.580 2003/08/11 20:07:59 espie Exp $
d2074 1
a2074 1
	@@cd ${.CURDIR} && SUBPACKAGE='${SUBPACKAGE}' FLAVOR='${FLAVOR}' PACKAGING='${SUBPACKAGE}' exec ${MAKE} readme
d2077 1
a2077 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' PACKAGING='${_sub}' exec ${MAKE} readme
@


1.580
log
@make sure the site selector has an entry for each :<digit>, ensuring
incorrect entries will be spotted.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.579 2003/08/11 18:42:07 sturm Exp $
d1216 1
a1216 1
uninstall deinstall fake package lib-depends-check manpages-check:
d2158 19
d2479 2
a2480 1
	update-plist
@


1.579
log
@Unconditionally use do-extract and create that target in case it doesn't
exist with the old, regular EXTRACT_CASES stuff. This allows for systrace
protected extracts.

espie@@ ok
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.578 2003/08/04 14:37:10 espie Exp $
d801 2
@


1.578
log
@move _depfile_fragment to pkgpath.mk so that it can be reused more widely.
Fix the logic so that the file is only removed where it is set.
Add some checks to *-dir-depends for more `global situations'.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.577 2003/08/04 14:00:46 espie Exp $
d588 2
a589 2
_SYSTRACE_POLICIES+=	/bin/sh /bin/tar /usr/bin/env /usr/bin/make \
	${LOCALBASE}/bin/gmake ${LOCALBASE}/bin/unzip
a1410 1
.if target(do-extract)
d1412 7
a1418 1
.else
a1427 5
.if target(post-extract)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-extract
.endif
	@@${_MAKE_COOKIE} $@@

@


1.577
log
@Use trap to remove _DEPENDS_FILE, so that it does not stay around.
Since all the code is now in one chunk, put it into _depfile_fragment.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.576 2003/08/04 13:25:36 espie Exp $
a1071 5
_depfile_fragment= \
	: $${_DEPENDS_FILE:=`mktemp /tmp/depends.XXXXXXXXX|| exit 1`}; \
	export _DEPENDS_FILE; \
	trap "rm -f $${_DEPENDS_FILE}" 0 1 2 3 13 15

d2211 2
a2212 2
		if fgrep -q "|$$default|" ${_DEPENDS_FILE}; then : ; else \
			echo "|$$default|" >>${_DEPENDS_FILE}; \
d2251 2
a2252 2
			if ! fgrep -q "|$$default|" ${_DEPENDS_FILE}; then \
				echo "lib|$$default|" >>${_DEPENDS_FILE}; \
d2269 2
a2270 2
	if ! fgrep -q "|${_dir}|" ${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >> ${_DEPENDS_FILE}; \
d2284 4
a2287 2
	echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
	self=${FULLPKGPATH} ${MAKE} _recurse-run-dir-depends
d2298 2
a2299 2
	if ! fgrep -q "|${_dir}|" ${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >> ${_DEPENDS_FILE}; \
d2315 2
a2316 2
	if ! fgrep -q "|${_dir}|" ${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >> ${_DEPENDS_FILE}; \
d2330 4
a2333 2
	echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
	self=${FULLPKGPATH} ${MAKE} _build-dir-depends
d2341 4
a2344 2
	echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
	self=${FULLPKGPATH} ${MAKE} _recurse-all-dir-depends
@


1.576
log
@kill old readme (useless distinction).
Let make clean=readmes work.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.575 2003/08/02 09:53:27 espie Exp $
d687 1
a687 2
	@@: $${_DEPENDS_FILE:=`mktemp /tmp/depends.XXXXXXXXXX`}; \
	export _DEPENDS_FILE; \
d689 1
a689 2
	self=${FULLPKGNAME${SUBPACKAGE}} _depends_result=$@@ ${MAKE} _recurse-solve-package-depends; \
	rm -f $${_DEPENDS_FILE}
d1072 5
d1234 3
a1236 1
	@@_DEPENDS_FILE=`mktemp /tmp/depends.XXXXXXXXX`; export _DEPENDS_FILE; LIB_DEPENDS="`${MAKE} _recurse-lib-depends-check`" PKG_DBDIR='${PKG_DBDIR}' \
d1238 1
a1238 2
		${_LIBLIST} ${_BUILDLIBLIST}; \
	rm -f ${_DEPENDS_FILE}
d2288 1
a2288 2
	@@: $${_DEPENDS_FILE:=`mktemp /tmp/depends.XXXXXXXXXX`}; \
	export _DEPENDS_FILE; \
d2290 1
a2290 2
	self=${FULLPKGPATH} ${MAKE} _recurse-run-dir-depends; \
	rm -f $${_DEPENDS_FILE}
d2332 1
a2332 2
	@@: $${_DEPENDS_FILE:=`mktemp /tmp/depends.XXXXXXXXXX`}; \
	export _DEPENDS_FILE; \
d2334 1
a2334 2
	self=${FULLPKGPATH} ${MAKE} _build-dir-depends; \
	rm -f $${_DEPENDS_FILE}
d2341 1
a2341 2
	@@: $${_DEPENDS_FILE:=`mktemp /tmp/depends.XXXXXXXXXX`}; \
	export _DEPENDS_FILE; \
d2343 1
a2343 2
	self=${FULLPKGPATH} ${MAKE} _recurse-all-dir-depends; \
	rm -f $${_DEPENDS_FILE}
@


1.575
log
@put _flavor_fragment into a separate file, that's included from both
bsd.port.mk and bsd.port.subdir.mk. Make sure flavors are properly
separated.

Change the way bsd.port.subdir.mk works, slightly: always set full directories.
- SKIPDIR with full paths will work.
- all dirs are displayed as full package specs.

Generate complete html files.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.574 2003/08/01 09:07:06 espie Exp $
d1845 6
d2071 1
a2071 1
readme readmes:
d2454 1
a2454 1
	readme readmes rebuild \
@


1.574
log
@minor fixes to readme
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.573 2003/08/01 09:02:42 espie Exp $
d541 1
a541 5
.if !defined(PKGPATH)
_PORTSDIR!=	cd ${PORTSDIR} && pwd -P
_CURDIR!=	cd ${.CURDIR} && pwd -P
PKGPATH=${_CURDIR:S,${_PORTSDIR}/,,}
.endif
a542 1
PKGDEPTH=${PKGPATH:C|[^./][^/]*|..|g}
a1070 38
# Code to invoke to split dir,-multi,flavor

_flavor_fragment= \
		multi=''; flavor=''; sawflavor=false; \
		case "$$dir" in \
		*,*) \
			IFS=,; first=true; for i in $$dir; do \
				if $$first; then \
					dir=$$i; first=false; \
				else \
					case X"$$i" in \
						X-*) \
							multi="$$i";; \
						*) \
							sawflavor=true; \
							flavor="$$flavor $$i";; \
					esac \
				fi; \
			done; unset IFS;; \
		esac; \
		toset="PKGPATH=$$dir"; \
		case X$$multi in "X");; *) \
			toset="$$toset SUBPACKAGE=\"$$multi\"";; \
		esac; \
		if $$sawflavor; then \
			toset="$$toset FLAVOR=\"$$flavor\""; \
		fi; \
		cd ${PORTSDIR}; \
		if [ -L $$dir ]; then \
			echo 1>&2 ">> Broken dependency: $$dir is a symbolic link"; \
			exit 1; \
		fi; \
		if cd $$dir 2>/dev/null || cd mystuff/$$dir 2>/dev/null; then \
			:; \
		else \
			echo 1>&2 ">> Broken dependency: $$dir non existent"; \
			exit 1; \
		fi
a2078 2
HTMLIFY=	sed -e 's/&/\&amp;/g' -e 's/>/\&gt;/g' -e 's/</\&lt;/g'

d2087 17
d2109 1
a2109 1
			echo "<li><a href=\"${PKGDEPTH}/$$j/$$k.html\">$$k</a>"; \
d2123 1
@


1.573
log
@if cmd; then : else -> if ! cmd; then
suggested by naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.572 2003/08/01 08:29:43 espie Exp $
d2125 1
a2125 1
	@@echo ${_COMMENT} >$@@.tmp-comment
d2140 1
a2140 1
	@@echo "<li>none" >$@@.tmp${_I}
d2144 1
a2144 1
		sed -e 's|%%PORT%%|'"`echo ${PKGPATH}  | ${HTMLIFY}`"'|g' \
d2147 1
a2147 1
			-e '/%%DESCR%%/r${PKGDIR}/DESCR' -e '//d' \
@


1.572
log
@show libraries BEFORE testing that we already recursed in that dir.
Problem found by marc_m@@.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.571 2003/08/01 08:20:43 espie Exp $
d2273 1
a2273 1
			if fgrep -q "|$$default|" ${_DEPENDS_FILE}; then : ; else \
d2291 1
a2291 1
	if fgrep -q "|${_dir}|" ${_DEPENDS_FILE}; then : ; else \
d2320 1
a2320 1
	if fgrep -q "|${_dir}|" ${_DEPENDS_FILE}; then : ; else \
d2337 1
a2337 1
	if fgrep -q "|${_dir}|" ${_DEPENDS_FILE}; then : ; else \
@


1.571
log
@too eager in unsetting FLAVOR, problem found by jolan@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.570 2003/08/01 08:07:30 espie Exp $
d2202 1
a2205 1
			IFS=,; for j in $$dep; do echo $$j; done; \
@


1.570
log
@get thru _clean to handle clean, since it's set in stone.
Add work if only depends is set.
problem found by naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.569 2003/07/30 19:59:48 espie Exp $
d1836 2
a1837 2
	@@unset FLAVOR SUBPACKAGE || true; \
	${MAKE} all-dir-depends|tsort -r|while read dir; do \
d2171 2
a2172 2
	@@unset FLAVOR SUBPACKAGE || true; \
	${MAKE} ${_i}-dir-depends|tsort -r|sed -e '$$d'|while read dir; do \
@


1.569
log
@pull a few more targets out of user-visible space.
Sprinkle a few more cd ${.CURDIR} && exec
move distclean into convenience targets area.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.568 2003/07/30 19:51:11 espie Exp $
d120 6
a125 1
clean?=work
d127 1
a127 1
clean+=depends
d129 2
a130 2
.if ${clean:L:Mwork}
clean+=fake
d132 2
a133 2
.if ${clean:L:Mforce}
clean+=-f
d1835 1
a1835 1
.if ${clean:L:Mdepends} && ${_CLEANDEPENDS:L} == "yes"
d1843 1
a1843 1
.  if ${clean:L:Mfake}
d1846 2
a1847 2
.  if ${clean:L:Mwork}
.    if ${clean:L:Mflavors}
d1857 1
a1857 1
.  if ${clean:L:Mdist}
d1868 2
a1869 2
.  if ${clean:L:Minstall}
.    if ${clean:L:Msub}
d1877 1
a1877 1
.  if ${clean:L:Mpackages} || ${clean:L:Mpackage} && ${clean:L:Msub}
d1884 1
a1884 1
.  elif ${clean:L:Mpackage}
d1888 1
a1888 1
.  if ${clean:L:Mbulk}
@


1.568
log
@redo the list of phony targets, in alphabetical order
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.567 2003/07/30 19:31:31 espie Exp $
d513 1
a513 1
	@@${MAKE} ${_PACKAGE_COOKIE_DEPS}
d527 1
a527 1
	@@${MAKE} ${_PACKAGE_COOKIE_DEPS}
d1363 1
a1363 1
		  	cd ${.CURDIR} && ${MAKE} refetch _PROBLEMS="$$list"; \
d1375 1
a1375 1
refetch:
d1377 3
a1379 3
		@@rm ${DISTDIR}/${file}
		@@cd ${.CURDIR} && ${MAKE} ${DISTDIR}/${file} \
			MASTER_SITE_OVERRIDE="ftp://ftp.openbsd.org/pub/OpenBSD/distfiles/${cipher}/${value}/"
d1431 1
a1431 1
	@@exec ${MAKE} ${_i} ${BULK_FLAGS}
d1433 1
a1433 1
	@@exec ${SUDO} ${MAKE} clean
d1764 1
a1764 1
	    ${MAKE} package-links; \
d1806 2
a1807 2
package-links:
	@@cd ${.CURDIR} && exec ${MAKE} delete-package-links
d1820 1
a1820 1
delete-package-links:
d1876 1
a1876 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' exec ${MAKE} delete-package-links
d1880 1
a1880 1
	@@cd ${.CURDIR} && exec ${MAKE} delete-package-links
a1887 3
distclean:
	@@${MAKE} clean=dist

d2407 4
a2410 1
	@@exec ${MAKE} clean=depends
d2442 5
a2446 3
	_build-dir-depends _fetch-makefile _package \
	_print-packagename _recurse-all-dir-depends _recurse-run-dir-depends \
	_recurse-solve-package-depends _recursive-lib-depends-check addsum \
d2451 2
a2452 1
	delete-package delete-package-links depends \
d2462 1
a2462 1
	package package-links patch \
d2471 1
a2471 1
	refetch regress regress-depends \
@


1.567
log
@clean-up and speed-up dependency generation.
thanks to nikolay, naddy, and others for comments.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.565 2003/07/28 17:17:04 sturm Exp $
d2442 31
a2472 21
   addsum all build build-depends regress regress-depends checkpatch \
   checksum clean clean-depends configure deinstall \
   delete-package delete-package-links depends depends-list \
   describe distclean do-build do-configure do-extract \
   do-fetch do-install do-package do-patch extract list-distfiles \
   fetch install lib-depends makesum \
   package package-depends package-links \
   package-noinstall patch plist update-plist update-patches post-build \
   post-configure post-extract post-fetch post-install post-package \
   post-patch pre-build pre-configure \
   pre-extract pre-fetch pre-install pre-package pre-patch \
   readme readmes rebuild reinstall \
   repackage run-depends uninstall fetch-all print-depends \
   recurse-build-depends recurse-package-depends \
   distpatch do-distpatch post-distpatch show \
   link-categories unlink-categories _package \
   lib-depends-check homepage-links manpages-check \
   _recurse-lib-depends-check _recurse-solve-package-depends \
   _recurse-run-dir-depends run-dir-depends _recurse-all-dir-depends \
   _build-dir-depends build-dir-depends all-dir-depends \
   fetch-makefile _fetch-makefile
@


1.566
log
@quote pkg to protect wildcards against shell (e.g., bzip2-*).
It didn't use to happen, but I just had bzip2-* matching against
bzip2-1.0.2.html
@
text
@a46 2
# readme		- Create a README.html file describing the category or package
#				  (somewhat broken due to NEW_DEPENDS)
a47 11

# Somewhat obsolete targets:
# list-distfiles- list the distribution and patch files used by a port.
#				  Typical use is (from the top level of the ports tree)
#				  make ECHO_MSG=: list-distfiles | tee some-file
#				  (rely on mirror-maker instead)
# print-depends - print all dependencies for the given package
#				  (for new dependencies, use
#				  build-depends-list/run-depends-list instead)
#
#
d684 9
a692 2
	@@touch $@@
	@@self=${FULLPKGNAME${SUBPACKAGE}} _depends_result=$@@ exec ${MAKE} _solve-package-depends
a709 1
_SORT_DEPENDS?=tsort|tail -r
a766 3
# XXX
_DEPEND_ECHO?=		echo

d840 1
a840 1
.if make(makesum) || make(addsum) || make(list-distfiles) || defined(__FETCH_ALL)
d1152 1
d1154 3
d1158 1
d1200 1
a1200 1
			if eval $$toset ${MAKE} ${_DEPEND_THRU} $$target; then \
d1269 1
a1269 1
	@@LIB_DEPENDS="`${MAKE} _recurse-lib-depends`" PKG_DBDIR='${PKG_DBDIR}' \
d1271 2
a1272 1
		${_LIBLIST} ${_BUILDLIBLIST}
a1803 16
# list the distribution and patch files used by a port.  Typical
# use is		make ECHO_MSG=: list-distfiles | tee some-file
#
list-distfiles:
	@@echo "${FULLPKGNAME}"
	@@for file in ${ALLFILES}; do \
		if [ "$$file" != "${EXTRACT_SUFX}" ]; then \
			if [ -z "${DIST_SUBDIR}" ]; then \
				printf "\t$$file\n"; \
			else \
				printf "\t${DIST_SUBDIR}/$$file\n"; \
			fi \
		fi \
	 done
	@@echo ""

d1825 1
a1825 37
delete-package:
	@@cd ${.CURDIR} && exec ${MAKE} clean=package

# Checkpatch
#
# Special target to verify patches

checkpatch:
	@@cd ${.CURDIR} && exec ${MAKE} PATCH_CHECK_ONLY=Yes patch

# Reinstall
#
# Special target to re-run install

reinstall:
	@@cd ${.CURDIR} && exec ${MAKE} clean=install
	@@cd ${.CURDIR} && DEPENDS_TARGET=${DEPENDS_TARGET} exec ${MAKE} install

# Force rebuild of a package
repackage:
	@@cd ${.CURDIR} && exec ${MAKE} clean=packages
	@@cd ${.CURDIR} && exec ${MAKE} package

# Rebuild
#
# Special target to re-run build
rebuild:
	@@rm -f ${_BUILD_COOKIE}
	@@cd ${.CURDIR} && exec ${MAKE} build

# Deinstall
#
# Special target to remove installation

uninstall deinstall:
	@@${ECHO_MSG} "===> Deinstalling for ${FULLPKGNAME${SUBPACKAGE}}"
	@@${SUDO} ${PKG_DELETE} -f ${FULLPKGNAME${SUBPACKAGE}}
d1827 1
a1827 6

################################################################
# Some more targets supplied for users' convenience
################################################################

# Cleaning up
d1830 7
a1836 3
.if ${clean:L:Mdepends}
	@@cd ${.CURDIR} && exec ${MAKE} clean-depends
.endif
d1838 1
a1838 1
.if ${clean:L:Mfake}
d1840 3
a1842 3
.endif
.if ${clean:L:Mwork}
.  if ${clean:L:Mflavors}
d1847 1
a1847 1
.  else
d1850 1
d1852 1
a1852 2
.endif
.if ${clean:L:Mdist}
d1859 1
a1859 1
.  if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
d1861 1
d1863 3
a1865 4
.endif
.if ${clean:L:Minstall}
.  if ${clean:L:Msub}
.    for _s in ${MULTI_PACKAGES}
d1867 2
a1868 2
.    endfor
.  else
d1870 1
d1872 1
a1872 2
.endif
.if ${clean:L:Mpackages} || ${clean:L:Mpackage} && ${clean:L:Msub}
d1874 2
a1875 2
.  if defined(MULTI_PACKAGES)
.    for _s in ${MULTI_PACKAGES}
d1877 3
a1879 3
.    endfor
.  endif
.elif ${clean:L:Mpackage}
d1882 2
a1883 2
.endif
.if ${clean:L:Mbulk}
d1885 1
d1909 1
a1909 1
	DEPS="`${MAKE} package-depends|tsort`" \
d1939 7
d1955 9
a1963 2
	@@echo ":: ${PKGPATH}/${FULLPKGNAME}"
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes _fetch-makefile-helper
d1966 1
a1966 8
_fetch-makefile-helper:
# write generic package dependencies
	@@name='${PKGPATH}/${FULLPKGNAME}'; \
	echo ".PHONY: $${name}"; \
	case '${RECURSIVE_FETCH_LIST:L}' in yes) \
	  echo "$${name}:: "`${MAKE} depends-list package-depends FULL_PACKAGE_NAME=Yes |${_SORT_DEPENDS}`;; \
	esac; \
	echo "$${name}:: ${_ALLFILES}"
a2005 15
# The README.html target needs full information (this is passed via
# depends-list and package-depends)
FULL_PACKAGE_NAME?=No

# Make variables to pass along on recursive builds
_DEPEND_THRU=FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME}

# XXX
package-name:
.  if (${FULL_PACKAGE_NAME:L} == "yes")
	@@${_DEPEND_ECHO} '${PKGPATH}/${FULLPKGNAME${SUBPACKAGE}}'
.  else
	@@${_DEPEND_ECHO} '${FULLPKGNAME${SUBPACKAGE}}'
.  endif

a2034 20
_clean-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
	@@unset FLAVOR SUBPACKAGE || true; \
	for dir in ${_ALWAYS_DEP} ${_RUN_DEP} ${_BUILD_DEP}; do \
		if fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then :; else \
			echo "|$$dir|" >>$${_DEPENDS_FILE}; \
			${_flavor_fragment}; \
			eval $$toset ${MAKE} CLEANDEPENDS=No ${_DEPEND_THRU} clean _clean-depends; \
		fi; \
	done
.endif

clean-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
	@@: $${_DEPENDS_FILE:=`mktemp /tmp/depends.XXXXXXXXXX`}; \
	export _DEPENDS_FILE; \
	${MAKE} _clean-depends; \
	rm -f $${_DEPENDS_FILE}
.endif

d2043 1
a2043 1
.if !defined(PACKAGING) && defined(MULTI_PACKAGES)
d2045 5
d2102 8
a2109 1
.  if defined(MULTI_PACKAGES) && empty(SUBPACKAGE)
d2111 1
a2111 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' PACKAGING='${_sub}' exec ${MAKE} describe
d2114 3
d2120 4
a2123 1
README.html:
a2124 6
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
	@@cd ${.CURDIR} && ${MAKE} depends-list FULL_PACKAGE_NAME=Yes | ${_SORT_DEPENDS}>$@@.tmp1
.endif
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
	@@cd ${.CURDIR} && ${MAKE} package-depends FULL_PACKAGE_NAME=Yes | ${_SORT_DEPENDS} >$@@.tmp2
.endif
d2130 4
a2133 3
.for I in 1 2
	@@if [ -s $@@.tmp$I ]; then \
		{ cat $@@.tmp$I | while read n; do \
d2135 5
a2139 5
			echo "<li><a href=\"${PKGDEPTH}/$$j/README.html\">$$k</a>"; \
		 done; } >$@@.tmp$Ia; \
    else \
    echo "<li>(none)" > $@@.tmp$Ia; \
	fi
d2144 1
a2144 1
			-e '/%%COMMENT%%/r${PKGDIR}/COMMENT' -e '//d' \
d2147 2
a2148 2
			-e '/%%BUILD_DEPENDS%%/r$@@.tmp1a' -e '//d' \
			-e '/%%RUN_DEPENDS%%/r$@@.tmp2a' -e '//d' \
d2152 2
a2153 1
print-depends-list:
d2156 1
a2156 2
	@@unset FLAVOR SUBPACKAGE || true; \
	echo -n `cd ${.CURDIR} && ${MAKE} ${_DEPEND_THRU} depends-list | ${_SORT_DEPENDS}`
d2160 1
a2160 1
print-package-depends:
d2163 1
a2163 2
	@@unset FLAVOR SUBPACKAGE || true; \
	echo -n `cd ${.CURDIR} && ${MAKE} ${_DEPEND_THRU} package-depends | ${_SORT_DEPENDS}`
d2167 4
a2170 7

recurse-build-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
	@@pname=`cd ${.CURDIR} && ${MAKE} _DEPEND_ECHO='echo -n' package-name ${_DEPEND_THRU}`; \
	unset FLAVOR SUBPACKAGE || true; \
	for dir in `echo ${_ALWAYS_DEP} ${_BUILD_DEP} ${_RUN_DEP} \
		| tr '\040' '\012' | sort -u`; do \
d2172 1
a2172 4
		if ! eval $$toset ${MAKE} _DEPEND_ECHO=\"echo $$pname\" package-name recurse-build-depends ${_DEPEND_THRU}; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
d2174 1
a2174 3
.else
	@@pname=`cd ${.CURDIR} && ${MAKE} _DEPEND_ECHO='echo -n' package-name`; echo $$pname $$pname
.endif
d2176 3
a2178 2
depends-list:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
d2180 5
a2184 1
	for dir in `echo ${_ALWAYS_DEP} ${_BUILD_DEP} \
d2186 5
a2190 7
		${_flavor_fragment}; \
		if ! eval $$toset ${MAKE} recurse-build-depends ${_DEPEND_THRU}; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
	done
.endif
d2192 1
a2192 16
# Build (recursively) a list of package dependencies suitable for tsort
recurse-package-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
	@@pname=`cd ${.CURDIR} && ${MAKE} _DEPEND_ECHO='echo -n' package-name ${_DEPEND_THRU}`; \
	unset FLAVOR SUBPACKAGE || true; \
	for dir in `echo ${_ALWAYS_DEP} ${_RUN_DEP} \
		| tr '\040' '\012' | sort -u`; do \
		${_flavor_fragment}; \
		if ! eval $$toset ${MAKE} _DEPEND_ECHO=\"echo $$pname\" package-name recurse-package-depends ${_DEPEND_THRU}; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
			exit 1; \
		fi; \
	done
.else
	@@pname=`cd ${.CURDIR} && ${MAKE} _DEPEND_ECHO='echo -n' package-name`; echo $$pname $$pname
.endif
d2194 2
a2195 2
# Print list of all libraries we're allowed to depend upon.
_recurse-lib-depends:
d2200 6
a2205 3
		${_flavor_fragment}; \
		IFS=,; for j in $$dep; do echo $$j; done; \
		eval $$toset ${MAKE} ${_DEPEND_THRU} _recurse-lib-depends; \
d2212 5
a2216 2
		${_flavor_fragment}; \
		eval $$toset ${MAKE} ${_DEPEND_THRU} _recurse-lib-depends; \
d2220 4
a2223 2
package-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
d2225 2
a2226 2
	for dir in `echo ${_ALWAYS_DEP} ${_RUN_DEP} \
		| tr '\040' '\012' | sort -u`; do \
d2228 14
a2241 10
		if ! eval $$toset ${MAKE} recurse-package-depends ${_DEPEND_THRU}; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
			exit 1; \
		fi; \
	done
.endif

# recursively build a list of dirs to pass to tsort...
_recurse-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
d2243 2
a2244 4
	for dir in `echo ${_ALWAYS_DEP} ${_BUILD_DEP} ${_RUN_DEP} \
		| tr '\040' '\012' | sort -u`; do \
		echo "$$self $$dir"; \
		self2="$$dir"; \
d2246 8
a2253 4
		toset="$$toset self=\"$$self2\""; \
		if ! eval $$toset ${MAKE} _recurse-dir-depends ${_DEPEND_THRU}; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
d2255 27
a2281 1
	done
d2284 3
a2286 3
# recursively build a list of dirs to pass to tsort...
dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
d2288 4
a2291 4
	for dir in `echo ${_ALWAYS_DEP} ${_BUILD_DEP} \
		| tr '\040' '\012' | sort -u`; do \
		echo "${FULLPKGPATH} $$dir"; \
		self2="$$dir"; \
d2293 2
a2294 2
		toset="$$toset self=\"$$self2\""; \
		if ! eval $$toset ${MAKE} _recurse-dir-depends ${_DEPEND_THRU}; then  \
d2298 10
a2307 1
	done
d2312 4
a2315 19
.for _i in RUN BUILD LIB
${_i:L}-depends-list:
.  if !empty(_${_i}_DEP2)
	@@unset FLAVOR SUBPACKAGE || true; \
	: $${_INITIAL_ECHO:='echo -n "This port requires \""'}; \
	: $${_ECHO='echo -n'}; \
	: $${_FINAL_ECHO:='echo "\" for ${_i:L}."'}; space=''; \
	eval $${_INITIAL_ECHO}; \
	for spec in `echo '${_${_i}_DEP2}' \
		| tr '\040' '\012' | sort -u`; do \
		$${_ECHO} "$$space$${spec}"; \
		space=' '; \
	done; eval $${_FINAL_ECHO}
.  endif
.endfor

# recursively build a list of dirs to pass to tsort...
_package-recurse-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
d2317 4
a2320 4
	for dir in `echo ${_ALWAYS_DEP} ${_RUN_DEP} \
		| tr '\040' '\012' | sort -u`; do \
		echo "$$self $$dir"; \
		self2="$$dir"; \
d2322 2
a2323 2
		toset="$$toset self=\"$$self2\""; \
		if ! eval $$toset ${MAKE} _package-recurse-dir-depends ${_DEPEND_THRU}; then  \
d2327 2
a2328 2
	done
.endif
d2330 3
a2332 3
# recursively build a list of dirs to pass to tsort...
package-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
d2334 4
a2337 4
	for dir in `echo ${_ALWAYS_DEP} ${_RUN_DEP} \
		| tr '\040' '\012' | sort -u`; do \
		echo "${FULLPKGPATH} $$dir"; \
		self2="$$dir"; \
d2339 2
a2340 2
		toset="$$toset self=\"$$self2\""; \
		if ! eval $$toset ${MAKE} _package-recurse-dir-depends ${_DEPEND_THRU}; then  \
d2344 10
a2353 1
	done
d2358 9
a2366 58
_solve-package-depends:
.if !empty(_RUN_DEP2)
	@@unset FLAVOR SUBPACKAGE || true; \
	: $${self:=self}; \
	for spec in `echo '${_RUN_DEP2}' \
		| tr '\040' '\012' | sort -u`; do \
		dir=$${spec#*:}; pkg=$${spec%:*}; \
		${_flavor_fragment}; \
		default=`eval $$toset ${MAKE} _print-packagename`; \
		: $${pkg:=$$default}; \
		echo "@@newdepend $$self:$$pkg:$$default" >>$${_depends_result}; \
		toset="$$toset self=\"$$default\""; \
		if ! eval $$toset ${MAKE} _solve-package-depends; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
			exit 1; \
		fi; \
	done
.endif
.if !defined(NO_SHARED_LIBS) && defined(LIB_DEPENDS) && !empty(LIB_DEPENDS)
.  for _i in ${LIB_DEPENDS}
	@@unset FLAVOR SUBPACKAGE || true; \
	: $${self:=self}; \
		echo '${_i}'|{ \
			IFS=:; read dep pkg dir target; \
			${_flavor_fragment}; \
			libspecs='';comma=''; \
			default=`eval $$toset ${MAKE} _print-packagename`; \
			case "X$$pkg" in X) pkg=`echo $$default|sed -e 's,-[0-9].*,-*,'`;; esac; \
			if pkg dependencies check $$pkg; then \
				listlibs='ls $$shdir 2>/dev/null'; \
			else \
				eval $$toset ${MAKE} ${PKGREPOSITORY}/$$default.tgz; \
				listlibs='pkg_info -L ${PKGREPOSITORY}/$$default.tgz|grep $$shdir|sed -e "s,^$$shdir/,,"'; \
			fi; \
			IFS=,; for d in $$dep; do \
				${_libresolve_fragment}; \
				case "$$check" in \
				*.a) continue;; \
				Missing\ library|Error:*) \
					echo 1>&2 "Can't resolve libspec $$d"; \
					exit 1;; \
				*) \
					libspecs="$$libspecs$$comma$$shprefix$$check"; \
					comma=',';; \
				esac; \
			done; \
			case "X$$libspecs" in \
			X) ;;\
			*) \
				echo "@@libdepend $$self:$$libspecs:$$pkg:$$default" >>$${_depends_result}; \
				toset="$$toset self=\"$$default\""; \
				if ! eval $$toset ${MAKE} _solve-package-depends; then  \
					echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
					exit 1; \
				fi;; \
			esac; \
		}
.  endfor
a2368 11
README_NAME?=	${TEMPLATES}/README.port

readme readmes:
	@@rm -f README.html
	@@cd ${.CURDIR} && exec ${MAKE} README_NAME=${README_NAME} README.html

HTMLIFY=	sed -e 's/&/\&amp;/g' -e 's/>/\&gt;/g' -e 's/</\&lt;/g'

print-depends:
	@@cd ${.CURDIR} && exec ${MAKE} FULL_PACKAGE_NAME=Yes print-depends-list print-package-depends

d2402 29
d2448 1
a2448 1
   package package-depends package-links package-name \
d2453 1
a2453 2
   print-depends-list print-package-depends readme \
   readmes rebuild reinstall \
d2457 6
a2462 5
   link-categories unlink-categories _package _solve-package-depends \
   dir-depends _recurse-dir-depends package-dir-depends \
   _package-recurse-dir-depends recursebuild-depends-list run-depends-list \
   _recurse-lib-depends lib-depends-check \
   homepage-links manpages-check
@


1.565
log
@this makes our build infrastructure systrace aware
original idea from jsyn@@, discussed and first tests at c2k3

Warning!
- this commit is different from all patches sent around, please remove
  them before updating
- due to a few bugs in systrace this is currently not ready for the casual
  porter and several ports will fail to build, you've been warned

The idea of this patch is to help a porter when developing a new port.
With systrace the configure, build and fake stages are not allowed to
open network connections or write outside some well defined directories.
This way misbehaving programs will be noticed due to logfile entries in
/var/log/messages and the port can be fixed. There is generally no need
for endusers to use this, as the checksum ensures that ports in the
future will behave the same as they did when porting. :)

To activate systrace'd port building, set USE_SYSTRACE=Yes (e.g. in
/etc/mk.conf)

tested by some people, ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.564 2003/07/25 12:46:26 espie Exp $
d1123 1
a1123 1
	if pkg dependencies check $$pkg; then \
@


1.564
log
@FETCH_MANUALLY
okay naddy
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.563 2003/07/25 02:17:51 pvalchev Exp $
d364 1
d592 23
d1448 1
a1448 1
${_EXTRACT_COOKIE}: ${_WRKDIR_COOKIE}
d1452 1
a1452 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-extract
d1455 1
a1455 1
	@@cd ${.CURDIR} && exec ${MAKE} do-extract
d1467 1
a1467 1
	@@cd ${.CURDIR} && exec ${MAKE} post-extract
d1575 2
a1576 1
	cd ${WRKBUILD} && CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
d1591 1
a1591 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-configure
d1594 1
a1594 1
	@@cd ${.CURDIR} && exec ${MAKE} do-configure
d1598 2
a1599 2
		cd ${.CURDIR} && ${SETENV} ${SCRIPTS_ENV} ${SH} \
		  ${SCRIPTDIR}/configure; \
d1609 1
a1609 1
	@@cd ${.CURDIR} && exec ${MAKE} post-configure
d1634 1
a1634 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-build
d1637 1
a1637 1
	@@cd ${.CURDIR} && exec ${MAKE} do-build
d1640 1
a1640 1
	@@cd ${WRKBUILD} && exec ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} ${ALL_TARGET}
d1644 1
a1644 1
	@@cd ${.CURDIR} && exec ${MAKE} post-build
d1694 1
a1694 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} pre-fake ${_FAKE_SETUP}
d1698 1
a1698 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} pre-install ${_FAKE_SETUP}
d1701 1
a1701 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} do-install ${_FAKE_SETUP}
d1704 1
a1704 1
	@@cd ${WRKBUILD} && exec ${SUDO} ${SETENV} ${MAKE_ENV} ${_FAKE_SETUP} ${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
d1708 1
a1708 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} post-install ${_FAKE_SETUP}
@


1.563
log
@patch -b is now -z
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.562 2003/07/24 12:50:38 naddy Exp $
d938 14
d1761 6
d1780 1
@


1.562
log
@protect smart recursion in clean-depends against port names that are
substrings of others; ok espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.561 2003/07/23 22:24:24 espie Exp $
d450 2
a451 2
PATCH_ARGS?=	-d ${WRKDIST} -b ${PATCHORIG} -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-b ${DISTORIG} -d ${WRKDIST} -E ${PATCH_DIST_STRIP}
d453 2
a454 2
PATCH_ARGS?=	-d ${WRKDIST} -b ${PATCHORIG} --forward --quiet -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-b ${DISTORIG} -d ${WRKDIST} --forward --quiet -E ${PATCH_DIST_STRIP}
@


1.561
log
@smart recursion in clean-depends: use an extra temp file to avoid cleaning
up the same spec twice.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.560 2003/07/23 09:58:33 espie Exp $
d2057 2
a2058 2
		if fgrep -q $$dir $${_DEPENDS_FILE}; then :; else \
			echo $$dir >>$${_DEPENDS_FILE}; \
@


1.560
log
@say goodbye to DEPENDS, MISC_DEPENDS, FETCH_DEPENDS. Okay naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.559 2003/07/18 19:02:13 espie Exp $
d2053 1
a2053 1
clean-depends:
d2056 6
a2061 5
	for dir in \
	   `echo ${_ALWAYS_DEP} ${_BUILD_DEP} ${_RUN_DEP} \
		| tr '\040' '\012' | sort -u`; do \
		${_flavor_fragment}; \
		eval $$toset ${MAKE} CLEANDEPENDS=No ${_DEPEND_THRU} clean clean-depends; \
d2063 8
@


1.559
log
@switch to emacs Makefile mode, at the request of Han Boetes.
Kill extra ending spaces.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.558 2003/07/18 18:54:09 espie Exp $
a40 3
# DEPENDS		- A list of other ports this package depends on being
#				  made first.
#
d395 2
a396 3
${_WRKDIR_COOKIE} ${_DEPlib_COOKIES} ${_DEPmisc_COOKIES} \
${_DEPfetch_COOKIES} ${_DEPbuild_COOKIES} ${_DEPrun_COOKIES} \
${_DEPregress_COOKIES}
d1084 1
a1084 1
_fetch_depends_fragment= \
d1088 2
a1089 4

_build_depends_fragment=${_fetch_depends_fragment}
_run_depends_fragment=${_fetch_depends_fragment}
_regress_depends_fragment=${_fetch_depends_fragment}
d1120 1
a1120 9
_misc_depends_fragment = :

depends: lib-depends misc-depends fetch-depends build-depends run-depends\
	regress-depends

# Let DEPENDS behave like the others
.if defined(DEPENDS)
MISC_DEPENDS=${DEPENDS:S/^/nonexistent::/}
.endif
d1127 1
a1127 1
.for _DEP in fetch build run lib misc regress
d1257 1
a1257 1
fetch: fetch-depends
d1367 1
a1367 1
patch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} ${_DEPmisc_COOKIES} \
d1369 1
a1369 1
distpatch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} ${_DEPmisc_COOKIES} \
d1371 1
a1371 1
configure: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} ${_DEPmisc_COOKIES} \
d1373 1
a1373 1
all build: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} ${_DEPmisc_COOKIES} \
d1411 1
a1411 1
	@@cd ${.CURDIR} && exec ${MAKE} checksum build-depends lib-depends misc-depends
d2026 2
a2027 4
.if defined(LIB_DEPENDS) || defined(MISC_DEPENDS)
_ALWAYS_DEP2 = ${LIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/} \
	${MISC_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_ALWAYS_DEP3 = ${MISC_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
a2029 1
_ALWAYS_DEP3=
d2043 2
a2044 3
.if defined(FETCH_DEPENDS) || defined(BUILD_DEPENDS)
_BUILD_DEP2 = ${FETCH_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/} \
	${BUILD_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
a2051 2
_RUN_DEP2+= ${_ALWAYS_DEP3}
_BUILD_DEP2+=${_ALWAYS_DEP3}
d2472 2
a2473 2
   fetch fetch-depends install lib-depends makesum \
   misc-depends package package-depends package-links package-name \
@


1.558
log
@more non-existing hooks.
@
text
@d1 1
a1 1
#-*- mode: Fundamental; tab-width: 4; -*-
d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.557 2003/07/18 18:34:26 espie Exp $
d12 1
a12 1
# To obtain that address, just type 
d15 1
a15 1
# 
d19 1
a19 1
# Enquiries as to the bsd.port.mk framework should usually be directed 
d33 3
a35 3
# Any variable or target starting with an underscore (e.g., _DEPEND_ECHO) 
# is internal to bsd.port.mk, not part of the user's API, and liable to 
# change without notice. 
d42 1
a42 1
#				  made first.  
d74 1
a74 1
# The sequence of hooks actually run is: 
d410 1
a410 1
_CIPHERS=		sha1 rmd160 md5 
d703 1
a703 1
PKG_ARGS+=-f ${WRKPKG}/PLIST${SUBPACKAGE} -p ${PREFIX} 
d871 1
a871 1
.endif 
d875 1
a875 1
EXTRACT_CASES?= 
d1011 1
a1011 1
.if !defined(NO_CHECKSUM) 
d1020 1
a1020 1
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE} 
d1034 1
a1034 1
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE} 
d1198 1
a1198 1
# Do a brute-force ldd/objdump on all files under WRKINST. 
d1240 1
a1240 1
.else 
d1264 1
a1264 1
# 
d1405 1
a1405 1
BULK_TARGETS?= 
d1424 1
a1424 1
${_EXTRACT_COOKIE}: ${_WRKDIR_COOKIE} 
d1505 1
a1505 1
.  if target(do-distpatch) || target(post-distpatch) || defined(PATCHFILES) 
d1507 1
a1507 1
.  endif 
d1606 1
a1606 1
	echo ""; 
d1714 1
a1714 1
.endif 
d1858 1
a1858 1
clean: 
d1875 1
a1875 1
.  endif 
d1885 1
a1885 1
	-@@rmdir ${FULLDISTDIR}  
d1912 1
a1912 1
distclean: 
d1949 1
a1949 1
	
a2020 1
	
d2022 2
a2023 1
# The README.html target needs full information (this is passed via 
d2036 1
a2036 1
.  endif 
d2038 1
a2038 1
# Internal variables, used by dependencies targets 
d2216 1
a2216 1
	done 
d2231 1
a2231 1
	done 
d2298 1
a2298 1
	done 
d2315 1
a2315 1
	done 
d2350 1
a2350 1
	done 
d2367 1
a2367 1
	done 
d2440 1
a2440 1
print-depends: 
d2464 1
a2464 1
    
@


1.557
log
@simplify the creation of links in the package repository.
ok naddy@@, pval@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.555 2003/07/16 21:22:15 espie Exp $
d2156 1
a2156 1
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || target(depends-list)
d2159 1
a2159 1
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP) || target(package-depends)
d2189 1
a2189 1
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || target(depends-list)
d2197 1
a2197 1
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP) || target(package-depends)
@


1.556
log
@kill lots of if !target.
Kill targets that don't apply to ports.
@
text
@d174 1
a174 1
PACKAGES?=		${PORTSDIR}/packages/${MACHINE_ARCH}
d177 2
a178 2
CDROM_PACKAGES?=	${PORTSDIR}/cdrom-packages/${MACHINE_ARCH}
FTP_PACKAGES?=		${PORTSDIR}/ftp-packages/${MACHINE_ARCH}
a343 1
PKGREPOSITORYSUBDIR?=	All
d345 1
a345 1
PKGREPOSITORY?=		${PACKAGES}/${PKGREPOSITORYSUBDIR}
d1405 1
a1405 1
BULK_TARGETS?= ftp-packages cdrom-packages
d1745 1
a1745 1
	    ${SUDO} ${MAKE} delete-package; \
a1775 32
# Invoke "make cdrom-packages CDROM_PACKAGES=/cdrom/snapshots/packages"
# Invoke "make ftp-packages FTP_PACKAGES=/pub/OpenBSD/snapshots/packages"

.for _l in FTP CDROM

.  if ${PERMIT_PACKAGE_${_l}:L} == "yes" && !defined(IGNORE)
${_l:L}-packages: ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
.  else
${_l:L}-packages:
.  endif
.  if defined(MULTI_PACKAGES) && empty(SUBPACKAGE)
.    for _sub in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' exec ${MAKE} ${.TARGET}
.    endfor
.  endif

${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}: ${_PACKAGE_COOKIE${SUBPACKAGE}}
.    if ${PERMIT_PACKAGE_${_l}:L} == "yes"
	@@mkdir -p ${${_l}_PACKAGES}
	@@rm -f ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
	@@ln ${PKGFILE${SUBPACKAGE}} \
	  ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX} 2>/dev/null || \
	  cp -p ${PKGFILE${SUBPACKAGE}} \
	  ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
.    else
	@@echo 1>&2 "Internal error: ${_l:L}-packages for a forbidden file ?"
	@@false
.    endif

.endfor


d1796 11
a1806 10
	@@for cat in ${CATEGORIES}; do \
		if [ ! -d ${PACKAGES}/$$cat ]; then \
			if ! mkdir -p ${PACKAGES}/$$cat; then \
				echo ">> Can't create directory ${PACKAGES}/$$cat."; \
				exit 1; \
			fi; \
		fi; \
		case $$cat in */*/*) parent=../../..;; */*) parent=../..;; *) parent=..;; esac; \
		ln -s $$parent/${PKGREPOSITORYSUBDIR}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX} ${PACKAGES}/$$cat; \
	done;
d1809 3
a1811 1
	@@cd ${PACKAGES} && find . -type l -name ${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}|xargs rm -f
d1814 1
a1814 2
	@@cd ${.CURDIR} && exec ${MAKE} delete-package-links
	@@rm -f ${PKGFILE${SUBPACKAGE}}
d1899 5
d1905 1
a2492 1
   cdrom-packages ftp-packages \
@


1.555
log
@remove RESTRICTED, CATn, MANn, MANPREFIX, CATPREFIX, NOCLEANDEPENDS.
MANCOMPRESSED, NOMANCOMPRESS.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.554 2003/07/14 14:08:57 espie Exp $
a1754 1
.if !target(fetch-all)
a1756 1
.endif
a1824 7
# Obj
#
.if !target(obj)
obj:
.endif


a1826 1
.if !target(package-links)
a1838 1
.endif
a1839 1
.if !target(delete-package-links)
a1841 1
.endif
a1842 1
.if !target(delete-package)
a1845 1
.endif
a1850 1
.if !target(checkpatch)
a1852 1
.endif
a1888 1
.if !target(clean)
d1890 1
a1890 1
.  if ${clean:L:Mdepends}
d1892 1
a1892 1
.  endif
d1894 1
a1894 1
.  if ${clean:L:Mfake}
d1896 3
a1898 3
.  endif
.  if ${clean:L:Mwork}
.    if ${clean:L:Mflavors}
d1903 1
a1903 1
.    else
d1906 3
a1908 3
.    endif 
.  endif
.  if ${clean:L:Mdist}
d1915 1
a1915 1
.    if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
a1916 1
.    endif
d1918 4
a1921 3
.  if ${clean:L:Minstall}
.    if ${clean:L:Msub}
.	   for _s in ${MULTI_PACKAGES}
d1923 2
a1924 2
.      endfor
.    else
a1925 1
.    endif
d1927 2
a1928 1
.  if ${clean:L:Mpackages} || ${clean:L:Mpackage} && ${clean:L:Msub}
d1930 1
a1930 1
.  elif ${clean:L:Mpackage}
d1932 2
a1933 2
.  endif
.  if ${clean:L:Mbulk}
a1934 1
.  endif
a2097 1
.if !target(clean-depends)
d2099 1
a2099 1
.  if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
a2106 1
.  endif
a2212 1
.if !target(print-depends-list)
d2214 1
a2214 1
.  if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || target(depends-list)
a2218 1
.  endif
a2220 1
.if !target(print-package-depends)
d2222 1
a2222 1
.  if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP) || target(package-depends)
a2226 1
.  endif
a2229 1
.if !target(recurse-build-depends)
d2231 1
a2231 1
.  if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
d2242 1
a2242 1
.  else
a2243 1
.  endif
a2245 1
.if !target(depends-list)
d2247 1
a2247 1
.  if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
a2256 1
.  endif
a2259 1
.if !target(recurse-package-depends)
d2261 1
a2261 1
.  if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
d2272 1
a2272 1
.  else
a2273 1
.  endif
a2295 1
.if !target(package-depends)
d2297 1
a2297 1
.  if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
a2306 1
.  endif
d2459 1
a2459 6
.if !target(readmes)
readmes:	readme
.endif

.if !target(readme)
readme:
a2461 2
.endif

a2464 1
.if !target(print-depends)
a2466 14
.endif

# Depend is generally meaningless for arbitrary ports, but if someone wants
# one they can override this.  This is just to catch people who've gotten into
# the habit of typing `make depend all install' as a matter of course.
#
.if !target(depend)
depend:
.endif

# Same goes for tags
.if !target(tags)
tags:
.endif
d2514 1
a2514 1
   delete-package delete-package-links depend depends depends-list \
d2526 1
a2526 1
   repackage run-depends tags uninstall fetch-all print-depends \
d2528 1
a2528 1
   distpatch real-distpatch do-distpatch post-distpatch show \
@


1.554
log
@zap motif comments
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.553 2003/07/14 14:02:18 espie Exp $
a38 2
# RESTRICTED	- Port is restricted.  Set this string to the reason why.
#
a49 16
#
# It is assumed that the port installs manpages uncompressed. If this is
# not the case, set MANCOMPRESSED in the port and define MAN<sect> and
# CAT<sect> for the compressed pages.  The pages will then be automatically
# uncompressed.
#
# MANCOMPRESSED - Indicates that the port installs manpages in a compressed
#                 form (default: port installs manpages uncompressed).
# MAN<sect>		- A list of manpages, categorized by section.  For
#				  example, if your port has "man/man1/foo.1" and
#				  "man/mann/bar.n", set "MAN1=foo.1" and "MANN=bar.n".
#				  The available sections chars are "123456789LN".
# CAT<sect>     - The same as MAN<sect>, only for formatted manpages.
# MANPREFIX		 -The directory prefix for ${MAN<sect>} (default: ${PREFIX}).
# CATPREFIX     - The directory prefix for ${CAT<sect>} (default: ${PREFIX}).
#
a133 5
# Compatibility kludge for old scripts
.if defined(NOCLEANDEPENDS)
.  if ${NOCLEANDEPENDS:L} == "no"
CLEANDEPENDS?=Yes
.  else
d135 1
a135 4
.  endif
.else
CLEANDEPENDS?=No
.endif
a941 24
.if ${FAKE:L} == "yes"
MANPREFIX?=  ${WRKINST}${TRUEPREFIX}
CATPREFIX?=  ${WRKINST}${TRUEPREFIX}
.endif

.for sect in 1 2 3 4 5 6 7 8 9 L N
MAN${sect}PREFIX?=	${MANPREFIX}
CAT${sect}PREFIX?=	${CATPREFIX}
.endfor

MANLANG?=	""	# english only by default

.for lang in ${MANLANG}

.  for sect in 1 2 3 4 5 6 7 8 9 L N
.    if defined(MAN${sect})
_MANPAGES+=	${MAN${sect}:S%^%${MAN${sect}PREFIX}/man/${lang}/man${sect:L}/%}
.    endif
.    if defined(CAT${sect})
_CATPAGES+=	${CAT${sect}:S%^%${CAT${sect}PREFIX}/man/${lang}/cat${sect:L}/%}
.    endif
.  endfor
.endfor

a954 3
# Don't build a port if it's restricted and we don't want to get
# into that.
#
a969 2
.  elif (defined(RESTRICTED) && defined(NO_RESTRICTED))
IGNORE=	"is restricted: ${RESTRICTED}"
a1684 20
.  endif
.  if defined(_MANPAGES) || defined(_CATPAGES)
.    if defined(MANCOMPRESSED) && defined(NOMANCOMPRESS)
	@@${ECHO_MSG} "===>   Uncompressing manual pages for ${FULLPKGNAME}${_MASTER}"
.      for manpage in ${_MANPAGES} ${_CATPAGES}
	@@${SUDO} ${GUNZIP_CMD} ${manpage}.gz
.      endfor
.    elif !defined(MANCOMPRESSED) && !defined(NOMANCOMPRESS)
	@@${ECHO_MSG} "===>   Compressing manual pages for ${FULLPKGNAME}${_MASTER}"
.      for manpage in ${_MANPAGES} ${_CATPAGES}
	@@if [ -L ${manpage} ]; then \
		set - `file ${manpage}`; \
		shift `expr $$# - 1`; \
		${SUDO} ln -sf $${1}.gz ${manpage}.gz; \
		${SUDO} rm ${manpage}; \
	else \
		${SUDO} ${GZIP_CMD} ${manpage}; \
	fi
.      endfor
.    endif
@


1.553
log
@zap stuff documented elsewhere.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.552 2003/07/14 13:33:04 espie Exp $
a45 7
# Motif support:
#
# USE_MOTIF		- Set this to "any" for ports that work with lesstif or
#				  openmotif (automatic flavoring), "openmotif" for ports
#				  that require openmotif, "lesstif" for ports that require
#				  lesstif. "any" will create an extra hidden lesstif
#				  FLAVOR, beware in flavor tests.
a300 1
HAVE_MOTIF?=No
@


1.552
log
@kill tweaks that make no sense:
NO_DESCRIBE, NO_PACKAGE, FETCH_BEFORE_ARGS, FETCH_AFTER_ARGS, NO_WARNINGS
(is this used ?), VARNAME, FORCE_PACKAGE.
Make CKSUMFILES invisible from users.

Make sure repackage and reinstall go through normal clean targets.
Kill pre-clean, pre-distclean, pre-repackage.
Don't allow customization of distclean.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.551 2003/07/12 12:51:19 espie Exp $
d30 2
a31 3
# There is a transition in progress. When the dust settles, 
# the definitive source of documentation to this file's working
# should be bsd.port.mk(5).
d33 3
a35 2
# All redundant documentation is being stripped, refer to bsd.port.mk(5),
# really !
a36 8
# IMPORTANT: any variable or target starting with an underscore 
# (e.g., _DEPEND_ECHO) is internal to bsd.port.mk, and 
# liable to change without notice. 
#
# DON'T USE IN INDIVIDUAL PORTS !!!
#
# Some variables that typically apply to an individual port.  Non-Boolean
# variables without defaults are *mandatory*.
a73 18
#
# Other variables:
#
# Some targets and their behaviors:
#
# package	    - Build package from the fake installation.
# install       - Install the resulting package.
#
# Note that `fake' uses {pre,do,post}-install for its own dark purposes.
# There is also a special pre-fake target that gets run after mtree but
# before making the INSTALL_PRECOOKIE, to finish setting up the fake tree.
#
# describe		- Try to generate a one-line description for each port for
#				  use in INDEX files and the like.
# checkpatch	- Do a "patch -C" instead of a "patch".  Note that it may
#				  give incorrect results if multiple patches deal with
#				  the same file.
# obj			- pre-build ${WRKDIR} -> ${WRKOBJDIR}/${PKGPATH} links
@


1.551
log
@zap show VARNAME= usage.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.550 2003/07/12 12:50:06 espie Exp $
a45 2
# NO_DESCRIBE	- Use a dummy (do-nothing) describe target.
# NO_PACKAGE	- Use a dummy (do-nothing) package target.
a53 8
# FETCH_BEFORE_ARGS -
#				  Arguments to ${FETCH_CMD} before filename (default: none).
# FETCH_AFTER_ARGS -
#				  Arguments to ${FETCH_CMD} following filename (default: none).
# NO_WARNINGS	- Set this to Yes to disable warnings regarding variables
#				  to define to control the build.  Automatically set
#				  from the "mirror-distfiles" target.
#
a151 1
VARNAME=${show}
d153 2
a655 7
# The user can override the NO_PACKAGE by specifying this from
# the make command line
.if defined(FORCE_PACKAGE)
.undef NO_PACKAGE
.endif


d898 1
a898 1
CKSUMFILES=
d901 2
a902 2
.  if empty(CKSUMFILES:M${_file})
CKSUMFILES+=${_file}
d905 1
a905 1
ALLFILES:=${CKSUMFILES}
d909 1
a909 1
CKSUMFILES:=${CKSUMFILES:N${_file}}
d915 1
a915 1
_CKSUMFILES=	${CKSUMFILES:S/^/${DIST_SUBDIR}\//}
d918 1
a918 1
_CKSUMFILES=	${CKSUMFILES}
d1829 1
a1829 2
.if !defined(NO_PACKAGE)
.  if target(pre-package)
d1831 2
a1832 2
.  endif
.  if target(do-package)
d1834 1
a1834 1
.  else
d1859 2
a1860 2
.  endif
.  if target(post-package)
a1861 5
.  endif
.else
.  if !defined(IGNORE_SILENT)
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}} may not be packaged: ${NO_PACKAGE}."
.  endif
d1866 1
a1866 1
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes fetch
d1882 1
a1882 1
		if ${FETCH_CMD} ${FETCH_BEFORE_ARGS} $${site}$$f ${FETCH_AFTER_ARGS}; then \
d1985 1
a1985 1
	@@${SUDO} ${PKG_DELETE} -f ${FULLPKGNAME${SUBPACKAGE}}
d1988 5
a2014 4
.if !target(pre-clean)
pre-clean:
.endif

d2016 1
a2016 1
clean: pre-clean
d2065 1
a2065 6
.if !target(pre-distclean)
pre-distclean:
.endif

.if !target(distclean)
distclean: pre-distclean
a2066 1
.endif
d2126 1
a2126 1
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes _fetch-makefile-helper
a2190 9
# Build a package but don't check the package cookie

.if !target(repackage)
repackage: pre-repackage package

pre-repackage:
	@@rm -f ${_PACKAGE_COOKIES}
.endif

d2247 1
a2247 2
.if !defined(NO_DESCRIBE) 
.  if !defined(PACKAGING) && defined(MULTI_PACKAGES)
d2249 1
a2249 1
.  else
d2251 1
a2251 1
.    if ${PREFIX} == ${LOCALBASE}
d2253 1
a2253 1
.    else
d2255 1
a2255 1
.    endif
d2263 2
a2264 2
.    for _d in LIB BUILD RUN
.      if !empty(_${_d}_DEP2)
d2266 1
a2266 1
.      endif
d2268 1
a2268 1
.    endfor
d2277 1
a2277 1
.    if defined(_BAD_LICENSING)
d2279 3
a2282 3
.      if ${PERMIT_PACKAGE_CDROM:L} == "yes"
	@@echo -n "y|"
.      else
d2284 2
a2285 2
.      endif
.      if ${PERMIT_PACKAGE_FTP:L} == "yes"
d2287 1
a2287 1
.      else
d2289 2
a2290 2
.      endif
.	   if ${PERMIT_DISTFILES_CDROM:L} == "yes"
d2292 1
a2292 1
.      else
d2294 2
a2295 2
.      endif
.	   if ${PERMIT_DISTFILES_FTP:L} == "yes"
d2297 1
a2297 1
.      else
a2298 1
.      endif
d2300 3
a2302 2
.    if defined(MULTI_PACKAGES) && empty(SUBPACKAGE)
.      for _sub in ${MULTI_PACKAGES}
d2304 1
a2304 2
.      endfor
.    endif
a2618 5
.if defined(VARNAME)
show:
	@@echo ${${VARNAME}:Q}
.endif

d2686 1
a2686 1
   post-patch pre-build pre-clean pre-configure pre-distclean \
d2688 1
a2688 1
   pre-repackage print-depends-list print-package-depends readme \
@


1.550
log
@zap stuff that's now properly documented
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.549 2003/07/11 16:46:20 pvalchev Exp $
d13 1
a13 1
#	make show VARNAME=MAINTAINER
@


1.549
log
@use '|' rather than ',' for sed substitution delimiter since the comma
clashed with multiple names into MAINTAINER (separated with comma), now
that it is part of SUBST_VARS.  '|' should be safer wrt all other
variables there; ok espie
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.548 2003/07/09 11:16:21 espie Exp $
a42 7
# Some variables that typically apply to all ports:
# 
# MASTER_SITES	- Primary location(s) for distribution files if not found
#				  locally.
# MASTER_SITESn	- Primary location(s) for more distribution files, in case
#				  some distfiles must be fetched from elsewhere.
#
a48 1
# BROKEN		- Port is broken.  Set this string to the reason why.
a50 2
# PKG_DBDIR		- Where package installation is recorded (default: /var/db/pkg)
#
a59 4
# NO_IGNORE     - Set this to Yes (most probably in a "make fetch" in
#                 ${PORTSDIR}) if you want to fetch all distfiles,
#                 even for packages not built due to limitation by
#                 absent X or ONLY_FOR_ARCHS...
@


1.548
log
@PROBLEMS->_PROBLEMS, this shouldn't be user-visible.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.547 2003/07/08 22:01:23 espie Exp $
d690 1
a690 1
_SED_SUBST+=-e 's,$${${_v}},${${_v}},g'
@


1.547
log
@say goodbye to obsolete comments and stuff documented in bsd.port.mk(5)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.546 2003/07/08 21:51:26 pvalchev Exp $
d1463 1
a1463 1
		  	cd ${.CURDIR} && ${MAKE} refetch PROBLEMS="$$list"; \
d1476 1
a1476 1
.  for file cipher value in ${PROBLEMS}
@


1.546
log
@Include maintainer name in the description, this way it can be easily
checked by pkg_info(1), etc.; ok espie
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.545 2003/05/18 23:11:21 sturm Exp $
d43 1
a43 1
# Variables that typically apply to all ports:
d50 1
a50 1
# Variables that typically apply to an individual port.  Non-Boolean
a52 5
# COMES_WITH	- The first version that a port was made part of the
#				  standard OpenBSD distribution.  If the current OpenBSD
#				  version is >= this version then a notice will be
#				  displayed instead of the port being generated.
#
a60 2
# USE_X11		- Port uses X11.
#
d109 1
a109 1
# Default targets and their behaviors:
a110 12
# fetch			- Retrieves ${DISTFILES} (and ${PATCHFILES} if defined, and
#                 ${SUPDISTFILES} if needed) into ${DISTDIR} as necessary.
# extract		- Unpacks ${EXTRACT_ONLY} (${DISTFILES} by default)
#                 into ${WRKDIR}.
# patch			- Apply any provided patches to the source.
# distpatch     - Intermediate patch target, apply only distribution patches.
# configure		- Runs either GNU configure, one or more local configure
#				  scripts or nothing, depending on what's available.
# build			- Actually compile the sources.
#
# If ${FAKE} == Yes
# fake			- Perform a fake installation into ${WRKINST}.
a117 2
# plist			- create a file suitable for use as a packing list.  This
#				  is for port maintainers.
a122 4
# checksum		- Use ${CHECKSUM_FILE} to ensure that your distfiles are valid.
# makesum		- Generate ${CHECKSUM_FILE} (only do this for your own ports!).
# addsum		- update ${CHECKSUM_FILE} in a non-destructive way 
#				  (your own ports only!)
a152 3
# For historical reasons, you shouldn't override pre-extract and
# do-extract. Rely on EXTRACT_ONLY and post-extract instead.

@


1.545
log
@As "run-depends" is not recursive, only the first layer of pure RUN_DEPENDS
packages got created. By setting DEPENDS_TARGET=install, all layers of
pure RUN_DEPENDS are installed directly.

OK espie@@, naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.544 2003/04/06 14:34:36 espie Exp $
d715 1
a715 1
SUBST_VARS+=MACHINE_ARCH ARCH HOMEPAGE PREFIX SYSCONFDIR FLAVOR_EXT
d804 1
@


1.544
log
@do not duplicate gnu in CONFIGURE_STYLE if it's already there.
Useful when one wants a specific CONFIGURE_STYLE order and thus specifies
gnu explicitly, e.g., CONFIGURE_STYLE=autoconf gnu imake
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.543 2003/03/02 17:54:27 pvalchev Exp $
d1864 1
a1864 1
	@@cd ${.CURDIR} && DEPENDS_TARGET=package exec ${MAKE} run-depends lib-depends
@


1.543
log
@Stop advising users to ignore wrong checksums, instead suggesting from the
distfiles/ directories on the OpenBSD FTP servers where a good copy is
normally carried.  From Peter Hessler, ok espie lebel
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.542 2003/02/06 03:45:15 brad Exp $
d356 1
d358 1
@


1.542
log
@fix lib-depends-check on ELF systems to deal with libraries of the form
libN-X.Y.so.A.B
--
From: Lurene Grenier <lurene@@daemonkitty.net>
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.541 2003/01/14 18:18:23 espie Exp $
d1491 3
a1493 2
			echo "are up to date.  If you want to override this check, type"; \
			echo "\"make NO_CHECKSUM=Yes [other args]\"."; \
@


1.541
log
@Make WRKOBJDIR be a basis for WRKDIR when defined.
Do not create a symlink from CURDIR.

Based on a suggestion of Hakan, tested and approved by various ports
people.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.540 2003/01/06 20:18:23 espie Exp $
d1343 1
a1343 1
# Do a brute-force ldd on all files under WRKINST. 
d1363 1
a1363 1
		sed 's/\./\ /g'|\
@


1.540
log
@Quote flavors, pass multi_packages as well.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.539 2003/01/06 20:15:39 espie Exp $
d585 6
a590 2
.if defined(OBJMACHINE)
WRKDIR?=		${.CURDIR}/w-${PKGNAME}${_FLAVOR_EXT2}.${MACHINE_ARCH}
a1559 10
_create_wrkobjdir =	\
	rm -rf ${WRKOBJDIR}/${PKGNAME}${_FLAVOR_EXT2}; \
	mkdir -p ${WRKOBJDIR}/${PKGNAME}${_FLAVOR_EXT2}; \
	if [ ! -L ${WRKDIR} ] || \
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${PKGNAME}${_FLAVOR_EXT2} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${PKGNAME}${_FLAVOR_EXT2}"; \
		rm -f ${WRKDIR}; \
		ln -sf ${WRKOBJDIR}/${PKGNAME}${_FLAVOR_EXT2} ${WRKDIR}; \
	fi

a1563 3
.  if defined(WRKOBJDIR) && empty(_MASTER)
	@@${_create_wrkobjdir}
.  else
d1565 1
a1565 3
	@@mkdir -p ${WRKDIR}
.  endif
	@@mkdir -p ${WRKDIR}/bin
a1999 8
.  if defined(WRKOBJDIR)
	@@${_create_wrkobjdir}
.  else
	@@echo ">>"
	@@echo ">> Please set the WRKOBJDIR variable before using 'make obj'"
	@@echo ">>"
	@@exit 1;
.  endif
@


1.539
log
@Pass more arguments to update-plist
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.538 2002/12/08 11:04:47 espie Exp $
d2174 1
a2174 1
	FLAVORS=${FLAVORS} \
@


1.538
log
@revert
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.537 2002/12/08 04:17:39 brad Exp $
d2172 3
@


1.537
log
@be more flexible with the gmake version we will accept.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.536 2002/10/10 21:14:11 naddy Exp $
d349 1
a349 1
BUILD_DEPENDS+=		:gmake-*:devel/gmake
@


1.536
log
@typo; from Han Boetes <han@@mijncomputer.nl>
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.535 2002/09/11 19:35:21 espie Exp $
d349 1
a349 1
BUILD_DEPENDS+=		::devel/gmake
@


1.535
log
@fix typo. sigh. this code is not used that much.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.534 2002/08/30 15:06:06 brad Exp $
d2182 1
a2182 1
	cd ${PATCHDIR} && $${VISUAL:-$${EDIT:-/usr/bin/vi}} $$toedit;; esac
@


1.534
log
@fix refetch target when DIST_SUBDIR is defined. FULLDISTDIR -> DISTDIR
--
Problem pointed out by: Nick Nauwelaerts <nick@@wanadoo.be>
Ok'd by: espie@@
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.533 2002/08/07 15:48:19 avsm Exp $
d1239 1
a1239 1
_no_shared=-noshared
@


1.533
log
@PSEUDO_FLAVORS support

from/ok espie
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.532 2002/07/06 09:24:06 pvalchev Exp $
d1497 2
a1498 2
		@@rm ${FULLDISTDIR}/${file}
		@@cd ${.CURDIR} && ${MAKE} ${FULLDISTDIR}/${file} \
@


1.532
log
@Kill NEED_VERSION, since people are now told to keep their ports
tree / release in sync, and strictly managing it generates a lot
of useless effort.

Note that the support for NEED_VERSION is now gone, however ports
will get that line stripped from their Makefile as time progresses
with updates, gradually; there is no emergent need for it.

ok espie and others
@
text
@d3 1
a3 1
#	$OpenBSD$
d215 3
a217 3
WRKINST?=${WRKDIR}/fake-${ARCH}${FLAVOR_EXT}
_LIBLIST=${WRKDIR}/.liblist-${ARCH}${FLAVOR_EXT}
_BUILDLIBLIST=${WRKDIR}/.buildliblist-${ARCH}${FLAVOR_EXT}
d375 2
d420 3
d431 2
d434 1
d586 1
a586 1
WRKDIR?=		${.CURDIR}/w-${PKGNAME}${FLAVOR_EXT}.${MACHINE_ARCH}
d591 1
a591 1
WRKDIR?=		${.CURDIR}/w-${PKGNAME}${FLAVOR_EXT}
d600 1
a600 1
WRKBUILD?=		${WRKDIR}/build-${MACHINE_ARCH}${FLAVOR_EXT}
d666 1
a666 1
FULLPKGPATH=${PKGPATH}${FLAVOR_EXT:S/-/,/g}
d668 1
a668 1
FULLPKGPATH=${PKGPATH},${SUBPACKAGE}${FLAVOR_EXT:S/-/,/g}
d1557 2
a1558 2
	rm -rf ${WRKOBJDIR}/${PKGNAME}${FLAVOR_EXT}; \
	mkdir -p ${WRKOBJDIR}/${PKGNAME}${FLAVOR_EXT}; \
d1560 2
a1561 2
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${PKGNAME}${FLAVOR_EXT} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${PKGNAME}${FLAVOR_EXT}"; \
d1563 1
a1563 1
		ln -sf ${WRKOBJDIR}/${PKGNAME}${FLAVOR_EXT} ${WRKDIR}; \
@


1.531
log
@Add -V and -m to FETCH_CMD. Idea from form@@.

espie@@ ok
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.530 2002/05/19 18:51:21 millert Exp $$
a613 17

# NEED_VERSION: we need at least this version of bsd.port.mk for this 
# port  to build

_VERSION_REVISION=${FULL_REVISION:M[0-9]*.*}

_VERSION=${_VERSION_REVISION:C/\..*//}
_REVISION=${_VERSION_REVISION:C/.*\.//}

.for _v in ${NEED_VERSION}
_VERSION_NEEDED=${_v:C/\..*//}
_REVISION_NEEDED=${_v:C/.*\.//}
.  if ${_VERSION_NEEDED} > ${_VERSION} || \
   (${_VERSION_NEEDED} == ${_VERSION} && ${_REVISION_NEEDED} > ${_REVISION})
ERRORS+=	"Fatal: Need version ${NEED_VERSION} of bsd.port.mk."
.  endif
.endfor
@


1.530
log
@'perl -p' does not seem to behave as I expected; use -n instead.
Fixes a problem with the perl shar filter noticed by pval@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.529 2002/05/15 18:23:21 espie Exp $$
d546 1
a546 1
FETCH_CMD?=		/usr/bin/ftp
@


1.529
log
@say goodbye to MASTER_SITE_SUBDIR
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.528 2002/05/13 00:43:42 espie Exp $$
d998 1
a998 1
_PERL_FIX_SHAR?=perl -pe 'next unless $$s || ($$s = m:^\#(\!\s*/bin/sh\s*| This is a shell archive):)'
@


1.528
log
@Add WWW: ${HOMEPAGE} at end of DESCR if not integrated already.

Mark MASTER_SITES_SUBDIR obsolete.

Promote a construct taken from NetBSD indeed.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.527 2002/05/08 18:31:49 millert Exp $$
a48 2
# MASTER_SITE_SUBDIR - Directory that "%SUBDIR%" in MASTER_SITES is
#				  replaced by.
a891 3
.if defined(MASTER_SITE_SUBDIR) && !empty(MASTER_SITE_SUBDIR)
ERRORS+=	"MASTER_SITE_SUBDIR is obsolete, replace with {SITE:=subdir/}"
.endif
a893 2
# Substitute subdirectory names in intermediate form
_MASTER_SITES:=		${MASTER_SITES:S@@%SUBDIR%@@${MASTER_SITE_SUBDIR}@@}
d897 1
a897 1
MASTER_SITES:=	${_MASTER_SITES} ${MASTER_SITE_BACKUP}
d899 1
a899 1
MASTER_SITES:=	${MASTER_SITE_OVERRIDE} ${_MASTER_SITES}
a907 1
_MASTER_SITES${_I}:=	${MASTER_SITES${_I}:S@@%SUBDIR%@@${MASTER_SITE_SUBDIR}@@}
d909 1
a909 1
MASTER_SITES${_I}:=	${_MASTER_SITES${_I}} ${MASTER_SITE_BACKUP}
d911 1
a911 1
MASTER_SITES${_I}:= ${MASTER_SITE_OVERRIDE} ${_MASTER_SITES${_I}}
@


1.527
log
@Replace _SED_FIX_SHAR with _PERL_FIX_SHAR which can deal with shar
archives that don't start with "#!/bin/sh"; espie@@ OK
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.526 2002/05/07 12:25:54 espie Exp $$
d809 3
d894 3
@


1.526
log
@Run check of symlinks post-fake as root too.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.525 2002/04/24 21:29:26 espie Exp $$
d1000 1
a1000 1
_SED_FIX_SHAR?=	sed -n -e '/^\#\![[:blank:]]*\/bin\/sh[[:space:]]*$$/,$$p'
d1012 2
a1013 2
EXTRACT_CASES+= *.shar.gz|*.shar.Z|*.sh.gz|*.sh.Z) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | ${_SED_FIX_SHAR} | /bin/sh;;
EXTRACT_CASES+= *.shar | *.sh) ${_SED_FIX_SHAR} ${FULLDISTDIR}/$$archive | /bin/sh;;
@


1.525
log
@let build of dependencies that are not 'install' or 'package' happen
inside a subdirectory of the working directory, instead of elsewhere.
Allows packages BULK=Yes to work correctly, and increase reproducibility
of builds.

tested by naddy@@ through several incarnations.

Ports that use patch/configure/build dependencies must be adjusted for this.
Pleasingly enough, the adjusted version is often simpler.

The change uses an internal _MASTER variable to recall the list of ports
built during dependencies, for less confusion.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.524 2002/04/17 16:53:13 espie Exp $$
d1874 1
a1874 1
	@@if find ${WRKINST} -type l -ls|fgrep -- '-> ${WRKINST}'; then \
@


1.524
log
@double typo. Let ftp-packages and cdrom-packages be normal BULK_TARGETS.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.523 2002/04/17 15:58:48 espie Exp $$
d456 1
d1298 1
a1298 1
	@@unset PACKAGING DEPENDS_TARGET FLAVOR SUBPACKAGE || true; \
d1301 1
d1303 2
a1304 1
		case "X$$target" in Xinstall|Xreinstall) early_exit=false;; \
d1306 5
a1310 2
		*) early_exit=true; dep="/nonexistent";; esac; \
		${_flavor_fragment}; defaulted=false; \
d1325 1
a1325 1
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}} depends on: $$what - found"; \
d1329 1
a1329 1
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}} depends on: $$what -$$msg"; \
d1334 1
a1334 1
				${ECHO_MSG} "===> Returning to build of ${FULLPKGNAME${SUBPACKAGE}}"; \
d1389 1
a1389 1
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}} ${IGNORE}."
d1425 1
a1425 1
	@@${ECHO_MSG} "===>  Checking files for ${FULLPKGNAME}"
d1548 1
a1548 1
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}} ${_IGNORE_REGRESS}."
d1581 1
a1581 1
.  if defined(WRKOBJDIR)
d1592 1
a1592 1
	@@${ECHO_MSG} "===>  Extracting for ${FULLPKGNAME}"
d1638 1
a1638 1
	@@${ECHO_MSG} "===>  Applying distribution patches for ${FULLPKGNAME}"
d1662 1
a1662 1
	@@${ECHO_MSG} "===>  Patching for ${FULLPKGNAME}"
d1729 1
a1729 1
	@@${ECHO_MSG} "===>  Configuring for ${FULLPKGNAME}"
d1760 1
a1760 1
	@@${ECHO_MSG} "===>  Building for ${FULLPKGNAME}"
d1792 1
a1792 1
	@@${ECHO_MSG} "===>  Regression check for ${FULLPKGNAME}"
d1817 1
a1817 1
	@@${ECHO_MSG} "===>  Faking installation for ${FULLPKGNAME}"
d1853 1
a1853 1
	@@${ECHO_MSG} "===>   Uncompressing manual pages for ${FULLPKGNAME}"
d1858 1
a1858 1
	@@${ECHO_MSG} "===>   Compressing manual pages for ${FULLPKGNAME}"
@


1.523
log
@kill bulk-packages. Use `make package BULK=Yes' instead.
The main advantage is that workdirs are cleaned up as soon
as package is built (or installed), not later.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.522 2002/04/10 08:44:57 espie Exp $$
d1550 1
a1550 1
BULK_TARGETS? = ftp-packages cdrom-packages
a1553 1
	@@exec ${MAKE} ftp-packages cdrom-packages
@


1.522
log
@Allow for DIST_SUBDIR to be empty
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.521 2002/04/09 23:55:11 espie Exp $$
d451 1
a451 1

d476 1
d1512 11
d1534 1
a1534 5
.  if defined(ALWAYS_PACKAGE)
install: ${_INSTALL_COOKIE} ${_PACKAGE_COOKIES}
.  else
install: ${_INSTALL_COOKIE}
.  endif
d1536 2
a1537 1
package: ${_PACKAGE_COOKIES}
d1550 12
a1964 20
bulk-packages:
	@@${MAKE} package BATCH=Yes && exec ${SUDO} ${MAKE} clean CLEANDEPENDS=Yes
	@@exec ${MAKE} ftp-packages cdrom-packages BATCH=Yes
# bulk-packages is just 
# make bulk-do BULK_TARGETS='package ftp-packages cdrom-packages clean'
#			   BULK_FLAGS='BATCH=Yes CLEANDEPENDS=Yes'
#
# You can, for instance, do:
# make clean='distclean install package'
# make bulk-do 
#	BULK_TARGETS='distclean clean=package regress lib-depends-check 
#		package ftp-packages cdrom-packages clean'
#	BULK_FLAGS='BATCH=Yes CLEANDEPENDS=Yes'
#
bulk-do:
.for _i in ${BULK_TARGETS}
	@@exec ${MAKE} ${_i} ${BULK_FLAGS}
.endfor


d2144 3
d2799 1
a2799 1
   bulk-packages bulk-do _recurse-lib-depends lib-depends-check \
@


1.521
log
@Add PROTECT_MOUNT_POINTS, to help package builders spot ports that write
outside of the fake area.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.520 2002/04/09 22:52:24 espie Exp $$
d281 1
a281 1
.if defined(DIST_SUBDIR)
d974 1
a974 1
.if defined(DIST_SUBDIR)
d2125 1
a2125 1
.    if defined(DIST_SUBDIR)
d2193 1
a2193 1
.if defined(DIST_SUBDIR)
d2224 1
a2224 1
.    if defined(DIST_SUBDIR)
@


1.520
log
@fix indentation
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.519 2002/04/09 13:52:58 espie Exp $$
d1787 2
d1799 3
d1845 3
@


1.519
log
@USE_LIBTOOL, USE_GMAKE, USE_X11 should really be Yes/No variables.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.518 2002/04/03 15:00:30 espie Exp $$
d1797 2
a1798 2
.for _m in ${MODULES}
.  if defined(MOD${_m:U}_pre-fake)
d1800 2
a1801 2
.  endif
.endfor
@


1.518
log
@Let make update-plist look at dependent packages (LIB_DEPENDS and
RUN_DEPENDS) to create a more accurate list of @@dirrm.

Minor negative side-effect: up-to-date dependent packages must be present
for this to work. Not a problem, since this is only used by maintainers.

This improves the quality of generated plists for large packages with lots
of dependencies by a large amount (e.g., kde)

reviewed by pval@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.517 2002/04/02 15:55:55 espie Exp $$
d349 2
a350 1
.if defined(USE_GMAKE)
d361 2
a362 1
.if defined(USE_LIBTOOL)
d1086 1
d1119 1
a1119 1
.  elif defined(USE_X11) && !exists(${X11BASE})
@


1.517
log
@Add a target to check that makewhatis will build correct index entries.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.516 2002/03/21 21:28:29 espie Exp $$
d2156 1
a2156 1
plist update-plist: fake
d2161 2
@


1.516
log
@Kill files/md5 magic
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.515 2002/03/18 01:55:40 espie Exp $$
d1377 1
a1377 1
uninstall deinstall fake package lib-depends-check:
d1396 4
a1399 1

d2783 1
a2783 1
   homepage-links
@


1.515
log
@can't set both motif and lesstif flavors at once.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.514 2002/03/18 01:52:46 espie Exp $$
a506 2
# Compatibility game
MD5_FILE?=		${FILESDIR}/md5
d1159 1
a1159 1
	@@rm -f ${CHECKSUM_FILE} ${MD5_FILE}
a1172 3
	@@if [ -f ${MD5_FILE} ]; then \
	  mv -f ${MD5_FILE} ${CHECKSUM_FILE}; \
	fi
a1437 1
	test -f $$checksum_file || checksum_file=${MD5_FILE}; \
a2216 1
	test -f $$checksum_file || checksum_file=${MD5_FILE}; \
@


1.514
log
@Handle ERRORS+='Fatal:...' as well
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.513 2002/03/16 01:09:23 espie Exp $$
d390 3
@


1.513
log
@move gnu dreck (autoconf, automake...) to gnu.port.mk
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.513 2002/03/16 00:54:37 espie Exp $$
d2757 1
a2757 1
.  if !empty(ERRORS:M"Fatal\:*")
@


1.512
log
@disable automake unless explicitly asked for it.
Just did a package build without any apparent ill effect.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.511 2002/03/15 13:29:13 espie Exp $$
d355 2
a356 2
AUTOCONF_NEW?=	No
.if ${CONFIGURE_STYLE:L:Mautomake}
a357 23
BUILD_DEPENDS+=		::devel/automake
.endif
.if ${CONFIGURE_STYLE:L:Mautoupdate}
CONFIGURE_STYLE+=autoconf
.endif
.if ${CONFIGURE_STYLE:L:Mautoconf}
CONFIGURE_STYLE+=gnu
.  if ${AUTOCONF_NEW:L} == "yes"
BUILD_DEPENDS+=		::devel/autoconf-new
AUTOCONF?=			autoconf-new
AUTOUPDATE?=		autoupdate-new
AUTOHEADER?=		autoheader-new
MAKE_FLAGS+=		AUTOCONF='${AUTOCONF}' AUTOHEADER='${AUTOHEADER}'
FAKE_FLAGS+=		AUTOCONF='${AUTOCONF}' AUTOHEADER='${AUTOHEADER}'
.  else
AUTOCONF?=		autoconf
AUTOUPDATE?=	autoupdate
AUTOHEADER?=	autoheader
BUILD_DEPENDS+=		::devel/autoconf
.  endif
AUTOCONF_DIR?=${WRKSRC}
# missing ?= not an oversight
AUTOCONF_ENV=PATH=${PORTPATH}
d1677 5
a1682 10
.  if ${CONFIGURE_STYLE:L:Mautoupdate}
	@@cd ${AUTOCONF_DIR} && exec ${SETENV} ${AUTOCONF_ENV} ${AUTOUPDATE}
.  endif
.  if ${CONFIGURE_STYLE:L:Mautoconf}
	@@cd ${AUTOCONF_DIR} && exec ${SETENV} ${AUTOCONF_ENV} ${AUTOCONF}
.  endif
.  if !${CONFIGURE_STYLE:L:Mautomake}
	@@ln -s /usr/bin/false ${WRKDIR}/bin/automake
	@@ln -s /usr/bin/false ${WRKDIR}/bin/aclocal
.  endif
@


1.511
log
@Add ${WRKDIR}/bin directory.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.510 2002/03/13 13:51:59 espie Exp $$
d356 4
d1706 4
@


1.510
log
@Add rules to create a list of homepage links for all ports.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.509 2002/03/10 06:02:16 brad Exp $$
d533 1
a533 1
PORTPATH?= /usr/bin:/bin:/usr/sbin:/sbin:${LOCALBASE}/bin:${X11BASE}/bin
d1577 1
@


1.509
log
@mention tcsh
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.508 2002/03/04 15:33:16 espie Exp $$
d2760 7
d2802 2
a2803 1
   bulk-packages bulk-do _recurse-lib-depends lib-depends-check
@


1.508
log
@create package dependency list in a separate file.
This solves some nasty merged output problems and unconfuse redirection
issues.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.507 2002/03/02 13:38:25 espie Exp $$
d1760 1
a1760 1
	echo "*** 	csh(1): limit datasize <kbytes of memory>"; \
@


1.507
log
@Trip ports that mistakenly try to write into $HOME.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.506 2002/03/01 00:49:03 naddy Exp $$
d790 1
a790 1
${WRKPKG}/PLIST${SUBPACKAGE}: ${PLIST}
d792 1
a792 1
	@@self=${FULLPKGNAME${SUBPACKAGE}} exec ${MAKE} _solve-package-depends|sort -u >>$@@.tmp
d796 1
a796 1
		-e '//d' -e '/^%%SHARED%%$$/d' <$? \
d803 1
a803 1
			-e '//d' <$? ${SED_PLIST} \
d809 1
a809 1
			-e '//d' <$? \
d814 4
d2650 1
a2650 1
		echo "@@newdepend $$self:$$pkg:$$default"; \
d2671 1
a2671 1
				eval $$toset ${MAKE} ${PKGREPOSITORY}/$$default.tgz 1>&2; \
d2689 1
a2689 1
				echo "@@libdepend $$self:$$libspecs:$$pkg:$$default"; \
@


1.506
log
@fix REGRESS_IS_INTERACTIVE logic; ok espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.505 2002/02/27 00:25:35 espie Exp $$
d554 2
d559 2
a560 1
	TRUEPREFIX='${PREFIX}' ${DESTDIRNAME}=''
@


1.505
log
@don't redirect build output to /dev/null, redirect it to stderr instead,
so that building packages in the background to solve dependencies won't
break the plist it's building, but show up clearly still...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.504 2001/12/31 09:38:54 espie Exp $$
d1118 1
a1118 1
.  elif (!defined(IS_INTERACTIVE) && defined(INTERACTIVE))
@


1.504
log
@hooks for switching to autoconf-2.52.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.503 2001/12/23 02:17:02 miod Exp $$
d2664 1
a2664 1
				eval $$toset ${MAKE} ${PKGREPOSITORY}/$$default.tgz >/dev/null; \
@


1.503
log
@Repair mvme88k entry in NO_SHARED_ARCHS line. MACHINE_ARCH should be listed
there, not MACHINE....
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.502 2001/12/15 18:10:36 brad Exp $$
d355 4
d361 11
d373 1
a521 1
AUTOCONF?=		autoconf
d1689 3
@


1.502
log
@for the addsum target, check to see if files/md5 exists before trying to
move it that way we do not get an error message from mv if it does not
already exist.
--
Ok'd by: espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.501 2001/12/13 15:40:27 naddy Exp $$
d229 1
a229 1
NO_SHARED_ARCHS=hppa mvme88k vax
@


1.501
log
@Fix the HTML markup produced by "make readmes" in /usr/ports.

Submitted by:	Nick Nauwelaerts <nick@@wanadoo.be>
PR:		2233
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.500 2001/11/22 16:02:26 naddy Exp $$
d1169 4
a1172 1
	@@mv ${MD5_FILE} ${CHECKSUM_FILE} || touch ${CHECKSUM_FILE}
@


1.500
log
@match the comment for the describe target with the actual code; ok espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.499 2001/11/17 10:39:19 espie Exp $$
d2399 1
a2399 1
			echo "<A HREF=\"${PKGDEPTH}/$$j/README.html\">$$k</A>"; \
d2402 1
a2402 1
    echo "(none)" > $@@.tmp$Ia; \
@


1.499
log
@Use perl lib depends checker, that parses the full gamut of libspecs.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.498 2001/11/15 02:07:05 espie Exp $$
d2314 2
a2315 1
#  description-file|maintainer|categories|build deps|run deps|for arch
@


1.498
log
@handles subcategories in package-links. Close PR 1731
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.497 2001/11/13 12:52:22 espie Exp $$
d774 1
a774 1
	@@self=${FULLPKGNAME${SUBPACKAGE}} exec ${MAKE} new-depends|sort -u >>$@@.tmp
d1240 2
a1241 6
.if !defined(NO_SHARED_LIBS)
_sharedlib_resolve_fragment = \
		lib=`echo $$d | sed -e 's|\.$$||' -e 's|\([^\\]\)\.|\1\\\\.|g'`; \
		check=`eval $$listlibs |grep '^lib.*\.so\.*'| \
			sed -e 's,^lib,,' -e 's,$$,.,' -e 's,\.so\.,.,' | \
			grep "^$$lib\."|sed -e 's,\.$$,,'` || true 
d1243 1
a1243 1
_sharedlib_resolve_fragment = :
d1252 3
a1254 5
		${_sharedlib_resolve_fragment}; \
		case "X$$check" in "X") \
			lib=`echo $$d | sed -e 's|\([^\\]\)[\\\.].*|\1|'`; \
			check=`eval $$listlibs | grep "^lib$$lib\.a$$"` || true;; \
		esac
d1262 4
a1265 1
		case "X$$check" in "X") bad=true; msg="$$msg $$d missing...";; esac; \
d2283 1
d2293 4
d2334 4
a2337 7
.    if !empty(_ALWAYS_DEP3) || !empty(_BUILD_DEP2)
	@@cd ${.CURDIR} && _FINAL_ECHO=: _INITIAL_ECHO=: exec ${MAKE} build-depends-list
.    endif
	@@echo -n "|"
.    if !empty(_ALWAYS_DEP3) || !empty(_RUN_DEP2)
	@@cd ${.CURDIR} && _FINAL_ECHO=: _INITIAL_ECHO=: exec ${MAKE} run-depends-list
.    endif
d2339 1
d2559 1
a2559 1
.for _i in RUN BUILD
d2561 1
a2561 1
.  if !empty(_ALWAYS_DEP2) || !empty(_${_i}_DEP2)
d2565 1
a2565 1
	: $${_FINAL_ECHO:='echo "\" to ${_i:L}."'}; space=''; \
d2567 1
a2567 1
	for spec in `echo '${_ALWAYS_DEP2} ${_${_i}_DEP2}' \
d2569 2
a2570 5
		dir=$${spec#*:}; pkg=$${spec%:*}; \
		case X"$$pkg" in \
			X) $${_ECHO} "$$space$${dir}";; \
			*) $${_ECHO} "$$space$${pkg}:$${dir}";; \
		esac; space=' '; \
d2611 2
a2612 2
new-depends:
.if !empty(_ALWAYS_DEP3) || !empty(_RUN_DEP2)
d2615 1
a2615 1
	for spec in `echo '${_ALWAYS_DEP3} ${_RUN_DEP2}' \
d2623 1
a2623 1
		if ! eval $$toset ${MAKE} new-depends; then  \
d2647 3
a2649 3
				case "X$$check" in \
				Xlib*.a) continue;; \
				X) \
d2652 1
a2652 1
				X*) \
d2662 1
a2662 1
				if ! eval $$toset ${MAKE} new-depends; then  \
d2763 1
a2763 1
   link-categories unlink-categories _package new-depends \
@


1.497
log
@typo
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.496 2001/11/12 14:32:52 espie Exp $$
d2022 2
a2023 1
		ln -s ../${PKGREPOSITORYSUBDIR}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX} ${PACKAGES}/$$cat; \
@


1.496
log
@Basic new lib dependency code for package.
LIB_DEPENDS are no longer part of ALWAYS_DEPEND for the new-depends code,
but use their own code.

The code does scan the list of libraries for dependent packages, and insert
corresponding @@libdepend lines into the resulting package. There are a few
important consequences:

- no libdepend lines are inserted if only a static library is found. So
RUN_DEPENDS are now needed to supplement LIB_DEPENDS if a package requires
another package for something that isn't a library.
- dependency checking for installed stuff can go one step further, since
we have the major/minor number of the libraries used for the build.
At the moment, pkg resolve dependencies does nothing smart with the
inserted libdepends, but it will (soon). In fact, for most libdepends, if
the major/minor scheme are correct, no check on the installed pkgspec ought
to be necessary... which is why the `default pkgspec to check' is pkg-* for
libraries.
- resolving recursive run dependencies need to go one step further: a
RUN_DEPENDS pkg may have some LIB_DEPENDS, and the RUN_DEPENDS pkg will be
needed to explicitly write the required information into the resulting
package... Hence the necessity of being able to tune the list of libraries
to ask the uninstalled package (and to make sure the uninstalled package
is built).

This is only preliminary work. Currently, this doesn't yield any real
benefits to the old approach, as a few semantic details need to be
sharpened out. Also, there are now quite a few old targets that are a
complete mess and will need to be cleaned up/removed entirely.

Thanks to naddy@@ for testing various preliminary versions of this patch
and helping me iron bugs out.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.495 2001/11/12 14:24:06 espie Exp $$
d2214 1
a2214 1
	@@if [ ! -f $$checksum_file ]; then \
@


1.495
log
@Replace the lib dependency check with a more mechanical check, that
no longer relies on ldconfig, but rather on the path stored inside
LIB_DEPENDS. Introduce a lib_resolve_fragment that can be used to
resolve the libraries from a given list (e.g., listlibs).

To be used in the next patch.

Note that this check is currently more or less equivalent to the old
check, apart from the fact that:
- libs can't trust packages,
- lib-depends always resort to non-shared libraries, even on shared
architectures, if the shared check doesn't work.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.494 2001/11/12 14:19:17 espie Exp $$
d2269 1
d2272 1
d2331 1
a2331 1
.    if !empty(_ALWAYS_DEP2) || !empty(_BUILD_DEP2)
d2335 1
a2335 1
.    if !empty(_ALWAYS_DEP2) || !empty(_RUN_DEP2)
d2614 1
a2614 1
.if !empty(_ALWAYS_DEP2) || !empty(_RUN_DEP2)
d2617 1
a2617 1
	for spec in `echo '${_ALWAYS_DEP2} ${_RUN_DEP2}' \
d2621 1
a2621 1
		default=`eval $$toset ${MAKE} package-name`; \
d2631 42
@


1.494
log
@add top-level directory `mystuff' to be used by porters for stuff they
haven't committed yet. The nice part is that dependencies get transparently
resolved to mystuff/dir if they aren't found in dir.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.493 2001/11/12 14:14:46 espie Exp $$
d1240 23
a1262 4
.if ${TRUST_PACKAGES:L} == "yes"
_lib_depends_fragment=${_fetch_depends_fragment}
.else
.  if defined(NO_SHARED_LIBS)
d1266 3
a1268 6
		d=$${d\#\#*/}; \
		lib=`echo $$d | sed -e 's|\([^\\]\)[\\\.].*|\1|'`; \
		tmp=`mktemp /tmp/bpmXXXXXXXXXX`; \
		if ${LD} -r -o $$tmp ${EXTRA_LIBDIRS:S/^/-L/} -L${LOCALBASE}/lib -L${X11BASE}/lib -l$$lib; then :; else\
			bad=true; msg="$$msg $$lib missing..."; \
		fi; \
d1270 1
a1270 11
.  else
_lib_depends_fragment = \
	what=$$dep; \
	IFS=,; bad=false; for d in $$dep; do \
		d=$${d\#\#*/}; \
		lib=`echo $$d | sed -e 's|\.$$||' -e 's|\([^\\]\)\.|\1\\\\.|g'`; \
		check=`${LDCONFIG} -r | awk "/:-l$$lib[ .]/"'{ print $$3 }'`; \
		case "X$$check" in "X") bad=true; msg="$$msg $$lib missing...";; esac; \
	done; $$bad || found=true
.  endif
.endif
@


1.493
log
@Move the `check and change directory' part to flavor_fragment, as it's
invariably duplicated right after otherwise.

This makes the code cleaner, and makes sure the check happens all the time.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.492 2001/11/12 01:27:26 pvalchev Exp $$
d1222 1
a1222 1
		if cd $$dir 2>/dev/null; then \
@


1.492
log
@get a proper list of system libraries to exclude, and report real missing
ones from LIB_DEPENDS for lib-depends-check on ELF. ok espie
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.491 2001/11/11 13:57:32 heko Exp $$
d1216 11
d1294 1
a1294 2
		case "X$$pkg" in X) pkg=`cd ${PORTSDIR} && cd $$dir && \
			eval $$toset ${MAKE} _print-packagename`; \
a1300 8
			cd ${PORTSDIR}; \
			if [ ! -d $$dir ]; then \
				echo ">> No directory for $$dep ($$dir)"; \
			fi; \
			if [ -L $$dir ]; then \
				echo ">> Broken dependency: $$dir is a symbolic link"; \
				exit 1; \
			fi; \
d1316 1
a1316 1
			if cd $$dir && eval $$toset ${MAKE} ${_DEPEND_THRU} $$target; then \
d2294 1
a2294 3
		if cd ${PORTSDIR} && cd $$dir 2>/dev/null ; then \
			eval $$toset ${MAKE} CLEANDEPENDS=No ${_DEPEND_THRU} clean clean-depends; \
		fi \
d2433 4
a2436 9
		 | tr '\040' '\012' | sort -u`; do \
		 ${_flavor_fragment}; \
		if cd ${PORTSDIR} && cd $$dir 2>/dev/null; then \
			if ! eval $$toset ${MAKE} _DEPEND_ECHO=\"echo $$pname\" package-name recurse-build-depends ${_DEPEND_THRU}; then  \
				echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
				exit 1; \
			fi; \
		else \
			echo 1>&2  "*** Build dependencies bogus: \"$$dir\" non-existent"; \
d2452 2
a2453 7
		if cd ${PORTSDIR} && cd $$dir 2>/dev/null; then \
			if ! eval $$toset ${MAKE} recurse-build-depends ${_DEPEND_THRU}; then  \
				echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
				exit 1; \
			fi; \
		else \
			echo 1>&2  "*** Build dependencies bogus: \"$$dir\" non-existent"; \
d2469 2
a2470 7
		if cd ${PORTSDIR} && cd $$dir 2>/dev/null; then \
			if ! eval $$toset ${MAKE} _DEPEND_ECHO=\"echo $$pname\" package-name recurse-package-depends ${_DEPEND_THRU}; then  \
				echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
				exit 1; \
			fi; \
		else \
			echo 1>&2 "*** @@pkgdep registration bogus: \"$$dir\" non-existent"; \
a2486 1
		cd ${PORTSDIR}; cd $$dir; \
a2494 1
		cd ${PORTSDIR}; cd $$dir; \
d2506 2
a2507 7
		if cd ${PORTSDIR} && cd $$dir 2>/dev/null; then \
			if ! eval $$toset ${MAKE} recurse-package-depends ${_DEPEND_THRU}; then  \
				echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
				exit 1; \
			fi; \
		else \
			echo 1>&2 "*** @@pkgdep registration bogus: \"$$dir\" non-existent"; \
d2524 2
a2525 7
		if cd ${PORTSDIR} && cd $$dir 2>/dev/null; then \
			if ! eval $$toset ${MAKE} _recurse-dir-depends ${_DEPEND_THRU}; then  \
				echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
				exit 1; \
			fi; \
		else \
			echo 1>&2  "*** Build dependencies bogus: \"$$dir\" non-existent"; \
d2541 2
a2542 7
		if cd ${PORTSDIR} && cd $$dir 2>/dev/null; then \
			if ! eval $$toset ${MAKE} _recurse-dir-depends ${_DEPEND_THRU}; then  \
				echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
				exit 1; \
			fi; \
		else \
			echo 1>&2  "*** Build dependencies bogus: \"$$dir\" non-existent"; \
d2579 2
a2580 7
		if cd ${PORTSDIR} && cd $$dir 2>/dev/null; then \
			if ! eval $$toset ${MAKE} _package-recurse-dir-depends ${_DEPEND_THRU}; then  \
				echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
				exit 1; \
			fi; \
		else \
			echo 1>&2  "*** Run dependencies bogus: \"$$dir\" non-existent"; \
d2596 2
a2597 7
		if cd ${PORTSDIR} && cd $$dir 2>/dev/null; then \
			if ! eval $$toset ${MAKE} _package-recurse-dir-depends ${_DEPEND_THRU}; then  \
				echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
				exit 1; \
			fi; \
		else \
			echo 1>&2  "*** Run dependencies bogus: \"$$dir\" non-existent"; \
d2613 1
a2613 1
		default=`cd ${PORTSDIR} && cd $$dir 2>/dev/null && eval $$toset ${MAKE} package-name`; \
d2617 2
a2618 7
		if cd ${PORTSDIR} && cd $$dir 2>/dev/null; then \
			if ! eval $$toset ${MAKE} new-depends; then  \
				echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
				exit 1; \
			fi; \
		else \
			echo 1>&2 "*** @@pkgdep registration bogus: \"$$dir\" non-existent"; \
@


1.491
log
@o Instead of copying the "virtual memory exhausted" warning for each
individual port, introduce a new variable for bsd.port.mk, VMEM_WARNING.
By setting this variable to `Yes', the user is given a warning about the
virtual memory requirements just before the pre-build stage.
o Also give some examples for different shells for what to do about
it, and mention login.conf(5). bash, for example, has a confusing
-v flag to ulimit.
o Document this in bsd.port.mk.5
espie@@ ok
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.490 2001/11/11 12:59:50 espie Exp $$
d1362 1
a1362 1
		fgrep .so.|${SUDO} xargs file -L|fgrep 'shared library'|cut -d\: -f1|sort -u >$@@
@


1.490
log
@transform files/md5 into distinfo magically.
I would credit FreeBSD or NetBSD for the idea if I could remember which
one came up with it first. :)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.489 2001/11/01 12:26:16 espie Exp $$
d1711 1
d1718 13
@


1.489
log
@Zap idiot subshell
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.487 2001/10/28 12:34:57 espie Exp $$
d510 1
a510 1
CHECKSUM_FILE?=	${MD5_FILE}
d1155 1
a1155 1
	@@mkdir -p ${FILESDIR} && rm -f ${CHECKSUM_FILE}
d1169 1
a1169 1
	@@mkdir -p ${FILESDIR} && touch ${CHECKSUM_FILE}
d1428 3
a1430 1
	@@if [ ! -f ${CHECKSUM_FILE} ]; then \
d1436 1
a1436 1
			set -- `grep -i "^$$cipher ($$file)" ${CHECKSUM_FILE}` && break || \
d1461 1
a1461 1
		  set -- `grep "($$file)" ${CHECKSUM_FILE}` || \
d1476 1
a1476 1
			echo "Make sure the Makefile and checksum file (${CHECKSUM_FILE})"; \
d2190 4
a2193 2
	@@if [ ! -f ${CHECKSUM_FILE} ]; then \
	  echo >&2 'Missing checksum file: ${CHECKSUM_FILE}'; \
d2197 1
a2197 1
		if set -- `grep -i "^$$c (${_F})" ${CHECKSUM_FILE}`; then break; fi; \
d2204 1
a2204 1
		  echo >&2 "Checksum for ${_F} is IGNORE in ${CHECKSUM_FILE}"; \
@


1.488
log
@Recursive module support.
@
text
@d1338 1
a1338 1
	@@(cd ${WRKINST} && ${SUDO} find . -type f)|\
@


1.487
log
@defaulted variable in *-depends target, currently unused: way to know
that dependency defaulted to default pattern.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.486 2001/10/28 12:31:35 espie Exp $$
d608 4
a611 7
.for _m in ${MODULES:L}
.  if exists(${PORTSDIR}/infrastructure/mk/${_m}.port.mk)
.    include "${PORTSDIR}/infrastructure/mk/${_m}.port.mk"
.  else
ERRORS+="Missing support for modules ${_m}."
.  endif
.endfor
@


1.486
log
@Move NEED_VERSION check later. Allows for NEED_VERSION to be a list.
Useful for modules support: now specific modules can require later
versions of bsd.port.mk.

Of course, ports using modules may need an update to 1.486 to use
this feature.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.485 2001/10/28 04:59:26 brad Exp $$
d1285 1
a1285 1
		${_flavor_fragment}; \
d1287 2
a1288 1
			eval $$toset ${MAKE} _print-packagename`;; esac; \
@


1.485
log
@For consistency, use :L variable modifier with ELF_TOOLCHAIN check.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.484 2001/10/26 17:34:31 pvalchev Exp $$
a22 17
# NEED_VERSION: we need at least this version of bsd.port.mk for this 
# port  to build

.if defined(NEED_VERSION)
_VERSION_REVISION=${FULL_REVISION:M[0-9]*.*}

_VERSION=${_VERSION_REVISION:C/\..*//}
_REVISION=${_VERSION_REVISION:C/.*\.//}

_VERSION_NEEDED=${NEED_VERSION:C/\..*//}
_REVISION_NEEDED=${NEED_VERSION:C/.*\.//}
.  if ${_VERSION_NEEDED} > ${_VERSION} || \
   (${_VERSION_NEEDED} == ${_VERSION} && ${_REVISION_NEEDED} > ${_REVISION})
ERRORS+=	"Fatal: Need version ${NEED_VERSION} of bsd.port.mk."
.  endif
.endif

d613 17
@


1.484
log
@lib-depends checker for ELF using objdump -p.  ok espie
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.483 2001/10/26 13:46:03 espie Exp $$
d1334 1
a1334 1
.if ${ELF_TOOLCHAIN} == no
@


1.483
log
@Allows for a path in the LIB_DEPENDS libspec component.
Don't use it for now.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.482 2001/10/24 16:35:38 espie Exp $$
d1334 1
d1345 11
@


1.482
log
@shift to `update-plist' from `plist'... keep old target around for now.
Create PKGDIR while we're at it.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.481 2001/10/24 11:57:34 espie Exp $$
d1239 1
d1250 1
@


1.481
log
@First cut at a lib-depends checker: this version does use WRKINST instead
of the actual package, so it WILL get things wrong in some multi-packages
case.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.480 2001/10/24 11:53:54 espie Exp $$
d2113 2
a2114 1
plist: fake
d2723 1
a2723 1
   package-noinstall patch plist update-patches post-build \
@


1.480
log
@More helpers: scan WRKINST for list of all needed libraries.
The chroot is needed to avoid having ldd pick up dependent libraries
that come from a package variant and are actually not needed as
dependencies.

Scan /usr, /usr/X11R6 for system libraries, and WRKINST for packaged
libraries.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.479 2001/10/24 11:49:45 espie Exp $$
d1356 1
a1356 1
uninstall deinstall fake package:
d1362 13
d2734 1
a2734 1
   bulk-packages bulk-do _recurse-lib-depends
@


1.479
log
@Internal target: create list of all libraries we're allowed to depend upon.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.478 2001/10/24 11:47:41 espie Exp $$
d235 3
d1330 21
@


1.478
log
@bulk-do, a slightly more generic version of bulk-packages
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.477 2001/10/24 11:44:35 espie Exp $$
d2426 22
d2697 1
a2697 1
   bulk-packages bulk-do
@


1.477
log
@Cleaning out an installed package that is not there should not abort the
make.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.476 2001/10/24 11:43:06 espie Exp $$
d1857 16
d2674 2
a2675 1
   _package-recurse-dir-depends recursebuild-depends-list run-depends-list
@


1.476
log
@More verbose default maintainer
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.475 2001/10/11 00:01:27 espie Exp $$
d2025 1
a2025 1
	${SUDO} ${PKG_DELETE} ${clean:M-f} ${FULLPKGNAME${_s}}
d2028 1
a2028 1
	${SUDO} ${PKG_DELETE} ${clean:M-f} ${FULLPKGNAME${SUBPACKAGE}}
@


1.475
log
@Give dependencies a fighting change, spell early_exit correctly.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.474 2001/10/07 11:30:30 espie Exp $$
d1018 1
a1018 1
MAINTAINER?=	ports@@openbsd.org
@


1.474
log
@REGRESS_IS_INTERACTIVE

This makes things a bit less symetric, but it can't really be avoided
since regress is out of the normal build chain.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.473 2001/10/07 10:53:43 espie Exp $$
d1316 1
a1316 1
			if $$earlyexit; then \
@


1.473
log
@In retrospect, just allow REGRESS_FLAGS. This would be redundant otherwise
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.472 2001/10/07 10:50:47 espie Exp $$
d1101 5
a1456 1
regress: ${_DEPregress_COOKIES} ${_REGRESS_COOKIE}
d1464 9
@


1.472
log
@Seems like we can't avoid REGRESS_ENV/REGRESS_FLAGS.

Some testsuites use HOME to test their getenv function. Which seems
to be reasonable. But we definitely don't want to allow HOME into
MAKE_ENV by default.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.471 2001/10/07 10:47:01 espie Exp $$
a630 1
REGRESS_ENV ?= ${MAKE_ENV}
d1679 1
a1679 1
	@@cd ${WRKBUILD} && exec ${SETENV} ${REGRESS_ENV} ${MAKE_PROGRAM} ${REGRESS_FLAGS} -f ${MAKE_FILE} ${REGRESS_TARGET}
@


1.471
log
@don't depend on the current version of unzip/bzip2. Any should do.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.470 2001/10/04 22:43:45 naddy Exp $$
d631 2
d1680 1
a1680 1
	@@cd ${WRKBUILD} && exec ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} ${REGRESS_TARGET}
@


1.470
log
@fix PATCH_LIST absolute path handling in case of missing PATCHDIR
ok espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.469 2001/10/04 22:20:38 espie Exp $$
d995 1
a995 1
BUILD_DEPENDS+=		::archivers/unzip
d999 1
a999 1
BUILD_DEPENDS+=		::archivers/bzip2
@


1.469
log
@typo
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.468 2001/10/03 08:53:18 espie Exp $$
d1568 1
a1568 1
	@@if cd ${PATCHDIR} 2>/dev/null || [ x"${PATCH_LIST:M|/*||}" != x"" ]; then \
@


1.468
log
@basic regression testing framework.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.467 2001/10/03 08:41:16 espie Exp $$
d630 1
a630 1
_REGRESS_TARGET ?= regress
@


1.467
log
@move error handling later for greater flexibility.
Move default NO_* after including local Makefiles.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.466 2001/10/03 08:36:25 espie Exp $$
d286 1
d391 5
d435 1
a435 1
.if defined(FLAVORS)
d447 1
a447 1
.  if defined(FLAVORS)
d501 1
d505 1
d509 2
a510 1
${_INSTALL_PRE_COOKIE} ${_BUILD_COOKIE} ${_PACKAGE_COOKIES} \
d513 2
a514 1
${_DEPfetch_COOKIES} ${_DEPbuild_COOKIES} ${_DEPrun_COOKIES}
d630 2
d1221 1
d1249 2
a1250 1
depends: lib-depends misc-depends fetch-depends build-depends run-depends
d1262 1
a1262 1
.for _DEP in fetch build run lib misc
d1325 1
a1325 1
fetch checksum extract patch configure all build install \
d1451 2
a1452 1
.if defined(ALWAYS_PACKAGE)
d1454 1
a1454 1
.else
d1456 1
a1456 1
.endif
d1668 21
d2625 1
a2625 1
   addsum all build build-depends checkpatch \
@


1.466
log
@In bulk, ftp/cdrom must be non interactive as well.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.465 2001/09/30 12:26:57 espie Exp $$
a275 3
NO_DEPENDS?= No
NO_BUILD?= No

d284 3
a1066 10
.if defined(ERRORS)
.BEGIN:
.  for _m in ${ERRORS}
	@@echo 1>&2 ${_m}
.  endfor
.  if !empty(ERRORS:M"Fatal\:*")
	@@exit 1
.  endif
.endif

d2576 10
@


1.465
log
@More stringent PERMIT_* checking: if any info is missing, assume
the maintainer made a mistake, and turn everything to No.
Record it as _BAD_LICENSING for describe purpose.

Yep, having this as ERRORS is obnoxious.

Then, we can rely on PERMIT_* always being defined.

Rewrite ftp-packages/cdrom-packages to use more current rules. Fixes
naddy's issue of ignoring IGNORE.  Use a .for loop, since those rules
are basically identical.

No longer use them to try and record port logging, as we have a much better
script to do that.

`Enhance' bulk-packages to do ftp-packages/cdrom-packages linking as well,
so that one single sweep of the tree should be enough for everything.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.464 2001/09/30 11:27:05 espie Exp $$
d1816 1
a1816 1
	@@exec ${MAKE} ftp-packages cdrom-packages
@


1.464
log
@Enforce /nonexistent for non-package/install/reinstall dep.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.463 2001/09/29 17:36:02 espie Exp $$
d206 12
a1342 1
# You need to define PERMIT_* to make the warning go away.
a1344 5
.  if !defined(PERMIT_PACKAGE_CDROM) || !defined(PERMIT_PACKAGE_FTP) || \
    !defined(PERMIT_DISTFILES_CDROM) || !defined(PERMIT_DISTFILES_FTP)
	@@echo >&2 "*** The licensing info for this port is incomplete."
	@@echo >&2 "*** Please notify the OpenBSD port maintainer: ${MAINTAINER}"
.  endif
d1816 1
d1818 4
a1821 6
all-packages: ${PKGFILE${SUBPACKAGE}}
.if defined(MULTI_PACKAGES) && empty(SUBPACKAGE)
.  for _sub in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' exec ${MAKE} ${.TARGET}
.  endfor
.endif
d1823 7
a1829 8
# Invoke "make cdrom-packages CDROM_PACKAGES=/cdrom/snapshots/packages"
.if defined(PERMIT_PACKAGE_CDROM) && ${PERMIT_PACKAGE_CDROM:L} == "yes"
cdrom-packages: ${CDROM_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
.else
cdrom-packages:
.endif
.if defined(MULTI_PACKAGES) && empty(SUBPACKAGE)
.  for _sub in ${MULTI_PACKAGES}
d1831 2
a1832 2
.  endfor
.endif
d1834 12
a1845 11
# Invoke "make ftp-packages FTP_PACKAGES=/pub/OpenBSD/snapshots/packages"
.if defined(PERMIT_PACKAGE_FTP) && ${PERMIT_PACKAGE_FTP:L} == "yes"
ftp-packages: ${FTP_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
.else
ftp-packages:
.endif
.if defined(MULTI_PACKAGES) && empty(SUBPACKAGE)
.  for _sub in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' exec ${MAKE} ${.TARGET}
.  endfor
.endif
d1847 1
a1848 16
${PKGFILE${SUBPACKAGE}}:
	@@mkdir -p ${PORTSDIR}/logs/${MACHINE_ARCH}
	@@cd ${.CURDIR} && exec ${MAKE} package ALWAYS_PACKAGE=Yes 2>&1 | \
		tee ${PORTSDIR}/logs/${MACHINE_ARCH}/${FULLPKGNAME}.log

${FTP_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}: ${PKGFILE${SUBPACKAGE}}
	@@mkdir -p ${FTP_PACKAGES}
	@@rm -f ${FTP_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
	@@ln ${PKGFILE${SUBPACKAGE}} ${FTP_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX} 2>/dev/null || \
	cp -p ${PKGFILE${SUBPACKAGE}} ${FTP_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}

${CDROM_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}: ${PKGFILE${SUBPACKAGE}}
	@@mkdir -p ${CDROM_PACKAGES}
	@@rm -f ${CDROM_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
	@@ln ${PKGFILE${SUBPACKAGE}} ${CDROM_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX} 2>/dev/null || \
	cp -p ${PKGFILE${SUBPACKAGE}} ${CDROM_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
d2052 1
a2052 1
.  if defined(PERMIT_DISTFILES_FTP) && ${PERMIT_DISTFILES_FTP:L} == "yes"
d2055 1
a2055 1
.  if defined(PERMIT_DISTFILES_CDROM) && ${PERMIT_DISTFILES_CDROM:L} == "yes"
d2215 3
a2217 1
.    if defined(PERMIT_PACKAGE_CDROM)
a2222 5
.  	 else
	@@echo -n "?|"
.	 endif	

.	 if defined(PERMIT_PACKAGE_FTP)
a2227 6
.	 else
	@@echo -n "?|"
.	 endif	


.	 if defined(PERMIT_DISTFILES_CDROM)
a2232 6
.	 else
		@@echo -n "?|"
.	 endif	


.	 if defined(PERMIT_DISTFILES_FTP)
a2237 2
.	 else
	@@echo "?"
@


1.463
log
@Enforce correct use of SUBPACKAGE.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.462 2001/09/28 01:48:58 naddy Exp $$
a1200 1
	what=$$pkg; \
d1232 1
a1232 1
_misc_depends_fragment = what=$$pkg; :
d1256 2
a1257 1
		*) early_exit=true;; esac; \
d1275 1
@


1.462
log
@remove last vestiges of NO_INSTALL; ok espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.461 2001/09/27 10:34:19 espie Exp $$
d42 3
@


1.461
log
@Let PATCH_LIST handle absolute paths.
make sure update-patches can handle lists (naddy@@).
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.460 2001/09/21 11:41:17 espie Exp $$
a74 1
# NO_INSTALL	- Use a dummy (do-nothing) install target.
@


1.460
log
@quote |. Thanks naddy@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.459 2001/09/19 16:03:09 espie Exp $$
d1554 1
a1554 1
	@@if cd ${PATCHDIR} 2>/dev/null; then \
d1571 3
a1573 5
						echo "===>   Can't find patch matching $$i"; \
						if [ -d ${PATCHDIR}/CVS -a "$$i" = \
							"${PATCHDIR}/patch-*" ]; then \
								echo "===>   Perhaps you forgot the -P flag to cvs co or update?"; \
								error=true; \
d2035 3
a2037 2
	@@toedit=`WRKDIST=${WRKDIST} PATCHDIR=${PATCHDIR} PATCH_LIST=${PATCH_LIST} \
		DIFF_ARGS=${DIFF_ARGS} DISTORIG=${DISTORIG} PATCHORIG=${PATCHORIG} \
@


1.459
log
@Update dependencies (kill first part when needed).

Update japanese/README... 2.4 is looong past.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.458 2001/09/19 15:16:39 espie Exp $$
d1249 1
a1249 1
${WRKDIR}/.${_DEP}${_i:C,[:./<=>*],-,g}: ${_WRKDIR_COOKIE}
d1297 1
a1297 1
_DEP${_DEP}_COOKIES+=${WRKDIR}/.${_DEP}${_i:C,[:./<=>*],-,g}
@


1.458
log
@show what is actually checked (the pkg, no longer the file)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.457 2001/09/16 14:56:42 espie Exp $$
d349 1
a349 1
BUILD_DEPENDS+=		${GMAKE}::devel/gmake
d356 1
a356 1
BUILD_DEPENDS+=		${AUTOCONF}::devel/autoconf
d364 1
a364 1
BUILD_DEPENDS+=		${LIBTOOL}::devel/libtool
d382 1
a382 1
LIB_DEPENDS+=		Xm.1.::x11/lesstif
d384 1
a384 1
LIB_DEPENDS+=		Xm.2.::x11/openmotif
d388 1
a388 1
LIB_DEPENDS+=		Xm.1.::x11/lesstif
d390 1
a390 1
LIB_DEPENDS+=		Xm.2.::x11/openmotif
d969 1
a969 1
BUILD_DEPENDS+=		${UNZIP}::archivers/unzip
d973 1
a973 1
BUILD_DEPENDS+=		${BZIP2}::archivers/bzip2
@


1.457
log
@Handles the case where CONFIGURE_SCRIPT is an absolute path gracefully
(to deal with a common shared Cygnus configure)

Move MODGNU_configure definition to gnu.port.mk. Should have done that on
creation.

Typo in brad's hack (to be superseded shortly anyways)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.456 2001/09/14 15:04:23 espie Exp $$
d1199 1
d1212 1
d1222 1
d1231 1
a1231 1
_misc_depends_fragment = :
d1278 1
a1278 1
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}} depends on: $$dep - found"; \
d1282 1
a1282 1
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}} depends on: $$dep -$$msg"; \
d1285 1
a1285 1
			${ECHO_MSG} "===>  Verifying $$target for $$dep in $$dir"; \
@


1.456
log
@Trust packages for all dependencies except libs.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.455 2001/09/13 09:12:45 ho Exp $$
d999 4
a1002 1
.if defined(SEPARATE_BUILD)
d1004 1
a1004 1
.else
d1006 1
d1008 1
a1602 2
MODGNU_configure= ${MODSIMPLE_configure}
	
@


1.455
log
@Fix a typo that prevented a number of ports from building correctly. heko@@ ok.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.454 2001/09/07 10:56:50 espie Exp $$
a1192 1
.if ${TRUST_PACKAGES:L} == "yes"
d1200 2
a1202 1

a1203 18
_fetch_depends_fragment= \
	case $$dep in \
	/*) \
		if [ -e "$$dep" ]; then \
			found=true; \
		fi;; \
	*) \
		p=${PORTPATH}; IFS=:; for d in $$p; do \
			if [ -x $$d/$$dep ]; then \
				found=true; \
				break; \
			fi \
		done; unset IFS;; \
	esac

_build_depends_fragment = ${_fetch_depends_fragment}
_run_depends_fragment = ${_fetch_depends_fragment}; earlyexit=true

@


1.454
log
@* is special too
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.453 2001/09/07 09:48:23 espie Exp $$
d1686 1
a1686 1
.  if target(pre_fake)
@


1.453
log
@Protect expression against empty results. Will at least prevent syntax
errors.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.452 2001/09/06 21:33:39 espie Exp $$
d1259 1
a1259 1
${WRKDIR}/.${_DEP}${_i:C,[:./<=>],-,g}: ${_WRKDIR_COOKIE}
d1307 1
a1307 1
_DEP${_DEP}_COOKIES+=${WRKDIR}/.${_DEP}${_i:C,[:./<=>],-,g}
@


1.452
log
@More special chars to remove to create files.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.451 2001/09/05 11:59:54 espie Exp $$
d1673 1
a1673 1
	@@if [ `${SUDO} ${SH} -c umask` != ${DEF_UMASK} ]; then \
@


1.451
log
@If pkg_create fails, you may still have a partial package out there...
Owned by root. Ouch.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.450 2001/09/05 09:13:18 espie Exp $$
d1259 1
a1259 1
${WRKDIR}/.${_DEP}${_i:C,[:./=],-,g}: ${_WRKDIR_COOKIE}
d1307 1
a1307 1
_DEP${_DEP}_COOKIES+=${WRKDIR}/.${_DEP}${_i:C,[:./],-,g}
@


1.450
log
@Use cookies for dependencies as well, and for the creation of a workdir.
This can speed up some iterations, as a dependency won't be checked more
than once. This also allows for make extract NO_DEPENDS=Yes, then later
to have the dependencies pulled in at configure stage (even though this
might not work all the time, as some dependencies may be needed earlier
but then you'll certainly notice).
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.448 2001/08/28 08:09:31 espie Exp $$
d1781 1
a1781 1
	    ${MAKE} delete-package; \
@


1.449
log
@LIB_DEPENDS tweaks.
- allow for several libraries, separated by commas.
- try to heed dependency most closely. Notably, make sure the spec
stops at a sensible place. This may break some ill-formed dependencies.
@
text
@d462 1
d488 3
a490 1
${_DISTPATCH_COOKIE} ${_PREPATCH_COOKIE} ${_FAKE_COOKIE}
d1256 1
a1256 1
${_DEP}-depends:
d1259 1
d1306 2
d1310 1
d1314 1
d1440 8
a1447 4
patch: ${_PATCH_COOKIE}
distpatch: ${_DISTPATCH_COOKIE}
configure: ${_CONFIGURE_COOKIE}
all build: ${_BUILD_COOKIE}
d1471 10
a1480 1
${_EXTRACT_COOKIE}:
a1489 6
.  if defined(WRKOBJDIR)
	@@${_create_wrkobjdir}
.  else
	@@rm -rf ${WRKDIR}
	@@mkdir -p ${WRKDIR}
.  endif
@


1.448
log
@Enforce the order of MOD*_configure fragments to match CONFIGURE_STYLE.
Create pseudo gnu/simple fragments to make the situation more regular.
Found by aaron@@.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.447 2001/08/27 08:50:30 espie Exp $$
d1221 7
a1227 5
	lib=`echo $$dep | sed -e 's|\([^\\]\)[\\\.].*|\1|'`; \
	tmp=`mktemp /tmp/bpmXXXXXXXXXX`; \
	if ${LD} -r -o $$tmp ${EXTRA_LIBDIRS:S/^/-L/} -L${LOCALBASE}/lib -L${X11BASE}/lib -l$$lib; then \
		found=true; \
	fi
d1230 5
a1234 3
	lib=`echo $$dep | sed -e 's|\([^\\]\)\.|\1\\\\.|g'`; \
	check=`${LDCONFIG} -r | awk "/-l$$lib/"'{ print $$3 }'`; \
	case "X$$check" in "X") ;; *) found=true;; esac 
d1281 1
a1281 1
			*) \
d1287 2
a1288 1
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}} depends on: $$dep - not found"; \
@


1.447
log
@Turns out modules have to go through infrastructure anyways, because
there's no easy way to reparse the Makefile afterwards...

Turns module absence into mild error (Fatal ?)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.446 2001/08/27 08:47:37 espie Exp $$
d589 1
a589 1
.for _i in perl imake gnu
d1586 12
d1614 3
a1616 3
.  for _m in ${MODULES}
.    if ${CONFIGURE_STYLE:L:M${_m:L}} && defined(MOD${_m:U}_configure)
	@@${MOD${_m:U}_configure}
a1618 10
.  if ${CONFIGURE_STYLE:L:Msimple} || ${CONFIGURE_STYLE:L:Mgnu}
	@@cd ${WRKBUILD} && CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
		CXX="${CXX}" ac_cv_path_CXX="${CXX}" CXXFLAGS="${CXXFLAGS}" \
		INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
		ac_given_INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
		INSTALL_PROGRAM="${INSTALL_PROGRAM}" INSTALL_MAN="${INSTALL_MAN}" \
		INSTALL_SCRIPT="${INSTALL_SCRIPT}" INSTALL_DATA="${INSTALL_DATA}" \
		YACC="${YACC}" \
		${CONFIGURE_ENV} ${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS}
.  endif
@


1.446
log
@fix dependencies's early_exit logic.
Turns out this can be done based on target, directly, instead of
relying on /nonexistent.

One step closer to turning TRUST_PACKAGES=Yes on by default...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.445 2001/08/26 21:42:18 brad Exp $$
d596 1
a596 5
.  if exists(${FILESDIR}/${_m}.port.mk)
.    include "${FILESDIR}/${_m}.port.mk"
.  elif exists(${LOCALBASE}/share/mk/${_m}.port.mk)
.    include "${LOCALBASE}/share/mk/${_m}.port.mk"
.  elif exists(${PORTSDIR}/infrastructure/mk/${_m}.port.mk)
d598 2
@


1.445
log
@add LIBTOOL to MAKE_FLAGS when USE_LIBTOOL is defined.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.444 2001/08/25 11:23:46 espie Exp $$
a1249 1
_EARLY_EXIT?=false
d1254 1
a1254 1
	@@unset _EARLY_EXIT PACKAGING DEPENDS_TARGET FLAVOR SUBPACKAGE || true; \
d1258 2
d1278 2
a1279 2
			"/nonexistent") earlyexit=true;; \
			*) earlyexit=${_EARLY_EXIT}; \
d1712 1
a1712 1
	@@cd ${.CURDIR} && DEPENDS_TARGET=package _EARLY_EXIT=true exec ${MAKE} run-depends lib-depends
@


1.444
log
@Cut out some parts of bsd.port.mk into separate modules.

This is work-in-progress. Supplemental hooks will be added when they
become necessary.

The goal is to permit separate subsystems to tweak the package building
process slightly. This should help e.g., python or qt2, for instance.

Documentation will come when it's tested more thoroughly...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.443 2001/08/24 14:43:28 todd Exp $$
d338 6
d367 1
a522 5
.endif

MAKE_FLAGS?=	
.if !defined(FAKE_FLAGS)
FAKE_FLAGS=${DESTDIRNAME}=${WRKINST}
@


1.443
log
@implement $PATCHORIG, a variable with the ability to change from .orig to
another suffix for 'update-patches' and 'patch', since there are some
distfiles that have foo and foo.orig already; ok espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.442 2001/08/24 14:39:36 espie Exp $$
d204 4
a486 3
XMKMF?=			xmkmf -a
XMKMF+=			-DPorts

d582 20
a838 9
ALL_TARGET?=		all
INSTALL_TARGET?=	install

.if ${CONFIGURE_STYLE:L:Mimake} && empty(CONFIGURE_STYLE:L:Mnoman)
INSTALL_TARGET+=	install.man
.endif

FAKE_TARGET ?= ${INSTALL_TARGET}

a1002 15
.if ${CONFIGURE_STYLE:L:Mgnu}
.  if ${CONFIGURE_STYLE:L:Mdest}
CONFIGURE_ARGS+=	--prefix='$${${DESTDIRNAME}}${PREFIX}'
.  else
CONFIGURE_ARGS+=	--prefix='${PREFIX}'
.  endif
.  if empty(CONFIGURE_STYLE:L:Mold)
.    if ${CONFIGURE_STYLE:L:Mdest}
CONFIGURE_ARGS+=	--sysconfdir='$${${DESTDIRNAME}}${SYSCONFDIR}'
.    else
CONFIGURE_ARGS+=	--sysconfdir='${SYSCONFDIR}'
.    endif
.  endif
.endif

d1082 1
a1082 1
.  elif (!empty(CONFIGURE_STYLE:L:Mimake) || defined(USE_X11)) && !exists(${X11BASE})
d1601 5
a1605 14
.  if ${CONFIGURE_STYLE:L:Mperl}
	@@arch=`/usr/bin/perl -e 'use Config; print $$Config{archname}, "\n";'`; \
     cd ${WRKSRC}; ${SETENV} ${CONFIGURE_ENV} \
     /usr/bin/perl Makefile.PL \
     	PREFIX='$${${DESTDIRNAME}}${PREFIX}' \
		INSTALLSITELIB='$${${DESTDIRNAME}}${PREFIX}/libdata/perl5/site_perl' \
		INSTALLSITEARCH="\$${INSTALLSITELIB}/$$arch" \
		INSTALLPRIVLIB='$${${DESTDIRNAME}}/usr/./libdata/perl5' \
		INSTALLARCHLIB="\$${INSTALLPRIVLIB}/$$arch" \
		INSTALLMAN1DIR='$${${DESTDIRNAME}}${PREFIX}/man/man1' \
		INSTALLMAN3DIR='$${${DESTDIRNAME}}${PREFIX}/man/man3' \
		INSTALLBIN='$${PREFIX}/bin' \
		INSTALLSCRIPT='$${INSTALLBIN}' ${CONFIGURE_ARGS}
.  endif
a1615 12
.  if ${CONFIGURE_STYLE:L:Mimake}
	@@if [ -e ${X11BASE}/lib/X11/config/ports.cf ] || \
		fgrep >/dev/null 2>/dev/null Ports \
			${X11BASE}/lib/X11/config/OpenBSD.cf; then \
		cd ${WRKSRC} && ${SETENV} ${MAKE_ENV} ${XMKMF}; \
	else \
		echo >&2 "Error: your X installation is not recent enough"; \
		echo >&2 "Update to a more recent version, or use a ports tree"; \
		echo >&2 "that predates March 18, 2000"; \
		exit 1; \
	fi
.  endif
d1657 3
a1659 2
.  if ${CONFIGURE_STYLE:L} == "perl"
	@@${SUDO} mkdir -p ${WRKINST}`/usr/bin/perl -e 'use Config; print $$Config{installarchlib}, "\n";'`
d1661 1
d1663 1
a1663 1
.  if target(pre-fake)
d1711 5
a1715 7
# Kludge
.  if ${CONFIGURE_STYLE:Mimake}
	@@${SUDO} mkdir -p /usr/local/lib/X11
	@@if [ ! -e /usr/local/lib/X11/app-defaults ]; then \
		${SUDO} ln -sf /var/X11/app-defaults /usr/local/lib/X11/app-defaults; \
	fi
.  endif
@


1.442
log
@Fix clean/dist
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.441 2001/08/21 22:22:57 naddy Exp $$
d532 1
d538 1
a538 1
PATCH_ARGS?=	-d ${WRKDIST} -E ${PATCH_STRIP}
d541 1
a541 1
PATCH_ARGS?=	-d ${WRKDIST} --forward --quiet -E ${PATCH_STRIP}
d2051 1
a2051 1
		DIFF_ARGS=${DIFF_ARGS} DISTORIG=${DISTORIG} \
@


1.441
log
@typo: break to accidentally joined lines
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.440 2001/08/18 23:16:57 brad Exp $$
d1993 9
a2001 1
	@@exec ${MAKE} distclean
d2024 2
a2025 10
distclean: pre-distclean clean
	@@${ECHO_MSG} "===>  Dist cleaning for ${FULLPKGNAME${SUBPACKAGE}}"
	@@if cd ${FULLDISTDIR} 2>/dev/null; then \
		if [ "${_DISTFILES}" -o "${_PATCHFILES}" ]; then \
			rm -f ${_DISTFILES} ${_PATCHFILES}; \
		fi \
	fi
.  if defined(DIST_SUBDIR)
	-@@rmdir ${FULLDISTDIR}  
.  endif
@


1.440
log
@drop old compatibility cruft and make USE_ZIP/USE_BZIP2 internal variables
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.439 2001/08/17 03:23:04 brad Exp $$
d1865 2
a1866 1
${CDROM_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}: ${PKGFILE${SUBPACKAGE}} @@mkdir -p ${CDROM_PACKAGES}
@


1.439
log
@remove some old cruft to do with tar that does not pertain to us.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.438 2001/08/16 15:15:24 espie Exp $$
a887 8
# Compatibility game: if USE_ZIP or USE_BZIP2 is already defined, set
# EXTRACT_SUFX
.if defined(USE_ZIP)
EXTRACT_SUFX?=.zip
.elif defined(USE_BZIP2)
EXTRACT_SUFX?=.tar.bz2
.endif

d939 1
a939 1
USE_ZIP?=	Yes
d942 1
a942 1
USE_BZIP2?=	Yes
d944 2
a945 2
USE_ZIP?= No
USE_BZIP2?= No
d952 1
a952 1
.if ${USE_ZIP:L} != "no"
d956 1
a956 1
.if ${USE_BZIP2:L} != "no"
d968 1
a968 1
.if ${USE_BZIP2:L} != "no"
@


1.438
log
@Fix (used bad patch version...) _PKGFILE->PKGFILE.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.437 2001/08/16 15:13:17 espie Exp $$
a549 1
.if exists(/bin/tar)
a550 3
.else
TAR?=	/usr/bin/tar
.endif
@


1.437
log
@Use new make feature.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.436 2001/08/16 14:49:31 espie Exp $$
d2009 1
a2009 1
	${SUDO} ${PKG_DELETE} ${clean:M-f} ${_FULLPKGNAME${_s}}
d2012 1
a2012 1
	${SUDO} ${PKG_DELETE} ${clean:M-f} ${_FULLPKGNAME${SUBPACKAGE}}
d2018 1
a2018 1
	rm -f ${_PKGFILE${SUBPACKAGE}}
@


1.436
log
@Change WRKDIR name, to flatten things somewhat.
work-* is too long, because we want to include the PKGNAME in the dir name
(so that PKGNAME changes are less likely to work with old work directories)

Change the way clean works, so that you can say
make clean='dist depends packages' and have it do what you think it should
do.

Common fragment to _create_wrkobjdir.

Put some info into PACKAGING (name of subpackage being built)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.435 2001/08/12 11:33:10 espie Exp $$
d1426 5
a1430 10
	@@set -- ${PROBLEMS}; \
	 while [ $$# -gt 0 ]; do \
		file=$$1; \
		cipher=$$2; \
		value=$$3; \
		shift; shift; shift; \
		rm ${FULLDISTDIR}/$$file; \
		cd ${.CURDIR} && ${MAKE} ${FULLDISTDIR}/$$file \
			MASTER_SITE_OVERRIDE="ftp://ftp.openbsd.org/pub/OpenBSD/distfiles/$$cipher/$$value/"; \
	done;
a1431 1

@


1.435
log
@Change PKGNAME and FULLPKGNAME semantics slightly.
Since those are mostly infrastructure-side, making SUBPACKAGE transparent
only adds to the confusion, so don't interpolate SUBPACKAGE into
FULLPKGNAME, hiding it into _FULLPKGNAME, but rather let FULLPKGNAME
tag the main package, and use FULLPKGNAME-foo for subpackage -foo.

This will simplify some other stuff...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.434 2001/08/07 11:46:17 heko Exp $$
d204 9
d244 11
d563 1
a563 1
WRKDIR?=		${.CURDIR}/work${FLAVOR_EXT}.${MACHINE_ARCH}
d566 1
a566 1
WRKDIR?=		${.CURDIR}/work
d568 1
a568 1
WRKDIR?=		${.CURDIR}/work${FLAVOR_EXT}
d578 1
d581 1
a583 1
WRKPKG?=		${WRKBUILD}/pkg
d598 1
a598 1
	@@cd ${.CURDIR} && SUBPACKAGE='' FLAVOR='${FLAVOR}' PACKAGING=true exec ${MAKE} _package
d612 1
a612 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' FLAVOR='${FLAVOR}' PACKAGING=true exec ${MAKE} _package
a1068 7
.if defined(show)
VARNAME=${show}
.MAIN: show
.else
.MAIN: all
.endif

d1460 10
d1484 1
a1484 8
	@@rm -rf ${WRKOBJDIR}/${FULLPKGPATH}
	@@mkdir -p ${WRKOBJDIR}/${FULLPKGPATH}
	@@if [ ! -L ${WRKDIR} ] || \
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${FULLPKGPATH} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${FULLPKGPATH}"; \
		rm -f ${WRKDIR}; \
		ln -sf ${WRKOBJDIR}/${FULLPKGPATH} ${WRKDIR}; \
	fi
d1909 1
a1909 8
	@@rm -rf ${WRKOBJDIR}/${FULLPKGPATH}
	@@mkdir -p ${WRKOBJDIR}/${FULLPKGPATH}
	@@if [ ! -L ${WRKDIR} ] || \
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${FULLPKGPATH} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${FULLPKGPATH}"; \
		rm -f ${WRKDIR}; \
		ln -sf ${WRKOBJDIR}/${FULLPKGPATH} ${WRKDIR}; \
	fi
d1991 1
a1991 1
.  if ${CLEANDEPENDS:L} == "yes"
d1995 1
d1997 8
d2007 19
d2221 1
a2221 1
	@@cd ${.CURDIR} && SUBPACKAGE='${SUBPACKAGE}' FLAVOR='${FLAVOR}' PACKAGING=true exec ${MAKE} describe
d2295 1
a2295 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' PACKAGING=true exec ${MAKE} describe
@


1.434
log
@o Shared works on alpha post-2.9;
  remove it from the NO_SHARED_ARCHS list
naddy@@ ok
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD$$
d414 3
a416 8
.if defined(FULLPKGNAME)
_FULLPKGNAME=${FULLPKGNAME}
.elif defined(PKGNAME)
_FULLPKGNAME=${PKGNAME}${FLAVOR_EXT}
.else
_FULLPKGNAME=${DISTNAME}${FLAVOR_EXT}
.endif
_PKGFILE=${PKGREPOSITORY}/${_FULLPKGNAME}${PKG_SUFX}
d420 6
a425 6
.    if defined(FULLPKGNAME${_s})
_FULLPKGNAME${_s} = ${FULLPKGNAME${_s}}
.    elif defined(PKGNAME${_s})
_FULLPKGNAME${_s} = ${PKGNAME${_s}}${FLAVOR_EXT}
.    else
_FULLPKGNAME${_s} = ${DISTNAME}${_s}${FLAVOR_EXT}
d427 1
a427 1
_PKGFILE${_s} = ${PKGREPOSITORY}/${_FULLPKGNAME${_s}}${PKG_SUFX}
a430 6
# Backward compatibility, for now
FULLPKGNAME?=${_FULLPKGNAME${SUBPACKAGE}}
PKGNAME?=		${DISTNAME}${SUBPACKAGE}

PKGFILE?=		${PKGREPOSITORY}/${FULLPKGNAME}${PKG_SUFX}

d435 1
a435 1
_INSTALL_COOKIE=	${PKG_DBDIR}/${FULLPKGNAME}/+CONTENTS
d445 1
a445 1
_PACKAGE_COOKIE=	${_PKGFILE}
d583 1
a583 1
_PACKAGE_COOKIE${_s} = ${_PKGFILE${_s}}
d705 1
a705 1
	@@self=${FULLPKGNAME} exec ${MAKE} new-depends|sort -u >>$@@.tmp
d1108 1
a1108 1
IGNORE= "-- ${FULLPKGNAME:C/-[0-9].*//g} comes with ${OPSYS} as of release ${COMES_WITH}"
d1245 3
d1259 1
a1259 1
			eval $$toset ${MAKE} show VARNAME=FULLPKGNAME`;; esac; \
d1279 1
a1279 1
					${ECHO_MSG} "===>  ${FULLPKGNAME} depends on: $$dep - found"; \
d1282 1
a1282 1
					${ECHO_MSG} "===>  ${FULLPKGNAME} depends on: $$dep - not found"; \
d1287 1
a1287 1
				${ECHO_MSG} "===> Returning to build of ${FULLPKGNAME}"; \
d1305 1
a1305 1
	@@${ECHO_MSG} "===>  ${FULLPKGNAME} ${IGNORE}."
d1732 1
a1732 1
	@@${ECHO_MSG} "===>  Installing ${_FULLPKGNAME${SUBPACKAGE}} from ${_PKGFILE${SUBPACKAGE}}"
d1741 2
a1742 2
	@@if pkg dependencies check ${_FULLPKGNAME${SUBPACKAGE}}; then \
		echo "Package ${_FULLPKGNAME${SUBPACKAGE}} is already installed"; \
d1744 1
a1744 1
		${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKGFILE${SUBPACKAGE}}; \
d1747 1
a1747 1
	@@${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${_PKGFILE${SUBPACKAGE}}
d1763 1
a1763 1
	@@${ECHO_MSG} "===>  Building package for ${_FULLPKGNAME${SUBPACKAGE}}"
d1778 2
a1779 2
	  if ${SUDO} ${PKG_CMD} ${PKG_ARGS} ${_PKGFILE${SUBPACKAGE}}; then \
	    mode=`id -u`:`id -g`; ${SUDO} ${CHOWN} $${mode} ${_PKGFILE${SUBPACKAGE}}; \
d1792 1
a1792 1
	@@${ECHO_MSG} "===>  ${_FULLPKGNAME${SUBPACKAGE}} may not be packaged: ${NO_PACKAGE}."
d1823 1
a1823 1
all-packages: ${PKGFILE}
d1832 1
a1832 1
cdrom-packages: ${CDROM_PACKAGES}/${FULLPKGNAME}${PKG_SUFX}
d1844 1
a1844 1
ftp-packages: ${FTP_PACKAGES}/${FULLPKGNAME}${PKG_SUFX}
d1855 1
a1855 1
${PKGFILE}:
d1860 1
a1860 1
${FTP_PACKAGES}/${FULLPKGNAME}${PKG_SUFX}: ${PKGFILE}
d1862 8
a1869 9
	@@rm -f ${FTP_PACKAGES}/${FULLPKGNAME}${PKG_SUFX}
	@@ln ${PKGFILE} ${FTP_PACKAGES}/${FULLPKGNAME}${PKG_SUFX} 2>/dev/null || \
	cp -p ${PKGFILE} ${FTP_PACKAGES}/${FULLPKGNAME}${PKG_SUFX}

${CDROM_PACKAGES}/${FULLPKGNAME}${PKG_SUFX}: ${PKGFILE}
	@@mkdir -p ${CDROM_PACKAGES}
	@@rm -f ${CDROM_PACKAGES}/${FULLPKGNAME}${PKG_SUFX}
	@@ln ${PKGFILE} ${CDROM_PACKAGES}/${FULLPKGNAME}${PKG_SUFX} 2>/dev/null || \
	cp -p ${PKGFILE} ${CDROM_PACKAGES}/${FULLPKGNAME}${PKG_SUFX}
d1921 1
a1921 1
		ln -s ../${PKGREPOSITORYSUBDIR}/${FULLPKGNAME}${PKG_SUFX} ${PACKAGES}/$$cat; \
d1927 1
a1927 1
	@@cd ${PACKAGES} && find . -type l -name ${FULLPKGNAME}${PKG_SUFX}|xargs rm -f
d1933 1
a1933 1
	@@rm -f ${_PKGFILE${SUBPACKAGE}}
d1950 1
a1950 1
	@@${SUDO} ${PKG_DELETE} -f ${FULLPKGNAME}
d1965 2
a1966 2
	@@${ECHO_MSG} "===> Deinstalling for ${FULLPKGNAME}"
	@@${SUDO} ${PKG_DELETE} -f ${FULLPKGNAME}
d1984 1
a1984 1
	@@${ECHO_MSG} "===>  Cleaning for ${FULLPKGNAME}"
d1996 1
a1996 1
	@@${ECHO_MSG} "===>  Dist cleaning for ${FULLPKGNAME}"
d2117 1
a2117 1
	@@${_DEPEND_ECHO} '${PKGPATH}/${FULLPKGNAME}'
d2119 1
a2119 1
	@@${_DEPEND_ECHO} '${FULLPKGNAME}'
d2185 1
a2185 1
	@@echo -n "${FULLPKGNAME}|${FULLPKGPATH}|"
d2265 1
a2265 1
	@@echo ${FULLPKGNAME} | ${HTMLIFY} > $@@.tmp3
@


1.433
log
@Restore sudo in make deinstall. Naddy, Joshua Stein, and myself...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.432 2001/07/30 15:07:49 espie Exp $$
d216 1
a216 1
NO_SHARED_ARCHS=alpha hppa mvme88k vax
@


1.432
log
@More trouble... Revert sed -e so that it will work.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.431 2001/07/30 14:55:07 espie Exp $$
d1975 1
a1975 1
	@@${PKG_DELETE} -f ${FULLPKGNAME}
@


1.431
log
@Tsk, tsk.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.430 2001/07/30 14:45:26 jsyn Exp $$
d951 1
a951 1
_SED_FIX_SHAR?=	sed -e '1,/^\#\![[:blank:]]*\/bin\/sh[[:space:]]*$$/d'
@


1.430
log
@Fix EXTRACT_CASES for shell archives (handles leading cruft, too!)
ok espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.429 2001/07/30 14:34:34 espie Exp $$
d951 1
a951 1
_SED_FIX_SHAR?=	sed -e '1,/^\#\![[:blank:]]*\/bin\/sh[[:space:]]*$/d'
@


1.429
log
@Pass PKG_TMPDIR thru to pkg_add. From Heikki Korpalla.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.428 2001/07/30 14:13:16 espie Exp $$
d951 2
d963 2
a964 2
EXTRACT_CASES+= *.shar.gz|*.shar.Z|*.sh.Z|*.sh.gz) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | /bin/sh;;
EXTRACT_CASES+= *.shar | *.sh) /bin/sh ${FULLDISTDIR}/$$archive;;
@


1.428
log
@Lots of internal changes.
- define _FULLPKGNAME* and _PKGFILE*. Use _PKGFILE* as package cookie
instead of package_done.
- use ${PKG_DBDIR}/${_FULLPKGNAME${SUBPACKAGE}/+CONTENTS as install cookie.

- BIN_PACKAGES variable. If set to yes, remove coupling between
PACKAGE_COOKIE and dependencies, so that binary packages exist
independently of working directories.

- mark packages as precious.

- change all refs to PKGFILE to _PKGFILE${SUBPACKAGE}.
- add bulk-packages target.

Note that BIN_PACKAGES and TRUST_PACKAGES are off by default.
This interface is likely to change. The name bulk-packages will probably
change as well.

We will probably get rid of the old PKGFILE/FULLPKGNAME (taking SUBPACKAGE
into account) and use the new PKGFILE/FULLPKGNAME
PKGFILE-foo/FULLPKGNAME-foo instead (with explicit subpackage information).
This is less confusing and simpler.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.427 2001/07/20 13:13:47 espie Exp $$
d747 1
d1750 1
a1750 1
		${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} pkg_add ${_PKGFILE${SUBPACKAGE}}; \
d1753 1
a1753 1
	@@${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} pkg_add ${_PKGFILE${SUBPACKAGE}}
@


1.427
log
@Move the whole definition of FLAVOR_EXT up, so that it can be used
directly.

Tighten the flavor check, so that ports without flavors error out if
flavors are specified.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.426 2001/07/20 13:02:47 espie Exp $$
d81 2
d206 1
d408 26
a433 6
.if ${SUBPACKAGE} != "" 
.  if defined(FULLPKGNAME${SUBPACKAGE})
FULLPKGNAME:=	${FULLPKGNAME${SUBPACKAGE}}
.  elif defined(PKGNAME${SUBPACKAGE})
PKGNAME:=		${PKGNAME${SUBPACKAGE}}
.  endif
d435 3
a438 1
FULLPKGNAME?=	${PKGNAME}${FLAVOR_EXT}
a439 3
PKGREPOSITORYSUBDIR?=	All
PKG_SUFX?=		.tgz
PKGREPOSITORY?=		${PACKAGES}/${PKGREPOSITORYSUBDIR}
d446 1
d456 1
a458 1
_INSTALL_COOKIE=	${WRKBUILD}/.install_done${SUBPACKAGE}
a459 1
_PACKAGE_COOKIE=	${WRKBUILD}/.package_done
a461 1
_INSTALL_COOKIE=	${WRKDIR}/.install_done${SUBPACKAGE}
a462 1
_PACKAGE_COOKIE=	${WRKDIR}/.package_done
d575 6
d582 6
a587 5
.  if ${FAKE:L} == "yes"
${_PACKAGE_COOKIE}: ${_FAKE_COOKIE}
.  else
${_PACKAGE_COOKIE}: ${_INSTALL_COOKIE}
.  endif
d593 6
a598 5
.for _sub in ${MULTI_PACKAGES}
_PACKAGE_COOKIE${_sub} = ${_PACKAGE_COOKIE}${_sub}
_PACKAGE_COOKIES+=  ${_PACKAGE_COOKIE${_sub}}
.  if ${FAKE:L} == "yes"
${_PACKAGE_COOKIE${_sub}}: ${_FAKE_COOKIE}
d600 1
a600 5
${_PACKAGE_COOKIE${_sub}}: ${_INSTALL_COOKIE}
.  endif
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' PACKAGING=true exec ${MAKE} _package
.  if !defined(PACKAGE_NOINSTALL)
	@@${_MAKE_COOKIE} $@@
d602 1
d605 2
a1430 5
uninstall deinstall:
	@@${ECHO_MSG} "===> Deinstalling for ${FULLPKGNAME}"
	@@${SUDO} ${PKG_DELETE} -f ${FULLPKGNAME}
	@@rm -f ${_INSTALL_COOKIE} ${_PACKAGE_COOKIES}

d1737 1
a1737 1
	@@${ECHO_MSG} "===>  Installing ${FULLPKGNAME} from ${PKGFILE}"
d1746 2
a1747 2
	@@if pkg dependencies check ${FULLPKGNAME}; then \
		echo "Package ${FULLPKGNAME} is already installed"; \
d1749 1
a1749 1
		${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} pkg_add ${PKGFILE}; \
d1752 1
a1752 1
	@@${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} pkg_add ${PKGFILE}
d1754 1
a1754 1
	@@${SUDO} ${_MAKE_COOKIE} $@@
d1768 1
a1768 1
	@@${ECHO_MSG} "===>  Building package for ${FULLPKGNAME}"
d1783 2
a1784 2
	  if ${SUDO} ${PKG_CMD} ${PKG_ARGS} ${PKGFILE}; then \
	    mode=`id -u`:`id -g`; ${SUDO} ${CHOWN} $${mode} ${PKGFILE}; \
d1797 1
a1797 1
	@@${ECHO_MSG} "===>  ${FULLPKGNAME} may not be packaged: ${NO_PACKAGE}."
d1825 3
d1939 1
a1939 1
	@@rm -f ${PKGFILE}
a1954 1
.if !target(reinstall)
d1956 1
a1956 1
	@@${SUDO} rm -f ${_INSTALL_PRE_COOKIE} ${_INSTALL_COOKIE} ${_PACKAGE_COOKIES}
a1957 1
.endif
a1969 1
.if !target(deinstall)
a1972 2
	@@rm -f ${_INSTALL_COOKIE}
.endif
a2134 9
.endif

# Build a package but don't rely on cookie for installation, also don't
# install package cookie

.if !target(package-noinstall)
package-noinstall:
	@@rm -f ${_PACKAGE_COOKIES}
	@@cd ${.CURDIR} && exec ${MAKE} PACKAGE_NOINSTALL=Yes ${_PACKAGE_COOKIES}
@


1.426
log
@While building a package, we check dependencies with
DEPENDS_TARGET=package. Thus, the second check may fail...
So make it possible to avoid the second check.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.425 2001/07/18 18:23:04 espie Exp $$
d372 4
d378 3
d382 12
a393 1
.  if defined(FLAVOR)
d400 2
a553 17

# Support architecture and flavor dependent packing lists
#
SED_PLIST?=

# Create the basic sed substitution pipeline for fragments
# (applies only to PLIST for now)
.if defined(FLAVORS)
.  for _i in ${FLAVORS:L}
.    if empty(FLAVOR:L:M${_i})
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/r${PKGDIR}/PFRAG.no-${_i}' -e '//d' -e '/^%%${_i}%%$$/d'
.    else
FLAVOR_EXT:=${FLAVOR_EXT}-${_i}
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/d' -e '/^%%${_i}%%$$/r${PKGDIR}/PFRAG.${_i}' -e '//d'
.    endif
.  endfor
.endif
@


1.425
log
@Move PKGFILE definition up, so that it can be used in dependencies.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.424 2001/07/18 16:19:47 espie Exp $$
d1223 1
d1228 1
a1228 1
	@@unset PACKAGING DEPENDS_TARGET FLAVOR SUBPACKAGE || true; \
d1251 1
a1251 1
			*) earlyexit=false; \
d1711 1
a1711 1
	@@cd ${.CURDIR} && DEPENDS_TARGET=package exec ${MAKE} run-depends lib-depends
@


1.424
log
@Knob DESTDIRNAME.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.423 2001/07/18 14:52:27 espie Exp $$
d372 28
a538 12

# Build FLAVOR_EXT, checking that no flavors are misspelled
FLAVOR_EXT:=
.if defined(FLAVORS)
.  if defined(FLAVOR)
.    for _i in ${FLAVOR:L}
.      if empty(FLAVORS:L:M${_i})
ERRORS+=	"Fatal: Unknown flavor: ${_i}"
ERRORS+= "   (Possible flavors are: ${FLAVORS})."
.      endif
.    endfor
.  endif
d541 1
a755 3
PKG_SUFX?=		.tgz


a860 1
# Derive names so that they're easily overridable.
a861 9
.if ${SUBPACKAGE} != "" 
.  if defined(FULLPKGNAME${SUBPACKAGE})
FULLPKGNAME:=	${FULLPKGNAME${SUBPACKAGE}}
.  elif defined(PKGNAME${SUBPACKAGE})
PKGNAME:=		${PKGNAME${SUBPACKAGE}}
.  endif
.endif
PKGNAME?=		${DISTNAME}${SUBPACKAGE}
FULLPKGNAME?=	${PKGNAME}${FLAVOR_EXT}
a948 4

PKGREPOSITORYSUBDIR?=	All
PKGREPOSITORY?=		${PACKAGES}/${PKGREPOSITORYSUBDIR}
PKGFILE?=		${PKGREPOSITORY}/${FULLPKGNAME}${PKG_SUFX}
@


1.423
log
@Synch with src (CDIAGFLAGS, CXXOPTS, WARNINGS)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.422 2001/07/17 16:11:45 espie Exp $$
d308 1
d442 1
a442 1
FAKE_FLAGS=DESTDIR=${WRKINST}
d449 1
a449 1
	TRUEPREFIX='${PREFIX}' DESTDIR=''
d961 1
a961 1
CONFIGURE_ARGS+=	--prefix='$${DESTDIR}${PREFIX}'
d967 1
a967 1
CONFIGURE_ARGS+=	--sysconfdir='$${DESTDIR}${SYSCONFDIR}'
d1587 2
a1588 2
     	PREFIX='$${DESTDIR}${PREFIX}' \
		INSTALLSITELIB='$${DESTDIR}${PREFIX}/libdata/perl5/site_perl' \
d1590 1
a1590 1
		INSTALLPRIVLIB='$${DESTDIR}/usr/./libdata/perl5' \
d1592 2
a1593 2
		INSTALLMAN1DIR='$${DESTDIR}${PREFIX}/man/man1' \
		INSTALLMAN3DIR='$${DESTDIR}${PREFIX}/man/man3' \
d1648 1
a1648 1
_FAKE_SETUP=TRUEPREFIX=${PREFIX} PREFIX=${WRKINST}${PREFIX} DESTDIR=${WRKINST}
@


1.422
log
@Replace .BEGIN lines with explicit ERRORS framework.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.421 2001/07/16 15:14:36 espie Exp $$
d426 11
@


1.421
log
@Replace X11 up-to-dateness test with something that will work with
recent XFree.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.420 2001/07/11 12:57:20 espie Exp $$
d36 1
a36 3
.BEGIN:
	@@echo "Need version ${NEED_VERSION} of bsd.port.mk"; \
	exit 1;
d41 1
a41 3
.BEGIN:
	@@echo "Use 'env FLAVOR=${FLAVOR} ${MAKE}' instead"
	@@exit 1
d358 1
a358 3
.BEGIN:
	@@echo >&2 "Unknown USE_MOTIF=${USE_MOTIF} settings"
	@@exit 1
d366 1
a366 3
.BEGIN:
	@@echo >&2 "Subpackage ${SUBPACKAGE} does not exist"
	@@exit 1
d506 2
a507 4
.BEGIN:
	@@echo >&2 "Unknown flavor: ${_i}"
	@@echo >&2 "Possible flavors are: ${FLAVORS}"
	@@exit 1
d645 1
a645 1
	@@echo 2>&1 "Error: missing comment"
d931 1
a931 3
.BEGIN:
	@@echo "CATEGORIES is mandatory."
	@@exit 1
d1003 10
@


1.420
log
@Don't append COPTS if it's not defined. This avoids passing
CFLAGS="-O2 -g " with extra unwanted spaces off to submakes.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.419 2001/07/03 12:06:13 espie Exp $$
d1598 10
a1607 8
.    if exists(${X11BASE}/lib/X11/config/ports.cf)
	@@cd ${WRKSRC} && ${SETENV} ${MAKE_ENV} ${XMKMF}
.    else
	@@echo >&2 "Error: your X installation is not recent enough"
	@@echo >&2 "Update to a more recent version, or use a ports tree"
	@@echo >&2 "that predates March 18, 2000"
	@@exit 1
.    endif
@


1.419
log
@Recognize both !%%SHARED%% and %%!SHARED%% temporarily, to match
!%%flavor%%  eventually.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.418 2001/06/30 19:06:09 matt Exp $$
d432 1
d434 1
@


1.418
log
@skip ports marked COMES_WITH on mirror-maker runs; ok espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.417 2001/06/22 07:21:24 jakob Exp $$
d667 2
a668 1
	@@sed -e '/^%%!SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
d673 2
a674 1
		sed -e '/^%%!SHARED%%$$/d' \
d679 2
a680 1
		sed -e '/^%%!SHARED%%$$/d' \
@


1.417
log
@take care of *.tar.gz before extracting any *.gz
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.415 2001/06/22 07:03:19 jakob Exp $$
d2014 1
d2016 1
a2016 1
.if defined(PERMIT_DISTFILES_FTP) && ${PERMIT_DISTFILES_FTP:L} == "yes"
d2018 2
a2019 2
.endif
.if defined(PERMIT_DISTFILES_CDROM) && ${PERMIT_DISTFILES_CDROM:L} == "yes"
d2021 1
a2021 1
.endif
d2024 1
@


1.416
log
@back out my broken handling of .gz
@
text
@d921 2
@


1.415
log
@handle .gz as EXTRACT_SUFX. ok espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.414 2001/06/03 14:42:07 espie Exp $$
a920 1
EXTRACT_CASES+= *.gz) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive >`basename $$archive .gz`;;
@


1.414
log
@Add support for PATCH_CASES, modelled on EXTRACT_CASES.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.413 2001/05/23 15:48:08 espie Exp $$
d921 1
@


1.413
log
@Fix quoting
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.412 2001/05/23 14:18:24 espie Exp $$
d901 1
a901 1
.if !empty(EXTRACT_ONLY:M*.tar.bz2)
d903 1
a903 1
.endif
d923 7
d1474 1
a1474 1
	  for i in ${_PATCHFILES}; do \
d1477 1
a1477 1
			*) ${ECHO_MSG} "===>   Applying distribution patch $$i" ;; \
d1479 2
a1480 7
		case $$i in \
			*.Z|*.gz) \
				${GZCAT} $$i | ${PATCH} ${PATCH_DIST_ARGS}; \
				;; \
			*) \
				${PATCH} ${PATCH_DIST_ARGS} < $$i; \
				;; \
@


1.412
log
@Smarter plist regen.
- back substitute VAR_SUBST (hence swap ARCH/MACHINE_ARCH)
- pass PKGDIR to make-plist.

- don't create PLIST-auto/PFRAG.shared-auto. Move originals around, and
create new ones directly (guard against accidentally deleting old ones).

Todo: add regexp to dispatch stuff to fragments automatically, based on
MULTI_PACKAGES.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.411 2001/05/23 13:28:14 espie Exp $$
d2159 1
a2159 1
	@@echo -n "${_COMMENT}|"; \
@


1.411
log
@kill some old stuff:
- all COMMENTs live in Makefiles now.
- NEW_DEPENDS is always on.
- 2.8 warning is woefully out of date (rohee@@)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.410 2001/05/22 11:46:17 espie Exp $$
d607 1
a607 1
SUBST_VARS+=ARCH MACHINE_ARCH HOMEPAGE PREFIX SYSCONFDIR FLAVOR_EXT
d1977 4
d1985 1
a1985 1
	perl ${PORTSDIR}/infrastructure/install/make-plist ${PLIST}
@


1.410
log
@Fix double describe for MULTI_PACKAGES
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.409 2001/05/19 20:07:00 espie Exp $$
a206 1
NEW_DEPENDS?=Yes
d644 1
a644 1
_COMMENT=echo ${COMMENT${SUBPACKAGE}${FLAVOR_EXT}:S/^-//}
d646 1
a646 7
_COMMENT=echo ${COMMENT${SUBPACKAGE}:S/^-//}
.else
.  if exists(${PKGDIR}/COMMENT${SUBPACKAGE}${FLAVOR_EXT})
_COMMENT=cat ${PKGDIR}/COMMENT${SUBPACKAGE}${FLAVOR_EXT}
.  else
_COMMENT=cat ${PKGDIR}/COMMENT${SUBPACKAGE}
.  endif
d650 5
a654 1
	@@${_COMMENT} >$@@
a664 1
.if ${NEW_DEPENDS:L} == "yes"
a665 1
.endif
a702 3
.if ${NEW_DEPENDS:L} != "yes"
PKG_ARGS+=-P "`cd ${.CURDIR} && SUBPACKAGE='${SUBPACKAGE}' ${MAKE} package-depends|${_SORT_DEPENDS}`"
.endif
a1405 4
.if ${OPSYS_VER} < 2.8
	@@${ECHO_MSG} "*** Warning: using a new ports tree on a ${OPSYS_VER} system"
	@@${ECHO_MSG} "*** Things may not work, as make was updated"
.endif
d2155 1
a2155 1
	@@echo -n "`${_COMMENT}`|"; \
d2162 1
a2162 2
.    if ${NEW_DEPENDS:L} == "yes"
.      if !empty(_ALWAYS_DEP2) || !empty(_BUILD_DEP2)
a2163 5
.      endif
.    else
.      if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || target(depends-list)
	@@cd ${.CURDIR} && echo -n `${MAKE} depends-list|${_SORT_DEPENDS}`
.      endif
d2166 1
a2166 2
.    if ${NEW_DEPENDS:L} == "yes"
.      if !empty(_ALWAYS_DEP2) || !empty(_RUN_DEP2)
a2167 5
.      endif
.    else
.      if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP) || target(package-depends)
	@@cd ${.CURDIR} && echo -n `${MAKE} package-depends|${_SORT_DEPENDS}`
.      endif
@


1.409
log
@Make sure assignment is unambiguous. Found out by naddy@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.408 2001/05/07 15:24:50 espie Exp $$
d2243 5
a2249 5
.  if defined(MULTI_PACKAGES) && empty(SUBPACKAGE)
.    for _sub in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' PACKAGING=true exec ${MAKE} describe
.    endfor
.  endif
@


1.408
log
@Avoid Makemaker's /usr/lib -> $(PREFIX)/lib substitution in a weird place.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.407 2001/05/05 23:42:03 miod Exp $$
d544 1
a544 1
_PACKAGE_COOKIE${_sub}= ${_PACKAGE_COOKIE}${_sub}
@


1.407
log
@Make MACHINE_ARCH available for PLIST.
Allow for MACHINE_ARCH specific files or patches, if no such files
for ARCH found.
Put compiled packages in MACHINE_ARCH directory, instead of ARCH.

All of this to improve support for compound architectures, mainly
m68k-based architectures at this time.

While there, mention mvme88k does not have shared libraries, to be
sure this isn't forgotten when mvme88k gets back in shape.

ok'ed by espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.406 2001/05/05 20:23:42 espie Exp $$
d1583 1
a1583 1
		INSTALLPRIVLIB='$${DESTDIR}/usr/libdata/perl5' \
@


1.406
log
@Minor fixes having to do with PACKAGING.
This repairs dependencies in some japanese ports.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.405 2001/04/20 16:25:24 espie Exp $$
d218 1
a218 1
NO_SHARED_ARCHS=alpha hppa vax
d245 4
d263 1
a263 1
PACKAGES?=		${PORTSDIR}/packages/${ARCH}
d266 2
a267 2
CDROM_PACKAGES?=	${PORTSDIR}/cdrom-packages/${ARCH}
FTP_PACKAGES?=		${PORTSDIR}/ftp-packages/${ARCH}
d272 3
d277 1
d284 3
d289 1
d294 3
d299 1
d304 3
d309 1
d495 1
a495 1
WRKBUILD?=		${WRKDIR}/build-${ARCH}${FLAVOR_EXT}
d608 1
a608 1
SUBST_VARS+=ARCH HOMEPAGE PREFIX SYSCONFDIR FLAVOR_EXT
d620 4
d633 4
d1823 1
a1823 1
	@@mkdir -p ${PORTSDIR}/logs/${ARCH}
d1825 1
a1825 1
		tee ${PORTSDIR}/logs/${ARCH}/${FULLPKGNAME}.log
d1985 1
a1985 1
# Note: add @@comment PACKAGE(arch=${ARCH}, opsys=${OPSYS}, vers=${OPSYS_VER})
@


1.405
log
@TRUST_PACKAGES: use actual installed packages to check dependencies
and avoid calling pkg_add.
Solve some of art's problems.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.404 2001/04/20 15:06:19 espie Exp $$
d1183 1
a1183 1
	@@unset DEPENDS_TARGET FLAVOR SUBPACKAGE || true; \
d2130 1
a2130 1
.  if !defined(PACKAGING) && ${SUBPACKAGE} != ""
@


1.405.2.1
log
@MFC: fixes that were discovered while building packages.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.406 2001/05/05 20:23:42 espie Exp $$
d1183 1
a1183 1
	@@unset PACKAGING DEPENDS_TARGET FLAVOR SUBPACKAGE || true; \
d2130 1
a2130 1
.  if !defined(PACKAGING) && defined(MULTI_PACKAGES)
@


1.405.2.2
log
@Partial report from recent bsd.port.mk changes, requested by espie:

Make MACHINE_ARCH available for PLIST.
Put compiled packages in MACHINE_ARCH directory, instead of ARCH.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.405.2.1 2001/05/05 20:34:19 espie Exp $$
d259 1
a259 1
PACKAGES?=		${PORTSDIR}/packages/${MACHINE_ARCH}
d262 2
a263 2
CDROM_PACKAGES?=	${PORTSDIR}/cdrom-packages/${MACHINE_ARCH}
FTP_PACKAGES?=		${PORTSDIR}/ftp-packages/${MACHINE_ARCH}
d475 1
a475 1
WRKBUILD?=		${WRKDIR}/build-${MACHINE_ARCH}${FLAVOR_EXT}
d588 1
a588 1
SUBST_VARS+=ARCH MACHINE_ARCH HOMEPAGE PREFIX SYSCONFDIR FLAVOR_EXT
d1795 1
a1795 1
	@@mkdir -p ${PORTSDIR}/logs/${MACHINE_ARCH}
d1797 1
a1797 1
		tee ${PORTSDIR}/logs/${MACHINE_ARCH}/${FULLPKGNAME}.log
d1957 1
a1957 1
# Note: add @@comment PACKAGE(arch=${MACHINE_ARCH}, opsys=${OPSYS}, vers=${OPSYS_VER})
@


1.405.2.3
log
@Hardcode the Makefile FULL_REVISION number, instead of using CVS
revision number.
Motivated by the need for -STABLE ports to rely on the changes made
in the previous commit, and besides, there shouldn't be many changes
to bsd.port.mk backported to -STABLE.

Ok espie@@
@
text
@d3 1
a3 4
# XXX REMEMBER TO CHANGE THIS NUMBER EVERYTIME YOU BACKPORT INCOMPATIBLE
# XXX CHANGES TO BSD.PORT.MK PORTS RELY UPON !
FULL_REVISION=1.406
#FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.405.2.2 2001/05/07 23:21:19 miod Exp $$
@


1.404
log
@Solve two simple problems:
- allow Makefile to distinguish packaging steps, since SUBPACKAGE can now
be set for various reasons.
- EXTRA_LIBDIRS for architectures without shared libraries.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.403 2001/04/19 22:15:05 espie Exp $$
d208 1
d1124 11
d1153 1
a1153 1
.if defined(NO_SHARED_LIBS)
d1160 1
a1160 1
.else
d1165 1
d1682 7
d1690 1
@


1.403
log
@typo. thanks Anil.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.402 2001/04/19 01:56:53 espie Exp $$
d517 1
a517 1
	@@cd ${.CURDIR} && SUBPACKAGE='' FLAVOR='${FLAVOR}' exec ${MAKE} _package
d530 1
a530 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' exec ${MAKE} _package
d1145 1
a1145 1
	if ${LD} -r -o $$tmp -L${LOCALBASE}/lib -L${X11BASE}/lib -l$$lib; then \
d2109 3
d2113 1
a2113 1
.  if ${PREFIX} == ${LOCALBASE}
d2115 1
a2115 1
.  else
d2117 1
a2117 1
.  endif
d2125 2
a2126 2
.if ${NEW_DEPENDS:L} == "yes"
.  if !empty(_ALWAYS_DEP2) || !empty(_BUILD_DEP2)
d2128 3
a2130 3
.  endif
.else
.  if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || target(depends-list)
d2132 2
a2133 2
.  endif
.endif
d2135 2
a2136 2
.if ${NEW_DEPENDS:L} == "yes"
.  if !empty(_ALWAYS_DEP2) || !empty(_RUN_DEP2)
d2138 3
a2140 3
.  endif
.else
.  if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP) || target(package-depends)
d2142 2
a2143 2
.  endif
.endif
d2153 2
a2154 2
.	if defined(PERMIT_PACKAGE_CDROM)
.     if ${PERMIT_PACKAGE_CDROM:L} == "yes"
d2156 1
a2156 1
.     else
d2158 2
a2159 2
.     endif
.	else
d2161 1
a2161 1
.	endif	
d2163 2
a2164 2
.	if defined(PERMIT_PACKAGE_FTP)
.     if ${PERMIT_PACKAGE_FTP:L} == "yes"
d2166 1
a2166 1
.     else
d2168 2
a2169 2
.     endif
.	else
d2171 1
a2171 1
.	endif	
d2174 2
a2175 2
.	if defined(PERMIT_DISTFILES_CDROM)
.	  if ${PERMIT_DISTFILES_CDROM:L} == "yes"
d2177 1
a2177 1
.     else
d2179 2
a2180 2
.     endif
.	else
d2182 1
a2182 1
.	endif	
d2185 2
a2186 2
.	if defined(PERMIT_DISTFILES_FTP)
.	  if ${PERMIT_DISTFILES_FTP:L} == "yes"
d2188 1
a2188 1
.     else
d2190 2
a2191 2
.     endif
.	else
d2193 2
a2194 1
.   endif
d2196 5
a2200 5
.if defined(MULTI_PACKAGES) && empty(SUBPACKAGE)
.  for _sub in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' exec ${MAKE} describe
.  endfor
.endif	
@


1.402
log
@MOTIFLIB, not MOTIF_LIB
Use FULLPKGPATH for describe
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.401 2001/04/18 15:00:53 brad Exp $$
d2352 1
a2352 1
			if ! eval $$toset ${MAKE} recurse-dir-depends ${_DEPEND_THRU}; then  \
@


1.401
log
@consistency nit, add missing braces.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.400 2001/04/18 14:43:55 espie Exp $$
d346 1
a346 1
MOTIF_LIB=-L${LOCALBASE}/lib -lXm
d2109 1
a2109 5
.  if !empty(FLAVOR)
	@@echo -n "${FULLPKGNAME}|${.CURDIR:S,^${PORTSDIR}/,,}${FLAVOR_EXT:S/-/,/g}|"
.  else
	@@echo -n "${FULLPKGNAME}|${.CURDIR:S,^${PORTSDIR}/,,}|"
.  endif
@


1.400
log
@Misc. small tweaks.
- let USE_MOTIF be sensible: any, openmotif, lesstif.
any triggers a lesstif flavor.
- show=name as a shortcut.
- package-dir-depends to check that packages are okay.

- error message for non-existent dirs.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.400 2001/04/17 21:40:36 espie Exp $$
d421 1
a421 1
	LOCALBASE='${LOCALBASE}' X11BASE=${X11BASE} \
@


1.399
log
@Add SUBPACKAGE to INSTALL_COOKIE so that stuff such as
SUBPACKAGE=-thingy make install
works sanely.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.398 2001/04/17 16:45:14 espie Exp $$
d99 1
a99 1
#                 absent X or Motif or ONLY_FOR_ARCHS...
d106 5
a110 12
# USE_MOTIF		- Set this in your port if it requires Motif or Lesstif.
#				  It will be built using Lesstif port unless Motif libraries
#				  found or HAVE_MOTIF is defined. See also REQUIRES_MOTIF.
#
# HAVE_MOTIF	- If set, means system has Motif.  Typically set in /etc/mk.conf.
# MOTIF_STATIC	- If set, link libXm statically; otherwise, link it
#				  dynamically.  Typically set in /etc/mk.conf.
# MOTIFLIB		- Set automatically to appropriate value depending on
#				  ${MOTIF_STATIC}.  Substitute references to -lXm with 
#				  patches to make your port conform to our standards.
# MOTIF_ONLY	- If set, build Motif ports only.  (Not much use except for
#				  building packages.)
a317 3
.if defined(USE_MOTIF) && !defined(HAVE_MOTIF) && !defined(REQUIRES_MOTIF)
LIB_DEPENDS+=		Xm.::x11/lesstif
.endif
d326 23
a712 8
# shared/dynamic motif libs
.if defined(USE_MOTIF) || defined(HAVE_MOTIF)
.  if defined(MOTIF_STATIC)
MOTIFLIB?=	${X11BASE}/lib/libXm.a
.  else
MOTIFLIB?=	-L${X11BASE}/lib -lXm
.  endif
.endif
d981 4
d986 1
a997 3
# Don't attempt to build ports that require Motif if you don't
# have Motif.
#
a1012 4
.  elif (defined(REQUIRES_MOTIF) && !defined(HAVE_MOTIF))
IGNORE=	"requires Motif"
.  elif (defined(MOTIF_ONLY) && !defined(REQUIRES_MOTIF))
IGNORE=	"does not require Motif"
d2346 1
a2346 1
recurse-dir-depends:
d2378 1
a2378 1
			if ! eval $$toset ${MAKE} recurse-dir-depends ${_DEPEND_THRU}; then  \
d2410 46
d2562 2
a2563 1
   dir-depends dir-depends-recursive build-depends-list run-depends-list
@


1.398
log
@- Fix FULLPKGPATH again. I missed it in naddy's buggy bug-fix.
- save subdir into package, that's what is useful, since the name is
already there.
- check that SUBPACKAGE is a member of MULTI_PACKAGES.
Make make SUBDIR=misc/fileutils,-ls  work without error.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.397 2001/04/16 21:40:04 naddy Exp $$
d361 1
a361 1
_INSTALL_COOKIE=	${WRKBUILD}/.install_done
d366 1
a366 1
_INSTALL_COOKIE=	${WRKDIR}/.install_done
@


1.397
log
@Handle multiple flavors in package paths.  ok espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.396 2001/04/14 16:49:53 espie Exp $$
d336 10
d533 1
a533 1
FULLPKGPATH=${PKGPATH},-${SUBPACKAGE}${FLAVOR_EXT:S/-/,/g}
d625 1
a625 1
	@@echo "@@comment name=${PKGPATH}/${FULLPKGNAME} cdrom=${PERMIT_PACKAGE_CDROM:L} ftp=${PERMIT_PACKAGE_FTP:L}" >$@@.tmp
@


1.396
log
@Add NO_SHARED_ARCHS, useful with NOT_FOR_ARCHS
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.395 2001/04/12 20:35:59 espie Exp $$
d521 1
a521 1
FULLPKGPATH=${PKGPATH}${FLAVOR_EXT:S/-/,/}
d523 1
a523 1
FULLPKGPATH=${PKGPATH},-${SUBPACKAGE}${FLAVOR_EXT:S/-/,/}
@


1.395
log
@Proper quoting in build depends too. Discovered by avsm@@.
Slightly more intricate, because we can't quote each value
indiscriminately, simplest way is to move the for loop from shell to make.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.394 2001/04/11 16:06:07 espie Exp $$
d224 1
d227 2
a228 2
.if (${MACHINE_ARCH} == "alpha") || (${MACHINE_ARCH} == "hppa") || \
    (${MACHINE_ARCH} == "vax")
d230 2
a231 1
.endif
@


1.394
log
@aesthetical tweaks.

Oh, and uninstall doesn't need to remove the package cookies, obviously.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.393 2001/04/11 15:55:34 espie Exp $$
d654 1
a654 1
.if ${NEW_DEPENDS} != "yes"
d1154 1
d1156 27
a1182 35
	for i in ${${_DEP:U}_DEPENDS}; do \
		echo $$i|{ \
			IFS=:; read dep pkg dir target; \
			case "X$$target" in X) target=${DEPENDS_TARGET};; esac; \
			${_flavor_fragment}; \
			case "X$$pkg" in X) pkg=`cd ${PORTSDIR} && cd $$dir && \
				eval $$toset ${MAKE} show VARNAME=FULLPKGNAME`;; esac; \
			for abort in false false true; do \
				if $$abort; then \
					${ECHO_MSG} "Dependency check failed"; \
					exit 1; \
				fi; \
				cd ${PORTSDIR}; \
				if [ ! -d $$dir ]; then \
					echo ">> No directory for $$dep ($$dir)"; \
				fi; \
				if [ -L $$dir ]; then \
					echo ">> Broken dependency: $$dir is a symbolic link"; \
					exit 1; \
				fi; \
				found=false; \
				case "$$dep" in \
				"/nonexistent") earlyexit=true;; \
				*) earlyexit=false; \
					${_${_DEP}_depends_fragment}; \
					if $$found; then \
						${ECHO_MSG} "===>  ${FULLPKGNAME} depends on: $$dep - found"; \
						break; \
					else \
						${ECHO_MSG} "===>  ${FULLPKGNAME} depends on: $$dep - not found"; \
					fi;; \
				esac; \
				${ECHO_MSG} "===>  Verifying $$target for $$dep in $$dir"; \
				if cd $$dir && eval $$toset ${MAKE} ${_DEPEND_THRU} $$target; then \
					${ECHO_MSG} "===> Returning to build of ${FULLPKGNAME}"; \
d1184 15
a1198 8
					exit 1; \
				fi; \
				if $$earlyexit; then \
					break; \
				fi; \
			done; \
		}; \
	done
@


1.393
log
@define NEW_DEPENDS as yes. More consistent with the rest of the file.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.392 2001/04/09 23:16:50 espie Exp $$
d174 2
d177 4
d184 1
a184 1
# obj			- pre-build ${WRKDIR} -> ${WRKOBJDIR}/${PKGPATH} links
d186 3
d203 5
a207 2
# NEVER override the "regular" targets unless you want to open
# a major can of worms.
d1874 1
a1874 1
	@@rm -f ${_INSTALL_COOKIE} ${_PACKAGE_COOKIES}
a2084 5

################################################################
# Everything after here are internal targets and really
# shouldn't be touched by anybody but the release engineers.
################################################################
@


1.392
log
@protect dependencies from shell expansion.
Noticed by avsm@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.391 2001/04/08 16:56:22 espie Exp $$
d202 1
a202 1
NEW_DEPENDS=Yes
d602 1
a602 1
.if defined(NEW_DEPENDS)
d642 1
a642 1
.if !defined(NEW_DEPENDS)
d2104 1
a2104 1
.if defined(NEW_DEPENDS)
d2114 1
a2114 1
.if defined(NEW_DEPENDS)
@


1.391
log
@Turn NEW_DEPENDS on
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.390 2001/04/08 16:55:17 espie Exp $$
d2377 1
a2377 1
	for spec in `echo ${_ALWAYS_DEP2} ${_${_i}_DEP2} \
d2392 1
a2392 1
	for spec in `echo ${_ALWAYS_DEP2} ${_RUN_DEP2} \
@


1.390
log
@FULLPKGPATH is PKGPATH plus flavor/multipackage modifiers.
Use it where we can, including WRKOBJDIR `real' names.

NOTE: if you are using WRKOBJDIR, *all* flavored builds directories
will change  names, from work-no_x11 to work,no_x11
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.389 2001/04/08 16:50:13 espie Exp $$
d202 1
@


1.389
log
@...without breaking things
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.388 2001/04/08 16:49:26 espie Exp $$
d504 7
d1358 2
a1359 2
	@@rm -rf ${WRKOBJDIR}/${PKGPATH}${FLAVOR_EXT}
	@@mkdir -p ${WRKOBJDIR}/${PKGPATH}${FLAVOR_EXT}
d1361 2
a1362 2
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${PKGPATH}${FLAVOR_EXT} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${PKGPATH}${FLAVOR_EXT}"; \
d1364 1
a1364 1
		ln -sf ${WRKOBJDIR}/${PKGPATH}${FLAVOR_EXT} ${WRKDIR}; \
d1783 2
a1784 2
	@@rm -rf ${WRKOBJDIR}/${PKGPATH}${FLAVOR_EXT}
	@@mkdir -p ${WRKOBJDIR}/${PKGPATH}${FLAVOR_EXT}
d1786 2
a1787 2
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${PKGPATH}${FLAVOR_EXT} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${PKGPATH}${FLAVOR_EXT}"; \
d1789 1
a1789 1
		ln -sf ${WRKOBJDIR}/${PKGPATH}${FLAVOR_EXT} ${WRKDIR}; \
a2343 6
.if empty(SUBPACKAGE)
_PKGPATH=${PKGPATH}${FLAVOR_EXT:S/-/,/}
.else
_PKGPATH=${PKGPATH},-${SUBPACKAGE}${FLAVOR_EXT:S/-/,/}
.endif

d2350 1
a2350 1
		echo "${_PKGPATH} $$dir"; \
d2365 1
a2365 1
	@@echo "${_PKGPATH} ${_PKGPATH}"
a2423 4

.if make(README.html) || make(readme) || make(readmes)
PKGDEPTH!=echo ${PKGPATH}|sed -e 's|[^./][^/]*|..|g'
.endif
@


1.388
log
@Store PERMIT_PACKAGE_* in PLIST.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.387 2001/04/04 09:55:34 espie Exp $$
d593 1
a593 1
+	@@echo "@@comment name=${PKGPATH}/${FULLPKGNAME} cdrom=${PERMIT_PACKAGE_CDROM:L} ftp=${PERMIT_PACKAGE_FTP:L}" >$@@.tmp
@


1.387
log
@reset IFS so that dir-depends will work correctly.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.386 2001/04/04 08:17:31 espie Exp $$
d593 1
a593 1
	@@echo "@@comment name="`cd ${.CURDIR} && exec make package-name FULL_PACKAGE_NAME=Yes` >$@@.tmp
d595 1
a595 1
	@@self=${FULLPKGNAME} exec ${MAKE} new-depends|sort -u >$@@.tmp
@


1.386
log
@New Features for NEW_DEPENDS:
dir-depends: list of SUBDIRS this port depends on (with flavors, subpackages),
to use with tsort.
build-depends-list, run-depends-list: list of pkgspec:dir needed for this
port, no recursion. To use for INDEX.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.385 2001/04/04 08:03:59 espie Exp $$
d1076 1
a1076 1
			done;; \
@


1.385
log
@I missed one package cookie
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.384 2001/04/02 21:08:49 espie Exp $$
d2096 6
a2101 1
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || target(depends-list)
d2103 1
d2106 6
a2111 1
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP) || target(package-depends)
d2113 1
d2315 71
d2495 2
a2496 1
   link-categories unlink-categories _package
@


1.384
log
@derive _ALWAYS_DEP from _ALWAYS_DEP2 (and friends) so that pkgspec don't
interfere.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.383 2001/04/02 11:50:25 espie Exp $$
d1311 1
a1311 1
	@@rm -f ${_INSTALL_COOKIE} ${_PACKAGE_COOKIE} ${_SUBPACKAGE_COOKIES}
@


1.383
log
@Compute `new dependencies' if NEW_DEPENDS is defined.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.382 2001/04/02 11:45:11 espie Exp $$
d2024 1
a2024 1

d2026 3
a2028 2
_ALWAYS_DEP = ${LIB_DEPENDS:S,::,:,:C/^[^:]*://:C/:.*//} \
	${MISC_DEPENDS:S,::,:,:C/^[^:]*://:C/:.*//}
d2030 2
a2031 1
_ALWAYS_DEP =
d2034 3
a2036 3
.if defined(FETCH_DEPENDS) || defined(BUILD_DEPENDS)
_BUILD_DEP = ${FETCH_DEPENDS:S,::,:,:C/^[^:]*://:C/:.*//} \
	${BUILD_DEPENDS:S,::,:,:C/^[^:]*://:C/:.*//}
d2038 2
a2039 1
_BUILD_DEP =
d2042 4
a2045 2
.if defined(RUN_DEPENDS)
_RUN_DEP = ${RUN_DEPENDS:S,::,:,:C/^[^:]*://:C/:.*//}
d2047 2
a2048 1
_RUN_DEP =
a2300 14
.endif

# Only keep pkg:dir spec
.if defined(LIB_DEPENDS) || defined(MISC_DEPENDS)
_ALWAYS_DEP2 = ${LIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/} \
	${MISC_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
.else
_ALWAYS_DEP2=
.endif

.if defined(RUN_DEPENDS)
_RUN_DEP2 = ${RUN_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
.else
_RUN_DEP2=
@


1.382
log
@Some comments
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.381 2001/04/02 11:32:32 espie Exp $$
d593 5
a597 1
.  if defined(NO_SHARED_LIBS)
d600 2
a601 2
		${SED_PLIST} >$@@.tmp && mv -f $@@.tmp $@@
.  else
d606 1
a606 1
			| sed -f ${LDCONFIG_SED_SCRIPT} >$@@.tmp && mv -f $@@.tmp $@@; \
d611 1
a611 1
			${SED_PLIST} >$@@.tmp && mv -f $@@.tmp $@@; \
d613 1
a613 2
.  endif
	@@echo "@@comment name="`cd ${.CURDIR} && exec make package-name FULL_PACKAGE_NAME=Yes` >>$@@
d634 1
d636 1
d2297 37
@


1.381
log
@Remove stuff that is often duplicate, and causes only bogus warnings.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.380 2001/04/02 10:35:51 espie Exp $$
d1052 3
d1081 1
d1123 2
@


1.380
log
@revise the way package multi-builds are handled.
- move FLAVOR_EXT up so that WRK* are correct when they're needed for
dependencies.
- build a list of _PACKAGE_COOKIES, one for each subpackage.
- let package go through an indirection:
package: ${_PACKAGE_COOKIES}

_PACKAGE_COOKIE_${SUB}:
	SUBPACKAGE=${SUB} ${MAKE} _package

so that all packages are `flat', and subpackages can depend on each other
freely.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.379 2001/04/02 10:16:59 espie Exp $$
d1648 1
a1648 1
	@@duplicates=`sort <${WRKPKG}/PLIST${SUBPACKAGE}|uniq -d`; \
@


1.379
log
@Add FLAVOR_EXT to the list of substituted variables (deprecate ${FLAVOR}
in packing lists).
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.378 2001/03/29 19:01:05 espie Exp $$
d338 1
a338 1
_PACKAGE_COOKIE=	${WRKBUILD}/.package_done${SUBPACKAGE}
d343 1
a343 1
_PACKAGE_COOKIE=	${WRKDIR}/.package_done${SUBPACKAGE}
d347 2
a348 2
${_INSTALL_PRE_COOKIE} ${_BUILD_COOKIE} ${_PACKAGE_COOKIE} \
${_DISTPATCH_COOKIE} ${_PREPATCH_COOKIE} ${_FAKE_COOKIE} ${_SUBPACKAGE_COOKIES}
d443 55
a539 29
# Support architecture and flavor dependent packing lists
#
SED_PLIST?=


# Build FLAVOR_EXT, checking that no flavors are misspelled
FLAVOR_EXT:=
.if defined(FLAVORS)
.  if defined(FLAVOR)
.    for _i in ${FLAVOR:L}
.      if empty(FLAVORS:L:M${_i})
.BEGIN:
	@@echo >&2 "Unknown flavor: ${_i}"
	@@echo >&2 "Possible flavors are: ${FLAVORS}"
	@@exit 1
.      endif
.    endfor
.  endif
# Create the basic sed substitution pipeline for fragments
# (applies only to PLIST for now)
.  for _i in ${FLAVORS:L}
.    if empty(FLAVOR:L:M${_i})
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/r${PKGDIR}/PFRAG.no-${_i}' -e '//d' -e '/^%%${_i}%%$$/d'
.    else
FLAVOR_EXT:=${FLAVOR_EXT}-${_i}
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/d' -e '/^%%${_i}%%$$/r${PKGDIR}/PFRAG.${_i}' -e '//d'
.    endif
.  endfor
.endif
d1313 1
a1313 1
install: ${_INSTALL_COOKIE} ${_PACKAGE_COOKIE}
d1318 1
a1318 1
package: ${_PACKAGE_COOKIE}
d1611 3
a1613 1
${_INSTALL_COOKIE}:  ${_PACKAGE_COOKIE}
d1627 1
a1627 11
_SUBPACKAGE_COOKIES=
.if defined(MULTI_PACKAGES) && empty(SUBPACKAGE)
.  for _sub in ${MULTI_PACKAGES}

_SUBPACKAGE_COOKIES+= ${_PACKAGE_COOKIE}${_sub}
.    if ${FAKE:L} == "yes"
${_PACKAGE_COOKIE}${_sub}: ${_FAKE_COOKIE}
.    else
${_PACKAGE_COOKIE}${_sub}: ${_INSTALL_COOKIE}
.    endif
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' exec ${MAKE} package
d1629 1
a1629 9
.  endfor
.endif


.if ${FAKE:L} == "yes"
${_PACKAGE_COOKIE}: ${_FAKE_COOKIE} ${_SUBPACKAGE_COOKIES} ${_PKG_PREREQ}
.else
${_PACKAGE_COOKIE}: ${_INSTALL_COOKIE} ${_SUBPACKAGE_COOKIES} ${_PKG_PREREQ}
.endif
a1669 3
.if !defined(PACKAGE_NOINSTALL)
	@@${_MAKE_COOKIE} $@@
.endif
d1824 1
a1824 1
	@@${SUDO} rm -f ${_INSTALL_PRE_COOKIE} ${_INSTALL_COOKIE} ${_PACKAGE_COOKIE}
d1843 1
a1843 1
	@@rm -f ${_INSTALL_COOKIE} ${_PACKAGE_COOKIE}
d2000 1
a2000 1
	@@rm -f ${_PACKAGE_COOKIE}
d2008 2
a2009 2
	@@rm -f ${_PACKAGE_COOKIE}
	@@cd ${.CURDIR} && exec ${MAKE} PACKAGE_NOINSTALL=Yes ${_PACKAGE_COOKIE}
d2372 1
a2372 1
   link-categories unlink-categories
@


1.378
log
@Repair IGNORE. I forgot to move this around when the rest needed
rearranging. Found by naddy@@.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.377 2001/03/28 15:07:05 espie Exp $$
d516 1
a516 1
SUBST_VARS+=ARCH HOMEPAGE PREFIX SYSCONFDIR
@


1.377
log
@typo
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.376 2001/03/28 15:04:34 espie Exp $$
a980 131
.if defined(IGNORE) && !defined(NO_IGNORE)
fetch checksum extract patch configure all build install \
uninstall deinstall package:
.  if !defined(IGNORE_SILENT)
	@@${ECHO_MSG} "===>  ${FULLPKGNAME} ${IGNORE}."
.  endif

.else 


# Most standard port targets create a cookie to avoid being re-run.
#
# fetch is an exception, as it uses the files it fetches as `cookies',
# and it's run by checksum, so in essence it's a sub-goal of extract,
# in normal use.
# 
# Besides, fetch can't create cookies, as it does not have WRKDIR available
# in the first place.
#
# IMPORTANT: pre-fetch/do-fetch/post-fetch MUST be designed so that they
# can be run several times in a row.

fetch: fetch-depends
# You need to define PERMIT_* to make the warning go away.
# See ports/infrastructure/templates/Makefile.template
	@@${ECHO_MSG} "===>  Checking files for ${FULLPKGNAME}"
.  if !defined(PERMIT_PACKAGE_CDROM) || !defined(PERMIT_PACKAGE_FTP) || \
    !defined(PERMIT_DISTFILES_CDROM) || !defined(PERMIT_DISTFILES_FTP)
	@@echo >&2 "*** The licensing info for this port is incomplete."
	@@echo >&2 "*** Please notify the OpenBSD port maintainer: ${MAINTAINER}"
.  endif
.  if target(pre-fetch)
	@@cd ${.CURDIR} && exec ${MAKE} pre-fetch
.  endif
.  if target(do-fetch)
	@@cd ${.CURDIR} && exec ${MAKE} do-fetch
.  else
# What FETCH normally does:
.    if !empty(ALLFILES)
	@@cd ${.CURDIR} && exec ${MAKE} ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
.    endif
# End of FETCH
.  endif
.  if target(post-fetch)
	@@cd ${.CURDIR} && exec ${MAKE} post-fetch
.  endif


# Set to true to try to retrieve older distfiles from ftp.openbsd.org if
# checksums no longer match.

REFETCH?=false

checksum: fetch
.  if ! defined(NO_CHECKSUM)
	@@if [ ! -f ${CHECKSUM_FILE} ]; then \
	  ${ECHO_MSG} ">> No checksum file."; \
	else \
	  cd ${DISTDIR}; OK=true; list=''; \
		for file in ${_CKSUMFILES}; do \
		  for cipher in ${PREFERRED_CIPHERS}; do \
			set -- `grep -i "^$$cipher ($$file)" ${CHECKSUM_FILE}` && break || \
			  ${ECHO_MSG} ">> No $$cipher checksum recorded for $$file."; \
		  done; \
		  case "$$4" in \
			"") \
			  ${ECHO_MSG} ">> No checksum recorded for $$file."; \
			  OK=false;; \
			"IGNORE") \
			  echo ">> Checksum for $$file is set to IGNORE in md5 file even though"; \
			  echo "   the file is not in the "'$$'"{IGNOREFILES} list."; \
			  OK=false;; \
			*) \
			  CKSUM=`$$cipher < $$file`; \
			  case "$$CKSUM" in \
			  	"$$4") \
				  ${ECHO_MSG} ">> Checksum OK for $$file. ($$cipher)";; \
				*) \
				  echo ">> Checksum mismatch for $$file. ($$cipher)"; \
				  list="$$list $$file $$cipher $$4"; \
				  OK=false;; \
			  esac;; \
		  esac; \
		done; \
		set --; \
		for file in ${_IGNOREFILES}; do \
		  set -- `grep "($$file)" ${CHECKSUM_FILE}` || \
			  { echo ">> No checksum recorded for $$file, file is in "'$$'"{IGNOREFILES} list." && \
			  OK=false; } ; \
		  case "$$4" in \
		  	"IGNORE") : ;; \
			*) \
			  echo ">> Checksum for $$file is not set to IGNORE in md5 file even though"; \
			  echo "   the file is in the "'$$'"{IGNOREFILES} list."; \
			  OK=false;; \
		  esac; \
		done; \
		if ! $$OK; then \
		  if ${REFETCH}; then \
		  	cd ${.CURDIR} && ${MAKE} refetch PROBLEMS="$$list"; \
		  else \
			echo "Make sure the Makefile and checksum file (${CHECKSUM_FILE})"; \
			echo "are up to date.  If you want to override this check, type"; \
			echo "\"make NO_CHECKSUM=Yes [other args]\"."; \
			exit 1; \
		  fi; \
		fi ; \
  fi
.  endif

refetch:
	@@set -- ${PROBLEMS}; \
	 while [ $$# -gt 0 ]; do \
		file=$$1; \
		cipher=$$2; \
		value=$$3; \
		shift; shift; shift; \
		rm ${FULLDISTDIR}/$$file; \
		cd ${.CURDIR} && ${MAKE} ${FULLDISTDIR}/$$file \
			MASTER_SITE_OVERRIDE="ftp://ftp.openbsd.org/pub/OpenBSD/distfiles/$$cipher/$$value/"; \
	done;
	cd ${.CURDIR} && exec ${MAKE} checksum REFETCH=false



uninstall deinstall:
	@@${ECHO_MSG} "===> Deinstalling for ${FULLPKGNAME}"
	@@${SUDO} ${PKG_DELETE} -f ${FULLPKGNAME}
	@@rm -f ${_INSTALL_COOKIE} ${_PACKAGE_COOKIE} ${_SUBPACKAGE_COOKIES}

.endif # IGNORECMD
d1146 130
d1293 2
@


1.376
log
@Distinguish between no flavor seen (default flavor) and empty flavor seen
(empty flavor).
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.375 2001/03/28 15:01:01 espie Exp $$
d1180 1
a1180 1
			toset="$$toset FLAVOR=\"$$flavor\"";; \
@


1.375
log
@Due to the way make is working, flavors passed as `make FLAVOR=a'
don't work, as they propagate down subdirs.

Use `FLAVOR=a make' (sh) or `env FLAVOR=a make' (csh) instead.

Error out with a useful error message if old usage is encountered.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.374 2001/03/28 14:50:17 espie Exp $$
d1158 1
a1158 1
		multi=''; flavor=''; \
d1169 1
d1179 1
a1179 1
		case X"$$flavor" in "X");; *) \
d1181 1
a1181 1
		esac
@


1.374
log
@Missed one in back-porting my diff
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.373 2001/03/28 14:33:24 espie Exp $$
d40 6
@


1.373
log
@dir -> dir[,-multi][,-flavor...] notation for dependencies. Finally !
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.372 2001/03/28 12:15:26 espie Exp $$
d599 1
a599 1
PKG_ARGS+=-P "`cd ${.CURDIR} && ${MAKE} SUBPACKAGE='${SUBPACKAGE}' package-depends|${_SORT_DEPENDS}`"
@


1.372
log
@Slight optimisation:
always define _ALWAYS_DEP, _BUILD_DEP, _RUN_DEP and test for emptiness
instead of definedness, so that the code is still optimized away when
dependency lists are defined, but empty.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.371 2001/03/28 11:52:20 espie Exp $$
d313 1
a482 1
FLAVOR?=
d747 1
a747 1
.if ${SUBPACKAGE} != '' 
d1151 25
d1221 1
a1221 1
	@@unset DEPENDS_TARGET || true; \
d1226 1
d1228 1
a1228 1
				${MAKE} ${_DEPEND_THRU} show VARNAME=FULLPKGNAME`;; esac; \
d1255 1
a1255 1
				if cd $$dir && PKGPATH="$$dir" ${MAKE} ${_DEPEND_THRU} $$target; then \
d1601 1
a1601 1
	@@cd ${.CURDIR} && exec ${MAKE} package SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1683 1
a1683 1
	@@cd ${.CURDIR} && exec ${MAKE} ${.TARGET} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1695 1
a1695 1
	@@cd ${.CURDIR} && exec ${MAKE} ${.TARGET} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1707 1
a1707 1
	@@cd ${.CURDIR} && exec ${MAKE} ${.TARGET} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1969 1
a1969 1
_DEPEND_THRU=FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME} FLAVOR='' SUBPACKAGE=''
d2022 2
a2023 1
	@@for dir in \
d2026 1
d2028 1
a2028 1
			PKGPATH="$$dir" ${MAKE} CLEANDEPENDS=No ${_DEPEND_THRU} clean clean-depends; \
d2124 1
a2124 1
	@@cd ${.CURDIR} && exec ${MAKE} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' describe
d2167 2
a2168 1
	@@echo -n `cd ${.CURDIR} && ${MAKE} ${_DEPEND_THRU} depends-list | ${_SORT_DEPENDS}`
d2177 2
a2178 1
	@@echo -n `cd ${.CURDIR} && ${MAKE} ${_DEPEND_THRU} package-depends | ${_SORT_DEPENDS}`
d2188 1
d2191 1
d2193 1
a2193 1
			if ! PKGPATH="$$dir" ${MAKE} _DEPEND_ECHO="echo $$pname" package-name recurse-build-depends ${_DEPEND_THRU}; then  \
d2210 2
a2211 1
	@@for dir in `echo ${_ALWAYS_DEP} ${_BUILD_DEP} \
d2213 1
d2215 1
a2215 1
			if ! PKGPATH="$$dir" ${MAKE} recurse-build-depends ${_DEPEND_THRU}; then  \
d2232 1
d2235 1
d2237 1
a2237 1
			if ! PKGPATH="$$dir" ${MAKE} _DEPEND_ECHO="echo $$pname" package-name recurse-package-depends ${_DEPEND_THRU}; then  \
d2254 2
a2255 1
	@@for dir in `echo ${_ALWAYS_DEP} ${_RUN_DEP} \
d2257 1
d2259 1
a2259 1
			if ! PKGPATH="$$dir" ${MAKE} recurse-package-depends ${_DEPEND_THRU}; then  \
@


1.371
log
@Use error=true/false instead of error=0/1 (consistency)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.370 2001/03/28 11:48:12 espie Exp $$
d1976 2
d1983 2
d1989 2
d1995 1
a1995 1
.  if defined(_ALWAYS_DEP) || defined(_BUILD_DEP) || defined(_RUN_DEP)
d2036 1
a2036 1
.if defined(_ALWAYS_DEP) || defined(_BUILD_DEP) || target(depends-list)
d2040 1
a2040 1
.if defined(_ALWAYS_DEP) || defined(_RUN_DEP) || target(package-depends)
d2103 1
a2103 1
.if defined(_ALWAYS_DEP) || defined(_BUILD_DEP) || target(depends-list)
d2106 1
a2106 1
.if defined(_ALWAYS_DEP) || defined(_RUN_DEP) || target(package-depends)
d2137 1
a2137 1
.  if defined(_ALWAYS_DEP) || defined(_BUILD_DEP) || target(depends-list)
d2146 1
a2146 1
.  if defined(_ALWAYS_DEP) || defined(_RUN_DEP) || target(package-depends)
d2156 1
a2156 1
.  if defined(_ALWAYS_DEP) || defined(_BUILD_DEP) || defined(_RUN_DEP)
d2177 1
a2177 1
.  if defined(_ALWAYS_DEP) || defined(_BUILD_DEP)
d2196 1
a2196 1
.  if defined(_ALWAYS_DEP) || defined(_RUN_DEP)
d2217 1
a2217 1
.  if defined(_ALWAYS_DEP) || defined(_RUN_DEP)
@


1.370
log
@Move dependency checking above targets, so that it can be changed to
generate cookies for each dependency.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.369 2001/03/28 11:43:16 espie Exp $$
d1372 1
a1372 1
		error=0; \
d1386 1
a1386 1
							error=1; }\
d1392 1
a1392 1
								error=1; \
d1398 1
a1398 1
		case $$error in 1) exit 1;; esac; \
@


1.369
log
@Trim documented parts. Give default values to NO_DEPENDS, NO_BUILD
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.368 2001/03/28 11:32:29 espie Exp $$
a1099 19
# Normal user-mode targets are PHONY targets, e.g., don't create the
# corresponding file. However, there is nothing phony about the cookie.

# The cookie's recipe hold the real rule for each of those targets.

extract: ${_EXTRACT_COOKIE}
patch: ${_PATCH_COOKIE}
distpatch: ${_DISTPATCH_COOKIE}
configure: ${_CONFIGURE_COOKIE}
all build: ${_BUILD_COOKIE}
.if defined(ALWAYS_PACKAGE)
install: ${_INSTALL_COOKIE} ${_PACKAGE_COOKIE}
.else
install: ${_INSTALL_COOKIE}
.endif
fake: ${_FAKE_COOKIE}
package: ${_PACKAGE_COOKIE}


d1148 113
a1969 94

################################################################
# Dependency checking
################################################################
_fetch_depends_fragment= \
	case $$dep in \
	/*) \
		if [ -e "$$dep" ]; then \
			found=true; \
		fi;; \
	*) \
		p=${PORTPATH}; IFS=:; for d in $$p; do \
			if [ -x $$d/$$dep ]; then \
				found=true; \
				break; \
			fi \
		done; unset IFS;; \
	esac

_build_depends_fragment = ${_fetch_depends_fragment}
_run_depends_fragment = ${_fetch_depends_fragment}; earlyexit=true

.if defined(NO_SHARED_LIBS)
_lib_depends_fragment = \
	lib=`echo $$dep | sed -e 's|\([^\\]\)[\\\.].*|\1|'`; \
	tmp=`mktemp /tmp/bpmXXXXXXXXXX`; \
	if ${LD} -r -o $$tmp -L${LOCALBASE}/lib -L${X11BASE}/lib -l$$lib; then \
		found=true; \
	fi
.else
_lib_depends_fragment = \
	lib=`echo $$dep | sed -e 's|\([^\\]\)\.|\1\\\\.|g'`; \
	check=`${LDCONFIG} -r | awk "/-l$$lib/"'{ print $$3 }'`; \
	case "X$$check" in "X") ;; *) found=true;; esac 
.endif

_misc_depends_fragment = :

depends: lib-depends misc-depends fetch-depends build-depends run-depends

# Let DEPENDS behave like the others
.if defined(DEPENDS)
MISC_DEPENDS=${DEPENDS:S/^/nonexistent::/}
.endif

.for _DEP in fetch build run lib misc
${_DEP}-depends:
.  if defined(${_DEP:U}_DEPENDS) && ${NO_DEPENDS:L} == "no"
	@@unset DEPENDS_TARGET || true; \
	for i in ${${_DEP:U}_DEPENDS}; do \
		echo $$i|{ \
			IFS=:; read dep pkg dir target; \
			case "X$$target" in X) target=${DEPENDS_TARGET};; esac; \
			case "X$$pkg" in X) pkg=`cd ${PORTSDIR} && cd $$dir && \
				${MAKE} ${_DEPEND_THRU} show VARNAME=FULLPKGNAME`;; esac; \
			for abort in false false true; do \
				if $$abort; then \
					${ECHO_MSG} "Dependency check failed"; \
					exit 1; \
				fi; \
				cd ${PORTSDIR}; \
				if [ ! -d $$dir ]; then \
					echo ">> No directory for $$dep ($$dir)"; \
				fi; \
				if [ -L $$dir ]; then \
					echo ">> Broken dependency: $$dir is a symbolic link"; \
					exit 1; \
				fi; \
				found=false; \
				case "$$dep" in \
				"/nonexistent") earlyexit=true;; \
				*) earlyexit=false; \
					${_${_DEP}_depends_fragment}; \
					if $$found; then \
						${ECHO_MSG} "===>  ${FULLPKGNAME} depends on: $$dep - found"; \
						break; \
					else \
						${ECHO_MSG} "===>  ${FULLPKGNAME} depends on: $$dep - not found"; \
					fi;; \
				esac; \
				${ECHO_MSG} "===>  Verifying $$target for $$dep in $$dir"; \
				if cd $$dir && PKGPATH="$$dir" ${MAKE} ${_DEPEND_THRU} $$target; then \
					${ECHO_MSG} "===> Returning to build of ${FULLPKGNAME}"; \
				else \
					exit 1; \
				fi; \
				if $$earlyexit; then \
					break; \
				fi; \
			done; \
		}; \
	done
.  endif
.endfor
@


1.368
log
@More regularity, use $@@ to regenerate target cookies
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.367 2001/03/28 11:28:31 espie Exp $$
d70 1
a70 1
#				  displayed instead the port being generated.
a71 1
# NO_BUILD		- Use a dummy (do-nothing) build target.
a75 1
# NO_DEPENDS	- Don't verify build of dependencies.
a80 6
# YACC          - yacc program to pass to configure script (default: yacc)
#                 override with bison if port requires bison.
# CONFIGURE_ARGS - Pass these args to configure if CONFIGURE_STYLE is
# 				  simple, gnu or perl.
# CONFIGURE_ENV - Pass these env (shell-like) to configure if
#				  CONFIGURE_STYLE is simple, gnu or perl.
d84 1
a84 2
#				  made first.  Use this for things that don't fall into
#				  the above two categories.
d225 3
d1380 1
a1380 1
.if !defined(NO_BUILD) 
d1923 1
a1923 1
.  if defined(${_DEP:U}_DEPENDS) && !defined(NO_DEPENDS)
@


1.367
log
@... and to the list of targets too, oops.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.366 2001/03/28 11:27:18 espie Exp $$
d1215 1
a1215 1
	@@${_MAKE_COOKIE} ${_EXTRACT_COOKIE}
d1225 1
a1225 1
	@@${_MAKE_COOKIE} ${_PREPATCH_COOKIE}
d1265 1
a1265 1
	@@${_MAKE_COOKIE} ${_DISTPATCH_COOKIE}
d1321 1
a1321 1
	@@${_MAKE_COOKIE} ${_PATCH_COOKIE}
d1380 1
a1380 1
	@@${_MAKE_COOKIE} ${_CONFIGURE_COOKIE}
d1402 1
a1402 1
	@@${_MAKE_COOKIE} ${_BUILD_COOKIE}
d1461 1
a1461 1
	@@${SUDO} ${_MAKE_COOKIE} ${_FAKE_COOKIE}
d1474 1
a1474 1
	@@${SUDO} ${_MAKE_COOKIE} ${_INSTALL_COOKIE}
d1539 1
a1539 1
	@@${_MAKE_COOKIE} ${_PACKAGE_COOKIE}
@


1.366
log
@Add rebuild target
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.365 2001/03/28 10:25:38 espie Exp $$
d2315 1
a2315 1
   readmes reinstall \
@


1.365
log
@Add NOT_FOR_ARCHS
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.364 2001/03/25 20:35:35 espie Exp $$
d1698 7
@


1.364
log
@Repair setting of PKGNAME/FULLPKGNAME dependning on Flavor.
These should override a default setting of PKGNAME, since in that case,
PKGNAME only holds the name for the main package.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.363 2001/03/22 00:22:36 espie Exp $$
d966 6
d2037 7
a2043 5
	@@if [ "${ONLY_FOR_ARCHS}" = "" ]; then \
		echo -n "any|"; \
	else \
		echo -n "${ONLY_FOR_ARCHS}|"; \
	fi
@


1.363
log
@_FEXT -> FLAVOR_EXT, make this visible
FULLPKGNAME as a knob for ex ${PKGNAME}-${_FEXT}, so that python
and others can tweak it directly, without needing post bsd.port.mk
tweaks.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.362 2001/03/17 11:16:38 espie Exp $$
d755 1
a755 1
FULLPKGNAME?=	${FULLPKGNAME${SUBPACKAGE}}
d757 1
a757 1
PKGNAME?=		${PKGNAME${SUBPACKAGE}}
@


1.362
log
@Consistency (Peter Fritchman)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.361 2001/03/16 14:56:41 espie Exp $$
d205 1
a205 1
WRKINST?=${WRKDIR}/fake-${ARCH}${_FEXT}
d421 1
a421 1
WRKDIR?=		${.CURDIR}/work${_FEXT}.${MACHINE_ARCH}
d426 1
a426 1
WRKDIR?=		${.CURDIR}/work${_FEXT}
d435 1
a435 1
WRKBUILD?=		${WRKDIR}/build-${ARCH}${_FEXT}
d490 2
a491 2
# Build _FEXT, checking that no flavors are misspelled
_FEXT:=
d509 1
a509 1
_FEXT:=${_FEXT}-${_i}
d521 1
a521 1
_SED_SUBST+=-e 's,$${FLAVORS},${_FEXT},g' -e 's,$$\\,$$,g'
d526 2
a527 2
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}${_FEXT}.${ARCH})
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}${_FEXT}.${ARCH}
d529 2
a530 2
.if !defined(PLIST) && defined(NO_SHARED_LIBS) && exists(${PKGDIR}/PLIST${SUBPACKAGE}${_FEXT}.noshared)
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}${_FEXT}.noshared
d532 2
a533 2
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}${_FEXT})
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}${_FEXT}
d544 2
a545 2
.if defined(COMMENT${SUBPACKAGE}${_FEXT})
_COMMENT=echo ${COMMENT${SUBPACKAGE}${_FEXT}:S/^-//}
d549 2
a550 2
.  if exists(${PKGDIR}/COMMENT${SUBPACKAGE}${_FEXT})
_COMMENT=cat ${PKGDIR}/COMMENT${SUBPACKAGE}${_FEXT}
d753 4
a756 1
.if ${SUBPACKAGE} != '' && defined(PKGNAME${SUBPACKAGE})
d758 1
d761 1
a761 2

PKGNAME:=		${PKGNAME}${_FEXT}
d845 1
a845 1
PKGFILE?=		${PKGREPOSITORY}/${PKGNAME}${PKG_SUFX}
d969 1
a969 1
IGNORE= "-- ${PKGNAME:C/-[0-9].*//g} comes with ${OPSYS} as of release ${COMES_WITH}"
d979 1
a979 1
	@@${ECHO_MSG} "===>  ${PKGNAME} ${IGNORE}."
d1000 1
a1000 1
	@@${ECHO_MSG} "===>  Checking files for ${PKGNAME}"
d1120 2
a1121 2
	@@${ECHO_MSG} "===> Deinstalling for ${PKGNAME}"
	@@${SUDO} ${PKG_DELETE} -f ${PKGNAME}
d1177 1
a1177 1
	@@${ECHO_MSG} "===>  Extracting for ${PKGNAME}"
d1186 2
a1187 2
	@@rm -rf ${WRKOBJDIR}/${PKGPATH}${_FEXT}
	@@mkdir -p ${WRKOBJDIR}/${PKGPATH}${_FEXT}
d1189 2
a1190 2
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${PKGPATH}${_FEXT} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${PKGPATH}${_FEXT}"; \
d1192 1
a1192 1
		ln -sf ${WRKOBJDIR}/${PKGPATH}${_FEXT} ${WRKDIR}; \
d1236 1
a1236 1
	@@${ECHO_MSG} "===>  Applying distribution patches for ${PKGNAME}"
d1265 1
a1265 1
	@@${ECHO_MSG} "===>  Patching for ${PKGNAME}"
d1322 1
a1322 1
	@@${ECHO_MSG} "===>  Configuring for ${PKGNAME}"
d1381 1
a1381 1
	@@${ECHO_MSG} "===>  Building for ${PKGNAME}"
d1402 1
a1402 1
	@@${ECHO_MSG} "===>  Faking installation for ${PKGNAME}"
d1433 1
a1433 1
	@@${ECHO_MSG} "===>   Uncompressing manual pages for ${PKGNAME}"
d1438 1
a1438 1
	@@${ECHO_MSG} "===>   Compressing manual pages for ${PKGNAME}"
d1459 1
a1459 1
	@@${ECHO_MSG} "===>  Installing ${PKGNAME} from ${PKGFILE}"
d1500 1
a1500 1
	@@${ECHO_MSG} "===>  Building package for ${PKGNAME}"
d1529 1
a1529 1
	@@${ECHO_MSG} "===>  ${PKGNAME} may not be packaged: ${NO_PACKAGE}."
d1569 1
a1569 1
cdrom-packages: ${CDROM_PACKAGES}/${PKGNAME}${PKG_SUFX}
d1581 1
a1581 1
ftp-packages: ${FTP_PACKAGES}/${PKGNAME}${PKG_SUFX}
d1595 1
a1595 1
		tee ${PORTSDIR}/logs/${ARCH}/${PKGNAME}.log
d1597 1
a1597 1
${FTP_PACKAGES}/${PKGNAME}${PKG_SUFX}: ${PKGFILE}
d1599 3
a1601 3
	@@rm -f ${FTP_PACKAGES}/${PKGNAME}${PKG_SUFX}
	@@ln ${PKGFILE} ${FTP_PACKAGES}/${PKGNAME}${PKG_SUFX} 2>/dev/null || \
	cp -p ${PKGFILE} ${FTP_PACKAGES}/${PKGNAME}${PKG_SUFX}
d1603 1
a1603 1
${CDROM_PACKAGES}/${PKGNAME}${PKG_SUFX}: ${PKGFILE}
d1605 3
a1607 3
	@@rm -f ${CDROM_PACKAGES}/${PKGNAME}${PKG_SUFX}
	@@ln ${PKGFILE} ${CDROM_PACKAGES}/${PKGNAME}${PKG_SUFX} 2>/dev/null || \
	cp -p ${PKGFILE} ${CDROM_PACKAGES}/${PKGNAME}${PKG_SUFX}
d1613 1
a1613 1
	@@echo "${PKGNAME}"
d1630 2
a1631 2
	@@rm -rf ${WRKOBJDIR}/${PKGPATH}${_FEXT}
	@@mkdir -p ${WRKOBJDIR}/${PKGPATH}${_FEXT}
d1633 2
a1634 2
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${PKGPATH}${_FEXT} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${PKGPATH}${_FEXT}"; \
d1636 1
a1636 1
		ln -sf ${WRKOBJDIR}/${PKGPATH}${_FEXT} ${WRKDIR}; \
d1659 1
a1659 1
		ln -s ../${PKGREPOSITORYSUBDIR}/${PKGNAME}${PKG_SUFX} ${PACKAGES}/$$cat; \
d1665 1
a1665 1
	@@cd ${PACKAGES} && find . -type l -name ${PKGNAME}${PKG_SUFX}|xargs rm -f
d1699 2
a1700 2
	@@${ECHO_MSG} "===> Deinstalling for ${PKGNAME}"
	@@${PKG_DELETE} -f ${PKGNAME}
d1720 1
a1720 1
	@@${ECHO_MSG} "===>  Cleaning for ${PKGNAME}"
d1732 1
a1732 1
	@@${ECHO_MSG} "===>  Dist cleaning for ${PKGNAME}"
d1788 1
a1788 1
	@@echo ":: ${PKGPATH}/${PKGNAME}"
d1793 1
a1793 1
	@@name='${PKGPATH}/${PKGNAME}'; \
a1843 2
# Nobody should want to override this unless PKGNAME is simply bogus.

a1844 1
.if !target(package-name)
d1847 1
a1847 1
	@@${_DEPEND_ECHO} '${PKGPATH}/${PKGNAME}'
d1849 1
a1849 1
	@@${_DEPEND_ECHO} '${PKGNAME}'
a1850 1
.endif 
d1923 1
a1923 1
				${MAKE} ${_DEPEND_THRU} show VARNAME=PKGNAME`;; esac; \
d1943 1
a1943 1
						${ECHO_MSG} "===>  ${PKGNAME} depends on: $$dep - found"; \
d1946 1
a1946 1
						${ECHO_MSG} "===>  ${PKGNAME} depends on: $$dep - not found"; \
d1951 1
a1951 1
					${ECHO_MSG} "===> Returning to build of ${PKGNAME}"; \
d2007 1
a2007 1
	@@echo -n "${PKGNAME}|${.CURDIR:S,^${PORTSDIR}/,,}${_FEXT:S/-/,/g}|"
d2009 1
a2009 1
	@@echo -n "${PKGNAME}|${.CURDIR:S,^${PORTSDIR}/,,}|"
d2087 1
a2087 1
	@@echo ${PKGNAME} | ${HTMLIFY} > $@@.tmp3
@


1.361
log
@Allow for COMMENT-foo=	inside the Makefile.
NetBSD did this a while ago, this is a natural idea. It just took me
some time to figure out how to do that in a MULTI_PACKAGE context,
while maintaining compatibility with existing stuff.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.360 2001/03/16 14:54:40 espie Exp $$
d997 1
a997 1
	@@${ECHO_MSG} "===> Checking files for ${PKGNAME}"
@


1.360
log
@Simplify MULTI_PACKAGES, allow for PKGNAME-foo=value
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.359 2001/03/06 18:59:38 espie Exp $$
d544 5
a548 1
.if !defined(COMMENT)
d550 1
a550 1
COMMENT=${PKGDIR}/COMMENT${SUBPACKAGE}${_FEXT}
d552 1
a552 1
COMMENT=	${PKGDIR}/COMMENT${SUBPACKAGE}
d556 3
d600 1
a600 1
_PKG_PREREQ= ${WRKPKG}/PLIST${SUBPACKAGE} ${WRKPKG}/DESCR${SUBPACKAGE} ${COMMENT}
d603 1
a603 1
PKG_ARGS= -v -c '${COMMENT}' -d ${WRKPKG}/DESCR${SUBPACKAGE}
d2017 1
a2017 8
	@@case '${COMMENT}' in \
		-*) echo -n '${COMMENT:S/^-//}|';; \
		*)if [ -f '${COMMENT}' ]; then \
			echo -n "`cat ${COMMENT}`|"; \
		else \
			echo -n "** No Description|"; \
		fi;; \
	esac; \
@


1.359
log
@Create an intermediate mtree.spec that is used for fake installations.
Use of VAR_SUBSTS will solve a few nasty problems.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.358 2001/03/01 00:01:40 espie Exp $$
d746 3
d750 1
@


1.358
log
@Add `===> Checking files for pkgname' line to simplify automatic
recognition of various package builds.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.357 2001/02/24 22:02:08 espie Exp $$
d579 3
d585 3
d1387 1
a1387 1
${_FAKE_COOKIE}: ${_BUILD_COOKIE} 
d1395 1
a1395 1
		-f ${PORTSDIR}/infrastructure/db/fake.mtree  >/dev/null
d1740 1
a1740 1
	MTREE_FILE=${PORTSDIR}/infrastructure/db/fake.mtree \
@


1.357
log
@Rework the dependency framework.
* pull every dependency under the same rule, using specialized fragments.
* re-check after the dependency is expanded, unless earlyexit is true.
* explicitly recognize /nonexistent as a specific way to have always
triggered dependencies, use it to handle DEPENDS in a uniform way.
* parse dependencies fully. Note that we know have a pkg variable that will
be used.

Thanks to naddy@@ for useful tweaks.

This is probably not quite perfect yet, stuff may break. Other stuff that
remain to be done:

- handle library dependencies better, so that lib.10 will match only
lib.10.x and not lib.100.
- handle default FLAVORS correctly. This involves not
passing FLAVOR='', but rearranging ${MAKE} ${_DEPEND_THRU} to remove
FLAVOR from the environment and from MAKEFLAGS (yucky).
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.356 2001/02/13 12:09:07 wilfried Exp $$
d980 1
@


1.356
log
@set variable before we use it, ok espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.355 2001/02/10 13:50:13 espie Exp $$
d1856 33
a1889 1
.if !target(depends)
d1892 6
a1897 1
.  for _DEP in fetch build run
d1899 40
a1938 28
.    if defined(${_DEP:U}_DEPENDS) && !defined(NO_DEPENDS)
	@@PATH=${PORTPATH}; { unset DEPENDS_TARGET || true; }; \
	for i in ${${_DEP:U}_DEPENDS:S,::,:,}; do \
		cd ${PORTSDIR}; \
		prog=`echo $$i | sed -e 's/:.*//'`; \
		dir=`echo $$i | sed -e 's/[^:]*://'`; \
		if expr "$$dir" : '.*:' > /dev/null; then \
			target=`echo $$dir | sed -e 's/.*://'`; \
			dir=`echo $$dir | sed -e 's/:.*//'`; \
		else \
			target=${DEPENDS_TARGET}; \
		fi; \
		if [ ! -d $$dir ]; then \
			echo ">> No directory for $$prog ($$dir)"; \
		fi; \
		if [ -L $$dir ]; then \
			echo ">> Broken dependency: $$dir is a symbolic link"; \
			exit 1; \
		fi; \
		found=false; \
		if expr "$$prog" : \\/ >/dev/null; then \
			if [ -e "$$prog" ]; then \
				found=true; \
			fi; \
		else \
			IFS=:; for d in $$PATH; do \
				if [ -x $$d/$$prog ]; then \
					found=true; \
d1940 3
a1942 14
				fi \
			done; unset IFS; \
		fi; \
		if $$found; then \
			${ECHO_MSG} "===>  ${PKGNAME} depends on file: $$prog - found"; \
		else \
			${ECHO_MSG} "===>  ${PKGNAME} depends on file: $$prog - not found"; \
			${ECHO_MSG} "===>  Verifying $$target for $$prog in $$dir"; \
			if cd $$dir && PKGPATH="$$dir" ${MAKE} ${_DEPEND_THRU} $$target; then \
				${ECHO_MSG} "===> Returning to build of ${PKGNAME}"; \
			else \
				exit 1; \
			fi; \
		fi; \
a1943 73
.    endif
.  endfor

lib-depends:
.  if defined(LIB_DEPENDS) && !defined(NO_DEPENDS)
.    if defined(NO_SHARED_LIBS)
	@@{ unset DEPENDS_TARGET || true; }; \
	for i in ${LIB_DEPENDS:S,::,:,}; do \
		cd ${PORTSDIR}; \
		lib=`echo $$i | sed -e 's/:.*//' -e 's|\([^\\]\)[\\\.].*|\1|'`; \
		dir=`echo $$i | sed -e 's/[^:]*://'`; \
		if expr "$$dir" : '.*:' > /dev/null; then \
			target=`echo $$dir | sed -e 's/.*://'`; \
			dir=`echo $$dir | sed -e 's/:.*//'`; \
		else \
			target=${DEPENDS_TARGET}; \
		fi; \
		if [ ! -d "$$dir" ]; then \
			echo ">> No directory for $$lib ($$dir)"; \
		fi; \
		if [ -L $$dir ]; then \
			echo ">> Broken dependency: $$dir is a symbolic link"; \
			exit 1; \
		fi; \
		tmp=`mktemp /tmp/bpmXXXXXXXXXX`; \
		if ${LD} -r -o $$tmp -L${LOCALBASE}/lib -L${X11BASE}/lib -l$$lib; then \
			${ECHO_MSG} "===>  ${PKGNAME} depends on library: $$lib - found"; \
		else \
			${ECHO_MSG} "===>  ${PKGNAME} depends on library: $$lib - not found"; \
			${ECHO_MSG} "===>  Verifying $$target for $$lib in $$dir"; \
			if cd $$dir && PKGPATH="$$dir" ${MAKE} ${_DEPEND_THRU} $$target; then \
				${ECHO_MSG} "===>  Returning to build of ${PKGNAME}"; \
			else \
				rm -f $$tmp; \
				exit 1; \
			fi; \
		fi; \
		rm -f $$tmp; \
	done
.    else
	@@{ unset DEPENDS_TARGET || true ; }; \
	for i in ${LIB_DEPENDS:S,::,:,}; do \
		cd ${PORTSDIR}; \
		lib=`echo $$i | sed -e 's/:.*//' -e 's|\([^\\]\)\.|\1\\\\.|g'`; \
		dir=`echo $$i | sed -e 's/[^:]*://'`; \
		if expr "$$dir" : '.*:' > /dev/null; then \
			target=`echo $$dir | sed -e 's/.*://'`; \
			dir=`echo $$dir | sed -e 's/:.*//'`; \
		else \
			target=${DEPENDS_TARGET}; \
		fi; \
		libname=`echo $$lib | sed -e 's|\\\\||g'`; \
		if [ ! -d "$$dir" ]; then \
			echo ">> No directory for $$libname ($$dir)"; \
		fi; \
		if [ -L $$dir ]; then \
			echo ">> Broken dependency: $$dir is a symbolic link"; \
			exit 1; \
		fi; \
		reallib=`${LDCONFIG} -r | grep -e "-l$$lib" | awk '{ print $$3 }'`; \
		if [ "X$$reallib" = X"" ]; then \
			${ECHO_MSG} "===>  ${PKGNAME} depends on shared library: $$libname - not found"; \
			${ECHO_MSG} "===>  Verifying $$target for $$libname in $$dir"; \
			if cd $$dir && PKGPATH="$$dir" ${MAKE} ${_DEPEND_THRU} $$target; then \
				${ECHO_MSG} "===>  Returning to build of ${PKGNAME}"; \
			else \
				exit 1; \
			fi; \
		else \
			${ECHO_MSG} "===>  ${PKGNAME} depends on shared library: $$libname - $$reallib found"; \
		fi; \
	done
.    endif
d1945 1
a1945 30

misc-depends:
.  if defined(DEPENDS) && !defined(NO_DEPENDS)
	@@{ unset DEPENDS_TARGET || true; } ; \
	for dir in ${DEPENDS:S,::,:,}; do \
		cd ${PORTSDIR}; \
		if expr "$$dir" : '.*:' > /dev/null; then \
			target=`echo $$dir | sed -e 's/.*://'`; \
			dir=`echo $$dir | sed -e 's/:.*//'`; \
		else \
			target=${DEPENDS_TARGET}; \
		fi; \
		if [ ! -d $$dir ]; then \
			echo ">> No directory for $$dir."; \
		fi; \
		if [ -L $$dir ]; then \
			echo ">> Broken dependency: $$dir is a symbolic link"; \
			exit 1; \
		fi; \
		${ECHO_MSG} "===>  ${PKGNAME} depends on: $$dir"; \
		${ECHO_MSG} "===>  Verifying $$target for $$dir"; \
		if cd $$dir && PKGPATH="$$dir" ${MAKE} ${_DEPEND_THRU} $$target; then \
			${ECHO_MSG} "===>  Returning to build of ${PKGNAME}"; \
		else \
			exit 1; \
		fi \
	done
.  endif

.endif
d1949 1
a1949 1
.if defined(LIB_DEPENDS) || defined(DEPENDS)
d1951 1
a1951 1
	${DEPENDS:S,::,:,:C/:.*//} 
@


1.355
log
@Run pkg_create under ${SUDO} and fix the owner afterwards when needed.
The cleaner fix would be to create the package to stdout under SUDO
and redirect it, but that junk (pkg_create) is actively fighting that.

God, I've got to rewrite it and retire that crap.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.354 2001/02/10 13:47:54 espie Exp $$
d1957 1
a1964 1
		libname=`echo $$lib | sed -e 's|\\\\||g'`; \
@


1.354
log
@Fix DEF_UMASK check, should take ${SUDO} into account.
This ought to please naddy and avsm...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.353 2001/02/03 01:14:52 miod Exp $$
d1494 2
a1495 1
	  if ${PKG_CMD} ${PKG_ARGS} ${PKGFILE}; then \
@


1.353
log
@Don't mention LICENCE_TYPE anymore
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.352 2001/01/18 14:58:16 espie Exp $$
d1382 1
a1382 1
	@@if [ `${SH} -c umask` != ${DEF_UMASK} ]; then \
@


1.352
log
@move variables that only belong in old-install.mk to old-install.mk

Kill old work-arounds that are no longer needed since 2.8 came out.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.351 2001/01/08 22:34:51 brad Exp $$
d978 1
a978 1
# You need to define LICENCE_TYPE and PERMIT_* to make the warning go away.
@


1.351
log
@eliminate NO_CDROM and make the use of :U/:L consistent. Ok'd by espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.350 2001/01/08 22:10:36 espie Exp $$
a22 5
# recent /usr/share/mk/* should include bsd.own.mk, guard for older versions
.if !defined(BSD_OWN_MK)
.  include <bsd.own.mk>
.endif

a66 3
# PKG_DBDIR		- Where package installation is recorded (default: /var/db/pkg)
# FORCE_PKG_REGISTER - If set, it will overwrite any existing package
#				  registration information in ${PKG_DBDIR}/${PKGNAME}.
a457 3
# DIRMODE lives in bsd.own.mk, but only starting from OpenBSD 2.7 !
DIRMODE?=755

a622 2
# where pkg_add records its dirty deeds.
PKG_DBDIR?=		/var/db/pkg
@


1.350
log
@Always make TRUEPREFIX/DESTDIR available
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.349 2001/01/08 22:09:24 espie Exp $$
a59 2
# NO_CDROM		- Port may not go on CDROM.  Set this string to reason.
#
d231 1
a231 1
.  if ${NOCLEANDEPENDS:L}=="no"
d332 1
a332 1
.if ${FAKE:U} == "YES"
d629 1
a629 1
.if ${FAKE:U} == "YES"
d882 1
a882 1
.if ${FAKE:U} == "YES"
a939 2
.  elif (defined(NO_CDROM) && defined(FOR_CDROM))
IGNORE=	"may not be placed on a CDROM: ${NO_CDROM}"
d1392 1
a1392 1
.if ${FAKE:U} == "YES"
d1468 1
a1468 1
.    if ${FAKE:U} == "YES"
d1479 1
a1479 1
.if ${FAKE:U} == "YES"
d1708 1
a1708 1
.  if ${CLEANDEPENDS:L}=="yes"
d1742 1
a1742 1
.if ${FAKE:U} == "YES"
d2348 1
a2348 1
.if ${FAKE:U} == "NO"
@


1.349
log
@Less comments, see bsd.port.mk(5)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.348 2000/12/23 12:27:17 espie Exp $$
d252 2
a253 2
LOCALBASE?=		${DESTDIR}/usr/local
X11BASE?=		${DESTDIR}/usr/X11R6
d293 2
d884 3
a886 6
.if ${FAKE:U} == "YES" && !defined(TRUEPREFIX)
MANPREFIX?=  ${WRKINST}${PREFIX}
CATPREFIX?=  ${WRKINST}${PREFIX}
.else
MANPREFIX?=	${PREFIX}
CATPREFIX?=	${PREFIX}
@


1.348
log
@indentation
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.347 2000/12/23 12:25:57 espie Exp $$
a69 1
# CATEGORIES	- A list of descriptive categories into which this port falls.
a73 3
# DISTNAME		- Name of port or distribution.
# IGNOREFILES	- If some of the ${ALLFILES} are not checksum-able, set
#				  this variable to their names.
@


1.347
log
@take the old non-fake code out of line, for greater clarity (and since
it's so seldom used now).

Remove a few targets that are not really needed (mirror-distfiles, use
mirror-maker instead).

More changes to fake to come, once they've been properly tested.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.346 2000/12/16 15:49:12 espie Exp $$
d806 1
a806 1
.  if !empty(EXTRACT_ONLY:M*.zip)
d808 2
a809 2
.  endif
.  if !empty(EXTRACT_ONLY:M*.tar.bz2)
d811 1
a811 1
.  endif
@


1.346
log
@link-categories/unlink-categories target:
populate ports tree with symlinks.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.345 2000/12/16 15:47:35 espie Exp $$
a162 1
# fetch-list	- Show list of files that would be retrieved by fetch
a179 7
# If ${FAKE} == No
# install		- Install the results of a build.
# reinstall		- Install the results of a build, ignoring "already installed"
#				  flag.
# deinstall		- Remove the installation.  Alias: uninstall
# package		- Create a package from an _installed_ port.
#
a191 4
# mirror-distfiles	- Mirror the distfile(s) if they are freely redistributable
#				  Setting MIRROR_DISTFILE to "No" in the package Makefile
#				  will override the default "Yes", and the distfile will
#				  not be fetched.
a399 3
# By default, distfiles have no restrictions placed on them
MIRROR_DISTFILE?=	Yes

d1462 1
a1462 1
.if ${CONFIGURE_STYLE:Mimake}
d1467 1
a1467 1
.endif
a1469 77

.else

${_FAKE_COOKIE}: ${_BUILD_COOKIE}
	@@echo 1>&2 "*** ${PKGNAME} does not use fake installation yet"

# The real install, old version
${_INSTALL_COOKIE}: ${_BUILD_COOKIE} 
	@@cd ${.CURDIR} && exec ${MAKE} run-depends lib-depends 
.  if !defined(NO_INSTALL)
	@@${ECHO_MSG} "===>  Installing for ${PKGNAME}"
# Kludge
.    if ${CONFIGURE_STYLE:Mimake}
	@@mkdir -p /usr/local/lib/X11
	@@if [ ! -e /usr/local/lib/X11/app-defaults ]; then \
		ln -sf /var/X11/app-defaults /usr/local/lib/X11/app-defaults; \
	fi
.    endif
.    if !defined(NO_PKG_REGISTER) && !defined(FORCE_PKG_REGISTER)
	@@if [ -d ${PKG_DBDIR}/${PKGNAME} -o "X$$(ls -d ${PKG_DBDIR}/${PKGNAME:C/-[0-9].*//g}-* 2> /dev/null)" != "X" ]; then \
		echo "===>  ${PKGNAME} is already installed - perhaps an older version?"; \
		echo "      If so, you may wish to \`\`make deinstall'' and install"; \
		echo "      this port again by \`\`make reinstall'' to upgrade it properly."; \
		echo "      If you really wish to overwrite the old port of ${PKGNAME}"; \
		echo "      without deleting it first, set the variable \"FORCE_PKG_REGISTER\""; \
		echo "      in your environment or the \"make install\" command line."; \
		exit 1; \
	fi
.    endif
	@@if [ `${SH} -c umask` != ${DEF_UMASK} ]; then \
		${ECHO_MSG} "===>  Warning: your umask is \"`${SH} -c umask`"\".; \
		${ECHO_MSG} "      If this is not desired, set it to an appropriate value"; \
		${ECHO_MSG} "      and install this port again by \`\`make reinstall''."; \
	fi
	@@${_MAKE_COOKIE} ${_INSTALL_PRE_COOKIE}
.    if target(pre-install)
	@@cd ${.CURDIR} && exec ${MAKE} pre-install
.    endif
.    if target(do-install)
	@@cd ${.CURDIR} && exec ${MAKE} do-install
.    else
# What INSTALL normally does:
	@@cd ${WRKBUILD} && ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} ${INSTALL_TARGET}
# End of INSTALL.
.    endif
.    if target(post-install)
	@@cd ${.CURDIR} && exec ${MAKE} post-install
.    endif
.    if defined(_MANPAGES) || defined(_CATPAGES)
.      if defined(MANCOMPRESSED) && defined(NOMANCOMPRESS)
	@@${ECHO_MSG} "===>   Uncompressing manual pages for ${PKGNAME}"
.        for manpage in ${_MANPAGES} ${_CATPAGES}
	@@${GUNZIP_CMD} ${manpage}.gz
.        endfor
.      elif !defined(MANCOMPRESSED) && !defined(NOMANCOMPRESS)
	@@${ECHO_MSG} "===>   Compressing manual pages for ${PKGNAME}"
.        for manpage in ${_MANPAGES} ${_CATPAGES}
	@@if [ -L ${manpage} ]; then \
		set - `file ${manpage}`; \
		shift `expr $$# - 1`; \
		ln -sf $${1}.gz ${manpage}.gz; \
		rm ${manpage}; \
	else \
		${GZIP_CMD} ${manpage}; \
	fi
.          endfor
.      endif
.    endif
.    if defined(${MESSAGE})
	@@cat	${WRKBUILD}/MESSAGE${SUBPACKAGE}
.    endif
.    if !defined(NO_PKG_REGISTER)
	@@cd ${.CURDIR} && exec ${MAKE} fake-pkg
.    endif
.  endif
	@@${_MAKE_COOKIE} ${_INSTALL_COOKIE}

a1559 8
# This is for the use of sites which store distfiles which others may
# fetch - only fetch the distfile if it is allowed to be
# re-distributed freely
mirror-distfiles:
.if (${MIRROR_DISTFILE:L} == "yes")
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes fetch
.endif

a1742 2
# Prints out a list of files to fetch (useful to do a batch fetch)

a1744 34
.if !target(fetch-list)
fetch-list:
	@@cd ${.CURDIR} && ${MAKE} fetch-list-recursive RECURSIVE_FETCH_LIST=${RECURSIVE_FETCH_LIST} | sort -u
.endif # !target(fetch-list)

.if !target(fetch-list-recursive)
fetch-list-recursive:
	@@cd ${.CURDIR} && exec ${MAKE} fetch-list-one-pkg 
.  if ${RECURSIVE_FETCH_LIST:L} != "no"
	@@for dir in `echo ${_ALWAYS_DEP} ${_BUILD_DEP} ${_RUN_DEP} \
	| tr '\040' '\012' | sort -u`; do \
		cd ${PORTSDIR} && cd $$dir && PKGPATH="$$dir" ${MAKE} fetch-list-recursive; \
	done
.  endif # ${RECURSIVE_FETCH_LIST} != "NO"
.endif # !target(fetch-list-recursive)

.if !target(fetch-list-one-pkg)
fetch-list-one-pkg:
	@@mkdir -p ${FULLDISTDIR}
	@@[ -z "${FULLDISTDIR}" ] || echo "mkdir -p ${FULLDISTDIR}"
	@@cd ${FULLDISTDIR}; \
	 for select in ${_EVERYTHING}; do \
	 	file=`echo $$select|sed -e 's,:[0-9]$$,,'`; \
		if [ ! -f $$file -a ! -f `basename $$file` ]; then \
			echo -n "cd ${FULLDISTDIR} && [ -f $$file -o -f `basename $$file` ] || " ; \
			${_SITE_SELECTOR}; \
			for site in $$sites ; do \
				echo -n ${FETCH_CMD} ${FETCH_BEFORE_ARGS} $${site}$${file} "${FETCH_AFTER_ARGS}" '|| ' ; \
			done; \
			echo "echo $${file} not fetched" ; \
		fi \
	done
.endif # !target(fetch-list-one-pkg)

a1756 13
.else

# Figure out where the local mtree file is
.  if ${PREFIX} == "/usr/local"
MTREE_FILE?=	/etc/mtree/BSD.local.dist
.  else
MTREE_FILE?=	/etc/mtree/BSD.x11.dist
.  endif

plist: install
	@@DESTDIR=${PREFIX} PREFIX=${PREFIX} LDCONFIG="${LDCONFIG}" MTREE_FILE=${MTREE_FILE} \
	INSTALL_PRE_COOKIE=${_INSTALL_PRE_COOKIE} \
	perl ${PORTSDIR}/infrastructure/install/make-plist ${PLIST}
a2316 43
# Fake installation of package so that user can pkg_delete it later.
# Also, make sure that an installed port is recognized correctly in
# accordance to the @@pkgdep directive in the packing lists

.if !target(fake-pkg)
fake-pkg: ${_PKG_PREREQ}
	@@if [ `/bin/ls -l ${COMMENT} | awk '{print $$5}'` -gt 60 ]; then \
	    echo "** ${COMMENT} too large - installation not recorded."; \
	    exit 1; \
	 fi
	@@if [ ! -d ${PKG_DBDIR} ]; then rm -f ${PKG_DBDIR}; mkdir -p ${PKG_DBDIR}; fi
.  if defined(FORCE_PKG_REGISTER)
	@@rm -rf ${PKG_DBDIR}/${PKGNAME}
.  endif
	@@if [ ! -d ${PKG_DBDIR}/${PKGNAME} ]; then \
		${ECHO_MSG} "===>  Registering installation for ${PKGNAME}"; \
		mkdir -p ${PKG_DBDIR}/${PKGNAME}; \
		${PKG_CMD} ${PKG_ARGS} -O ${PKGFILE} > ${PKG_DBDIR}/${PKGNAME}/+CONTENTS; \
		cp ${WRKPKG}/DESCR${SUBPACKAGE} ${PKG_DBDIR}/${PKGNAME}/+DESC; \
		cp ${COMMENT} ${PKG_DBDIR}/${PKGNAME}/+COMMENT; \
		if [ -f ${WRKPKG}/INSTALL${SUBPACKAGE} ]; then \
			cp ${WRKPKG}/INSTALL${SUBPACKAGE} ${PKG_DBDIR}/${PKGNAME}/+INSTALL; \
		fi; \
		if [ -f ${WRKPKG}/DEINSTALL${SUBPACKAGE} ]; then \
			cp ${WRKPKG}/DEINSTALL${SUBPACKAGE} ${PKG_DBDIR}/${PKGNAME}/+DEINSTALL; \
		fi; \
		if [ -f ${WRKPKG}/REQ${SUBPACKAGE} ]; then \
			cp ${WRKPKG}}/REQ${SUBPACKAGE} ${PKG_DBDIR}/${PKGNAME}/+REQ; \
		fi; \
		if [ -f ${WRKPKG}/MESSAGE${SUBPACKAGE} ]; then \
			cp ${WRKPKG}/MESSAGE${SUBPACKAGE} ${PKG_DBDIR}/${PKGNAME}/+DISPLAY; \
		fi; \
		for dep in `cd ${.CURDIR} && ${MAKE} package-depends ECHO_MSG=true | ${_SORT_DEPENDS}`; do \
			if [ -d ${PKG_DBDIR}/$$dep ]; then \
				if ! grep ^${PKGNAME}$$ ${PKG_DBDIR}/$$dep/+REQUIRED_BY \
					>/dev/null 2>&1; then \
					echo ${PKGNAME} >> ${PKG_DBDIR}/$$dep/+REQUIRED_BY; \
				fi; \
			fi; \
		done; \
	fi
.endif

d2357 4
d2367 1
a2367 2
   fake-pkg fetch fetch-depends fetch-list fetch-list-one-pkg \
   fetch-list-recursive install lib-depends makesum mirror-distfiles \
@


1.345
log
@Enforce directory check in dependencies, so that link-category can come
alive (since ports can now be symlinked, porters need some strong check
so that they don't create bogus dependencies).
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.344 2000/12/16 15:44:35 espie Exp $$
d2527 22
d2567 2
a2568 1
   distpatch real-distpatch do-distpatch post-distpatch show
@


1.344
log
@Remove compatibility scaffolding for EXTRACT_CMD, EXTRACT_BEFORE_ARGS,
EXTRACT_AFTER_ARGS
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.343 2000/12/14 13:13:53 espie Exp $$
d2047 4
d2096 4
d2130 4
d2164 4
@


1.343
log
@Fix build of README.html (use PKGPATH)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.342 2000/12/14 13:08:59 espie Exp $$
a829 25
# Compatibility game: if anything is defined, we define the rest
# and invoke the old extract target
.if defined(EXTRACT_CMD) || defined(EXTRACT_BEFORE_ARGS) || \
	defined(EXTRACT_AFTER_ARGS)
.  if ${USE_ZIP:L} != "no"
BUILD_DEPENDS+=		${UNZIP}::archivers/unzip
EXTRACT_CMD?=		${UNZIP}
EXTRACT_BEFORE_ARGS?=  -q
EXTRACT_AFTER_ARGS?=   -d ${WRKDIR}
.  else
# common tar case

EXTRACT_AFTER_ARGS?=	| ${TAR} -xf -
EXTRACT_BEFORE_ARGS?=	-dc

.    if ${USE_BZIP2:L} != "no"
BUILD_DEPENDS+=		${BZIP2}::archivers/bzip2
EXTRACT_CMD?=		${BZIP2}
.    else
EXTRACT_CMD?=		${GZIP_CMD}
.    endif
.  endif
EXTRACT_CASES= *) ${EXTRACT_CMD} ${EXTRACT_BEFORE_ARGS} ${FULLDISTDIR}/$$archive ${EXTRACT_AFTER_ARGS};;
.else

d833 1
a833 1
.  if ${USE_ZIP:L} != "no"
d836 2
a837 2
.  endif
.  if ${USE_BZIP2:L} != "no"
d840 1
a840 1
.  endif
a844 1
.endif
a2508 24
.endif

# Compatibility game: we have to define the old variables now for legacy
# Makefiles
.if !defined(EXTRACT_CMD)
.  if defined(USE_ZIP)
EXTRACT_CMD?=		${UNZIP}
EXTRACT_SUFX?=		.zip
EXTRACT_BEFORE_ARGS?=  -q
EXTRACT_AFTER_ARGS?=   -d ${WRKDIR}
.  else
# common tar case

EXTRACT_AFTER_ARGS?=	| ${TAR} -xf -
EXTRACT_BEFORE_ARGS?=	-dc

.    if defined(USE_BZIP2)
EXTRACT_CMD?=		${BZIP2}
EXTRACT_SUFX?=		.tar.bz2
.    else
EXTRACT_CMD?=		${GZIP_CMD}
EXTRACT_SUFX?=		.tar.gz
.    endif
.  endif
@


1.342
log
@Add extraction support for shell archives (.sh, .shar, .shar.gz...)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.342 2000/12/01 16:31:11 espie Exp $$
d2344 1
a2344 1
		sed -e 's|%%PORT%%|'"`${MAKE} package-path | ${HTMLIFY}`"'|g' \
@


1.341
log
@Remove documentation that is now in bsd.port.mk(5)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.340 2000/10/22 16:31:38 espie Exp $$
d867 2
@


1.340
log
@With the new MAINTAINER format, this looked weird
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.339 2000/10/22 16:06:25 espie Exp $$
d51 3
a59 3
# The following variables are deprecated, use
# PERMIT_xxx, CONFIGURE_STYLE, or EXTRACT_CASES instead:
# ========================================================================
a60 11
# EXTRACT_CMD	- Command for extracting archives (default: "gzip",
#				  "bzip2" if USE_BZIP2, "unzip" if USE_ZIP).
# EXTRACT_SUFX	- Suffix for archive files (default: ".tar.gz",
#				  ".tar.bz2" if USE_BZIP2, ".zip" if USE_ZIP).
# EXTRACT_BEFORE_ARGS 
#				- Arguments to ${EXTRACT_CMD} before filename
#				  (default: "-dc" for gzip or bzip2, "-q" for unzip)
# EXTRACT_AFTER_ARGS 
#				- Arguments to ${EXTRACT_CMD} following filename
#				  (default: "| ${TAR} -xf -", or "-d ${WKRDIR}" if USE_ZIP).
# ========================================================================
a63 11
# ONLY_FOR_ARCHS - If a port only makes sense to certain architectures, this
#				  is a list containing the names for them.  It is checked
#				  against the predefined ${MACHINE_ARCH} value
# ARCH			- The architecture (default: "uname -m").
# OPSYS			- The operating system (default: "uname -s").
# OPSYS_VER		- The current version of the operating system
#				  (default: "uname -r").
# PORTSDIR		- The root of the ports tree.  Defaults: /usr/ports
# DISTDIR 		- Where to get gzip'd, tarballed copies of original sources.
#				  (default: ${PORTSDIR}/distfiles).
# PREFIX		- Where to install things in general (default: /usr/local).
a69 8
# PACKAGES		- A top level directory where all packages go (rather than
#				  going locally to each port). (default:
#				  ${PORTSDIR}/packages/${ARCH}).
# GMAKE			- Set to path of GNU make if not in $PORTPATH (default: gmake).
# XMKMF			- Set to path of `xmkmf' if not in $PORTPATH 
#                 (default: xmkmf -a ).
# MAINTAINER	- The e-mail address of the contact person for this port
#				  Default: ports@@openbsd.org
a70 9
# WRKOBJDIR		- A top level directory where, if defined, the separate working
#				  directories will get created, and symbolically linked to from
#				  ${WRKDIR} (see below).  This is useful for building ports on
#				  several architectures, then ${PORTSDIR} can be NFS-mounted
#				  while ${WRKOBJDIR} is local to every arch
# PREFERRED_CIPHERS
#				- a list of the form cipher.sig of programs to use to check
#				  recorded checksums, in order of decreasing trust.
#				  (default to using sha1, then rmd160, then md5).
a74 17
# WRKDIR 		- A temporary working directory that gets *clobbered* on clean
#				  (default: ${.CURDIR}/work).
# WRKDIST 		- A subdirectory of ${WRKDIR} where the distribution actually
#				  unpacks to.  (Default: ${WRKDIR}/${DISTNAME}).
# WRKSRC		- where the actual source lives (default ${WRKDIST}).
# WRKBUILD		- The directory where the port is actually built, useful for 
#                 ports that need a separate directory (default: ${WRKSRC}).
#				  This is intended for GNU configure.
# WRKPKG		- Subdirectory of WRKBUILD where package information gets
#				  generated (default: ${WKRBUILD}/pkg, don't override unless
#				  it conflicts with existing stuff.
# WRKINST       - The directory where new ports get installed (default:
#				  ${WRKDIR}/fake-${ARCH}
# SEPARATE_BUILD
#               - define if the port can build in directory separate from
#                 WRKSRC. This redefines WRKBUILD to be arch-dependent,
#                 along with the configure, build and install cookies
a75 22
# DISTFILES		- Name(s) of archive file(s) containing distribution
#				  (default: ${DISTNAME}${EXTRACT_SUFX}).
#				  Each name can take an additional :[0-9] suffix, in which
#				  case it will be fetched from the corresponding 
#				  MASTER_SITES0...9 sites.
# SUPDISTFILES  - Names of supplementary archive files that don't get
# 				  used all the time (default: empty).
# PATCHFILES	- Name(s) of additional files that contain distribution
#				  patches (default: none).  make will look for them at
#				  MASTER_FILES (see above).  They will automatically be
#				  uncompressed before patching if the names end with
#				  ".gz" or ".Z".
# DIST_SUBDIR	- Suffix to ${DISTDIR}.  If set, all ${DISTFILES} 
#				  and ${PATCHFILES} will be put in this subdirectory of
#				  ${DISTDIR}.  Also they will be fetched in this subdirectory 
#				  from FreeBSD mirror sites.
# FULLDISTDIR	- ${DISTDIR}/${DIST_SUBDIR}, useful for non-standard
#                 installations that override fetch and/or extract.
# ALLFILES		- All of ${DISTFILES} and ${PATCHFILES}, maybe SUPDISTFILES
#                 as well. Set by bsd.port.mk, NOT the user.
# MIRROR_DISTFILE - Whether the distfile is redistributable without restrictions.
#				  Defaults to "Yes", set this to "No" if restrictions exist.
a77 16
# PKGNAME		- Name of the package file to create if the DISTNAME 
#				  isn't really relevant for the port/package
#				  (default: ${DISTNAME}).
# EXTRACT_ONLY	- If defined, a subset of ${DISTFILES} you want to
#			  	  actually extract.
# PATCHDIR 		- A directory containing any additional patches you made
#				  to port this software to OpenBSD (default:
#				  ${.CURDIR}/patches)
# PATCH_LIST	- list of patches to apply, can include wildcards (default:
#                 patch-*)
# SCRIPTDIR 	- A directory containing any auxiliary scripts
#				  (default: ${.CURDIR}/scripts)
# FILESDIR 		- A directory containing any miscellaneous additional files.
#				  (default: ${.CURDIR}/files)
# PKGDIR 		- A direction containing any package creation files.
#				  (default: ${.CURDIR}/pkg)
a80 2
# MTREE_FILE	- The name of the mtree file to use for make plist, set only
#				  if port does not install in a standard place.
a84 6
# FAKE		    - Install first into ${WRKINST}, build the package from there,
#				  and perform the real install from the package (default: Yes)
# FAKE_FLAGS	- Flags to pass to make for the fake install, used to
# 				  override the default install directory (Defaults:
# 				  something relevant for gnu configure and imake)
#
a91 1
# CLEANDEPENDS  - Nuke dependent dirs on make clean (Default: no)
a93 4
# USE_BZIP2		- Port distfiles use bzip2 instead of gzip for compression.
# USE_ZIP		- Port distfiles use zip instead of tar for packaging.
# USE_GMAKE		- Port uses gmake.
# USE_LIBTOOL	- Port uses libtool.
a94 1
# AUTOCONF_DIR  - Where to apply autoconf (default: ${WRKSRC}).
a96 12
# CONFIGURE_STYLE
#               - Set to value corresponding to some standard configuration
#				  perl: perl's MakeMaker Makefile.PL
#				  gnu [autoconf] [old] [dest]: gnu style configure (old: no
#				  sysconfdir), (dest: add DESTDIR, does not handle it),
#				  (autoconf: needed by port, implies gnu)
# 				XXX: cygnus products do NOT use autoconf for making the main 
#      			configure from configure.in
#				  imake [noman]: port uses imake for configuration.
#                 (noman: no man page installation)
#			      simple: port has its own configure script
#
a98 1
# CONFIGURE_SCRIPT - Name of configure script, defaults to 'configure'.
a100 6
# CONFIGURE_SHARED - An argument to GNU configure that expands to
#				  --enable-shared for those architectures that support
#				  shared libraries and --disable-shared for architectures
#				  that do not support shared libraries.
# LIBTOOL_FLAGS	- Pass these flags in ${CONFIGURE} and ${MAKE} environment so
#				  to be used as args by libtool.
a104 29
# MAKE_ENV		- Additional environment vars passed to sub-make in build
#				  stage.
# IS_INTERACTIVE - Set this if your port needs to interact with the user
#				  during a build.  User can then decide to skip this port by
#				  setting ${BATCH}, or compiling only the interactive ports
#				  by setting ${INTERACTIVE}.
# FETCH_DEPENDS - A list of "path::dir" pairs of other ports this
#				  package depends in the "fetch" stage.  "path" is the
#				  name of a file if it starts with a slash (/), an
#				  executable otherwise.  make will test for the
#				  existence (if it is a full pathname) or search for
#				  it in $PORTPATH (if it is an executable) and go
#				  into "dir" to do a "make all install" if it's not
#				  found.
# BUILD_DEPENDS - A list of "path::dir" pairs of other ports this
#				  package depends to build (between the "extract" and
#				  "build" stages, inclusive).  The test done to
#				  determine the existence of the dependency is the
#				  same as FETCH_DEPENDS.
# RUN_DEPENDS	- A list of "path::dir" pairs of other ports this
#				  package depends to run.  The test done to determine
#				  the existence of the dependency is the same as
#				  FETCH_DEPENDS.  This will be checked during the
#				  "install" stage and the name of the dependency will
#				  be put into the package as well.
# LIB_DEPENDS	- A list of "lib::dir" pairs of other ports this package
#				  depends on.  "lib" is the name of a shared library.
#				  make will use "ldconfig -r" to search for the
#				  library.  Note that lib can be any regular expression.
a108 2
# FETCH_CMD		  - Full path to ftp/http fetch command if not in $PORTPATH
#				  (default: /usr/bin/ftp).
a119 4
# ALL_TARGET	- The target to pass to make in the package when building.
#				  (default: "all")
# INSTALL_TARGET- The target to pass to make in the package when installing.
#				  (default: "install")
a126 2
# REQUIRES_MOTIF- Set this in your port if it requires Motif.  It will  be
#				  built only if HAVE_MOTIF is set.
a137 2
# ECHO_MSG		- Used to print all the '===>' style prompts - override this
#				  to turn them off (default: /bin/echo).
a139 2
# PATCH_DEBUG	- If set to Yes, print out more information about the 
#				  patches as it attempts to apply them.
a140 12
# Variables that serve as convenient "aliases" for your *-install targets.
# Use these like: "${INSTALL_PROGRAM} ${WRKBUILD}/prog ${PREFIX}/bin".
#
# INSTALL_PROGRAM		- A command to install binary executables.
# INSTALL_SCRIPT		- A command to install executable scripts.
# INSTALL_DATA			- A command to install sharable data.
# INSTALL_MAN			- A command to install manpages (doesn't compress).
# INSTALL_PROGRAM_DIR	- Create a directory for storing programs
# INSTALL_SCRIPT_DIR	- Create a directory for storing scripts (alias for
#						  (INSTALL_PROGRAM_DIR)
# INSTALL_DATA_DIR		- Create a directory for storing arbitrary data
# INSTALL_MAN_DIR		- Create a directory for storing man pages
a158 6
# NO_SHARED_LIBS - defined as "Yes" for those machine architectures that do
#				  not support shared libraries.  WARNING: This value is
#				  NOT defined until AFTER ".include bsd.port.mk".  Thus
#				  you can NOT use something like ".if defined(NO_SHARED_LIBS)"
#				  before this file is included.
#
d706 1
a706 1
# ;;; This is referenced in a few Makefiles -- I'd like to get rid of it
@


1.339
log
@Kill USE_AUTOCONF, USE_IMAKE, NO_INSTALL_MANPAGES, HAS_CONFIGURE,
GNU_CONFIGURE.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.338 2000/10/02 07:53:24 espie Exp $$
d1230 1
a1230 1
	@@echo >&2 "*** Please notify the OpenBSD port maintainer <${MAINTAINER}>"
@


1.338
log
@Fed up with *idiots* that never read the documentation.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.337 2000/09/23 22:03:21 espie Exp $$
a60 6
# USE_AUTOCONF	- Port uses autoconf (implies GNU_CONFIGURE).
# USE_IMAKE		- Port uses imake.
# HAS_CONFIGURE	- Says that the port has its own configure script.
# GNU_CONFIGURE	- Set if you are using GNU configure (optional).
# NO_INSTALL_MANPAGES - For imake ports that don't like the install.man
#						target.
d220 2
a221 1
# CONFIGURE_ARGS - Pass these args to configure if ${HAS_CONFIGURE} is set.
d229 1
a229 1
#				  ${HAS_CONFIGURE} is set.
a495 1
# Convert legacy variables into new CONFIGURE_STYLE
a496 15
.if defined(USE_AUTOCONF)
CONFIGURE_STYLE+=autoconf
.endif
.if defined(HAS_CONFIGURE)
CONFIGURE_STYLE+=simple
.endif
.if defined(GNU_CONFIGURE)
CONFIGURE_STYLE+=gnu
.endif
.if defined(USE_IMAKE)
CONFIGURE_STYLE+=imake
.endif
.if defined(NO_INSTALL_MANPAGES)
CONFIGURE_STYLE+=noman
.endif
@


1.337
log
@Typo.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.336 2000/09/23 12:40:27 espie Exp $$
d1420 4
@


1.336
log
@Use CONFIGURE_ENV/CONFIGURE_ARGS for perl-style configure
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.335 2000/09/23 12:36:39 espie Exp $$
d637 1
a637 1
.if ${PATCH_CHECK_ONLY:L} != "yes"
@


1.335
log
@Don't change the semantics of the patch target if BATCH is defined,
this is stupid (BATCH is only there to skip IS_INTERACTIVE ports).

Make PATCH_CHECK_ONLY a Yes/No switch.
Let it be a slightly better no-op, e.g., skip creating the cookies
in checkpatch operation.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.334 2000/09/22 02:20:30 espie Exp $$
d1580 1
a1580 1
     cd ${WRKSRC}; ${SETENV} ${MAKE_ENV} \
d1590 1
a1590 1
		INSTALLSCRIPT='$${INSTALLBIN}'
@


1.334
log
@thinko
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.333 2000/09/19 14:14:52 mickey Exp $$
a634 4
.if defined(BATCH)
PATCH_ARGS+=		--batch
PATCH_DIST_ARGS+=	--batch
.endif
d636 2
a637 1
.if defined(PATCH_CHECK_ONLY)
d1461 1
d1463 1
d1501 1
d1503 1
a1503 1

d1554 2
a1555 1
.if !defined(PATCH_CHECK_ONLY) && ${CONFIGURE_STYLE:L:Mautoconf}
d1557 2
a1559 1
	@@${_MAKE_COOKIE} ${_PATCH_COOKIE}
@


1.333
log
@@@ the echo so we only the message
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.332 2000/09/17 16:26:57 espie Exp $$
d1483 1
a1483 1
	  	case "${PATCH_DEBUG}" in \
@


1.332
log
@INSTALL_MACROS does not need to be visible.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.331 2000/09/16 13:54:56 espie Exp $$
d42 1
a42 1
	echo "Need version ${NEED_VERSION} of bsd.port.mk"; \
@


1.331
log
@Clean PATCH_DEBUG handling
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.330 2000/09/13 14:06:55 espie Exp $$
d707 1
a707 1
INSTALL_MACROS=	BSD_INSTALL_PROGRAM="${INSTALL_PROGRAM}" \
d715 2
a716 2
MAKE_ENV+=	${INSTALL_MACROS}
SCRIPTS_ENV+=	${INSTALL_MACROS}
@


1.330
log
@Documentation clean-up: group deprecated variables, clarify
MAINTAINER comment. List bsd.port.mk(5) as the future source of
documentation.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.329 2000/09/13 13:49:51 espie Exp $$
d311 2
a312 2
# PATCH_DEBUG	- If set, print out more information about the patches as
#				  it attempts to apply them.
d626 3
a628 2
.if defined(PATCH_DEBUG)
PATCH_DEBUG_TMP=	Yes
a631 1
PATCH_DEBUG_TMP=	No
d1483 3
a1485 2
	  	case ${PATCH_DEBUG_TMP:L} in \
			yes) ${ECHO_MSG} "===>   Applying distribution patch $$i" ;; \
d1529 3
a1531 2
						case ${PATCH_DEBUG_TMP:L} in \
							yes) ${ECHO_MSG} "===>   Applying ${OPSYS} patch $$i" ;; \
@


1.329
log
@Fix dependency problem linked to make's POSIX rules.
Reported by Camiel, thanks.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.328 2000/09/12 02:52:01 marc Exp $$
a8 2
#
# Please view me with 4 column tabs!
d10 8
a17 6
# There are two different types of "maintainers" in the whole ports
# framework concept.  Maintainers of the bsd.port*.mk files
# are listed below in the ${OPSYS}_MAINTAINER entries (this file
# is used by multiple *BSD flavors).  You should consult them directly
# if you have any questions/suggestions regarding this file since only
# they are allowed to modify the master copies in the CVS repository!
d19 2
a20 6
# For each port, the MAINTAINER variable is what you should consult for
# contact information on the person(s) to contact if you have questions/
# suggestions about that specific port.  By default (if no MAINTAINER
# is listed), a port is maintained by the subscribers of the ports@@openbsd.org
# mailing list, and any correspondence should be directed there.  
#
a21 1
OpenBSD_MAINTAINER= ports-maintainers@@openbsd.org
d47 3
a49 1
# Supported Variables and their behaviors:
d57 22
d105 1
a105 1
#				  Defaults: ports@@openbsd.org
a207 10
# The following variables are deprecated:
# NO_CDROM		- Port may not go on CDROM.  Set this string to reason.
# USE_AUTOCONF	- Port uses autoconf (implies GNU_CONFIGURE).
# USE_IMAKE		- Port uses imake.
# HAS_CONFIGURE	- Says that the port has its own configure script.
# GNU_CONFIGURE	- Set if you are using GNU configure (optional).
# NO_INSTALL_MANPAGES - For imake ports that don't like the install.man
#						target.
#
#
a268 13
#
# Those variables are deprecated, use EXTRACT_CASES instead.
# EXTRACT_CMD	- Command for extracting archives (default: "gzip",
#				  "bzip2" if USE_BZIP2, "unzip" if USE_ZIP).
# EXTRACT_SUFX	- Suffix for archive files (default: ".tar.gz",
#				  ".tar.bz2" if USE_BZIP2, ".zip" if USE_ZIP).
# EXTRACT_BEFORE_ARGS 
#				- Arguments to ${EXTRACT_CMD} before filename
#				  (default: "-dc" for gzip or bzip2, "-q" for unzip)
# EXTRACT_AFTER_ARGS 
#				- Arguments to ${EXTRACT_CMD} following filename
#				  (default: "| ${TAR} -xf -", or "-d ${WKRDIR}" if USE_ZIP).
#
@


1.328
log
@distclean: don't puke when _DISTFILES and _PATCHFILES are empty
prob found by Jeremie Kass <jeremie@@umich.edu>
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.327 2000/09/11 18:06:24 espie Exp $$
d1701 1
a1701 1
	@@cd ${.CURDIR} && exec ${MAKE} run-depends lib-depends DEPENDS_TARGET=package
@


1.327
log
@Deprecate old EXTRACT_* variables.
Use some weird code to allow backward compatibility.
Rely on distfiles suffixes and a case statement (with matching variable
EXTRACT_CASES) to allow distinct extraction rules for multiple distfiles.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.326 2000/09/07 04:20:54 brad Exp $$
d2061 3
a2063 1
		rm -f ${_DISTFILES} ${_PATCHFILES}; \
@


1.326
log
@oops, fix cut and past-o. vax -> hppa
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.325 2000/09/07 04:14:44 brad Exp $$
d261 1
d273 1
a656 22
.if defined(USE_ZIP)
BUILD_DEPENDS+=		${UNZIP}::archivers/unzip
EXTRACT_CMD?=		${UNZIP}
EXTRACT_SUFX?=		.zip
EXTRACT_BEFORE_ARGS?=  -q
EXTRACT_AFTER_ARGS?=   -d ${WRKDIR}
.else
# common tar case

EXTRACT_AFTER_ARGS?=	| ${TAR} -xf -
EXTRACT_BEFORE_ARGS?=	-dc

.  if defined(USE_BZIP2)
BUILD_DEPENDS+=		${BZIP2}::archivers/bzip2
EXTRACT_CMD?=		${BZIP2}
EXTRACT_SUFX?=		.tar.bz2
.  else
EXTRACT_CMD?=		${GZIP_CMD}
EXTRACT_SUFX?=		.tar.gz
.  endif

.endif
d974 10
d1034 50
d1448 5
a1452 6
	@@PATH=${PORTPATH}; \
	for file in ${EXTRACT_ONLY}; do \
		if cd ${WRKDIR} && ${EXTRACT_CMD} ${EXTRACT_BEFORE_ARGS} ${FULLDISTDIR}/$$file ${EXTRACT_AFTER_ARGS}; then : ; \
		else\
			exit 1; \
		fi \
d2734 24
@


1.325
log
@enable shared libraries on powerpc
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.324 2000/09/05 17:27:45 espie Exp $$
d435 1
a435 1
.if (${MACHINE_ARCH} == "alpha") || (${MACHINE_ARCH} == "vax") || \
@


1.324
log
@Add SYSCONFDIR to SUBST_VARS.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.323 2000/09/03 16:00:49 espie Exp $$
d435 2
a436 3
#
.if (${MACHINE_ARCH} == "alpha") || (${MACHINE_ARCH} == "powerpc") || \
    (${MACHINE_ARCH} == "vax") || (${MACHINE_ARCH} == "hppa")
@


1.323
log
@Kill CDROM_COPY/CDROM_OPT. Nothing really needs them.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.322 2000/08/28 22:42:00 espie Exp $$
d781 1
a781 1
SUBST_VARS+=ARCH HOMEPAGE PREFIX
@


1.322
log
@current make passes flags through to submakes, no need to subvert
AM_MAKEFLAGS for this.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.321 2000/08/28 22:38:37 espie Exp $$
d982 1
a982 8
CDROM_SITE:=	/cdrom/distfiles/${DIST_SUBDIR}
.  if defined(FETCH_SYMLINK_DISTFILES)
CDROM_COPY:=	ln
CDROM_OPT=		-s
.  else
CDROM_COPY:=	cp
CDROM_OPT=		-f
.  endif
d998 1
a998 1
PKGNAME:=${PKGNAME}${_FEXT}
@


1.321
log
@make from current handles recursive variables just fine.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.320 2000/08/22 23:10:38 brad Exp $$
a611 3
.  if ${CONFIGURE_STYLE:L:Mgnu}
FAKE_FLAGS+=	AM_MAKEFLAGS='DESTDIR=${WRKINST}'
.  endif
@


1.320
log
@now that the ports tree is tracking -CURRENT, make use of ldconfig -U for
NEWDYNLIBDIR
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.319 2000/07/21 02:38:33 miod Exp $$
d2692 1
a2692 3
.  for _var in ${VARNAME}
	@@echo ${${_var}:Q}
.  endfor
d2694 1
@


1.319
log
@Make _CDROM_OVERRIDE work again
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.318 2000/07/19 22:36:32 naddy Exp $$
d910 1
a910 1
LDCONFIG_SED_SCRIPT?=${PORTSDIR}/infrastructure/install/ldconfig.sed
@


1.318
log
@fix "show" target to correctly display variables that contain
shell metacharacters; ok espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.317 2000/07/17 07:11:50 espie Exp $$
d997 1
a997 1
_CDROM_OVERRIDE=if ln -s ${CDROM_SITE}/$$f .; then exit 0; fi;
d999 1
a999 1
_CDROM_OVERRIDE=if cp -f ${CDROM_SITE}/$$f .; then exit 0; fi;
@


1.317
log
@Buglet: ensure PKGPATH is without a /.
This complicates bsd.port.subdir.mk slightly (needs to set _SEP),
but at least it's consistent.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.316 2000/07/14 23:07:25 espie Exp $$
d2693 1
a2693 1
	@@echo ${${_var}}
@


1.316
log
@DEPENDS lib:path -> lib::path   here as well.

(getting ready to drop back support for lib:path, so that we may do
lib:package:path support and similar fun things)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.315 2000/07/14 23:01:12 espie Exp $$
d710 1
a710 1
PKGPATH=${_CURDIR:S,${_PORTSDIR}/,,}/
@


1.315
log
@Change PORTSUBDIR/DIRPRFX to PKGPATH (avoid gratuitous naming
incompatibility with NetBSD).

This patch rearranges code so that PKGPATH is maintained
- when recursing into subdirs,
- when computing dependencies.

So that this reduces the number of `pwd` calls overall.
Should be especially noticeable for mirror-maker.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.314 2000/07/11 10:32:22 espie Exp $$
d80 2
a81 1
#				  going locally to each port). (default: ${PORTSDIR}/packages).
d234 1
a234 1
# FETCH_DEPENDS - A list of "path:dir" pairs of other ports this
d242 1
a242 1
# BUILD_DEPENDS - A list of "path:dir" pairs of other ports this
d247 1
a247 1
# RUN_DEPENDS	- A list of "path:dir" pairs of other ports this
d253 1
a253 1
# LIB_DEPENDS	- A list of "lib:dir" pairs of other ports this package
d525 1
a525 1
BUILD_DEPENDS+=		${GMAKE}:devel/gmake
d532 1
a532 1
BUILD_DEPENDS+=		${AUTOCONF}:devel/autoconf
d540 1
a540 1
BUILD_DEPENDS+=		${LIBTOOL}:devel/libtool
d545 1
a545 1
LIB_DEPENDS+=		Xm.:x11/lesstif
d660 1
a660 1
BUILD_DEPENDS+=		${UNZIP}:archivers/unzip
d672 1
a672 1
BUILD_DEPENDS+=		${BZIP2}:archivers/bzip2
@


1.314
log
@Make mtree invocation path explicit (rohee@@)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.313 2000/07/07 15:49:32 espie Exp $$
d399 1
a399 1
# obj			- pre-build ${WRKDIR} -> ${WRKOBJDIR}/${PORTSUBDIR} links
d706 4
a709 4
.if defined(WRKOBJDIR)
__canonical_PORTSDIR!=	cd ${PORTSDIR}; pwd -P
__canonical_CURDIR!=	cd ${.CURDIR}; pwd -P
PORTSUBDIR=		${__canonical_CURDIR:S,${__canonical_PORTSDIR}/,,}
d1406 2
a1407 2
	@@rm -rf ${WRKOBJDIR}/${PORTSUBDIR}${_FEXT}
	@@mkdir -p ${WRKOBJDIR}/${PORTSUBDIR}${_FEXT}
d1409 2
a1410 2
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${PORTSUBDIR}${_FEXT} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${PORTSUBDIR}${_FEXT}"; \
d1412 1
a1412 1
		ln -sf ${WRKOBJDIR}/${PORTSUBDIR}${_FEXT} ${WRKDIR}; \
d1928 2
a1929 2
	@@rm -rf ${WRKOBJDIR}/${PORTSUBDIR}${_FEXT}
	@@mkdir -p ${WRKOBJDIR}/${PORTSUBDIR}${_FEXT}
d1931 2
a1932 2
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${PORTSUBDIR}${_FEXT} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${PORTSUBDIR}${_FEXT}"; \
d1934 1
a1934 1
		ln -sf ${WRKOBJDIR}/${PORTSUBDIR}${_FEXT} ${WRKDIR}; \
d2054 1
a2054 1
		cd ${PORTSDIR} && cd $$dir && ${MAKE} fetch-list-recursive; \
d2133 1
a2133 1
	@@echo ":: "`${MAKE} package-name FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME}`
d2138 1
a2138 1
	@@name=`${MAKE} package-name FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME}`; \
d2184 1
a2184 3
.ifndef FULL_PACKAGE_NAME
FULL_PACKAGE_NAME=No
.endif 
d2195 1
a2195 1
	@@${_DEPEND_ECHO} `${MAKE} package-path`/${PKGNAME}
a2200 4
.if !target(package-path)
package-path:
	@@pwd | sed s@@`cd ${PORTSDIR} ; pwd`/@@@@g
.endif
d2261 1
a2261 1
			if cd $$dir && ${MAKE} ${_DEPEND_THRU} $$target; then \
d2294 1
a2294 1
			if cd $$dir && ${MAKE} ${_DEPEND_THRU} $$target; then \
d2323 1
a2323 1
			if cd $$dir && ${MAKE} ${_DEPEND_THRU} $$target; then \
d2351 1
a2351 1
		if cd $$dir && ${MAKE} ${_DEPEND_THRU} $$target; then \
d2384 1
a2384 1
			${MAKE} CLEANDEPENDS=No ${_DEPEND_THRU} clean clean-depends; \
d2550 1
a2550 1
			if ! ${MAKE} _DEPEND_ECHO="echo $$pname" package-name recurse-build-depends ${_DEPEND_THRU}; then  \
d2570 1
a2570 1
			if ! ${MAKE} recurse-build-depends ${_DEPEND_THRU}; then  \
d2590 1
a2590 1
			if ! ${MAKE} _DEPEND_ECHO="echo $$pname" package-name recurse-package-depends ${_DEPEND_THRU}; then  \
d2610 1
a2610 1
			if ! ${MAKE} recurse-package-depends ${_DEPEND_THRU}; then  \
d2638 1
a2638 1
PKGDEPTH!=${MAKE} package-path|sed -e 's|[^./][^/]*|..|g'
d2718 1
a2718 1
   package-noinstall package-path patch plist update-patches post-build \
@


1.313
log
@Remove work-around for pre 2.7 ftp/make bug with dates.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.312 2000/07/03 13:01:47 espie Exp $$
d1622 1
a1622 1
	@@${SUDO} mtree -U -e -d -n -p ${WRKINST} \
@


1.312
log
@Put shared libraries into a separate fragment.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.311 2000/06/30 21:48:50 espie Exp $$
d1835 1
a1835 3
# Bug-fix for make/ftp interaction in 2.6
	@@if [ -e ${_F} ]; then touch ${_F}; exit 0; fi; \
	mkdir -p ${_F:H}; \
@


1.311
log
@Fix up comment.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.310 2000/06/30 21:42:36 espie Exp $$
d2090 1
a2090 1
	perl ${PORTSDIR}/infrastructure/install/make-plist > ${PLIST}-auto
d2103 1
a2103 1
	perl ${PORTSDIR}/infrastructure/install/make-plist > ${PLIST}-auto
@


1.310
log
@Remove ldconfig mess from packing-lists, let a sed script generate the
right instructions from DYNLIBDIR(dir) or NEWDYNLIBDIR(dir)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.309 2000/06/28 15:06:26 espie Exp $$
d168 1
a168 1
#				  and perform the real install from the package (default: No)
@


1.309
log
@Remove kludge for PLIST.sed
All PLIST are substituted, and all PLIST.sed have been removed from
the tree.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.308 2000/06/20 16:51:23 espie Exp $$
d832 11
a842 3
	@@sed -e '/^%%!SHARED%%$$/d' \
		-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' -e '//d' <$? \
		${SED_PLIST} >$@@.tmp && mv -f $@@.tmp $@@
d909 1
@


1.308
log
@Since we are generating the PLIST, add the full package name as a comment,
may be useful later.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.307 2000/06/18 23:35:02 turan Exp $$
a790 6

# compatibility kludge
.if !defined(PLIST) && exists(${PKGDIR}/PLIST.sed${SUBPACKAGE})
PLIST=${PKGDIR}/PLIST.sed${SUBPACKAGE}
_SED_SUBST+=-e 's/@@ARCH@@/${ARCH}/g' -e 's/@@FLAVORS@@/${_FEXT}/g'
.endif
@


1.307
log
@spelling errors in all-packages target.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.306 2000/06/18 23:27:03 espie Exp $$
d842 1
@


1.306
log
@Fix DESCR/INSTALL/DEINSTALL names for old-style ports.
Based on something that looked remotely like a bug-report by
Michael H. Price II (no details at all, except `lsof is broken')
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.305 2000/06/16 23:53:40 espie Exp $$
d1856 1
a1856 1
all-package: ${PKGFILE}
@


1.305
log
@Create all packing information under a subdir of WRKDIR (WRKPKG).
WRKPKG should seldom be changed, unless it conflicts with the port's
actual naming conventions (default is ${WRKBUILD}/pkg).

Substitute stuff in INSTALL/DEINSTALL script as well.
The only drawback is that those LOOK like shell variables, but are actually
simple sed substitution.
Preconise a style such as
prefix=${PREFIX}
(then use ${prefix}) to avoid confusion.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.304 2000/06/16 23:10:41 espie Exp $$
d2668 1
a2668 1
		cp ${WRKBUILD}/DESCR${SUBPACKAGE} ${PKG_DBDIR}/${PKGNAME}/+DESC; \
d2670 2
a2671 2
		if [ -f ${PKGDIR}/INSTALL ]; then \
			cp ${PKGDIR}/INSTALL ${PKG_DBDIR}/${PKGNAME}/+INSTALL; \
d2673 2
a2674 2
		if [ -f ${PKGDIR}/DEINSTALL ]; then \
			cp ${PKGDIR}/DEINSTALL ${PKG_DBDIR}/${PKGNAME}/+DEINSTALL; \
d2676 2
a2677 2
		if [ -f ${PKGDIR}/REQ ]; then \
			cp ${PKGDIR}/REQ ${PKG_DBDIR}/${PKGNAME}/+REQ; \
d2679 2
a2680 2
		if [ -f ${WRKBUILD}/MESSAGE${SUBPACKAGE} ]; then \
			cp ${WRKBUILD}/MESSAGE${SUBPACKAGE} ${PKG_DBDIR}/${PKGNAME}/+DISPLAY; \
@


1.304
log
@Remove NO_EXTRACT/NO_PATCH/NO_CONFIGURE
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.303 2000/06/13 01:48:17 espie Exp $$
d108 3
d704 2
d832 1
a832 1
${WRKBUILD}/PLIST${SUBPACKAGE}.gen: ${PLIST}
d843 1
a843 5
${WRKBUILD}/DESCR${SUBPACKAGE}: ${DESCR}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@

.if defined(MESSAGE)
${WRKBUILD}/MESSAGE${SUBPACKAGE}: ${MESSAGE}
a844 1
.endif
d851 1
a851 1
_PKG_PREREQ= ${WRKBUILD}/PLIST${SUBPACKAGE}.gen ${WRKBUILD}/DESCR${SUBPACKAGE} ${COMMENT}
d854 2
a855 2
PKG_ARGS= -v -c '${COMMENT}' -d ${WRKBUILD}/DESCR${SUBPACKAGE}
PKG_ARGS+=-f ${WRKBUILD}/PLIST${SUBPACKAGE}.gen -p ${PREFIX} 
d858 4
a861 2
PKG_ARGS+=		-i ${PKGDIR}/INSTALL${SUBPACKAGE}
_PKG_PREREQ+=${PKGDIR}/INSTALL${SUBPACKAGE}
d864 4
a867 2
PKG_ARGS+=		-k ${PKGDIR}/DEINSTALL${SUBPACKAGE}
_PKG_PREREQ+=${PKGDIR}/DEINSTALL${SUBPACKAGE}
d870 4
a873 2
PKG_ARGS+=		-r ${PKGDIR}/REQ${SUBPACKAGE}
_PKG_PREREQ+=${PKGDIR}/REQ${SUBPACKAGE}
d876 4
a879 2
PKG_ARGS+=		-D ${WRKBUILD}/MESSAGE${SUBPACKAGE}
_PKG_PREREQ+=${WRKBUILD}/MESSAGE${SUBPACKAGE}
d1533 1
a1533 1
	@@mkdir -p ${WRKBUILD}
d1797 1
a1797 1
	@@duplicates=`sort <${WRKBUILD}/PLIST${SUBPACKAGE}.gen|uniq -d`; \
@


1.303
log
@NO_INSTALL_MANPAGES -> CONFIGURE_STYLE=imake noman
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.302 2000/06/12 02:09:22 espie Exp $$
a185 1
# NO_CONFIGURE	- Use a dummy (do-nothing) configure target.
a186 2
# NO_EXTRACT	- Use a dummy (do-nothing) extract target.
# NO_PATCH		- Use a dummy (do-nothing) patch target.
d1241 1
a1241 1
.  if ! (defined(NO_CHECKSUM) || defined(NO_EXTRACT))
d1347 1
a1347 1
.if !(defined(NO_CHECKSUM) || defined(NO_EXTRACT))
d1361 1
a1361 1
.if !(defined(NO_CHECKSUM) || defined(NO_EXTRACT))
a1384 1
.if !defined(NO_EXTRACT)
d1386 1
a1386 1
.  if target(pre-extract)
d1388 2
a1389 2
.  endif
.  if target(do-extract)
d1391 1
a1391 1
.  else
d1393 1
a1393 1
.    if defined(WRKOBJDIR)
d1402 1
a1402 1
.    else
d1405 1
a1405 1
.    endif
d1414 2
a1415 2
.  endif
.  if target(post-extract)
a1416 1
.  endif
a1417 1

d1435 1
a1435 2
.if !defined(NO_PATCH)
.  if target(pre-patch)
d1437 2
a1438 2
.  endif
.  if target(do-distpatch)
d1440 1
a1440 1
.  else
d1442 1
a1442 1
.    if defined(_PATCHFILES)
d1458 1
a1458 1
.    endif
d1460 2
a1461 2
.  endif
.  if target(post-distpatch)
a1462 1
.  endif
a1469 1
.if !defined(NO_PATCH)
d1471 1
a1471 1
.  if target(pre-patch)
d1473 2
a1474 2
.  endif
.  if target(do-patch)
d1476 1
a1476 1
.  else
d1479 1
a1479 1
.    if target(do-distpatch) || target(post-distpatch) || defined(PATCHFILES) 
d1481 1
a1481 1
.    endif 
d1511 2
a1512 2
.  endif
.  if target(post-patch)
a1513 1
.  endif
a1523 1
.if !defined(NO_CONFIGURE)
d1526 1
a1526 1
.  if target(pre-configure)
d1528 2
a1529 2
.  endif
.  if target(do-configure)
d1531 1
a1531 1
.  else
d1537 1
a1537 1
.    if ${CONFIGURE_STYLE:L:Mperl}
d1550 2
a1551 2
.    endif
.    if ${CONFIGURE_STYLE:L:Msimple} || ${CONFIGURE_STYLE:L:Mgnu}
d1560 3
a1562 3
.    endif
.    if ${CONFIGURE_STYLE:L:Mimake}
.      if exists(${X11BASE}/lib/X11/config/ports.cf)
d1564 1
a1564 1
.      else
a1568 1
.      endif
d1570 1
d1572 2
a1573 2
.  endif
.  if target(post-configure)
a1574 1
.  endif
@


1.302
log
@Set ac_given_INSTALL to the same value as INSTALL for gnu-configure
invocations. This works around a bug in autoconf-generated scripts that
is present up to autoconf 2.13.

In recursive configure, INSTALL is re-set from ac_given_INSTALL, to handle
relative paths correctly. However, sometimes ac_given_INSTALL hasn't been
set yet, and we end up with a `BSD compatible INSTALL' of ../
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.301 2000/06/10 17:21:33 espie Exp $$
d194 2
a199 2
# NO_INSTALL_MANPAGES - For imake ports that don't like the install.man
#						target.
d209 2
a210 1
#				  imake: port uses imake for configuration.
d517 3
d920 1
a920 1
.if ${CONFIGURE_STYLE:L:Mimake} && !defined(NO_INSTALL_MANPAGES)
@


1.301
log
@Handle CONFIGURE_STYLE=autoconf correctly
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.301 2000/06/10 17:15:06 espie Exp $$
d1562 1
@


1.300
log
@Forgot to handle legacy HAS_CONFIGURE

(+typo spotted by brad@@)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.299 2000/06/10 15:27:54 espie Exp $$
d1521 1
a1521 1
.if !defined(PATCH_CHECK_ONLY) && defined(USE_AUTOCONF)
@


1.299
log
@Extend CONFIGURE_STYLE to deal with GNU_CONFIGURE, HAS_CONFIGURE,
DESTDIR tweaks for fake, old-style gnu-configure (no sysconf), imake,
and autoconf...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.299 2000/06/09 20:59:46 espie Exp $$
d213 1
a213 1
#                 override with bison is port requires bison.
d506 3
@


1.298
log
@Missing SUDO in reinstall target for fake ports.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.297 2000/06/09 19:34:31 espie Exp $$
d190 5
a195 3
# XXX: cygnus products do NOT use autoconf for making its main 
#      configure from configure.in
# USE_AUTOCONF	- Port uses autoconf (implies GNU_CONFIGURE).
a196 1
# USE_IMAKE		- Port uses imake.
a199 2
# HAS_CONFIGURE	- Says that the port has its own configure script.
# GNU_CONFIGURE	- Set if you are using GNU configure (optional).
d204 7
d502 12
d522 2
a523 2
.if defined(USE_AUTOCONF)
GNU_CONFIGURE= Yes
d529 1
d604 1
a604 1
.  if defined(GNU_CONFIGURE)
d610 4
a613 1
MAKE_ENV+=		PATH=${PORTPATH} PREFIX=${PREFIX} LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} MOTIFLIB="${MOTIFLIB}" CFLAGS="${CFLAGS}"
d913 1
a913 1
.if defined(USE_IMAKE) && !defined(NO_INSTALL_MANPAGES)
a1050 1
CONFIGURE_STYLE?=
d1060 13
a1072 4
.if defined(GNU_CONFIGURE)
CONFIGURE_ARGS+=	--prefix=${PREFIX}
CONFIGURE_ARGS+=	--sysconfdir=${SYSCONFDIR}
HAS_CONFIGURE=		Yes
d1158 1
a1158 1
.  elif ((defined(USE_IMAKE) || defined(USE_X11)) && !exists(${X11BASE}))
d1541 1
a1541 1
.    if ${CONFIGURE_STYLE:L} == "perl"
d1555 1
a1555 1
.    if defined(HAS_CONFIGURE)
d1564 1
a1564 1
.    if defined(USE_IMAKE)
d1667 1
a1667 1
.if defined(USE_IMAKE)
d1687 1
a1687 1
.    if defined(USE_IMAKE)
@


1.297
log
@Add EXEC=exec indirection to mirror-maker,
so that broken OSes (slowlaris) can say 'make EXEC=/bin/ksh' and
use the target.
Thanks, Bob (beck@@)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.296 2000/06/09 18:37:31 espie Exp $$
d1951 1
a1951 1
	@@rm -f ${_INSTALL_PRE_COOKIE} ${_INSTALL_COOKIE} ${_PACKAGE_COOKIE}
@


1.296
log
@Document deprecated variables.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.295 2000/06/09 16:31:54 espie Exp $$
d2140 1
a2140 1
	@@echo '\t exec $${FETCH} "$$@@"'
@


1.295
log
@Tweak generated PLIST name, to avoid collisions with ports that brew
their own (compatibility hack, to remove once ports have been cleaned up).
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.294 2000/06/09 16:26:54 espie Exp $$
a171 2
# NO_CONFIGURE	- Use a dummy (do-nothing) configure target.
# NO_CDROM		- Port may not go on CDROM.  Set this string to reason.
a172 2
# NO_EXTRACT	- Use a dummy (do-nothing) extract target.
# NO_PATCH		- Use a dummy (do-nothing) patch target.
d184 6
@


1.294
log
@Generate PLIST, MESSAGE, DESCR from templates systematically.

- the PLIST, MESSAGE, DESCR variables refer to the sources.
- files are generated under ${WRKBUILD}, always.
- SUBST_VARS refer to the variables being substituted. ARCH,
  HOMEPAGE, PREFIX are always substituted.
  Use $\{VAR} to escape substitution.
Plus ${FLAVORS} -> -flavor1-flavor2  for PLIST.
- the %%FRAG%% and %%!FRAG%% notations are always used for PLIST.
- SED_PLIST can be augmented if needed.

Plus some compatibility kludges with the current situation.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.293 2000/06/09 16:18:42 espie Exp $$
d799 1
a799 1
${WRKBUILD}/PLIST${SUBPACKAGE}: ${PLIST}
d823 1
a823 1
_PKG_PREREQ= ${WRKBUILD}/PLIST${SUBPACKAGE} ${WRKBUILD}/DESCR${SUBPACKAGE} ${COMMENT}
d827 1
a827 1
PKG_ARGS+=-f ${WRKBUILD}/PLIST${SUBPACKAGE} -p ${PREFIX} 
d1761 1
a1761 1
	@@duplicates=`sort <${PLIST}|uniq -d`; \
@


1.293
log
@Support COMMENT=-string
(specifically, to allow all-in-one-Makefile stubs for all ports)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.292 2000/06/07 15:46:15 espie Exp $$
d724 1
d737 2
a747 1
SED_PLIST+=|sed -e 's/@@ARCH@@/${ARCH}/' -e 's/@@FLAVORS@@/${_FEXT}/'
d749 11
d761 2
a762 10
PLIST=${WRKBUILD}/PLIST${SUBPACKAGE}

${PLIST}: ${PKGDIR}/PLIST.sed${SUBPACKAGE}
.  if defined(NO_SHARED_LIBS)
	@@sed -e '/^%%SHARED%%$$/d' <$? \
		${SED_PLIST} >${PLIST}.tmp && mv -f ${PLIST}.tmp ${PLIST}
.  else
	@@sed -e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' -e '//d' <$? \
		${SED_PLIST} >${PLIST}.tmp && mv -f ${PLIST}.tmp ${PLIST}
.  endif
d765 1
d783 1
d791 5
d798 19
a816 1
_PKG_PREREQ=${PLIST} ${DESCR} ${COMMENT}
d822 3
d826 2
a827 2
PKG_ARGS= -v -c '${COMMENT}' -d ${DESCR}
PKG_ARGS+=-f ${PLIST} -p ${PREFIX} 
d841 3
a843 3
.  if exists(${PKGDIR}/MESSAGE${SUBPACKAGE})
PKG_ARGS+=		-D ${PKGDIR}/MESSAGE${SUBPACKAGE}
_PKG_PREREQ+=${PKGDIR}/MESSAGE${SUBPACKAGE}
d1711 2
a1712 2
.    if exists(${PKGDIR}/MESSAGE)
	@@cat	${PKGDIR}/MESSAGE
d2074 1
d2632 1
a2632 1
		cp ${DESCR} ${PKG_DBDIR}/${PKGNAME}/+DESC; \
d2643 2
a2644 2
		if [ -f ${PKGDIR}/MESSAGE ]; then \
			cp ${PKGDIR}/MESSAGE ${PKG_DBDIR}/${PKGNAME}/+DISPLAY; \
@


1.292
log
@Display `cleaning for' at the right point.
Somehow, this got swapped.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.291 2000/06/02 14:37:17 brad Exp $$
d793 1
a793 1
PKG_ARGS= -v -c ${COMMENT} -d ${DESCR}
d2347 8
a2354 5
	@@if [ -f ${COMMENT} ]; then \
		echo -n "`cat ${COMMENT}`|"; \
	else \
		echo -n "** No Description|"; \
	fi; \
@


1.291
log
@ports-admin@@ -> ports-maintainers@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.290 2000/06/02 11:42:53 espie Exp $$
d1947 1
a1948 1
	@@${ECHO_MSG} "===>  Cleaning for ${PKGNAME}"
@


1.290
log
@Add standard method for perl MakeMaker configuration
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.289 2000/06/01 17:33:53 espie Exp $$
d26 1
a26 1
OpenBSD_MAINTAINER= ports-admin@@openbsd.org
@


1.289
log
@- tighten regexps for PLIST_SED, to avoid accidental matching for fragments.

- repair clean-depends... it was broken quite a few months ago. I suspect
I'm the only one who uses this.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.288 2000/05/31 22:37:42 marc Exp $$
d199 5
d994 2
d1476 14
d1551 4
@


1.288
log
@use  with uninstall
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.287 2000/05/30 16:39:04 espie Exp $$
d733 1
a733 1
SED_PLIST+=|sed -e '/!%%${_i}%%/r${PKGDIR}/PFRAG.no-${_i}' -e '//d' -e '/%%${_i}%%/d'
d736 1
a736 1
SED_PLIST+=|sed -e '/!%%${_i}%%/d' -e '/%%${_i}%%/r${PKGDIR}/PFRAG.${_i}' -e '//d'
d747 1
a747 1
	@@sed -e '/%%SHARED%%/d' <$? \
d750 1
a750 1
	@@sed -e '/%%SHARED%%/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' -e '//d' <$? \
d2292 1
a2292 1
		if cd $$dir 2>/dev/null ; then \
@


1.287
log
@Let package cookie depend on package components (plist, descr, etc)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.286 2000/05/30 14:51:59 espie Exp $$
d1257 1
a1257 1
	@@${PKG_DELETE} -f ${PKGNAME}
@


1.286
log
@Turn
FAKE=Yes
on by default
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.285 2000/05/30 14:44:23 espie Exp $$
d781 2
d793 1
d797 1
d801 1
d805 1
d1681 1
a1681 1
${_PACKAGE_COOKIE}: ${_FAKE_COOKIE} ${_SUBPACKAGE_COOKIES} ${PLIST} 
d1683 1
a1683 1
${_PACKAGE_COOKIE}: ${_INSTALL_COOKIE} ${_SUBPACKAGE_COOKIES} ${PLIST}
d2557 1
a2557 2
fake-pkg: ${PLIST}
	@@if [ ! -f ${PLIST} -o ! -f ${COMMENT} -o ! -f ${DESCR} ]; then echo "** Missing package files for ${PKGNAME} - installation not recorded."; exit 1; fi
@


1.285
log
@Define WRKINST always.
Exchange WRKINST tests for FAKE tests, more logical.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.284 2000/05/29 16:43:35 espie Exp $$
d408 1
a408 1
FAKE?=No
@


1.284
log
@Add duplicates check to packing list
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.283 2000/05/22 13:43:55 espie Exp $$
a408 1
.if ${FAKE:U} == "YES"
a409 1
.endif
d524 1
a524 1
.if defined(WRKINST)
d1015 1
a1015 1
.if defined(WRKINST) && !defined(TRUEPREFIX)
a1915 1
.if defined(WRKINST)
a1916 1
.endif
@


1.283
log
@Add PLIST.sed substitution
!%%fragment%% -> PFRAG.no-fragment
Useful for no_X11-like flavors.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.282 2000/05/18 19:59:21 espie Exp $$
d1696 7
@


1.282
log
@Don't show `make plist' internals under fake, it works good enough that
we don't need to debug it.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.281 2000/05/17 12:41:28 espie Exp $$
d735 1
a735 1
SED_PLIST+=|sed -e '/%%${_i}%%/d'
d738 1
a738 1
SED_PLIST+=|sed -e '/%%${_i}%%/r${PKGDIR}/PFRAG.${_i}' -e '//d'
@


1.281
log
@Add REFETCH mechanism, effective once ftp.openbsd.org is populated with
checksum links.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.280 2000/05/17 12:14:53 espie Exp $$
d1980 1
a1980 1
	DESTDIR=${WRKINST} PREFIX=${WRKINST}${PREFIX} LDCONFIG="${LDCONFIG}" \
@


1.280
log
@Use exec to strip a large number of intermediate shells that don't serve
any useful purpose except for eating up PCB.

Not sure whether this is a ksh bug or not, but this is at least a fine
work-around.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.279 2000/05/17 00:22:39 espie Exp $$
d1155 5
d1165 1
a1165 1
	  cd ${DISTDIR}; OK=true; \
d1186 1
d1205 8
a1212 4
		  echo "Make sure the Makefile and checksum file (${CHECKSUM_FILE})"; \
		  echo "are up to date.  If you want to override this check, type"; \
		  echo "\"make NO_CHECKSUM=Yes [other args]\"."; \
		  exit 1; \
d1216 13
@


1.279
log
@pre-fake needs SUDO
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.278 2000/05/16 18:14:29 espie Exp $$
d1139 1
a1139 1
	@@cd ${.CURDIR} && ${MAKE} pre-fetch
d1142 1
a1142 1
	@@cd ${.CURDIR} && ${MAKE} do-fetch
d1146 1
a1146 1
	@@cd ${.CURDIR} && ${MAKE} ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
d1151 1
a1151 1
	@@cd ${.CURDIR} && ${MAKE} post-fetch
d1281 1
a1281 1
	@@cd ${.CURDIR} && ${MAKE} checksum build-depends lib-depends misc-depends
d1285 1
a1285 1
	@@cd ${.CURDIR} && ${MAKE} pre-extract
d1288 1
a1288 1
	@@cd ${.CURDIR} && ${MAKE} do-extract
d1314 1
a1314 1
	@@cd ${.CURDIR} && ${MAKE} post-extract
d1326 1
a1326 1
	@@cd ${.CURDIR} && ${MAKE} pre-patch
d1337 1
a1337 1
	@@cd ${.CURDIR} && ${MAKE} ${_PREPATCH_COOKIE}
d1340 1
a1340 1
	@@cd ${.CURDIR} && ${MAKE} do-distpatch
d1363 1
a1363 1
	@@cd ${.CURDIR} && ${MAKE} post-distpatch
d1375 1
a1375 1
	@@cd ${.CURDIR} && ${MAKE} ${_PREPATCH_COOKIE}
d1378 1
a1378 1
	@@cd ${.CURDIR} && ${MAKE} do-patch
d1383 1
a1383 1
	@@cd ${.CURDIR} && ${MAKE} distpatch
d1416 1
a1416 1
	@@cd ${.CURDIR} && ${MAKE} post-patch
d1420 1
a1420 1
	@@cd ${AUTOCONF_DIR} && ${SETENV} ${AUTOCONF_ENV} ${AUTOCONF}
d1432 1
a1432 1
	@@cd ${.CURDIR} && ${MAKE} pre-configure
d1435 1
a1435 1
	@@cd ${.CURDIR} && ${MAKE} do-configure
d1464 1
a1464 1
	@@cd ${.CURDIR} && ${MAKE} post-configure
d1476 1
a1476 1
	@@cd ${.CURDIR} && ${MAKE} pre-build
d1479 1
a1479 1
	@@cd ${.CURDIR} && ${MAKE} do-build
d1482 1
a1482 1
	@@cd ${WRKBUILD} && ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} ${ALL_TARGET}
d1486 1
a1486 1
	@@cd ${.CURDIR} && ${MAKE} post-build
d1504 1
a1504 1
	@@cd ${.CURDIR} && ${SUDO} ${MAKE} pre-fake ${_FAKE_SETUP}
d1508 1
a1508 1
	@@cd ${.CURDIR} && ${SUDO} ${MAKE} pre-install ${_FAKE_SETUP}
d1511 1
a1511 1
	@@cd ${.CURDIR} && ${SUDO} ${MAKE} do-install ${_FAKE_SETUP}
d1514 1
a1514 1
	@@cd ${WRKBUILD} && ${SUDO} ${SETENV} ${MAKE_ENV} ${_FAKE_SETUP} ${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
d1518 1
a1518 1
	@@cd ${.CURDIR} && ${SUDO} ${MAKE} post-install ${_FAKE_SETUP}
d1547 1
a1547 1
	@@cd ${.CURDIR} && ${MAKE} run-depends lib-depends DEPENDS_TARGET=package
d1566 1
a1566 1
	@@cd ${.CURDIR} && ${MAKE} run-depends lib-depends 
d1594 1
a1594 1
	@@cd ${.CURDIR} && ${MAKE} pre-install
d1597 1
a1597 1
	@@cd ${.CURDIR} && ${MAKE} do-install
d1604 1
a1604 1
	@@cd ${.CURDIR} && ${MAKE} post-install
d1630 1
a1630 1
	@@cd ${.CURDIR} && ${MAKE} fake-pkg
d1647 1
a1647 1
	@@cd ${.CURDIR} && ${MAKE} package SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1660 1
a1660 1
	@@cd ${.CURDIR} && ${MAKE} pre-package
d1663 1
a1663 1
	@@cd ${.CURDIR} && ${MAKE} do-package
d1683 1
a1683 1
	@@cd ${.CURDIR} && ${MAKE} post-package
d1696 1
a1696 1
	@@cd ${.CURDIR} && ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes fetch
d1725 1
a1725 1
	@@cd ${.CURDIR} && ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes fetch
d1731 1
a1731 1
	@@cd ${.CURDIR} && ${MAKE} ${.TARGET} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1743 1
a1743 1
	@@cd ${.CURDIR} && ${MAKE} ${.TARGET} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1755 1
a1755 1
	@@cd ${.CURDIR} && ${MAKE} ${.TARGET} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1762 1
a1762 1
	@@cd ${.CURDIR} && ${MAKE} package ALWAYS_PACKAGE=Yes 2>&1 | \
d1819 1
a1819 1
	@@cd ${.CURDIR} && ${MAKE} delete-package-links
d1838 1
a1838 1
	@@cd ${.CURDIR} && ${MAKE} delete-package-links
d1848 1
a1848 1
	@@cd ${.CURDIR} && ${MAKE} PATCH_CHECK_ONLY=Yes patch
d1858 1
a1858 1
	@@cd ${.CURDIR} && DEPENDS_TARGET=${DEPENDS_TARGET} ${MAKE} install
d1886 1
a1886 1
	@@cd ${.CURDIR} && ${MAKE} clean-depends
d1922 1
a1922 1
	@@cd ${.CURDIR} && ${MAKE} fetch-list-one-pkg 
d2005 1
a2005 1
	@@cd ${.CURDIR} && ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes _fetch-makefile-helper
d2093 1
a2093 1
	@@cd ${.CURDIR} && ${MAKE} PACKAGE_NOINSTALL=Yes ${_PACKAGE_COOKIE}
d2359 1
a2359 1
	@@cd ${.CURDIR} && ${MAKE} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' describe
d2505 1
a2505 1
	@@cd ${.CURDIR} && ${MAKE} README_NAME=${README_NAME} README.html
d2517 1
a2517 1
	@@cd ${.CURDIR} && ${MAKE} FULL_PACKAGE_NAME=Yes print-depends-list print-package-depends
@


1.278
log
@Use setenv -i, for predictability.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.277 2000/05/16 17:06:46 espie Exp $$
d1504 1
a1504 1
	@@cd ${.CURDIR} && ${MAKE} pre-fake ${_FAKE_SETUP}
@


1.277
log
@Support ${SUDO}
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.276 2000/05/16 15:54:17 espie Exp $$
d835 1
a835 1
SETENV?=	/usr/bin/env
@


1.276
log
@Switch back to ${MAKE}. Pointed out by Todd Miller.
${MAKE} is special, it's set by make itself, and should be relied upon
to be sure we reinvoke the same make we started out with.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.275 2000/05/16 15:13:28 espie Exp $$
d1500 2
a1501 2
	@@install -d -m 755 -o root -g wheel ${WRKINST}
	@@mtree -U -e -d -n -p ${WRKINST} \
d1506 1
a1506 1
	@@${_MAKE_COOKIE} ${_INSTALL_PRE_COOKIE}
d1508 1
a1508 1
	@@cd ${.CURDIR} && ${MAKE} pre-install ${_FAKE_SETUP}
d1511 1
a1511 1
	@@cd ${.CURDIR} && ${MAKE} do-install ${_FAKE_SETUP}
d1514 1
a1514 1
	@@cd ${WRKBUILD} && ${SETENV} ${MAKE_ENV} ${_FAKE_SETUP} ${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
d1518 1
a1518 1
	@@cd ${.CURDIR} && ${MAKE} post-install ${_FAKE_SETUP}
d1524 1
a1524 1
	@@${GUNZIP_CMD} ${manpage}.gz
d1532 2
a1533 2
		ln -sf $${1}.gz ${manpage}.gz; \
		rm ${manpage}; \
d1535 1
a1535 1
		${GZIP_CMD} ${manpage}; \
d1544 1
a1544 1
	@@${_MAKE_COOKIE} ${_FAKE_COOKIE}
d1551 1
a1551 1
	@@mkdir -p /usr/local/lib/X11
d1553 1
a1553 1
		ln -sf /var/X11/app-defaults /usr/local/lib/X11/app-defaults; \
d1556 2
a1557 2
	@@${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} pkg_add ${PKGFILE}
	@@${_MAKE_COOKIE} ${_INSTALL_COOKIE}
d1888 3
@


1.275
log
@Missed phony target
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.274 2000/05/16 14:40:28 espie Exp $$
d790 1
a790 1
PKG_ARGS+=-P "`cd ${.CURDIR} && make SUBPACKAGE='${SUBPACKAGE}' package-depends|${_SORT_DEPENDS}`"
d1139 1
a1139 1
	@@cd ${.CURDIR} && make pre-fetch
d1142 1
a1142 1
	@@cd ${.CURDIR} && make do-fetch
d1146 1
a1146 1
	@@cd ${.CURDIR} && make ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
d1151 1
a1151 1
	@@cd ${.CURDIR} && make post-fetch
d1281 1
a1281 1
	@@cd ${.CURDIR} && make checksum build-depends lib-depends misc-depends
d1285 1
a1285 1
	@@cd ${.CURDIR} && make pre-extract
d1288 1
a1288 1
	@@cd ${.CURDIR} && make do-extract
d1314 1
a1314 1
	@@cd ${.CURDIR} && make post-extract
d1326 1
a1326 1
	@@cd ${.CURDIR} && make pre-patch
d1337 1
a1337 1
	@@cd ${.CURDIR} && make ${_PREPATCH_COOKIE}
d1340 1
a1340 1
	@@cd ${.CURDIR} && make do-distpatch
d1363 1
a1363 1
	@@cd ${.CURDIR} && make post-distpatch
d1375 1
a1375 1
	@@cd ${.CURDIR} && make ${_PREPATCH_COOKIE}
d1378 1
a1378 1
	@@cd ${.CURDIR} && make do-patch
d1383 1
a1383 1
	@@cd ${.CURDIR} && make distpatch
d1416 1
a1416 1
	@@cd ${.CURDIR} && make post-patch
d1432 1
a1432 1
	@@cd ${.CURDIR} && make pre-configure
d1435 1
a1435 1
	@@cd ${.CURDIR} && make do-configure
d1464 1
a1464 1
	@@cd ${.CURDIR} && make post-configure
d1476 1
a1476 1
	@@cd ${.CURDIR} && make pre-build
d1479 1
a1479 1
	@@cd ${.CURDIR} && make do-build
d1486 1
a1486 1
	@@cd ${.CURDIR} && make post-build
d1504 1
a1504 1
	@@cd ${.CURDIR} && make pre-fake ${_FAKE_SETUP}
d1508 1
a1508 1
	@@cd ${.CURDIR} && make pre-install ${_FAKE_SETUP}
d1511 1
a1511 1
	@@cd ${.CURDIR} && make do-install ${_FAKE_SETUP}
d1518 1
a1518 1
	@@cd ${.CURDIR} && make post-install ${_FAKE_SETUP}
d1547 1
a1547 1
	@@cd ${.CURDIR} && make run-depends lib-depends DEPENDS_TARGET=package
d1566 1
a1566 1
	@@cd ${.CURDIR} && make run-depends lib-depends 
d1594 1
a1594 1
	@@cd ${.CURDIR} && make pre-install
d1597 1
a1597 1
	@@cd ${.CURDIR} && make do-install
d1604 1
a1604 1
	@@cd ${.CURDIR} && make post-install
d1630 1
a1630 1
	@@cd ${.CURDIR} && make fake-pkg
d1647 1
a1647 1
	@@cd ${.CURDIR} && make package SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1660 1
a1660 1
	@@cd ${.CURDIR} && make pre-package
d1663 1
a1663 1
	@@cd ${.CURDIR} && make do-package
d1675 1
a1675 1
	    make package-links; \
d1677 1
a1677 1
	    make delete-package; \
d1683 1
a1683 1
	@@cd ${.CURDIR} && make post-package
d1696 1
a1696 1
	@@cd ${.CURDIR} && make __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes fetch
d1725 1
a1725 1
	@@cd ${.CURDIR} && make __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes fetch
d1731 1
a1731 1
	@@cd ${.CURDIR} && make ${.TARGET} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1743 1
a1743 1
	@@cd ${.CURDIR} && make ${.TARGET} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1755 1
a1755 1
	@@cd ${.CURDIR} && make ${.TARGET} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1762 1
a1762 1
	@@cd ${.CURDIR} && make package ALWAYS_PACKAGE=Yes 2>&1 | \
d1819 1
a1819 1
	@@cd ${.CURDIR} && make delete-package-links
d1838 1
a1838 1
	@@cd ${.CURDIR} && make delete-package-links
d1848 1
a1848 1
	@@cd ${.CURDIR} && make PATCH_CHECK_ONLY=Yes patch
d1858 1
a1858 1
	@@cd ${.CURDIR} && DEPENDS_TARGET=${DEPENDS_TARGET} make install
d1886 1
a1886 1
	@@cd ${.CURDIR} && make clean-depends
d1914 1
a1914 1
	@@cd ${.CURDIR} && make fetch-list-recursive RECURSIVE_FETCH_LIST=${RECURSIVE_FETCH_LIST} | sort -u
d1919 1
a1919 1
	@@cd ${.CURDIR} && make fetch-list-one-pkg 
d1923 1
a1923 1
		cd ${PORTSDIR} && cd $$dir && make fetch-list-recursive; \
d2001 2
a2002 2
	@@echo ":: "`make package-name FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME}`
	@@cd ${.CURDIR} && make __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes _fetch-makefile-helper
d2006 1
a2006 1
	@@name=`make package-name FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME}`; \
d2009 1
a2009 1
	  echo "$${name}:: "`make depends-list package-depends FULL_PACKAGE_NAME=Yes |${_SORT_DEPENDS}`;; \
d2065 1
a2065 1
	@@${_DEPEND_ECHO} `make package-path`/${PKGNAME}
d2090 1
a2090 1
	@@cd ${.CURDIR} && make PACKAGE_NOINSTALL=Yes ${_PACKAGE_COOKIE}
d2135 1
a2135 1
			if cd $$dir && make ${_DEPEND_THRU} $$target; then \
d2168 1
a2168 1
			if cd $$dir && make ${_DEPEND_THRU} $$target; then \
d2197 1
a2197 1
			if cd $$dir && make ${_DEPEND_THRU} $$target; then \
d2225 1
a2225 1
		if cd $$dir && make ${_DEPEND_THRU} $$target; then \
d2258 1
a2258 1
			make CLEANDEPENDS=No ${_DEPEND_THRU} clean clean-depends; \
d2299 1
a2299 1
	@@cd ${.CURDIR} && echo -n `make depends-list|${_SORT_DEPENDS}`
d2303 1
a2303 1
	@@cd ${.CURDIR} && echo -n `make package-depends|${_SORT_DEPENDS}`
d2356 1
a2356 1
	@@cd ${.CURDIR} && make SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' describe
d2364 1
a2364 1
	@@cd ${.CURDIR} && make depends-list FULL_PACKAGE_NAME=Yes | ${_SORT_DEPENDS}>$@@.tmp1
d2367 1
a2367 1
	@@cd ${.CURDIR} && make package-depends FULL_PACKAGE_NAME=Yes | ${_SORT_DEPENDS} >$@@.tmp2
d2385 1
a2385 1
		sed -e 's|%%PORT%%|'"`make package-path | ${HTMLIFY}`"'|g' \
d2399 1
a2399 1
	@@echo -n `cd ${.CURDIR} && make ${_DEPEND_THRU} depends-list | ${_SORT_DEPENDS}`
d2408 1
a2408 1
	@@echo -n `cd ${.CURDIR} && make ${_DEPEND_THRU} package-depends | ${_SORT_DEPENDS}`
d2417 1
a2417 1
	@@pname=`cd ${.CURDIR} && make _DEPEND_ECHO='echo -n' package-name ${_DEPEND_THRU}`; \
d2421 1
a2421 1
			if ! make _DEPEND_ECHO="echo $$pname" package-name recurse-build-depends ${_DEPEND_THRU}; then  \
d2431 1
a2431 1
	@@pname=`cd ${.CURDIR} && make _DEPEND_ECHO='echo -n' package-name`; echo $$pname $$pname
d2441 1
a2441 1
			if ! make recurse-build-depends ${_DEPEND_THRU}; then  \
d2457 1
a2457 1
	@@pname=`cd ${.CURDIR} && make _DEPEND_ECHO='echo -n' package-name ${_DEPEND_THRU}`; \
d2461 1
a2461 1
			if ! make _DEPEND_ECHO="echo $$pname" package-name recurse-package-depends ${_DEPEND_THRU}; then  \
d2471 1
a2471 1
	@@pname=`cd ${.CURDIR} && make _DEPEND_ECHO='echo -n' package-name`; echo $$pname $$pname
d2481 1
a2481 1
			if ! make recurse-package-depends ${_DEPEND_THRU}; then  \
d2502 1
a2502 1
	@@cd ${.CURDIR} && make README_NAME=${README_NAME} README.html
d2509 1
a2509 1
PKGDEPTH!=make package-path|sed -e 's|[^./][^/]*|..|g'
d2514 1
a2514 1
	@@cd ${.CURDIR} && make FULL_PACKAGE_NAME=Yes print-depends-list print-package-depends
d2550 1
a2550 1
		for dep in `cd ${.CURDIR} && make package-depends ECHO_MSG=true | ${_SORT_DEPENDS}`; do \
@


1.274
log
@Remove lots of extra shells in the mirror-maker Makefile.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.273 2000/04/22 19:20:12 espie Exp $$
d2590 1
a2590 1
   package-noinstall package-path patch plist post-build \
@


1.273
log
@Passing flavors along while computing dependencies is a bad idea,
use _DEPEND_THRU uniformously.

Note that this actually needs something very similar to what is used
in bsd.port.subdir.mk to work.

In particular `default' FLAVORs not being empty is probably a bad idea,
and won't work uniformously.

The right way to set a default flavor is probably to:
- not have empty as a valid flavor.
- do things in two steps:
FLAVOR?=default
.if empty(FLAVOR)
FLAVOR:=default
.endif

so that flavor always gets set correctly.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.272 2000/04/22 18:57:00 espie Exp $$
d2044 1
a2044 1
	@@echo '\t $${FETCH} "$$@@"'
@


1.273.2.1
log
@
bring cutoff infrastructure files into 2.7 branch
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.319 2000/07/21 02:38:33 miod Exp $$
d26 1
a26 1
OpenBSD_MAINTAINER= ports-maintainers@@openbsd.org
d80 1
a80 2
#				  going locally to each port). (default:
#				  ${PORTSDIR}/packages/${ARCH}).
a107 3
# WRKPKG		- Subdirectory of WRKBUILD where package information gets
#				  generated (default: ${WKRBUILD}/pkg, don't override unless
#				  it conflicts with existing stuff.
d165 1
a165 1
#				  and perform the real install from the package (default: Yes)
d172 2
d175 2
d189 2
a190 2
# The following variables are deprecated:
# NO_CDROM		- Port may not go on CDROM.  Set this string to reason.
d192 1
d194 3
a198 19
# NO_INSTALL_MANPAGES - For imake ports that don't like the install.man
#						target.
#
#
# AUTOCONF_DIR  - Where to apply autoconf (default: ${WRKSRC}).
# USE_X11		- Port uses X11.
#
# CONFIGURE_STYLE
#               - Set to value corresponding to some standard configuration
#				  perl: perl's MakeMaker Makefile.PL
#				  gnu [autoconf] [old] [dest]: gnu style configure (old: no
#				  sysconfdir), (dest: add DESTDIR, does not handle it),
#				  (autoconf: needed by port, implies gnu)
# 				XXX: cygnus products do NOT use autoconf for making the main 
#      			configure from configure.in
#				  imake [noman]: port uses imake for configuration.
#                 (noman: no man page installation)
#			      simple: port has its own configure script
#
d200 1
a200 1
#                 override with bison if port requires bison.
d219 1
a219 1
# FETCH_DEPENDS - A list of "path::dir" pairs of other ports this
d227 1
a227 1
# BUILD_DEPENDS - A list of "path::dir" pairs of other ports this
d232 1
a232 1
# RUN_DEPENDS	- A list of "path::dir" pairs of other ports this
d238 1
a238 1
# LIB_DEPENDS	- A list of "lib::dir" pairs of other ports this package
d385 1
a385 1
# obj			- pre-build ${WRKDIR} -> ${WRKOBJDIR}/${PKGPATH} links
d408 2
a409 1
FAKE?=Yes
d411 1
a490 18
# Convert legacy variables into new CONFIGURE_STYLE
CONFIGURE_STYLE?=
.if defined(USE_AUTOCONF)
CONFIGURE_STYLE+=autoconf
.endif
.if defined(HAS_CONFIGURE)
CONFIGURE_STYLE+=simple
.endif
.if defined(GNU_CONFIGURE)
CONFIGURE_STYLE+=gnu
.endif
.if defined(USE_IMAKE)
CONFIGURE_STYLE+=imake
.endif
.if defined(NO_INSTALL_MANPAGES)
CONFIGURE_STYLE+=noman
.endif

d494 1
a494 1
BUILD_DEPENDS+=		${GMAKE}::devel/gmake
d499 3
a501 3
.if ${CONFIGURE_STYLE:L:Mautoconf}
CONFIGURE_STYLE+=gnu
BUILD_DEPENDS+=		${AUTOCONF}::devel/autoconf
a505 1

d508 1
a508 1
BUILD_DEPENDS+=		${LIBTOOL}::devel/libtool
d513 1
a513 1
LIB_DEPENDS+=		Xm.::x11/lesstif
d526 1
a526 1
.if ${FAKE:U} == "YES"
d580 1
a580 1
.  if ${CONFIGURE_STYLE:L:Mgnu}
d586 1
a586 4
MAKE_ENV+=		PATH='${PORTPATH}' PREFIX='${PREFIX}' \
	LOCALBASE='${LOCALBASE}' X11BASE=${X11BASE} \
	MOTIFLIB='${MOTIFLIB}' CFLAGS='${CFLAGS}' \
	TRUEPREFIX='${PREFIX}' DESTDIR=''
d625 1
a625 1
BUILD_DEPENDS+=		${UNZIP}::archivers/unzip
d637 1
a637 1
BUILD_DEPENDS+=		${BZIP2}::archivers/bzip2
d670 4
a673 6
WRKPKG?=		${WRKBUILD}/pkg

.if !defined(PKGPATH)
_PORTSDIR!=	cd ${PORTSDIR} && pwd -P
_CURDIR!=	cd ${.CURDIR} && pwd -P
PKGPATH=${_CURDIR:S,${_PORTSDIR}/,,}
a720 1
# Build _FEXT, checking that no flavors are misspelled
a732 2
# Create the basic sed substitution pipeline for fragments
# (applies only to PLIST for now)
d735 1
a735 1
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/r${PKGDIR}/PFRAG.no-${_i}' -e '//d' -e '/^%%${_i}%%$$/d'
d738 1
a738 1
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/d' -e '/^%%${_i}%%$$/r${PKGDIR}/PFRAG.${_i}' -e '//d'
d742 4
d747 9
a755 9
# Create the generic variable substitution list, from subst vars
SUBST_VARS+=ARCH HOMEPAGE PREFIX
_SED_SUBST=sed
.for _v in ${SUBST_VARS}
_SED_SUBST+=-e 's,$${${_v}},${${_v}},g'
.endfor
_SED_SUBST+=-e 's,$${FLAVORS},${_FEXT},g' -e 's,$$\\,$$,g'
# and append it to the PLIST substitution pipeline
SED_PLIST+=|${_SED_SUBST}
a756 1
# find out the most appropriate PLIST  source
a773 1
# Likewise for DESCR/MESSAGE/COMMENT
a780 5

.if exists(${PKGDIR}/MESSAGE${SUBPACKAGE})
MESSAGE?= ${PKGDIR}/MESSAGE${SUBPACKAGE}
.endif

a782 24
# And create the actual files from sources
${WRKPKG}/PLIST${SUBPACKAGE}: ${PLIST}
.  if defined(NO_SHARED_LIBS)
	@@sed -e '/^%%!SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
		-e '//d' -e '/^%%SHARED%%$$/d' <$? \
		${SED_PLIST} >$@@.tmp && mv -f $@@.tmp $@@
.  else
	@@if [ -x /sbin/ldconfig ]; then \
		sed -e '/^%%!SHARED%%$$/d' \
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
			-e '//d' <$? ${SED_PLIST} \
			| sed -f ${LDCONFIG_SED_SCRIPT} >$@@.tmp && mv -f $@@.tmp $@@; \
	else \
		sed -e '/^%%!SHARED%%$$/d' \
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
			-e '//d' <$? \
			${SED_PLIST} >$@@.tmp && mv -f $@@.tmp $@@; \
	fi
.  endif
	@@echo "@@comment name="`cd ${.CURDIR} && exec make package-name FULL_PACKAGE_NAME=Yes` >>$@@

${WRKPKG}/DESCR${SUBPACKAGE}: ${DESCR}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@

a786 3
# Fill out package command, and package dependencies
_PKG_PREREQ= ${WRKPKG}/PLIST${SUBPACKAGE} ${WRKPKG}/DESCR${SUBPACKAGE} ${COMMENT}
# Note that if you override PKG_ARGS, you will not get correct dependencies
d788 3
a790 3
PKG_ARGS= -v -c '${COMMENT}' -d ${WRKPKG}/DESCR${SUBPACKAGE}
PKG_ARGS+=-f ${WRKPKG}/PLIST${SUBPACKAGE} -p ${PREFIX} 
PKG_ARGS+=-P "`cd ${.CURDIR} && ${MAKE} SUBPACKAGE='${SUBPACKAGE}' package-depends|${_SORT_DEPENDS}`"
d792 1
a792 4
PKG_ARGS+=		-i ${WRKPKG}/INSTALL${SUBPACKAGE}
_PKG_PREREQ+=${WRKPKG}/INSTALL${SUBPACKAGE}
${WRKPKG}/INSTALL${SUBPACKAGE}: ${PKGDIR}/INSTALL${SUBPACKAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
d795 1
a795 4
PKG_ARGS+=		-k ${WRKPKG}/DEINSTALL${SUBPACKAGE}
_PKG_PREREQ+=${WRKPKG}/DEINSTALL${SUBPACKAGE}
${WRKPKG}/DEINSTALL${SUBPACKAGE}: ${PKGDIR}/DEINSTALL${SUBPACKAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
d798 4
a801 10
PKG_ARGS+=		-r ${WRKPKG}/REQ${SUBPACKAGE}
_PKG_PREREQ+=${WRKPKG}/REQ${SUBPACKAGE}
${WRKPKG}/REQ${SUBPACKAGE}: ${PKGDIR}/REQ${SUBPACKAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
.  endif
.  if defined(MESSAGE)
PKG_ARGS+=		-D ${WRKPKG}/MESSAGE${SUBPACKAGE}
_PKG_PREREQ+=${WRKPKG}/MESSAGE${SUBPACKAGE}
${WRKPKG}/MESSAGE${SUBPACKAGE}: ${MESSAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
a827 1
LDCONFIG_SED_SCRIPT?=${PORTSDIR}/infrastructure/install/ldconfig.sed
d835 1
a835 1
SETENV?=	/usr/bin/env -i
d847 1
a847 1
.if ${CONFIGURE_STYLE:L:Mimake} && empty(CONFIGURE_STYLE:L:Mnoman)
d914 1
a914 1
_CDROM_OVERRIDE=if ln -s ${CDROM_SITE}/$$f .; then exit 0; fi
d916 1
a916 1
_CDROM_OVERRIDE=if cp -f ${CDROM_SITE}/$$f .; then exit 0; fi
a984 1

d993 4
a996 13
.if ${CONFIGURE_STYLE:L:Mgnu}
.  if ${CONFIGURE_STYLE:L:Mdest}
CONFIGURE_ARGS+=	--prefix='$${DESTDIR}${PREFIX}'
.  else
CONFIGURE_ARGS+=	--prefix='${PREFIX}'
.  endif
.  if empty(CONFIGURE_STYLE:L:Mold)
.    if ${CONFIGURE_STYLE:L:Mdest}
CONFIGURE_ARGS+=	--sysconfdir='$${DESTDIR}${SYSCONFDIR}'
.    else
CONFIGURE_ARGS+=	--sysconfdir='${SYSCONFDIR}'
.    endif
.  endif
d1017 1
a1017 1
.if ${FAKE:U} == "YES" && !defined(TRUEPREFIX)
d1082 1
a1082 1
.  elif (!empty(CONFIGURE_STYLE:L:Mimake) || defined(USE_X11)) && !exists(${X11BASE})
d1139 1
a1139 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-fetch
d1142 1
a1142 1
	@@cd ${.CURDIR} && exec ${MAKE} do-fetch
d1146 1
a1146 1
	@@cd ${.CURDIR} && exec ${MAKE} ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
d1151 1
a1151 1
	@@cd ${.CURDIR} && exec ${MAKE} post-fetch
a1154 5
# Set to true to try to retrieve older distfiles from ftp.openbsd.org if
# checksums no longer match.

REFETCH?=false

d1156 1
a1156 1
.  if ! defined(NO_CHECKSUM)
d1160 1
a1160 1
	  cd ${DISTDIR}; OK=true; list=''; \
a1180 1
				  list="$$list $$file $$cipher $$4"; \
d1199 4
a1202 8
		  if ${REFETCH}; then \
		  	cd ${.CURDIR} && ${MAKE} refetch PROBLEMS="$$list"; \
		  else \
			echo "Make sure the Makefile and checksum file (${CHECKSUM_FILE})"; \
			echo "are up to date.  If you want to override this check, type"; \
			echo "\"make NO_CHECKSUM=Yes [other args]\"."; \
			exit 1; \
		  fi; \
a1206 13
refetch:
	@@set -- ${PROBLEMS}; \
	 while [ $$# -gt 0 ]; do \
		file=$$1; \
		cipher=$$2; \
		value=$$3; \
		shift; shift; shift; \
		rm ${FULLDISTDIR}/$$file; \
		cd ${.CURDIR} && ${MAKE} ${FULLDISTDIR}/$$file \
			MASTER_SITE_OVERRIDE="ftp://ftp.openbsd.org/pub/OpenBSD/distfiles/$$cipher/$$value/"; \
	done;
	cd ${.CURDIR} && exec ${MAKE} checksum REFETCH=false

d1230 1
a1230 1
	@@${SUDO} ${PKG_DELETE} -f ${PKGNAME}
d1244 1
a1244 1
.if !defined(NO_CHECKSUM) 
d1258 1
a1258 1
.if !defined(NO_CHECKSUM)
d1281 2
a1282 1
	@@cd ${.CURDIR} && exec ${MAKE} checksum build-depends lib-depends misc-depends
d1284 6
a1289 6
.if target(pre-extract)
	@@cd ${.CURDIR} && exec ${MAKE} pre-extract
.endif
.if target(do-extract)
	@@cd ${.CURDIR} && exec ${MAKE} do-extract
.else
d1291 3
a1293 3
.  if defined(WRKOBJDIR)
	@@rm -rf ${WRKOBJDIR}/${PKGPATH}${_FEXT}
	@@mkdir -p ${WRKOBJDIR}/${PKGPATH}${_FEXT}
d1295 2
a1296 2
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${PKGPATH}${_FEXT} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${PKGPATH}${_FEXT}"; \
d1298 1
a1298 1
		ln -sf ${WRKOBJDIR}/${PKGPATH}${_FEXT} ${WRKDIR}; \
d1300 1
a1300 1
.  else
d1303 1
a1303 1
.  endif
d1312 4
d1317 1
a1317 3
.if target(post-extract)
	@@cd ${.CURDIR} && exec ${MAKE} post-extract
.endif
d1326 1
a1326 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-patch
d1335 7
a1341 6
.if target(pre-patch)
	@@cd ${.CURDIR} && exec ${MAKE} ${_PREPATCH_COOKIE}
.endif
.if target(do-distpatch)
	@@cd ${.CURDIR} && exec ${MAKE} do-distpatch
.else
d1343 1
a1343 1
.  if defined(_PATCHFILES)
d1359 5
a1364 4
# End of DISTPATCH.
.endif
.if target(post-distpatch)
	@@cd ${.CURDIR} && exec ${MAKE} post-distpatch
d1372 1
d1374 6
a1379 6
.if target(pre-patch)
	@@cd ${.CURDIR} && exec ${MAKE} ${_PREPATCH_COOKIE}
.endif
.if target(do-patch)
	@@cd ${.CURDIR} && exec ${MAKE} do-patch
.else
d1382 3
a1384 3
.  if target(do-distpatch) || target(post-distpatch) || defined(PATCHFILES) 
	@@cd ${.CURDIR} && exec ${MAKE} distpatch
.  endif 
d1414 4
d1419 2
a1420 5
.if target(post-patch)
	@@cd ${.CURDIR} && exec ${MAKE} post-patch
.endif
.if !defined(PATCH_CHECK_ONLY) && ${CONFIGURE_STYLE:L:Mautoconf}
	@@cd ${AUTOCONF_DIR} && exec ${SETENV} ${AUTOCONF_ENV} ${AUTOCONF}
d1428 1
d1430 7
a1436 7
	@@mkdir -p ${WRKBUILD} ${WRKPKG}
.if target(pre-configure)
	@@cd ${.CURDIR} && exec ${MAKE} pre-configure
.endif
.if target(do-configure)
	@@cd ${.CURDIR} && exec ${MAKE} do-configure
.else
d1442 1
a1442 15
.  if ${CONFIGURE_STYLE:L:Mperl}
	@@arch=`/usr/bin/perl -e 'use Config; print $$Config{archname}, "\n";'`; \
     cd ${WRKSRC}; ${SETENV} ${MAKE_ENV} \
     /usr/bin/perl Makefile.PL \
     	PREFIX='$${DESTDIR}${PREFIX}' \
		INSTALLSITELIB='$${DESTDIR}${PREFIX}/libdata/perl5/site_perl' \
		INSTALLSITEARCH="\$${INSTALLSITELIB}/$$arch" \
		INSTALLPRIVLIB='$${DESTDIR}/usr/libdata/perl5' \
		INSTALLARCHLIB="\$${INSTALLPRIVLIB}/$$arch" \
		INSTALLMAN1DIR='$${DESTDIR}${PREFIX}/man/man1' \
		INSTALLMAN3DIR='$${DESTDIR}${PREFIX}/man/man3' \
		INSTALLBIN='$${PREFIX}/bin' \
		INSTALLSCRIPT='$${INSTALLBIN}'
.  endif
.  if ${CONFIGURE_STYLE:L:Msimple} || ${CONFIGURE_STYLE:L:Mgnu}
a1445 1
		ac_given_INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
d1450 3
a1452 3
.  endif
.  if ${CONFIGURE_STYLE:L:Mimake}
.    if exists(${X11BASE}/lib/X11/config/ports.cf)
d1454 1
a1454 1
.    else
d1459 1
d1461 4
a1465 4
# End of CONFIGURE.
.endif
.if target(post-configure)
	@@cd ${.CURDIR} && exec ${MAKE} post-configure
d1476 1
a1476 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-build
d1479 1
a1479 1
	@@cd ${.CURDIR} && exec ${MAKE} do-build
d1482 1
a1482 1
	@@cd ${WRKBUILD} && exec ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} ${ALL_TARGET}
d1486 1
a1486 1
	@@cd ${.CURDIR} && exec ${MAKE} post-build
d1500 2
a1501 2
	@@${SUDO} install -d -m 755 -o root -g wheel ${WRKINST}
	@@${SUDO} /usr/sbin/mtree -U -e -d -n -p ${WRKINST} \
a1502 4
.  if ${CONFIGURE_STYLE:L} == "perl"
	@@${SUDO} mkdir -p ${WRKINST}`/usr/bin/perl -e 'use Config; print $$Config{installarchlib}, "\n";'`
.  endif

d1504 1
a1504 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} pre-fake ${_FAKE_SETUP}
d1506 1
a1506 1
	@@${SUDO} ${_MAKE_COOKIE} ${_INSTALL_PRE_COOKIE}
d1508 1
a1508 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} pre-install ${_FAKE_SETUP}
d1511 1
a1511 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} do-install ${_FAKE_SETUP}
d1514 1
a1514 1
	@@cd ${WRKBUILD} && exec ${SUDO} ${SETENV} ${MAKE_ENV} ${_FAKE_SETUP} ${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
d1518 1
a1518 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} post-install ${_FAKE_SETUP}
d1524 1
a1524 1
	@@${SUDO} ${GUNZIP_CMD} ${manpage}.gz
d1532 2
a1533 2
		${SUDO} ln -sf $${1}.gz ${manpage}.gz; \
		${SUDO} rm ${manpage}; \
d1535 1
a1535 1
		${SUDO} ${GZIP_CMD} ${manpage}; \
d1544 1
a1544 1
	@@${SUDO} ${_MAKE_COOKIE} ${_FAKE_COOKIE}
d1547 1
a1547 1
	@@cd ${.CURDIR} && exec ${MAKE} run-depends lib-depends DEPENDS_TARGET=package
d1550 2
a1551 2
.if ${CONFIGURE_STYLE:Mimake}
	@@${SUDO} mkdir -p /usr/local/lib/X11
d1553 1
a1553 1
		${SUDO} ln -sf /var/X11/app-defaults /usr/local/lib/X11/app-defaults; \
d1556 2
a1557 2
	@@${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} pkg_add ${PKGFILE}
	@@${SUDO} ${_MAKE_COOKIE} ${_INSTALL_COOKIE}
d1566 1
a1566 1
	@@cd ${.CURDIR} && exec ${MAKE} run-depends lib-depends 
d1570 1
a1570 1
.    if ${CONFIGURE_STYLE:Mimake}
d1594 1
a1594 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-install
d1597 1
a1597 1
	@@cd ${.CURDIR} && exec ${MAKE} do-install
d1604 1
a1604 1
	@@cd ${.CURDIR} && exec ${MAKE} post-install
d1626 2
a1627 2
.    if defined(${MESSAGE})
	@@cat	${WRKBUILD}/MESSAGE${SUBPACKAGE}
d1630 1
a1630 1
	@@cd ${.CURDIR} && exec ${MAKE} fake-pkg
d1647 1
a1647 1
	@@cd ${.CURDIR} && exec ${MAKE} package SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1654 1
a1654 1
${_PACKAGE_COOKIE}: ${_FAKE_COOKIE} ${_SUBPACKAGE_COOKIES} ${_PKG_PREREQ}
d1656 1
a1656 1
${_PACKAGE_COOKIE}: ${_INSTALL_COOKIE} ${_SUBPACKAGE_COOKIES} ${_PKG_PREREQ}
d1660 1
a1660 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-package
d1663 1
a1663 1
	@@cd ${.CURDIR} && exec ${MAKE} do-package
a1672 7
# PLIST should normally hold no duplicates.
# This is left as a warning, because stuff such as @@exec %F/%D
# completion may cause legitimate dups.
	@@duplicates=`sort <${WRKPKG}/PLIST${SUBPACKAGE}|uniq -d`; \
	case "$${duplicates}" in "");; \
		*) echo "\n*** WARNING *** Duplicates in PLIST:\n$$duplicates\n";; \
	esac
d1675 1
a1675 1
	    ${MAKE} package-links; \
d1677 1
a1677 1
	    ${MAKE} delete-package; \
d1683 1
a1683 1
	@@cd ${.CURDIR} && exec ${MAKE} post-package
d1696 1
a1696 1
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes fetch
d1703 3
a1705 1
	@@mkdir -p ${_F:H}; \
d1725 1
a1725 1
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes fetch
d1728 1
a1728 1
all-packages: ${PKGFILE}
d1731 1
a1731 1
	@@cd ${.CURDIR} && exec ${MAKE} ${.TARGET} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1743 1
a1743 1
	@@cd ${.CURDIR} && exec ${MAKE} ${.TARGET} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1755 1
a1755 1
	@@cd ${.CURDIR} && exec ${MAKE} ${.TARGET} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}'
d1762 1
a1762 1
	@@cd ${.CURDIR} && exec ${MAKE} package ALWAYS_PACKAGE=Yes 2>&1 | \
d1798 2
a1799 2
	@@rm -rf ${WRKOBJDIR}/${PKGPATH}${_FEXT}
	@@mkdir -p ${WRKOBJDIR}/${PKGPATH}${_FEXT}
d1801 2
a1802 2
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${PKGPATH}${_FEXT} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${PKGPATH}${_FEXT}"; \
d1804 1
a1804 1
		ln -sf ${WRKOBJDIR}/${PKGPATH}${_FEXT} ${WRKDIR}; \
d1819 1
a1819 1
	@@cd ${.CURDIR} && exec ${MAKE} delete-package-links
d1838 1
a1838 1
	@@cd ${.CURDIR} && exec ${MAKE} delete-package-links
d1848 1
a1848 1
	@@cd ${.CURDIR} && exec ${MAKE} PATCH_CHECK_ONLY=Yes patch
d1857 2
a1858 2
	@@${SUDO} rm -f ${_INSTALL_PRE_COOKIE} ${_INSTALL_COOKIE} ${_PACKAGE_COOKIE}
	@@cd ${.CURDIR} && DEPENDS_TARGET=${DEPENDS_TARGET} exec ${MAKE} install
d1886 1
a1886 1
	@@cd ${.CURDIR} && exec ${MAKE} clean-depends
a1888 1
	@@if cd ${WRKINST} 2>/dev/null; then ${SUDO} rm -rf ${WRKINST}; fi
d1914 1
a1914 1
	@@cd ${.CURDIR} && ${MAKE} fetch-list-recursive RECURSIVE_FETCH_LIST=${RECURSIVE_FETCH_LIST} | sort -u
d1919 1
a1919 1
	@@cd ${.CURDIR} && exec ${MAKE} fetch-list-one-pkg 
d1923 1
a1923 1
		cd ${PORTSDIR} && cd $$dir && PKGPATH="$$dir" ${MAKE} fetch-list-recursive; \
d1954 1
a1954 1
	@@DESTDIR=${WRKINST} PREFIX=${WRKINST}${PREFIX} LDCONFIG="${LDCONFIG}" \
d1957 1
a1957 1
	perl ${PORTSDIR}/infrastructure/install/make-plist ${PLIST}
d1970 1
a1970 1
	perl ${PORTSDIR}/infrastructure/install/make-plist ${PLIST}
a1980 1

d2001 2
a2002 2
	@@echo ":: ${PKGPATH}/${PKGNAME}"
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes _fetch-makefile-helper
d2006 1
a2006 1
	@@name='${PKGPATH}/${PKGNAME}'; \
d2009 1
a2009 1
	  echo "$${name}:: "`${MAKE} depends-list package-depends FULL_PACKAGE_NAME=Yes |${_SORT_DEPENDS}`;; \
d2044 1
a2044 1
	@@echo '\t $${EXEC} $${FETCH} "$$@@"'
d2052 3
a2054 1
FULL_PACKAGE_NAME?=No
d2065 1
a2065 1
	@@${_DEPEND_ECHO} '${PKGPATH}/${PKGNAME}'
d2071 4
d2090 1
a2090 1
	@@cd ${.CURDIR} && exec ${MAKE} PACKAGE_NOINSTALL=Yes ${_PACKAGE_COOKIE}
d2135 1
a2135 1
			if cd $$dir && PKGPATH="$$dir" ${MAKE} ${_DEPEND_THRU} $$target; then \
d2168 1
a2168 1
			if cd $$dir && PKGPATH="$$dir" ${MAKE} ${_DEPEND_THRU} $$target; then \
d2197 1
a2197 1
			if cd $$dir && PKGPATH="$$dir" ${MAKE} ${_DEPEND_THRU} $$target; then \
d2225 1
a2225 1
		if cd $$dir && PKGPATH="$$dir" ${MAKE} ${_DEPEND_THRU} $$target; then \
d2257 2
a2258 2
		if cd ${PORTSDIR} && cd $$dir 2>/dev/null ; then \
			PKGPATH="$$dir" ${MAKE} CLEANDEPENDS=No ${_DEPEND_THRU} clean clean-depends; \
d2287 5
a2291 8
	@@case '${COMMENT}' in \
		-*) echo -n '${COMMENT:S/^-//}|';; \
		*)if [ -f '${COMMENT}' ]; then \
			echo -n "`cat ${COMMENT}`|"; \
		else \
			echo -n "** No Description|"; \
		fi;; \
	esac; \
d2299 1
a2299 1
	@@cd ${.CURDIR} && echo -n `${MAKE} depends-list|${_SORT_DEPENDS}`
d2303 1
a2303 1
	@@cd ${.CURDIR} && echo -n `${MAKE} package-depends|${_SORT_DEPENDS}`
d2356 1
a2356 1
	@@cd ${.CURDIR} && exec ${MAKE} SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' describe
d2364 1
a2364 1
	@@cd ${.CURDIR} && ${MAKE} depends-list FULL_PACKAGE_NAME=Yes | ${_SORT_DEPENDS}>$@@.tmp1
d2367 1
a2367 1
	@@cd ${.CURDIR} && ${MAKE} package-depends FULL_PACKAGE_NAME=Yes | ${_SORT_DEPENDS} >$@@.tmp2
d2385 1
a2385 1
		sed -e 's|%%PORT%%|'"`${MAKE} package-path | ${HTMLIFY}`"'|g' \
d2399 1
a2399 1
	@@echo -n `cd ${.CURDIR} && ${MAKE} ${_DEPEND_THRU} depends-list | ${_SORT_DEPENDS}`
d2408 1
a2408 1
	@@echo -n `cd ${.CURDIR} && ${MAKE} ${_DEPEND_THRU} package-depends | ${_SORT_DEPENDS}`
d2417 1
a2417 1
	@@pname=`cd ${.CURDIR} && ${MAKE} _DEPEND_ECHO='echo -n' package-name ${_DEPEND_THRU}`; \
d2421 1
a2421 1
			if ! PKGPATH="$$dir" ${MAKE} _DEPEND_ECHO="echo $$pname" package-name recurse-build-depends ${_DEPEND_THRU}; then  \
d2431 1
a2431 1
	@@pname=`cd ${.CURDIR} && ${MAKE} _DEPEND_ECHO='echo -n' package-name`; echo $$pname $$pname
d2441 1
a2441 1
			if ! PKGPATH="$$dir" ${MAKE} recurse-build-depends ${_DEPEND_THRU}; then  \
d2457 1
a2457 1
	@@pname=`cd ${.CURDIR} && ${MAKE} _DEPEND_ECHO='echo -n' package-name ${_DEPEND_THRU}`; \
d2461 1
a2461 1
			if ! PKGPATH="$$dir" ${MAKE} _DEPEND_ECHO="echo $$pname" package-name recurse-package-depends ${_DEPEND_THRU}; then  \
d2471 1
a2471 1
	@@pname=`cd ${.CURDIR} && ${MAKE} _DEPEND_ECHO='echo -n' package-name`; echo $$pname $$pname
d2481 1
a2481 1
			if ! PKGPATH="$$dir" ${MAKE} recurse-package-depends ${_DEPEND_THRU}; then  \
d2502 1
a2502 1
	@@cd ${.CURDIR} && exec ${MAKE} README_NAME=${README_NAME} README.html
d2509 1
a2509 1
PKGDEPTH!=echo ${PKGPATH}|sed -e 's|[^./][^/]*|..|g'
d2514 1
a2514 1
	@@cd ${.CURDIR} && exec ${MAKE} FULL_PACKAGE_NAME=Yes print-depends-list print-package-depends
d2522 2
a2523 1
fake-pkg: ${_PKG_PREREQ}
d2536 1
a2536 1
		cp ${WRKPKG}/DESCR${SUBPACKAGE} ${PKG_DBDIR}/${PKGNAME}/+DESC; \
d2538 2
a2539 2
		if [ -f ${WRKPKG}/INSTALL${SUBPACKAGE} ]; then \
			cp ${WRKPKG}/INSTALL${SUBPACKAGE} ${PKG_DBDIR}/${PKGNAME}/+INSTALL; \
d2541 2
a2542 2
		if [ -f ${WRKPKG}/DEINSTALL${SUBPACKAGE} ]; then \
			cp ${WRKPKG}/DEINSTALL${SUBPACKAGE} ${PKG_DBDIR}/${PKGNAME}/+DEINSTALL; \
d2544 2
a2545 2
		if [ -f ${WRKPKG}/REQ${SUBPACKAGE} ]; then \
			cp ${WRKPKG}}/REQ${SUBPACKAGE} ${PKG_DBDIR}/${PKGNAME}/+REQ; \
d2547 2
a2548 2
		if [ -f ${WRKPKG}/MESSAGE${SUBPACKAGE} ]; then \
			cp ${WRKPKG}/MESSAGE${SUBPACKAGE} ${PKG_DBDIR}/${PKGNAME}/+DISPLAY; \
d2550 1
a2550 1
		for dep in `cd ${.CURDIR} && ${MAKE} package-depends ECHO_MSG=true | ${_SORT_DEPENDS}`; do \
d2564 1
a2564 1
	@@echo ${${_var}:Q}
d2590 1
a2590 1
   package-noinstall patch plist update-patches post-build \
@


1.273.2.2
log
@
Hard code the makefile version from Aug 15.   The standard version
mechanism doesn't work with branches.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.273.2.1 2000/09/15 04:38:08 marc Exp $$
d39 2
a40 4
#_VERSION=${_VERSION_REVISION:C/\..*//}
#_REVISION=${_VERSION_REVISION:C/.*\.//}
_VERSION=1
_REVISION=319
d45 1
a45 1
(${_VERSION_NEEDED} == ${_VERSION} && ${_REVISION_NEEDED} > ${_REVISION})
d47 2
a48 3
echo "Need version ${NEED_VERSION} of bsd.port.mk"; \
echo "Have version ${_VERSION} . ${_REVISION}; \
exit 1;
@


1.272
log
@Dependency bugfix:
subpackage cookies ought to depend on {fake,install}_cookie as well.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.271 2000/04/19 14:37:19 espie Exp $$
d2056 1
a2056 1
# Make variables to pass along on recursive depends computations
d2135 1
a2135 1
			if cd $$dir && make $$target; then \
d2168 1
a2168 1
			if cd $$dir && make $$target; then \
d2197 1
a2197 1
			if cd $$dir && make $$target; then \
d2225 1
a2225 1
		if cd $$dir && make $$target; then \
d2258 1
a2258 1
			make CLEANDEPENDS=No clean clean-depends; \
@


1.271
log
@hook to call update-patches, and call your fave editor on the changed
patches.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.270 2000/04/18 23:20:49 espie Exp $$
d1642 5
a1646 1
${_PACKAGE_COOKIE}${_sub}: 
@


1.270
log
@MULTI_PACKAGES needs to be propagated to all-package, ftp-packages,
cdrom-packages as well.

Use _sub for loop variable name, to work around an obscure make bug.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.269 2000/04/18 20:13:48 espie Exp $$
d1969 8
@


1.269
log
@Missed SUBPACKAGE in PFRAG.shared
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.268 2000/04/18 17:35:09 espie Exp $$
d1725 5
d1737 5
d1749 5
d2343 2
a2344 2
.  for SUBPACKAGE in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && make SUBPACKAGE='${SUBPACKAGE}' FLAVOR='${FLAVOR}' describe
@


1.268
log
@Handle NO_DESCRIBE like NO_PACKAGE for MULTI_PACKAGES.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.267 2000/04/17 21:53:38 espie Exp $$
d752 1
a752 1
	@@sed -e '/%%SHARED%%/r${PKGDIR}/PFRAG.shared' -e '//d' <$? \
@


1.267
log
@Always define a FAKE_COOKIE, so that FAKE="No" will display an error message.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.266 2000/04/17 20:14:33 espie Exp $$
d2326 3
a2328 3

.  if defined(MULTI_PACKAGES) && empty(SUBPACKAGE)
.    for SUBPACKAGE in ${MULTI_PACKAGES}
d2330 2
a2331 2
.    endfor
.	endif	
a2332 1
.endif
@


1.266
log
@buglet fix: let the port+flavor directory show up in a form suitable
for direct SUBDIR reuse.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.265 2000/04/17 20:12:03 espie Exp $$
d533 1
@


1.265
log
@MULTI_PACKAGES framework.
This is somewhat orthogonal to FLAVORS.

Principle: one port may build several packages in one go.
For instance, egcs will build all compilers, and package stuff as
base, C++, Fortran, etc.

This simplifies some japanese ports greatly, e.g., one Canna port that
builds libs/server/app packages.

How to use:
just set
MULTI_PACKAGES=-ext1 -ext2...
in the Makefile.

Then make package will invoke itself recursively with SUBPACKAGE set to
-ext1, -ext2.

The SUBPACKAGE will fetch package info as PLIST-ext1, COMMENT-ext1,
DESCR-ext1, etc.

The port Makefile itself can test the value of SUBPACKAGE if things differ.

Some problems:
- there still is a main package (with PLIST, DESCR, etc), and it's built
last, so you can't add RUN_DEPENDS=main_package to subpackages, you have
to encode them explicitly in the PLIST for now.
- other ports can't depend on subpackages yet. This is usually not a
problem, it's just a question of choosing the `right' main package (e.g.,
for Canna, it will be canna-lib).
- PLIST.sed recognize @@FLAVOR@@, which is extended to the current flavor,
so that a subpackage may depend on the corresponding main package in
explicit ways.


describe is also invoked recursively, so that all subpackages appear in
the INDEX.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.264 2000/04/16 21:41:07 espie Exp $$
d2250 1
a2250 1
	@@echo -n "${PKGNAME}|${.CURDIR:S,^${PORTSDIR}/,,}:${FLAVOR}|"
@


1.264
log
@Common definitions into _FAKE_SETUP to shorten and simplify fake target.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.263 2000/04/16 20:59:22 espie Exp $$
d520 2
d526 1
a527 1
.if defined(WRKINST)
d538 1
a538 1
_PACKAGE_COOKIE=	${WRKBUILD}/.package_done
d543 1
a543 1
_PACKAGE_COOKIE=	${WRKDIR}/.package_done
d545 1
d548 1
a548 1
${_DISTPATCH_COOKIE} ${_PREPATCH_COOKIE} ${_FAKE_COOKIE}
d741 1
a741 1
SED_PLIST+=|sed -e 's/@@ARCH@@/${ARCH}/'
d743 2
a744 2
.if !defined(PLIST) && exists(${PKGDIR}/PLIST.sed)
PLIST=${WRKBUILD}/PLIST
d746 1
a746 1
${PLIST}: ${PKGDIR}/PLIST.sed
d756 2
a757 2
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${_FEXT}.${ARCH})
PLIST=		${PKGDIR}/PLIST${_FEXT}.${ARCH}
d759 2
a760 2
.if !defined(PLIST) && defined(NO_SHARED_LIBS) && exists(${PKGDIR}/PLIST${_FEXT}.noshared)
PLIST=		${PKGDIR}/PLIST${_FEXT}.noshared
d762 2
a763 2
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${_FEXT})
PLIST=		${PKGDIR}/PLIST${_FEXT}
d765 2
a766 2
.if !defined(PLIST) && exists(${PKGDIR}/PLIST.${ARCH})
PLIST=		${PKGDIR}/PLIST.${ARCH}
d768 2
a769 2
.if !defined(PLIST) && defined(NO_SHARED_LIBS) && exists(${PKGDIR}/PLIST.noshared)
PLIST=		${PKGDIR}/PLIST.noshared
d771 1
a771 1
PLIST?=		${PKGDIR}/PLIST
d774 2
a775 2
.  if exists(${PKGDIR}/COMMENT${_FEXT})
COMMENT=${PKGDIR}/COMMENT${_FEXT}
d777 1
a777 1
COMMENT=	${PKGDIR}/COMMENT
d780 1
a780 1
DESCR?=		${PKGDIR}/DESCR
d787 5
a791 3
PKG_ARGS=		-v -c ${COMMENT} -d ${DESCR} -f ${PLIST} -p ${PREFIX} -P "`cd ${.CURDIR} && make package-depends|${_SORT_DEPENDS}`"
.  if exists(${PKGDIR}/INSTALL)
PKG_ARGS+=		-i ${PKGDIR}/INSTALL
d793 2
a794 2
.  if exists(${PKGDIR}/DEINSTALL)
PKG_ARGS+=		-k ${PKGDIR}/DEINSTALL
d796 2
a797 2
.  if exists(${PKGDIR}/REQ)
PKG_ARGS+=		-r ${PKGDIR}/REQ
d799 2
a800 2
.  if exists(${PKGDIR}/MESSAGE)
PKG_ARGS+=		-D ${PKGDIR}/MESSAGE
d923 1
a923 1
PKGNAME?=		${DISTNAME}
d1230 1
a1230 1
	@@rm -f ${_INSTALL_COOKIE} ${_PACKAGE_COOKIE}
d1555 1
a1555 1
	@@PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} pkg_add ${PKGFILE}
d1636 11
d1649 1
a1649 1
${_PACKAGE_COOKIE}: ${_FAKE_COOKIE} ${PLIST}
d1651 1
a1651 1
${_PACKAGE_COOKIE}: ${_INSTALL_COOKIE} ${PLIST}
d2029 1
a2029 1
_DEPEND_THRU=FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME} FLAVOR=''
d2324 6
@


1.263
log
@Add @@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.262 2000/04/15 18:46:08 espie Exp $$
d1485 1
d1498 1
a1498 1
	@@cd ${.CURDIR} && make pre-fake TRUEPREFIX=${PREFIX} PREFIX=${WRKINST}${PREFIX} DESTDIR=${WRKINST}
d1502 1
a1502 1
	@@cd ${.CURDIR} && make pre-install TRUEPREFIX=${PREFIX} PREFIX=${WRKINST}${PREFIX} DESTDIR=${WRKINST}
d1505 1
a1505 1
	@@cd ${.CURDIR} && make do-install TRUEPREFIX=${PREFIX} PREFIX=${WRKINST}${PREFIX} DESTDIR=${WRKINST}
d1508 1
a1508 1
	@@cd ${WRKBUILD} && ${SETENV} ${MAKE_ENV} PREFIX=${WRKINST}${PREFIX} DESTDIR=${WRKINST} ${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
d1512 1
a1512 1
	@@cd ${.CURDIR} && make post-install TRUEPREFIX=${PREFIX} PREFIX=${WRKINST}${PREFIX} DESTDIR=${WRKINST}
@


1.262
log
@Bug-fix: take ${_FEXT} into account for WRKOBJDIR.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.261 2000/04/10 01:11:36 espie Exp $$
d1549 1
a1549 1
	PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} pkg_add ${PKGFILE}
@


1.261
log
@Somewhat simpler {ftp/cdrom/all}-packages, depending on real files.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.260 2000/04/10 00:42:02 espie Exp $$
d1286 2
a1287 2
	@@rm -rf ${WRKOBJDIR}/${PORTSUBDIR}
	@@mkdir -p ${WRKOBJDIR}/${PORTSUBDIR}
d1289 2
a1290 2
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${PORTSUBDIR} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${PORTSUBDIR}"; \
d1292 1
a1292 1
		ln -sf ${WRKOBJDIR}/${PORTSUBDIR} ${WRKDIR}; \
d1761 2
a1762 2
	@@rm -rf ${WRKOBJDIR}/${PORTSUBDIR}
	@@mkdir -p ${WRKOBJDIR}/${PORTSUBDIR}
d1764 2
a1765 2
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${PORTSUBDIR} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${PORTSUBDIR}"; \
d1767 1
a1767 1
		ln -sf ${WRKOBJDIR}/${PORTSUBDIR} ${WRKDIR}; \
@


1.260
log
@ALWAYS_PACKAGE: if defined, let install depend on _PACKAGE_COOKIE as well.
Use this for the {all,cdrom,ftp}-packages targets instead of unreliable
DEPENDS_TARGET.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.259 2000/04/09 23:57:58 espie Exp $$
d460 2
a461 2
CDROM_PACKAGES?=	${PORTSDIR}/cdrom-packages
FTP_PACKAGES?=		${PORTSDIR}/ftp-packages
d1706 1
a1706 4
all-packages:
.if !exists(${PKGFILE})
	cd ${.CURDIR} && make package ALWAYS_PACKAGE=Yes
.endif
d1709 3
a1712 12
.if defined(PERMIT_PACKAGE_CDROM) && (${PERMIT_PACKAGE_CDROM:L} == "yes") && \
    !exists(${CDROM_PACKAGES}/${PKGNAME}${PKG_SUFX}})
	@@if [ ! -f ${PKGFILE} ]; then \
	   mkdir -p ${PORTSDIR}/logs ;\
	   cd ${.CURDIR} && make package ALWAYS_PACKAGE=Yes \
	      2>&1 | tee ${PORTSDIR}/logs/${PKGNAME}.log ;\
	fi
	@@if [ -f ${PKGFILE} ]; then \
	   mkdir -p ${CDROM_PACKAGES} ;\
	   rm -f ${CDROM_PACKAGES}/${PKGNAME}${PKG_SUFX} ;\
	   ln ${PKGFILE} ${CDROM_PACKAGES}/${PKGNAME}${PKG_SUFX} ;\
	fi
d1716 3
a1719 12
.if defined(PERMIT_PACKAGE_FTP) && (${PERMIT_PACKAGE_FTP:L} == "yes") && \
    !exists(${FTP_PACKAGES}/${PKGNAME}${PKG_SUFX}})
	@@if [ ! -f ${PKGFILE} ]; then \
	   mkdir -p ${PORTSDIR}/logs ;\
	   cd ${.CURDIR} && make package ALWAYS_PACKAGE=Yes \
	      2>&1 | tee  ${PORTSDIR}/logs/${PKGNAME}.log ;\
	fi
	@@if [ -f ${PKGFILE} ]; then \
	   mkdir -p ${FTP_PACKAGES} ;\
	   rm -f ${FTP_PACKAGES}/${PKGNAME}${PKG_SUFX} ;\
	   ln ${PKGFILE} ${FTP_PACKAGES}/${PKGNAME}${PKG_SUFX} ;\
	fi
d1721 18
@


1.259
log
@Typos
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.258 2000/04/09 15:24:13 espie Exp $$
d1213 3
d1217 1
a1705 2
packageinstall: package install

d1708 1
a1708 1
	cd ${.CURDIR} && make package DEPENDS_TARGET=packageinstall
d1717 1
a1717 1
	   cd ${.CURDIR} && make package DEPENDS_TARGET=packageinstall \
d1733 1
a1733 1
	   cd ${.CURDIR} && make package DEPENDS_TARGET=packageinstall \
d2541 1
a2541 1
   packageinstall cdrom-packages ftp-packages \
@


1.258
log
@Need to include Makefile.inc sooner.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.257 2000/04/09 15:05:52 espie Exp $$
d1712 1
a1712 1
    !exists(${CDROM_PACKAGES/${PKGNAME}${PKG_SUFX}})
d1728 1
a1728 1
    !exists(${FTP_PACKAGES/${PKGNAME}${PKG_SUFX}})
@


1.257
log
@Let fetch-all use the same magic invocation as mirror-distfiles
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.256 2000/04/09 12:04:13 turan Exp $$
d404 4
a419 3
.if exists(${.CURDIR}/../Makefile.inc)
.include "${.CURDIR}/../Makefile.inc"
.endif
@


1.256
log
@ftp-packages, cdrom-packages targets. These are the targets I use
to build packages and log them.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.255 2000/04/09 11:51:39 espie Exp $$
d1669 1
a1669 1
	@@cd ${.CURDIR} && make __FETCH_ALL=Yes fetch
@


1.255
log
@Fix MANPREFIX for FAKE, reported by Chris Turan.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.254 2000/04/09 11:34:01 espie Exp $$
d459 3
d1701 39
d2538 1
@


1.254
log
@Fix bug in IGNORE logic.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.253 2000/04/08 23:11:15 marc Exp $$
d1007 1
a1007 1
.if defined(WRKINST)
@


1.253
log
@
Change PACKAGES so the arch part of the name.  Allows nfs mounted
ports tree to be shared by hosts of different types.   Note: you
may want to do something like this to move any existing packages:
cd /usr/ports/packages
mkdir .tmp
mv * .tmp
mv .tmp sparc
patch approved by espie@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.252 2000/04/03 17:32:42 espie Exp $$
d1089 2
a1090 1
.  elif defined(COMES_WITH)
@


1.252
log
@Use flavor in WRKINST/WRKBUILD name.
Optimize space: if SEPARATE_BUILD contains `flavored',
one WRKSRC for all flavors is enough.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.251 2000/04/03 17:09:12 espie Exp $$
d456 1
a456 1
PACKAGES?=		${PORTSDIR}/packages
@


1.251
log
@Fix SED_PLIST behavior for flavors.
- test for NO_SHARED before reading PFRAG.shared
- pipe several sed together, otherwise keyword recognition won't work
in fragments.
- put PFRAG.shared replacement at front, so that further flavor will
use it.
- various typos...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.250 2000/04/02 18:35:41 espie Exp $$
d406 1
a406 1
WRKINST?=${WRKDIR}/fake-${ARCH}
d641 1
d645 3
d649 1
d657 1
a657 1
WRKBUILD?=		${WRKDIR}/build-${ARCH}
@


1.250
log
@Typo
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.249 2000/04/02 18:08:31 espie Exp $$
a704 2
SED_PLIST+=-e '/%%SHARED%%/r${PKGDIR}/PFRAG.shared' -e '//d'
SED_PLIST+=-e 's/@@ARCH@@/${ARCH}/'
d722 1
a722 1
SED_PLIST+=-e '/%%${_i}%%/d'
d725 1
a725 1
SED_PLIST+=-e '/%%${_i}%%/r${PKGDIR}/PFRAG.${FLAVOR}' -e '//d'
d729 1
d735 7
a741 1
	@@sed ${SED_PLIST} <$? >${PLIST}.tmp && mv -f ${PLIST}.tmp ${PLIST}
d743 1
@


1.249
log
@Force packages to always go the PKGREPOSITORY, creating it if needed.
Add PKGREPOSITORY to PKG_PATH before pkg_add.

Thanks to aaron, fries, and mickey.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.247 2000/04/02 16:42:27 espie Exp $$
d2186 1
a2186 1
	@@echo -n "|${PREFIX}"
@


1.248
log
@Typo
@
text
@a961 1
.if exists(${PACKAGES})
a962 3
.else
PKGFILE?=		${PKGNAME}${PKG_SUFX}
.endif
d1529 1
a1529 1
	pkg_add ${PKGFILE}
d1625 2
a1626 3
	@@if [ -d ${PACKAGES} ]; then \
	  if [ ! -d ${PKGREPOSITORY} ]; then \
	    if ! mkdir -p ${PKGREPOSITORY}; then \
d1629 1
a1629 2
		fi; \
	  fi; \
d1633 1
a1633 3
	    if [ -d ${PACKAGES} ]; then \
	      make package-links; \
	    fi; \
@


1.247
log
@Don't propagate DEPENDS_TARGET more than one level deep.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.246 2000/04/02 10:47:54 espie Exp $$
d2120 1
a2120 1
	@@{unset DEPENDS_TARGET || true; } ; \
@


1.246
log
@Try to detect people who are not running X-current and tell them about it.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.245 2000/04/01 15:49:06 espie Exp $$
d2012 1
a2012 1
	@@PATH=${PORTPATH}; \
d2057 2
a2058 1
	@@for i in ${LIB_DEPENDS:S,::,:,}; do \
d2087 2
a2088 1
	@@for i in ${LIB_DEPENDS:S,::,:,}; do \
d2120 2
a2121 1
	@@for dir in ${DEPENDS:S,::,:,}; do \
@


1.245
log
@Oops, make sure FLAVOR is always defined...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.244 2000/04/01 14:57:24 espie Exp $$
d1430 1
d1432 6
@


1.244
log
@Add :${FLAVOR} to directory if exists.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.243 2000/03/31 18:51:09 espie Exp $$
d708 2
d712 3
a714 3
.if defined(FLAVOR)
.  for _i in ${FLAVOR:L}
.    if empty(FLAVORS:L:M${_i})
d719 3
a721 4
.    endif
.  endfor
.endif
FLAVOR?=
@


1.243
log
@More uniform way to find PLIST, handles more flavors.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.242 2000/03/31 18:05:28 espie Exp $$
d2175 3
d2179 1
@


1.242
log
@Include guard to avoid getting bsd.own.mk twice.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.241 2000/03/29 16:34:45 espie Exp $$
d731 1
a731 1
.if exists(${PKGDIR}/PLIST.sed)
d736 16
a751 7

.elif exists(${PKGDIR}/PLIST.${ARCH})
PLIST?=		${PKGDIR}/PLIST.${ARCH}
.else
.  if defined(NO_SHARED_LIBS) && exists(${PKGDIR}/PLIST.noshared)
PLIST?=		${PKGDIR}/PLIST.noshared
.  else
a752 2
.  endif
.endif
@


1.241
log
@Depend on the `package' target of subpackages for installing fake packages.
This means that sub packages *won't* be installed, except as an effect of
pkg_add...

Helps finding problems with pkg_add.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.240 2000/03/29 15:59:50 espie Exp $$
d28 4
a31 1
.include <bsd.own.mk>
@


1.240
log
@Flavored ports
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.239 2000/03/28 09:27:03 espie Exp $$
d1506 1
a1506 1
	@@cd ${.CURDIR} && make run-depends lib-depends
@


1.239
log
@Don't record ${PREFIX} in index if it's equal to ${LOCALBASE}
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.238 2000/03/27 01:52:17 espie Exp $$
d639 1
a639 1
WRKDIR?=		${.CURDIR}/work.${MACHINE_ARCH}
d641 1
a641 1
WRKDIR?=		${.CURDIR}/work
d699 1
a699 1
# Support architecture dependent packing lists
d701 34
a734 3
COMMENT?=	${PKGDIR}/COMMENT
DESCR?=		${PKGDIR}/DESCR
.if exists(${PKGDIR}/PLIST.${ARCH})
d744 9
d893 1
d1948 1
a1948 1
_DEPEND_THRU=FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME} 
d2401 1
a2401 1
fake-pkg:
@


1.238
log
@Remove PORTSDIR from describe:, in portsubdir, and in descr.

(noticed by turan, quick and dirty implementation until I clean the
DIRPRFX mess)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.237 2000/03/26 21:23:20 espie Exp $$
d2124 7
a2130 3
	@@echo -n "${PKGNAME}|${.CURDIR:S,^${PORTSDIR}/,,}|"; \
	echo -n "${PREFIX}|"; \
	if [ -f ${COMMENT} ]; then \
@


1.237
log
@USE_X11 should mark ports that need X11, but don't say anything about
where they install.

E.g., DON'T TOUCH USE_X11 in existing ports for now, we'll see how we
go about them.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.236 2000/03/26 16:01:08 espie Exp $$
d2124 1
a2124 1
	@@echo -n "${PKGNAME}|${.CURDIR}|"; \
d2132 1
a2132 1
		echo -n "${DESCR}|"; \
@


1.236
log
@Missed PORTSDIR in fetch-list.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.235 2000/03/26 15:59:41 espie Exp $$
d25 1
d28 2
d191 1
a191 1
# USE_X11		- Port uses X11 and installs in ${X11BASE}
a635 1
.include <bsd.own.mk>
@


1.235
log
@Propagate RECURSIVE_FETCH_LIST in a less hackish way.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.234 2000/03/24 20:44:01 turan Exp $$
d1779 1
a1779 1
		cd $$dir; make fetch-list-recursive; \
@


1.234
log
@MTREE_FILE fix.  Some ports did not pass MTREE_FILE into make-plist.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.233 2000/03/21 21:23:54 espie Exp $$
a1765 4
# are we called from bsd.port.subdir.mk (i.e. do we scan all dirs anyways)? XXX
.ifdef(DIRPRFX)
RECURSIVE_FETCH_LIST?=	No
.else
a1766 1
.endif
@


1.233
log
@Crude check for broken links in fake install.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.232 2000/03/21 21:06:58 espie Exp $$
d1829 1
a1829 1
	@@DESTDIR=${PREFIX} PREFIX=${PREFIX} LDCONFIG="${LDCONFIG}" MTREE_FILE=${_MTREE_FILE} \
@


1.232
log
@No need to display MESSAGE at the end of fake install, for obvious
reasons...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.231 2000/03/19 16:46:18 espie Exp $$
d1456 4
@


1.231
log
@Remove references to ancient versions of LIB_DEPENDS.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.230 2000/03/19 16:11:41 espie Exp $$
a1454 3
.  endif
.  if exists(${PKGDIR}/MESSAGE)
	@@cat	${PKGDIR}/MESSAGE
@


1.230
log
@Strip :: -> : in dependencies.
(to provide for a seamless way to insert MORE in dependencies)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.229 2000/03/19 16:04:19 espie Exp $$
a235 6
#				  In older versions of this file, you need two backslashes
#				  in front of dots (.) to supress its special meaning (e.g.,
#				  use "foo\\.2\\.:utils/foo" to match "libfoo.2.*").
#				  No special backslashes are needed to escape regular
#				  expression metacharacters in OpenBSD, and the old backslash
#				  escapes are recognised for backwards compatibility.
@


1.229
log
@A few PORTSDIR I didn't remove...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.228 2000/03/19 01:52:46 espie Exp $$
d1962 1
a1962 1
	for i in ${${_DEP:U}_DEPENDS}; do \
d2006 1
a2006 1
	@@for i in ${LIB_DEPENDS}; do \
d2035 1
a2035 1
	@@for i in ${LIB_DEPENDS}; do \
d2067 1
a2067 1
	@@for dir in ${DEPENDS}; do \
d2093 2
a2094 2
_ALWAYS_DEP = ${LIB_DEPENDS:C/^[^:]*://:C/:.*//} \
	${DEPENDS:C/:.*//} 
d2098 2
a2099 2
_BUILD_DEP = ${FETCH_DEPENDS:C/^[^:]*://:C/:.*//} \
	${BUILD_DEPENDS:C/^[^:]*://:C/:.*//}
d2103 1
a2103 1
_RUN_DEP = ${RUN_DEPENDS:C/^[^:]*://:C/:.*//}
@


1.228
log
@app-defaults kludge needs to have a test around thanks to ln semantics.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.227 2000/03/18 17:01:34 espie Exp $$
d238 1
a238 1
#				  use "foo\\.2\\.:${PORTSDIR}/utils/foo" to match "libfoo.2.*").
d490 1
a490 1
BUILD_DEPENDS+=		${GMAKE}:${PORTSDIR}/devel/gmake
d497 1
a497 1
BUILD_DEPENDS+=		${AUTOCONF}:${PORTSDIR}/devel/autoconf
d504 1
a504 1
BUILD_DEPENDS+=		${LIBTOOL}:${PORTSDIR}/devel/libtool
d509 1
a509 1
LIB_DEPENDS+=		Xm.:${PORTSDIR}/x11/lesstif
d617 1
a617 1
BUILD_DEPENDS+=		${UNZIP}:${PORTSDIR}/archivers/unzip
d629 1
a629 1
BUILD_DEPENDS+=		${BZIP2}:${PORTSDIR}/archivers/bzip2
@


1.227
log
@Let X11 ports install under /usr/local
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.226 2000/03/10 18:09:23 espie Exp $$
d1473 3
a1475 1
	@@-ln -s /var/X11/app-defaults /usr/local/lib/X11/app-defaults
d1493 3
a1495 1
	@@-ln -s /var/X11/app-defaults /usr/local/lib/X11/app-defaults
@


1.226
log
@pre-fake target:
finish setting up WRKINST tree after mtree, but before making the
INSTALL_PRECOOKIE.

See /usr/ports/print/teTeX/base for sample use.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.225 2000/03/08 00:07:37 espie Exp $$
a484 3
.if defined(USE_IMAKE) || defined(USE_X11)
PREFIX?=		${X11BASE}
.else
a485 1
.endif
d549 1
d1470 5
d1488 5
d2099 1
a2099 1
_RUN_DEP = ${RUN_DEPENDS:C/^[^:]*://:C/:.*//} 
@


1.225
log
@Fix build-depends/recurse-build-depends to work with PORTSDIR removed.

(no, I'm not going back and adding NEED_VERSION everywhere...)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.224 2000/03/07 16:14:20 espie Exp $$
d355 4
d1428 3
@


1.224
log
@Pass TRUEPREFIX, PREFIX, DESTDIR  to pre-install, do-install, install targets
in FAKE mode, to simplify conversion.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.223 2000/03/05 16:40:52 espie Exp $$
d2244 1
a2244 1
		if cd $$dir 2>/dev/null; then \
d2264 1
a2264 1
		if cd ${PORTSTDIR} && cd $$dir 2>/dev/null; then \
@


1.223
log
@Switch to ${PORTSDIR} before evaluating any dependency.
Makes ${PORTSDIR} in dependencies redundant.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.222 2000/03/05 16:33:38 espie Exp $$
d1426 1
a1426 1
	@@cd ${.CURDIR} && make pre-install PREFIX=${WRKINST}${PREFIX}
d1429 1
a1429 1
	@@cd ${.CURDIR} && make do-install PREFIX=${WRKINST}${PREFIX}
d1436 1
a1436 1
	@@cd ${.CURDIR} && make post-install PREFIX=${WRKINST}${PREFIX}
@


1.222
log
@If DISTFILES + PATCHFILES = ALLFILES is empty, no fetch is needed...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.221 2000/03/05 16:00:30 espie Exp $$
d1945 1
d1989 1
d2018 1
d2050 1
d2264 1
a2264 1
		if cd $$dir 2>/dev/null; then \
d2284 1
a2284 1
		if cd $$dir 2>/dev/null; then \
d2304 1
a2304 1
		if cd $$dir 2>/dev/null; then \
@


1.221
log
@Document NO_PATCH. Indent stuff correctly.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.220 2000/03/04 18:16:02 espie Exp $$
d1078 1
d1080 1
d1852 2
a1853 1
.for _F in ${_ALLFILES}
d1856 1
a1856 1
.  if defined(DIST_SUBDIR)
d1858 1
a1858 1
.  endif
d1863 1
a1863 1
.  if !defined(NO_CHECKSUM) && !empty(_CKSUMFILES:M${_F})
d1883 1
a1883 1
.  endif
d1885 2
a1886 1
.endfor
@


1.220
log
@Add fetch-makefile to bsd.port.subdir.mk, mirror-maker to main Makefile.

Tweak fetch-makefile to take PERMIT_* into account, giving us the level
of control needed.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.219 2000/03/04 14:40:21 turan Exp $$
d170 1
d1066 1
a1066 1
.if !defined(PERMIT_PACKAGE_CDROM) || !defined(PERMIT_PACKAGE_FTP) || \
d1070 1
a1070 2
.endif

@


1.219
log
@remove trailing -n in make describe
pretty INDEX
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.218 2000/03/04 14:36:46 turan Exp $$
d1832 8
a1839 2
.if ${MIRROR_DISTFILE:L} == "yes"
	@@echo "all:: "`make package-name FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME}`
a1840 1
.endif
@


1.218
log
@remove trailing | in make describe
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.217 2000/03/04 08:35:47 turan Exp $$
d2162 1
a2162 1
	@@echo -n "y"
d2164 1
a2164 1
	@@echo -n "n"
d2167 1
a2167 1
	@@echo -n "?"
@


1.217
log
@Move the test for the existance of license info up into the beginning
of fetch instead of the end of extract.  It only makes sense to do the
check in extract if we are checking the file that contains the license.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.216 2000/03/03 21:24:51 espie Exp $$
d2162 1
a2162 1
	@@echo -n "y|"
d2164 1
a2164 1
	@@echo -n "n|"
d2167 1
a2167 1
	@@echo -n "?|"
@


1.216
log
@`Fake' infrastructure:
if a port sets FAKE=Yes, this means it can be `pre'-installed elsewhere,
with DESTDIR set to WRKINST (=work/fake-${ARCH} by default).

the infrastructure takes care of pre-install/do-install/post-install targets,
assuming those install stuff under PREFIX.

To help ports to cope with DESTDIR, you can set FAKE_FLAGS and FAKE_TARGET
(used for the fake installation).

Ports with FAKE=Yes are the way to go: they can be packaged directly without
a real installation, and the installation proceeds from the package, thus
forcing porters to check the package.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.215 2000/03/03 20:59:16 espie Exp $$
d1063 8
a1242 8
.endif

# You need to define LICENCE_TYPE and PERMIT_* to make the warning go away.
# See ports/infrastructure/templates/Makefile.template
.if !defined(PERMIT_PACKAGE_CDROM) || !defined(PERMIT_PACKAGE_FTP) || \
    !defined(PERMIT_DISTFILES_CDROM) || !defined(PERMIT_DISTFILES_FTP)
	@@echo >&2 "*** The licensing info for this port is incomplete."
	@@echo >&2 "*** Please notify the OpenBSD port maintainer <${MAINTAINER}>"
@


1.215
log
@Mtree changes:
- don't record mtree in packages by default,
- don't run mtree on /usr/local or /usr/X11R6 by default,
- only use MTREE_FILE for plist.
- choose mtree based on PREFIX, since this is what matters.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.214 2000/03/03 20:41:11 espie Exp $$
d102 2
d158 6
d348 7
d359 2
a362 1
# package		- Create a package from an _installed_ port.
d399 5
d519 8
a528 1
_INSTALL_PRE_COOKIE=${WRKBUILD}/.install_started
a533 1
_INSTALL_PRE_COOKIE=${WRKDIR}/.install_started
d540 1
a540 1
${_DISTPATCH_COOKIE} ${_PREPATCH_COOKIE}
d568 7
d734 4
d781 2
d950 4
d956 1
d1143 1
d1412 59
a1470 1
# The real install
d1472 1
d1475 1
a1475 1
.if !defined(NO_INSTALL)
d1477 1
a1477 1
.  if !defined(NO_PKG_REGISTER) && !defined(FORCE_PKG_REGISTER)
d1487 1
a1487 1
.  endif
d1494 1
a1494 1
.  if target(pre-install)
d1496 2
a1497 2
.  endif
.  if target(do-install)
d1499 1
a1499 1
.  else
d1503 2
a1504 2
.  endif
.  if target(post-install)
d1506 3
a1508 3
.  endif
.  if defined(_MANPAGES) || defined(_CATPAGES)
.    if defined(MANCOMPRESSED) && defined(NOMANCOMPRESS)
d1510 1
a1510 1
.      for manpage in ${_MANPAGES} ${_CATPAGES}
d1512 2
a1513 2
.      endfor
.    elif !defined(MANCOMPRESSED) && !defined(NOMANCOMPRESS)
d1515 1
a1515 1
.      for manpage in ${_MANPAGES} ${_CATPAGES}
d1524 2
a1525 1
.      endfor
d1527 1
a1527 2
.  endif
.  if exists(${PKGDIR}/MESSAGE)
d1529 2
a1530 2
.  endif
.  if !defined(NO_PKG_REGISTER)
d1532 1
a1533 1
.endif
d1536 2
d1539 5
a1543 1
${_PACKAGE_COOKIE}: ${_INSTALL_COOKIE}
d1552 6
a1557 17
	@@cd ${.CURDIR} && if [ -e ${PLIST} ]; then \
		${ECHO_MSG} "===>  Building package for ${PKGNAME}"; \
		if [ -d ${PACKAGES} ]; then \
			if [ ! -d ${PKGREPOSITORY} ]; then \
				if ! mkdir -p ${PKGREPOSITORY}; then \
					echo ">> Can't create directory ${PKGREPOSITORY}."; \
					exit 1; \
				fi; \
			fi; \
		fi; \
		if ${PKG_CMD} ${PKG_ARGS} ${PKGFILE}; then \
			if [ -d ${PACKAGES} ]; then \
				make package-links; \
			fi; \
		else \
			make delete-package; \
			exit 1; \
d1559 1
d1561 9
d1798 7
a1806 1
.if !defined(MTREE_FILE)
d1808 1
a1808 1
MTREE_FILE=	/etc/mtree/BSD.local.dist
d1810 1
a1810 1
MTREE_FILE=	/etc/mtree/BSD.x11.dist
d1812 1
a1812 1
.endif
d1814 1
a1814 1
	@@PREFIX=${PREFIX} LDCONFIG="${LDCONFIG}" MTREE_FILE=${MTREE_FILE} \
d1817 1
@


1.214
log
@.bak.orig looks nicer than bak.orig
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.213 2000/03/03 17:51:37 espie Exp $$
d150 2
a151 5
# NO_MTREE		- If set, will not invoke mtree from bsd.port.mk from
#				  the "install" target.
# MTREE_FILE	- The name of the mtree file (default: /etc/mtree/BSD.x11.dist
#				  if USE_IMAKE or USE_X11 is set, /etc/mtree/BSD.local.dist
#				  otherwise.)
a602 11
# Figure out where the local mtree file is
.if !defined(MTREE_FILE)
.  if defined(USE_IMAKE) || defined(USE_X11)
MTREE_FILE=	/etc/mtree/BSD.x11.dist
.  else
MTREE_FILE=	/etc/mtree/BSD.local.dist
.  endif
.endif
MTREE_CMD?=	/usr/sbin/mtree
MTREE_ARGS?=	-U -f ${MTREE_FILE} -d -e -q -p

a698 3
.  if !defined(NO_MTREE)
PKG_ARGS+=		-m ${MTREE_FILE}
.  endif
a1387 17
.  if !defined(NO_MTREE)
	@@if [ `id -u` = 0 ]; then \
		if [ ! -f ${MTREE_FILE} ]; then \
			echo "Error: mtree file \"${MTREE_FILE}\" is missing."; \
			echo "Copy it from a suitable location (e.g., /usr/src/etc/mtree) and try again."; \
			exit 1; \
		else \
			if [ ! -d ${PREFIX} ]; then \
				mkdir -p ${PREFIX}; \
			fi; \
			${MTREE_CMD} ${MTREE_ARGS} ${PREFIX}/; \
		fi; \
	else \
		${ECHO_MSG} "Warning: not superuser, can't run mtree."; \
		${ECHO_MSG} "Become root and try again to ensure correct permissions."; \
	fi
.  endif
d1688 9
@


1.213
log
@Basic framework for fetching distfiles for mirrors.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.212 2000/03/03 14:23:10 turan Exp $$
d552 1
a552 1
DISTORIG?=	bak.orig
@


1.212
log
@nix LICENSE_TYPE.  This is much prettier now.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.211 2000/02/28 18:13:18 espie Exp $$
d1732 56
@


1.211
log
@Simplify README.html, reuse last pattern instead of re-specifying it.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.210 2000/02/22 17:08:31 espie Exp $$
d1210 2
a1211 3
.if !defined(LICENSE_TYPE) || !defined(PERMIT_PACKAGE_CDROM) || \
!defined(PERMIT_PACKAGE_FTP) || !defined(PERMIT_DISTFILES_CDROM) || \
!defined(PERMIT_DISTFILES_FTP)
a2020 6

.	if defined(LICENSE_TYPE)
	@@echo "${LICENSE_TYPE}"
.	else
	@@echo "?"
.	endif
@


1.210
log
@MAKEFILE-> MAKE_FILE
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.209 2000/02/22 14:07:09 espie Exp $$
d2056 6
a2061 12
			-e '/%%PKG%%/r$@@.tmp3' \
			-e '/%%PKG%%/d' \
			-e '/%%COMMENT%%/r${PKGDIR}/COMMENT' \
			-e '/%%COMMENT%%/d' \
			-e '/%%DESCR%%/r${PKGDIR}/DESCR' \
			-e '/%%DESCR%%/d' \
			-e '/%%HOMEPAGE%%/r$@@.tmp4' \
			-e '/%%HOMEPAGE%%/d' \
			-e '/%%BUILD_DEPENDS%%/r$@@.tmp1a' \
			-e '/%%BUILD_DEPENDS%%/d' \
			-e '/%%RUN_DEPENDS%%/r$@@.tmp2a' \
			-e '/%%RUN_DEPENDS%%/d' \
@


1.209
log
@Compute CKSUMFILES in two steps, use that to remove duplicates from
ALLFILES as well...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.208 2000/02/22 09:27:52 turan Exp $$
d544 1
a544 1
MAKEFILE?=		Makefile
d1374 1
a1374 1
	@@cd ${WRKBUILD} && ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKEFILE} ${ALL_TARGET}
d1431 1
a1431 1
	@@cd ${WRKBUILD} && ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKEFILE} ${INSTALL_TARGET}
@


1.208
log
@minor tweaks
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.207 2000/02/22 09:18:36 turan Exp $$
a849 1
# Build CKSUMFILES incrementally from ALLFILES, avoiding duplicates
d851 4
a854 3
.for __file in ${ALLFILES}
.  if empty(CKSUMFILES:M${__file}) && (!defined(IGNOREFILES) || empty(IGNOREFILES:M${__file}))
CKSUMFILES+= ${__file}
d857 7
@


1.207
log
@make describe, blanks -> ?.  typo as well
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.206 2000/02/21 23:53:52 espie Exp $$
d2015 2
d2018 3
@


1.206
log
@Compute more of INDEX within make, without external test calls.
Re-indent rules correctly. Only the make tests are indented, the rule itself
still starts after one tab.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.205 2000/02/21 22:09:58 turan Exp $$
d1981 1
a1981 1
	@@echo -n "|"
d1991 1
a1991 1
	@@echo -n "|"
d2002 1
a2002 1
		@@echo -n "|"
d2006 1
a2006 1
.	if defined(PERMIT_DISTFILES_CDROM)
d2013 1
a2013 1
	@@echo -n "|"
@


1.205
log
@licensing info in make describe.
make print-licenses target
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.204 2000/02/20 17:05:40 espie Exp $$
d1975 5
a1979 5
		@@if [ ${PERMIT_PACKAGE_CDROM:L} == "yes" ]; then \
			echo -n "y|"; \
		else \
			echo -n "n|"; \
		fi
d1981 1
a1981 1
		@@echo -n "|"
d1985 5
a1989 5
		@@if [ ${PERMIT_PACKAGE_FTP:L} == "yes" ]; then \
			echo -n "y|"; \
		else \
			echo -n "n|"; \
		fi
d1991 1
a1991 1
		@@echo -n "|"
d1996 5
a2000 5
		@@if [ ${PERMIT_DISTFILES_CDROM:L} == "yes" ]; then \
			echo -n "y|"; \
		else \
			echo -n "n|"; \
		fi
d2007 5
a2011 5
		@@if [ ${PERMIT_DISTFILES_FTP:L} == "yes" ]; then \
			echo -n "y|"; \
		else \
			echo -n "n|"; \
		fi
d2013 1
a2013 1
		@@echo -n "|"
@


1.204
log
@The MAINTAINER variable is here to be used...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.203 2000/02/19 04:16:23 turan Exp $$
d1969 1
a1969 1
		echo "any"; \
d1971 1
a1971 1
		echo "${ONLY_FOR_ARCHS}"; \
d1973 44
@


1.203
log
@pretty license warning.  louis@@
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.202 2000/02/18 22:54:27 espie Exp $$
d1206 2
a1207 2
	@@echo >&2 "*** The licensing info for this port is incomplete. ***"
	@@echo >&2 "*** Please notify the OpenBSD port maintainer.      ***"
@


1.202
log
@Add show target, to be able to enquire about ports variable values.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.201 2000/02/15 18:19:12 espie Exp $$
d1206 2
a1207 1
	@@echo >&2 "*** LICENSING INFO INCOMPLETE!  NOTIFY MAINTAINER! ***"
@


1.201
log
@Add HOMEPAGE to README.html
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.200 2000/02/15 17:58:32 espie Exp $$
d2180 6
d2216 1
a2216 1
   distpatch real-distpatch do-distpatch post-distpatch
@


1.200
log
@Be more thorough in cd ${.CURDIR} && make...
Otherwise, this causes obscure bugs some of the time...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.199 2000/02/15 07:28:20 turan Exp $$
d1982 5
d2005 2
@


1.199
log
@DISTF -> DISTFILES, PKG -> PACKAGE
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.198 2000/02/12 13:52:04 espie Exp $$
d700 1
a700 1
PKG_ARGS=		-v -c ${COMMENT} -d ${DESCR} -f ${PLIST} -p ${PREFIX} -P "`${MAKE} package-depends|${_SORT_DEPENDS}`"
d1468 1
a1468 1
	@@if [ -e ${PLIST} ]; then \
d1532 1
a1532 1
	@@make __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes fetch
d1577 1
a1577 1
	@@make delete-package-links
d1596 1
a1596 1
	@@make delete-package-links
d1616 1
a1616 1
	@@DEPENDS_TARGET=${DEPENDS_TARGET} make install
d1644 1
a1644 1
	@@make clean-depends
d1677 1
a1677 1
	@@make fetch-list-recursive RECURSIVE_FETCH_LIST=${RECURSIVE_FETCH_LIST} | sort -u
d1682 1
a1682 1
	@@make fetch-list-one-pkg 
d1977 1
a1977 1
	@@make depends-list FULL_PACKAGE_NAME=Yes | ${_SORT_DEPENDS}>$@@.tmp1
d1980 1
a1980 1
	@@make package-depends FULL_PACKAGE_NAME=Yes | ${_SORT_DEPENDS} >$@@.tmp2
d2011 1
a2011 1
	@@echo -n `make ${_DEPEND_THRU} depends-list | ${_SORT_DEPENDS}`
d2020 1
a2020 1
	@@echo -n `make ${_DEPEND_THRU} package-depends | ${_SORT_DEPENDS}`
d2029 1
a2029 1
	@@pname=`make _DEPEND_ECHO='echo -n' package-name ${_DEPEND_THRU}`; \
d2043 1
a2043 1
	@@pname=`make _DEPEND_ECHO='echo -n' package-name`; echo $$pname $$pname
d2069 1
a2069 1
	@@pname=`make _DEPEND_ECHO='echo -n' package-name ${_DEPEND_THRU}`; \
d2083 1
a2083 1
	@@pname=`make _DEPEND_ECHO='echo -n' package-name`; echo $$pname $$pname
d2126 1
a2126 1
	@@make FULL_PACKAGE_NAME=Yes print-depends-list print-package-depends
d2162 1
a2162 1
		for dep in `make package-depends ECHO_MSG=true | ${_SORT_DEPENDS}`; do \
@


1.198
log
@Warning message to stderr, to not interfere with other stuff.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.197 2000/02/12 06:02:04 turan Exp $$
d1203 3
a1205 3
.if !defined(LICENSE_TYPE) || !defined(PERMIT_PKG_CDROM) || \
!defined(PERMIT_PKG_FTP) || !defined(PERMIT_DISTF_CDROM) || \
!defined( PERMIT_DISTF_FTP)
@


1.197
log
@license framework minus checksums
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.196 2000/02/12 00:49:17 espie Exp $$
d1206 1
a1206 1
	@@echo "*** LICENSING INFO INCOMPLETE!  NOTIFY MAINTAINER! ***"
@


1.196
log
@Oops, left `build' line visible.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.195 2000/02/12 00:43:58 espie Exp $$
d1200 9
@


1.195
log
@Change MAKE_FLAGS to remove the -f.

Actually reading the Makefiles proved that about one third of them was
confused about this already...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.194 2000/02/11 01:11:00 espie Exp $$
d1357 1
a1357 1
	cd ${WRKBUILD} && ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKEFILE} ${ALL_TARGET}
@


1.194
log
@Remove deprecated variables.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.193 2000/02/11 00:40:09 espie Exp $$
d543 1
a543 1
MAKE_FLAGS?=	-f
d1357 1
a1357 1
	@@cd ${WRKBUILD} && ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} ${MAKEFILE} ${ALL_TARGET}
d1414 1
a1414 1
	@@cd ${WRKBUILD} && ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} ${MAKEFILE} ${INSTALL_TARGET}
@


1.193
log
@Remove WRKSRC work-around
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.192 2000/02/10 23:46:42 espie Exp $$
a745 28

# Deprecated:
MD5?=			md5
SHA1?=			sha1
RMD160?=		rmd160
TOUCH?=			/usr/bin/touch
TOUCH_FLAGS?=	-f
RM?=		/bin/rm
RMDIR?=		/bin/rmdir
SED?=		/usr/bin/sed
FIND?=		/usr/bin/find
MKDIR?=		/bin/mkdir -p
MV?=		/bin/mv
READLINK?=	/usr/bin/readlink
LN?=		/bin/ln
TR?=		/usr/bin/tr
TRUE?=		true
AWK?=		/usr/bin/awk
BASENAME?=	/usr/bin/basename
CAT?=		/bin/cat
CP?=		/bin/cp
ECHO?=		echo
EXPR?=		/bin/expr
FALSE?=		false
FILE?=		/usr/bin/file
DIRNAME?=	/usr/bin/dirname
GREP?=		/usr/bin/grep
DO_NADA?=		true
@


1.192
log
@Bye, bye NO_WRKSUBDIR
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.191 2000/02/09 20:09:05 espie Exp $$
a625 3
.if defined(WRKSRC)
WRKDIST?=		${WRKSRC}
.else
a626 1
.endif
@


1.191
log
@Repair package building.
Thanks to martin@@ for reminding me...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.190 2000/02/09 00:54:33 espie Exp $$
a167 2
# NO_WRKSUBDIR	- Assume port unpacks directly into ${WRKDIR}.
#				  (deprecated, use WRKDIST=${WRKDIR} instead)
a627 2
.elif defined(NO_WRKSUBDIR)
WRKDIST?=		${WRKDIR}
@


1.190
log
@and of course, nobody spotted the obvious typo in the patch I gave on
ports...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.189 2000/02/09 00:42:39 espie Exp $$
d1405 2
a1406 1
${_INSTALL_COOKIE}: ${_BUILD_COOKIE} run-depends lib-depends 
@


1.189
log
@Temporary work-around for ports that define WRKSRC manually...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.188 2000/02/09 00:26:32 espie Exp $$
d636 1
a636 1
WRKSRC?=	   ${WRKDIR}
@


1.188
log
@Use DIRMODE to install dirs, avoid collisions with mtree
(keep a duplicate of DIRMODE until 2.7)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.187 2000/02/09 00:23:26 espie Exp $$
d628 3
a630 1
.if defined(NO_WRKSUBDIR)
@


1.187
log
@Introduce WRKDIST: place where stuff unpacks.
May be different from where source lives.
And from where build happens.

NO_WRKSUBDIR=Yes is equivalent to WRKDIST=${WRKDIR}, and not
particularly smaller, deprecated it.

Remove CLEANDISTORIG, use patch -b instead.
Note that DISTORIG ends in .orig to let rm *.orig still work...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.185 2000/02/04 20:33:42 espie Exp $$
d657 4
d662 1
a662 1
	${INSTALL} -d -o ${BINOWN} -g ${BINGRP} -m ${BINMODE}
d666 1
a666 1
	${INSTALL} -d -o ${SHAREOWN} -g ${SHAREGRP} -m ${BINMODE}
d668 1
a668 1
	${INSTALL} -d -o ${MANOWN} -g ${MANGRP} -m ${BINMODE}
@


1.186
log
@Kill ALL_HOOK, it's deprecated and unused.
@
text
@d96 3
a98 3
# WRKSRC		- A subdirectory of ${WRKDIR} where the distribution actually
#				  unpacks to.  (Default: ${WRKDIR}/${DISTNAME} unless
#				  NO_WRKSUBDIR is set, in which case simply ${WRKDIR}).
d169 1
a296 3
# CLEANDISTORIG - Set to yes to clear *.orig files after applying
#                 distribution patches 
#
d298 1
a298 1
# Use these like: "${INSTALL_PROGRAM} ${WRKSRC}/prog ${PREFIX}/bin".
d554 1
a554 3

CLEANDISTORIG?= No

d560 2
a561 2
PATCH_ARGS?=	-d ${WRKSRC} -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-d ${WRKSRC} -E ${PATCH_DIST_STRIP}
d564 2
a565 2
PATCH_ARGS?=	-d ${WRKSRC} --forward --quiet -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-d ${WRKSRC} --forward --quiet -E ${PATCH_DIST_STRIP}
d629 1
a629 1
WRKSRC?=		${WRKDIR}
d631 1
a631 1
WRKSRC?=		${WRKDIR}/${DISTNAME}
d634 2
d938 1
a938 1
# Passed to most of script invocations
d940 2
a941 2
          PATH=${PORTPATH} \
		  WRKDIR=${WRKDIR} WRKSRC=${WRKSRC} WRKBUILD=${WRKBUILD} \
a1276 3
.  if ${CLEANDISTORIG:L} == "yes"
	@@cd ${WRKSRC} && find . -name '*.orig' | xargs rm
.  endif
d1294 1
a1294 1
.    if target(do-distpatch) || target(post-distpatch) || defined(PATCHFILES) || ${CLEANDISTORIG:L} == "yes"
@


1.185
log
@Compute CKSUMFILES in a better way, to avoid duplicates.
Simplifies SUPDISTFILES choice: put everything that might ever be fetched
there, don't worry about duplicates.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.184 2000/02/04 12:55:33 espie Exp $$
d1138 1
a1138 1
build: ${_BUILD_COOKIE}
a1141 14

# ALL_HOOK is deprecated, `all' should be a synonym for `build'.
.  if defined(ALL_HOOK)
all:
	@@cd ${.CURDIR} && ${SETENV} CURDIR=${.CURDIR} DISTNAME=${DISTNAME} \
	  DISTDIR=${DISTDIR} WRKDIR=${WRKDIR} WRKSRC=${WRKSRC} WRKBUILD=${WRKBUILD}\
	  PATCHDIR=${PATCHDIR} SCRIPTDIR=${SCRIPTDIR} \
	  FILESDIR=${FILESDIR} PORTSDIR=${PORTSDIR} PREFIX=${PREFIX} \
	  DEPENDS="${DEPENDS}" BUILD_DEPENDS="${BUILD_DEPENDS}" \
	  RUN_DEPENDS="${RUN_DEPENDS}" X11BASE=${X11BASE} \
	${ALL_HOOK}
.  else
all: ${_BUILD_COOKIE}
.  endif
@


1.184
log
@Defining ALLFILES in every case is much better...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.183 2000/02/04 11:15:16 espie Exp $$
d882 7
a888 6
CKSUMFILES=		${ALLFILES}
.if defined(IGNOREFILES)
.  for __TMP in ${IGNOREFILES}
CKSUMFILES:=${CKSUMFILES:N${__TMP}}
.  endfor
.endif
@


1.183
log
@Finish cleansing PATCH_SITES out.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.182 2000/02/04 11:09:33 espie Exp $$
d865 3
a867 2
_EVERYTHING= ${DISTFILES}
_DISTFILES=		${DISTFILES:C/:[0-9]$//}
d870 1
a870 1
_PATCHFILES=	${PATCHFILES:C/:[0-9]$//}
d872 1
a872 1
ALLFILES+= ${_PATCHFILES}
@


1.182
log
@Remove the real-* targets, do things directly at the cookie level.
More submakes die.

Remove NO_WRKDIR `feature'

Fix `make clean' to do the right thing even if WRKOBJDIR is not defined
at that point.

It's doubtful package-noinstall is useful, but I left it in for now, with
slightly altered semantics.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.180 2000/02/03 22:03:00 espie Exp $$
a72 4
# PATCH_SITES	- Primary location(s) for distribution patch files
#				  (see PATCHFILES below) if not found locally.
# PATCH_SITE_SUBDIR - Directory that "%SUBDIR%" in PATCH_SITES is
#				  replaced by.
d116 1
a116 1
#				  PATCH_SITES (see above).  They will automatically be
a118 2
# SUPPATCHFILES  - Names of supplementary patch files that don't get
# 				  used all the time (default: empty).
d125 2
a126 1
# ALLFILES		- All of ${DISTFILES} and ${PATCHFILES}.
d337 2
a338 2
# fetch			- Retrieves ${DISTFILES} (and ${PATCHFILES} if defined)
#				  into ${DISTDIR} as necessary.
d340 2
a341 1
# extract		- Unpacks ${DISTFILES} into ${WRKDIR}.
a809 5
.if defined(PATCH_SITES)
_PATCH_SITES:=		${PATCH_SITES:S@@%SUBDIR%@@${PATCH_SITE_SUBDIR}@@}
.else
_PATCH_SITES:=		${_MASTER_SITES}
.endif
a813 1
PATCH_SITES:=	${_PATCH_SITES} ${MASTER_SITE_BACKUP}
a815 1
PATCH_SITES:=	${MASTER_SITE_OVERRIDE} ${_PATCH_SITES}
d818 4
d830 1
a830 10
.  endif
.  if defined(PATCH_SITES${_I})
_PATCH_SITES${_I}:=	${PATCH_SITES${_I}:S@@%SUBDIR%@@${PATCH_SITE_SUBDIR}@@}
.    if !defined(MASTER_SITE_OVERRIDE)
PATCH_SITES${_I}:=	${_PATCH_SITES${_I}} ${MASTER_SITE_BACKUP}
.    else
PATCH_SITES${_I}:= ${MASTER_SITE_OVERRIDE} ${_PATCH_SITES${_I}}
.    endif
.  elif defined(MASTER_SITES${_I})
PATCH_SITES${_I}:= ${MASTER_SITES${_I}}
d833 1
d864 2
a865 1
# This one is hardcoded for now
d867 2
d870 3
d874 1
a874 1
.if make(makesum) || make(addsum) || defined(__FETCH_ALL)
d876 2
a877 6
 DISTFILES+=${SUPDISTFILES}
 _DISTFILES+=${SUPDISTFILES:C/:[0-9]$//}
.  endif
.  if defined(SUPPATCHFILES)
 PATCHFILES+=${SUPPATCHFILES}
 _PATCHFILES+=${SUPPATCHFILES:C/:[0-9]$//}
a879 1
ALLFILES?=	${_DISTFILES} ${_PATCHFILES}
d1269 1
a1269 1
.    if defined(PATCHFILES)
d1545 1
a1545 1
.for _F in ${_DISTFILES:S@@^@@${FULLDISTDIR}/@@}
d1551 1
a1551 1
	select=${DISTFILES:M*${_F:S@@^${FULLDISTDIR}/@@@@}\:[0-9]}; \
d1555 1
a1555 13
	case $$select in \
		"") sites="${MASTER_SITES}";; \
		*:0) sites="${MASTER_SITES0}";; \
		*:1) sites="${MASTER_SITES1}";; \
		*:2) sites="${MASTER_SITES2}";; \
		*:3) sites="${MASTER_SITES3}";; \
		*:4) sites="${MASTER_SITES4}";; \
		*:5) sites="${MASTER_SITES5}";; \
		*:6) sites="${MASTER_SITES6}";; \
		*:7) sites="${MASTER_SITES7}";; \
		*:8) sites="${MASTER_SITES8}";; \
		*:9) sites="${MASTER_SITES9}";; \
	esac; \
a1563 34
.if defined(PATCHFILES)
.  for _F in ${_PATCHFILES:S@@^@@${FULLDISTDIR}/@@}
${_F}:
# Bug-fix for make/ftp interaction in 2.6
	@@if [ -e ${_F} ]; then touch ${_F}; exit 0; fi; \
	mkdir -p ${_F:H}; \
	cd ${_F:H}; \
	${_CDROM_OVERRIDE}; \
	select=${PATCHFILES:M*${_F:S@@^${FULLDISTDIR}/@@@@}\:[0-9]}; \
	f=${_F:S@@^${FULLDISTDIR}/@@@@}; \
	${ECHO_MSG} ">> $$f doesn't seem to exist on this system."; \
	case $$select in \
		"") sites="${PATCH_SITES}";; \
		*:0) sites="${PATCH_SITES0}";; \
		*:1) sites="${PATCH_SITES1}";; \
		*:2) sites="${PATCH_SITES2}";; \
		*:3) sites="${PATCH_SITES3}";; \
		*:4) sites="${PATCH_SITES4}";; \
		*:5) sites="${PATCH_SITES5}";; \
		*:6) sites="${PATCH_SITES6}";; \
		*:7) sites="${PATCH_SITES7}";; \
		*:8) sites="${PATCH_SITES8}";; \
		*:9) sites="${PATCH_SITES9}";; \
	esac; \
	for site in $$sites; do \
		${ECHO_MSG} ">> Attempting to fetch ${_F} from $${site}."; \
		if ${FETCH_CMD} ${FETCH_BEFORE_ARGS} $${site}$$f ${FETCH_AFTER_ARGS}; then \
				exit 0; \
		fi; \
	done; exit 1
.  endfor

.endif	# defined(PATCHFILES)

d1577 1
a1577 1
	@@for file in ${_DISTFILES} ${_PATCHFILES}; do \
d1719 1
a1719 1
	@@make fetch-list-one-pkg
d1733 2
a1734 2
	 for fullfile in ${DISTFILES}; do \
	 	file=`echo $$fullfile|sed -e 's,:[0-9]$$,,'`; \
d1737 2
a1738 39
			case $$fullfile in \
				*:0) sites_list="${MASTER_SITES0}";; \
				*:1) sites_list="${MASTER_SITES1}";; \
				*:2) sites_list="${MASTER_SITES2}";; \
				*:3) sites_list="${MASTER_SITES3}";; \
				*:4) sites_list="${MASTER_SITES4}";; \
				*:5) sites_list="${MASTER_SITES5}";; \
				*:6) sites_list="${MASTER_SITES6}";; \
				*:7) sites_list="${MASTER_SITES7}";; \
				*:8) sites_list="${MASTER_SITES8}";; \
				*:9) sites_list="${MASTER_SITES9}";; \
				*)   sites_list="${MASTER_SITES}";; \
			esac; \
			for site in $$sites_list ; do \
				echo -n ${FETCH_CMD} ${FETCH_BEFORE_ARGS} $${site}$${file} "${FETCH_AFTER_ARGS}" '|| ' ; \
			done; \
			echo "echo $${file} not fetched" ; \
		fi \
	done
.  if defined(PATCHFILES)
	@@cd ${FULLDISTDIR}; \
	 for fullfile in ${PATCHFILES}; do \
	 	file=`echo $$fullfile|sed -e 's,:[0-9]$$,,'`; \
		if [ ! -f $$file -a ! -f `basename $$file` ]; then \
			echo -n "cd ${FULLDISTDIR} && [ -f $$file -o -f `basename $$file` ] || " ; \
			case $$fullfile in \
				*:0) sites_list="${PATCH_SITES0}";; \
				*:1) sites_list="${PATCH_SITES1}";; \
				*:2) sites_list="${PATCH_SITES2}";; \
				*:3) sites_list="${PATCH_SITES3}";; \
				*:4) sites_list="${PATCH_SITES4}";; \
				*:5) sites_list="${PATCH_SITES5}";; \
				*:6) sites_list="${PATCH_SITES6}";; \
				*:7) sites_list="${PATCH_SITES7}";; \
				*:8) sites_list="${PATCH_SITES8}";; \
				*:9) sites_list="${PATCH_SITES9}";; \
				*)   sites_list="${PATCH_SITES}";; \
			esac; \
+			for site in $$sites_list; do \
a1743 1
.  endif # defined(PATCHFILES)
@


1.181
log
@Don't let real target depend on phony, unless we want the real target to
be rebuilt each and every time...
@
text
@a173 2
# NO_WRKDIR		- There's no work directory at all; port does this someplace
#				  else.
d390 1
a390 1
# pre-patch `real distpatch' post-distpatch `real-patch' post-patch
d630 1
a630 2
.if !defined(NO_WRKDIR)
.  if defined(OBJMACHINE)
d632 1
a632 1
.  else
a633 3
.  endif
.else
WRKDIR?=		${.CURDIR}
d635 1
d1058 28
a1085 1
fetch: real-fetch
d1139 7
d1154 2
a1183 7
################################################################
# The following hooks are used to create easy dummy targets for
# disabling some bit of default target behavior you don't want,
# and to perform ports build in the correct order.
################################################################

# Disable checksum
d1197 1
d1217 4
a1223 239
	@@cd ${.CURDIR} && make real-extract
.endif
	@@${_MAKE_COOKIE} ${_EXTRACT_COOKIE}

.if target(pre-patch)
${_PREPATCH_COOKIE}:
	@@cd ${.CURDIR} && make pre-patch
	@@${_MAKE_COOKIE} ${_PREPATCH_COOKIE}
.endif

${_DISTPATCH_COOKIE}: ${_EXTRACT_COOKIE}
.if !defined(NO_PATCH)
	@@cd ${.CURDIR} && make real-distpatch
.endif
	@@${_MAKE_COOKIE} ${_DISTPATCH_COOKIE}

${_PATCH_COOKIE}: ${_EXTRACT_COOKIE}
.if !defined(NO_PATCH)
	@@cd ${.CURDIR} && make real-patch
.endif
.if !defined(PATCH_CHECK_ONLY) && defined(USE_AUTOCONF)
	@@cd ${AUTOCONF_DIR} && ${SETENV} ${AUTOCONF_ENV} ${AUTOCONF}
.endif
	@@${_MAKE_COOKIE} ${_PATCH_COOKIE}

${_CONFIGURE_COOKIE}: ${_PATCH_COOKIE}
.if !defined(NO_CONFIGURE)
	@@cd ${.CURDIR} && make real-configure
.endif
	@@${_MAKE_COOKIE} ${_CONFIGURE_COOKIE}

${_BUILD_COOKIE}: ${_CONFIGURE_COOKIE}
.if !defined(NO_BUILD) 
	@@cd ${.CURDIR} && make real-build
.endif
	@@${_MAKE_COOKIE} ${_BUILD_COOKIE}

${_INSTALL_COOKIE}: ${_BUILD_COOKIE} 
	@@cd ${.CURDIR} && make run-depends lib-depends 
.if !defined(NO_INSTALL)
	@@cd ${.CURDIR} && make real-install
.endif
	@@${_MAKE_COOKIE} ${_INSTALL_COOKIE}

${_PACKAGE_COOKIE}: ${_INSTALL_COOKIE}
.if !defined(NO_PACKAGE)
	@@cd ${.CURDIR} && make real-package
.else
.  if !defined(IGNORE_SILENT)
	@@${ECHO_MSG} "===>  ${PKGNAME} may not be packaged: ${NO_PACKAGE}."
.  endif
.endif
.if !defined(PACKAGE_NOINSTALL)
	@@${_MAKE_COOKIE} ${_PACKAGE_COOKIE}
.endif


################################################################
# Support for standard targets start here.
################################################################


.if !target(fetch-all)
fetch-all:
	@@cd ${.CURDIR} && make __FETCH_ALL=Yes real-fetch
.endif

# Separate target for each file fetch will retrieve

.for _F in ${_DISTFILES:S@@^@@${FULLDISTDIR}/@@}
${_F}:
# Bug-fix for make/ftp interaction in 2.6
	@@if [ -e ${_F} ]; then touch ${_F}; exit 0; fi; \
	mkdir -p ${_F:H}; \
	cd ${_F:H}; \
	select=${DISTFILES:M*${_F:S@@^${FULLDISTDIR}/@@@@}\:[0-9]}; \
	f=${_F:S@@^${FULLDISTDIR}/@@@@}; \
	${ECHO_MSG} ">> $$f doesn't seem to exist on this system."; \
	${_CDROM_OVERRIDE}; \
	case $$select in \
		"") sites="${MASTER_SITES}";; \
		*:0) sites="${MASTER_SITES0}";; \
		*:1) sites="${MASTER_SITES1}";; \
		*:2) sites="${MASTER_SITES2}";; \
		*:3) sites="${MASTER_SITES3}";; \
		*:4) sites="${MASTER_SITES4}";; \
		*:5) sites="${MASTER_SITES5}";; \
		*:6) sites="${MASTER_SITES6}";; \
		*:7) sites="${MASTER_SITES7}";; \
		*:8) sites="${MASTER_SITES8}";; \
		*:9) sites="${MASTER_SITES9}";; \
	esac; \
	for site in $$sites; do \
		${ECHO_MSG} ">> Attempting to fetch ${_F} from $${site}."; \
		if ${FETCH_CMD} ${FETCH_BEFORE_ARGS} $${site}$$f ${FETCH_AFTER_ARGS}; then \
				exit 0; \
		fi; \
	done; exit 1
.endfor

.if defined(PATCHFILES)
.  for _F in ${_PATCHFILES:S@@^@@${FULLDISTDIR}/@@}
${_F}:
# Bug-fix for make/ftp interaction in 2.6
	@@if [ -e ${_F} ]; then touch ${_F}; exit 0; fi; \
	mkdir -p ${_F:H}; \
	cd ${_F:H}; \
	${_CDROM_OVERRIDE}; \
	select=${PATCHFILES:M*${_F:S@@^${FULLDISTDIR}/@@@@}\:[0-9]}; \
	f=${_F:S@@^${FULLDISTDIR}/@@@@}; \
	${ECHO_MSG} ">> $$f doesn't seem to exist on this system."; \
	case $$select in \
		"") sites="${PATCH_SITES}";; \
		*:0) sites="${PATCH_SITES0}";; \
		*:1) sites="${PATCH_SITES1}";; \
		*:2) sites="${PATCH_SITES2}";; \
		*:3) sites="${PATCH_SITES3}";; \
		*:4) sites="${PATCH_SITES4}";; \
		*:5) sites="${PATCH_SITES5}";; \
		*:6) sites="${PATCH_SITES6}";; \
		*:7) sites="${PATCH_SITES7}";; \
		*:8) sites="${PATCH_SITES8}";; \
		*:9) sites="${PATCH_SITES9}";; \
	esac; \
	for site in $$sites; do \
		${ECHO_MSG} ">> Attempting to fetch ${_F} from $${site}."; \
		if ${FETCH_CMD} ${FETCH_BEFORE_ARGS} $${site}$$f ${FETCH_AFTER_ARGS}; then \
				exit 0; \
		fi; \
	done; exit 1
.  endfor

.endif	# defined(PATCHFILES)

# This is for the use of sites which store distfiles which others may
# fetch - only fetch the distfile if it is allowed to be
# re-distributed freely
mirror-distfiles:
.if (${MIRROR_DISTFILE:L} == "yes")
	@@make fetch-all __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes
.endif

# list the distribution and patch files used by a port.  Typical
# use is		make ECHO_MSG=: list-distfiles | tee some-file
#
list-distfiles:
	@@echo "${PKGNAME}"
	@@for file in ${_DISTFILES} ${_PATCHFILES}; do \
		if [ "$$file" != "${EXTRACT_SUFX}" ]; then \
			if [ -z "${DIST_SUBDIR}" ]; then \
				printf "\t$$file\n"; \
			else \
				printf "\t${DIST_SUBDIR}/$$file\n"; \
			fi \
		fi \
	 done
	@@echo ""

# Obj
#
.if !target(obj)
obj:
.  if !defined(NO_WRKDIR)
.    if defined(WRKOBJDIR)
	@@rm -rf ${WRKOBJDIR}/${PORTSUBDIR}
	@@mkdir -p ${WRKOBJDIR}/${PORTSUBDIR}
	@@if [ ! -L ${WRKDIR} ] || \
	  [ X`readlink ${WRKDIR}` != X${WRKOBJDIR}/${PORTSUBDIR} ]; then \
		${ECHO_MSG} "${WRKDIR} -> ${WRKOBJDIR}/${PORTSUBDIR}"; \
		rm -f ${WRKDIR}; \
		ln -sf ${WRKOBJDIR}/${PORTSUBDIR} ${WRKDIR}; \
	fi
.    else
	@@echo ">>"
	@@echo ">> Please set the WRKOBJDIR variable before using 'make obj'"
	@@echo ">>"
	@@exit 1;
.    endif
.  endif
.endif


${WRKBUILD}:
	mkdir -p ${WRKBUILD}

# Some support rules for do-package

.if !target(package-links)
package-links:
	@@make delete-package-links
	@@for cat in ${CATEGORIES}; do \
		if [ ! -d ${PACKAGES}/$$cat ]; then \
			if ! mkdir -p ${PACKAGES}/$$cat; then \
				echo ">> Can't create directory ${PACKAGES}/$$cat."; \
				exit 1; \
			fi; \
		fi; \
		ln -s ../${PKGREPOSITORYSUBDIR}/${PKGNAME}${PKG_SUFX} ${PACKAGES}/$$cat; \
	done;
.endif

.if !target(delete-package-links)
delete-package-links:
	@@cd ${PACKAGES} && find . -type l -name ${PKGNAME}${PKG_SUFX}|xargs rm -f
.endif

.if !target(delete-package)
delete-package:
	@@make delete-package-links
	@@rm -f ${PKGFILE}
.endif

################################################################
# The real targets start here.
# 
# You shouldn't EVER change these. If possible, add a pre-* or
# post-* hook.  
# In the worst case, define a do-* target that will override
# the main body of the target.
################################################################


real-fetch: fetch-depends
.if target(pre-fetch)
	@@cd ${.CURDIR} && make pre-fetch
.endif
.if target(do-fetch)
	@@cd ${.CURDIR} && make do-fetch
.else
# What FETCH normally does:
	@@cd ${.CURDIR} && make ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
# End of FETCH
.endif
.if target(post-fetch)
	@@cd ${.CURDIR} && make post-fetch
.endif


real-extract: 
d1225 1
a1225 1
.if target(pre-extract)
d1227 2
a1228 2
.endif
.if target(do-extract)
d1230 1
a1230 1
.else
a1231 1
.  if !defined(NO_WRKDIR)
a1244 1
.  endif
d1253 2
a1254 2
.endif
.if target(post-extract)
d1256 1
d1258 2
d1261 3
a1263 1
real-distpatch:
d1265 12
d1278 2
a1279 2
.endif
.if target(do-distpatch)
d1281 1
a1281 1
.else
d1283 1
a1283 1
.  if defined(PATCHFILES)
d1299 2
d1302 1
a1302 3
# End of DISTPATCH.
.endif
.if target(post-distpatch)
d1304 2
a1305 2
.endif
.if ${CLEANDISTORIG:L} == "yes"
d1307 1
d1309 2
d1312 4
a1315 1
real-patch: 
d1320 1
a1320 1
.if target(do-patch)
d1322 1
a1322 1
.else
d1325 1
a1325 1
.  if target(do-distpatch) || target(post-distpatch) || defined(PATCHFILES) || ${CLEANDISTORIG:L} == "yes"
d1327 1
a1327 1
.  endif 
d1357 4
d1362 2
a1363 2
.if target(post-patch)
	@@cd ${.CURDIR} && make post-patch
d1365 2
d1368 1
d1370 2
a1371 1
real-configure: ${WRKBUILD}
d1373 2
a1374 1
.if target(pre-configure)
d1376 2
a1377 2
.endif
.if target(do-configure)
d1379 1
a1379 1
.else
d1385 1
a1385 1
.  if defined(HAS_CONFIGURE)
d1393 2
a1394 2
.  endif
.  if defined(USE_IMAKE)
d1396 2
d1399 1
a1399 3
# End of CONFIGURE.
.endif
.if target(post-configure)
d1401 1
d1403 1
d1406 1
d1408 2
a1409 1
real-build: 
d1411 1
a1411 1
.if target(pre-build)
d1413 2
a1414 2
.endif
.if target(do-build)
d1416 1
a1416 1
.else
d1420 2
a1421 2
.endif
.if target(post-build)
d1423 1
d1425 1
d1428 4
a1431 1
real-install: 
d1433 1
a1433 1
.if !defined(NO_PKG_REGISTER) && !defined(FORCE_PKG_REGISTER)
d1443 1
a1443 1
.endif
d1449 1
a1449 1
.if !defined(NO_MTREE)
d1465 1
a1465 1
.endif
d1467 1
a1467 1
.if target(pre-install)
d1469 2
a1470 2
.endif
.if target(do-install)
d1472 1
a1472 1
.else
d1476 2
a1477 2
.endif
.if target(post-install)
d1479 3
a1481 3
.endif
.if defined(_MANPAGES) || defined(_CATPAGES)
.  if defined(MANCOMPRESSED) && defined(NOMANCOMPRESS)
d1483 1
a1483 1
.    for manpage in ${_MANPAGES} ${_CATPAGES}
d1485 2
a1486 2
.    endfor
.  elif !defined(MANCOMPRESSED) && !defined(NOMANCOMPRESS)
d1488 1
a1488 1
.    for manpage in ${_MANPAGES} ${_CATPAGES}
d1497 2
a1498 1
.    endfor
d1500 1
a1500 2
.endif
.if exists(${PKGDIR}/MESSAGE)
d1502 2
a1503 2
.endif
.if !defined(NO_PKG_REGISTER)
d1505 1
d1507 1
d1510 3
a1512 3

real-package:
.if target(pre-package)
d1514 2
a1515 2
.endif
.if target(do-package)
d1517 1
a1517 1
.else
d1539 145
d1685 4
a1688 2
.if target(post-package)
	@@cd ${.CURDIR} && make post-package
d1691 5
d1744 2
a1745 16
.  if !defined(NO_WRKDIR)
.    if  defined(WRKOBJDIR)
	@@rm -rf ${WRKOBJDIR}/${PORTSUBDIR}
	@@rm -f ${WRKDIR}
.    else
	@@if [ -d ${WRKDIR} ]; then \
		if [ -w ${WRKDIR} ]; then \
			rm -rf ${WRKDIR}; \
		else \
			${ECHO_MSG} "===>   ${WRKDIR} not writable, skipping"; \
		fi; \
	fi
.    endif
.  else
	@@rm -f ${_ALL_COOKIES}
.  endif
d1895 1
a1895 1
# Build a package but don't check the cookie for installation, also don't
d1900 2
a1901 1
	@@cd ${.CURDIR} && make PACKAGE_NOINSTALL=Yes real-package
d2335 1
a2335 2
   readmes real-extract real-fetch real-install real-patch real-package \
   real-configure reinstall \
@


1.180
log
@Buglet fix: there's absolutely no reason not to run checksum, or
dependencies, if NO_EXTRACT or NO_PACKAGE has been defined ?

Might break some ports that don't explicitly ask not to run those steps.
Good thing.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.179 2000/02/02 18:33:42 espie Exp $$
d1232 2
a1233 1
${_INSTALL_COOKIE}: ${_BUILD_COOKIE} run-depends lib-depends 
@


1.179
log
@...twice
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.178 2000/02/02 18:20:28 espie Exp $$
d1193 1
d1195 1
a1195 1
	@@cd ${.CURDIR} && make checksum real-extract
d1232 1
a1232 1
${_INSTALL_COOKIE}: ${_BUILD_COOKIE}
d1432 1
a1432 1
real-extract: build-depends lib-depends misc-depends
d1601 1
a1601 1
real-install: run-depends lib-depends 
@


1.178
log
@I am a moron
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.177 2000/02/02 15:28:17 espie Exp $$
d850 1
a850 1
.  elsif defined(MASTER_SITES${_I})
@


1.177
log
@Cosmetic patch: don't append DIST_SUBDIR if it's not defined.

Set vim filetype, as vi doesn't care.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.176 2000/02/02 00:15:07 espie Exp $$
d851 1
a851 1
_PATCH_SITES${_I}:= ${MASTER_SITES${_I}}
@


1.176
log
@Dependency tweaks.

- put .if defined(XXX) && !defined(YYY) on the same line: less indentation,
more readability.
- set found to true/false directly (builtin).

ALWAYS check that a dependency directory does exist and is a directory.
Catch up typos more quickly, since they will be evident *even if the
dependency is already satisfied*.

Make this only a warning, not a hard error, as we still want to cater
to users with a partially checked out tree...
@
text
@d2 2
a3 2
# ex:ts=4 sw=4
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.175 2000/02/01 14:39:20 espie Exp $$
d438 1
d440 3
@


1.175
log
@Undefined PATCH_SITES equivalent to MASTER_SITES,
PATCH_SITESn equivalent to MASTER_SITESn.

Start phasing out PATCH_SITES.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.174 2000/01/30 15:19:40 espie Exp $$
d1937 1
a1937 2
.    if defined(${_DEP:U}_DEPENDS)
.      if !defined(NO_DEPENDS)
d1948 4
a1951 1
		found=not; \
d1954 1
a1954 4
				${ECHO_MSG} "===>  ${PKGNAME} depends on file: $$prog - found"; \
				found=""; \
			else \
				${ECHO_MSG} "===>  ${PKGNAME} depends on file: $$prog - not found"; \
d1959 1
a1959 1
					found="$$d/$$prog"; \
a1962 1
			${ECHO_MSG} "===>  ${PKGNAME} depends on executable: $$prog - $$found found"; \
d1964 4
a1967 1
		if [ X"$$found" = Xnot ]; then \
a1971 3
				if [ ! -d $$dir ]; then \
					echo ">> No directory for $$prog ($$dir)"; \
				fi; \
a1975 1
.      endif
d1980 2
a1981 3
.  if defined(LIB_DEPENDS)
.    if !defined(NO_DEPENDS)
.      if defined(NO_SHARED_LIBS)
d1991 3
d2003 1
a2003 3
				if [ ! -d "$$dir" ]; then \
					echo ">> No directory for $$lib ($$dir)"; \
				fi; \
d2009 1
a2009 1
.      else
d2019 3
a2029 3
				if [ ! -d "$$dir" ]; then \
					echo ">> No directory for $$libname ($$dir)"; \
				fi; \
a2035 1
.      endif
d2040 1
a2040 2
.  if defined(DEPENDS)
.    if !defined(NO_DEPENDS)
d2048 3
d2056 1
a2056 4
			if [ ! -d $$dir ]; then \
				echo ">> No directory for $$dir."; \
			fi; \
				exit 1; \
a2058 1
.    endif
@


1.174
log
@Add intermediate `distpatch' target.
This is done in a tricky way, so as not to disturb the usual sequence
of targets. Namely, you still have
fetch, extract, patch, configure, build, install, package,
but patch does invoke a subtarget distpatch when needed,
and you can
fetch, extract, distpatch, patch, configure, build, install, package
for the same results.

Mostly useful for porters: provide an intermediate point to work on
patches, and make it easy to override distpatch/OpenBSD patches separately.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.172 2000/01/27 20:16:14 espie Exp $$
d815 1
a815 1
PATCH_SITES?=
d817 3
d846 2
@


1.173
log
@oops
@
text
@d303 3
d349 1
d388 5
d505 2
d521 2
a522 1
${_INSTALL_PRE_COOKIE} ${_BUILD_COOKIE} ${_PACKAGE_COOKIE}
d559 2
d1110 1
d1189 12
d1459 1
a1459 4


real-patch: 
	@@${ECHO_MSG} "===>  Patching for ${PKGNAME}"
d1461 1
a1461 1
	@@cd ${.CURDIR} && make pre-patch
d1463 2
a1464 2
.if target(do-patch)
	@@cd ${.CURDIR} && make do-patch
d1466 1
a1466 1
# What PATCH normally does:
d1484 22
d2363 2
a2364 1
   recurse-build-depends recurse-package-depends
@


1.172
log
@Missed a few phony targets.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.171 2000/01/27 15:32:15 espie Exp $$
d2314 1
a2314 1
   readmes real-extract real-fetch real-install real-patch real-package
@


1.171
log
@Use db/network.conf only if it exists, defaults to the template otherwise.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.170 2000/01/27 00:09:44 brad Exp $$
d2314 2
a2315 1
   readmes real-extract real-fetch real-install reinstall \
@


1.170
log
@update comment to match reality after recent removal of support for using
pre-*/post-* scripts
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.169 2000/01/26 23:11:08 espie Exp $$
d785 1
d787 3
@


1.169
log
@Kill _PORT_USE macro.

This trims down the number of sub-makes the port system runs quite a bit,
and makes some other fun stuff possible.

THIS KILLS THE pre-*/post-* SCRIPT STUFF
The functionality is unneeded, as it can be done with normal
pre-*/post-* targets, but it must be kept in mind when porting
Free/NetBSD ports.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.168 2000/01/26 21:15:05 espie Exp $$
d379 4
a382 4
# should be able to use the pre-* or post-* targets/scripts
# (which are available for every stage except checksum) or
# provide an overriding do-* target to do pretty much anything 
# you want.
@


1.168
log
@Work-around for a whole set of bugs in 2.6...
some ftp servers give weird dates, like Dec 14 1909...
and then make gets confused, as make 2.6 is broken with respect to negative
dates.

So we touch the file whenever make gets confused and it already exists.
This avoids fetching & re-fetching files with negative dates, while keeping
timestamps for correct files...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.167 2000/01/13 17:40:20 espie Exp $$
d381 2
a382 1
# override the do-* targets to do pretty much anything you want.
d1127 2
a1128 1
# disabling some bit of default target behavior you don't want.
d1211 1
a1211 5
# More standard targets start here.
#
# These are the body of the build/install framework.  If you are
# not happy with the default actions, and you can't solve it by
# adding pre-* or post-* targets/scripts, override these.
a1213 1
# Fetch
d1215 6
a1220 2
.if !target(do-fetch)
do-fetch: ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
d1222 1
a1222 1
.  for _F in ${_DISTFILES:S@@^@@${FULLDISTDIR}/@@}
d1251 1
a1251 1
.  endfor
d1253 2
a1254 2
.  if defined(PATCHFILES)
.    for _F in ${_PATCHFILES:S@@^@@${FULLDISTDIR}/@@}
d1283 1
a1283 1
.    endfor
d1285 1
a1285 3
.  endif	# defined(PATCHFILES)

.endif	# !target(do-fetch)
a1333 1
# Extract
d1335 65
a1399 2
.if !target(do-extract)
do-extract:
d1422 1
d1424 4
a1428 1
# Patch
d1430 9
a1438 2
.if !target(do-patch)
do-patch:
d1484 4
a1489 1
# Configure
d1491 9
a1499 2
.if !target(do-configure)
do-configure: ${WRKBUILD}
d1516 4
a1521 2
${WRKBUILD}:
	mkdir -p ${WRKBUILD}
a1522 1
# Build
d1524 9
a1532 2
.if !target(do-build)
do-build:
d1534 4
a1539 1
# Install
d1541 12
a1552 3
.if !target(do-install)
do-install:
	@@cd ${WRKBUILD} && ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} ${MAKEFILE} ${INSTALL_TARGET}
d1554 14
a1567 13

# Package

.if !target(do-package)
do-package:
	@@if [ -e ${PLIST} ]; then \
		${ECHO_MSG} "===>  Building package for ${PKGNAME}"; \
		if [ -d ${PACKAGES} ]; then \
			if [ ! -d ${PKGREPOSITORY} ]; then \
				if ! mkdir -p ${PKGREPOSITORY}; then \
					echo ">> Can't create directory ${PKGREPOSITORY}."; \
					exit 1; \
				fi; \
d1569 1
d1571 3
a1573 8
		if ${PKG_CMD} ${PKG_ARGS} ${PKGFILE}; then \
			if [ -d ${PACKAGES} ]; then \
				make package-links; \
			fi; \
		else \
			make delete-package; \
			exit 1; \
		fi; \
d1576 3
a1578 15

# Some support rules for do-package

.if !target(package-links)
package-links:
	@@make delete-package-links
	@@for cat in ${CATEGORIES}; do \
		if [ ! -d ${PACKAGES}/$$cat ]; then \
			if ! mkdir -p ${PACKAGES}/$$cat; then \
				echo ">> Can't create directory ${PACKAGES}/$$cat."; \
				exit 1; \
			fi; \
		fi; \
		ln -s ../${PKGREPOSITORYSUBDIR}/${PKGNAME}${PKG_SUFX} ${PACKAGES}/$$cat; \
	done;
d1580 6
a1585 4

.if !target(delete-package-links)
delete-package-links:
	@@cd ${PACKAGES} && find . -type l -name ${PKGNAME}${PKG_SUFX}|xargs rm -f
d1587 2
a1588 5

.if !target(delete-package)
delete-package:
	@@make delete-package-links
	@@rm -f ${PKGFILE}
a1589 20

################################################################
# This is the "generic" port target, actually a macro used from the
# six main targets.  See below for more.
################################################################

_PORT_USE: .USE
	@@cd ${.CURDIR} && make ${.TARGET:S/^real-/pre-/}
	@@if [ -f ${SCRIPTDIR}/${.TARGET:S/^real-/pre-/} ]; then \
		cd ${.CURDIR} && ${SETENV} ${SCRIPTS_ENV} ${SH} \
			${SCRIPTDIR}/${.TARGET:S/^real-/pre-/}; \
	fi
	@@cd ${.CURDIR} && make ${.TARGET:S/^real-/do-/}
	@@cd ${.CURDIR} && make ${.TARGET:S/^real-/post-/}
	@@if [ -f ${SCRIPTDIR}/${.TARGET:S/^real-/post-/} ]; then \
		cd ${.CURDIR} && ${SETENV} ${SCRIPTS_ENV} ${SH} \
			${SCRIPTDIR}/${.TARGET:S/^real-/post-/}; \
	fi

_POST_INSTALL: .USE
a1616 13
################################################################
# Skeleton targets start here
# 
# You shouldn't have to change these.  Either add the pre-* or
# post-* targets/scripts or redefine the do-* targets.  These
# targets don't do anything other than checking for cookies and
# call the necessary targets/scripts.
################################################################

.if !target(fetch-all)
fetch-all:
	@@cd ${.CURDIR} && make __FETCH_ALL=Yes real-fetch
.endif
a1617 1
# And call the macros
d1619 3
a1621 21
real-fetch: fetch-depends _PORT_USE
real-extract: build-depends lib-depends misc-depends _PORT_USE
	@@${ECHO_MSG} "===>  Extracting for ${PKGNAME}"
real-patch: _PORT_USE
	@@${ECHO_MSG} "===>  Patching for ${PKGNAME}"
real-configure: _PORT_USE
	@@${ECHO_MSG} "===>  Configuring for ${PKGNAME}"
real-build: _PORT_USE
	@@${ECHO_MSG} "===>  Building for ${PKGNAME}"
real-install: run-depends lib-depends _PORT_USE _POST_INSTALL
	@@${ECHO_MSG} "===>  Installing for ${PKGNAME}"
.if !defined(NO_PKG_REGISTER) && !defined(FORCE_PKG_REGISTER)
	@@if [ -d ${PKG_DBDIR}/${PKGNAME} -o "X$$(ls -d ${PKG_DBDIR}/${PKGNAME:C/-[0-9].*//g}-* 2> /dev/null)" != "X" ]; then \
		echo "===>  ${PKGNAME} is already installed - perhaps an older version?"; \
		echo "      If so, you may wish to \`\`make deinstall'' and install"; \
		echo "      this port again by \`\`make reinstall'' to upgrade it properly."; \
		echo "      If you really wish to overwrite the old port of ${PKGNAME}"; \
		echo "      without deleting it first, set the variable \"FORCE_PKG_REGISTER\""; \
		echo "      in your environment or the \"make install\" command line."; \
		exit 1; \
	fi
d1623 20
a1642 10
	@@if [ `${SH} -c umask` != ${DEF_UMASK} ]; then \
		${ECHO_MSG} "===>  Warning: your umask is \"`${SH} -c umask`"\".; \
		${ECHO_MSG} "      If this is not desired, set it to an appropriate value"; \
		${ECHO_MSG} "      and install this port again by \`\`make reinstall''."; \
	fi
.if !defined(NO_MTREE)
	@@if [ `id -u` = 0 ]; then \
		if [ ! -f ${MTREE_FILE} ]; then \
			echo "Error: mtree file \"${MTREE_FILE}\" is missing."; \
			echo "Copy it from a suitable location (e.g., /usr/src/etc/mtree) and try again."; \
a1643 5
		else \
			if [ ! -d ${PREFIX} ]; then \
				mkdir -p ${PREFIX}; \
			fi; \
			${MTREE_CMD} ${MTREE_ARGS} ${PREFIX}/; \
a1644 3
	else \
		${ECHO_MSG} "Warning: not superuser, can't run mtree."; \
		${ECHO_MSG} "Become root and try again to ensure correct permissions."; \
d1646 4
a1650 3
	@@${_MAKE_COOKIE} ${_INSTALL_PRE_COOKIE}

real-package: _PORT_USE
a1651 14
# Empty pre-* and post-* targets, note we can't use .if !target()
# in the _PORT_USE macro

.for name in fetch extract patch configure build install package

.  if !target(pre-${name})
pre-${name}:
.  endif

.  if !target(post-${name})
post-${name}:
.  endif

.endfor
@


1.167
log
@make handles indented tests nicely.

So, we indent each test/loop level two spaces to let the structure
of bsd.port.mk be more visible.

Large indentations show that something blatantly unobvious/obfuscated is
going on.

Design decision made after consulting with brad@@.
We agree it's much clearer that way.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.166 2000/01/06 21:53:27 espie Exp $$
d1223 4
a1226 2
	@@mkdir -p ${_F:H}
	@@cd ${_F:H}; \
d1255 4
a1258 2
	@@mkdir -p ${_F:H}
	@@cd ${_F:H}; \
@


1.166
log
@MANNPREFIX and CATNPREFIX are no special cases.

.for lang in ${MANLANG} cannot be folded yet, as make still uses a very
primitive .for parser (should use an efficient variant of brk_string...)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.165 2000/01/01 15:43:34 brad Exp $$
d38 1
a38 1
.if ${_VERSION_NEEDED} > ${_VERSION} || \
d43 1
a43 1
.endif
d406 1
a406 1
.if ${NOCLEANDEPENDS:L}=="no"
d408 1
a408 1
.else
d410 1
a410 1
.endif
d588 1
a588 1
.if defined(USE_BZIP2)
d592 1
a592 1
.else
d595 1
a595 1
.endif
d601 1
a601 1
.if defined(USE_IMAKE) || defined(USE_X11)
d603 1
a603 1
.else
d605 1
a605 1
.endif
d614 1
a614 1
.if defined(OBJMACHINE)
d616 1
a616 1
.else
d618 1
a618 1
.endif
d682 1
a682 1
.if defined(NO_SHARED_LIBS) && exists(${PKGDIR}/PLIST.noshared)
d684 1
a684 1
.else
d686 1
a686 1
.endif
d695 1
a695 1
.if exists(${PKGDIR}/INSTALL)
d697 2
a698 2
.endif
.if exists(${PKGDIR}/DEINSTALL)
d700 2
a701 2
.endif
.if exists(${PKGDIR}/REQ)
d703 2
a704 2
.endif
.if exists(${PKGDIR}/MESSAGE)
d706 2
a707 2
.endif
.if !defined(NO_MTREE)
d709 1
a709 1
.endif
d717 1
a717 1
.if defined(MOTIF_STATIC)
d719 1
a719 1
.else
d721 1
a721 1
.endif
d809 1
a809 1
.if defined(MASTER_SITES${_I})
d811 1
a811 1
.if !defined(MASTER_SITE_OVERRIDE)
d813 1
a813 1
.else
d815 3
a817 3
.endif
.endif
.if defined(PATCH_SITES${_I})
d819 1
a819 1
.if !defined(MASTER_SITE_OVERRIDE)
d821 1
a821 1
.else
d823 2
a824 2
.endif
.endif
d834 1
a834 1
.if defined(FETCH_SYMLINK_DISTFILES)
d837 1
a837 1
.else
d840 1
a840 1
.endif
d844 1
a844 1
.if defined(FETCH_SYMLINK_DISTFILES)
d846 1
a846 1
.else
d848 1
a848 1
.endif
d861 1
a861 1
.if defined(SUPDISTFILES)
d864 2
a865 2
.endif
.if defined(SUPPATCHFILES)
d868 1
a868 1
.endif
d874 1
a874 1
.for __TMP in ${IGNOREFILES}
d876 1
a876 1
.endfor
d953 2
a954 2
.for sect in 1 2 3 4 5 6 7 8 9 L N
.if defined(MAN${sect})
d956 2
a957 2
.endif
.if defined(CAT${sect})
d959 2
a960 2
.endif
.endfor
d989 1
a989 1
.if (defined(IS_INTERACTIVE) && defined(BATCH))
d991 1
a991 1
.elif (!defined(IS_INTERACTIVE) && defined(INTERACTIVE))
d993 1
a993 1
.elif (defined(REQUIRES_MOTIF) && !defined(HAVE_MOTIF))
d995 1
a995 1
.elif (defined(MOTIF_ONLY) && !defined(REQUIRES_MOTIF))
d997 1
a997 1
.elif (defined(NO_CDROM) && defined(FOR_CDROM))
d999 1
a999 1
.elif (defined(RESTRICTED) && defined(NO_RESTRICTED))
d1001 1
a1001 1
.elif ((defined(USE_IMAKE) || defined(USE_X11)) && !exists(${X11BASE}))
d1003 1
a1003 1
.elif defined(BROKEN)
d1005 3
a1007 3
.elif defined(ONLY_FOR_ARCHS)
.for __ARCH in ${MACHINE_ARCH} ${ARCH}
.if !empty(ONLY_FOR_ARCHS:M${__ARCH})
d1009 4
a1012 4
.endif
.endfor
.if !defined(_ARCH_OK)
.if ${MACHINE_ARCH} == "${ARCH}"
d1014 1
a1014 1
.else
d1016 4
a1019 4
.endif
.endif
.elif defined(COMES_WITH)
.if ( ${OPSYS_VER} >= ${COMES_WITH} )
d1021 2
a1022 2
.endif
.endif
d1029 1
a1029 1
.if !defined(IGNORE_SILENT)
d1031 1
a1031 1
.endif
d1038 1
a1038 1
.if ! (defined(NO_CHECKSUM) || defined(NO_EXTRACT))
d1087 1
a1087 1
.endif
d1096 1
a1096 1
.if defined(ALL_HOOK)
d1105 1
a1105 1
.else
d1107 1
a1107 1
.endif
d1117 1
a1117 1
.if make(reinstall)
d1119 1
a1119 1
.else
d1121 1
a1121 1
.endif
d1199 1
a1199 1
.if !defined(IGNORE_SILENT)
d1201 1
a1201 1
.endif
d1221 1
a1221 1
.for _F in ${_DISTFILES:S@@^@@${FULLDISTDIR}/@@}
d1248 1
a1248 1
.endfor
d1250 2
a1251 2
.if defined(PATCHFILES)
.for _F in ${_PATCHFILES:S@@^@@${FULLDISTDIR}/@@}
d1278 1
a1278 1
.endfor
d1280 1
a1280 1
.endif	# defined(PATCHFILES)
d1312 2
a1313 2
.if !defined(NO_WRKDIR)
.if defined(WRKOBJDIR)
d1322 1
a1322 1
.else
d1327 2
a1328 2
.endif
.endif
d1335 2
a1336 2
.if !defined(NO_WRKDIR)
.if defined(WRKOBJDIR)
d1345 1
a1345 1
.else
d1348 2
a1349 2
.endif
.endif
d1363 1
a1363 1
.if defined(PATCHFILES)
d1379 1
a1379 1
.endif
d1418 1
a1418 1
.if defined(HAS_CONFIGURE)
d1426 2
a1427 2
.endif
.if defined(USE_IMAKE)
d1429 1
a1429 1
.endif
d1521 1
a1521 1
.if defined(MANCOMPRESSED) && defined(NOMANCOMPRESS)
d1523 1
a1523 1
.for manpage in ${_MANPAGES} ${_CATPAGES}
d1525 2
a1526 2
.endfor
.elif !defined(MANCOMPRESSED) && !defined(NOMANCOMPRESS)
d1528 1
a1528 1
.for manpage in ${_MANPAGES} ${_CATPAGES}
d1537 2
a1538 2
.endfor
.endif
d1616 1
a1616 1
.if !target(pre-${name})
d1618 1
a1618 1
.endif
d1620 1
a1620 1
.if !target(post-${name})
d1622 1
a1622 1
.endif
d1669 1
a1669 1
.if ${CLEANDEPENDS:L}=="yes"
d1671 1
a1671 1
.endif
d1673 2
a1674 2
.if !defined(NO_WRKDIR)
.if  defined(WRKOBJDIR)
d1677 1
a1677 1
.else
d1685 2
a1686 2
.endif
.else
d1688 1
a1688 1
.endif
d1701 1
a1701 1
.if defined(DIST_SUBDIR)
d1703 1
a1703 1
.endif
d1723 1
a1723 1
.if ${RECURSIVE_FETCH_LIST:L} != "no"
d1728 1
a1728 1
.endif # ${RECURSIVE_FETCH_LIST} != "NO"
d1759 1
a1759 1
.if defined(PATCHFILES)
d1784 1
a1784 1
.endif # defined(PATCHFILES)
d1818 1
a1818 1
.if (${FULL_PACKAGE_NAME:L} == "yes")
d1820 1
a1820 1
.else
d1822 1
a1822 1
.endif 
d1853 1
a1853 1
.for _DEP in fetch build run
d1855 2
a1856 2
.if defined(${_DEP:U}_DEPENDS)
.if !defined(NO_DEPENDS)
d1896 3
a1898 3
.endif
.endif
.endfor
d1901 3
a1903 3
.if defined(LIB_DEPENDS)
.if !defined(NO_DEPENDS)
.if defined(NO_SHARED_LIBS)
d1930 1
a1930 1
.else
d1957 3
a1959 3
.endif
.endif
.endif
d1962 2
a1963 2
.if defined(DEPENDS)
.if !defined(NO_DEPENDS)
d1982 2
a1983 2
.endif
.endif
d2005 1
a2005 1
.if defined(_ALWAYS_DEP) || defined(_BUILD_DEP) || defined(_RUN_DEP)
d2013 1
a2013 1
.endif
d2092 1
a2092 1
.if defined(_ALWAYS_DEP) || defined(_BUILD_DEP) || target(depends-list)
d2096 1
a2096 1
.endif
d2101 1
a2101 1
.if defined(_ALWAYS_DEP) || defined(_RUN_DEP) || target(package-depends)
d2105 1
a2105 1
.endif
d2111 1
a2111 1
.if defined(_ALWAYS_DEP) || defined(_BUILD_DEP) || defined(_RUN_DEP)
d2125 1
a2125 1
.else
d2127 1
a2127 1
.endif
d2132 1
a2132 1
.if defined(_ALWAYS_DEP) || defined(_BUILD_DEP)
d2145 1
a2145 1
.endif
d2151 1
a2151 1
.if defined(_ALWAYS_DEP) || defined(_RUN_DEP)
d2165 1
a2165 1
.else
d2167 1
a2167 1
.endif
d2172 1
a2172 1
.if defined(_ALWAYS_DEP) || defined(_RUN_DEP)
d2185 1
a2185 1
.endif
d2224 1
a2224 1
.if defined(FORCE_PKG_REGISTER)
d2226 1
a2226 1
.endif
@


1.165
log
@automagically -> automatically
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.164 1999/12/24 00:27:58 espie Exp $$
d944 1
a944 1
.for sect in 1 2 3 4 5 6 7 8 9
a947 4
MANLPREFIX?=	${MANPREFIX}
MANNPREFIX?=	${MANPREFIX}
CATLPREFIX?=	${CATPREFIX}
CATNPREFIX?=	${CATPREFIX}
@


1.164
log
@Clean do-fetch target: it can depend on the files it's trying to fetch.
Plays some make trickery to get all details correct.
Numerous benefits:
- make automatically handles badly fetched files,
- possible extension to special-case *each* file fetch,
- can be easily parallelized.

Similar rules for fetch-list soon coming.

Also simplify CDROM handling while we're at it, no need for 10 knobs
when one suffices.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.163 1999/12/21 21:43:37 espie Exp $$
d318 1
a318 1
# CAT<sect> for the compressed pages.  The pages will then be automagically
@


1.163
log
@Wrap MASTER_SITESn/PATCH_SITESn into a .for loop.
Don't bother computing MASTER_SITESn/PATCH_SITESn if they're not
set in the first place...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.162 1999/12/20 19:02:37 espie Exp $$
d843 10
d1223 31
a1253 46
do-fetch:
	@@mkdir -p ${FULLDISTDIR}
	@@cd ${FULLDISTDIR}; \
	 for fullfile in ${DISTFILES}; do \
	 	file=`echo $$fullfile|sed -e 's,:[0-9]$$,,'`; \
		if [ ! -f $$file -a ! -f `basename $$file` ]; then \
			if [ -L $$file -o -L `basename $$file` ]; then \
				echo ">> ${FULLDISTDIR}/$$file is a broken symlink."; \
				echo ">> Perhaps a filesystem (most likely a CD) isn't mounted?"; \
				echo ">> Please correct this problem and try again."; \
				exit 1; \
			fi ; \
			if [ ! -z ${CDROM_COPY} ]; then \
				if ${CDROM_COPY} ${CDROM_OPT} ${CDROM_SITE}/$$file .; then \
					continue; \
				fi ; \
			fi ; \
			${ECHO_MSG} ">> $$file doesn't seem to exist on this system."; \
			if [ ! -w ${FULLDISTDIR}/. ]; then \
				${ECHO_MSG} ">> Can't download to ${FULLDISTDIR} (permission denied?)."; \
				exit 1; \
			fi; \
			case $$fullfile in \
				*:0) sites_list="${MASTER_SITES0}";; \
				*:1) sites_list="${MASTER_SITES1}";; \
				*:2) sites_list="${MASTER_SITES2}";; \
				*:3) sites_list="${MASTER_SITES3}";; \
				*:4) sites_list="${MASTER_SITES4}";; \
				*:5) sites_list="${MASTER_SITES5}";; \
				*:6) sites_list="${MASTER_SITES6}";; \
				*:7) sites_list="${MASTER_SITES7}";; \
				*:8) sites_list="${MASTER_SITES8}";; \
				*:9) sites_list="${MASTER_SITES9}";; \
				*)   sites_list="${MASTER_SITES}";; \
			esac; \
			for site in $$sites_list; do \
			    ${ECHO_MSG} ">> Attempting to fetch from $${site}."; \
				if ${FETCH_CMD} ${FETCH_BEFORE_ARGS} $${site}$${file} ${FETCH_AFTER_ARGS}; then \
					continue 2; \
				fi \
			done; \
			echo ">> Couldn't fetch it - please try to retrieve this";\
			echo ">> port manually into ${FULLDISTDIR} and try again."; \
			exit 1; \
	    fi \
	 done
d1255 32
a1286 37
	@@cd ${FULLDISTDIR}; \
	 for fullfile in ${PATCHFILES}; do \
	 	file=`echo $$fullfile|sed -e 's,:[0-9]$$,,'`; \
		if [ ! -f $$file -a ! -f `basename $$file` ]; then \
			if [ -L $$file -o -L `basename $$file` ]; then \
				echo ">> ${FULLDISTDIR}/$$file is a broken symlink."; \
				echo ">> Perhaps a filesystem (most likely a CD) isn't mounted?"; \
				echo ">> Please correct this problem and try again."; \
				exit 1; \
			fi ; \
			${ECHO_MSG} ">> $$file doesn't seem to exist on this system."; \
			case $$fullfile in \
				*:0) sites_list="${PATCH_SITES0}";; \
				*:1) sites_list="${PATCH_SITES1}";; \
				*:2) sites_list="${PATCH_SITES2}";; \
				*:3) sites_list="${PATCH_SITES3}";; \
				*:4) sites_list="${PATCH_SITES4}";; \
				*:5) sites_list="${PATCH_SITES5}";; \
				*:6) sites_list="${PATCH_SITES6}";; \
				*:7) sites_list="${PATCH_SITES7}";; \
				*:8) sites_list="${PATCH_SITES8}";; \
				*:9) sites_list="${PATCH_SITES9}";; \
				*)   sites_list="${PATCH_SITES}";; \
			esac; \
			for site in $$sites_list; do \
			    ${ECHO_MSG} ">> Attempting to fetch from $${site}."; \
				if ${FETCH_CMD} ${FETCH_BEFORE_ARGS} $${site}$${file} ${FETCH_AFTER_ARGS}; then \
					continue 2; \
				fi \
			done; \
			echo ">> Couldn't fetch it - please try to retrieve this";\
			echo ">> port manually into ${FULLDISTDIR} and try again."; \
			exit 1; \
	    fi \
	 done
.endif
.endif
@


1.162
log
@Deprecate DO_NADA
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.161 1999/12/20 00:07:17 espie Exp $$
a793 22
MASTER_SITES0?=
MASTER_SITES1?=
MASTER_SITES2?=
MASTER_SITES3?=
MASTER_SITES4?=
MASTER_SITES5?=
MASTER_SITES6?=
MASTER_SITES7?=
MASTER_SITES8?=
MASTER_SITES9?=
PATCH_SITES?=
PATCH_SITES0?=
PATCH_SITES1?=
PATCH_SITES2?=
PATCH_SITES3?=
PATCH_SITES4?=
PATCH_SITES5?=
PATCH_SITES6?=
PATCH_SITES7?=
PATCH_SITES8?=
PATCH_SITES9?=

d796 1
a796 10
_MASTER_SITES0:=	${MASTER_SITES0:S@@%SUBDIR%@@${MASTER_SITE_SUBDIR}@@}
_MASTER_SITES1:=	${MASTER_SITES1:S@@%SUBDIR%@@${MASTER_SITE_SUBDIR}@@}
_MASTER_SITES2:=	${MASTER_SITES2:S@@%SUBDIR%@@${MASTER_SITE_SUBDIR}@@}
_MASTER_SITES3:=	${MASTER_SITES3:S@@%SUBDIR%@@${MASTER_SITE_SUBDIR}@@}
_MASTER_SITES4:=	${MASTER_SITES4:S@@%SUBDIR%@@${MASTER_SITE_SUBDIR}@@}
_MASTER_SITES5:=	${MASTER_SITES5:S@@%SUBDIR%@@${MASTER_SITE_SUBDIR}@@}
_MASTER_SITES6:=	${MASTER_SITES6:S@@%SUBDIR%@@${MASTER_SITE_SUBDIR}@@}
_MASTER_SITES7:=	${MASTER_SITES7:S@@%SUBDIR%@@${MASTER_SITE_SUBDIR}@@}
_MASTER_SITES8:=	${MASTER_SITES8:S@@%SUBDIR%@@${MASTER_SITE_SUBDIR}@@}
_MASTER_SITES9:=	${MASTER_SITES9:S@@%SUBDIR%@@${MASTER_SITE_SUBDIR}@@}
a797 11
_PATCH_SITES0:=		${PATCH_SITES0:S@@%SUBDIR%@@${PATCH_SITE_SUBDIR}@@}
_PATCH_SITES1:=		${PATCH_SITES1:S@@%SUBDIR%@@${PATCH_SITE_SUBDIR}@@}
_PATCH_SITES2:=		${PATCH_SITES2:S@@%SUBDIR%@@${PATCH_SITE_SUBDIR}@@}
_PATCH_SITES3:=		${PATCH_SITES3:S@@%SUBDIR%@@${PATCH_SITE_SUBDIR}@@}
_PATCH_SITES4:=		${PATCH_SITES4:S@@%SUBDIR%@@${PATCH_SITE_SUBDIR}@@}
_PATCH_SITES5:=		${PATCH_SITES5:S@@%SUBDIR%@@${PATCH_SITE_SUBDIR}@@}
_PATCH_SITES6:=		${PATCH_SITES6:S@@%SUBDIR%@@${PATCH_SITE_SUBDIR}@@}
_PATCH_SITES7:=		${PATCH_SITES7:S@@%SUBDIR%@@${PATCH_SITE_SUBDIR}@@}
_PATCH_SITES8:=		${PATCH_SITES8:S@@%SUBDIR%@@${PATCH_SITE_SUBDIR}@@}
_PATCH_SITES9:=		${PATCH_SITES9:S@@%SUBDIR%@@${PATCH_SITE_SUBDIR}@@}

a801 10
MASTER_SITES0:=	${_MASTER_SITES0} ${MASTER_SITE_BACKUP}
MASTER_SITES1:=	${_MASTER_SITES1} ${MASTER_SITE_BACKUP}
MASTER_SITES2:=	${_MASTER_SITES2} ${MASTER_SITE_BACKUP}
MASTER_SITES3:=	${_MASTER_SITES3} ${MASTER_SITE_BACKUP}
MASTER_SITES4:=	${_MASTER_SITES4} ${MASTER_SITE_BACKUP}
MASTER_SITES5:=	${_MASTER_SITES5} ${MASTER_SITE_BACKUP}
MASTER_SITES6:=	${_MASTER_SITES6} ${MASTER_SITE_BACKUP}
MASTER_SITES7:=	${_MASTER_SITES7} ${MASTER_SITE_BACKUP}
MASTER_SITES8:=	${_MASTER_SITES8} ${MASTER_SITE_BACKUP}
MASTER_SITES9:=	${_MASTER_SITES9} ${MASTER_SITE_BACKUP}
a802 10
PATCH_SITES0:=	${_PATCH_SITES0} ${MASTER_SITE_BACKUP}
PATCH_SITES1:=	${_PATCH_SITES1} ${MASTER_SITE_BACKUP}
PATCH_SITES2:=	${_PATCH_SITES2} ${MASTER_SITE_BACKUP}
PATCH_SITES3:=	${_PATCH_SITES3} ${MASTER_SITE_BACKUP}
PATCH_SITES4:=	${_PATCH_SITES4} ${MASTER_SITE_BACKUP}
PATCH_SITES5:=	${_PATCH_SITES5} ${MASTER_SITE_BACKUP}
PATCH_SITES6:=	${_PATCH_SITES6} ${MASTER_SITE_BACKUP}
PATCH_SITES7:=	${_PATCH_SITES7} ${MASTER_SITE_BACKUP}
PATCH_SITES8:=	${_PATCH_SITES8} ${MASTER_SITE_BACKUP}
PATCH_SITES9:=	${_PATCH_SITES9} ${MASTER_SITE_BACKUP}
a804 10
MASTER_SITES0:=	${MASTER_SITE_OVERRIDE} ${_MASTER_SITES0}
MASTER_SITES1:=	${MASTER_SITE_OVERRIDE} ${_MASTER_SITES1}
MASTER_SITES2:=	${MASTER_SITE_OVERRIDE} ${_MASTER_SITES2}
MASTER_SITES3:=	${MASTER_SITE_OVERRIDE} ${_MASTER_SITES3}
MASTER_SITES4:=	${MASTER_SITE_OVERRIDE} ${_MASTER_SITES4}
MASTER_SITES5:=	${MASTER_SITE_OVERRIDE} ${_MASTER_SITES5}
MASTER_SITES6:=	${MASTER_SITE_OVERRIDE} ${_MASTER_SITES6}
MASTER_SITES7:=	${MASTER_SITE_OVERRIDE} ${_MASTER_SITES7}
MASTER_SITES8:=	${MASTER_SITE_OVERRIDE} ${_MASTER_SITES8}
MASTER_SITES9:=	${MASTER_SITE_OVERRIDE} ${_MASTER_SITES9}
a805 10
PATCH_SITES0:=	${MASTER_SITE_OVERRIDE} ${_PATCH_SITES0}
PATCH_SITES1:=	${MASTER_SITE_OVERRIDE} ${_PATCH_SITES1}
PATCH_SITES2:=	${MASTER_SITE_OVERRIDE} ${_PATCH_SITES2}
PATCH_SITES3:=	${MASTER_SITE_OVERRIDE} ${_PATCH_SITES3}
PATCH_SITES4:=	${MASTER_SITE_OVERRIDE} ${_PATCH_SITES4}
PATCH_SITES5:=	${MASTER_SITE_OVERRIDE} ${_PATCH_SITES5}
PATCH_SITES6:=	${MASTER_SITE_OVERRIDE} ${_PATCH_SITES6}
PATCH_SITES7:=	${MASTER_SITE_OVERRIDE} ${_PATCH_SITES7}
PATCH_SITES8:=	${MASTER_SITE_OVERRIDE} ${_PATCH_SITES8}
PATCH_SITES9:=	${MASTER_SITE_OVERRIDE} ${_PATCH_SITES9}
d807 20
@


1.161
log
@Clean up _PORT_USE, so that it does not depend on what's being made.

fetch can depend on real-fetch directly, since it does not involve
cookies.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.160 1999/12/19 23:48:36 espie Exp $$
d767 1
a774 4
# How to do nothing.  Override if you, for some strange reason, would rather
# do something.
DO_NADA?=		true

d1080 7
a1086 5
.if defined(IGNORE)
.if defined(IGNORE_SILENT)
IGNORECMD=	${DO_NADA}
.else
IGNORECMD=	${ECHO_MSG} "===>  ${PKGNAME} ${IGNORE}."
a1087 2
.endif
.endif		# NO_IGNORE
d1089 1
a1089 22
.if defined(IGNORECMD)
fetch:
	@@${IGNORECMD}
checksum:
	@@${IGNORECMD}
extract:
	@@${IGNORECMD}
patch:
	@@${IGNORECMD}
configure:
	@@${IGNORECMD}
all:
	@@${IGNORECMD}
build:
	@@${IGNORECMD}
install:
	@@${IGNORECMD}
uninstall deinstall:
	@@${IGNORECMD}
package:
	@@${IGNORECMD}
.else # IGNORECMD
d1094 1
a1094 3
.if defined(NO_CHECKSUM) || defined(NO_EXTRACT)
	${DO_NADA}
.else
d1187 1
a1187 3
.if defined(NO_CHECKSUM) || defined(NO_EXTRACT)
	@@${DO_NADA}
.else
d1200 1
a1200 3
.if defined(NO_CHECKSUM) || defined(NO_EXTRACT)
	@@${DO_NADA}
.else
a1693 1
	@@${DO_NADA}
a1697 1
	@@${DO_NADA}
a1740 1
	@@${DO_NADA}
a1768 1
	@@${DO_NADA}
a1972 2
.else
	@@${DO_NADA}
a2034 2
.else
	@@${DO_NADA}
a2058 2
.else
	@@${DO_NADA}
d2104 1
a2104 3
.if defined(NO_DESCRIBE) 
	@@${DO_NADA}
.else
@


1.160
log
@Changes tests of IGNORE/NO_IGNORE so that
`main' targets (checksum, fetch, extract...) are always defined.

This removes the possibility of erroneously overriding them.

Dependency fix:
- move the NO_xxx test to the _xxx_COOKIE target, so that each cookie
is built at exactly one point in the Makefile.
- separate phony targets from the real thing:
`top' dummy targets (e.g., build)  depend on the corresponding cookie,
cookies depend on each others and each cookie does trigger the real targett
(unless NO_xxx) before creating the cookie.

This does repair parallel makes, which were completely broken.

Might induce problems into odd-balls ports, but I couldn't get anyone to
comment on this patch after a week on ports@@ and tech@@.

Maybe, if something breaks, I'll finally get some comments...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.159 1999/12/11 16:14:20 espie Exp $$
d1115 1
a1115 2
fetch:
	@@cd ${.CURDIR} && make real-fetch
d1258 3
a1612 36
.if make(real-install)
.if !defined(NO_PKG_REGISTER) && !defined(FORCE_PKG_REGISTER)
	@@if [ -d ${PKG_DBDIR}/${PKGNAME} -o "X$$(ls -d ${PKG_DBDIR}/${PKGNAME:C/-[0-9].*//g}-* 2> /dev/null)" != "X" ]; then \
		echo "===>  ${PKGNAME} is already installed - perhaps an older version?"; \
		echo "      If so, you may wish to \`\`make deinstall'' and install"; \
		echo "      this port again by \`\`make reinstall'' to upgrade it properly."; \
		echo "      If you really wish to overwrite the old port of ${PKGNAME}"; \
		echo "      without deleting it first, set the variable \"FORCE_PKG_REGISTER\""; \
		echo "      in your environment or the \"make install\" command line."; \
		exit 1; \
	fi
.endif
	@@if [ `${SH} -c umask` != ${DEF_UMASK} ]; then \
		${ECHO_MSG} "===>  Warning: your umask is \"`${SH} -c umask`"\".; \
		${ECHO_MSG} "      If this is not desired, set it to an appropriate value"; \
		${ECHO_MSG} "      and install this port again by \`\`make reinstall''."; \
	fi
.if !defined(NO_MTREE)
	@@if [ `id -u` = 0 ]; then \
		if [ ! -f ${MTREE_FILE} ]; then \
			echo "Error: mtree file \"${MTREE_FILE}\" is missing."; \
			echo "Copy it from a suitable location (e.g., /usr/src/etc/mtree) and try again."; \
			exit 1; \
		else \
			if [ ! -d ${PREFIX} ]; then \
				mkdir -p ${PREFIX}; \
			fi; \
			${MTREE_CMD} ${MTREE_ARGS} ${PREFIX}/; \
		fi; \
	else \
		${ECHO_MSG} "Warning: not superuser, can't run mtree."; \
		${ECHO_MSG} "Become root and try again to ensure correct permissions."; \
	fi
.endif
	@@${_MAKE_COOKIE} ${_INSTALL_PRE_COOKIE}
.endif
d1624 2
a1625 1
.if make(real-install) 
a1651 4
.endif
.if make(real-patch) && !defined(PATCH_CHECK_ONLY) && defined(USE_AUTOCONF)
	@@cd ${AUTOCONF_DIR} && ${SETENV} ${AUTOCONF_ENV} ${AUTOCONF}
.endif
d1678 1
a1678 1
real-install: run-depends lib-depends _PORT_USE
d1680 35
@


1.159
log
@Use IFS to parse PATH instead of ludicrous echo $PATH|tr
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.158 1999/12/08 17:11:09 espie Exp $$
d1089 4
d1113 65
a1177 2
.endif # IGNORE
.endif # !NO_IGNORE
d1188 2
d1192 6
a1197 3
.if !target(all)
all: build
.endif
d1208 1
a1208 1
# The following are used to create easy dummy targets for
a1209 4
# They still check to see if the target exists, and if so don't
# do anything, since you might want to set this globally for a
# group of ports in a Makefile.inc, but still be able to
# override from an individual Makefile.
d1213 2
a1214 4
.if defined(NO_CHECKSUM) 
.for _TARGET in makesum addsum
.if !target(${_TARGET})
${_TARGET}: fetch-all
d1216 10
d1227 3
a1229 3
.endfor
.if !target(checksum)
checksum: fetch
d1231 16
d1248 4
d1253 1
d1255 3
a1257 8
# Disable extract
.if defined(NO_EXTRACT) && !target(extract)
extract: 
	@@${_MAKE_COOKIE} ${_EXTRACT_COOKIE}
checksum: fetch 
	@@${DO_NADA}
makesum addsum: fetch-all
	@@${DO_NADA}
d1259 1
d1261 3
a1263 4
# Disable patch
.if defined(NO_PATCH) && !target(patch)
patch: extract
	@@${_MAKE_COOKIE} ${_PATCH_COOKIE}
d1265 1
d1267 3
a1269 4
# Disable configure
.if defined(NO_CONFIGURE) && !target(configure)
configure: patch
	@@${_MAKE_COOKIE} ${_CONFIGURE_COOKIE}
d1271 1
d1273 3
a1275 4
# Disable build
.if defined(NO_BUILD) && !target(build)
build: configure
	@@${_MAKE_COOKIE} ${_BUILD_COOKIE}
a1276 4

# Disable install
.if defined(NO_INSTALL) && !target(install)
install: build
a1277 1
.endif
d1279 3
a1281 5
# Disable package
.if defined(NO_PACKAGE) && !target(package)
package:
.if defined(IGNORE_SILENT)
	@@${DO_NADA}
d1283 1
d1287 3
a1290 5
# Disable describe
.if defined(NO_DESCRIBE) && !target(describe)
describe:
	@@${DO_NADA}
.endif
a1627 2
.endif
.if make(real-install)
d1658 2
a1659 1
.if make(real-install) && (defined(_MANPAGES) || defined(_CATPAGES))
d1679 1
a1679 1
.if make(real-install) && exists(${PKGDIR}/MESSAGE)
d1682 1
a1682 1
.if make(real-install) && !defined(NO_PKG_REGISTER)
a1684 2
.if make(real-extract)
	@@${_MAKE_COOKIE} ${_EXTRACT_COOKIE}
d1686 1
a1686 2
.if make(real-patch) && !defined(PATCH_CHECK_ONLY)
.if defined(USE_AUTOCONF)
a1688 14
	@@${_MAKE_COOKIE} ${_PATCH_COOKIE}
.endif
.if make(real-configure)
	@@${_MAKE_COOKIE} ${_CONFIGURE_COOKIE}
.endif
.if make(real-install)
	@@${_MAKE_COOKIE} ${_INSTALL_COOKIE}
.endif
.if make(real-build)
	@@${_MAKE_COOKIE} ${_BUILD_COOKIE}
.endif
.if make(real-package) && !defined(PACKAGE_NOINSTALL)
	@@${_MAKE_COOKIE} ${_PACKAGE_COOKIE}
.endif
a1698 4
.if !target(fetch)
fetch:
	@@cd ${.CURDIR} && make real-fetch
.endif
a1703 38

.if !target(extract)
extract: ${_EXTRACT_COOKIE}
.endif

.if !target(patch)
patch: extract ${_PATCH_COOKIE}
.endif

.if !target(configure)
configure: patch ${_CONFIGURE_COOKIE}
.endif

.if !target(build)
build: configure ${_BUILD_COOKIE}
.endif

.if !target(install)
install: build ${_INSTALL_COOKIE}
.endif

.if !target(package)
package: install ${_PACKAGE_COOKIE}
.endif

${_EXTRACT_COOKIE}: 
	@@cd ${.CURDIR} && make checksum real-extract
${_PATCH_COOKIE}:
	@@cd ${.CURDIR} && make real-patch
${_CONFIGURE_COOKIE}:
	@@cd ${.CURDIR} && make real-configure
${_BUILD_COOKIE}:
	@@cd ${.CURDIR} && make real-build
${_INSTALL_COOKIE}:
	@@cd ${.CURDIR} && make real-install
${_PACKAGE_COOKIE}:
	@@cd ${.CURDIR} && make real-package

a1898 86
# Checksumming utilities

.if !target(makesum)
makesum: fetch-all
	@@mkdir -p ${FILESDIR} && rm -f ${CHECKSUM_FILE}
	@@cd ${DISTDIR} && \
		for cipher in ${_CIPHERS}; do \
			$$cipher ${_CKSUMFILES} >> ${CHECKSUM_FILE}; \
	 done
	@@for file in ${_IGNOREFILES}; do \
		echo "MD5 ($$file) = IGNORE" >> ${CHECKSUM_FILE}; \
	done
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE} 
.endif

.if !target(addsum)
addsum: fetch-all
	@@mkdir -p ${FILESDIR} && touch ${CHECKSUM_FILE}
	@@cd ${DISTDIR} && \
	 	for cipher in ${_CIPHERS}; do \
			$$cipher ${_CKSUMFILES} >> ${CHECKSUM_FILE}; \
	 done
	@@for file in ${_IGNOREFILES}; do \
		echo "MD5 ($$file) = IGNORE" >> ${CHECKSUM_FILE}; \
	done
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE} 
	@@if [ `sed -e 's/\=.*$$//' ${CHECKSUM_FILE} | uniq -d | wc -l` -ne 0 ]; then \
		echo "Inconsistent checksum in ${CHECKSUM_FILE}"; \
		exit 1; \
	else \
		${ECHO_MSG} "${CHECKSUM_FILE} updated okay, don't forget to remove cruft"; \
	fi
.endif

.if !target(checksum)
checksum: fetch
	@@if [ ! -f ${CHECKSUM_FILE} ]; then \
	  ${ECHO_MSG} ">> No checksum file."; \
	else \
	  cd ${DISTDIR}; OK=true; \
		for file in ${_CKSUMFILES}; do \
		  for cipher in ${PREFERRED_CIPHERS}; do \
			set -- `grep -i "^$$cipher ($$file)" ${CHECKSUM_FILE}` && break || \
			  ${ECHO_MSG} ">> No $$cipher checksum recorded for $$file."; \
		  done; \
		  case "$$4" in \
			"") \
			  ${ECHO_MSG} ">> No checksum recorded for $$file."; \
			  OK=false;; \
			"IGNORE") \
			  echo ">> Checksum for $$file is set to IGNORE in md5 file even though"; \
			  echo "   the file is not in the "'$$'"{IGNOREFILES} list."; \
			  OK=false;; \
			*) \
			  CKSUM=`$$cipher < $$file`; \
			  case "$$CKSUM" in \
			  	"$$4") \
				  ${ECHO_MSG} ">> Checksum OK for $$file. ($$cipher)";; \
				*) \
				  echo ">> Checksum mismatch for $$file. ($$cipher)"; \
				  OK=false;; \
			  esac;; \
		  esac; \
		done; \
		set --; \
		for file in ${_IGNOREFILES}; do \
		  set -- `grep "($$file)" ${CHECKSUM_FILE}` || \
			  { echo ">> No checksum recorded for $$file, file is in "'$$'"{IGNOREFILES} list." && \
			  OK=false; } ; \
		  case "$$4" in \
		  	"IGNORE") : ;; \
			*) \
			  echo ">> Checksum for $$file is not set to IGNORE in md5 file even though"; \
			  echo "   the file is in the "'$$'"{IGNOREFILES} list."; \
			  OK=false;; \
		  esac; \
		done; \
		if ! $$OK; then \
		  echo "Make sure the Makefile and checksum file (${CHECKSUM_FILE})"; \
		  echo "are up to date.  If you want to override this check, type"; \
		  echo "\"make NO_CHECKSUM=Yes [other args]\"."; \
		  exit 1; \
		fi ; \
  fi
.endif

a1904 1
.if !target(plist)
a1908 1
.endif
a2144 1
.if !target(describe)
d2146 3
@


1.158
log
@Make cookie names internal to bsd.port.mk
Don't allow the user to override these. It's a major can of worms anyway.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.157 1999/12/08 17:00:15 espie Exp $$
d2052 1
a2052 1
			for d in `echo $$PATH | tr ':' ' '`; do \
d2057 1
a2057 1
			done; \
@


1.157
log
@Pass YACC to configure script.
Ensure reproducability of builds for autoconf ports: those would tend
to use bison by default otherwise.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.156 1999/12/03 17:37:33 espie Exp $$
d493 2
a494 2
EXTRACT_COOKIE?=	${WRKDIR}/.extract_done
PATCH_COOKIE?=		${WRKDIR}/.patch_done
d496 11
a506 11
CONFIGURE_COOKIE?=	${WRKBUILD}/.configure_done
INSTALL_PRE_COOKIE?=${WRKBUILD}/.install_started
INSTALL_COOKIE?=	${WRKBUILD}/.install_done
BUILD_COOKIE?=		${WRKBUILD}/.build_done
PACKAGE_COOKIE?=	${WRKBUILD}/.package_done
.else
CONFIGURE_COOKIE?=	${WRKDIR}/.configure_done
INSTALL_PRE_COOKIE?=${WRKDIR}/.install_started
INSTALL_COOKIE?=	${WRKDIR}/.install_done
BUILD_COOKIE?=		${WRKDIR}/.build_done
PACKAGE_COOKIE?=	${WRKDIR}/.package_done
d508 3
d1161 1
a1161 1
	@@${_MAKE_COOKIE} ${EXTRACT_COOKIE}
d1171 1
a1171 1
	@@${_MAKE_COOKIE} ${PATCH_COOKIE}
d1177 1
a1177 1
	@@${_MAKE_COOKIE} ${CONFIGURE_COOKIE}
d1183 1
a1183 1
	@@${_MAKE_COOKIE} ${BUILD_COOKIE}
d1189 1
a1189 1
	@@${_MAKE_COOKIE} ${INSTALL_COOKIE}
d1563 1
a1563 1
	@@${_MAKE_COOKIE} ${INSTALL_PRE_COOKIE}
d1603 1
a1603 1
	@@${_MAKE_COOKIE} ${EXTRACT_COOKIE}
d1609 1
a1609 1
	@@${_MAKE_COOKIE} ${PATCH_COOKIE}
d1612 1
a1612 1
	@@${_MAKE_COOKIE} ${CONFIGURE_COOKIE}
d1615 1
a1615 1
	@@${_MAKE_COOKIE} ${INSTALL_COOKIE}
d1618 1
a1618 1
	@@${_MAKE_COOKIE} ${BUILD_COOKIE}
d1621 1
a1621 1
	@@${_MAKE_COOKIE} ${PACKAGE_COOKIE}
d1644 1
a1644 1
extract: ${EXTRACT_COOKIE}
d1648 1
a1648 1
patch: extract ${PATCH_COOKIE}
d1652 1
a1652 1
configure: patch ${CONFIGURE_COOKIE}
d1656 1
a1656 1
build: configure ${BUILD_COOKIE}
d1660 1
a1660 1
install: build ${INSTALL_COOKIE}
d1664 1
a1664 1
package: install ${PACKAGE_COOKIE}
d1667 1
a1667 1
${EXTRACT_COOKIE}: 
d1669 1
a1669 1
${PATCH_COOKIE}:
d1671 1
a1671 1
${CONFIGURE_COOKIE}:
d1673 1
a1673 1
${BUILD_COOKIE}:
d1675 1
a1675 1
${INSTALL_COOKIE}:
d1677 1
a1677 1
${PACKAGE_COOKIE}:
d1727 1
a1727 1
	@@rm -f ${INSTALL_PRE_COOKIE} ${INSTALL_COOKIE} ${PACKAGE_COOKIE}
d1739 1
a1739 1
	@@rm -f ${INSTALL_COOKIE} ${PACKAGE_COOKIE}
d1774 1
a1774 1
	@@rm -f ${WRKDIR}/.*_started ${WRKDIR}/.*_done
d1970 1
a1970 1
	INSTALL_PRE_COOKIE=${INSTALL_PRE_COOKIE} \
d2011 1
a2011 1
	@@rm -f ${PACKAGE_COOKIE}
@


1.156
log
@Kill a few extraneous for loops.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.155 1999/12/03 17:30:47 espie Exp $$
a188 1
# USE_PERL5		- Port uses perl5 for building and running.
d195 2
d731 2
d1441 1
@


1.155
log
@Streamline checksum verification, remove awk use.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.154 1999/12/03 17:20:02 espie Exp $$
d38 2
a39 1

d41 3
a43 8
	@@if [ ${_VERSION_NEEDED} -gt ${_VERSION} -o \
			${_VERSION_NEEDED} -eq ${_VERSION} -a \
				${_REVISION_NEEDED} -gt ${_REVISION} ]; \
	then \
		echo "Need version ${NEED_VERSION} of bsd.port.mk"; \
		exit 1; \
    fi; 

d921 1
d923 3
a925 16
CKSUMFILES!=	\
	for file in ${ALLFILES}; do \
		ignore=0; \
		for tmp in ${IGNOREFILES}; do \
			if [ "$$file" = "$$tmp" ]; then \
				ignore=1; \
			fi; \
		done; \
		if [ "$$ignore" = 0 ]; then \
			echo "$$file"; \
		else \
			echo ""; \
		fi; \
	done
.else
CKSUMFILES=		${ALLFILES}
d930 2
a931 2
_CKSUMFILES?=	${CKSUMFILES:S/^/${DIST_SUBDIR}\//}
_IGNOREFILES?=	${IGNOREFILES:S/^/${DIST_SUBDIR}\//}
d933 2
a934 2
_CKSUMFILES?=	${CKSUMFILES}
_IGNOREFILES?=	${IGNOREFILES}
d1059 3
a1061 3
.for __ARCH in ${ONLY_FOR_ARCHS}
.if (${MACHINE_ARCH} == "${__ARCH}") || (${ARCH} == "${__ARCH}")
__ARCH_OK=	1
d1064 1
a1064 1
.if !defined(__ARCH_OK)
@


1.154
log
@Simplify cipher usage slightly
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.153 1999/12/03 16:54:42 brad Exp $$
d1921 1
a1921 1
		${ECHO_MSG} ">> No checksum file."; \
d1923 5
a1927 26
		cd ${DISTDIR}; OK=true; \
		  for file in ${_CKSUMFILES}; do \
			for cipher in ${PREFERRED_CIPHERS}; do \
				CKSUM2=`grep -i "^$$cipher ($$file)" ${CHECKSUM_FILE} | awk '{print $$4}'`; \
				if [ "$$CKSUM2" = "" ]; then \
					${ECHO_MSG} ">> No $$cipher checksum recorded for $$file."; \
				else \
					break; \
				fi; \
			done; \
			if [ "$$CKSUM2" = "" ]; then \
				${ECHO_MSG} ">> No checksum recorded for $$file."; \
				OK=false; \
			elif [ "$$CKSUM2" = "IGNORE" ]; then \
				echo ">> Checksum for $$file is set to IGNORE in md5 file even though"; \
				echo "   the file is not in the "'$$'"{IGNOREFILES} list."; \
				OK=false; \
			else \
				CKSUM=`$$cipher < $$file`; \
				if [ "$$CKSUM" = "$$CKSUM2" ]; then \
					${ECHO_MSG} ">> Checksum OK for $$file. ($$cipher)"; \
				else \
					echo ">> Checksum mismatch for $$file. ($$cipher)"; \
					OK=false; \
				fi; \
			fi; \
d1929 39
a1967 18
		  for file in ${_IGNOREFILES}; do \
			CKSUM2=`grep "($$file)" ${CHECKSUM_FILE} | awk '{print $$4}'`; \
			if [ "$$CKSUM2" = "" ]; then \
				echo ">> No checksum recorded for $$file, file is in "'$$'"{IGNOREFILES} list."; \
				OK=false; \
			elif [ "$$CKSUM2" != "IGNORE" ]; then \
				echo ">> Checksum for $$file is not set to IGNORE in md5 file even though"; \
				echo "   the file is in the "'$$'"{IGNOREFILES} list."; \
				OK=false; \
			fi; \
		  done; \
		  if ! $$OK; then \
			echo "Make sure the Makefile and checksum file (${CHECKSUM_FILE})"; \
			echo "are up to date.  If you want to override this check, type"; \
			echo "\"make NO_CHECKSUM=Yes [other args]\"."; \
			exit 1; \
		  fi ; \
	fi
@


1.153
log
@fix typo with recent ${AWK} -> awk change, needed a space added in
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.152 1999/12/03 14:57:12 espie Exp $$
d1888 1
a1888 2
	@@mkdir -p ${FILESDIR}
	@@if [ -f ${CHECKSUM_FILE} ]; then rm -f ${CHECKSUM_FILE}; fi
d1890 2
a1891 4
	 for file in ${_CKSUMFILES}; do \
	 	for cipher in ${_CIPHERS}; do \
			$$cipher $$file >> ${CHECKSUM_FILE}; \
		done; \
d1901 1
a1901 2
	@@mkdir -p ${FILESDIR}
	@@touch ${CHECKSUM_FILE}
d1903 2
a1904 4
	 for file in ${_CKSUMFILES}; do \
	 	for cipher in ${CIPHERS:R}; do \
			$$cipher $$file >> ${CHECKSUM_FILE}; \
		done; \
d1923 1
a1923 1
		cd ${DISTDIR}; OK="true"; \
d1935 1
a1935 1
				OK="false"; \
d1939 1
a1939 1
				OK="false"; \
d1946 1
a1946 1
					OK="false"; \
d1954 1
a1954 1
				OK="false"; \
d1958 1
a1958 1
				OK="false"; \
d1961 1
a1961 1
		  if [ "$$OK" != "true" ]; then \
@


1.152
log
@Introduce _MAKE_COOKIE, rename CIPHERS to _CIPHERS (and change it).
Deprecate a whole slew of unneeded variables.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.151 1999/12/03 14:24:39 espie Exp $$
d1932 1
a1932 1
				CKSUM2=`grep -i "^$$cipher ($$file)" ${CHECKSUM_FILE} | awk'{print $$4}'`; \
@


1.151
log
@Kill USE_EGCC/USE_EGXX, since 2.6 includes both as standard compilers.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.150 1999/12/01 22:39:44 ian Exp $$
d511 1
a517 30
# be paranoid about which ciphers we trust
.if exists(/sbin/md5)
MD5?=			/sbin/md5
.elif exists(/bin/md5)
MD5?=			/bin/md5
.elif exists(/usr/bin/md5)
MD5?=			/usr/bin/md5
.else
MD5?=			md5
.endif

.if exists(/sbin/sha1)
SHA1?=			/sbin/sha1
.elif exists(/bin/sha1)
SHA1?=			/bin/sha1
.elif exists(/usr/bin/sha1)
SHA1?=			/usr/bin/sha1
.else
SHA1?=			sha1
.endif

.if exists(/sbin/rmd160)
RMD160?=		/sbin/rmd160
.elif exists(/bin/rmd160)
RMD160?=		/bin/rmd160
.elif exists(/usr/bin/rmd160)
RMD160?=		/usr/bin/rmd160
.else
RMD160?=		rmd160
.endif
d524 1
a524 1
CIPHERS=		${SHA1}.SHA1 ${RMD160}.RMD160 ${MD5}.MD5 
d527 1
a527 1
PREFERRED_CIPHERS?= ${CIPHERS}
a544 2
TOUCH?=			/usr/bin/touch
TOUCH_FLAGS?=	-f
a723 3
AWK?=		/usr/bin/awk
BASENAME?=	/usr/bin/basename
CAT?=		/bin/cat
a725 7
CP?=		/bin/cp
DIRNAME?=	/usr/bin/dirname
ECHO?=		echo
EXPR?=		/bin/expr
FALSE?=		false
FILE?=		/usr/bin/file
GREP?=		/usr/bin/grep
a730 1
LN?=		/bin/ln
a731 6
MKDIR?=		/bin/mkdir -p
MV?=		/bin/mv
READLINK?=	/usr/bin/readlink
RM?=		/bin/rm
RMDIR?=		/bin/rmdir
SED?=		/usr/bin/sed
a732 1
FIND?=		/usr/bin/find
d738 15
d755 10
d774 1
a774 1
DO_NADA?=		${TRUE}
d898 1
a898 1
CDROM_COPY:=	${LN}
d901 1
a901 1
CDROM_COPY:=	${CP}
d1171 1
a1171 1
	@@${TOUCH} ${TOUCH_FLAGS} ${EXTRACT_COOKIE}
d1181 1
a1181 1
	@@${TOUCH} ${TOUCH_FLAGS} ${PATCH_COOKIE}
d1187 1
a1187 1
	@@${TOUCH} ${TOUCH_FLAGS} ${CONFIGURE_COOKIE}
d1193 1
a1193 1
	@@${TOUCH} ${TOUCH_FLAGS} ${BUILD_COOKIE}
d1199 1
a1199 1
	@@${TOUCH} ${TOUCH_FLAGS} ${INSTALL_COOKIE}
d1230 1
a1230 1
	@@${MKDIR} ${FULLDISTDIR}
d1233 3
a1235 3
	 	file=`echo $$fullfile|${SED} -e 's,:[0-9]$$,,'`; \
		if [ ! -f $$file -a ! -f `${BASENAME} $$file` ]; then \
			if [ -L $$file -o -L `${BASENAME} $$file` ]; then \
d1278 3
a1280 3
	 	file=`echo $$fullfile|${SED} -e 's,:[0-9]$$,,'`; \
		if [ ! -f $$file -a ! -f `${BASENAME} $$file` ]; then \
			if [ -L $$file -o -L `${BASENAME} $$file` ]; then \
d1344 2
a1345 2
	@@${RM} -rf ${WRKOBJDIR}/${PORTSUBDIR}
	@@${MKDIR} -p ${WRKOBJDIR}/${PORTSUBDIR}
d1347 1
a1347 1
	  [ X`${READLINK} ${WRKDIR}` != X${WRKOBJDIR}/${PORTSUBDIR} ]; then \
d1349 2
a1350 2
		${RM} -f ${WRKDIR}; \
		${LN} -sf ${WRKOBJDIR}/${PORTSUBDIR} ${WRKDIR}; \
d1367 2
a1368 2
	@@${RM} -rf ${WRKOBJDIR}/${PORTSUBDIR}
	@@${MKDIR} -p ${WRKOBJDIR}/${PORTSUBDIR}
d1370 1
a1370 1
	  [ X`${READLINK} ${WRKDIR}` != X${WRKOBJDIR}/${PORTSUBDIR} ]; then \
d1372 2
a1373 2
		${RM} -f ${WRKDIR}; \
		${LN} -sf ${WRKOBJDIR}/${PORTSUBDIR} ${WRKDIR}; \
d1376 2
a1377 2
	@@${RM} -rf ${WRKDIR}
	@@${MKDIR} ${WRKDIR}
d1462 1
a1462 1
	${MKDIR} ${WRKBUILD}
d1486 1
a1486 1
				if ! ${MKDIR} ${PKGREPOSITORY}; then \
d1494 1
a1494 1
				${MAKE} package-links; \
d1497 1
a1497 1
			${MAKE} delete-package; \
d1507 1
a1507 1
	@@${MAKE} delete-package-links
d1510 1
a1510 1
			if ! ${MKDIR} ${PACKAGES}/$$cat; then \
d1521 1
a1521 1
	@@cd ${PACKAGES} && ${FIND} . -type l -name ${PKGNAME}${PKG_SUFX}|xargs ${RM} -f
d1526 2
a1527 2
	@@${MAKE} delete-package-links
	@@${RM} -f ${PKGFILE}
d1572 1
a1572 1
	@@touch ${INSTALL_PRE_COOKIE}
d1574 1
a1574 1
	@@cd ${.CURDIR} && ${MAKE} ${.TARGET:S/^real-/pre-/}
d1579 2
a1580 2
	@@cd ${.CURDIR} && ${MAKE} ${.TARGET:S/^real-/do-/}
	@@cd ${.CURDIR} && ${MAKE} ${.TARGET:S/^real-/post-/}
d1595 4
a1598 4
		set - `${FILE} ${manpage}`; \
		shift `${EXPR} $$# - 1`; \
		${LN} -sf $${1}.gz ${manpage}.gz; \
		${RM} ${manpage}; \
d1606 1
a1606 1
	@@${CAT}	${PKGDIR}/MESSAGE
d1609 1
a1609 1
	@@cd ${.CURDIR} && ${MAKE} fake-pkg
d1612 1
a1612 1
	@@${TOUCH} ${TOUCH_FLAGS} ${EXTRACT_COOKIE}
d1618 1
a1618 1
	@@${TOUCH} ${TOUCH_FLAGS} ${PATCH_COOKIE}
d1621 1
a1621 1
	@@${TOUCH} ${TOUCH_FLAGS} ${CONFIGURE_COOKIE}
d1624 1
a1624 1
	@@${TOUCH} ${TOUCH_FLAGS} ${INSTALL_COOKIE}
d1627 1
a1627 1
	@@${TOUCH} ${TOUCH_FLAGS} ${BUILD_COOKIE}
d1630 1
a1630 1
	@@${TOUCH} ${TOUCH_FLAGS} ${PACKAGE_COOKIE}
d1644 1
a1644 1
	@@cd ${.CURDIR} && ${MAKE} real-fetch
d1648 1
a1648 1
	@@cd ${.CURDIR} && ${MAKE} __FETCH_ALL=Yes real-fetch
d1677 1
a1677 1
	@@cd ${.CURDIR} && ${MAKE} checksum real-extract
d1679 1
a1679 1
	@@cd ${.CURDIR} && ${MAKE} real-patch
d1681 1
a1681 1
	@@cd ${.CURDIR} && ${MAKE} real-configure
d1683 1
a1683 1
	@@cd ${.CURDIR} && ${MAKE} real-build
d1685 1
a1685 1
	@@cd ${.CURDIR} && ${MAKE} real-install
d1687 1
a1687 1
	@@cd ${.CURDIR} && ${MAKE} real-package
d1727 1
a1727 1
	@@cd ${.CURDIR} && ${MAKE} PATCH_CHECK_ONLY=Yes patch
d1736 2
a1737 2
	@@${RM} -f ${INSTALL_PRE_COOKIE} ${INSTALL_COOKIE} ${PACKAGE_COOKIE}
	@@DEPENDS_TARGET=${DEPENDS_TARGET} ${MAKE} install
d1748 1
a1748 1
	@@${RM} -f ${INSTALL_COOKIE} ${PACKAGE_COOKIE}
d1766 1
a1766 1
	@@${MAKE} clean-depends
d1771 2
a1772 2
	@@${RM} -rf ${WRKOBJDIR}/${PORTSUBDIR}
	@@${RM} -f ${WRKDIR}
d1776 1
a1776 1
			${RM} -rf ${WRKDIR}; \
d1783 1
a1783 1
	@@${RM} -f ${WRKDIR}/.*_started ${WRKDIR}/.*_done
d1796 1
a1796 1
		${RM} -f ${_DISTFILES} ${_PATCHFILES}; \
d1799 1
a1799 1
	-@@${RMDIR} ${FULLDISTDIR}  
d1888 2
a1889 2
	@@${MKDIR} ${FILESDIR}
	@@if [ -f ${CHECKSUM_FILE} ]; then ${RM} -f ${CHECKSUM_FILE}; fi
d1892 1
a1892 1
	 	for cipher in ${CIPHERS:R}; do \
d1904 1
a1904 1
	@@${MKDIR} ${FILESDIR}
d1916 1
a1916 1
	@@if [ `${SED} -e 's/\=.*$$//' ${CHECKSUM_FILE} | uniq -d | wc -l` -ne 0 ]; then \
d1931 2
a1932 3
			for cipher_sig in ${PREFERRED_CIPHERS}; do \
				sig=`${EXPR} $$cipher_sig : '.*\.\(.*\)'`; \
				CKSUM2=`${GREP} "^$$sig ($$file)" ${CHECKSUM_FILE} | ${AWK} '{print $$4}'`; \
d1934 1
a1934 1
					${ECHO_MSG} ">> No $$sig checksum recorded for $$file."; \
a1935 1
					cipher=`${EXPR} $$cipher_sig : '\(.*\)\.'`; \
d1949 1
a1949 1
					${ECHO_MSG} ">> Checksum OK for $$file. ($$sig)"; \
d1951 1
a1951 1
					echo ">> Checksum mismatch for $$file. ($$sig)"; \
d1957 1
a1957 1
			CKSUM2=`${GREP} "($$file)" ${CHECKSUM_FILE} | ${AWK} '{print $$4}'`; \
d1986 1
a1986 1
	${PERL} ${PORTSDIR}/infrastructure/install/make-plist > ${PLIST}-auto
d2010 1
a2010 1
	@@${_DEPEND_ECHO} `${MAKE} package-path`/${PKGNAME}
d2018 1
a2018 1
	@@pwd | ${SED} s@@`cd ${PORTSDIR} ; pwd`/@@@@g
d2026 1
a2026 1
	@@${RM} -f ${PACKAGE_COOKIE}
d2034 1
a2034 1
	@@cd ${.CURDIR} && ${MAKE} PACKAGE_NOINSTALL=Yes real-package
d2050 5
a2054 5
		prog=`echo $$i | ${SED} -e 's/:.*//'`; \
		dir=`echo $$i | ${SED} -e 's/[^:]*://'`; \
		if ${EXPR} "$$dir" : '.*:' > /dev/null; then \
			target=`echo $$dir | ${SED} -e 's/.*://'`; \
			dir=`echo $$dir | ${SED} -e 's/:.*//'`; \
d2059 1
a2059 1
		if ${EXPR} "$$prog" : \\/ >/dev/null; then \
d2077 1
a2077 1
			if cd $$dir && ${MAKE} $$target; then \
d2098 5
a2102 5
		lib=`echo $$i | ${SED} -e 's/:.*//' -e 's|\([^\\]\)[\\\.].*|\1|'`; \
		dir=`echo $$i | ${SED} -e 's/[^:]*://'`; \
		if ${EXPR} "$$dir" : '.*:' > /dev/null; then \
			target=`echo $$dir | ${SED} -e 's/.*://'`; \
			dir=`echo $$dir | ${SED} -e 's/:.*//'`; \
d2112 1
a2112 1
			if cd $$dir && ${MAKE} $$target; then \
d2121 1
a2121 1
		${RM} -f $$tmp; \
d2125 5
a2129 5
		lib=`echo $$i | ${SED} -e 's/:.*//' -e 's|\([^\\]\)\.|\1\\\\.|g'`; \
		dir=`echo $$i | ${SED} -e 's/[^:]*://'`; \
		if ${EXPR} "$$dir" : '.*:' > /dev/null; then \
			target=`echo $$dir | ${SED} -e 's/.*://'`; \
			dir=`echo $$dir | ${SED} -e 's/:.*//'`; \
d2133 2
a2134 2
		libname=`echo $$lib | ${SED} -e 's|\\\\||g'`; \
		reallib=`${LDCONFIG} -r | ${GREP} -e "-l$$lib" | awk '{ print $$3 }'`; \
d2138 1
a2138 1
			if cd $$dir && ${MAKE} $$target; then \
d2160 3
a2162 3
		if ${EXPR} "$$dir" : '.*:' > /dev/null; then \
			target=`echo $$dir | ${SED} -e 's/.*://'`; \
			dir=`echo $$dir | ${SED} -e 's/:.*//'`; \
d2168 1
a2168 1
		if cd $$dir && ${MAKE} $$target; then \
d2229 1
a2229 1
		echo -n "`${CAT} ${COMMENT}`|"; \
d2264 1
a2264 1
		{ ${CAT} $@@.tmp$I | while read n; do \
d2272 2
a2273 2
	@@${CAT} ${README_NAME} | \
		${SED} -e 's|%%PORT%%|'"`${MAKE} package-path | ${HTMLIFY}`"'|g' \
d2398 1
a2398 1
HTMLIFY=	${SED} -e 's/&/\&amp;/g' -e 's/>/\&gt;/g' -e 's/</\&lt;/g'
d2401 1
a2401 1
PKGDEPTH!=${MAKE} package-path|${SED} -e 's|[^./][^/]*|..|g'
d2406 1
a2406 1
	@@${MAKE} FULL_PACKAGE_NAME=Yes print-depends-list print-package-depends
d2416 1
a2416 1
	@@if [ `/bin/ls -l ${COMMENT} | ${AWK} '{print $$5}'` -gt 60 ]; then \
d2420 1
a2420 1
	@@if [ ! -d ${PKG_DBDIR} ]; then ${RM} -f ${PKG_DBDIR}; ${MKDIR} ${PKG_DBDIR}; fi
d2422 1
a2422 1
	@@${RM} -rf ${PKG_DBDIR}/${PKGNAME}
d2426 1
a2426 1
		${MKDIR} ${PKG_DBDIR}/${PKGNAME}; \
d2428 2
a2429 2
		${CP} ${DESCR} ${PKG_DBDIR}/${PKGNAME}/+DESC; \
		${CP} ${COMMENT} ${PKG_DBDIR}/${PKGNAME}/+COMMENT; \
d2431 1
a2431 1
			${CP} ${PKGDIR}/INSTALL ${PKG_DBDIR}/${PKGNAME}/+INSTALL; \
d2434 1
a2434 1
			${CP} ${PKGDIR}/DEINSTALL ${PKG_DBDIR}/${PKGNAME}/+DEINSTALL; \
d2437 1
a2437 1
			${CP} ${PKGDIR}/REQ ${PKG_DBDIR}/${PKGNAME}/+REQ; \
d2440 1
a2440 1
			${CP} ${PKGDIR}/MESSAGE ${PKG_DBDIR}/${PKGNAME}/+DISPLAY; \
d2442 1
a2442 1
		for dep in `make package-depends ECHO_MSG=${TRUE} | ${_SORT_DEPENDS}`; do \
d2444 1
a2444 1
				if ! ${GREP} ^${PKGNAME}$$ ${PKG_DBDIR}/$$dep/+REQUIRED_BY \
@


1.150
log
@Less verbose.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.149 1999/12/01 22:35:54 ian Exp $$
a195 2
# USE_EGCC		- Port needs the egcs C compiler
# USE_EGXX		- Port needs the egcs C++ compiler
a487 14
.if defined(USE_EGCC)
_CC_VERSION!=/usr/bin/cc -dumpversion
.if ${_CC_VERSION} == "2.8.0" || ${_CC_VERSION} == "2.8.1"
BUILD_DEPENDS+= 	${EGCC}:${PORTSDIR}/lang/egcs/stable
CC=${EGCC}
.endif
.endif
.if defined(USE_EGXX)
_CXX_VERSION!=/usr/bin/cc -dumpversion
.if ${_CXX_VERSION} == "2.8.0" || ${_CXX_VERSION} == "2.8.1" 
BUILD_DEPENDS+= 	${EGXX}:${PORTSDIR}/lang/egcs/stable
CXX=${EGXX}
.endif
.endif
a514 2
EGCC?=			egcc
EGXX?=			eg++
@


1.149
log
@Have delete-package-link function correctly even if ${PACKAGES} is itself
a symlink (ok espie).
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.148 1999/12/01 13:36:50 espie Exp $$
d1563 1
a1563 1
	cd ${PACKAGES} && ${FIND} . -type l -name ${PKGNAME}${PKG_SUFX}|xargs ${RM} -f
@


1.148
log
@Use _ALWAYS_DEP & friends pervasively.
Rename SORT_DEPENDS to _SORT_DEPENDS, nothing but us does need it anyway.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.147 1999/11/29 23:14:03 espie Exp $$
d1563 1
a1563 1
	@@${FIND} ${PACKAGES} -type l -name ${PKGNAME}${PKG_SUFX}|xargs ${RM} -f
@


1.147
log
@Prefer sh builtins to a dubious `optimization'
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.146 1999/11/28 14:14:58 espie Exp $$
d740 1
a740 1
SORT_DEPENDS?=tsort|tail -r
d743 1
a743 1
PKG_ARGS=		-v -c ${COMMENT} -d ${DESCR} -f ${PLIST} -p ${PREFIX} -P "`${MAKE} package-depends|${SORT_DEPENDS}`"
d2228 16
d2246 1
a2246 2
.if defined(FETCH_DEPENDS) || defined(BUILD_DEPENDS) || defined(LIB_DEPENDS) \
	|| defined(RUN_DEPENDS) || defined(DEPENDS)
d2248 2
a2249 5
	   `echo ${FETCH_DEPENDS:C/^[^:]*://:C/:.*//} \
	   ${BUILD_DEPENDS:C/^[^:]*://:C/:.*//} \
	   ${LIB_DEPENDS:C/^[^:]*://:C/:.*//} \
	   ${RUN_DEPENDS:C/^[^:]*://:C/:.*//} \
	   ${DEPENDS:C/:.*//} | ${TR} '\040' '\012' | sort -u`; do \
d2251 1
a2251 1
			${MAKE} CLEANDEPENDS=No clean clean-depends; \
d2283 2
a2284 3
.if defined(FETCH_DEPENDS) || defined(BUILD_DEPENDS) || \
   defined(LIB_DEPENDS) || defined(DEPENDS) || target(depends-list)
	@@cd ${.CURDIR} && echo -n `make depends-list|${SORT_DEPENDS}`
d2287 2
a2288 3
.if defined(LIB_DEPENDS) || defined(RUN_DEPENDS) || defined(DEPENDS) || \
	target(package-depends)
	@@cd ${.CURDIR} && echo -n `make package-depends|${SORT_DEPENDS}`
d2300 5
a2304 7
.if defined(FETCH_DEPENDS) || defined(BUILD_DEPENDS) || \
   defined(LIB_DEPENDS) || defined(DEPENDS) || target(depends-list)
	@@${MAKE} depends-list FULL_PACKAGE_NAME=Yes | ${SORT_DEPENDS}>$@@.tmp1
.endif
.if defined(LIB_DEPENDS) || defined(RUN_DEPENDS) || defined(DEPENDS) || \
	target(package-depends)
	@@${MAKE} package-depends FULL_PACKAGE_NAME=Yes | ${SORT_DEPENDS} >$@@.tmp2
d2333 1
a2333 2
.if defined(FETCH_DEPENDS) || defined(BUILD_DEPENDS) || \
	defined(LIB_DEPENDS) || defined(DEPENDS) || target(depends-list)
d2335 1
a2335 1
	@@echo -n `make ${_DEPEND_THRU} depends-list | ${SORT_DEPENDS}`
d2342 1
a2342 2
.if defined(RUN_DEPENDS) || defined(LIB_DEPENDS) || defined(DEPENDS) || \
   target(package-depends)
d2344 1
a2344 1
	@@echo -n `make ${_DEPEND_THRU} package-depends | ${SORT_DEPENDS}`
a2348 9
# Internal variables, used by recursive dependencies targets 

_ALWAYS_DEP = ${LIB_DEPENDS:C/^[^:]*://:C/:.*//} \
	${DEPENDS:C/:.*//} 

_BUILD_DEP = ${FETCH_DEPENDS:C/^[^:]*://:C/:.*//} \
	${BUILD_DEPENDS:C/^[^:]*://:C/:.*//}

_RUN_DEP = ${RUN_DEPENDS:C/^[^:]*://:C/:.*//} 
d2352 1
a2352 2
.if defined(FETCH_DEPENDS) || defined(BUILD_DEPENDS) || \
   defined(LIB_DEPENDS) || defined(DEPENDS) || defined(RUN_DEPENDS)
d2373 1
a2373 2
.if defined(FETCH_DEPENDS) || defined(BUILD_DEPENDS) || \
   defined(LIB_DEPENDS) || defined(DEPENDS)
d2392 1
a2392 1
.if defined(LIB_DEPENDS) || defined(RUN_DEPENDS) || defined(DEPENDS)
d2413 1
a2413 1
.if defined(LIB_DEPENDS) || defined(RUN_DEPENDS) || defined(DEPENDS)
d2486 1
a2486 1
		for dep in `make package-depends ECHO_MSG=${TRUE} | ${SORT_DEPENDS}`; do \
@


1.146
log
@Vi commodity fix: default sw=4 to the same as ts while we're at it.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.145 1999/11/28 14:12:24 espie Exp $$
d780 1
a780 1
ECHO?=		/bin/echo
d782 1
a782 1
FALSE?=		/usr/bin/false
d806 1
a806 1
TRUE?=		/usr/bin/true
@


1.145
log
@Kill opsys cruft.
@
text
@d2 2
a3 2
# ex:ts=4
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.144 1999/11/27 13:17:13 espie Exp $$
@


1.144
log
@Uniformize: everything else uses :L.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.143 1999/11/24 01:18:57 espie Exp $$
d422 1
a422 5
.if exists(${.CURDIR}/Makefile.${ARCH}-${OPSYS})
.include "${.CURDIR}/Makefile.${ARCH}-${OPSYS}"
.elif exists(${.CURDIR}/Makefile.${OPSYS})
.include "${.CURDIR}/Makefile.${OPSYS}"
.elif exists(${.CURDIR}/Makefile.${ARCH})
d437 1
a437 5
.if exists(${.CURDIR}/patches.${ARCH}-${OPSYS})
PATCHDIR?=		${.CURDIR}/patches.${ARCH}-${OPSYS}
.elif exists(${.CURDIR}/patches.${OPSYS})
PATCHDIR?=		${.CURDIR}/patches.${OPSYS}
.elif exists(${.CURDIR}/patches.${ARCH})
d445 1
a445 5
.if exists(${.CURDIR}/scripts.${ARCH}-${OPSYS})
SCRIPTDIR?=		${.CURDIR}/scripts.${ARCH}-${OPSYS}
.elif exists(${.CURDIR}/scripts.${OPSYS})
SCRIPTDIR?=		${.CURDIR}/scripts.${OPSYS}
.elif exists(${.CURDIR}/scripts.${ARCH})
d451 1
a451 5
.if exists(${.CURDIR}/files.${ARCH}-${OPSYS})
FILESDIR?=		${.CURDIR}/files.${ARCH}-${OPSYS}
.elif exists(${.CURDIR}/files.${OPSYS})
FILESDIR?=		${.CURDIR}/files.${OPSYS}
.elif exists(${.CURDIR}/files.${ARCH})
d457 1
a457 5
.if exists(${.CURDIR}/pkg.${ARCH}-${OPSYS})
PKGDIR?=		${.CURDIR}/pkg.${ARCH}-${OPSYS}
.elif exists(${.CURDIR}/pkg.${OPSYS})
PKGDIR?=		${.CURDIR}/pkg.${OPSYS}
.elif exists(${.CURDIR}/pkg.${ARCH})
@


1.143
log
@Oops.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.142 1999/11/24 00:56:52 espie Exp $$
d1882 1
a1882 1
.if ${RECURSIVE_FETCH_LIST:U} != "NO"
@


1.142
log
@Typo
Surprising nobody saw it before...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.141 1999/11/23 15:06:14 espie Exp $$
d2204 1
a2204 1
			else
@


1.141
log
@Kill some extra shells that are not needed.

Note that

if ! (cmd1 && cmd2) then
cmd
fi

can be replaced with

if cmd1 && cmd2 then :
else
cmd
fi
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.140 1999/11/22 23:44:01 espie Exp $$
d891 1
a891 1
_PATCH_SITES=		${PATCH_SITES:S@@%SUBDIR%@@${PATCH_SITE_SUBDIR}@@}
@


1.140
log
@Use echo directly, except where ECHO_MSG makes sense.
Clean up error conditions somewhat.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.139 1999/11/22 20:40:53 espie Exp $$
d1444 2
a1445 2
		if ! (cd ${WRKDIR} && ${EXTRACT_CMD} ${EXTRACT_BEFORE_ARGS} ${FULLDISTDIR}/$$file ${EXTRACT_AFTER_ARGS});\
		then \
d1530 1
a1530 1
	@@(cd ${WRKBUILD}; ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} ${MAKEFILE} ${ALL_TARGET})
d1537 1
a1537 1
	@@(cd ${WRKBUILD} && ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} ${MAKEFILE} ${INSTALL_TARGET})
d1952 1
a1952 1
	@@(cd ${DISTDIR}; \
d1957 1
a1957 1
	 done)
d1968 1
a1968 1
	@@(cd ${DISTDIR}; \
d1973 1
a1973 1
	 done)
d1991 1
a1991 1
		(cd ${DISTDIR}; OK="true"; \
d2036 1
a2036 1
		  fi) ; \
d2320 1
a2320 1
		(${CAT} $@@.tmp$I | while read n; do \
d2323 1
a2323 1
		 done;) >$@@.tmp$Ia; \
@


1.139
log
@Robust subdir substitution.
dugsong@@ agrees that @@ is a better choice.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.138 1999/11/22 20:37:04 espie Exp $$
d44 2
a45 2
		${ECHO} "Need version ${NEED_VERSION} of bsd.port.mk"; \
		${FALSE}; \
d829 1
a829 1
ECHO_MSG?=		${ECHO}
d832 1
a832 1
_DEPEND_ECHO?=		${ECHO}
d1024 2
a1025 2
	@@${ECHO_MSG} "CATEGORIES is mandatory."
	@@${FALSE}
d1295 1
a1295 1
	 	file=`${ECHO} $$fullfile|${SED} -e 's,:[0-9]$$,,'`; \
d1298 3
a1300 3
				${ECHO_MSG} ">> ${FULLDISTDIR}/$$file is a broken symlink."; \
				${ECHO_MSG} ">> Perhaps a filesystem (most likely a CD) isn't mounted?"; \
				${ECHO_MSG} ">> Please correct this problem and try again."; \
d1332 2
a1333 2
			${ECHO_MSG} ">> Couldn't fetch it - please try to retrieve this";\
			${ECHO_MSG} ">> port manually into ${FULLDISTDIR} and try again."; \
d1340 1
a1340 1
	 	file=`${ECHO} $$fullfile|${SED} -e 's,:[0-9]$$,,'`; \
d1343 3
a1345 3
				${ECHO_MSG} ">> ${FULLDISTDIR}/$$file is a broken symlink."; \
				${ECHO_MSG} ">> Perhaps a filesystem (most likely a CD) isn't mounted?"; \
				${ECHO_MSG} ">> Please correct this problem and try again."; \
d1368 2
a1369 2
			${ECHO_MSG} ">> Couldn't fetch it - please try to retrieve this";\
			${ECHO_MSG} ">> port manually into ${FULLDISTDIR} and try again."; \
d1410 1
a1410 1
		echo "${WRKDIR} -> ${WRKOBJDIR}/${PORTSUBDIR}"; \
d1415 3
a1417 3
	@@${ECHO_MSG} ">>"
	@@${ECHO_MSG} ">> Please set the WRKOBJDIR variable before using 'make obj'"
	@@${ECHO_MSG} ">>"
d1433 1
a1433 1
		echo "${WRKDIR} -> ${WRKOBJDIR}/${PORTSUBDIR}"; \
d1488 1
a1488 1
						${ECHO_MSG} "===>   Can't find patch matching $$i"; \
d1491 2
a1492 1
								${ECHO_MSG} "===>   Perhaps you forgot the -P flag to cvs co or update?"; \
d1549 1
a1549 1
					${ECHO_MSG} ">> Can't create directory ${PKGREPOSITORY}."; \
d1573 1
a1573 1
				${ECHO_MSG} ">> Can't create directory ${PACKAGES}/$$cat."; \
d1601 6
a1606 6
		${ECHO_MSG} "===>  ${PKGNAME} is already installed - perhaps an older version?"; \
		${ECHO_MSG} "      If so, you may wish to \`\`make deinstall'' and install"; \
		${ECHO_MSG} "      this port again by \`\`make reinstall'' to upgrade it properly."; \
		${ECHO_MSG} "      If you really wish to overwrite the old port of ${PKGNAME}"; \
		${ECHO_MSG} "      without deleting it first, set the variable \"FORCE_PKG_REGISTER\""; \
		${ECHO_MSG} "      in your environment or the \"make install\" command line."; \
d1620 2
a1621 2
			${ECHO_MSG} "Error: mtree file \"${MTREE_FILE}\" is missing."; \
			${ECHO_MSG} "Copy it from a suitable location (e.g., /usr/src/etc/mtree) and try again."; \
d1959 1
a1959 1
		${ECHO} "MD5 ($$file) = IGNORE" >> ${CHECKSUM_FILE}; \
d1975 1
a1975 1
		${ECHO} "MD5 ($$file) = IGNORE" >> ${CHECKSUM_FILE}; \
d1979 2
a1980 2
		${ECHO} "Inconsistent checksum in ${CHECKSUM_FILE}"; \
		${FALSE}; \
d1982 1
a1982 1
		${ECHO} "${CHECKSUM_FILE} updated okay, don't forget to remove cruft"; \
d2007 2
a2008 2
				${ECHO_MSG} ">> Checksum for $$file is set to IGNORE in md5 file even though"; \
				${ECHO_MSG} "   the file is not in the "'$$'"{IGNOREFILES} list."; \
d2015 1
a2015 1
					${ECHO_MSG} ">> Checksum mismatch for $$file. ($$sig)"; \
d2023 1
a2023 1
				${ECHO_MSG} ">> No checksum recorded for $$file, file is in "'$$'"{IGNOREFILES} list."; \
d2026 2
a2027 2
				${ECHO_MSG} ">> Checksum for $$file is not set to IGNORE in md5 file even though"; \
				${ECHO_MSG} "   the file is in the "'$$'"{IGNOREFILES} list."; \
d2032 3
a2034 3
			${ECHO_MSG} "Make sure the Makefile and checksum file (${CHECKSUM_FILE})"; \
			${ECHO_MSG} "are up to date.  If you want to override this check, type"; \
			${ECHO_MSG} "\"make NO_CHECKSUM=Yes [other args]\"."; \
d2114 2
a2115 2
		prog=`${ECHO} $$i | ${SED} -e 's/:.*//'`; \
		dir=`${ECHO} $$i | ${SED} -e 's/[^:]*://'`; \
d2117 2
a2118 2
			target=`${ECHO} $$dir | ${SED} -e 's/.*://'`; \
			dir=`${ECHO} $$dir | ${SED} -e 's/:.*//'`; \
d2141 2
a2142 2
			if [ ! -d "$$dir" ]; then \
				${ECHO_MSG} ">> No directory for $$prog.  Skipping.."; \
d2144 4
a2147 2
				(cd $$dir; ${MAKE} $$target) ; \
				${ECHO_MSG} "===>  Returning to build of ${PKGNAME}"; \
d2162 2
a2163 2
		lib=`${ECHO} $$i | ${SED} -e 's/:.*//' -e 's|\([^\\]\)[\\\.].*|\1|'`; \
		dir=`${ECHO} $$i | ${SED} -e 's/[^:]*://'`; \
d2165 2
a2166 2
			target=`${ECHO} $$dir | ${SED} -e 's/.*://'`; \
			dir=`${ECHO} $$dir | ${SED} -e 's/:.*//'`; \
d2176 2
a2177 2
			if [ ! -d "$$dir" ]; then \
				${ECHO_MSG} ">> No directory for $$lib.  Skipping.."; \
d2179 4
a2182 2
				(cd $$dir; ${MAKE} $$target) ; \
				${ECHO_MSG} "===>  Returning to build of ${PKGNAME}"; \
d2189 2
a2190 2
		lib=`${ECHO} $$i | ${SED} -e 's/:.*//' -e 's|\([^\\]\)\.|\1\\\\.|g'`; \
		dir=`${ECHO} $$i | ${SED} -e 's/[^:]*://'`; \
d2192 2
a2193 2
			target=`${ECHO} $$dir | ${SED} -e 's/.*://'`; \
			dir=`${ECHO} $$dir | ${SED} -e 's/:.*//'`; \
d2197 1
a2197 1
		libname=`${ECHO} $$lib | ${SED} -e 's|\\\\||g'`; \
d2202 1
a2202 4
			if [ ! -d "$$dir" ]; then \
				${ECHO_MSG} ">> No directory for $$libname.  Skipping.."; \
			else \
				(cd $$dir; ${MAKE} $$target) ; \
d2204 5
d2225 2
a2226 2
			target=`${ECHO} $$dir | ${SED} -e 's/.*://'`; \
			dir=`${ECHO} $$dir | ${SED} -e 's/:.*//'`; \
d2232 2
a2233 2
		if [ ! -d $$dir ]; then \
			${ECHO_MSG} ">> No directory for $$dir.  Skipping.."; \
d2235 4
a2238 1
			(cd $$dir; ${MAKE} $$target) ; \
a2240 1
	@@${ECHO_MSG} "===>  Returning to build of ${PKGNAME}"
d2253 1
a2253 1
	   `${ECHO} ${FETCH_DEPENDS:C/^[^:]*://:C/:.*//} \
d2278 2
a2279 2
	@@${ECHO} -n "${PKGNAME}|${.CURDIR}|"; \
	${ECHO} -n "${PREFIX}|"; \
d2281 1
a2281 1
		${ECHO} -n "`${CAT} ${COMMENT}`|"; \
d2283 1
a2283 1
		${ECHO} -n "** No Description|"; \
d2286 1
a2286 1
		${ECHO} -n "${DESCR}|"; \
d2288 1
a2288 1
		${ECHO} -n "/dev/null|"; \
d2290 1
a2290 1
	${ECHO} -n "${MAINTAINER}|${CATEGORIES}|"
d2293 1
a2293 1
	@@cd ${.CURDIR} && ${ECHO} -n `make depends-list|${SORT_DEPENDS}`
d2295 1
a2295 1
	@@${ECHO} -n "|"
d2298 1
a2298 1
	@@cd ${.CURDIR} && ${ECHO} -n `make package-depends|${SORT_DEPENDS}`
d2300 1
a2300 1
	@@${ECHO} -n "|"
d2302 1
a2302 1
		${ECHO} "any"; \
d2304 1
a2304 1
		${ECHO} "${ONLY_FOR_ARCHS}"; \
d2309 1
a2309 1
	@@${ECHO} ${PKGNAME} | ${HTMLIFY} > $@@.tmp3
d2347 3
a2349 3
	@@${ECHO} -n 'This port requires package(s) "'
	@@${ECHO} -n `make ${_DEPEND_THRU} depends-list | ${SORT_DEPENDS}`
	@@${ECHO} '" to build.'
d2357 3
a2359 3
	@@${ECHO} -n 'This port requires package(s) "'
	@@${ECHO} -n `make ${_DEPEND_THRU} package-depends | ${SORT_DEPENDS}`
	@@${ECHO} '" to run.'
d2484 1
a2484 1
	@@if [ ! -f ${PLIST} -o ! -f ${COMMENT} -o ! -f ${DESCR} ]; then ${ECHO} "** Missing package files for ${PKGNAME} - installation not recorded."; exit 1; fi
d2486 1
a2486 1
	    ${ECHO} "** ${COMMENT} too large - installation not recorded."; \
d2515 1
a2515 1
					${ECHO} ${PKGNAME} >> ${PKG_DBDIR}/$$dep/+REQUIRED_BY; \
@


1.138
log
@Simplify make fetch-list by using _ALWAYS_DEP and friends.
Remove some extraneous subshells.
Remove unwanted variables.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.137 1999/11/22 20:34:14 espie Exp $$
d880 22
a901 22
_MASTER_SITES:=		${MASTER_SITES:S/%SUBDIR%/${MASTER_SITE_SUBDIR}/}
_MASTER_SITES0:=	${MASTER_SITES0:S/%SUBDIR%/${MASTER_SITE_SUBDIR}/}
_MASTER_SITES1:=	${MASTER_SITES1:S/%SUBDIR%/${MASTER_SITE_SUBDIR}/}
_MASTER_SITES2:=	${MASTER_SITES2:S/%SUBDIR%/${MASTER_SITE_SUBDIR}/}
_MASTER_SITES3:=	${MASTER_SITES3:S/%SUBDIR%/${MASTER_SITE_SUBDIR}/}
_MASTER_SITES4:=	${MASTER_SITES4:S/%SUBDIR%/${MASTER_SITE_SUBDIR}/}
_MASTER_SITES5:=	${MASTER_SITES5:S/%SUBDIR%/${MASTER_SITE_SUBDIR}/}
_MASTER_SITES6:=	${MASTER_SITES6:S/%SUBDIR%/${MASTER_SITE_SUBDIR}/}
_MASTER_SITES7:=	${MASTER_SITES7:S/%SUBDIR%/${MASTER_SITE_SUBDIR}/}
_MASTER_SITES8:=	${MASTER_SITES8:S/%SUBDIR%/${MASTER_SITE_SUBDIR}/}
_MASTER_SITES9:=	${MASTER_SITES9:S/%SUBDIR%/${MASTER_SITE_SUBDIR}/}
_PATCH_SITES=		${PATCH_SITES:S/%SUBDIR%/${PATCH_SITE_SUBDIR}/}
_PATCH_SITES0:=		${PATCH_SITES0:S/%SUBDIR%/${PATCH_SITE_SUBDIR}/}
_PATCH_SITES1:=		${PATCH_SITES1:S/%SUBDIR%/${PATCH_SITE_SUBDIR}/}
_PATCH_SITES2:=		${PATCH_SITES2:S/%SUBDIR%/${PATCH_SITE_SUBDIR}/}
_PATCH_SITES3:=		${PATCH_SITES3:S/%SUBDIR%/${PATCH_SITE_SUBDIR}/}
_PATCH_SITES4:=		${PATCH_SITES4:S/%SUBDIR%/${PATCH_SITE_SUBDIR}/}
_PATCH_SITES5:=		${PATCH_SITES5:S/%SUBDIR%/${PATCH_SITE_SUBDIR}/}
_PATCH_SITES6:=		${PATCH_SITES6:S/%SUBDIR%/${PATCH_SITE_SUBDIR}/}
_PATCH_SITES7:=		${PATCH_SITES7:S/%SUBDIR%/${PATCH_SITE_SUBDIR}/}
_PATCH_SITES8:=		${PATCH_SITES8:S/%SUBDIR%/${PATCH_SITE_SUBDIR}/}
_PATCH_SITES9:=		${PATCH_SITES9:S/%SUBDIR%/${PATCH_SITE_SUBDIR}/}
@


1.137
log
@Simplify CATPAGES
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.136 1999/11/21 16:18:30 espie Exp $$
d1875 1
a1875 1
	@@${MAKE} fetch-list-recursive RECURSIVE_FETCH_LIST=${RECURSIVE_FETCH_LIST} | sort -u
d1880 1
a1880 1
	@@${MAKE} fetch-list-one-pkg
d1882 3
a1884 6
	@@for dir in `${ECHO} ${FETCH_DEPENDS:C/^[^:]*://:C/:.*//} \
	${BUILD_DEPENDS:C/^[^:]*://:C/:.*//} \
	${LIB_DEPENDS:C/^[^:]*://:C/:.*//} \
	${RUN_DEPENDS:C/^[^:]*://:C/:.*//} \
	${DEPENDS:C/:.*//} | ${TR} '\040' '\012' | sort -u`; do \
		(cd $$dir; ${MAKE} fetch-list-recursive; ); \
d1891 3
a1893 3
	@@${MKDIR} ${FULLDISTDIR}
	@@[ -z "${FULLDISTDIR}" ] || ${ECHO} "${MKDIR} ${FULLDISTDIR}"
	@@(cd ${FULLDISTDIR}; \
d1895 3
a1897 3
	 	file=`${ECHO} $$fullfile|${SED} -e 's,:[0-9]$$,,'`; \
		if [ ! -f $$file -a ! -f `${BASENAME} $$file` ]; then \
			${ECHO} -n "cd ${FULLDISTDIR} && [ -f $$file -o -f `${BASENAME} $$file` ] || " ; \
d1912 1
a1912 1
				${ECHO} -n ${FETCH_CMD} ${FETCH_BEFORE_ARGS} $${site}$${file} "${FETCH_AFTER_ARGS}" '|| ' ; \
d1914 1
a1914 1
			${ECHO} "echo $${file} not fetched" ; \
d1916 1
a1916 1
	done)
d1918 1
a1918 1
	@@(cd ${FULLDISTDIR}; \
d1920 3
a1922 3
	 	file=`${ECHO} $$fullfile|${SED} -e 's,:[0-9]$$,,'`; \
		if [ ! -f $$file -a ! -f `${BASENAME} $$file` ]; then \
			${ECHO} -n "cd ${FULLDISTDIR} && [ -f $$file -o -f `${BASENAME} $$file` ] || " ; \
d1937 1
a1937 1
				${ECHO} -n ${FETCH_CMD} ${FETCH_BEFORE_ARGS} $${site}$${file} "${FETCH_AFTER_ARGS}" '|| ' ; \
d1939 1
a1939 1
			${ECHO} "echo $${file} not fetched" ; \
d1941 1
a1941 1
	done)
@


1.136
log
@Typo
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.135 1999/11/20 17:54:09 espie Exp $$
d1084 1
a1084 1
.for sect in 1 2 3 4 5 6 7 8 9
d1086 1
a1086 1
_MANPAGES+=	${MAN${sect}:S%^%${MAN${sect}PREFIX}/man/${lang}/man${sect}/%}
d1089 1
a1089 1
_CATPAGES+=	${CAT${sect}:S%^%${CAT${sect}PREFIX}/man/${lang}/cat${sect}/%}
a1091 17

.if defined(MANL)
_MANPAGES+=	${MANL:S%^%${MANLPREFIX}/man/${lang}/manl/%}
.endif

.if defined(MANN)
_MANPAGES+=	${MANN:S%^%${MANNPREFIX}/man/${lang}/mann/%}
.endif

.if defined(CATL)
_CATPAGES+=	${CATL:S%^%${CATLPREFIX}/man/${lang}/catl/%}
.endif

.if defined(CATN)
_CATPAGES+=	${CATN:S%^%${CATNPREFIX}/man/${lang}/catn/%}
.endif

@


1.135
log
@Blast DEPENDS_TMP .USE macro out of existence.

The problem with .USE macros is that they should be constant...
If they do depend on the target being made, they will invariably use
.if make(TARGET) tests.   But this is a bad idea, as then `TARGET' can't
be used as a true dependency, since it's not being made then...
So instead, one would have to remember to fork another make TARGET to
ensure the .USE macro is executed correctly... This is slow, and
error-prone.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.134 1999/11/15 18:37:58 espie Exp $$
d1898 1
a1898 1
.if ${RECURSIVE_FETCH_LIST} != "NO"
@


1.134
log
@Fix recursive dependency computation.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.133 1999/11/10 13:46:40 espie Exp $$
a1613 6
.if make(real-fetch)
	@@cd ${.CURDIR} && ${MAKE} fetch-depends
.endif
.if make(real-extract)
	@@cd ${.CURDIR} && ${MAKE} build-depends lib-depends misc-depends
.endif
a1630 1
	@@cd ${.CURDIR} && ${MAKE} run-depends lib-depends
d1769 2
a1770 2
real-fetch: _PORT_USE
real-extract: _PORT_USE
d1778 1
a1778 1
real-install: _PORT_USE
d2125 1
a2125 4
depends: lib-depends misc-depends
	@@cd ${.CURDIR} && ${MAKE} fetch-depends
	@@cd ${.CURDIR} && ${MAKE} build-depends
	@@cd ${.CURDIR} && ${MAKE} run-depends
d2127 3
a2129 14
.if make(fetch-depends)
DEPENDS_TMP+=	${FETCH_DEPENDS}
.endif

.if make(build-depends)
DEPENDS_TMP+=	${BUILD_DEPENDS}
.endif

.if make(run-depends)
DEPENDS_TMP+=	${RUN_DEPENDS}
.endif

_DEPENDS_USE:	.USE
.if defined(DEPENDS_TMP)
d2132 1
a2132 1
	for i in ${DEPENDS_TMP}; do \
d2172 1
a2172 4

fetch-depends:	_DEPENDS_USE
build-depends:	_DEPENDS_USE
run-depends:	_DEPENDS_USE
@


1.133
log
@- introduce some internal variables to help recursive dependencies targets
be readable.
- kill some usage of ${ECHO} and ${TR} that is nonsense... there's no
reason to tweak those.

rohee@@ agrees...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.132 1999/11/05 22:44:34 espie Exp $$
d760 1
a760 1
SORT_DEPENDS?=tsort|tail +2|tail -r
d2408 22
d2434 2
a2435 3
	@@pname=`make _DEPEND_ECHO='echo -n' package-name ${_DEPEND_THRU}`; \
	for dir in `echo ${_ALWAYS_DEP} ${_BUILD_DEP}  \
	   | tr '\040' '\012' | sort -u`; do \
d2437 4
a2440 2
			make _DEPEND_ECHO="echo $$pname" package-name depends-list ${_DEPEND_THRU} || \
				${ECHO_MSG} "Error: problem in \"$$dir\"" >&2; \
d2442 2
a2443 1
			${ECHO_MSG} "Warning: \"$$dir\" non-existent" >&2; \
d2450 21
d2474 1
a2474 2
	@@pname=`make _DEPEND_ECHO='echo -n' package-name ${_DEPEND_THRU}`; \
	for dir in `echo ${_ALWAYS_DEP} ${_RUN_DEP} \
d2477 4
a2480 2
			make _DEPEND_ECHO="echo $$pname" package-name package-depends ${_DEPEND_THRU} || \
				${ECHO_MSG} "Error: problem in \"$$dir\"" >&2; \
d2482 2
a2483 1
			${ECHO_MSG} "Warning: \"$$dir\" non-existent -- @@pkgdep registration incomplete" >&2; \
d2585 2
a2586 1
   repackage run-depends tags uninstall fetch-all print-depends
@


1.132
log
@_VARIABLES are off-limit to individual ports.
Say so, explicitly.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.131 1999/10/27 12:48:40 espie Exp $$
d2398 10
d2412 3
a2414 5
	@@pname=`${MAKE} _DEPEND_ECHO='${ECHO} -n' package-name ${_DEPEND_THRU}`; \
	for dir in `${ECHO} ${FETCH_DEPENDS:C/^[^:]*://:C/:.*//} \
	${BUILD_DEPENDS:C/^[^:]*://:C/:.*//} \
	${LIB_DEPENDS:C/^[^:]*://:C/:.*//} \
	${DEPENDS:C/:.*//} | ${TR} '\040' '\012' | sort -u`; do \
d2416 1
a2416 1
			${MAKE} _DEPEND_ECHO="${ECHO} $$pname" package-name depends-list ${_DEPEND_THRU} || \
d2429 3
a2431 4
	@@pname=`${MAKE} _DEPEND_ECHO='${ECHO} -n' package-name ${_DEPEND_THRU}`; \
	for dir in `${ECHO} ${LIB_DEPENDS:C/^[^:]*://:C/:.*//} \
	${RUN_DEPENDS:C/^[^:]*://:C/:.*//} \
	${DEPENDS:C/:.*//} | ${TR} '\040' '\012' | sort -u`; do \
d2433 1
a2433 1
			${MAKE} _DEPEND_ECHO="${ECHO} $$pname" package-name package-depends ${_DEPEND_THRU} || \
@


1.131
log
@Slight speed-up, trim external unames.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.130 1999/10/08 11:38:05 espie Exp $$
d51 6
@


1.130
log
@Fix a reeeally old buglet.
make has been passing around its flags in MAKEFLAGS since
at least 1996... so passing them explicitly around means we
duplicate them.

This avoids the make -k -k -k -k -k -k -k -k -k   syndrome
that turans@@ has noticed
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.129 1999/09/30 21:07:09 espie Exp $$
d389 2
a390 2
OPSYS!=	uname -s
OPSYS_VER!=	uname -r
@


1.129
log
@- don't display `creating README.html for...', the subdir macros
already swamp us with information.
- perform the same optimization for README.html, namely don't invoke
depends-list and package-depends if they're known not to be needed.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.128 1999/09/30 17:34:22 espie Exp $$
d1566 1
a1566 1
				${MAKE} ${.MAKEFLAGS} package-links; \
d1569 1
a1569 1
			${MAKE} ${.MAKEFLAGS} delete-package; \
d1579 1
a1579 1
	@@${MAKE} ${.MAKEFLAGS} delete-package-links
d1598 1
a1598 1
	@@${MAKE} ${.MAKEFLAGS} delete-package-links
d1609 1
a1609 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} fetch-depends
d1612 1
a1612 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} build-depends lib-depends misc-depends
d1631 1
a1631 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} run-depends lib-depends
d1653 1
a1653 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} ${.TARGET:S/^real-/pre-/}
d1658 2
a1659 2
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} ${.TARGET:S/^real-/do-/}
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} ${.TARGET:S/^real-/post-/}
d1688 1
a1688 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} fake-pkg
d1723 1
a1723 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} real-fetch
d1727 1
a1727 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} __FETCH_ALL=Yes real-fetch
d1756 1
a1756 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} checksum real-extract
d1758 1
a1758 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} real-patch
d1760 1
a1760 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} real-configure
d1762 1
a1762 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} real-build
d1764 1
a1764 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} real-install
d1766 1
a1766 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} real-package
d1806 1
a1806 1
	@@cd ${.CURDIR} && ${MAKE} PATCH_CHECK_ONLY=Yes ${.MAKEFLAGS} patch
d2118 1
a2118 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} PACKAGE_NOINSTALL=Yes real-package
d2127 3
a2129 3
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} fetch-depends
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} build-depends
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} run-depends
d2178 1
a2178 1
				(cd $$dir; ${MAKE} ${.MAKEFLAGS} $$target) ; \
d2214 1
a2214 1
				(cd $$dir; ${MAKE} ${.MAKEFLAGS} $$target) ; \
d2238 1
a2238 1
				(cd $$dir; ${MAKE} ${.MAKEFLAGS} $$target) ; \
d2266 1
a2266 1
			(cd $$dir; ${MAKE} ${.MAKEFLAGS} $$target) ; \
@


1.128
log
@print-depends-list and print-package-depends need similar checks, so
they must appear before the default depends targets are generated.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.127 1999/09/30 17:28:31 espie Exp $$
d2337 35
a2446 30

README.html:
	@@${ECHO_MSG} "===>  Creating README.html for ${PKGNAME}"
	@@${ECHO} ${PKGNAME} | ${HTMLIFY} > $@@.tmp3
	@@${MAKE} depends-list FULL_PACKAGE_NAME=Yes | ${SORT_DEPENDS}>$@@.tmp1
	@@${MAKE} package-depends FULL_PACKAGE_NAME=Yes | ${SORT_DEPENDS} >$@@.tmp2
.for I in 1 2
	@@if [ -s $@@.tmp$I ]; then \
		(${CAT} $@@.tmp$I | while read n; do \
			j=`dirname $$n|${HTMLIFY}`; k=`basename $$n|${HTMLIFY}`; \
			echo "<A HREF=\"${PKGDEPTH}/$$j/README.html\">$$k</A>"; \
		 done;) >$@@.tmp$Ia; \
    else \
    echo "(none)" > $@@.tmp$Ia; \
	fi
.endfor
	@@${CAT} ${README_NAME} | \
		${SED} -e 's|%%PORT%%|'"`${MAKE} package-path | ${HTMLIFY}`"'|g' \
			-e '/%%PKG%%/r$@@.tmp3' \
			-e '/%%PKG%%/d' \
			-e '/%%COMMENT%%/r${PKGDIR}/COMMENT' \
			-e '/%%COMMENT%%/d' \
			-e '/%%DESCR%%/r${PKGDIR}/DESCR' \
			-e '/%%DESCR%%/d' \
			-e '/%%BUILD_DEPENDS%%/r$@@.tmp1a' \
			-e '/%%BUILD_DEPENDS%%/d' \
			-e '/%%RUN_DEPENDS%%/r$@@.tmp2a' \
			-e '/%%RUN_DEPENDS%%/d' \
		>> $@@
	@@rm -f $@@.tmp*
@


1.127
log
@More correct check for describe target... .e.g., if we have special depends
target, shortcuts can't be taken.

This involves moving those default target around so that they appear AFTER
describe.

Note that these tests mean ANYTHING adding to *_DEPENDS *MUST* come before
the targets that test these for bsd.port.mk to work...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.126 1999/09/30 16:56:16 espie Exp $$
d2337 20
a2441 19

.if !target(print-depends-list)
print-depends-list:
.if defined(FETCH_DEPENDS) || defined(BUILD_DEPENDS) || \
	defined(LIB_DEPENDS) || defined(DEPENDS)
	@@${ECHO} -n 'This port requires package(s) "'
	@@${ECHO} -n `make ${_DEPEND_THRU} depends-list | ${SORT_DEPENDS}`
	@@${ECHO} '" to build.'
.endif
.endif

.if !target(print-package-depends)
print-package-depends:
.if defined(RUN_DEPENDS) || defined(LIB_DEPENDS) || defined(DEPENDS)
	@@${ECHO} -n 'This port requires package(s) "'
	@@${ECHO} -n `make ${_DEPEND_THRU} package-depends | ${SORT_DEPENDS}`
	@@${ECHO} '" to run.'
.endif
.endif
@


1.126
log
@Replace some external sed with internal :C modifiers in the dependencies
computation, which is the place where lots of forking happened.

5% faster at make index.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.125 1999/09/30 16:35:40 espie Exp $$
a2103 20

# Build (recursively) a list of package dependencies suitable for tsort

.if !target(package-depends)
package-depends:
.if defined(LIB_DEPENDS) || defined(RUN_DEPENDS) || defined(DEPENDS)
	@@pname=`${MAKE} _DEPEND_ECHO='${ECHO} -n' package-name ${_DEPEND_THRU}`; \
	for dir in `${ECHO} ${LIB_DEPENDS:C/^[^:]*://:C/:.*//} \
	${RUN_DEPENDS:C/^[^:]*://:C/:.*//} \
	${DEPENDS:C/:.*//} | ${TR} '\040' '\012' | sort -u`; do \
		if cd $$dir 2>/dev/null; then \
			${MAKE} _DEPEND_ECHO="${ECHO} $$pname" package-name package-depends ${_DEPEND_THRU} || \
				${ECHO_MSG} "Error: problem in \"$$dir\"" >&2; \
		else \
			${ECHO_MSG} "Warning: \"$$dir\" non-existent -- @@pkgdep registration incomplete" >&2; \
		fi; \
	done
.endif
.endif

a2293 19
.if !target(depends-list)
depends-list:
.if defined(FETCH_DEPENDS) || defined(BUILD_DEPENDS) || \
   defined(LIB_DEPENDS) || defined(DEPENDS)
	@@pname=`${MAKE} _DEPEND_ECHO='${ECHO} -n' package-name ${_DEPEND_THRU}`; \
	for dir in `${ECHO} ${FETCH_DEPENDS:C/^[^:]*://:C/:.*//} \
	${BUILD_DEPENDS:C/^[^:]*://:C/:.*//} \
	${LIB_DEPENDS:C/^[^:]*://:C/:.*//} \
	${DEPENDS:C/:.*//} | ${TR} '\040' '\012' | sort -u`; do \
		if cd $$dir 2>/dev/null; then \
			${MAKE} _DEPEND_ECHO="${ECHO} $$pname" package-name depends-list ${_DEPEND_THRU} || \
				${ECHO_MSG} "Error: problem in \"$$dir\"" >&2; \
		else \
			${ECHO_MSG} "Warning: \"$$dir\" non-existent" >&2; \
		fi; \
	done 
.endif
.endif

d2310 1
a2310 1
		${ECHO} -n "`${CAT} ${COMMENT}`"; \
d2312 1
a2312 1
		${ECHO} -n "** No Description"; \
d2315 1
a2315 1
		${ECHO} -n "|${DESCR}"; \
d2317 1
a2317 1
		${ECHO} -n "|/dev/null"; \
d2319 13
a2331 13
	${ECHO} -n "|${MAINTAINER}|${CATEGORIES}|"; \
	case "A${FETCH_DEPENDS}B${BUILD_DEPENDS}C${LIB_DEPENDS}D${DEPENDS}E" in \
		ABCDE) ;; \
		*) cd ${.CURDIR} && ${ECHO} -n `make depends-list|${SORT_DEPENDS}`;; \
	esac; \
	${ECHO} -n "|"; \
	case "A${RUN_DEPENDS}B${LIB_DEPENDS}C${DEPENDS}D" in \
		ABCD) ;; \
		*) cd ${.CURDIR} && ${ECHO} -n `make package-depends|${SORT_DEPENDS}`;; \
	esac; \
	${ECHO} -n "|"; \
	if [ "${ONLY_FOR_ARCHS}" = "" ]; then \
		${ECHO} -n "any"; \
d2333 39
a2371 3
		${ECHO} -n "${ONLY_FOR_ARCHS}"; \
	fi; \
	${ECHO} ""
@


1.125
log
@Slightly better use of _DEPEND_ECHO
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.124 1999/09/30 16:24:47 espie Exp $$
d1900 5
a1904 1
	@@for dir in `${ECHO} ${FETCH_DEPENDS} ${BUILD_DEPENDS} ${LIB_DEPENDS}  ${RUN_DEPENDS} | ${TR} '\040' '\012' | ${SED} -e 's/^[^:]*://' -e 's/:.*//' | sort -u` `${ECHO} ${DEPENDS} | ${TR} '\040' '\012' | ${SED} -e 's/:.*//' | sort -u`; do \
d2111 3
a2113 1
	for dir in `${ECHO} ${LIB_DEPENDS} ${RUN_DEPENDS} | ${TR} '\040' '\012' | ${SED} -e 's/^[^:]*://' -e 's/:.*//' | sort -u` `${ECHO} ${DEPENDS} | ${TR} '\040' '\012' | ${SED} -e 's/:.*//' | sort -u`; do \
d2302 5
a2306 2
	   `${ECHO} ${FETCH_DEPENDS} ${BUILD_DEPENDS} ${LIB_DEPENDS} ${RUN_DEPENDS} | ${TR} '\040' '\012' | ${SED} -e 's/^[^:]*://' -e 's/:.*//' | sort -u` \
	   `${ECHO} ${DEPENDS} | ${TR} '\040' '\012' | ${SED} -e 's/:.*//' | sort -u`; do \
d2319 4
a2322 1
	for dir in `${ECHO} ${FETCH_DEPENDS} ${BUILD_DEPENDS} ${LIB_DEPENDS} | ${TR} '\040' '\012' | ${SED} -e 's/^[^:]*://' -e 's/:.*//' | sort -u` `${ECHO} ${DEPENDS} | ${TR} '\040' '\012' | ${SED} -e 's/:.*//' | sort -u`; do \
@


1.124
log
@Common case is for ports not to have dependencies.

The `pname hack' already catered to some of that (only computing the
package name if dependencies exist)

This removes the hack and simply optimize dependency computation out of
existence if it's not needed.

Improves make index time by >15%.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.123 1999/09/26 22:20:46 espie Exp $$
d2109 1
a2109 2
			${ECHO} -n "$$pname "; \
			${MAKE} package-name package-depends ${_DEPEND_THRU} || \
d2312 1
a2312 2
			${ECHO} -n "$$pname "; \
			${MAKE} package-name depends-list ${_DEPEND_THRU} || \
@


1.123
log
@Buglet, reversed default for CLEANDEPENDS
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.122 1999/09/26 10:51:34 espie Exp $$
d2105 2
a2106 1
	@@pname=x; \
a2107 4
		case $$pname in \
			x) \
			 pname=`${MAKE} _DEPEND_ECHO='${ECHO} -n' package-name ${_DEPEND_THRU}`;; \
		esac; \
d2117 1
d2308 3
a2310 1
	@@pname=x; \
a2311 4
		 case $$pname in \
			 x) \
				 pname=`${MAKE} _DEPEND_ECHO='${ECHO} -n' package-name ${_DEPEND_THRU}`;; \
			esac; \
d2320 1
@


1.122
log
@/usr/bin/fetch is long gone, long live ftp
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.117 1999/09/22 11:49:23 espie Exp $$
d411 1
a411 1
CLEANDEPENDS?=Yes
@


1.121
log
@Add multiple MASTER_SITES/PATCH_SITES
@
text
@a600 3
.if exists(/usr/bin/fetch)
FETCH_CMD?=		/usr/bin/fetch
.else
a601 1
.endif
@


1.120
log
@ftp sites configuration now live in network.conf
@
text
@d67 2
d111 3
d843 1
a843 9
# Empty declaration to avoid "variable MASTER_SITES recursive" error
MASTER_SITES?=
PATCH_SITES?=

# Substitute subdirectory names
_MASTER_SITES:=	${MASTER_SITES:S/%SUBDIR%/${MASTER_SITE_SUBDIR}/}
PATCH_SITES:=	${PATCH_SITES:S/%SUBDIR%/${PATCH_SITE_SUBDIR}/}
MASTER_SITES:= ${_MASTER_SITES}

d853 48
d904 45
a948 5
MASTER_SITES+=	${MASTER_SITE_BACKUP}
PATCH_SITES+=	${MASTER_SITE_BACKUP}
.else
MASTER_SITES:=	${MASTER_SITE_OVERRIDE} ${MASTER_SITES}
PATCH_SITES:=	${MASTER_SITE_OVERRIDE} ${PATCH_SITES}
d966 1
a966 1
# Derived names so that they're easily overridable.
d969 3
d976 1
d980 1
d983 1
a983 1
ALLFILES?=	${DISTFILES} ${PATCHFILES}
d1015 1
a1015 1
EXTRACT_ONLY?=	${DISTFILES}
d1309 2
a1310 1
	 for file in ${DISTFILES}; do \
d1328 14
a1341 1
			for site in ${MASTER_SITES}; do \
d1354 2
a1355 1
	 for file in ${PATCHFILES}; do \
d1364 14
a1377 1
			for site in ${PATCH_SITES}; do \
d1404 1
a1404 1
	@@for file in ${DISTFILES} ${PATCHFILES}; do \
d1473 1
a1473 1
	  for i in ${PATCHFILES}; do \
d1879 1
a1879 1
		${RM} -f ${DISTFILES} ${PATCHFILES}; \
d1915 2
a1916 1
	 for file in ${DISTFILES}; do \
d1919 14
a1932 1
			for site in ${MASTER_SITES} ; do \
d1940 2
a1941 1
	 for file in ${PATCHFILES}; do \
d1944 14
a1957 1
			for site in ${PATCH_SITES}; do \
@


1.119
log
@make now can lowercase/uppercase variables.
Use it.

NOTE: YOU MUST HAVE A CURRENT MAKE FOR THIS FILE TO WORK !!!
@
text
@a72 11
#
# MASTER_SITE_BACKUP - Backup location(s) for distribution files and patch
#				  files if not found locally and ${MASTER_SITES}/${PATCH_SITES}
#				  (default:
#				  ftp://ftp.openbsd.org/pub/OpenBSD/distfiles/${DIST_SUBDIR}/
#				  ftp://ftp.openbsd.org/pub/OpenBSD/licensed/${DIST_SUBDIR}/
#				  ftp://ftp.freebsd.org/pub/FreeBSD/distfiles/${DIST_SUBDIR}/)
# MASTER_SITE_OVERRIDE - If set, override the MASTER_SITES setting with this
#				  value.
# MASTER_SITE_OPENBSD - If set, only use ftp.openbsd.org as the
#				  MASTER_SITE_OVERRIDE.
a837 83
# Popular master sites
MASTER_SITE_XCONTRIB+=	\
	ftp://crl.dec.com/pub/X11/contrib/%SUBDIR%/ \
	ftp://uiarchive.uiuc.edu/pub/X11/contrib/%SUBDIR%/ \
	ftp://ftp.duke.edu/pub/X11/contrib/%SUBDIR%/ \
	ftp://ftp.sunet.se/pub/X11/contrib/%SUBDIR%/ \
	ftp://sunsite.sut.ac.jp/pub/archives/X11/%SUBDIR%/ \
	ftp://ftp.x.org/contrib/%SUBDIR%/

MASTER_SITE_GNU+=	\
	ftp://ftp.gnu.org/gnu/%SUBDIR%/ \
	ftp://ftp.cdrom.com/pub/gnu/%SUBDIR%/ \
	ftp://ftp.digital.com/pub/GNU/%SUBDIR%/ \
	ftp://ftp.uu.net/archive/systems/gnu/%SUBDIR%/ \
	ftp://ftp.de.uu.net/pub/gnu/%SUBDIR%/ \
	ftp://ftp.ecrc.net/pub/gnu/%SUBDIR%/ \
	ftp://ftp.funet.fi/pub/gnu/prep/%SUBDIR%/ \
	ftp://ftp.leo.org/pub/comp/os/unix/gnu/%SUBDIR%/ \
	ftp://ftp.digex.net/pub/gnu/%SUBDIR%/ \
	ftp://ftp.wustl.edu/systems/gnu/%SUBDIR%/ \
	ftp://ftp.kddlabs.co.jp/pub/gnu/%SUBDIR%/

MASTER_SITE_PERL_CPAN+=	\
	ftp://ftp.digital.com/pub/plan/perl/CPAN/modules/by-module/%SUBDIR%/ \
	ftp://ftp.cdrom.com/pub/perl/CPAN/modules/by-module/%SUBDIR%/

MASTER_SITE_TEX_CTAN+=	\
	ftp://ftp.cdrom.com/pub/tex/ctan/%SUBDIR%/ \
	ftp://ftp.wustl.edu/packages/TeX/%SUBDIR%/ \
	ftp://ftp.funet.fi/pub/TeX/CTAN/%SUBDIR%/ \
	ftp://ftp.tex.ac.uk/public/ctan/tex-archive/%SUBDIR%/ \
	ftp://ftp.dante.de/tex-archive/%SUBDIR%/

MASTER_SITE_SUNSITE+=	\
	ftp://metalab.unc.edu/pub/Linux/%SUBDIR%/ \
	ftp://ftp.infomagic.com/pub/mirrors/linux/sunsite/%SUBDIR%/ \
	ftp://ftp.funet.fi/pub/mirrors/sunsite.unc.edu/pub/Linux/%SUBDIR%/ \
	ftp://ftp.lip6.fr/pub/linux/sunsite/%SUBDIR%

MASTER_SITE_KDE+=	\
	ftp://ftp.us.kde.org/pub/kde/%SUBDIR%/ \
	ftp://ftp.kde.org/pub/kde/%SUBDIR%/ \
	ftp://ftp.tuniv.szczecin.pl/pub/kde/%SUBDIR%/ \
	ftp://ftp.fu-berlin.de/pub/unix/X11/gui/kde/%SUBDIR%/ \
	ftp://ftp.dataplus.se/pub/linux/kde/%SUBDIR%/

MASTER_SITE_GNOME+=	\
	ftp://ftp.cybertrails.com/pub/gnome/%SUBDIR%/ \
	ftp://gnomeftp.wgn.net/pub/gnome/%SUBDIR%/ \
	ftp://server.ph.ucla.edu/pub/mirror/ftp.gnome.org/%SUBDIR%/ \
	ftp://ftp.net.lut.ac.uk/gnome/%SUBDIR%/ \
	ftp://ftp.snoopy.net/pub/mirrors/GNOME/%SUBDIR%/ \
	ftp://ftp.gnome.org/pub/GNOME/%SUBDIR%/

MASTER_SITE_AFTERSTEP+=	\
	ftp://ftp.afterstep.org/%SUBDIR%/ \
	ftp://ftp.digex.net/pub/os/wm/AfterStep/%SUBDIR%/ \
	ftp://ftp.alpha1.net/pub/mirrors/ftp.afterstep.org/%SUBDIR%/ \
	ftp://ftp.math.uni-bonn.de/pub/mirror/ftp.afterstep.org/%SUBDIR%/ \
	ftp://ftp.bse.bg/pub/Unix/X11/wm/afterstep/%SUBDIR%/ \
	ftp://ftp.dti.ad.jp/pub/X/AfterStep/%SUBDIR%/ \
	ftp://ftp.lbi.ro/mirrors/ftp.afterstep.org/pub/%SUBDIR%/ \
	ftp://casper.yz.yamagata-u.ac.jp/pub/X11/apps/afterstep/%SUBDIR%/

MASTER_SITE_WINDOWMAKER+= \
	ftp://ftp.windowmaker.org/pub/%SUBDIR%/ \
	ftp://ftp.goldweb.com.au/pub/WindowMaker/%SUBDIR%/ \
	ftp://ftp.io.com/pub/mirror/windowmaker/%SUBDIR%/ \
	ftp://ftp.ensm-ales.fr/pub/mirrors/ftp.windowmaker.org/%SUBDIR%/ \
	ftp://ftp.freenews.de/pub/windowmaker/%SUBDIR%/ \
	http://jgo.local.net/cool_downloads/wm/%SUBDIR%/ \
	ftp://ftp.cybertrails.com/pub/windowmaker/%SUBDIR%/ \
	ftp://ftp.ameth.org/pub/mirrors/ftp.windowmaker.org/%SUBDIR%/

MASTER_SITE_TCLTK+= \
	ftp://ftp.scriptics.com/pub/tcl/%SUBDIR%/ \
	ftp://mirror.neosoft.com/pub/tcl/mirror/ftp.scriptics.com/%SUBDIR%/ \
	ftp://sunsite.utk.edu/pub/tcl/%SUBDIR%/ \
	ftp://ftp.funet.fi/pub/languages/tcl/tcl/%SUBDIR%/ \
	ftp://ftp.cs.tu-berlin.de/pub/tcl/distrib/%SUBDIR%/ \
	ftp://ftp.srcc.msu.su/mirror/ftp.scriptics.com/pub/tcl/%SUBDIR%/ \
	ftp://ftp.lip6.fr/pub/tcl/distrib/%SUBDIR%/

a846 17
# Two backup master sites, First one at ftp.openbsd.org
#
_MASTER_SITE_OPENBSD?=	\
	ftp://ftp.openbsd.org/pub/OpenBSD/distfiles/${DIST_SUBDIR}/ \
	ftp://ftp.openbsd.org/pub/OpenBSD/licensed/${DIST_SUBDIR}/

# set the backup master sites.
#
MASTER_SITE_BACKUP?=	\
	${_MASTER_SITE_OPENBSD} \
	ftp://ftp.freebsd.org/pub/FreeBSD/distfiles/${DIST_SUBDIR}/

# If the user has this set, go to the OpenBSD repository for everything.
#
.if defined(MASTER_SITE_OPENBSD)
MASTER_SITE_OVERRIDE=  ${_MASTER_SITE_OPENBSD}
.endif
d848 1
@


1.118
log
@NOCLEANDEPENDS=>CLEANDEPENDS, repair feature as well.
@
text
@d137 1
a137 1
#				  Defaults to "yes", set this to "no" if restrictions exist.
d270 1
a270 1
# NO_IGNORE     - Set this to YES (most probably in a "make fetch" in
d274 1
a274 1
# NO_WARNINGS	- Set this to YES to disable warnings regarding variables
d338 1
a338 1
# NO_SHARED_LIBS - defined as "yes" for those machine architectures that do
d372 2
a373 2
#				  Setting MIRROR_DISTFILE to "no" in the package Makefile
#				  will override the default "yes", and the distfile will
d406 1
a406 1
NO_SHARED_LIBS=	yes
d411 2
a412 2
.if ${NOCLEANDEPENDS}=="no"
CLEANDEPENDS?=yes
d414 1
a414 1
CLEANDEPENDS?=no
d417 1
a417 1
CLEANDEPENDS?=yes
d419 1
a419 1
NOMANCOMPRESS?=	yes
d498 1
a498 1
GNU_CONFIGURE= yes
d614 1
a614 1
MIRROR_DISTFILE?=	yes
d623 1
a623 1
PATCH_DEBUG_TMP=	yes
d627 1
a627 1
PATCH_DEBUG_TMP=	no
d1065 1
a1065 1
HAS_CONFIGURE=		yes
d1387 2
a1388 2
.if (${MIRROR_DISTFILE} == "yes")
	@@make fetch-all __ARCH_OK=yes NO_IGNORE=yes NO_WARNINGS=yes
d1466 1
a1466 1
	  	case ${PATCH_DEBUG_TMP} in \
d1488 1
a1488 1
						case ${PATCH_DEBUG_TMP} in \
d1723 1
a1723 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} __FETCH_ALL=yes real-fetch
d1802 1
a1802 1
	@@cd ${.CURDIR} && ${MAKE} PATCH_CHECK_ONLY=yes ${.MAKEFLAGS} patch
d1840 1
a1840 1
.if ${CLEANDEPENDS}=="yes"
d1882 1
a1882 1
RECURSIVE_FETCH_LIST?=	NO
d1884 1
a1884 1
RECURSIVE_FETCH_LIST?=	YES
d2018 1
a2018 1
			${ECHO_MSG} "\"make NO_CHECKSUM=yes [other args]\"."; \
d2046 1
a2046 1
FULL_PACKAGE_NAME=NO
d2057 1
a2057 1
.if (${FULL_PACKAGE_NAME} == "YES")
d2103 1
a2103 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} PACKAGE_NOINSTALL=yes real-package
d2270 1
a2270 1
			${MAKE} CLEANDEPENDS=no clean clean-depends; \
d2360 2
a2361 2
	@@${MAKE} depends-list FULL_PACKAGE_NAME=YES | ${SORT_DEPENDS}>$@@.tmp1
	@@${MAKE} package-depends FULL_PACKAGE_NAME=YES | ${SORT_DEPENDS} >$@@.tmp2
d2408 1
a2408 1
	@@${MAKE} FULL_PACKAGE_NAME=YES print-depends-list print-package-depends
@


1.117
log
@Use specific _DEPEND_ECHO to do dependencies, so that the trick of
changing echo to echo -n stays localized.

Found a bare sed -> SED.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.116 1999/09/22 10:16:58 espie Exp $$
d181 1
a181 1
# NOCLEANDEPENDS - Don't nuke dependent dirs on make clean (Default: yes)
d409 10
a418 1
NOCLEANDEPENDS=	yes
d1840 1
a1840 1
.if !defined(NOCLEANDEPENDS)
d2270 1
a2270 1
			${MAKE} NOCLEANDEPENDS=yes clean clean-depends; \
@


1.116
log
@Rename _DISTDIR to FULLDISTDIR,
make it a supported variable

(so that I can clean up the few uses of underscore variables I've done...
which were wrong; underscore variables are plain unsupported interface
which may change)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.115 1999/09/20 21:42:01 brad Exp $$
d826 3
d2045 1
d2049 1
a2049 1
	@@${ECHO} `${MAKE} package-path`/${PKGNAME}
d2051 1
a2051 1
	@@${ECHO} '${PKGNAME}'
d2057 1
a2057 1
	@@pwd | sed s@@`cd ${PORTSDIR} ; pwd`/@@@@g
d2068 1
a2068 1
			 pname=`${MAKE} ECHO='${ECHO} -n' package-name ${_DEPEND_THRU}`;; \
d2273 1
a2273 1
				 pname=`${MAKE} ECHO='${ECHO} -n' package-name ${_DEPEND_THRU}`;; \
@


1.115
log
@- remove ftp.geo.net from MASTER_SITE_GNOME, it has been un-responsive for
quite awhile now (2-3 months)
- add a missing slash to the end of the server.ph.ucla.edu URL
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.114 1999/09/02 21:57:32 brad Exp $$
d133 2
d428 1
a428 1
_DISTDIR?=		${DISTDIR}/${DIST_SUBDIR}
d1315 2
a1316 2
	@@${MKDIR} ${_DISTDIR}
	@@cd ${_DISTDIR}; \
d1320 1
a1320 1
				${ECHO_MSG} ">> ${_DISTDIR}/$$file is a broken symlink."; \
d1331 2
a1332 2
			if [ ! -w ${_DISTDIR}/. ]; then \
				${ECHO_MSG} ">> Can't download to ${_DISTDIR} (permission denied?)."; \
d1342 1
a1342 1
			${ECHO_MSG} ">> port manually into ${_DISTDIR} and try again."; \
d1347 1
a1347 1
	@@cd ${_DISTDIR}; \
d1351 1
a1351 1
				${ECHO_MSG} ">> ${_DISTDIR}/$$file is a broken symlink."; \
d1364 1
a1364 1
			${ECHO_MSG} ">> port manually into ${_DISTDIR} and try again."; \
d1439 1
a1439 1
		if ! (cd ${WRKDIR} && ${EXTRACT_CMD} ${EXTRACT_BEFORE_ARGS} ${_DISTDIR}/$$file ${EXTRACT_AFTER_ARGS});\
d1452 1
a1452 1
	@@cd ${_DISTDIR}; \
d1858 1
a1858 1
	@@if cd ${_DISTDIR} 2>/dev/null; then \
d1862 1
a1862 1
	-@@${RMDIR} ${_DISTDIR}  
d1892 3
a1894 3
	@@${MKDIR} ${_DISTDIR}
	@@[ -z "${_DISTDIR}" ] || ${ECHO} "${MKDIR} ${_DISTDIR}"
	@@(cd ${_DISTDIR}; \
d1897 1
a1897 1
			${ECHO} -n "cd ${_DISTDIR} && [ -f $$file -o -f `${BASENAME} $$file` ] || " ; \
d1905 1
a1905 1
	@@(cd ${_DISTDIR}; \
d1908 1
a1908 1
			${ECHO} -n "cd ${_DISTDIR} && [ -f $$file -o -f `${BASENAME} $$file` ] || " ; \
@


1.114
log
@add new variable STRIP, set to full pathname of strip command
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.113 1999/08/25 02:54:19 brad Exp $$
a882 1
	ftp://ftp.geo.net/pub/gnome/%SUBDIR%/ \
d884 1
a884 1
	ftp://server.ph.ucla.edu/pub/mirror/ftp.gnome.org/%SUBDIR% \
@


1.113
log
@- ports/lang/egcs-stable -> ports/lang/egcs/stable
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.112 1999/08/23 00:03:42 brad Exp $$
d811 2
a812 1
FIND?=      /usr/bin/find
@


1.112
log
@- update MASTER_SITE_TEX_CTAN and MASTER_SITE_GNOME
- OpenBSD.ORG -> openbsd.org
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.111 1999/08/22 23:44:51 brad Exp $$
d502 1
a502 1
BUILD_DEPENDS+= 	${EGCC}:${PORTSDIR}/lang/egcs-stable
d509 1
a509 1
BUILD_DEPENDS+= 	${EGXX}:${PORTSDIR}/lang/egcs-stable
@


1.111
log
@- update MASTER_SITE_XCONTRIB and MASTER_SITE_GNU
- add new variables CHMOD and CHOWN, set to full pathnames of those commands.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.110 1999/08/17 03:11:35 brad Exp $$
d90 1
a90 1
#				  Defaults: ports@@OpenBSD.ORG
d862 1
a862 1
	ftp://wuarchive.wustl.edu/packages/TeX/%SUBDIR%/ \
d883 2
a886 3
	ftp://gnomeftp.wgn.net/pub/gnome/%SUBDIR%/ \
	ftp://server.ph.ucla.edu/pub/mirror/ftp.gnome.org/%SUBDIR% \
	ftp://sod.inter-mezzo.org/mirror/ftp.gnome.org/%SUBDIR% \
d1024 1
a1024 1
MAINTAINER?=	ports@@OpenBSD.ORG
@


1.110
log
@back out previous commit which had broken the COMMENT length checking
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.109 1999/08/10 19:56:11 espie Exp $$
d789 2
d837 4
a840 2
	ftp://ftp.eu.net/X11/contrib/%SUBDIR%/ \
	ftp://ftp.uni-paderborn.de/pub/X11/contrib/%SUBDIR%/ \
d844 8
a851 3
	ftp://prep.ai.mit.edu/pub/gnu/%SUBDIR%/ \
	ftp://wuarchive.wustl.edu/systems/gnu/%SUBDIR%/ \
	ftp://ftp.kddlabs.co.jp/pub/gnu/%SUBDIR%/ \
d853 2
a854 5
	ftp://ftp.cs.ubc.ca/mirror2/gnu/%SUBDIR%/ \
	ftp://ftp.cdrom.com/pub/gnu/%SUBDIR%/ \
	ftp://ftp.duke.edu/pub/gnu/%SUBDIR%/ \
	ftp://ftp.gamma.ru/pub/gnu/%SUBDIR%/ \
	ftp://tron.um.u-tokyo.ac.jp/pub/GNU/prep/%SUBDIR%/
@


1.109
log
@wc -c to compute line lengths...
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.108 1999/08/10 19:55:31 espie Exp $$
d2398 1
a2398 1
	@@if [ `wc -c ${COMMENT}` -gt 60 ]; then \
@


1.108
log
@Activate new make-plist (perl script)
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.107 1999/08/10 19:54:17 espie Exp $$
d2398 1
a2398 1
	@@if [ `/bin/ls -l ${COMMENT} | ${AWK} '{print $$5}'` -gt 60 ]; then \
@


1.107
log
@Let comments match.
Remove obsolete EXEC_DEPENDS and EXTRACT_ARGS
kill a few more unneeded subshells.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.104 1999/07/28 13:02:15 espie Exp $$
d2013 3
a2015 22
	@@${MKDIR} ${PKGDIR}
	@@(dirs=""; \
	  ld=""; \
	  for f in `${FIND} ${PREFIX} -newer ${INSTALL_PRE_COOKIE} -print 2> /dev/null`; do \
	   ff=`${ECHO} $$f | ${SED} -e 's|^${PREFIX}/||'`; \
	   if [ -d $$f -a ! -L $$f ]; then dirs="$$ff $$dirs"; \
	   else \
	    ${ECHO} $$ff; \
	    if ${ECHO} $$f | ${GREP} -E -q -e '[^/]+\.so\.[0-9]+\.[0-9]+$$'; then \
	     ld="$$LDCONFIG `${DIRNAME} $$f`"; \
	    fi; \
	   fi; \
	  done; \
	  for f in $$dirs; do \
       if ${GREP} -q -e `${BASENAME} $$f` ${MTREE_FILE}; then \
        :; \
       else \
        ${ECHO} "@@dirrm $$f"; \
       fi; \
      done; \
	  for f in $$ld; do ${ECHO} "@@exec ${LDCONFIG} -m $$f"; done; \
	) > ${PLIST}-auto
@


1.106
log
@Oops... cd 2>/dev/null
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.105 1999/07/29 15:41:47 espie Exp $$
d400 1
a400 1
# Define SUPPORT_SHARES for those machines that support shared libraries.
a479 5
# The following 4 lines should go away as soon as the ports are all updated
.if defined(EXEC_DEPENDS)
BUILD_DEPENDS+=	${EXEC_DEPENDS}
RUN_DEPENDS+=	${EXEC_DEPENDS}
.endif
a646 4
# Backwards compatibility.
.if defined(EXTRACT_ARGS)
EXTRACT_AFTER_ARGS?=	| ${TAR} ${EXTRACT_ARGS} -
.else
a647 1
.endif
d1309 1
a1309 1
	@@(cd ${_DISTDIR}; \
d1338 1
a1338 1
	 done)
d1340 1
a1340 1
	@@(cd ${_DISTDIR}; \
d1360 1
a1360 1
	 done)
@


1.105
log
@Another if -> case conversion
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.104 1999/07/28 13:02:15 espie Exp $$
d1470 1
a1470 1
	@@if cd ${PATCHDIR} >/dev/null; then \
d1861 1
a1861 1
	@@if cd ${_DISTDIR} >/dev/null; then \
d2278 1
a2278 1
		if cd $$dir >/dev/null ; then \
@


1.104
log
@Remove more subshells and inefficient constructs.
fold clean-depends like depends-list
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.103 1999/07/28 12:56:15 espie Exp $$
d1479 3
a1481 3
						if [ ${PATCH_DEBUG_TMP} = yes ]; then \
							${ECHO_MSG} "===>   Applying ${OPSYS} patch $$i" ; \
						fi; \
@


1.103
log
@Optimizations:
- if cd construct >/dev/null
- prefer case to if [ ... ]
- remove unneeded subshells
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.102 1999/07/28 12:40:56 espie Exp $$
d1861 1
a1861 2
	@@(if [ -d ${_DISTDIR} ]; then \
		cd ${_DISTDIR}; \
d1863 1
a1863 1
	fi)
d2274 6
a2279 11
	|| defined(RUN_DEPENDS)
	@@for dir in `${ECHO} ${FETCH_DEPENDS} ${BUILD_DEPENDS} ${LIB_DEPENDS} ${RUN_DEPENDS} | ${TR} '\040' '\012' | ${SED} -e 's/^[^:]*://' -e 's/:.*//' | sort -u`; do \
		if [ -d $$dir ] ; then \
			(cd $$dir; ${MAKE} NOCLEANDEPENDS=yes clean clean-depends); \
		fi \
	done
.endif
.if defined(DEPENDS)
	@@for dir in `${ECHO} ${DEPENDS} | ${TR} '\040' '\012' | ${SED} -e 's/:.*//' | sort -u`; do \
		if [ -d $$dir ] ; then \
			(cd $$dir; ${MAKE} NOCLEANDEPENDS=yes clean clean-depends); \
@


1.102
log
@- fix up templates location so that readmes should be functional.
- provide error location for failing recursive dependency computation.
- remove hard-coded limit on topdir, always try to use make package-name
and fall back on directory name otherwise.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.101 1999/07/28 00:25:38 espie Exp $$
d1455 1
a1455 1
	@@(cd ${_DISTDIR}; \
d1457 3
a1459 3
		if [ ${PATCH_DEBUG_TMP} = yes ]; then \
			${ECHO_MSG} "===>   Applying distribution patch $$i" ; \
		fi; \
d1468 1
a1468 1
	  done)
d1470 2
a1471 2
	@@if [ -d ${PATCHDIR} ]; then \
		(cd ${PATCHDIR}; error=0; \
d1495 1
a1495 1
		if [ $$error == 1 ]; then exit 1; fi) \
d1508 1
a1508 1
	@@(cd ${WRKBUILD} && CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
d1513 1
a1513 1
		${CONFIGURE_ENV} ${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS})
d1516 1
a1516 1
	@@(cd ${WRKSRC} && ${SETENV} ${MAKE_ENV} ${XMKMF})
@


1.101
log
@Optimize package-depends and depends-list.
Shave about 10% off make index.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.100 1999/07/27 22:12:26 espie Exp $$
d428 1
a428 1
TEMPLATES?=		${PORTSDIR}/templates
d2091 2
a2092 1
			${MAKE} package-name package-depends ${_DEPEND_THRU}; \
d2301 2
a2302 1
			${MAKE} package-name depends-list ${_DEPEND_THRU};  \
d2393 2
@


1.100
log
@Let do-patch be more useful in case of failure.
- says which patch fails,
- go on applying other patches before failing globally.

This helps for quickly updating ports.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.99 1999/06/24 18:39:48 espie Exp $$
d2060 2
d2083 9
a2091 5
	@@for dir in `${ECHO} ${LIB_DEPENDS} ${RUN_DEPENDS} | ${TR} '\040' '\012' | ${SED} -e 's/^[^:]*://' -e 's/:.*//' | sort -u` `${ECHO} ${DEPENDS} | ${TR} '\040' '\012' | ${SED} -e 's/:.*//' | sort -u`; do \
		if [ -d $$dir ]; then \
			${MAKE} ECHO='${ECHO} -n' package-name FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME}; \
			${ECHO} -n " "; \
			(cd $$dir ; ${MAKE} package-name package-depends FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME}); \
d2292 9
a2300 5
	@@for dir in `${ECHO} ${FETCH_DEPENDS} ${BUILD_DEPENDS} ${LIB_DEPENDS} | ${TR} '\040' '\012' | ${SED} -e 's/^[^:]*://' -e 's/:.*//' | sort -u` `${ECHO} ${DEPENDS} | ${TR} '\040' '\012' | ${SED} -e 's/:.*//' | sort -u`; do \
		if [ -d $$dir ]; then \
			${MAKE} ECHO='${ECHO} -n' package-name FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME}; \
			${ECHO} -n " "; \
			(cd $$dir ; ${MAKE} package-name depends-list FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME}); \
d2304 1
a2304 1
	done
d2403 1
a2403 1
	@@${ECHO} -n `make FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME} depends-list | ${SORT_DEPENDS}`
d2412 1
a2412 1
	@@${ECHO} -n `make FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME} package-depends | ${SORT_DEPENDS}`
@


1.99
log
@Run mtree before creating the INSTALL_PRE_COOKIE.

Since that cookie is only used for automatically creating plists,
and since mtree information does not belong in the plist (duplicates...),
this was a definite bug.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.98 1999/06/24 17:31:16 espie Exp $$
d1471 1
a1471 1
		(cd ${PATCHDIR}; \
d1482 3
a1484 1
						${PATCH} ${PATCH_ARGS} < $$i; \
d1494 2
a1495 1
		done) \
@


1.98
log
@test -h   -> test -L
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.97 1999/06/13 03:50:51 brad Exp $$
a1617 1
	@@touch ${INSTALL_PRE_COOKIE}
d1635 1
@


1.97
log
@remove ftp.jimpick.com and add some additinal mirrors to MASTER_SITE_GNOME
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.96 1999/06/04 15:32:05 espie Exp $$
d1322 1
a1322 1
			if [ -h $$file -o -h `${BASENAME} $$file` ]; then \
d1353 1
a1353 1
			if [ -h $$file -o -h `${BASENAME} $$file` ]; then \
d2026 1
a2026 1
	   if [ -d $$f -a ! -h $$f ]; then dirs="$$ff $$dirs"; \
@


1.96
log
@Use egcs if it exists in-tree.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.95 1999/06/04 15:28:58 espie Exp $$
d885 1
a885 1
	ftp://ftp.jimpick.com/pub/mirrors/gnome/%SUBDIR%/ \
d887 2
d890 2
@


1.95
log
@Remove redundant OpenBSD tag.
@
text
@d3 1
a3 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.94 1999/06/02 15:44:50 espie Exp $$
d505 2
d510 1
d512 2
d516 1
@


1.94
log
@USE_AUTOCONF is more a part of `make patch' than a part of `make
configure'.

Special-case it so that it gets run right after post-patch, but before
configure.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.93 1999/05/25 20:38:33 espie Exp $
a29 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.93 1999/05/25 20:38:33 espie Exp $$
@


1.93
log
@Force commit.  These are `new' files actually.
Like FreeBSD, we transfer ownership of ports specific stuff outside
of /src.

The cvs files were copied to make it simpler to track history.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.92 1999/05/23 22:45:15 brad Exp $
d30 1
a30 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.92 1999/05/23 22:45:15 brad Exp $$
a1490 3
.if defined(USE_AUTOCONF)
	@@cd ${AUTOCONF_DIR} && ${SETENV} ${AUTOCONF_ENV} ${AUTOCONF}
.endif
d1669 3
@


1.92
log
@- add a few more dist sites to MASTER_SITE_GNU
- add MASTER_SITE_AFTERSTEP and MASTER_SITE_WINDOWMAKER for the master
and mirror sites of two popular window manager suites
- add MASTER_SITE_TCLTK which is Tcl/Tk master sites
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.91 1999/05/14 04:38:36 brad Exp $
d30 1
a30 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.91 1999/05/14 04:38:36 brad Exp $$
@


1.91
log
@add USE_ZIP for distfiles that use zip (.zip) for its packaging instead of
tar and add USE_BZIP2 for distfiles that use bzip2 (.tar.bz2) for
compression instead of gzip.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.90 1999/05/10 21:35:25 brad Exp $
d30 1
a30 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.90 1999/05/10 21:35:25 brad Exp $$
d846 8
a853 1
	ftp://wuarchive.wustl.edu/systems/gnu/%SUBDIR%/
d884 29
@


1.90
log
@change email address of maintainer to ports-admin@@openbsd.org
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.89 1999/05/04 18:12:24 rohee Exp $
d30 1
a30 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.89 1999/05/04 18:12:24 rohee Exp $$
d183 4
a186 2
# USE_GMAKE		- Says that the port uses gmake.
# USE_LIBTOOL	- Says that the port uses libtool.
d190 1
a190 1
# USE_AUTOCONF	- Says that the port uses autoconf (implies GNU_CONFIGURE).
d192 5
a196 5
# USE_PERL5		- Says that the port uses perl5 for building and running.
# USE_IMAKE		- Says that the port uses imake.
# USE_X11		- Says that the port uses X11 (i.e., installs in ${X11BASE}).
# USE_EGCC		- Says that the port needs the egcs C compiler
# USE_EGXX		- Says that the port needs the egcs C++ compiler
d251 11
a261 8
# EXTRACT_CMD	- Command for extracting archive (default: tar).
# EXTRACT_SUFX	- Suffix for archive names (default: .tar.gz).
# EXTRACT_BEFORE_ARGS -
#				  Arguments to ${EXTRACT_CMD} before filename
#				  (default: -xzf).
# EXTRACT_AFTER_ARGS -
#				  Arguments to ${EXTRACT_CMD} following filename
#				  (default: none).
d631 1
a631 1
EXTRACT_CMD?=	/bin/tar
d633 1
a633 1
EXTRACT_CMD?=	/usr/bin/tar
d635 13
a647 1
# Backwards compatability.
d649 1
a649 1
EXTRACT_BEFORE_ARGS?=   ${EXTRACT_ARGS}
d651 13
a663 1
EXTRACT_BEFORE_ARGS?=   -xzf
a664 1
EXTRACT_SUFX?=	.tar.gz
d1395 2
a1396 1
	@@for file in ${EXTRACT_ONLY}; do \
@


1.89
log
@USE_LIBTOOL from NetBSD
@
text
@d3 3
a5 1
#	$OpenBSD: bsd.port.mk,v 1.88 1999/04/20 18:22:56 espie Exp $
a9 3
# FreeBSD Id: bsd.port.mk,v 1.264 1996/12/25 02:27:44 imp Exp
#	$NetBSD: bsd.port.mk,v 1.62 1998/04/09 12:47:02 hubertf Exp $
#
d25 1
a25 1
OpenBSD_MAINTAINER=	marc@@OpenBSD.ORG
d30 1
a30 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.88 1999/04/20 18:22:56 espie Exp $$
@


1.88
log
@IMPORTANT CHANGE:

depends-list and package-depends now give out output suitable for tsort,
so they are INCOMPATIBLE with the previous version.

PACKAGE_NAME_AS_LINK disappears, functionality is replaced by
FULL_PACKAGE_NAME, which makes more sense anyway.

*This does fix the package dependencies problem*

Still missing: mechanism to output a decent error message in case tsort
finds out a cycle.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.87 1999/04/20 18:09:37 espie Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.87 1999/04/20 18:09:37 espie Exp $$
d185 1
d206 2
d494 6
@


1.87
log
@FIND as a known program
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.86 1999/04/20 18:06:40 espie Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.86 1999/04/20 18:06:40 espie Exp $$
d371 1
d722 2
d725 1
a725 1
PKG_ARGS=		-v -c ${COMMENT} -d ${DESCR} -f ${PLIST} -p ${PREFIX} -P "`${MAKE} package-depends|sort -u`"
d911 1
a911 1
 .endif
a1967 1
HTMLIFY=	${SED} -e 's/&/\&amp;/g' -e 's/>/\&gt;/g' -e 's/</\&lt;/g'
d1969 5
a1973 5
# Set to YES by the README.html target (and passed via depends-list
# and package-depends)
.ifndef PACKAGE_NAME_AS_LINK
PACKAGE_NAME_AS_LINK=NO
.endif # PACKAGE_NAME_AS_LINK
d1980 2
a1981 2
.if (${PACKAGE_NAME_AS_LINK} == "YES")
	@@${ECHO} '<A HREF="../../'`${MAKE} package-path | ${HTMLIFY}`'/README.html">'`echo ${PKGNAME} | ${HTMLIFY}`'</A>'
d1984 2
a1985 2
.endif # PACKAGE_NAME_AS_LINK != ""
.endif # !target(package-name)
d1992 1
a1992 1
# Show (recursively) all the packages this package depends on.
d1998 3
a2000 1
			(cd $$dir ; ${MAKE} package-name package-depends PACKAGE_NAME_AS_LINK=${PACKAGE_NAME_AS_LINK}); \
d2202 7
a2208 1
		(cd $$dir; ${MAKE} package-name depends-list PACKAGE_NAME_AS_LINK=${PACKAGE_NAME_AS_LINK}; ); \
d2240 1
a2240 1
		*) cd ${.CURDIR} && ${ECHO} -n `make depends-list|sort -u`;; \
d2245 1
a2245 1
		*) cd ${.CURDIR} && ${ECHO} -n `make package-depends|sort -u`;; \
d2256 2
d2265 1
a2265 1
	@@cd ${.CURDIR} && make README.html
d2268 6
a2273 1
README_NAME=	${TEMPLATES}/README.port
d2277 13
a2289 5
	@@${MAKE} depends-list PACKAGE_NAME_AS_LINK=YES >> $@@.tmp1
	@@[ -s $@@.tmp1 ] || echo "(none)" >> $@@.tmp1
	@@${MAKE} package-depends PACKAGE_NAME_AS_LINK=YES >> $@@.tmp2
	@@[ -s $@@.tmp2 ] || echo "(none)" >> $@@.tmp2
	@@${ECHO} ${PKGNAME} | ${HTMLIFY} >> $@@.tmp3
d2296 1
a2296 1
			-e '/%%BUILD_DEPENDS%%/r$@@.tmp1' \
d2298 1
a2298 1
			-e '/%%RUN_DEPENDS%%/r$@@.tmp2' \
d2301 1
a2301 1
	@@rm -f $@@.tmp1 $@@.tmp2 $@@.tmp3
d2308 1
a2308 1
	@@${ECHO} -n `make depends-list | sort -u`
d2317 1
a2317 1
	@@${ECHO} -n `make package-depends | sort -u`
d2322 5
d2360 1
a2360 1
		for dep in `make package-depends ECHO_MSG=${TRUE} | sort -u`; do \
d2399 1
a2399 1
   repackage run-depends tags uninstall fetch-all
@


1.86
log
@remove weird restriction on package repository name, and make delete-links
safer.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.85 1999/04/20 18:04:27 espie Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.85 1999/04/20 18:04:27 espie Exp $$
d775 1
d1495 1
a1495 1
	@@find ${PACKAGES} -type l -name ${PKGNAME}${PKG_SUFX}|xargs ${RM} -f
d1939 1
a1939 1
	  for f in `find ${PREFIX} -newer ${INSTALL_PRE_COOKIE} -print 2> /dev/null`; do \
@


1.85
log
@Add SUPDISTFILES/SUPPATCHFILES functionality:
files that are not always needed for all builds, but that must be fetched
for maintainance purposes (makesum, mirror...)

Not to use for intl/usa programs, probably...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.84 1999/04/10 07:48:53 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.84 1999/04/10 07:48:53 marc Exp $$
a951 2
# Note this has to start with a capital letter (or more accurately, it
#  shouldn't match "[a-z]*"), see the target "delete-package-links" below.
d1494 1
a1494 1
	@@${RM} -f ${PACKAGES}/[a-z]*/${PKGNAME}${PKG_SUFX};
@


1.84
log
@shit: egcs-stable is in LANG, not DEVEL
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.83 1999/04/06 19:14:41 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.83 1999/04/06 19:14:41 marc Exp $$
d122 2
d129 2
d901 8
d1161 1
a1161 1
.for _TARGET in checksum makesum addsum
d1163 1
a1163 1
${_TARGET}: fetch
d1167 4
d1177 3
a1179 1
checksum makesum addsum: fetch
d1296 1
a1296 1
	@@make fetch __ARCH_OK=yes NO_IGNORE=yes NO_WARNINGS=yes
d1625 5
d1838 1
a1838 1
makesum: fetch
d1850 1
d1854 1
a1854 1
addsum: fetch
d1866 1
a1866 2
	@@sort -u ${CHECKSUM_FILE} >${CHECKSUM_FILE}.new
	@@${MV} -f ${CHECKSUM_FILE}.new ${CHECKSUM_FILE}
d2370 1
a2370 1
   repackage run-depends tags uninstall
@


1.83
log
@Fix library dependency test for arch-es that don't
suppport shared libs so building tk80, for example, doesn't
cause tkl80 to get built even thouth it
is already installed.  Update list-distfiles target
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.82 1999/04/02 06:55:56 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.82 1999/04/02 06:55:56 marc Exp $$
d488 1
a488 1
BUILD_DEPENDS+= 	${EGCC}:${PORTSDIR}/devel/egcs-stable
d492 1
a492 1
BUILD_DEPENDS+= 	${EGXX}:${PORTSDIR}/devel/egcs-stable
d1739 1
a1739 1
	@@${RM} -f ${WRKDIR}/.*_done
@


1.82
log
@add list-distfiles target to help me build/update the LICENSE file
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.81 1999/03/30 07:12:05 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.81 1999/03/30 07:12:05 marc Exp $$
d1285 11
a1295 1
	@@for file in ${DISTFILES} ${PATCHFILES}; do ${ECHO} $$file; done
d2074 1
a2074 1
		lib=`${ECHO} $$i | ${SED} -e 's/:.*//' -e 's|\([^\\]\)\.|\1\\\\.|g'`; \
@


1.81
log
@add obj target that works in conjuction with WRKOBJDIR;
code from op21@@squish.org
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.80 1999/03/24 01:13:44 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.80 1999/03/24 01:13:44 marc Exp $$
d363 4
d1281 6
d1288 1
a1288 1

d2327 1
a2327 1
   do-fetch do-install do-package do-patch extract \
@


1.80
log
@arrgghhh! do NOT add pkgdep lines when creating PLIST-auto;
(I thought I had already removed this quite a while ago).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.79 1999/03/16 23:35:37 espie Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.79 1999/03/16 23:35:37 espie Exp $$
d1275 23
@


1.79
log
@tell gnu configure packages to stuff their files under /etc.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.78 1999/03/14 15:19:05 rohee Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.78 1999/03/14 15:19:05 rohee Exp $$
a1873 1
	  for f in `${MAKE} package-depends|sort -u`; do ${ECHO} "@@pkgdep $$f"; done; \
@


1.78
log
@Adding ${MASTER_SITE_GNOME} and ${MASTER_SITE_KDE}
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.77 1999/03/10 23:22:19 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.77 1999/03/10 23:22:19 marc Exp $$
d462 3
d956 1
@


1.77
log
@pass COPTS in CFLAGS for those ports that do not override CFLAGS;
NOTE: Some (most?) ports override CFLAGS.  This includes all ports
that use imake.  Therefore this change is not as useful as it should be.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.76 1999/03/05 16:32:49 espie Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.76 1999/03/05 16:32:49 espie Exp $$
d801 6
a806 6
MASTER_SITE_TEX_CTAN+=  \
        ftp://ftp.cdrom.com/pub/tex/ctan/%SUBDIR%/  \
        ftp://wuarchive.wustl.edu/packages/TeX/%SUBDIR%/  \
        ftp://ftp.funet.fi/pub/TeX/CTAN/%SUBDIR%/  \
        ftp://ftp.tex.ac.uk/public/ctan/tex-archive/%SUBDIR%/  \
        ftp://ftp.dante.de/tex-archive/%SUBDIR%/
d813 13
@


1.76
log
@Fix makesum/addsum   batch behavior
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.75 1999/03/03 18:18:46 espie Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.75 1999/03/03 18:18:46 espie Exp $$
d561 5
@


1.75
log
@Replace md5 checksum with a choice of sha1, rmd160, md5.
Upward compatible.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.74 1999/03/03 04:16:03 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.74 1999/03/03 04:16:03 marc Exp $$
d1122 4
a1125 2
.if defined(NO_CHECKSUM) && !target(checksum)
checksum: fetch
d1128 2
d1135 1
a1135 5
checksum: fetch
	@@${DO_NADA}
makesum:
	@@${DO_NADA}
addsum:
d1781 1
@


1.74
log
@Remove . from the path passed to configure;
adjust the configure script path appropriate for SEPARATE_BUILD;
this seems to work for all ports, some ports had probs with earlier
changes
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.73 1999/03/01 19:44:18 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.73 1999/03/01 19:44:18 marc Exp $$
d99 4
a102 1
#
d354 4
a357 3
# checksum		- Use files/md5 to ensure that your distfiles are valid.
# makesum		- Generate files/md5 (only do this for your own ports!).
# addsum		- update files/md5 in a non-destructive way (own ports only!)
d519 1
a519 1
# be paranoid about which md5 we trust
d529 22
d552 7
d1752 1
a1752 1
	@@if [ -f ${MD5_FILE} ]; then ${RM} -f ${MD5_FILE}; fi
d1755 3
a1757 1
		${MD5} $$file >> ${MD5_FILE}; \
d1760 1
a1760 1
		${ECHO} "MD5 ($$file) = IGNORE" >> ${MD5_FILE}; \
d1767 1
a1767 1
	@@touch ${MD5_FILE}
d1770 3
a1772 1
		${MD5} $$file >> ${MD5_FILE}; \
d1775 1
a1775 1
		${ECHO} "MD5 ($$file) = IGNORE" >> ${MD5_FILE}; \
d1777 4
a1780 4
	@@sort -u ${MD5_FILE} >${MD5_FILE}.new
	@@${MV} -f ${MD5_FILE}.new ${MD5_FILE}
	@@if [ `${SED} -e 's/\=.*$$//' ${MD5_FILE} | uniq -d | wc -l` -ne 0 ]; then \
		${ECHO} "Inconsistent checksum in ${MD5_FILE}"; \
d1782 1
a1782 1
		${ECHO} "${MD5_FILE} updated okay, don't forget to remove cruft"; \
d1788 2
a1789 2
	@@if [ ! -f ${MD5_FILE} ]; then \
		${ECHO_MSG} ">> No MD5 checksum file."; \
d1793 10
a1802 2
			CKSUM=`${MD5} < $$file`; \
			CKSUM2=`${GREP} "^MD5 ($$file)" ${MD5_FILE} | ${AWK} '{print $$4}'`; \
a1809 2
			elif [ "$$CKSUM" = "$$CKSUM2" ]; then \
				${ECHO_MSG} ">> Checksum OK for $$file."; \
d1811 7
a1817 2
				${ECHO_MSG} ">> Checksum mismatch for $$file."; \
				OK="false"; \
d1821 1
a1821 1
			CKSUM2=`${GREP} "($$file)" ${MD5_FILE} | ${AWK} '{print $$4}'`; \
d1832 1
a1832 1
			${ECHO_MSG} "Make sure the Makefile and md5 file (${MD5_FILE})"; \
@


1.73
log
@Note that NO_SHARED_LIBS can not be tested until after
bsd.port.mk is included; define CONFIGURE_SHARED that is set to
either --enable-shared or --disable-shared depending upon the
architecture.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.72 1999/03/01 18:44:04 espie Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.72 1999/03/01 18:44:04 espie Exp $$
d892 7
a898 2
CONFIGURE_SCRIPT?=	${WRKSRC}/configure
CONFIGURE_ENV+=		PATH=.:${PORTPATH}
d1313 1
a1313 1
		${CONFIGURE_ENV} ${CONFIGURE_SCRIPT} ${CONFIGURE_ARGS})
@


1.72
log
@Work around some broken Configure (such as elm) which don't work correctly
when they're invoked with an absolute path.
This was introduced by the WRKBUILD/WRKSRC split.

So:
- replace default CONFIGURE with a full path, so that you can override it.
- remove leading ${WRKSRC} from the configure invocation.
- add . to the configure path.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.71 1999/02/28 23:23:47 espie Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.71 1999/02/28 23:23:47 espie Exp $$
d99 1
a99 3
# NO_SHARED_LIBS - defined as "yes" for those machine architectures that do
#				  not support shared libraries.

d194 4
d321 8
d898 6
@


1.71
log
@* make the _PORT_USE macro more explicit and less magic in its use of
cookies, so that cookie names are no longer hard-coded.
* new SEPARATE_BUILD feature: for ports that can build outside their source
tree, use build-${ARCH} to build, and move configure/build/install cookie
down inside build-${ARCH}.

Those few people who use NFS to mount ports tree around different
architectures may find this helps.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.70 1999/02/27 18:28:13 rohee Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.70 1999/02/27 18:28:13 rohee Exp $$
d882 2
a883 2
CONFIGURE_SCRIPT?=	configure
CONFIGURE_ENV+=		PATH=${PORTPATH}
d1292 1
a1292 1
		${CONFIGURE_ENV} ${WRKSRC}/${CONFIGURE_SCRIPT} ${CONFIGURE_ARGS})
@


1.70
log
@sunsite.unc.edu changed its name to metalab.unc.edu + French mirror
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.69 1999/02/24 20:15:48 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.69 1999/02/24 20:15:48 marc Exp $$
d114 4
a481 2
# Don't change these!!!  These names are built into the _TARGET_USE macro,
# there is no way to refer to them cleanly from within the macro AFAIK.
d483 8
a494 1
PATCH_COOKIE?=		${WRKDIR}/.patch_done
d496 1
d599 3
d603 1
d1456 17
a1472 4
.if !make(real-fetch) \
	&& (!make(real-patch) || !defined(PATCH_CHECK_ONLY)) \
	&& (!make(real-package) || !defined(PACKAGE_NOINSTALL))
	@@${TOUCH} ${TOUCH_FLAGS} ${WRKDIR}/.${.TARGET:S/^real-//}_done
@


1.69
log
@Do not include @@name or @@cwd in packing lists created by the plist target;
they are not necessary as the proper names are generated when
the package is installed; including them only adds work as they
must be verified and changed when the port changes; thanks to
fgsch@@ for bringing this up
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.68 1999/02/24 12:34:46 espie Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.68 1999/02/24 12:34:46 espie Exp $$
d747 1
a747 1
	ftp://sunsite.unc.edu/pub/Linux/%SUBDIR%/ \
d749 2
a750 1
	ftp://ftp.funet.fi/pub/mirrors/sunsite.unc.edu/pub/Linux/%SUBDIR%/
@


1.68
log
@Declare phony target as phony targets. This may avert a few subtle bugs,
and it documents behavior as well.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.67 1999/02/21 00:50:28 espie Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.67 1999/02/21 00:50:28 espie Exp $$
a1753 2
	  ${ECHO} "@@cwd ${PREFIX}"; \
	  ${ECHO} "@@name ${PKGNAME}"; \
@


1.67
log
@internalize NEED_VERSION sub macros to avoid getting tangled with
user macros.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.66 1999/02/21 00:01:30 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.66 1999/02/21 00:01:30 marc Exp $$
d2172 16
@


1.66
log
@Follow up on espie suggestion: don't allow package registration
(following installation) if the COMMENT exceeds 60 characters
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.65 1999/02/18 19:22:45 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.65 1999/02/18 19:22:45 marc Exp $$
d33 1
a33 1
VERSION_REVISION=${FULL_REVISION:M[0-9]*.*}
d35 2
a36 2
VERSION=${VERSION_REVISION:C/\..*//}
REVISION=${VERSION_REVISION:C/.*\.//}
d38 2
a39 2
VERSION_NEEDED=${NEED_VERSION:C/\..*//}
REVISION_NEEDED=${NEED_VERSION:C/.*\.//}
d42 3
a44 3
	@@if [ ${VERSION_NEEDED} -gt ${VERSION} -o \
			${VERSION_NEEDED} -eq ${VERSION} -a \
				${REVISION_NEEDED} -gt ${REVISION} ]; \
@


1.65
log
@display ${PKGDIR}/MESSAGE after install (if it exists);
use cat(1) instead of more(1), though, so the port need not be
marked as interactive;  problem noted by fgsch@@openbsd.org
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.64 1999/02/18 00:01:47 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.64 1999/02/18 00:01:47 marc Exp $$
d2122 4
@


1.64
log
@use NO_SHARED_LIBS in lib-depends target instead of
testing specifically for the alpha
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.63 1999/02/17 23:52:56 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.63 1999/02/17 23:52:56 marc Exp $$
d1434 3
@


1.63
log
@oops: left out .endif in a cut/paste
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.62 1999/02/17 23:45:15 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.62 1999/02/17 23:45:15 marc Exp $$
d1909 1
a1909 1
.if (${MACHINE_ARCH} == "alpha")
@


1.62
log
@Define NO_SHARED_LIBS for those archs that do not support shared libs;
When selecting a packing list choose in order:
 o PLIST.<arch>
 o PLIST.noshared if NO_SHARED_LIBS is defined
 o PLIST
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.61 1999/02/17 13:00:42 espie Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.61 1999/02/17 13:00:42 espie Exp $$
d643 1
@


1.61
log
@Fix checksum logic: in a manual sequence of
make extract; make patch; make configure; make;
the checksum will only be checked ONCE (before extract), and not
every step of the way...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.60 1999/02/03 17:53:13 rohee Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.60 1999/02/03 17:53:13 rohee Exp $$
d98 3
a100 1
#				  while ${WRKOBJDIR} is local to every arch.
d367 7
d638 3
@


1.60
log
@Provisions for building in a separate directory tah sources
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.59 1999/01/24 02:04:20 marc Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.59 1999/01/24 02:04:20 marc Exp $$
d1047 1
a1047 1
extract: checksum
d1446 1
a1446 1
extract: checksum ${EXTRACT_COOKIE}
d1469 2
a1470 2
${EXTRACT_COOKIE}:
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} real-extract
@


1.59
log
@pass all install macros to configure; Kenneth R Westerback <krw@@tcn.net>
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.58 1999/01/08 23:45:48 pattonme Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.58 1999/01/08 23:45:48 pattonme Exp $$
d109 3
d580 2
d714 1
a714 1
    ftp://ftp.eu.net/X11/contrib/%SUBDIR%/ \
d865 2
a866 2
		  WRKDIR=${WRKDIR} WRKSRC=${WRKSRC} PATCHDIR=${PATCHDIR} \
		  SCRIPTDIR=${SCRIPTDIR} FILESDIR=${FILESDIR} \
d1010 1
a1010 1
	  DISTDIR=${DISTDIR} WRKDIR=${WRKDIR} WRKSRC=${WRKSRC} \
d1250 1
a1250 1
do-configure:
d1259 1
a1259 1
	@@(cd ${WRKSRC} && CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
d1264 1
a1264 1
		${CONFIGURE_ENV} ./${CONFIGURE_SCRIPT} ${CONFIGURE_ARGS})
d1271 3
d1278 1
a1278 1
	@@(cd ${WRKSRC}; ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} ${MAKEFILE} ${ALL_TARGET})
d1285 1
a1285 1
	@@(cd ${WRKSRC} && ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} ${MAKEFILE} ${INSTALL_TARGET})
@


1.58
log
@Removed all OPSYS conditionals and extraneous comments for readability.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.57 1998/12/19 16:52:22 espie Exp $
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.57 1998/12/19 16:52:22 espie Exp $$
d1256 4
a1259 3
	    INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
	    INSTALL_PROGRAM="${INSTALL_PROGRAM}" \
	    ${CONFIGURE_ENV} ./${CONFIGURE_SCRIPT} ${CONFIGURE_ARGS})
@


1.57
log
@avoid aliasing between MASTER_SITES and PATCH_SITES, e.g.,
MASTER_SITES=some_sites
PATCH_SITES=${MASTER_SITES}
MASTER_SITE_SUBDIR=one_dir
PATCH_SITE_SUBDIR=second_dir
now works
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.56 1998/12/18 12:00:46 form Exp $
d23 2
a24 3
# is listed), a port is maintained by the subscribers of the ports@@freebsd.org
# mailing list (OpenBSD: ports@@openbsd.org), and any correspondence
# should be directed there.  
a25 1
FreeBSD_MAINTAINER=	asami@@FreeBSD.ORG
a26 1
NetBSD_MAINTAINER=	agc@@netbsd.org
d31 1
a31 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.56 1998/12/18 12:00:46 form Exp $$
d59 6
a64 9
# ARCH			- The architecture, as returned by "uname -m".
# OPSYS			- Portability clause.  This is the operating system the
#				  makefile is being used on.  Automatically set to
#				  "FreeBSD," "NetBSD," or "OpenBSD" as appropriate.
# OPSYS_VER		- The current version if the operating system
# PORTSDIR		- The root of the ports tree.  Defaults:
#					FreeBSD/OpenBSD: /usr/ports
#					NetBSD:          /usr/pkgsrc
# DISTDIR 		- Where to get gzip'd, tarballed copies of original sources
a85 2
# MASTER_SITE_FREEBSD - If set, only use ftp.freebsd.org as the
#				  MASTER_SITE_OVERRIDE.
d92 1
a92 3
#				  Defaults: ports@@OpenBSD.ORG      (OpenBSD)
#							ports@@FreeBSD.ORG      (FreeBSD)
#                           packages@@NetBSD.ORG    (NetBSD)
d122 2
a123 2
# MIRROR_DISTFILE	- Whether the distfile is redistributable without restrictions.
#			  Defaults to "yes", set this to "no" if restrictions exist.
d264 1
a264 3
# HAVE_MOTIF	- If set, means system has Motif.  Typically set in
#				  /etc/make.conf (FreeBSD) or
#				  /etc/mk.conf (OpenBSD, NetBSD).
d266 1
a266 3
#				  dynamically.  Typically set in
#				  /etc/make.conf (FreeBSD) or
#				  /etc/mk.conf (OpenBSD, NetBSD).
a361 1
.if (${OPSYS} == "OpenBSD")
a364 6
.elif (${OPSYS} == "NetBSD")
DEF_UMASK?=		0022
NOCLEANDEPENDS=	yes
.else
DEF_UMASK?=		0022
.endif
a376 4
.if (${OPSYS} == "NetBSD")
PORTSDIR?=		/usr/pkgsrc
LOCALBASE?=		${DESTDIR}/usr/pkg
.else
a378 1
.endif
a461 7
# OpenBSD has perl5 in-tree
#
#.if defined(USE_PERL5)
#BUILD_DEPENDS+=		perl5.00404:${PORTSDIR}/lang/perl5
#RUN_DEPENDS+=		perl5.00404:${PORTSDIR}/lang/perl5
#.endif

a552 3
.if (${OPSYS} == "NetBSD")
MTREE_FILE=	/etc/mtree/BSD.pkg.dist
.else
a555 1
.endif
a558 1
.if (${OPSYS} == "OpenBSD")
a560 7
.elif (${OPSYS} == "NetBSD")
NEED_OWN_INSTALL_TARGET=	no
.include <bsd.own.mk>
SHAREOWN = ${DOCOWN}
SHAREGRP = ${DOCGRP}
SHAREMODE = ${DOCMODE}
.endif
a577 1
# XXX Is pwd -P available in FreeBSD's /bin/sh?
a747 5
# The second backup master site is ftp.freebsd.org
#
_MASTER_SITE_FREEBSD?=	\
	ftp://ftp.freebsd.org/pub/FreeBSD/distfiles/${DIST_SUBDIR}/

d751 2
a752 1
	${_MASTER_SITE_OPENBSD} ${_MASTER_SITE_FREEBSD}
a759 6
# If the user has this set, go to the FreeBSD repository for everything.
#
.if defined(MASTER_SITE_FREEBSD)
MASTER_SITE_OVERRIDE=  ${_MASTER_SITE_FREEBSD}
.endif

a776 14
# The following is a FreeBSD construct that does not work in OpenBSD.
# Since OpenBSD does not put packages in /cdrom/ports/packages it
# is safe to leave (but I may remove it in the future).
#
# Search CDROM first if mounted, symlink instead of copy if
# FETCH_SYMLINK_DISTFILES is set
.if exists(/cdrom/ports/distfiles)
MASTER_SITES:=	file:/cdrom/ports/distfiles/${DIST_SUBDIR}/ ${MASTER_SITES}
PATCH_SITES:=	file:/cdrom/ports/distfiles/${DIST_SUBDIR}/ ${PATCH_SITES}
.if defined(FETCH_SYMLINK_DISTFILES)
FETCH_BEFORE_ARGS+=	-l
.endif
.endif

a830 1
.if (${OPSYS} == "OpenBSD")
a831 5
.elif (${OPSYS} == "NetBSD")
MAINTAINER?=	packages@@NetBSD.ORG
.else
MAINTAINER?=	ports@@FreeBSD.ORG
.endif
a2048 3
.if (${OPSYS} == "NetBSD")
README_NAME=	${TEMPLATES}/README.pkg
.else
a2049 1
.endif
@


1.56
log
@make plist: do not add files from just installed ports (we wepend on) to PLIST.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.55 1998/12/17 18:25:06 espie Exp $
d34 1
a34 1
FULL_REVISION=$$OpenBSD: bsd.port.mk,v 1.55 1998/12/17 18:25:06 espie Exp $$
d784 1
a784 1
MASTER_SITES:=	${MASTER_SITES:S/%SUBDIR%/${MASTER_SITE_SUBDIR}/}
d786 1
@


1.55
log
@NEED_VERSION
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.54 1998/12/16 19:59:48 marc Exp $
d34 1
a34 1
FULL_REVISION=$$OpenBSD$$
d268 3
a270 3
# USE_MOTIF	- Set this in your port if it requires Motif or Lesstif.
#		  It will be built using Lesstif port unless Motif libraries
#		  found or HAVE_MOTIF is defined. See also REQUIRES_MOTIF.
d272 1
a272 1
# REQUIRES_MOTIF - Set this in your port if it requires Motif.  It will  be
d1438 1
a1543 1
	@@touch ${INSTALL_PRE_COOKIE}
@


1.54
log
@describe NO_WARNINGS; define in the "mirror-distfiles" target
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.53 1998/11/27 10:51:54 form Exp $
d30 24
@


1.53
log
@make plist: treat links to dirs as files, not dirs
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.52 1998/11/25 01:08:35 espie Exp $
d234 3
d1216 1
a1216 1
	@@make fetch __ARCH_OK=yes NO_IGNORE=yes
@


1.52
log
@- revert change now that we have patch -C
- fix PATCH_LIST so that is works
- add USE_AUTOCONF
- fix PATH env logic

plus some documentation...
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.51 1998/11/19 22:15:31 marc Exp $
d1782 1
a1782 1
	   if [ -d $$f ]; then dirs="$$ff $$dirs"; \
@


1.51
log
@checkpatch target and PATCH_CHECK_ONLY not available with OpenBSD
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.50 1998/11/19 04:20:09 espie Exp $
d72 3
a74 2
# GMAKE			- Set to path of GNU make if not in $PATH (default: gmake).
# XMKMF			- Set to path of `xmkmf' if not in $PATH (default: xmkmf -a ).
d157 5
d188 1
a188 1
#				  it in your $PATH (if it is an executable) and go
d224 1
a224 1
# FETCH_CMD		  - Full path to ftp/http fetch command if not in $PATH
d318 1
a318 1
#				  the same file. NOT AVAILABLE WITH OPENBSD!
d442 7
d484 1
d488 2
d501 2
d505 1
a505 1
MAKE_ENV+=		PATH=${PATH}:${LOCALBASE}/bin:${X11BASE}/bin PREFIX=${PREFIX} LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} MOTIFLIB="${MOTIFLIB}" CFLAGS="${CFLAGS}"
a535 3
# OpenBSD patch does not support the -C option/checkpatch target
#
.if (${OPSYS} != "OpenBSD")
a539 1
.endif
d648 1
d686 1
d703 3
d805 1
a805 1
# The following is a FreeBSD construct that dopes not work in OpenBSD.
d898 1
a898 1
CONFIGURE_ENV+=		PATH=${PATH}:${LOCALBASE}/bin:${X11BASE}/bin
d907 1
a907 1
          PATH=${PATH}:${LOCALBASE}/bin:${X11BASE}/bin \
d1265 2
a1266 1
		for i in ${PATCHDIR}/${PATCH_LIST}; do \
d1286 1
a1286 1
		done; \
d1294 3
d1451 1
a1451 1
		shift `expr $$# - 1`; \
d1556 1
a1556 3
# OpenBSD patch does not support the -C option; thus this target disabled
#
.if (${OPSYS} != "OpenBSD")
a1560 1
.endif
d1579 1
a1579 1
	@@pkg_delete -f ${PKGNAME}
d1886 2
a1887 1
	@@for i in ${DEPENDS_TMP}; do \
d1890 1
a1890 1
		if expr "$$dir" : '.*:' > /dev/null; then \
d1897 1
a1897 1
		if expr "$$prog" : \\/ >/dev/null; then \
d1939 1
a1939 1
		if expr "$$dir" : '.*:' > /dev/null; then \
d1964 1
a1964 1
		if expr "$$dir" : '.*:' > /dev/null; then \
d1995 1
a1995 1
		if expr "$$dir" : '.*:' > /dev/null; then \
@


1.50
log
@new functionalities:
- PATCH_LIST   for conditional patches
- addsum       for non destructive md5 checksum updates
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.49 1998/11/17 07:14:16 form Exp $
d312 1
a312 1
#				  the same file.
d518 3
d525 1
d1533 3
a1535 1

d1539 1
@


1.49
log
@Handle USE_MOTIF.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.47 1998/11/05 10:36:14 espie Exp $
d24 1
a24 1
# mailing list (OpenBSD: ports@@openbsd.org), and any correspondece
d117 1
a117 1
#				  to port this software to FreeBSD (default:
d119 2
d315 1
d388 2
d676 1
d1073 2
d1242 7
a1248 13
		if [ "`echo ${PATCHDIR}/patch-*`" = "${PATCHDIR}/patch-*" ]; then \
			${ECHO_MSG} "===>   Ignoring empty patch directory"; \
			if [ -d ${PATCHDIR}/CVS ]; then \
				${ECHO_MSG} "===>   Perhaps you forgot the -P flag to cvs co or update?"; \
			fi; \
		else \
			${ECHO_MSG} "===>  Applying ${OPSYS} patches for ${PKGNAME}" ; \
			for i in ${PATCHDIR}/patch-*; do \
				case $$i in \
					*.orig|*.rej|*~) \
						${ECHO_MSG} "===>   Ignoring patchfile $$i" ; \
						;; \
					*) \
d1253 10
a1262 4
						;; \
				esac; \
			done; \
		fi; \
d1674 20
@


1.48
log
@Test ${ONLY_FOR_ARCHS} against both ${ARCH} and ${MACHINE_ARCH}.
@
text
@d233 4
d439 3
d648 1
a648 1
.if defined(HAVE_MOTIF)
@


1.47
log
@- support for C++ in configure consistent with sys.mk
- support for USE_EGCC/USE_EGXX similar to USE_GMAKE
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.46 1998/10/05 05:13:34 form Exp $
d968 1
a968 1
.if ${MACHINE_ARCH} == "${__ARCH}"
d973 1
d975 3
@


1.46
log
@check write permissions to ${DISTDIR} before trying to fetch distfiles.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.45 1998/09/08 05:51:06 marc Exp $
d157 2
d427 8
d459 2
d1257 1
@


1.45
log
@don't generate @@exec ranlib for .a files (plist target)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.44 1998/09/07 22:33:19 marc Exp $
d1114 4
@


1.44
log
@sync with NetBSD where possible.  Fix WRKOBJDIR. Add deinstall target.
Make uninstall an alias for deinstall.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.43 1998/08/24 04:46:14 marc Exp $
d1702 1
a1702 3
	    if ${ECHO} $$f | ${GREP} -E -q -e '[^/]+\.a$$'; then \
	     ${ECHO} '@@exec ranlib %D/%F'; \
	    elif ${ECHO} $$f | ${GREP} -E -q -e '[^/]+\.so\.[0-9]+\.[0-9]+$$'; then \
@


1.43
log
@add -q to mtree invocation.  This requires version of mtree checked in
last week.
@
text
@d3 1
a3 2
#	$OpenBSD: bsd.port.mk,v 1.42 1998/08/21 06:57:19 marc Exp $
#	$NetBSD: $
d9 1
d24 2
a25 1
# mailing list, and any correspondece should be directed there.
d29 1
d35 1
a35 1
# ONLY_FOR_ARCHS- If a port only makes sense to certain architectures, this
d37 1
a37 1
#				  against the predefined ${MACHINE} value
d45 1
a45 1
#					NetBSD:          /usr/opt
d51 2
d55 2
d75 3
a77 1
#				  (default: ports@@FreeBSD.ORG).
a89 1
# beware! unless NOCLEANDEPENDS,  dependencies are also nuked on clean.
d107 2
d150 1
a150 1
# NOCLEANDEPENDS - Don't nuke dependent dirs on make clean.
d195 7
a201 4
#				  library.  Note that lib can be any regular expression,
#				  and you need two backslashes in front of dots (.) to
#				  supress its special meaning (e.g., use
#				  "foo\\.2\\.:${PORTSDIR}/utils/foo" to match "libfoo.2.*").
d215 1
a215 1
#				  (default: /usr/bin/fetch).
d220 8
d234 2
a235 2
#				  /etc/make.conf (FreeBSD,NetBSD) or
#				  /etc/mk.conf (OpenBSD).
d238 2
a239 2
#				  /etc/make.conf (FreeBSD,NetBSD) or
#				  /etc/mk.conf (OpenBSD).
d258 14
a271 8
# INSTALL_PROGRAM - A command to install binary executables.
# INSTALL_SCRIPT - A command to install executable scripts.
# INSTALL_DATA	- A command to install sharable data.
# INSTALL_MAN	- A command to install manpages (doesn't compress).
#
# If your port doesn't automatically compress manpages, set the following.
# Depending on the setting of NOMANCOMPRESS, the make rules will compress
# the manpages for you.
d273 2
d279 3
a281 1
# MANPREFIX		- The directory prefix for ${MAN<sect>} (default: ${PREFIX}).
d296 1
d307 5
d323 3
a329 3
# Get the architecture
ARCH!=	uname -m

d335 1
d338 3
d357 2
a358 1
PORTSDIR?=		/usr/opt
d361 1
a362 1
LOCALBASE?=		${DESTDIR}/usr/local
a367 21
.if !defined(NO_WRKDIR)
.if defined(OBJMACHINE)
WRKDIR?=		${.CURDIR}/work.${MACHINE}
.else
WRKDIR?=		${.CURDIR}/work
.endif
.else
WRKDIR?=		${.CURDIR}
.endif
.if defined(NO_WRKSUBDIR)
WRKSRC?=		${WRKDIR}
.else
WRKSRC?=		${WRKDIR}/${DISTNAME}
.endif

.if defined(WRKOBJDIR)
# XXX Is pwd -P available in FreeBSD's /bin/sh?
__canonical_PORTSDIR!=	cd ${PORTSDIR}; pwd -P
__canonical_CURDIR!=	cd ${.CURDIR}; pwd -P
PORTSUBDIR=		${__canonical_CURDIR:S,${__canonical_PORTSDIR}/,,}
.endif
d420 4
a423 1
BUILD_DEPENDS+=		gmake:${PORTSDIR}/devel/gmake
d425 1
d427 1
d429 2
a430 2
#BUILD_DEPENDS+=		perl5.00401:${PORTSDIR}/lang/perl5
#RUN_DEPENDS+=		perl5.00401:${PORTSDIR}/lang/perl5
a446 4
# How to do nothing.  Override if you, for some strange reason, would rather
# do something.
DO_NADA?=		/usr/bin/true

d463 1
a463 1
MAKE_ENV+=		PREFIX=${PREFIX} LOCALBASE=${LOCALBASE} X11BASE=${X11BASE} MOTIFLIB="${MOTIFLIB}" CFLAGS="${CFLAGS}"
d471 3
a503 1
EXTRACT_SUFX?=	.tar.gz
d510 1
d517 3
d523 1
d530 28
d569 8
d581 5
a585 1
			BSD_INSTALL_MAN="${INSTALL_MAN}"
d644 1
d658 1
a658 2
PORTSPATH?=	${PATH}:${X11BASE}/bin:${LOCALBASE}/bin
SETENV?=	/usr/bin/env PATH=${PORTSPATH}
d661 1
d666 4
d673 4
d680 3
a682 1
    ftp://ftp.eu.net/X11/contrib/%SUBDIR%/
d744 1
d803 2
d825 5
d831 1
d850 1
d858 2
a859 1
SCRIPTS_ENV+=	CURDIR=${.CURDIR} DISTDIR=${DISTDIR} \
d870 1
d874 1
d878 2
d889 3
d902 3
a904 1
.endfor
d906 2
a907 2
.if defined(_MANPAGES) && defined(MANCOMPRESSED)
_MANPAGES:=	${_MANPAGES:S/$/.gz/}
d910 2
d956 1
a956 1
.if ( ${MACHINE} == "${__ARCH}" || ${MACHINE_ARCH} == "${__ARCH}" )
d961 1
a961 5
.if ( ${MACHINE} != ${MACHINE_ARCH} )
IGNORE= "is only for ${ONLY_FOR_ARCHS}, not ${MACHINE} \(${MACHINE_ARCH}\)"
.else
IGNORE= "is only for ${ONLY_FOR_ARCHS}, not ${MACHINE}"
.endif
d991 2
d995 2
a996 2
.endif
.endif
d1150 8
d1165 1
a1165 1
	@@${MKDIR} ${WRKOBJDIR}/${PORTSUBDIR}
d1246 1
a1246 1
	@@(cd ${WRKSRC} && ${SETENV} ${XMKMF})
d1254 1
a1254 5
.if defined(USE_GMAKE)
	@@(cd ${WRKSRC}; ${SETENV} ${MAKE_ENV} ${GMAKE} ${MAKE_FLAGS} ${MAKEFILE} ${ALL_TARGET})
.else defined(USE_GMAKE)
	@@(cd ${WRKSRC}; ${SETENV} ${MAKE_ENV} ${MAKE} ${MAKE_FLAGS} ${MAKEFILE} ${ALL_TARGET})
.endif
d1261 1
a1261 11
.if defined(USE_GMAKE)
	@@(cd ${WRKSRC} && ${SETENV} ${MAKE_ENV} ${GMAKE} ${MAKE_FLAGS} ${MAKEFILE} ${INSTALL_TARGET})
.if defined(USE_IMAKE) && !defined(NO_INSTALL_MANPAGES)
	@@(cd ${WRKSRC} && ${SETENV} ${MAKE_ENV} ${GMAKE} ${MAKE_FLAGS} ${MAKEFILE} install.man)
.endif
.else defined(USE_GMAKE)
	@@(cd ${WRKSRC} && ${SETENV} ${MAKE_ENV} ${MAKE} ${MAKE_FLAGS} ${MAKEFILE} ${INSTALL_TARGET})
.if defined(USE_IMAKE) && !defined(NO_INSTALL_MANPAGES)
	@@(cd ${WRKSRC} && ${SETENV} ${MAKE_ENV} ${MAKE} ${MAKE_FLAGS} ${MAKEFILE} install.man)
.endif
.endif
d1332 1
a1332 1
		${ECHO_MSG} "      If so, you may wish to \`\`pkg_delete ${PKGNAME}'' and install"; \
d1355 3
d1377 1
a1377 1
.if make(real-install) && defined(_MANPAGES)
d1380 2
a1381 2
.for manpage in ${_MANPAGES}
	@@${GUNZIP_CMD} ${manpage}
d1385 9
a1393 2
.for manpage in ${_MANPAGES}
	@@${GZIP_CMD} ${manpage}
d1509 12
d1539 4
d1550 1
d1575 7
d1584 15
d1600 1
d1604 3
a1606 3
			for site in ${MASTER_SITES}; do \
				${ECHO} -n ${FETCH_CMD} ${FETCH_BEFORE_ARGS} $${site}$${file} "${FETCH_AFTER_ARGS}" '||' ; \
					break; \
d1615 1
d1617 1
a1617 2
				${ECHO} -n ${FETCH_CMD} ${FETCH_BEFORE_ARGS} $${site}$${file} "${FETCH_AFTER_ARGS}" '||' ; \
					break; \
d1621 3
a1623 3
	 done)
.endif
.endif
d1725 9
d1738 10
a1747 1
	@@${ECHO} ${PKGNAME}
d1756 1
a1756 1
			(cd $$dir ; ${MAKE} package-name package-depends); \
d1805 1
a1805 1
	@@PATH=${PORTSPATH}; for i in ${DEPENDS_TMP}; do \
d1814 1
d1818 1
a1818 1
				notfound=0; \
a1820 1
				notfound=1; \
d1823 7
a1829 7
			if which "$$prog" > /dev/null 2>&1 ; then \
				${ECHO_MSG} "===>  ${PKGNAME} depends on executable: $$prog - found"; \
				notfound=0; \
			else \
				${ECHO_MSG} "===>  ${PKGNAME} depends on executable: $$prog - not found"; \
				notfound=1; \
			fi; \
d1831 1
a1831 1
		if [ $$notfound != 0 ]; then \
d1855 1
a1855 1
		lib=`${ECHO} $$i | ${SED} -e 's/\\\.[0-9][0-9]*\\\.[0-9]*:.*//'`; \
d1880 1
a1880 1
		lib=`${ECHO} $$i | ${SED} -e 's/:.*//'`; \
d1888 5
a1892 5
		if /sbin/ldconfig -r | ${GREP} -q -e "-l$$lib"; then \
			${ECHO_MSG} "===>  ${PKGNAME} depends on shared library: $$lib - found"; \
		else \
			${ECHO_MSG} "===>  ${PKGNAME} depends on shared library: $$lib - not found"; \
			${ECHO_MSG} "===>  Verifying $$target for $$lib in $$dir"; \
d1894 1
a1894 1
				${ECHO_MSG} ">> No directory for $$lib.  Skipping.."; \
d1899 2
d1957 1
a1957 1
		(cd $$dir; ${MAKE} package-name depends-list); \
d1970 1
a1970 1
#  description-file|maintainer|categories|build deps|run deps
d1996 6
d2015 6
d2023 9
a2031 3
	@@${CAT} ${TEMPLATES}/README.port | \
		${SED} -e 's%%PORT%%'`${ECHO} ${.CURDIR} | ${SED} -e 's.*/\([^/]*/[^/]*\)$$\1'`'g' \
			-e 's%%PKG%%${PKGNAME}g' \
d2034 4
a2037 2
			-e 's%%BUILD_DEPENDS%%'"`${MAKE} print-depends-list`"'' \
			-e 's%%RUN_DEPENDS%%'"`${MAKE} print-package-depends`"'' \
d2039 1
d2086 4
a2089 1
		for dep in `make package-depends ECHO_MSG=/usr/bin/true | sort -u`; do \
@


1.42
log
@when checking for lib depends on the alpha (no shared libs)
check /usr/local/lib and /usr/X11R6/lib in addition to the standard place
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.41 1998/08/08 06:14:58 marc Exp $
d497 1
a497 1
MTREE_ARGS?=	-U -f ${MTREE_FILE} -d -e -p
@


1.41
log
@update 'comes with...' message so it is less confusing
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.40 1998/07/29 15:32:54 espie Exp $
d1703 1
a1703 1
		if ${LD} -r -o $$tmp -l$$lib; then \
@


1.40
log
@
Fix version number checking to handle ja-* correctly.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.39 1998/07/28 15:25:24 espie Exp $
d868 1
a868 1
IGNORE= "comes with ${OPSYS} as of release ${COMES_WITH}"
@


1.39
log
@
Document NOCLEANDEPENDS, make clean gotcha
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.38 1998/07/17 04:10:20 form Exp $
d1237 1
a1237 1
	@@if [ -d ${PKG_DBDIR}/${PKGNAME} -o "X$$(ls -d ${PKG_DBDIR}/${PKGNAME:C/-.*//g}-* 2> /dev/null)" != "X" ]; then \
@


1.38
log
@fix ONLY_FOR_ARCH test in bsd.port.mk
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.37 1998/07/13 03:11:14 todd Exp $
d82 1
d141 1
@


1.37
log
@typo
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.36 1998/07/12 04:34:39 todd Exp $
d853 1
a853 1
.if ${MACHINE} == "${__ARCH}"
d858 3
d862 1
@


1.36
log
@allow detection of older package versions with a new package from the ports tree
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.34 1998/07/08 03:27:17 marc Exp $
d1231 1
a1231 1
	@@if [ -d ${PKG_DBDIR}/${PKGNAME} -o "X$$(ls -d ${PKG_DBDIR}/${PKGNAME:C/-.*//g}-*> 2> /dev/null)" != "X" ]; then \
@


1.35
log
@remove comment from packing list that must be added when
the package is installed, not when the plist is created
@
text
@d1231 1
a1231 1
	@@if [ -d ${PKG_DBDIR}/${PKGNAME} ]; then \
@


1.34
log
@search for files in
ftp://ftp.openbsd.org/pub/OpenBSD/distfiles if they were not found in
ftp://ftp.openbsd.org/pub/OpenBSD/licensed.  The later directory is where
we will keep the tarballs for ports that can not be shipped on the CD.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.33 1998/07/07 04:02:47 marc Exp $
d1537 2
a1546 1
	  ${ECHO} "@@comment PACKAGE(arch=${ARCH}, opsys=${OPSYS}, vers=${OPSYS_VER})"; \
@


1.33
log
@minor tweaks to plist target
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.32 1998/07/06 22:06:51 marc Exp $
d56 1
d634 2
a635 1
	ftp://ftp.openbsd.org/pub/OpenBSD/distfiles/${DIST_SUBDIR}/
@


1.32
log
@New target 'plist' for port developers.  Generates /PLIST-auto
which should require minimal hacking to turn into /PLIST.
CAUTION: does not find files installed with tar, or any other install
method that does not change the timestamp of the installed file.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.31 1998/06/29 22:21:16 marc Exp $
d1541 2
a1543 2
	  ${ECHO} "@@name ${PKGNAME}"; \
	  ${ECHO} "@@cwd ${PREFIX}"; \
d1550 3
a1552 1
	    if ${ECHO} $$f | ${GREP} -E -q -e '/[^/]+\.so\.[0-9]+\.[0-9]+$$'; then \
@


1.31
log
@add support for architecture dependent packing lists;
PLIST.${ARCH} will be used if it exists, otherwise PLIST is used
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.30 1998/06/11 16:03:48 marc Exp $
d15 1
a15 1
# are listed below in the ${OSNAME}_MAINTAINER entries (this file
d40 1
d263 2
d284 1
a284 1
# Get the operating system type
d286 1
d413 1
d570 1
d859 1
a859 2
OS_VER!=	uname -r
.if ( ${OS_VER} >= ${COMES_WITH} )
d1342 1
d1394 1
a1394 1
	@@${RM} -f ${INSTALL_COOKIE} ${PACKAGE_COOKIE}
d1530 34
@


1.30
log
@update OpenBSD maintainer per toddf's request
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.29 1998/04/28 19:19:29 marc Exp $
d519 2
d523 3
d527 1
@


1.29
log
@Redo the way ONLY_FOR_ARCH was implemented.  The new method
allows things like "make clean" and a top level "make index" work
regardless of the architecture upon which the command is issued.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.28 1998/04/06 21:46:00 marc Exp $
d27 1
a27 1
OpenBSD_MAINTAINER=	joey@@OpenBSD.ORG
@


1.28
log
@existing fetch from cdrom was freebsd specific and would not work on OpenBSD;
Add code to copy or link from cdrom that works with OpenBSD.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.27 1998/04/05 04:20:38 marc Exp $
a280 18
.if defined(ONLY_FOR_ARCHS)
.for __ARCH in ${ONLY_FOR_ARCHS}
.if ${MACHINE} == "${__ARCH}"
__ARCH_OK=	1
.endif
.endfor
.else
__ARCH_OK=	1
.endif

.if !defined(__ARCH_OK)
.MAIN:	all

fetch fetch-list extract patch clean clean-depends configure build install reinstall package describe checkpatch checksum makesum all:
	@@echo "This port is only for ${ONLY_FOR_ARCHS},"
	@@echo "and you are running ${MACHINE}."
.else

d837 9
a1868 1
.endif
@


1.27
log
@Add ftp.openbsd.org as a MASTER_SITE_BACKUP before ftp.freebsd.org;
If MASTER_SITE_OPENBSD is defined only ftp.openbsd.org will be used;
Re-do the way COMES_WITH was implemented to allow overide on the
command line by defining NO_IGNORE.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.26 1998/03/27 03:30:43 marc Exp $
d679 4
d693 15
d998 5
@


1.26
log
@Add support for the COMES_WITH variable.  COMES_WITH is set to the OpenBSD
version that a port became part of the standard distribution.  If someone
tries to generate the port on that version (or later) they will see the
message "<port> comes with OpenBSD as of release ${COMES_WITH}".  Users
of earlier versions of OpenBSD will still generate the port.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.25 1998/02/19 20:41:02 marc Exp $
d54 1
d58 4
a61 2
# MASTER_SITE_FREEBSD - If set, only use ${MASTER_SITE_BACKUP} for
#				  MASTER_SITES.
d281 1
a281 13
# Get the operating system type
OPSYS!=	uname -s

.if defined(COMES_WITH)
OS_VER!=	uname -r
.if ( ${OS_VER} >= ${COMES_WITH} )
__NOT_NEEDED!= basename ${.CURDIR}
.endif
.endif
.if defined(__NOT_NEEDED)
fetch fetch-list extract patch clean clean-depends configure build install reinstall package describe checkpatch checksum makesum all:
	@@echo "${__NOT_NEEDED} comes with ${OPSYS} as of release ${COMES_WITH}
.elif defined(ONLY_FOR_ARCHS)
d299 3
d636 12
a647 1
# The primary backup site.
d649 7
a655 1
	ftp://ftp.freebsd.org/pub/FreeBSD/distfiles/${DIST_SUBDIR}/
d658 1
d660 1
a660 1
MASTER_SITE_OVERRIDE=  ${MASTER_SITE_BACKUP}
d664 2
d815 2
d836 5
@


1.25
log
@Handle make clean when port is not for machine's architecture
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.24 1998/02/11 00:40:55 niklas Exp $
d118 4
d278 13
a290 1
.if defined(ONLY_FOR_ARCHS)
a309 3

# Get the operating system type
OPSYS!=	uname -s
@


1.24
log
@Fix lib-depends case for alpha even better
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.22 1998/02/10 08:33:16 niklas Exp $
d287 1
a287 1
fetch fetch-list extract patch configure build install reinstall package describe checkpatch checksum makesum all:
@


1.23
log
@Fix lib-depends case for alpha
@
text
@d1588 1
a1588 1
		lib=`${ECHO} $$i | ${SED} -e 's/\\\.[0-9][0-9]*\\\.:.*//'`; \
@


1.22
log
@make LDCONFIG usable on alphas too, no need for special casing it anymore
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.21 1997/12/20 01:26:57 joey Exp $
d1588 1
a1588 1
		lib=`${ECHO} $$i | ${SED} -e 's/\\\.[0-9][0-9]*\\\.[0-9][0-9]*:.*//'`; \
@


1.21
log
@openbsd maintainer changed from imp to me
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.20 1997/12/20 01:24:08 todd Exp $
d577 1
a577 1
LDCONFIG?=	/sbin/ldconfig
@


1.20
log
@fix the PATH problem.
now things SHOULD compile with a PATH of /usr/bin:/bin ...
ANY executable not in these two subdirs should have ${SETENV} prepended
to set the right path.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.19 1997/12/17 10:06:45 niklas Exp $
d27 1
a27 1
OpenBSD_MAINTAINER=	imp@@OpenBSD.ORG
@


1.19
log
@append /usr/local/bin and /usr/X11R6/bin to PATH during ports builds
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.18 1997/12/04 08:26:23 niklas Exp $
d585 2
a586 1
SETENV?=	/usr/bin/env PATH=${PATH}:${X11BASE}/bin:${LOCALBASE}/bin
d1071 1
a1071 1
	@@(cd ${WRKSRC} && ${XMKMF})
d1538 1
a1538 1
	@@for i in ${DEPENDS_TMP}; do \
@


1.18
log
@Make WRKOBJDIR a bit smarter about existing links
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.15 1997/12/02 11:11:57 niklas Exp $
d585 1
a585 1
SETENV?=	/usr/bin/env
@


1.17
log
@do not destroy /dev/null on alpha
@
text
@d581 1
d989 7
a995 4
	@@${MKDIR} -p ${WRKOBJDIR}/${PORTSUBDIR}
	@@echo "${WRKDIR} -> ${WRKOBJDIR}/${PORTSUBDIR}"
	@@# XXX whatif a build is going on right now?  Is this wise?
	@@${LN} -sf ${WRKOBJDIR}/${PORTSUBDIR} ${WRKDIR}
@


1.16
log
@one way to deal with LIB_DEPENDS on alpha
@
text
@d1591 2
a1592 1
		if ${LD} -r -o /dev/null -l$$lib; then \
d1604 1
@


1.15
log
@We have perl5 in-tree
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.14 1997/09/21 10:58:41 niklas Exp $
d1581 24
d1627 1
@


1.14
log
@Accept WRKOBJDIR for NFS mounted ports tree and local objs.  DEF_UMASK is
different on OpenBSD.  Was this OK to commit, imp?
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.13 1997/09/09 15:11:28 imp Exp $
d406 5
a410 4
.if defined(USE_PERL5)
BUILD_DEPENDS+=		perl5.00401:${PORTSDIR}/lang/perl5
RUN_DEPENDS+=		perl5.00401:${PORTSDIR}/lang/perl5
.endif
@


1.13
log
@Merge 1.264 and 1.20 from FreeBSD's bsd.port.mk and bsd.port.subdir.mk respectively
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.11 1997/04/19 19:34:29 millert Exp $
d66 6
d304 3
d346 7
d577 1
d985 7
d995 1
d1173 1
a1173 1
	@@if [ `${SH} -c umask` != 0022 ]; then \
@


1.12
log
@COPY -> INSTALL_COPY and STRIP -> INSTALL_STRIP changes.
For some reason the previous commit did not grab these.
@
text
@d9 1
a9 1
# FreeBSD Id: bsd.port.mk,v 1.241 1996/12/25 02:27:44 imp Exp
d13 12
a24 7
# This is for this file, not for the ports that includes it, so it's
# commented out -- the person to contact if you have questions/
# suggestions about bsd.port.mk.
#
# MAINTAINER=	asami@@FreeBSD.ORG
#
# OPENBSD_MAINTAINER=	imp@@OpenBSD.ORG
d26 2
d36 1
d41 2
a42 2
#					OpenBSD/FreeBSD: /usr/ports
#					NetBSD: /usr/opt
d108 4
a111 2
#				  the "install" target.  This is the default if
#				  USE_IMAKE or USE_X11 is set.
d128 1
d130 1
a130 1
# USE_X11		- Says that the port uses X11.
d137 1
a137 1
# CONFIGURE_ENV  - Pass these env (shell-like) to configure if
d139 4
d180 1
a180 1
#				  (default: -C ${WRKDIR} -xzf).
d197 2
a198 1
#				  /etc/mk.conf.
d200 3
a202 1
#				  dynamically.  Typically set in /etc/mk.conf.
d206 2
d213 2
a214 6
# IS_DEPENDED_TARGET -
#				  The target to execute when a port is called as a
#				  dependency (default: install).  E.g., "make fetch
#				  IS_DEPENDED_TARGET=fetch" will fetch all the distfiles,
#				  including those of dependencies, without actually building
#				  any of them).
d286 3
d300 8
d312 1
a312 1
PORTSDIR?=		${DESTDIR}/usr/opt
d314 1
a314 1
PORTSDIR?=		${DESTDIR}/usr/ports
d316 2
a317 2
LOCALBASE?=		/usr/local
X11BASE?=		/usr/X11R6
d336 8
d345 9
d355 9
d365 9
d375 2
d388 5
a392 1
BUILD_DEPENDS+=               gmake:${PORTSDIR}/devel/gmake
d415 2
a416 2
.if exists(/usr/bin/md5)
MD5?=			/usr/bin/md5
d419 2
a420 2
.elif exists(/usr/local/bin/md5)
MD5?=			/usr/local/bin/md5
d422 1
a422 1
MD5?=			/sbin/md5
d430 3
a432 1
.if (${OPSYS} == "OpenBSD")
a433 2
.else
FETCH_CMD?=		/usr/bin/fetch
d475 6
a480 2
.if !defined(MTREE_LOCAL) && exists(/etc/mtree/BSD.local.dist)
MTREE_LOCAL=	/etc/mtree/BSD.local.dist
d483 1
a483 4
MTREE_ARGS?=	-U -f ${MTREE_LOCAL} -d -e -p
.if defined(USE_X11) || defined(USE_IMAKE) || !defined(MTREE_LOCAL)
NO_MTREE=	yes
.endif
d500 7
d513 4
d519 1
a519 1
PKG_ARGS=		-v -c ${PKGDIR}/COMMENT -d ${PKGDIR}/DESCR -f ${PKGDIR}/PLIST -p ${PREFIX} -P "`${MAKE} package-depends|sort -u`"
d532 2
a533 2
.if !defined(NO_MTREE) && defined(MTREE_LOCAL)
PKG_ARGS+=		-m ${MTREE_LOCAL}
d549 2
a550 1
ECHO?=		/bin/echo
d553 1
a553 6
SETENV?=	/usr/bin/env
RM?=		/bin/rm
MKDIR?=		/bin/mkdir -p
RMDIR?=		/bin/rmdir
AWK?=		/usr/bin/awk
BASENAME?=	/usr/bin/basename
d556 1
d560 5
a564 1
GUNZIP_CMD?=	/usr/bin/gunzip -f
d566 3
d577 31
a607 22
MASTER_SITE_XCONTRIB?=	\
	ftp://ftp.x.org/contrib/${MASTER_SITE_SUBDIR}/ \
	ftp://crl.dec.com/pub/X11/contrib/${MASTER_SITE_SUBDIR}/

MASTER_SITE_GNU?=	\
	ftp://prep.ai.mit.edu/pub/gnu/${MASTER_SITE_SUBDIR}/ \
	ftp://wuarchive.wustl.edu/systems/gnu/${MASTER_SITE_SUBDIR}/

MASTER_SITE_PERL_CPAN?=	\
	ftp://ftp.digital.com/pub/plan/perl/CPAN/modules/by-module/${MASTER_SITE_SUBDIR}/ \
	ftp://ftp.cdrom.com/pub/perl/CPAN/modules/by-module/${MASTER_SITE_SUBDIR}/

MASTER_SITE_TEX_CTAN?=  \
        ftp://ftp.cdrom.com/pub/tex/ctan/${MASTER_SITE_SUBDIR}/  \
        ftp://wuarchive.wustl.edu/packages/TeX/${MASTER_SITE_SUBDIR}/  \
        ftp://ftp.funet.fi/pub/TeX/CTAN/${MASTER_SITE_SUBDIR}/  \
        ftp.tex.ac.uk/public/ctan/tex-archive/${MASTER_SITE_SUBDIR}/

MASTER_SITE_SUNSITE?=	\
	ftp://sunsite.unc.edu/pub/Linux/${MASTER_SITE_SUBDIR}/ \
	ftp://ftp.infomagic.com/pub/mirrors/linux/sunsite/${MASTER_SITE_SUBDIR}/ \
	ftp://ftp.funet.fi/pub/mirrors/sunsite.unc.edu/pub/Linux/${MASTER_SITE_SUBDIR}/
d618 4
a621 3
# Empty declaration to avoid "variable MASTER_SITES recursive" error
MASTER_SITES?=
PATCH_SITES?=
d704 11
d770 1
d777 2
d783 2
d814 1
d831 5
a835 2
.if !defined(IS_DEPENDED_TARGET)
IS_DEPENDED_TARGET=	install
a836 3

.if !target(is_depended)
is_depended:	${IS_DEPENDED_TARGET}
d1010 1
a1010 1
					*.orig|*~) \
d1030 2
a1031 5
		cd ${.CURDIR} && ${SETENV} CURDIR=${.CURDIR} DISTDIR=${DISTDIR}\
		  WRKDIR=${WRKDIR} WRKSRC=${WRKSRC} PATCHDIR=${PATCHDIR} \
		  SCRIPTDIR=${SCRIPTDIR} FILESDIR=${FILESDIR} \
		  PORTSDIR=${PORTSDIR} PREFIX=${PREFIX} DEPENDS="${DEPENDS}" \
		  X11BASE=${X11BASE} /bin/sh ${SCRIPTDIR}/configure; \
a1058 5
	@@if [ `/bin/sh -c umask` != 0022 ]; then \
		${ECHO_MSG} "===>  Warning: your umask is \"`/bin/sh -c umask`"\".; \
		${ECHO_MSG} "      If this is not desired, set it to an appropriate value"; \
		${ECHO_MSG} "      and install this port again by \`\`make reinstall''."; \
	fi
d1076 1
a1076 1
	@@if [ -e ${PKGDIR}/PLIST ]; then \
d1137 16
d1158 7
a1164 1
		${MTREE_CMD} ${MTREE_ARGS} ${PREFIX}/; \
d1173 2
a1174 5
		cd ${.CURDIR} && ${SETENV} CURDIR=${.CURDIR} DISTDIR=${DISTDIR} WRKDIR=${WRKDIR} \
		  WRKSRC=${WRKSRC} PATCHDIR=${PATCHDIR} SCRIPTDIR=${SCRIPTDIR} \
		  FILESDIR=${FILESDIR} PORTSDIR=${PORTSDIR} PREFIX=${PREFIX} \
		  DEPENDS="${DEPENDS}" X11BASE=${X11BASE} \
			/bin/sh ${SCRIPTDIR}/${.TARGET:S/^real-/pre-/}; \
d1179 2
a1180 6
		cd ${.CURDIR} && ${SETENV} CURDIR=${.CURDIR} DISTDIR=${DISTDIR}\
		  WRKDIR=${WRKDIR} WRKSRC=${WRKSRC} PATCHDIR=${PATCHDIR} \
		  SCRIPTDIR=${SCRIPTDIR} FILESDIR=${FILESDIR} \
		  PORTSDIR=${PORTSDIR} PREFIX=${PREFIX} DEPENDS="${DEPENDS}" \
		  X11BASE=${X11BASE} \
			/bin/sh ${SCRIPTDIR}/${.TARGET:S/^real-/post-/}; \
d1301 3
a1303 5
reinstall: pre-reinstall install

pre-reinstall:
	@@${RM} -f ${INSTALL_COOKIE}
	@@${RM} -f ${PACKAGE_COOKIE}
d1344 4
a1347 2
	@@(cd ${_DISTDIR}; \
	${RM} -f ${DISTFILES} ${PATCHFILES})
d1349 1
a1349 1
	@@${RMDIR} ${_DISTDIR}  
d1405 1
a1405 1
			CKSUM2=`${GREP} "($$file)" ${MD5_FILE} | ${AWK} '{print $$4}'`; \
d1413 3
a1415 1
			elif [ "$$CKSUM" != "$$CKSUM2" ]; then \
d1417 1
a1417 1
				exit 1; \
d1431 5
a1435 5
		  if [ "$$OK" = "true" ]; then \
			${ECHO_MSG} "Checksums OK."; \
		  else \
			${ECHO_MSG} "There may be some inconsistencies, make sure the Makefile and md5 file"; \
			${ECHO_MSG} "(\"${MD5_FILE}\") are up to date."; \
d1456 6
a1461 3
	@@for i in ${RUN_DEPENDS} ${LIB_DEPENDS} ${DEPENDS}; do \
		dir=`${ECHO} $$i | ${SED} -e 's/.*://'`; \
		(cd $$dir ; ${MAKE} package-name package-depends); \
d1506 1
a1506 2
.if defined(NO_DEPENDS)
# Just print out messages
d1509 4
a1512 3
		dir=`${ECHO} $$i | ${SED} -e 's/.*://'`; \
		if expr "$$prog" : \\/ >/dev/null; then \
			${ECHO_MSG} "===>  ${PKGNAME} depends on file:  $$prog ($$dir)"; \
d1514 1
a1514 1
			${ECHO_MSG} "===>  ${PKGNAME} depends on executable:  $$prog ($$dir)"; \
a1515 5
	done
.else
	@@for i in ${DEPENDS_TMP}; do \
		prog=`${ECHO} $$i | ${SED} -e 's/:.*//'`; \
		dir=`${ECHO} $$i | ${SED} -e 's/.*://'`; \
d1534 1
a1534 1
			${ECHO_MSG} "===>  Verifying build for $$prog in $$dir"; \
d1538 1
a1538 1
				(cd $$dir; ${MAKE} ${.MAKEFLAGS} is_depended) ; \
d1554 1
a1554 2
.if defined(NO_DEPENDS)
# Just print out messages
d1557 7
a1563 7
		dir=`${ECHO} $$i | ${SED} -e 's/.*://'`; \
		${ECHO_MSG} "===>  ${PKGNAME} depends on shared library:  $$lib ($$dir)"; \
	done
.else
	@@for i in ${LIB_DEPENDS}; do \
		lib=`${ECHO} $$i | ${SED} -e 's/:.*//'`; \
		dir=`${ECHO} $$i | ${SED} -e 's/.*://'`; \
d1568 1
a1568 1
			${ECHO_MSG} "===>  Verifying build for $$lib in $$dir"; \
d1572 1
a1572 1
				(cd $$dir; ${MAKE} ${.MAKEFLAGS} is_depended) ; \
a1583 1
	@@${ECHO_MSG} "===>  ${PKGNAME} depends on:  ${DEPENDS}"
d1585 11
a1595 4
	@@for i in ${DEPENDS}; do \
		${ECHO_MSG} "===>  Verifying build for $$i"; \
		if [ ! -d $$i ]; then \
			${ECHO_MSG} ">> No directory for $$i.  Skipping.."; \
d1597 1
a1597 1
			(cd $$i; ${MAKE} ${.MAKEFLAGS} is_depended) ; \
d1612 4
a1615 3
	@@for i in ${FETCH_DEPENDS} ${BUILD_DEPENDS} ${LIB_DEPENDS} ${RUN_DEPENDS}; do \
		dir=`${ECHO} $$i | ${SED} -e 's/.*://'`; \
		if [ -d $$dir ] ; then (cd $$dir; ${MAKE} clean); fi \
d1619 4
a1622 2
	@@for dir in ${DEPENDS}; do \
		if [ -d $$dir ] ; then (cd $$dir; ${MAKE} clean); fi \
d1629 1
a1629 5
	@@for i in ${FETCH_DEPENDS} ${BUILD_DEPENDS} ${LIB_DEPENDS}; do \
		dir=`${ECHO} $$i | ${SED} -e 's/.*://'`; \
		(cd $$dir; ${MAKE} package-name depends-list); \
	done
	@@for dir in ${DEPENDS}; do \
d1647 4
a1650 4
	@@${ECHO} -n "${PKGNAME}|${.CURDIR}|"
	@@${ECHO} -n "${PREFIX}|"
	@@if [ -f ${PKGDIR}/COMMENT ]; then \
		${ECHO} -n "`${CAT} ${PKGDIR}/COMMENT`"; \
d1653 3
a1655 3
	fi
	@@if [ -f ${PKGDIR}/DESCR ]; then \
		${ECHO} -n "|${PKGDIR}/DESCR"; \
d1658 12
a1669 6
	fi
	@@${ECHO} -n "|${MAINTAINER}|${CATEGORIES}|"
	@@cd ${.CURDIR} && ${ECHO} -n `make depends-list|sort -u`
	@@${ECHO} -n "|"
	@@cd ${.CURDIR} && ${ECHO} -n `make package-depends|sort -u`
	@@${ECHO} ""
d1718 1
a1718 1
	@@if [ ! -f ${PKGDIR}/PLIST -o ! -f ${PKGDIR}/COMMENT -o ! -f ${PKGDIR}/DESCR ]; then ${ECHO} "** Missing package files for ${PKGNAME} - installation not recorded."; exit 1; fi
d1727 2
a1728 2
		${CP} ${PKGDIR}/DESCR ${PKG_DBDIR}/${PKGNAME}/+DESC; \
		${CP} ${PKGDIR}/COMMENT ${PKG_DBDIR}/${PKGNAME}/+COMMENT; \
d1738 8
a1745 4
	else \
		${ECHO_MSG} "===>  ${PKGNAME} is already installed - perhaps an older version?"; \
		${ECHO_MSG} "      If so, you may wish to \`\`pkg_delete ${PKGNAME}'' and install"; \
		${ECHO_MSG} "      this port again by \`\`make reinstall'' to upgrade it properly."; \
@


1.11
log
@We use /etc/mk.conf not /etc/make.conf.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.10 1997/01/11 11:58:11 niklas Exp $
d423 1
a423 1
	${INSTALL} ${COPY} ${STRIP} -o ${BINOWN} -g ${BINGRP} -m ${BINMODE}
d425 1
a425 1
	${INSTALL} ${COPY} -o ${BINOWN} -g ${BINGRP} -m ${BINMODE}
d427 1
a427 1
	${INSTALL} ${COPY} -o ${SHAREOWN} -g ${SHAREGRP} -m ${SHAREMODE}
d429 1
a429 1
	${INSTALL} ${COPY} -o ${MANOWN} -g ${MANGRP} -m ${MANMODE}
@


1.10
log
@Support an ONLY_FOR_ARCHS var, that prohibits doing anything for a certain
port except for certain architectures.  If OBJMACHINE is set set WRKDIR to
work.${MACHINE}.  Fix a shell construct which pdksh interprets differently
than ash as it was written.  Make bsd.own.mk be auto-included in make(1)
invocations below this one.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.9 1996/12/25 20:10:09 imp Exp $
d182 1
a182 1
#				  /etc/make.conf.
d184 1
a184 1
#				  dynamically.  Typically set in /etc/make.conf.
@


1.9
log
@Merge our chagnes with FreeBSD's latest changes.  We should now
have identical bsd.port.mk files again.  This file has successfully
compiled many of the archivers, gnu make, and emacs (althought the emacs
deltas have not been merged back into the FreeBSD tree yet since I don't
have it working yet).

The FreeBSD Id line may be slightly off since I generated it by hand to match
the commit I just made there.
@
text
@d3 1
a3 1
#	$OpenBSD:$
d26 3
d252 18
d278 1
a278 1
NOMANCOMPRESS?=yes
d296 3
d300 1
d416 5
d861 1
a861 1
		if !(cd ${WRKDIR} && ${EXTRACT_CMD} ${EXTRACT_BEFORE_ARGS} ${_DISTDIR}/$$file ${EXTRACT_AFTER_ARGS});\
d1628 2
@


1.8
log
@bring in bsd.own.mk
@
text
@d1 4
a4 2
# -*- mode: Fundamental; tab-width: 4; -*-
#	$OpenBSD: bsd.port.mk,v 1.7 1996/10/22 14:01:19 niklas Exp $
d9 1
a9 1
# FreeBSD Id: bsd.port.mk,v 1.226 1996/09/24 06:48:22 asami Exp $
d19 2
d26 6
a31 1
# PORTSDIR		- The root of the ports tree (default: /usr/ports).
d33 1
a33 1
#				  (default: ${PORTSDIR}/distfiles/${DIST_SUBDIR}).
d36 1
a36 2
#				  locally (default:
#				   ftp://ftp.freebsd.org/pub/FreeBSD/distfiles/${DIST_SUBDIR}/)
d38 1
a38 2
#				  (see PATCHFILES below) if not found locally (default:
#				   ftp://ftp.freebsd.org/pub/FreeBSD/distfiles/${DIST_SUBDIR}/)
d40 4
d46 1
a46 1
# MASTER_SITE_FREEBSD - If set, only use the FreeBSD master repository for
d54 1
a54 2
# CATEGORIES	- A list of descriptive categories into which this port falls
#				  (default: orphans).
d72 1
a72 1
# DIST_SUBDIR	- Suffix to ${DISTDIR} (see above).  If set, all ${DISTFILES} 
d76 3
d102 1
a102 1
# NO_CDROM		- Use dummy (do-nothing) targets if FOR_CDROM is set.
d112 1
a112 1
# BROKEN		- Port is broken.
d199 2
a200 1
# Variables that serve as convenient "aliases" for your *-install targets:
a201 1
# Use these like: "${INSTALL_PROGRAM} ${WRKSRC}/prog ${PREFIX}/bin".
d207 10
d249 3
d256 3
a258 1
.include <bsd.own.mk>
d262 4
a265 1
# by individual Makefiles.
d267 1
d270 2
a271 1
DISTDIR?=		${PORTSDIR}/distfiles/${DIST_SUBDIR}
d322 3
d326 5
d337 1
d339 3
d368 1
d370 3
d409 1
a409 1
PKG_ARGS=		-v -c ${PKGDIR}/COMMENT -d ${PKGDIR}/DESCR -f ${PKGDIR}/PLIST -p ${PREFIX} -P "`${MAKE} package-depends|sort|uniq`"
d419 3
d440 1
a440 1
CAT+=		/bin/cat
d444 6
a449 1
MKDIR?=		/bin/mkdir
d451 3
a453 1
BASENAME?=	/usr/bin/basename
a454 3
CAT?=		/bin/cat
GREP?=		/usr/bin/grep
AWK?=		/usr/bin/awk
d462 29
a490 1
# If the user has this set, go to the FreeBSD respository for everything.
d492 1
a492 1
MASTER_SITE_OVERRIDE=  ftp://ftp.freebsd.org/pub/FreeBSD/distfiles/${DIST_SUBDIR}/
d501 2
a502 2
MASTER_SITES+=	ftp://ftp.freebsd.org/pub/FreeBSD/distfiles/${DIST_SUBDIR}/
PATCH_SITES+=	ftp://ftp.freebsd.org/pub/FreeBSD/distfiles/${DIST_SUBDIR}/
d522 28
d556 6
a561 1
CATEGORIES?=	orphans
d580 32
d635 12
a646 7
.if (defined(IS_INTERACTIVE) && defined(BATCH)) || \
	(!defined(IS_INTERACTIVE) && defined(INTERACTIVE)) || \
	(defined(REQUIRES_MOTIF) && !defined(HAVE_MOTIF)) || \
	(defined(NO_CDROM) && defined(FOR_CDROM)) || \
	(defined(RESTRICTED) && defined(NO_RESTRICTED)) || \
	defined(BROKEN)
IGNORE=	yes
d650 15
d666 1
a666 1
	@@${DO_NADA}
d668 1
a668 1
	@@${DO_NADA}
d670 1
a670 5
	@@${DO_NADA}
fetch:
	@@${DO_NADA}
configure:
	@@${DO_NADA}
d672 1
a672 1
	@@${DO_NADA}
d707 6
d723 6
a734 6
# Disable describe
.if defined(NO_DESCRIBE) && !target(describe)
describe:
	@@${DO_NADA}
.endif

d741 6
d750 1
d752 2
a754 5

# Disable install
.if defined(NO_INSTALL) && !target(install)
install: build
	@@${TOUCH} ${TOUCH_FLAGS} ${INSTALL_COOKIE}
d757 4
a760 4
# Disable patch
.if defined(NO_PATCH) && !target(patch)
patch: extract
	@@${TOUCH} ${TOUCH_FLAGS} ${PATCH_COOKIE}
d775 2
a776 2
	@@if [ ! -d ${DISTDIR} ]; then ${MKDIR} -p ${DISTDIR}; fi
	@@(cd ${DISTDIR}; \
d780 1
a780 1
				${ECHO_MSG} ">> ${DISTDIR}/$$file is a broken symlink."; \
d793 1
a793 1
			${ECHO_MSG} ">> port manually into ${DISTDIR} and try again."; \
d798 1
a798 2
	@@if [ ! -d ${DISTDIR} ]; then ${MKDIR} -p ${DISTDIR}; fi
	@@(cd ${DISTDIR}; \
d802 1
a802 1
				${ECHO_MSG} ">> ${DISTDIR}/$$file is a broken symlink."; \
d815 1
a815 1
			${ECHO_MSG} ">> port manually into ${DISTDIR} and try again."; \
d828 1
a828 1
	@@${MKDIR} -p ${WRKDIR}
d831 1
a831 1
		if !(cd ${WRKDIR} && ${EXTRACT_CMD} ${EXTRACT_BEFORE_ARGS} ${DISTDIR}/$$file ${EXTRACT_AFTER_ARGS});\
d844 1
a844 1
	@@(cd ${DISTDIR}; \
d866 1
a866 1
			${ECHO_MSG} "===>  Applying FreeBSD patches for ${PKGNAME}" ; \
d874 1
a874 1
							${ECHO_MSG} "===>   Applying FreeBSD patch $$i" ; \
d922 3
a924 3
		${ECHO_MSG} "===> Warning: your umask is \"`/bin/sh -c umask`"\".; \
		${ECHO_MSG} "     If this is not desired, set it to an appropriate value"; \
		${ECHO_MSG} "     and install this port again by \`\`make reinstall''."; \
d947 1
a947 1
				if ! ${MKDIR} -p ${PKGREPOSITORY}; then \
d971 1
a971 1
			if ! ${MKDIR} -p ${PACKAGES}/$$cat; then \
d1004 1
a1004 1
	@@cd ${.CURDIR} && ${MAKE} ${.MAKEFLAGS} run-depends
d1034 14
a1047 1
.if make(real-install)  && !defined(NO_PKG_REGISTER)
d1173 3
d1178 7
a1184 1
	@@${RM} -rf ${WRKDIR}
d1190 15
d1209 2
a1210 2
	@@if [ ! -d ${DISTDIR} ]; then ${MKDIR} -p ${DISTDIR}; fi
	@@(cd ${DISTDIR}; \
d1221 1
a1221 1
	@@(cd ${DISTDIR}; \
d1238 1
a1238 1
	@@if [ ! -d ${FILESDIR} ]; then ${MKDIR} -p ${FILESDIR}; fi
d1241 1
a1241 1
	 for file in ${DISTFILES} ${PATCHFILES}; do \
d1244 3
d1254 2
a1255 2
		(cd ${DISTDIR}; OK=""; \
		  for file in ${DISTFILES} ${PATCHFILES}; do \
d1259 5
a1263 1
				${ECHO_MSG} ">> No checksum recorded for $$file"; \
d1266 1
a1266 1
				${ECHO_MSG} ">> Checksum mismatch for $$file"; \
d1270 12
a1281 1
		  if [ "$$OK" = "" ]; then \
d1284 2
a1285 1
			${ECHO_MSG} "Checksums OK for files that have them."; \
d1377 1
a1377 1
			if which -s "$$prog"; then \
d1455 16
d1473 1
a1473 1
	@@for i in ${FETCH_DEPENDS} ${BUILD_DEPENDS} ${LIB_DEPENDS} ${DEPENDS}; do \
d1475 4
a1478 1
		(cd $$dir ; ${MAKE} package-name depends-list); \
d1508 1
a1508 1
	@@cd ${.CURDIR} && ${ECHO} -n `make depends-list|sort|uniq`
d1510 1
a1510 1
	@@cd ${.CURDIR} && ${ECHO} -n `make package-depends|sort|uniq`
d1540 1
a1540 1
	@@${ECHO} -n `make depends-list | sort | uniq`
d1549 1
a1549 1
	@@${ECHO} -n `make package-depends | sort | uniq`
d1561 1
a1561 1
	@@if [ ! -d ${PKG_DBDIR} ]; then ${RM} -f ${PKG_DBDIR}; ${MKDIR} -p ${PKG_DBDIR}; fi
d1567 1
a1567 1
		${MKDIR} -p ${PKG_DBDIR}/${PKGNAME}; \
d1581 3
a1583 3
		${ECHO_MSG} "===> ${PKGNAME} is already installed - perhaps an older version?"; \
		${ECHO_MSG} "     If so, you may wish to \`\`pkg_delete ${PKGNAME}'' and install"; \
		${ECHO_MSG} "     this port again by \`\`make reinstall'' to upgrade it properly."; \
@


1.7
log
@Sync with FreeBSD
@
text
@d2 1
a2 1
#	$OpenBSD: bsd.port.mk,v 1.6 1996/08/23 11:37:41 niklas Exp $
d230 1
@


1.6
log
@Merge changes from FreeBSD
@
text
@d2 1
a2 1
#	$OpenBSD: bsd.port.mk,v 1.5 1996/06/30 18:25:29 tholo Exp $
d7 1
a7 1
# FreeBSD Id: bsd.port.mk,v 1.221 1996/08/18 10:53:16 asami Exp $
d116 19
a134 17
# FETCH_DEPENDS - A list of "prog:dir" pairs of other ports this
#				  package depends in the "fetch" stage.  "prog" is the
#				  name of an executable.  make will search your $PATH
#				  for it and go into "dir" to do a "make all install"
#				  if it's not found.
# BUILD_DEPENDS - A list of "prog:dir" pairs of other ports this
#				  package depends to build (between the "extract"
#				  and "build" stages, inclusive).  "prog" is the name
#				  of an executable.  make will search your $PATH for
#				  it and go into "dir" to do a "make all install" if
#				  it's not found.
# RUN_DEPENDS	- A list of "prog:dir" pairs of other ports this package
#				  depends to run.  "prog" is the name of an
#				  executable.  make will search your $PATH for it and
#				  go into "dir" to do a "make all install" if it's not
#				  found.  This will be build during the "install" stage
#				  and its name will be put into the package as well.
d410 3
a418 1
MASTER_SITES?=	# to avoid "variable MASTER_SITES recursive" error
d423 10
d713 1
a713 1
	@@if [ -f ${SCRIPTDIR}/${CONFIGURE_SCRIPT} ]; then \
d718 1
a718 1
		  X11BASE=${X11BASE} /bin/sh ${SCRIPTDIR}/${CONFIGURE_SCRIPT}; \
d1227 1
a1227 1
		dir=`/bin/echo $$i | /usr/bin/sed -e 's/.*://'`; \
@


1.5
log
@Our tar(1) now lives in /bin
@
text
@d2 1
a2 1
#	$OpenBSD: bsd.port.mk,v 1.4 1996/06/11 10:38:02 deraadt Exp $
d7 2
d11 6
a47 1
# 
d87 4
d92 1
a92 2
# NO_CONFIGURE	- Use a dummy (do-nothing) configure target.
# NO_BUILD		- Use a dummy (do-nothing) build target.
d94 1
a94 2
# NO_INSTALL	- Use a dummy (do-nothing) install target.
# NO_CDROM		- Use dummy (do-nothing) targets if FOR_CDROM is set.
d122 2
a123 2
#				  package depends to build (somewhere between the
#				  "extract" to "build" stage).  "prog" is the name
d152 6
a157 2
# NCFTP			- Full path to ncftp command if not in $PATH (default: ncftp).
# NCFTPFLAGS    - Arguments to ${NCFTP} (default: -N).
d166 4
a169 1
#				  dynamically.
d181 10
a191 1
# 
d228 1
d281 1
a281 1
DO_NADA?=		echo -n
d293 1
a293 2
NCFTP?=			/usr/bin/ftp
NCFTPFLAGS?=
d302 1
d306 1
d339 10
d414 1
d497 1
a497 1
	@@${SETENV} CURDIR=${.CURDIR} DISTNAME=${DISTNAME} \
d543 6
d598 1
a598 2
				(${NCFTP} ${NCFTPFLAGS} $${site}$${file} ${NCFTPTAIL} || true); \
				if [ -f $$file -o -f `${BASENAME} $$file` ]; then \
d602 1
a602 1
			${ECHO_MSG} ">> Couldn't fetch it - please try to retreive this";\
d621 1
a621 2
				(${NCFTP} ${NCFTPFLAGS} $${site}$${file} ${NCFTPTAIL} || true); \
				if [ -f $$file -o -f `${BASENAME} $$file` ]; then \
d625 1
a625 1
			${ECHO_MSG} ">> Couldn't fetch it - please try to retreive this";\
d637 1
d640 1
d642 1
a642 1
		if ! (cd ${WRKDIR};${EXTRACT_CMD} ${EXTRACT_BEFORE_ARGS} ${DISTDIR}/$$file ${EXTRACT_AFTER_ARGS});\
a654 14
.if defined(PATCH_DEBUG)
	@@(cd ${DISTDIR}; \
	  for i in ${PATCHFILES}; do \
		${ECHO_MSG} "===>   Applying distribution patch $$i" ; \
		case $$i in \
			*.Z|*.gz) \
				${GZCAT} $$i | ${PATCH} ${PATCH_DIST_ARGS}; \
				;; \
			*) \
				${PATCH} ${PATCH_DIST_ARGS} < $$i; \
				;; \
		esac; \
	  done)
.else
d657 3
a669 2
.endif
.if defined(PATCH_DEBUG)
d671 21
a691 26
		${ECHO_MSG} "===>  Applying FreeBSD patches for ${PKGNAME}" ; \
		for i in ${PATCHDIR}/patch-*; do \
			case $$i in \
				*.orig|*~) \
					${ECHO_MSG} "===>   Ignoring patchfile $$i" ; \
					;; \
				*) \
					${ECHO_MSG} "===>   Applying FreeBSD patch $$i" ; \
					${PATCH} ${PATCH_ARGS} < $$i; \
					;; \
			esac; \
		done; \
	fi
.else
	@@if [ -d ${PATCHDIR} ]; then \
		${ECHO_MSG} "===>  Applying FreeBSD patches for ${PKGNAME}" ; \
		for i in ${PATCHDIR}/patch-*; do \
			case $$i in \
				*.orig|*~) \
					${ECHO_MSG} "===>   Ignoring patchfile $$i" ; \
					;; \
				*) \
					${PATCH} ${PATCH_ARGS} < $$i; \
					;; \
			esac; \
		done;\
a693 1
.endif
d699 6
a704 6
	@@if [ -f ${SCRIPTDIR}/configure ]; then \
		${SETENV} CURDIR=${.CURDIR} DISTDIR=${DISTDIR} WRKDIR=${WRKDIR} \
		  WRKSRC=${WRKSRC} PATCHDIR=${PATCHDIR} SCRIPTDIR=${SCRIPTDIR} \
		  FILESDIR=${FILESDIR} PORTSDIR=${PORTSDIR} PREFIX=${PREFIX} \
		  DEPENDS="${DEPENDS}" X11BASE=${X11BASE} \
		/bin/sh ${SCRIPTDIR}/configure; \
d707 1
a707 1
	@@(cd ${WRKSRC}; CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
d709 1
a709 1
	    INSTALL_PROGRAM="/usr/bin/install ${COPY} ${STRIP} -o ${BINOWN} -g ${BINGRP} -m ${BINMODE}" \
d713 1
a713 1
	@@(cd ${WRKSRC}; ${XMKMF})
d732 5
d738 1
a738 1
	@@(cd ${WRKSRC}; ${SETENV} ${MAKE_ENV} ${GMAKE} ${MAKE_FLAGS} ${MAKEFILE} ${INSTALL_TARGET})
d740 1
a740 1
	@@(cd ${WRKSRC}; ${SETENV} ${MAKE_ENV} ${GMAKE} ${MAKE_FLAGS} ${MAKEFILE} install.man)
d743 1
a743 1
	@@(cd ${WRKSRC}; ${SETENV} ${MAKE_ENV} ${MAKE} ${MAKE_FLAGS} ${MAKEFILE} ${INSTALL_TARGET})
d745 1
a745 1
	@@(cd ${WRKSRC}; ${SETENV} ${MAKE_ENV} ${MAKE} ${MAKE_FLAGS} ${MAKEFILE} install.man)
d809 1
a809 1
	@@${MAKE} ${.MAKEFLAGS} fetch-depends
d812 1
a812 1
	@@${MAKE} ${.MAKEFLAGS} build-depends lib-depends misc-depends
d815 1
a815 1
	@@${MAKE} ${.MAKEFLAGS} run-depends
d827 1
a827 1
	@@${MAKE} ${.MAKEFLAGS} ${.TARGET:S/^real-/pre-/}
d829 1
a829 1
		${SETENV} CURDIR=${.CURDIR} DISTDIR=${DISTDIR} WRKDIR=${WRKDIR} \
d835 2
a836 2
	@@${MAKE} ${.MAKEFLAGS} ${.TARGET:S/^real-/do-/}
	@@${MAKE} ${.MAKEFLAGS} ${.TARGET:S/^real-/post-/}
d838 5
a842 4
		${SETENV} CURDIR=${.CURDIR} DISTDIR=${DISTDIR} WRKDIR=${WRKDIR} \
		  WRKSRC=${WRKSRC} PATCHDIR=${PATCHDIR} SCRIPTDIR=${SCRIPTDIR} \
		  FILESDIR=${FILESDIR} PORTSDIR=${PORTSDIR} PREFIX=${PREFIX} \
		  DEPENDS="${DEPENDS}" X11BASE=${X11BASE} \
d845 2
a846 2
.if make(real-install)
	@@${MAKE} ${.MAKEFLAGS} fake-pkg
d865 1
a865 1
	@@${MAKE} ${.MAKEFLAGS} real-fetch
d893 1
a893 1
	@@${MAKE} ${.MAKEFLAGS} real-extract
d895 1
a895 1
	@@${MAKE} ${.MAKEFLAGS} real-patch
d897 1
a897 1
	@@${MAKE} ${.MAKEFLAGS} real-configure
d899 1
a899 1
	@@${MAKE} ${.MAKEFLAGS} real-build
d901 1
a901 1
	@@${MAKE} ${.MAKEFLAGS} real-install
d903 1
a903 1
	@@${MAKE} ${.MAKEFLAGS} real-package
d943 1
a943 1
	@@${MAKE} PATCH_CHECK_ONLY=yes ${.MAKEFLAGS} patch
d972 3
a974 3
	@@${RM} -f ${EXTRACT_COOKIE} ${CONFIGURE_COOKIE} ${INSTALL_COOKIE} \
		${BUILD_COOKIE} ${PATCH_COOKIE}
.if defined(NO_WRKDIR)
a975 2
.else
	@@${RM} -rf ${WRKDIR}
d988 1
a988 1
				${ECHO} -n ${NCFTP} ${NCFTPFLAGS} $${site}$${file} "${NCFTPTAIL}" '||' ; \
d999 1
a999 1
				${ECHO} -n ${NCFTP} ${NCFTPFLAGS} $${site}$${file} "${NCFTPTAIL}" '||' ; \
d1027 1
a1027 1
			CKSUM=`${MD5} $$file | ${AWK} '{print $$4}'`; \
d1081 1
a1081 1
	@@${MAKE} ${.MAKEFLAGS} PACKAGE_NOINSTALL=yes real-package
d1090 3
a1092 3
	@@${MAKE} ${.MAKEFLAGS} fetch-depends
	@@${MAKE} ${.MAKEFLAGS} build-depends
	@@${MAKE} ${.MAKEFLAGS} run-depends
d1231 1
a1231 1
	@@${ECHO} -n "${PKGNAME}|${.CURDIR}/${PKGNAME}|"
d1244 1
a1244 1
	@@${ECHO} -n `make depends-list|sort|uniq`
d1246 1
a1246 1
	@@${ECHO} -n `make package-depends|sort|uniq`
d1257 1
a1257 1
	@@make README.html
@


1.4
log
@move to bin/md5 for `greater accessibility'
@
text
@d2 1
a2 1
#	$OpenBSD: bsd.port.mk,v 1.3 1996/06/10 11:23:16 niklas Exp $
d293 1
a293 1
EXTRACT_CMD?=	/usr/bin/tar
@


1.3
log
@Reintroduce the long patch(1) options
@
text
@d2 1
a2 1
#	$OpenBSD: bsd.port.mk,v 1.2 1996/06/03 23:07:28 niklas Exp $
d260 1
a260 1
MD5?=			/sbin/md5
@


1.2
log
@Use our ftp & patch
@
text
@d2 1
a2 1
#	$OpenBSD: bsd.port.mk,v 1.1 1996/06/03 22:47:10 niklas Exp $
d280 2
a281 2
PATCH_ARGS?=	-d ${WRKSRC} -N -s -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-d ${WRKSRC} -N -s -E ${PATCH_DIST_STRIP}
@


1.1
log
@Initial import of "ports" mk-files from FreeBSD, probably needs work
@
text
@d2 1
a2 1
#	$OpenBSD$
d267 2
a268 2
NCFTP?=			/usr/bin/ncftp
NCFTPFLAGS?=	-N
d280 2
a281 2
PATCH_ARGS?=	-d ${WRKSRC} --forward --quiet -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-d ${WRKSRC} --forward --quiet -E ${PATCH_DIST_STRIP}
@
