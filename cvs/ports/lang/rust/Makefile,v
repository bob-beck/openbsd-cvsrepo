head	1.38;
access;
symbols
	OPENBSD_6_0:1.25.0.2
	OPENBSD_6_0_BASE:1.25
	OPENBSD_5_9:1.15.0.2
	OPENBSD_5_9_BASE:1.15
	OPENBSD_5_8:1.8.0.4
	OPENBSD_5_8_BASE:1.8
	landry_20150406:1.1.1.1
	semarie:1.1.1;
locks; strict;
comment	@# @;


1.38
date	2017.02.18.13.15.48;	author landry;	state Exp;
branches;
next	1.37;
commitid	AZXHUw4YJRarl1Z6;

1.37
date	2017.02.15.12.52.35;	author landry;	state Exp;
branches;
next	1.36;
commitid	NM74A8PX4zxQ5FFL;

1.36
date	2017.02.02.08.02.50;	author landry;	state Exp;
branches;
next	1.35;
commitid	yNH1Zudd7906Mr5F;

1.35
date	2017.01.06.17.32.22;	author landry;	state Exp;
branches;
next	1.34;
commitid	1afG8dkX9POVHlRT;

1.34
date	2016.12.26.13.52.46;	author landry;	state Exp;
branches;
next	1.33;
commitid	iU6h7FSgPqiZKnfv;

1.33
date	2016.12.06.22.39.49;	author juanfra;	state Exp;
branches;
next	1.32;
commitid	6fv4mpjJ9hzcRB7g;

1.32
date	2016.11.12.16.42.24;	author danj;	state Exp;
branches;
next	1.31;
commitid	cBPPfooKD474cfpO;

1.31
date	2016.10.25.17.08.07;	author danj;	state Exp;
branches;
next	1.30;
commitid	CaXMwV9awx6WTFqu;

1.30
date	2016.10.05.16.48.10;	author danj;	state Exp;
branches;
next	1.29;
commitid	1jGt0pOT4pZLk8UH;

1.29
date	2016.09.03.19.51.47;	author naddy;	state Exp;
branches;
next	1.28;
commitid	dC5sGRweJUYVuh68;

1.28
date	2016.09.01.09.41.40;	author ajacoutot;	state Exp;
branches;
next	1.27;
commitid	JpxjG16s63uqATCW;

1.27
date	2016.08.31.08.33.19;	author landry;	state Exp;
branches;
next	1.26;
commitid	rjCKCwuvdXGdhOcu;

1.26
date	2016.08.13.07.40.43;	author landry;	state Exp;
branches;
next	1.25;
commitid	sOAWucDuPA9Tk5oP;

1.25
date	2016.06.12.13.07.42;	author sthen;	state Exp;
branches;
next	1.24;
commitid	5Dxro8R4GfmcvYV4;

1.24
date	2016.06.09.04.20.10;	author semarie;	state Exp;
branches;
next	1.23;
commitid	9ZDpi3B5rLvhZnQP;

1.23
date	2016.05.29.07.26.46;	author semarie;	state Exp;
branches;
next	1.22;
commitid	roUcrlyczCPIKJzh;

1.22
date	2016.05.25.06.39.35;	author semarie;	state Exp;
branches;
next	1.21;
commitid	MXspGwnScCXVczTc;

1.21
date	2016.05.09.14.08.41;	author semarie;	state Exp;
branches;
next	1.20;
commitid	pehSCneRWW5fdrSe;

1.20
date	2016.05.09.08.04.44;	author semarie;	state Exp;
branches;
next	1.19;
commitid	pyNRHMjV2xupMkry;

1.19
date	2016.04.14.03.42.12;	author semarie;	state Exp;
branches;
next	1.18;
commitid	nZIx9nodQL0nFe14;

1.18
date	2016.04.13.17.33.51;	author semarie;	state Exp;
branches;
next	1.17;
commitid	6yBO8KFZiq55gC0W;

1.17
date	2016.03.11.05.30.45;	author semarie;	state Exp;
branches;
next	1.16;
commitid	LChudS9WWntdF7ec;

1.16
date	2016.03.05.15.05.33;	author semarie;	state Exp;
branches;
next	1.15;
commitid	zHXYqXJVlpEY1lFN;

1.15
date	2016.01.25.05.36.05;	author semarie;	state Exp;
branches;
next	1.14;
commitid	K4io3y0qorUBvxJ6;

1.14
date	2016.01.22.09.03.14;	author semarie;	state Exp;
branches;
next	1.13;
commitid	soVo5L7O4D1hyBye;

1.13
date	2016.01.13.07.39.07;	author semarie;	state Exp;
branches;
next	1.12;
commitid	byiYh0dzYB8WFAob;

1.12
date	2015.12.10.17.53.57;	author semarie;	state Exp;
branches;
next	1.11;
commitid	rTjQKlw1EGnVsQEs;

1.11
date	2015.11.02.12.44.24;	author semarie;	state Exp;
branches;
next	1.10;
commitid	cBxaRRTWphtbz6LU;

1.10
date	2015.09.22.08.11.24;	author semarie;	state Exp;
branches;
next	1.9;
commitid	mOYkp4l6t2eZRG1l;

1.9
date	2015.08.28.06.51.07;	author semarie;	state Exp;
branches;
next	1.8;
commitid	5sBLchUKJep1BMsW;

1.8
date	2015.06.27.15.37.32;	author semarie;	state Exp;
branches;
next	1.7;
commitid	SygdTu2DEOHIWMnn;

1.7
date	2015.05.28.10.29.44;	author ajacoutot;	state Exp;
branches;
next	1.6;
commitid	hhxcIIy7kO8Dvbwt;

1.6
date	2015.05.28.10.17.24;	author pascal;	state Exp;
branches;
next	1.5;
commitid	020U4lCPk8wUkCOz;

1.5
date	2015.05.24.19.36.59;	author espie;	state Exp;
branches;
next	1.4;
commitid	ZCqvb9MHGJGzZYpd;

1.4
date	2015.05.19.23.42.38;	author bmercer;	state Exp;
branches;
next	1.3;
commitid	YJrXHRI4FMzxSRxO;

1.3
date	2015.04.18.12.19.09;	author landry;	state Exp;
branches;
next	1.2;
commitid	92ywKvARBAU6GKeh;

1.2
date	2015.04.08.13.02.57;	author sthen;	state Exp;
branches;
next	1.1;
commitid	DknHMiXcFMh5ej73;

1.1
date	2015.04.06.16.01.05;	author landry;	state Exp;
branches
	1.1.1.1;
next	;
commitid	uNXShIOtritg9vBI;

1.1.1.1
date	2015.04.06.16.01.05;	author landry;	state Exp;
branches;
next	;
commitid	uNXShIOtritg9vBI;


desc
@@


1.38
log
@Divide build time by at least three and various fixes, all from semarie@@

- stop pruning optimizations coming from the environment (ie OpenBSD's
  default -O2 -pipe) when building llvm - this resulted in a very slow
llvm, and in a veeery slow rust build, and an awfully slow rust
compiler. Yay. See https://github.com/rust-lang/rust/issues/39900
- only add cmake to BDEP when rustc is compiled with bundled llvm
- propagate verbose cmake flag to bundled llvm build

tested on i386 and amd64
@
text
@# $OpenBSD: Makefile,v 1.37 2017/02/15 12:52:35 landry Exp $

# snapshots are only available for amd64 and i386, for now
ONLY_FOR_ARCHS =	amd64 i386

COMMENT-main =		compiler for Rust Language
COMMENT-doc =		html documentation for rustc

V =			1.15.1
DISTNAME =		rustc-${V}-src
REVISION =		0

# rustc bootstrap version
RBV-amd64 =		1.15.0-20170203
RBV-i386 =		1.15.0-20170204
RBV =			${RBV-${MACHINE_ARCH}}

# cargo bootstrap version
CBV-amd64 =		0.16.0-20170213
CBV-i386 =		0.16.0-20170213
CBV =			${CBV-${MACHINE_ARCH}}

PKGNAME =		rust-${V}
PKGNAME-main =		rust-${V}
PKGNAME-doc =		rust-doc-${V}

MULTI_PACKAGES =	-main -doc

CATEGORIES =		lang

HOMEPAGE =		http://www.rust-lang.org/
MAINTAINER =		Sebastien Marie <semarie@@online.fr>

# both MIT and Apache2.0
# with portions covered by various BSD-like licenses
PERMIT_PACKAGE_CDROM =	Yes

WANTLIB-main =		${WANTLIB} c m pthread z
WANTLIB-doc =

MASTER_SITES =		https://static.rust-lang.org/dist/
MASTER_SITES0 =		http://kapouay.odns.fr/pub/rust/

DIST_SUBDIR =		rust
DISTFILES =		${DISTNAME}${EXTRACT_SUFX} \
			${RBOOTSTRAP} \
			${CBOOTSTRAP}

RBOOTSTRAP =		${RBOOTSTRAP-${MACHINE_ARCH}}
CBOOTSTRAP =		${CBOOTSTRAP-${MACHINE_ARCH}}
.for m in ${ONLY_FOR_ARCHS}
RBOOTSTRAP-$m =		rustc-bootstrap-${m}-${RBV-$m}.tar.gz:0
CBOOTSTRAP-$m =		../cargo/cargo-bootstrap-${m}-${CBV-$m}.tar.gz:0
SUPDISTFILES +=		${RBOOTSTRAP-$m} \
			${CBOOTSTRAP-$m}
.endfor

# per MACHINE_ARCH configuration
.if "${MACHINE_ARCH}" == "amd64"
TRIPLE_ARCH =		x86_64-unknown-openbsd
PKG_ARGS +=		-Damd64=1 -Di386=0
.elif "${MACHINE_ARCH}" == "i386"
TRIPLE_ARCH =		i686-unknown-openbsd
PKG_ARGS +=		-Damd64=0 -Di386=1
.endif

MODULES +=		gcc4 \
			lang/python
MODPY_RUNDEP =		No

# use embedded or ports version of LLVM
PORTS_LLVM ?=	No
.if ${PORTS_LLVM:L:Myes}
BUILD_DEPENDS +=	devel/llvm<4
.else
BUILD_DEPENDS +=	devel/cmake \
			devel/ninja
.endif

# rustllvm need c++11
MODGCC4_LANGS =		c++
MODGCC4_ARCHS =		*

# need to be keep in sync
LIBESTDC_VERSION =	17.0

# note: RUSTFLAGS extra flags passed to rust
# 		-L modgcc-libs : disambiguate libestdc++.so
MAKE_ENV =		RUSTFLAGS="-L ${WRKDIR}/modgcc-libs"

# build/configuration variables
SEPARATE_BUILD =	Yes
USE_GMAKE =		Yes

# need for libbacktrace
USE_LIBTOOL =		gnu

TEST_DEPENDS +=		${FULLPKGNAME-main}:${BUILD_PKGPATH} \
			devel/git

# - check datasize limit before configuring (and building)
pre-configure:
	@@if [ `ulimit -d` -lt 1572864 ]; then \
		echo datasize limit is too low - amd64 build takes approx 1.5GB; \
		exit 1; fi

# - generate config.toml file
# - copy libestdc++ from MODGCC4 to specific directory
#   in order to disambiguate version linking (having multiple libestdc++
#   at build time)
do-configure:
	echo '[build]' >${WRKBUILD}/config.toml
	echo 'rustc = "${WRKDIR}/rustc-bootstrap-${MACHINE_ARCH}-${RBV}/bin/rustc"' \
		>>${WRKBUILD}/config.toml
	echo 'cargo = "${WRKDIR}/cargo-bootstrap-${MACHINE_ARCH}-${CBV}/cargo"' \
		>>${WRKBUILD}/config.toml
	echo 'prefix = "${LOCALBASE}"' >>${WRKBUILD}/config.toml
	echo 'vendor = true' >>${WRKBUILD}/config.toml
	
	echo '[rust]' >>${WRKBUILD}/config.toml
	echo 'channel = "stable"' >>${WRKBUILD}/config.toml
	echo 'codegen-tests = false' >>${WRKBUILD}/config.toml
	
.if ${PORTS_LLVM:L:Myes}
	echo '[target.${TRIPLE_ARCH}]' >>${WRKBUILD}/config.toml
	echo 'llvm-config = "${LOCALBASE}/bin/llvm-config"' \
		>>${WRKBUILD}/config.toml
.else
	echo '[llvm]' >>${WRKBUILD}/config.toml
	echo 'static-libstdcpp = false' >>${WRKBUILD}/config.toml
	echo 'ninja = true' >>${WRKBUILD}/config.toml
.endif
	
	rm -rf ${WRKDIR}/modgcc-libs
	mkdir -p ${WRKDIR}/modgcc-libs
	cp ${LOCALBASE}/lib/libestdc++.so.${LIBESTDC_VERSION} \
		${WRKDIR}/modgcc-libs

BUILD_BIN = cd ${WRKBUILD} && exec ${SETENV} ${MAKE_ENV} \
	    ${MODPY_BIN} ${WRKSRC}/src/bootstrap/bootstrap.py

do-build:
	${BUILD_BIN} dist --verbose --jobs=${MAKE_JOBS}

COMPONENTS ?=	rustc rust-std rust-docs
do-install:
	rm -rf ${WRKBUILD}/_extractdist
.for _c in ${COMPONENTS}
	mkdir ${WRKBUILD}/_extractdist
	cd ${WRKBUILD}/_extractdist && tar zxf \
		${WRKBUILD}/build/dist/${_c}-${V}-${TRIPLE_ARCH}.tar.gz
	cd ${WRKBUILD}/_extractdist/${_c}-${V}-${TRIPLE_ARCH} && ./install.sh \
		--prefix="${PREFIX}" \
		--mandir="${PREFIX}/man"
	rm -rf ${WRKBUILD}/_extractdist
.endfor
	for lib in ${PREFIX}/lib/lib*.* ; do \
		libname=$${lib##*/} ; \
		test -e ${PREFIX}/lib/rustlib/${TRIPLE_ARCH}/lib/$${libname} && \
			ln -fs rustlib/${TRIPLE_ARCH}/lib/$${libname} \
				${PREFIX}/lib/$${libname} ; \
	done

post-install:
	# cleanup
	rm ${PREFIX}/bin/rust-lldb \
		${PREFIX}/lib/rustlib/{install.log,uninstall.sh,rust-installer-version} \
		${PREFIX}/lib/rustlib/components \
		${PREFIX}/lib/rustlib/manifest-*

do-test:
	${BUILD_BIN} test --verbose --jobs=${MAKE_JOBS}

# bootstrap target permits to regenerate the bootstrap archive
BOOTSTRAPDIR=${WRKDIR}/rustc-bootstrap-${MACHINE_ARCH}-${V}-new
bootstrap: build
	rm -rf ${BOOTSTRAPDIR}
	mkdir -p ${BOOTSTRAPDIR}/{bin,lib}
	${MAKE} clean=fake
	${MAKE} fake \
		PREFIX="${BOOTSTRAPDIR}" \
		COMPONENTS="rustc rust-std" \
		FAKE_SETUP=""
	rm -rf ${BOOTSTRAPDIR}/{man,share} \
		${BOOTSTRAPDIR}/bin/{rust-gdb,rustdoc}
	mv ${BOOTSTRAPDIR}/bin/rustc{,.bin}
	strip ${BOOTSTRAPDIR}/bin/rustc.bin \
		${BOOTSTRAPDIR}/lib/lib*.so \
		${BOOTSTRAPDIR}/lib/rustlib/${TRIPLE_ARCH}/lib/lib*.so
	cp ${WRKDIR}/rustc-bootstrap-${MACHINE_ARCH}-${RBV}/bin/rustc \
		${BOOTSTRAPDIR}/bin/rustc
	LD_LIBRARY_PATH="${BOOTSTRAPDIR}/lib" \
		ldd ${BOOTSTRAPDIR}/bin/rustc.bin \
		| sed -ne 's,.* \(/.*/lib/lib.*\.so.[.0-9]*\)$$,\1,p' \
		| xargs -r -J % cp % \
			${BOOTSTRAPDIR}/lib

.include <bsd.port.mk>
@


1.37
log
@Update to rust 1.15.1.

- switch to rustbuild build system instead of configure (the world
  definitely needed one more build system!)
- the build still takes +INF hours, this is being investigated

Note that rust will be a hard-requirement for gecko 54... sigh.

Tested by semarie@@ and myself on i386 & amd64.

All the hard work and countless build hours by semarie@@, thanks!
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.36 2017/02/02 08:02:50 landry Exp $
d11 1
a68 1
BUILD_DEPENDS +=	devel/cmake
d76 2
a77 1
BUILD_DEPENDS +=	devel/ninja
@


1.36
log
@Temporarly switch rust to build with embedded llvm.

rust doesnt build yet with llvm 4.0, which should be soon updated in the
portstree. Upstream rust support for llvm 4.0 is in the pipe.

From semarie@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.35 2017/01/06 17:32:22 landry Exp $
d9 1
a9 3
V =			1.14.0
BV-amd64 =		1.14.0-20161221
BV-i386 =		1.14.0-20161221
a10 1
REVISION =		0
d12 9
a20 4
#RUST_HASH !=		echo -n ${V} | md5 | cut -c1-8
RUST_HASH =		f5a209a9
SUBST_VARS +=		RUST_HASH
BV =			${BV-${MACHINE_ARCH}}
d45 2
a46 1
			${BOOTSTRAP}
d48 7
a54 4
BOOTSTRAP =		${BOOTSTRAP-${MACHINE_ARCH}}
.for m in i386 amd64
BOOTSTRAP-$m =		rustc-bootstrap-${m}-${BV-$m}.tar.gz:0
SUPDISTFILES +=		${BOOTSTRAP-$m}
d57 1
a57 3
WRKDIST =		${WRKDIR}/${DISTNAME:S/-src//}

# MACHINE_ARCH to TRIPLE_ARCH conversion
d60 1
d63 1
a63 14
.endif
SUBST_VARS +=		TRIPLE_ARCH

# PFRAG
.if ${MACHINE_ARCH} == amd64
PKG_ARGS += -Db64=1
.else
PKG_ARGS += -Db64=0
.endif

.if ${MACHINE_ARCH} == i386
PKG_ARGS += -Db32=1
.else
PKG_ARGS += -Db32=0
d71 8
d86 1
a86 2
# note: VERBOSE permit to unhide Makefile processing
# 	RUSTFLAGS extra flags passed to rust
d88 1
a88 5
#       RUST_LOG helper
MAKE_ENV =		VERBOSE=1 \
			RUSTFLAGS="-L ${WRKDIR}/modgcc-libs" \
			RUST_LOG="${RUST_LOG}"

a90 1
#
a93 15
CONFIGURE_STYLE =	simple
CONFIGURE_ARGS +=	--disable-valgrind-rpass \
			--disable-codegen-tests \
			--release-channel=stable \
			--local-rust-root="${WRKDIR}/rustc-bootstrap-${MACHINE_ARCH}-${BV}" \
			--prefix="${LOCALBASE}" \
			--mandir="${LOCALBASE}/man"

# VERSION and BOOTSTRAP are same major version
.if ${V:C/\.[0-9]+$//} == ${BV:C/\.[0-9]+-[0-9]+$//}
CONFIGURE_ARGS +=	--enable-local-rebuild
.endif

CONFIGURE_ENV +=	ac_cv_header_execinfo_h=no

d97 2
a98 4
ALL_TARGET +=		rustc-stage2 docs
TEST_TARGET =		check
TEST_ENV +=		ALLOW_NONZERO_RLIMIT_CORE=1
TEST_DEPENDS +=		devel/git
d106 1
a106 1
# - remove autodetected programs
d110 45
a154 6
# - copy bootstrap in stage0 (permit copying bootstrapped libs in stage0)
post-configure:
.for _v in CFG_CURL CFG_GIT CFG_CLANG CFG_VALGRIND CFG_PERF CFG_ISCC \
	CFG_JAVAC CFG_ANTLR4 CFG_BISON CFG_PANDOC CFG_GDB CFG_LLDB \
	CFG_GDB_VERSION CFG_ADB
	perl -pi -e 's/^${_v} .*/${_v} := /' ${WRKBUILD}/config.mk
d156 6
a161 7
	rm -rf ${WRKDIR}/modgcc-libs
	mkdir ${WRKDIR}/modgcc-libs
	cp ${LOCALBASE}/lib/libestdc++.so.${LIBESTDC_VERSION} ${WRKDIR}/modgcc-libs
	cp ${WRKDIR}/rustc-bootstrap-${MACHINE_ARCH}-${BV}/bin/rustc \
		${WRKBUILD}/${TRIPLE_ARCH}/stage0/bin
	cp ${WRKDIR}/rustc-bootstrap-${MACHINE_ARCH}-${BV}/lib/lib*.so* \
		${WRKBUILD}/${TRIPLE_ARCH}/stage0/lib
d165 4
a168 1
	rm ${PREFIX}/lib/rustlib/{install.log,uninstall.sh,rust-installer-version}
d170 2
a173 1
# it is based on stage3 binary
d175 1
a175 1
bootstrap: configure
d178 15
a192 4
	cd ${WRKBUILD} && exec ${SETENV} ${MAKE_ENV} ${GMAKE} rustc-stage3
	cp ${WRKBUILD}/${TRIPLE_ARCH}/stage3/bin/rustc ${BOOTSTRAPDIR}/bin
	strip ${BOOTSTRAPDIR}/bin/rustc
	ldd ${BOOTSTRAPDIR}/bin/rustc \
@


1.35
log
@Apply some black magic (shoplifted from lang/ghc) to fix
DISTFILES/SUPDISTFILES handling so that non-supported archs dont error
out in dpb with cryptic messages such as 'Incomplete info for
rust/rustc-bootstrap-sparc64-.tar.gz'

Reminder: DISTFILES is supposed to contain the list of files needed *on
the current arch* while SUPDISTFILES should have the list *of all files
that port might use* (think about make makesum)

discussed with semarie@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.34 2016/12/26 13:52:46 landry Exp $
d13 1
d76 1
a76 2
BUILD_DEPENDS +=	devel/cmake \
			devel/llvm
a104 1
			--llvm-root="${LOCALBASE}" \
@


1.34
log
@update rust to 1.14.0, from MAINTAINER semarie@@

for details, please see https://blog.rust-lang.org/2016/12/22/Rust-1.14.html

tested on i386 w/ llvm 3.9.0 here, and sebastien tested both amd64 & i386.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.33 2016/12/06 22:39:49 juanfra Exp $
d42 1
a42 1
			rustc-bootstrap-${MACHINE_ARCH}-${BV}.tar.gz:0
d44 5
a48 2
SUPDISTFILES =		rustc-bootstrap-amd64-${BV-amd64}.tar.gz:0 \
			rustc-bootstrap-i386-${BV-i386}.tar.gz:0
@


1.33
log
@Add support for i386 to rust. From semarie (MAINTAINER).
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.32 2016/11/12 16:42:24 danj Exp $
d9 3
a11 3
V =			1.13.0
BV-amd64 =		1.13.0-20161111
BV-i386 =		1.13.0-20161204
a12 1
REVISION =		0
d15 1
a15 1
RUST_HASH =		a4729905
d159 1
@


1.32
log
@Update to rust-1.13.0, from semarie who takes maintainership again

ok aja@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.31 2016/10/25 17:08:07 danj Exp $
d3 2
a4 3
# snapshots are only available for amd64, for now
ONLY_FOR_ARCHS =	amd64
PKG_ARCH-doc =		*
d10 2
a11 1
BV =			1.13.0-20161111
d13 1
d18 1
d42 2
a43 4
DISTFILES =		${DISTNAME}${EXTRACT_SUFX}
.if "${MACHINE_ARCH}" == "amd64"
DISTFILES +=		rustc-bootstrap-${MACHINE_ARCH}-${BV}.tar.gz:0
.endif
d45 2
a46 1
SUPDISTFILES =		rustc-bootstrap-amd64-${BV}.tar.gz:0
d53 2
d57 13
@


1.31
log
@Update to rust-1.12.1

For release note see https://blog.rust-lang.org/2016/10/20/Rust-1.12.1.html

Please note, semarie rebuilded the bootstrap due to a bug in rustc: 1.12.0
wasn't able to rebuild 1.12.1 without intrusive patches in the build system

From semarie, ok ajacoutot
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.30 2016/10/05 16:48:10 danj Exp $
d10 2
a11 2
V =			1.12.1
BV =			1.12.1-20161021
d15 1
a15 1
RUST_HASH =		5c6cf767
d27 1
d37 1
a37 1
MASTER_SITES0 =		http://semarie.free.fr/rust/
@


1.30
log
@Update to rust-1.12.0

From semarie (maintainer), ok ajacoutot
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.29 2016/09/03 19:51:47 naddy Exp $
d10 2
a11 2
V =			1.12.0
BV =			1.12.0-20160929
d15 1
a15 1
RUST_HASH =		40393716
d90 2
a91 2
# VERSION and BOOTSTRAP are same version
.if ${V} == ${BV:C/-[0-9]+$//}
@


1.29
log
@When testing the bootstrap version, the configure script failed to
use the included libraries. If a system library was bumped, the
binary wouldn't run at the configure stage, even if it ran fine
during the build.

So patch the configure script to pass LD_LIBRARY_PATH as it is done
during the build.  From Sebastien Marie.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.28 2016/09/01 09:41:40 ajacoutot Exp $
d10 2
a11 2
V =			1.11.0
BV =			1.11.0-20160819
a12 1
REVISION =		1
d15 1
a15 1
RUST_HASH =		39b92f95
d85 1
d92 1
a92 2
CONFIGURE_ARGS +=	--enable-local-rebuild \
			--local-rust-root="${WRKDIR}/rustc-bootstrap-${MACHINE_ARCH}-${BV}"
@


1.28
log
@Unbreak, from semarie:

When using --enable-local-rebuild option, the configure script will
check the existence of rustc binary from the local-rust-root directory
(/usr/local by default). It is the binary the build process will copy in
stage0 directory.

With the diff, we explicity use the bootstrap directory for configuring.
Note that we still we manually copying all the bootstrap files in
post-configure, as the standard build system will *not* copy the
libraries in lib/ which could be required to run rustc binary
(libraries like libc.so used by bootstrapper).
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.27 2016/08/31 08:33:19 landry Exp $
d13 1
a13 1
REVISION =		0
@


1.27
log
@Update to rust 1.11.0, from semarie@@, thanks!
All tests passing here.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.26 2016/08/13 07:40:43 landry Exp $
d13 1
d92 2
a93 1
CONFIGURE_ARGS +=	--enable-local-rebuild
d116 1
a116 1
# - copy bootstrap in stage0 (avoid downloading)
@


1.26
log
@Sebastien drops MAINTAINERship for lack of time... any takers ?
Thanks for your work on it !
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.25 2016/06/12 13:07:42 sthen Exp $
d10 2
a11 2
V =			1.9.0
BV =			${V}-20160608
a12 1
REVISION =		0
d14 2
a15 1
RUST_HASH !=		echo -n ${V} | md5 | cut -c1-8
d56 2
a57 1
BUILD_DEPENDS +=	devel/llvm
a69 1
# 		-Z print-link-args : unhide link call
d72 1
a72 1
			RUSTFLAGS="-L ${WRKDIR}/modgcc-libs -Z print-link-args" \
d89 5
d116 1
a116 1
.for _v in CFG_CURLORWGET CFG_GIT CFG_CLANG CFG_VALGRIND CFG_PERF CFG_ISCC \
@


1.25
log
@don't add rustc-bootstrap-${MACHINE_ARCH} to DISTFILES unless it's amd64
(currently the only arch in ONLY_FOR_ARCHS), otherwise fetch failures are
reported when dpb on any other arch tries to fetch a nonexistent
rustc-bootstrap-<somearch>. ok semarie@@ kili@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.24 2016/06/09 04:20:10 semarie Exp $
d13 1
a26 2

MAINTAINER =		Sebastien Marie <semarie@@openbsd.org>
@


1.24
log
@lang/rust: change bootstrap method

OK juanfra@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.23 2016/05/29 07:26:46 semarie Exp $
d41 1
d43 1
@


1.23
log
@lang/rust update to 1.9.0

- changes in Makefile to make it compute itself the RUST_HASH value

- use new configure option --disable-codegen-tests as with don't have FileCheck
  (from llvm) binary. remove the patches in configure and src/compiletest/runtest.rs

- disable (for now) two news tests added with unix socket support, that doesn't
  pass. I will investigate them later.

- disable run-pass/backtrace test. The support of libbacktrace has been remove
  recently.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.22 2016/05/25 06:39:35 semarie Exp $
d11 1
a22 3
# the snapshot version should be the version in src/snapshots.txt
SNAPSHOT-amd64 =	rust-stage0-2016-03-18-235d774-openbsd-x86_64-6d5adfe4301d158be8a5a33fb2e11bf857475cb3.tar.bz2

d41 1
a41 3
.if defined(SNAPSHOT-${MACHINE_ARCH})
DISTFILES +=            ${SNAPSHOT-${MACHINE_ARCH}}:0
.endif
d43 1
a43 1
SUPDISTFILES =		${SNAPSHOT-amd64}:0
d108 1
a108 1
# - copy snapshot in stage0 (avoid downloading a snapshot)
d118 1
a118 1
	cp ${WRKDIR}/rust-stage0/bin/rustc \
d120 1
a120 1
	cp ${WRKDIR}/rust-stage0/lib/lib*.so* \
d126 15
a140 1
	
@


1.22
log
@lang/rust: fallback to LOCALBASE for sysroot

- std::env::current_exe() returns an error instead of returning wrong
  pathname (no complete, but rust build scripts makes (bad)
  assumptions that I couldn't patch for now).

- rustc / rustdoc to use CFG_PREFIX (configure --prefix value) when
  std::env::current_exe() return an error

- remove the installed wrapper used to pass --sysroot argument to
  rustc (the wrapper was used for workaround the problem differently
  for rustc, but didn't resolv the problem for rustdoc as it doesn't
  have --sysroot argument).

looks ok edd@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.21 2016/05/09 14:08:41 semarie Exp $
d10 1
a10 2
V =			1.8.0
RUST_HASH =		4fda350b
a11 1
REVISION =		1
d13 1
d23 1
a23 1
SNAPSHOT-amd64 =	rust-stage0-2016-02-17-4d3eebf-openbsd-x86_64-266b485dc1658ceb1b119ea57ff5fab705003776.tar.bz2
d86 1
@


1.21
log
@lang/rust: new bootstrap for TIB (updated archive as the previous was busted)
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.20 2016/05/09 08:04:44 semarie Exp $
d13 1
a13 1
REVISION =		0
a129 6
	# host binary wrapper
	${INSTALL_PROGRAM_DIR} \
		${PREFIX}/lib/rustlib/${TRIPLE_ARCH}/bin
	mv ${PREFIX}/bin/rustc ${PREFIX}/lib/rustlib/${TRIPLE_ARCH}/bin
	${SUBST_PROGRAM} -c \
		files/rustc ${PREFIX}/bin/rustc
@


1.20
log
@lang/rust: new bootstrap for TIB
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.19 2016/04/14 03:42:12 semarie Exp $
d24 1
a24 1
SNAPSHOT-amd64 =	rust-stage0-2016-02-17-4d3eebf-openbsd-x86_64-99f710b8226e6ac8010c4924fc107cda5268d50e.tar.bz2
@


1.19
log
@add plist update too in lang/rust
(and bump revision)

bad semarie@@, no cookie.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.18 2016/04/13 17:33:51 semarie Exp $
d24 1
a24 1
SNAPSHOT-amd64 =	rust-stage0-2016-02-17-4d3eebf-openbsd-x86_64-ac957c6b84de2bd67f01df085d9ea515f96e22f3.tar.bz2
@


1.18
log
@update lang/rust to 1.8.0

ok juanfra@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.17 2016/03/11 05:30:45 semarie Exp $
d13 1
@


1.17
log
@lang/rust: use devel/llvm for building

switch from embedded version of LLVM to system version.

OK juanfra@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.16 2016/03/05 15:05:33 semarie Exp $
d10 2
a11 2
V =			1.7.0
RUST_HASH =		6a154fe0
a12 1
REVISION =		0
d23 1
a23 1
SNAPSHOT-amd64 =	rust-stage0-2015-12-18-3391630-openbsd-x86_64-6c8aab2c8a169274942f9a15e460069a3ff64be9.tar.bz2
@


1.16
log
@update lang/rust to 1.7.0

"looks reasonable" bmercer@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.15 2016/01/25 05:36:05 semarie Exp $
d13 1
d36 1
a36 1
WANTLIB-main =		${WANTLIB} c m pthread
d60 1
d88 1
a95 4

.ifdef LOCAL_LLVM_FOR_RUST
CONFIGURE_ARGS +=	--llvm-root="${LOCAL_LLVM_FOR_RUST}"
.endif
@


1.15
log
@lang/rust: remove python run-depends

it is only needed at compile-time.

ok ajacoutot@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.14 2016/01/22 09:03:14 semarie Exp $
d10 2
a11 2
V =			1.6.0
RUST_HASH =		ca9f0d77
a12 1
REVISION =		0
d23 1
a23 1
SNAPSHOT-amd64 =	rust-stage0-2015-08-11-1af31d4-openbsd-x86_64-9cae790c4ca19b1b29a048605ce249fe1c20a498.tar.bz2
@


1.14
log
@update lang/rust to 1.6.0

ok juanfra@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.13 2016/01/13 07:39:07 semarie Exp $
d13 1
d60 1
@


1.13
log
@install libraries with rustc

- remove now unneeded MAKE_ENV option to pass --sysroot argument to bootstrapper
- backport the latest changes for building rustc under openbsd
- switch the install from installing a stage3 rustc binary to installing a stage2 rustc binary (and all required libraries)

ok juanfra@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.12 2015/12/10 17:53:57 semarie Exp $
d10 2
a11 2
V =			1.5.0
RUST_HASH =		35c36e89
a12 1
REVISION =		0
@


1.12
log
@update lang/rust to 1.5.0

ok landry@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.11 2015/11/02 12:44:24 semarie Exp $
d13 1
a71 2
#       RUSTFLAGS_STAGE0 extra flags passed to stage0
#       	--sysroot force sysroot (due to limitation of us bootstrapper)
a74 1
			RUSTFLAGS_STAGE0="--sysroot ${WRKBUILD}/${TRIPLE_ARCH}/stage0" \
d98 1
a98 3
ALL_TARGET +=		rustc-stage3 \
			${TRIPLE_ARCH}/stage3/bin/rustdoc \
			docs
d128 5
a132 6

# do-install: don't use the default install target
do-install:
	# host binary
	${INSTALL_PROGRAM_DIR} ${PREFIX}/lib/rustlib/${TRIPLE_ARCH}/bin
	${INSTALL_PROGRAM} ${WRKBUILD}/${TRIPLE_ARCH}/stage3/bin/rustc \
d134 1
a136 10
	${INSTALL_PROGRAM} ${WRKBUILD}/${TRIPLE_ARCH}/stage3/bin/rustdoc \
		${PREFIX}/bin/rustdoc
	
	# data
	${INSTALL_DATA} \
		${WRKSRC}/man/{rustc,rustdoc}.1 \
		${PREFIX}/man/man1
	${INSTALL_DATA_DIR} ${PREFIX}/share/doc/rust
	${INSTALL_DATA} ${WRKSRC}/{COPYRIGHT,LICENSE-APACHE,LICENSE-MIT,README.md} \
		${PREFIX}/share/doc/rust
a137 10
	# target libraries
	${INSTALL_DATA_DIR} ${PREFIX}/lib/rustlib/${TRIPLE_ARCH}/lib
	${INSTALL_DATA} \
		${WRKBUILD}/${TRIPLE_ARCH}/stage3/lib/rustlib/${TRIPLE_ARCH}/lib/lib* \
		${PREFIX}/lib/rustlib/${TRIPLE_ARCH}/lib
	
	# html documentation
	cp -R ${WRKBUILD}/doc ${PREFIX}/share/doc/rust/html
	chmod -R a+rX ${PREFIX}/share/doc/rust/html

@


1.11
log
@update lang/rust to 1.4.0

tested by mmc@@ and bmercer@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.10 2015/09/22 08:11:24 semarie Exp $
d10 2
a11 2
V =			1.4.0
RUST_HASH =		1bf6e69c
@


1.10
log
@update lang/rust to 1.3.0

ok landry@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.9 2015/08/28 06:51:07 semarie Exp $
d10 2
a11 2
V =			1.3.0
RUST_HASH =		198068b3
d23 1
a23 1
SNAPSHOT-amd64 =	rust-stage0-2015-07-26-a5c12f4-openbsd-x86_64-8b21d574a65c38e7c7b0bbbb8d675d8a44cec214.tar.bz2
d105 1
@


1.9
log
@update rust to 1.2.0

ok jca@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.8 2015/06/27 15:37:32 semarie Exp $
d10 2
a11 2
V =			1.2.0
RUST_HASH =		62abc69f
d23 1
a23 1
SNAPSHOT-amd64 =	rust-stage0-2015-05-24-ba0e1cd-openbsd-x86_64-7c249db2a0f4e6ace9c3a343ba62c990635d665a.tar.bz2
@


1.8
log
@Update to rust-1.1.0

OK landry@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.7 2015/05/28 10:29:44 ajacoutot Exp $
d10 2
a11 2
V =			1.1.0
RUST_HASH =		7d23ff90
d23 1
a23 1
SNAPSHOT-amd64 =	rust-stage0-2015-04-27-857ef6e-openbsd-x86_64-20046defe7d1f3f37e25b5b2714cd54e61cabc61.tar.bz2
d29 1
a29 1
MAINTAINER =		Sebastien Marie <semarie-openbsd@@latrappe.fr>
@


1.7
log
@Bump LIBESTDC_VERSION after default gcc4 switched to 4.9.
That thing should be reworked somehow...
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.6 2015/05/28 10:17:24 pascal Exp $
d10 2
a11 1
V =			1.0.0
d14 2
a18 2
REVISION-doc =		0
REVISION-main =		1
d23 1
a23 1
SNAPSHOT-amd64 =	rust-stage0-2015-03-27-5520801-openbsd-x86_64-9844cc1a6203336e717ef422709ff413b625b450.tar.bz2
d123 1
@


1.6
log
@gcc4 bumps, reminded by aja@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.5 2015/05/24 19:36:59 espie Exp $
d17 1
a17 1
REVISION-main =		0
d64 1
a64 1
LIBESTDC_VERSION =	16.0
@


1.5
log
@fix bulk build, make sure we don't grab execinfo.h by mistake
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.4 2015/05/19 23:42:38 bmercer Exp $
d16 2
@


1.4
log
@Update to rust-1.0.0, from SÃ©bastien Marie. Tested by myself, sthen, and afresh, OK sthen@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.3 2015/04/18 12:19:09 landry Exp $
d87 2
@


1.3
log
@Update to rust-1.0.0beta2, from maintainer Sébastien Marie

Ensure we link against the correct libestdc++ version.
Remove a patch merged upstream.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.2 2015/04/08 13:02:57 sthen Exp $
d10 2
a11 2
V =			1.0.0beta2
DISTNAME =		rustc-1.0.0-beta.2-src
d20 1
a20 1
SNAPSHOT-amd64 =	rust-stage0-2015-03-27-5520801-openbsd-x86_64-afab969e747a3fc72c357155ca82891d2b485b36.tar.bz2
d84 1
a84 1
			--release-channel=beta \
@


1.2
log
@s/ONLY_FOR_ARCHS-main/ONLY_FOR_ARCHS/, -docs doesn't build on !amd64 either
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.1.1.1 2015/04/06 16:01:05 landry Exp $
d10 2
a11 2
V =			1.0.0beta
DISTNAME =		rustc-1.0.0-beta-src
a31 1
# "make port-lib-depends-check" can help
d61 2
a62 1
#TEST_DEPENDS =		???
d66 1
d72 1
a72 1
			RUSTFLAGS="-Z print-link-args" \
d108 3
d118 2
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
# $OpenBSD$
d4 1
a4 1
ONLY_FOR_ARCHS-main =	amd64
@


1.1.1.1
log
@Import rust 1.0.0beta, all the hard work from Sébastien Marie (thanks!)

Rust is a systems programming language that runs blazingly fast, prevents
almost all crashes, and eliminates data races.

Featuring:
- zero-cost abstractions
- move semantics
- guaranteed memory safety
- threads without data races
- trait-based generics
- pattern matching
- type inference
- minimal runtime
- efficient C bindings

some packaging tweaks by me, ok/testing bcallah@@ jca@@
@
text
@@
