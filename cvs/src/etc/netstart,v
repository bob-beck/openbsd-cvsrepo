head	1.176;
access;
symbols
	OPENBSD_6_1:1.172.0.4
	OPENBSD_6_1_BASE:1.172
	OPENBSD_6_0:1.169.0.4
	OPENBSD_6_0_BASE:1.169
	OPENBSD_5_9:1.167.0.2
	OPENBSD_5_9_BASE:1.167
	OPENBSD_5_8:1.153.0.4
	OPENBSD_5_8_BASE:1.153
	OPENBSD_5_7:1.144.0.2
	OPENBSD_5_7_BASE:1.144
	OPENBSD_5_6:1.141.0.4
	OPENBSD_5_6_BASE:1.141
	OPENBSD_5_5:1.139.0.4
	OPENBSD_5_5_BASE:1.139
	OPENBSD_5_4:1.138.0.2
	OPENBSD_5_4_BASE:1.138
	OPENBSD_5_3:1.137.0.2
	OPENBSD_5_3_BASE:1.137
	OPENBSD_5_2:1.134.0.4
	OPENBSD_5_2_BASE:1.134
	OPENBSD_5_1_BASE:1.134
	OPENBSD_5_1:1.134.0.2
	OPENBSD_5_0:1.133.0.2
	OPENBSD_5_0_BASE:1.133
	OPENBSD_4_9:1.131.0.2
	OPENBSD_4_9_BASE:1.131
	OPENBSD_4_8:1.130.0.2
	OPENBSD_4_8_BASE:1.130
	OPENBSD_4_7:1.129.0.2
	OPENBSD_4_7_BASE:1.129
	OPENBSD_4_6:1.124.0.6
	OPENBSD_4_6_BASE:1.124
	OPENBSD_4_5:1.124.0.2
	OPENBSD_4_5_BASE:1.124
	OPENBSD_4_4:1.122.0.2
	OPENBSD_4_4_BASE:1.122
	OPENBSD_4_3:1.118.0.2
	OPENBSD_4_3_BASE:1.118
	OPENBSD_4_2:1.116.0.2
	OPENBSD_4_2_BASE:1.116
	OPENBSD_4_1:1.115.0.2
	OPENBSD_4_1_BASE:1.115
	OPENBSD_4_0:1.114.0.2
	OPENBSD_4_0_BASE:1.114
	OPENBSD_3_9:1.113.0.2
	OPENBSD_3_9_BASE:1.113
	OPENBSD_3_8:1.105.0.2
	OPENBSD_3_8_BASE:1.105
	OPENBSD_3_7:1.102.0.2
	OPENBSD_3_7_BASE:1.102
	OPENBSD_3_6:1.97.0.2
	OPENBSD_3_6_BASE:1.97
	OPENBSD_3_5:1.96.0.2
	OPENBSD_3_5_BASE:1.96
	OPENBSD_3_4:1.87.0.2
	OPENBSD_3_4_BASE:1.87
	OPENBSD_3_3:1.86.0.2
	OPENBSD_3_3_BASE:1.86
	OPENBSD_3_2:1.85.0.2
	OPENBSD_3_2_BASE:1.85
	OPENBSD_3_1:1.84.0.2
	OPENBSD_3_1_BASE:1.84
	OPENBSD_3_0:1.82.0.2
	OPENBSD_3_0_BASE:1.82
	OPENBSD_2_9:1.77.0.2
	OPENBSD_2_9_BASE:1.77
	OPENBSD_2_8:1.72.0.2
	OPENBSD_2_8_BASE:1.72
	OPENBSD_2_7:1.70.0.2
	OPENBSD_2_7_BASE:1.70
	OPENBSD_2_6:1.51.0.2
	OPENBSD_2_6_BASE:1.51
	OPENBSD_2_5:1.48.0.2
	OPENBSD_2_5_BASE:1.48
	OPENBSD_2_4:1.44.0.2
	OPENBSD_2_4_BASE:1.44
	OPENBSD_2_3:1.37.0.2
	OPENBSD_2_3_BASE:1.37
	OPENBSD_2_2:1.30.0.2
	OPENBSD_2_2_BASE:1.30
	OPENBSD_2_1:1.18.0.2
	OPENBSD_2_1_BASE:1.18
	OPENBSD_2_0:1.11.0.2
	OPENBSD_2_0_BASE:1.11
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@# @;


1.176
date	2017.04.08.08.33.05;	author rpe;	state Exp;
branches;
next	1.175;
commitid	S5BiQ2rWe7aJqsNr;

1.175
date	2017.04.07.22.53.25;	author rpe;	state Exp;
branches;
next	1.174;
commitid	nR5UAjaz6p2qXcJ8;

1.174
date	2017.04.07.22.15.17;	author rpe;	state Exp;
branches;
next	1.173;
commitid	nCVemAu9TctNNzZD;

1.173
date	2017.04.07.21.44.07;	author rpe;	state Exp;
branches;
next	1.172;
commitid	FJTLaKgpM0PdNit4;

1.172
date	2016.12.06.14.01.43;	author mpi;	state Exp;
branches;
next	1.171;
commitid	WTMcOui5DNMeu77K;

1.171
date	2016.09.27.09.19.11;	author rzalamena;	state Exp;
branches;
next	1.170;
commitid	5J3wzcdm8va3CNTG;

1.170
date	2016.09.09.19.48.16;	author jasper;	state Exp;
branches;
next	1.169;
commitid	qiNOVn2ddQ8Ox0aL;

1.169
date	2016.07.19.08.03.01;	author mpi;	state Exp;
branches;
next	1.168;
commitid	ibrPL55oAQZRScjP;

1.168
date	2016.03.27.20.32.42;	author sthen;	state Exp;
branches;
next	1.167;
commitid	bF1WunUDpJTR46qw;

1.167
date	2015.12.29.19.37.31;	author rpe;	state Exp;
branches;
next	1.166;
commitid	6wNS9uerDDMu3cnt;

1.166
date	2015.12.29.19.33.43;	author rpe;	state Exp;
branches;
next	1.165;
commitid	8bA0pgBJaV9sL3tj;

1.165
date	2015.12.18.08.49.53;	author ajacoutot;	state Exp;
branches;
next	1.164;
commitid	4tFsYJknRC0gmNBc;

1.164
date	2015.12.17.23.19.23;	author ajacoutot;	state Exp;
branches;
next	1.163;
commitid	Y6oWA4copAQStHRY;

1.163
date	2015.12.05.18.43.12;	author mpi;	state Exp;
branches;
next	1.162;
commitid	Hwe4NrlSqy1olQ0E;

1.162
date	2015.11.12.23.11.11;	author rpe;	state Exp;
branches;
next	1.161;
commitid	5QJcXlUQa8PLuNNO;

1.161
date	2015.11.12.23.00.13;	author rpe;	state Exp;
branches;
next	1.160;
commitid	XubmyidHJXyyHrGr;

1.160
date	2015.11.12.22.50.46;	author rpe;	state Exp;
branches;
next	1.159;
commitid	fP8g1TiAd3miPNTK;

1.159
date	2015.11.01.15.37.18;	author rpe;	state Exp;
branches;
next	1.158;
commitid	OxTZ5eDdpyGPRRXO;

1.158
date	2015.10.26.19.24.04;	author rpe;	state Exp;
branches;
next	1.157;
commitid	zFII4fQwXQ4hcMmr;

1.157
date	2015.10.23.15.22.49;	author claudio;	state Exp;
branches;
next	1.156;
commitid	TUAAq2bhCEh3PsO5;

1.156
date	2015.09.27.20.32.33;	author sthen;	state Exp;
branches;
next	1.155;
commitid	lvk48U682zQWTgdk;

1.155
date	2015.09.13.13.51.57;	author sthen;	state Exp;
branches;
next	1.154;
commitid	qW4l28EfXZKFhbcN;

1.154
date	2015.09.11.12.21.52;	author sthen;	state Exp;
branches;
next	1.153;
commitid	RjqEopBQfZlo9Fpe;

1.153
date	2015.07.20.06.59.39;	author rpe;	state Exp;
branches;
next	1.152;
commitid	y7nbZ22RKbjhwOMg;

1.152
date	2015.07.19.23.42.58;	author florian;	state Exp;
branches;
next	1.151;
commitid	cPZefn4SZNxPBCIp;

1.151
date	2015.07.19.19.52.36;	author rpe;	state Exp;
branches;
next	1.150;
commitid	bTgWP1Bfe1GQKomo;

1.150
date	2015.07.19.14.17.21;	author ajacoutot;	state Exp;
branches;
next	1.149;
commitid	ZlihPMlocVpRF29w;

1.149
date	2015.07.19.04.44.36;	author rpe;	state Exp;
branches;
next	1.148;
commitid	AI4ymZ4o5FHoGW3X;

1.148
date	2015.07.19.01.37.45;	author rpe;	state Exp;
branches;
next	1.147;
commitid	omg3HFrPcyKyWehx;

1.147
date	2015.07.18.00.37.23;	author rpe;	state Exp;
branches;
next	1.146;
commitid	nwdUAK7uTuHTiwBf;

1.146
date	2015.07.18.00.03.34;	author rpe;	state Exp;
branches;
next	1.145;
commitid	HAC9bupABqscbVEj;

1.145
date	2015.06.06.13.13.07;	author florian;	state Exp;
branches;
next	1.144;
commitid	W2tnaAguWjaHgrIC;

1.144
date	2014.12.03.19.55.49;	author florian;	state Exp;
branches;
next	1.143;
commitid	jPX9re7e8bvWad2L;

1.143
date	2014.09.28.12.58.02;	author claudio;	state Exp;
branches;
next	1.142;
commitid	j7xz3VFSZw48DAH3;

1.142
date	2014.09.26.15.18.01;	author halex;	state Exp;
branches;
next	1.141;
commitid	asXNMOqLjOydYXsx;

1.141
date	2014.07.12.14.39.31;	author stsp;	state Exp;
branches;
next	1.140;
commitid	BKvoCASqjs1YBxbO;

1.140
date	2014.07.12.10.14.03;	author robert;	state Exp;
branches;
next	1.139;
commitid	bTkdeNHIIsfDwYx7;

1.139
date	2013.08.22.07.53.11;	author mpi;	state Exp;
branches;
next	1.138;

1.138
date	2013.03.20.15.26.28;	author todd;	state Exp;
branches;
next	1.137;

1.137
date	2012.12.05.07.08.38;	author rpe;	state Exp;
branches;
next	1.136;

1.136
date	2012.12.02.21.02.45;	author rpe;	state Exp;
branches;
next	1.135;

1.135
date	2012.12.02.16.19.18;	author rpe;	state Exp;
branches;
next	1.134;

1.134
date	2011.10.07.16.36.26;	author deraadt;	state Exp;
branches;
next	1.133;

1.133
date	2011.07.07.23.09.46;	author guenther;	state Exp;
branches;
next	1.132;

1.132
date	2011.05.26.15.22.53;	author mpf;	state Exp;
branches;
next	1.131;

1.131
date	2011.02.09.17.22.06;	author sobrado;	state Exp;
branches;
next	1.130;

1.130
date	2010.06.16.23.45.57;	author todd;	state Exp;
branches;
next	1.129;

1.129
date	2010.01.12.07.43.41;	author henning;	state Exp;
branches;
next	1.128;

1.128
date	2009.12.10.00.51.55;	author todd;	state Exp;
branches;
next	1.127;

1.127
date	2009.11.22.23.09.50;	author deraadt;	state Exp;
branches;
next	1.126;

1.126
date	2009.09.17.08.22.22;	author simon;	state Exp;
branches;
next	1.125;

1.125
date	2009.07.10.19.08.08;	author jdixon;	state Exp;
branches;
next	1.124;

1.124
date	2008.11.25.12.11.44;	author markus;	state Exp;
branches;
next	1.123;

1.123
date	2008.08.14.00.59.50;	author sthen;	state Exp;
branches;
next	1.122;

1.122
date	2008.07.23.16.05.47;	author sthen;	state Exp;
branches;
next	1.121;

1.121
date	2008.06.09.22.56.42;	author todd;	state Exp;
branches;
next	1.120;

1.120
date	2008.06.09.22.46.42;	author deraadt;	state Exp;
branches;
next	1.119;

1.119
date	2008.04.17.19.03.25;	author deraadt;	state Exp;
branches;
next	1.118;

1.118
date	2008.01.17.12.36.33;	author brad;	state Exp;
branches;
next	1.117;

1.117
date	2008.01.09.21.38.19;	author mpf;	state Exp;
branches;
next	1.116;

1.116
date	2007.08.02.03.19.10;	author david;	state Exp;
branches;
next	1.115;

1.115
date	2006.11.15.06.28.33;	author itojun;	state Exp;
branches;
next	1.114;

1.114
date	2006.06.29.17.23.28;	author todd;	state Exp;
branches;
next	1.113;

1.113
date	2005.12.28.04.55.35;	author david;	state Exp;
branches;
next	1.112;

1.112
date	2005.12.06.17.24.18;	author reyk;	state Exp;
branches;
next	1.111;

1.111
date	2005.11.02.18.45.26;	author todd;	state Exp;
branches;
next	1.110;

1.110
date	2005.10.25.14.18.38;	author todd;	state Exp;
branches;
next	1.109;

1.109
date	2005.10.14.15.46.41;	author todd;	state Exp;
branches;
next	1.108;

1.108
date	2005.10.12.13.11.55;	author todd;	state Exp;
branches;
next	1.107;

1.107
date	2005.10.04.12.50.15;	author todd;	state Exp;
branches;
next	1.106;

1.106
date	2005.09.28.17.40.30;	author todd;	state Exp;
branches;
next	1.105;

1.105
date	2005.05.22.08.56.08;	author todd;	state Exp;
branches;
next	1.104;

1.104
date	2005.04.04.04.26.27;	author djm;	state Exp;
branches;
next	1.103;

1.103
date	2005.04.03.19.39.31;	author deraadt;	state Exp;
branches;
next	1.102;

1.102
date	2005.01.04.15.40.53;	author mcbride;	state Exp;
branches;
next	1.101;

1.101
date	2004.12.30.17.33.59;	author millert;	state Exp;
branches;
next	1.100;

1.100
date	2004.12.19.15.37.58;	author millert;	state Exp;
branches;
next	1.99;

1.99
date	2004.12.04.00.17.05;	author itojun;	state Exp;
branches;
next	1.98;

1.98
date	2004.10.20.21.17.34;	author deraadt;	state Exp;
branches;
next	1.97;

1.97
date	2004.05.29.07.01.03;	author deraadt;	state Exp;
branches;
next	1.96;

1.96
date	2004.03.22.04.31.42;	author mcbride;	state Exp;
branches;
next	1.95;

1.95
date	2004.03.13.00.59.02;	author mcbride;	state Exp;
branches;
next	1.94;

1.94
date	2004.01.14.04.41.02;	author deraadt;	state Exp;
branches;
next	1.93;

1.93
date	2004.01.13.08.36.57;	author deraadt;	state Exp;
branches;
next	1.92;

1.92
date	2004.01.11.06.07.16;	author deraadt;	state Exp;
branches;
next	1.91;

1.91
date	2004.01.09.10.02.23;	author deraadt;	state Exp;
branches;
next	1.90;

1.90
date	2003.12.04.01.19.37;	author millert;	state Exp;
branches;
next	1.89;

1.89
date	2003.12.03.13.28.36;	author markus;	state Exp;
branches;
next	1.88;

1.88
date	2003.10.20.17.53.32;	author david;	state Exp;
branches;
next	1.87;

1.87
date	2003.08.27.11.49.36;	author henning;	state Exp;
branches;
next	1.86;

1.86
date	2003.02.16.23.25.40;	author krw;	state Exp;
branches;
next	1.85;

1.85
date	2002.05.16.20.48.25;	author todd;	state Exp;
branches;
next	1.84;

1.84
date	2002.02.23.01.55.24;	author deraadt;	state Exp;
branches;
next	1.83;

1.83
date	2002.02.21.02.32.01;	author miod;	state Exp;
branches;
next	1.82;

1.82
date	2001.07.31.08.27.35;	author hugh;	state Exp;
branches;
next	1.81;

1.81
date	2001.07.06.05.53.17;	author angelos;	state Exp;
branches;
next	1.80;

1.80
date	2001.07.06.05.44.40;	author angelos;	state Exp;
branches;
next	1.79;

1.79
date	2001.07.03.03.28.19;	author deraadt;	state Exp;
branches;
next	1.78;

1.78
date	2001.05.30.02.11.08;	author deraadt;	state Exp;
branches;
next	1.77;

1.77
date	2001.03.13.21.15.09;	author deraadt;	state Exp;
branches;
next	1.76;

1.76
date	2001.02.06.23.05.45;	author todd;	state Exp;
branches;
next	1.75;

1.75
date	2001.01.10.22.17.10;	author jason;	state Exp;
branches;
next	1.74;

1.74
date	2000.11.27.17.14.00;	author millert;	state Exp;
branches;
next	1.73;

1.73
date	2000.11.08.19.09.29;	author todd;	state Exp;
branches;
next	1.72;

1.72
date	2000.09.02.15.59.29;	author todd;	state Exp;
branches;
next	1.71;

1.71
date	2000.06.18.19.02.24;	author todd;	state Exp;
branches;
next	1.70;

1.70
date	2000.05.08.21.44.39;	author todd;	state Exp;
branches;
next	1.69;

1.69
date	2000.04.21.21.27.34;	author deraadt;	state Exp;
branches;
next	1.68;

1.68
date	2000.04.04.13.44.51;	author millert;	state Exp;
branches;
next	1.67;

1.67
date	2000.03.18.19.45.45;	author deraadt;	state Exp;
branches;
next	1.66;

1.66
date	2000.03.17.17.40.31;	author itojun;	state Exp;
branches;
next	1.65;

1.65
date	2000.03.12.04.18.47;	author itojun;	state Exp;
branches;
next	1.64;

1.64
date	2000.03.10.13.21.51;	author todd;	state Exp;
branches;
next	1.63;

1.63
date	2000.01.10.02.04.07;	author todd;	state Exp;
branches;
next	1.62;

1.62
date	2000.01.02.06.50.09;	author deraadt;	state Exp;
branches;
next	1.61;

1.61
date	2000.01.02.06.43.42;	author itojun;	state Exp;
branches;
next	1.60;

1.60
date	2000.01.02.06.42.13;	author itojun;	state Exp;
branches;
next	1.59;

1.59
date	2000.01.02.06.39.08;	author todd;	state Exp;
branches;
next	1.58;

1.58
date	2000.01.02.06.32.44;	author itojun;	state Exp;
branches;
next	1.57;

1.57
date	2000.01.02.05.21.55;	author itojun;	state Exp;
branches;
next	1.56;

1.56
date	2000.01.02.05.14.52;	author itojun;	state Exp;
branches;
next	1.55;

1.55
date	2000.01.02.04.38.17;	author todd;	state Exp;
branches;
next	1.54;

1.54
date	99.12.31.04.32.53;	author itojun;	state Exp;
branches;
next	1.53;

1.53
date	99.12.09.14.22.38;	author itojun;	state Exp;
branches;
next	1.52;

1.52
date	99.12.09.13.59.57;	author itojun;	state Exp;
branches;
next	1.51;

1.51
date	99.09.01.18.07.34;	author deraadt;	state Exp;
branches;
next	1.50;

1.50
date	99.09.01.05.07.50;	author deraadt;	state Exp;
branches;
next	1.49;

1.49
date	99.08.09.21.49.04;	author angelos;	state Exp;
branches;
next	1.48;

1.48
date	99.03.29.22.09.58;	author niklas;	state Exp;
branches;
next	1.47;

1.47
date	99.03.26.14.34.31;	author niklas;	state Exp;
branches;
next	1.46;

1.46
date	99.03.01.05.04.24;	author millert;	state Exp;
branches;
next	1.45;

1.45
date	98.10.28.19.17.10;	author millert;	state Exp;
branches;
next	1.44;

1.44
date	98.10.06.23.25.21;	author deraadt;	state Exp;
branches;
next	1.43;

1.43
date	98.09.18.18.42.10;	author deraadt;	state Exp;
branches;
next	1.42;

1.42
date	98.09.10.16.01.32;	author marc;	state Exp;
branches;
next	1.41;

1.41
date	98.09.08.20.26.41;	author marc;	state Exp;
branches;
next	1.40;

1.40
date	98.08.24.09.32.50;	author downsj;	state Exp;
branches;
next	1.39;

1.39
date	98.07.04.13.55.51;	author deraadt;	state Exp;
branches;
next	1.38;

1.38
date	98.05.22.04.25.50;	author deraadt;	state Exp;
branches;
next	1.37;

1.37
date	98.03.28.00.11.00;	author deraadt;	state Exp;
branches;
next	1.36;

1.36
date	98.02.23.20.47.35;	author niklas;	state Exp;
branches;
next	1.35;

1.35
date	98.02.07.20.51.50;	author deraadt;	state Exp;
branches;
next	1.34;

1.34
date	97.12.21.01.17.21;	author deraadt;	state Exp;
branches;
next	1.33;

1.33
date	97.12.20.23.19.30;	author deraadt;	state Exp;
branches;
next	1.32;

1.32
date	97.11.29.02.03.43;	author kstailey;	state Exp;
branches;
next	1.31;

1.31
date	97.11.04.09.15.31;	author deraadt;	state Exp;
branches;
next	1.30;

1.30
date	97.10.14.20.34.55;	author deraadt;	state Exp;
branches;
next	1.29;

1.29
date	97.09.04.01.12.23;	author deraadt;	state Exp;
branches;
next	1.28;

1.28
date	97.08.25.20.50.37;	author millert;	state Exp;
branches;
next	1.27;

1.27
date	97.08.19.21.55.15;	author niklas;	state Exp;
branches;
next	1.26;

1.26
date	97.07.31.02.23.46;	author downsj;	state Exp;
branches;
next	1.25;

1.25
date	97.07.30.21.35.15;	author deraadt;	state Exp;
branches;
next	1.24;

1.24
date	97.07.28.19.31.47;	author kstailey;	state Exp;
branches;
next	1.23;

1.23
date	97.07.25.00.06.03;	author provos;	state Exp;
branches;
next	1.22;

1.22
date	97.07.24.22.11.59;	author deraadt;	state Exp;
branches;
next	1.21;

1.21
date	97.07.22.10.02.47;	author provos;	state Exp;
branches;
next	1.20;

1.20
date	97.06.17.13.13.48;	author niklas;	state Exp;
branches;
next	1.19;

1.19
date	97.06.17.10.20.06;	author niklas;	state Exp;
branches;
next	1.18;

1.18
date	97.04.15.09.42.33;	author deraadt;	state Exp;
branches;
next	1.17;

1.17
date	97.04.09.03.00.05;	author kstailey;	state Exp;
branches;
next	1.16;

1.16
date	97.04.07.22.18.05;	author rees;	state Exp;
branches;
next	1.15;

1.15
date	97.03.03.01.13.11;	author downsj;	state Exp;
branches;
next	1.14;

1.14
date	97.02.11.18.46.08;	author deraadt;	state Exp;
branches;
next	1.13;

1.13
date	97.02.03.12.04.44;	author deraadt;	state Exp;
branches;
next	1.12;

1.12
date	96.11.02.00.52.02;	author deraadt;	state Exp;
branches;
next	1.11;

1.11
date	96.09.23.13.06.37;	author deraadt;	state Exp;
branches;
next	1.10;

1.10
date	96.09.04.10.25.55;	author deraadt;	state Exp;
branches;
next	1.9;

1.9
date	96.08.27.11.46.20;	author deraadt;	state Exp;
branches;
next	1.8;

1.8
date	96.06.18.15.30.02;	author deraadt;	state Exp;
branches;
next	1.7;

1.7
date	96.06.16.12.57.31;	author deraadt;	state Exp;
branches;
next	1.6;

1.6
date	96.06.02.21.17.58;	author tholo;	state Exp;
branches;
next	1.5;

1.5
date	96.05.26.10.25.24;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	96.01.09.09.29.27;	author dm;	state Exp;
branches;
next	1.3;

1.3
date	95.12.30.23.38.21;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	95.12.18.16.37.10;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.37.57;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.37.57;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.176
log
@- localize the if, file and stat variables which also ensures that
  variables are not named like commands.
- change test from [] to [[]]

OK tb@@ halex@@
@
text
@#!/bin/sh -
#
#	$OpenBSD: netstart,v 1.175 2017/04/07 22:53:25 rpe Exp $

# Turn off Strict Bourne shell mode.
set +o sh

# Echo file $1 to stdout. Skip comment lines and delete everything
# after the first '#' from other lines. Strip leading and trailing
# whitespace if IFS is set.
# Usage: stripcom /path/to/file
stripcom() {
	local _file=$1 _line

	[[ -f $_file ]] || return

	while read _line; do
		[[ -n ${_line%%#*} ]] && print -r -- "$_line"
	done <$_file
}

# Start a single interface.
# Usage: ifstart if1
ifstart() {
	# Note: Do not rename the 'if' variable which is documented as being
	# usable in hostname.if(5) files.
	local if=$1 _file=/etc/hostname.$1 _stat

	# Interface names must be alphanumeric only.  We check to avoid
	# configuring backup or temp files, and to catch the "*" case.
	[[ $if != +([[:alpha:]])+([[:digit:]]) ]] && return

	if [[ ! -f $_file ]]; then
		echo "netstart: $_file: No such file or directory"
		return
	fi
	# Not using stat(1), we can't rely on having /usr yet.
	set -A _stat -- $(ls -nL $_file)
	if [ "${_stat[0]#???????} ${_stat[2]} ${_stat[3]}" != "--- 0 0" ]; then
		echo "WARNING: $_file is insecure, fixing permissions"
		chmod -LR o-rwx $_file
		chown -LR root.wheel $_file
	fi
	# Check for ifconfig'able interface.
	(ifconfig $if || ifconfig $if create) >/dev/null 2>&1 || return

	# Now parse the hostname.* file.
	while :; do
		if [ "$cmd2" ]; then
			# We are carrying over from the 'read dt dtaddr'
			# last time.
			set -- $cmd2
			af=$1 name=$2 mask=$3 bcaddr=$4 ext1=$5 cmd2=
			# Make sure and get any remaining args in ext2,
			# like the read below.
			i=1
			while [ $i -lt 6 -a -n "$1" ]; do shift; let i=i+1; done
			ext2="$@@"
		else
			# Read the next line or exit the while loop.
			read af name mask bcaddr ext1 ext2 || break
		fi
		# $af can be "dhcp", "up", "rtsol", an address family, commands,
		# or a comment.
		case "$af" in
		"#"*|"")
			# Skip comments and empty lines.
			continue
			;;
		"!"*) # Parse commands.
			cmd="${af#*!} ${name} ${mask} ${bcaddr} ${ext1} ${ext2}"
			;;
		"dhcp")
			[ "$name" = "NONE" ] && name=
			[ "$mask" = "NONE" ] && mask=
			[ "$bcaddr" = "NONE" ] && bcaddr=
			cmd="ifconfig $if $name $mask $bcaddr $ext1 $ext2 down"
			cmd="$cmd;dhclient $if"
			dhcpif="$dhcpif $if"
			;;
		"rtsol")
			rtsolif="$rtsolif $if"
			cmd="ifconfig $if $name $mask $bcaddr $ext1 $ext2 up"
			;;
		*)
			read dt dtaddr
			if [ "$name" = "alias" ]; then
				# Perform a 'shift' of sorts.
				alias=$name
				name=$mask
				mask=$bcaddr
				bcaddr=$ext1
				ext1=$ext2
				ext2=
			else
				alias=
			fi
			cmd="ifconfig $if $af $alias $name"
			case "$dt" in
			dest)
				cmd="$cmd $dtaddr"
				;;
			*)
				cmd2="$dt $dtaddr"
				;;
			esac
			case $af in
			inet)
				if [ ! -n "$name" ]; then
					echo "/etc/hostname.$if: inet alone is invalid"
					return
				fi
				[ "$mask" ] && cmd="$cmd netmask $mask"
				if [ "$bcaddr" -a "X$bcaddr" != "XNONE" ]; then
					cmd="$cmd broadcast $bcaddr"
				fi
				;;
			inet6)
				if [ ! -n "$name" ]; then
					echo "/etc/hostname.$if: inet6 alone is invalid"
					return
				fi
				[ "$mask" ] && cmd="$cmd prefixlen $mask"
				cmd="$cmd $bcaddr"
				;;
			*)
				cmd="$cmd $mask $bcaddr"
				;;
			esac
			cmd="$cmd $ext1 $ext2"
			;;
		esac
		eval "$cmd"
	done <$_file
}

# Start multiple interfaces by driver name.
# Usage: ifmstart "em iwm" "trunk vlan"
#   Start "$1" interfaces in order or all interfaces if empty.
#   Don't start "$2" interfaces. "$2" is optional.
ifmstart() {
	local _sifs=$1 _xifs=$2 _hn _if _sif _xif

	for _sif in ${_sifs:-ALL}; do
		for _hn in /etc/hostname.*; do
			_if=${_hn#/etc/hostname.}
			[[ $_if == '*' ]] && continue

			# Skip unwanted ifs.
			for _xif in $_xifs; do
				[[ $_xif == ${_if%%[0-9]*} ]] && continue 2
			done

			# Start wanted ifs.
			[[ $_sif == @@(ALL|${_if%%[0-9]*}) ]] && ifstart $_if
		done
	done
}

# IPv6 autoconf the interfaces in the $rtsolif list.
# Usage: ifv6autoconf
ifv6autoconf() {
	local _if

	# $ip6kernel will not have been set if we were invoked with a
	# list of interface names
	ifconfig lo0 inet6 >/dev/null 2>&1 || return 0

	for _if in $rtsolif; do
		ifconfig $_if inet6 autoconf
	done
}

# Parse /etc/mygate and add default routes for IPv4 and IPv6
# Usage: defaultroute
defaultroute() {
	[[ -z $dhcpif ]] && stripcom /etc/mygate | while read gw; do
			[[ $gw == @@(*:*) ]] && continue
			route -qn delete default >/dev/null 2>&1
			route -qn add -host default $gw && break
	done
	[[ -z $rtsolif ]] && stripcom /etc/mygate | while read gw; do
			[[ $gw == !(*:*) ]] && continue
			route -qn delete -inet6 default >/dev/null 2>&1
			route -qn add -host -inet6 default $gw && break
	done
}

# Make sure the invoking user has the right privileges.
if (($(id -u) != 0)); then
	echo "${0##*/}: need root privileges"
	exit 1
fi

# Get network related vars from rc.conf using the parsing routine from rc.subr.
FUNCS_ONLY=1 . /etc/rc.d/rc.subr
_rc_parse_conf

# If we were invoked with a list of interface names, just reconfigure these
# interfaces (or bridges), add default routes and return.
if (($# > 0)); then
	for _if; do ifstart $_if; done
	ifv6autoconf
	defaultroute
	return
fi

# Otherwise, process with the complete network initialization.

# /etc/myname contains my symbolic name.
[[ -f /etc/myname ]] && hostname "$(stripcom /etc/myname)"

# Set the address for the loopback interface.  Bringing the interface up,
# automatically invokes the IPv6 address ::1.
ifconfig lo0 inet 127.0.0.1/8

if ifconfig lo0 inet6 >/dev/null 2>&1; then
	# IPv6 configurations.
	ip6kernel=YES

	# Disallow link-local unicast dest without outgoing scope identifiers.
	route -qn add -inet6 fe80:: -prefixlen 10 ::1 -reject >/dev/null

	# Disallow site-local unicast dest without outgoing scope identifiers.
	# If you configure site-locals without scope id (it is permissible
	# config for routers that are not on scope boundary), you may want
	# to comment the line out.
	route -qn add -inet6 fec0:: -prefixlen 10 ::1 -reject >/dev/null

	# Disallow "internal" addresses to appear on the wire.
	route -qn add -inet6 ::ffff:0.0.0.0 -prefixlen 96 ::1 -reject >/dev/null

	# Disallow packets to malicious IPv4 compatible prefix.
	route -qn add -inet6 ::224.0.0.0 -prefixlen 100 ::1 -reject >/dev/null
	route -qn add -inet6 ::127.0.0.0 -prefixlen 104 ::1 -reject >/dev/null
	route -qn add -inet6 ::0.0.0.0 -prefixlen 104 ::1 -reject >/dev/null
	route -qn add -inet6 ::255.0.0.0 -prefixlen 104 ::1 -reject >/dev/null

	# Disallow packets to malicious 6to4 prefix.
	route -qn add -inet6 2002:e000:: -prefixlen 20 ::1 -reject >/dev/null
	route -qn add -inet6 2002:7f00:: -prefixlen 24 ::1 -reject >/dev/null
	route -qn add -inet6 2002:0000:: -prefixlen 24 ::1 -reject >/dev/null
	route -qn add -inet6 2002:ff00:: -prefixlen 24 ::1 -reject >/dev/null

	# Disallow packets without scope identifier.
	route -qn add -inet6 ff01:: -prefixlen 16 ::1 -reject >/dev/null
	route -qn add -inet6 ff02:: -prefixlen 16 ::1 -reject >/dev/null

	# Completely disallow packets to IPv4 compatible prefix.
	#
	# This may conflict with RFC1933 under following circumstances:
	# (1) An IPv6-only KAME node tries to originate packets to IPv4
	#     compatible destination.  The KAME node has no IPv4 compatible
	#     support.  Under RFC1933, it should transmit native IPv6
	#     packets toward IPv4 compatible destination, hoping it would
	#     reach a router that forwards the packet toward auto-tunnel
	#     interface.
	# (2) An IPv6-only node originates a packet to an IPv4 compatible
	#     destination.  A KAME node is acting as an IPv6 router, and
	#     asked to forward it.
	#
	# Due to rare use of IPv4 compatible addresses, and security issues
	# with it, we disable it by default.
	route -qn add -inet6 ::0.0.0.0 -prefixlen 96 ::1 -reject >/dev/null

	rtsolif=""
else
	ip6kernel=NO
fi


# Configure all the non-loopback interfaces which we know about, but
# do not start interfaces which must be delayed. Refer to hostname.if(5)
ifmstart "" "trunk svlan vlan carp gif gre pfsync pppoe tun bridge switch pflow"

# The trunk interfaces need to come up first in this list.
# The (s)vlan interfaces need to come up after trunk.
# Configure all the carp interfaces which we know about before default route.
ifmstart "trunk svlan vlan carp"

# Now that $rtsolif has been populated, IPv6 autoconf those interfaces
ifv6autoconf

# Look for default routes in /etc/mygate.
defaultroute

# Multicast routing.
if [[ $multicast != YES ]]; then
	route -qn delete 224.0.0.0/4 >/dev/null 2>&1
	route -qn add -net 224.0.0.0/4 -interface 127.0.0.1 -reject >/dev/null
fi

# Configure PPPoE, GIF, GRE, TUN and PFLOW interfaces, delayed because they
# require routes to be set. TUN might depend on PPPoE, and GIF or GRE may
# depend on either of them. PFLOW might bind to ip addresses configured
# on either of them.
ifmstart "pppoe tun gif gre bridge switch pflow"

# Reject 127/8 other than 127.0.0.1.
route -qn add -net 127 127.0.0.1 -reject >/dev/null

if [[ $ip6kernel == YES ]]; then
	# This is to make sure DAD is completed before going further.
	count=0
	while ((count++ < 10 && $(sysctl -n net.inet6.ip6.dad_pending) != 0)); do
		sleep 1
	done
fi
@


1.175
log
@Minimize differences in ifstart() function between netstart and
install.sub which makes it easier to spot changes in the future.

- comments and formatting
- quotes on assignments are not needed (netstart)
- remove stray space in test (netstart)
- use $file variable with while-loop (netstart)
- although valid, instead of i use $i in arithmetic test (install.sub)

OK krw@@, tb@@
Looks good deraadt@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.174 2017/04/07 22:15:17 rpe Exp $
d27 1
a27 1
	if=$1
d33 2
a34 3
	file=/etc/hostname.$if
	if ! [ -f $file ]; then
		echo "netstart: $file: No such file or directory"
d38 5
a42 5
	set -A stat -- $(ls -nL $file)
	if [ "${stat[0]#???????} ${stat[2]} ${stat[3]}" != "--- 0 0" ]; then
		echo "WARNING: $file is insecure, fixing permissions"
		chmod -LR o-rwx $file
		chown -LR root.wheel $file
d134 1
a134 1
	done <$file
@


1.174
log
@Align comments of ifstart() function in netstart and install.sub.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.173 2017/04/07 21:44:07 rpe Exp $
d54 1
a54 1
			af="$1" name="$2" mask="$3" bcaddr="$4" ext1="$5" cmd2=
d67 2
a68 1
		"#"*|"") # Skip comments and empty lines.
d88 1
a88 1
			if [ "$name"  = "alias" ]; then
d135 1
a135 1
	done </etc/hostname.$if
@


1.173
log
@Align comments of stripcom() function in netstart and install.sub.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.172 2016/12/06 14:01:43 mpi Exp $
d25 2
d28 1
@


1.172
log
@Do not lose the default route when netstart(8) is run a second time on
the interface pointed to by the default route.

Since the kernel no longer keep routes with dangling address pointer,
netstart(8) has to re-add the default route when the corresponding ifa
has been deleted and re-created.

deraadt@@ points out that even if the previous semantic was not necessarily
better, a script like netstart(8) cannot totally fix the default route
problem.

Regression reported by and fix tested by Hrvoje Popovski.

ksh foo checked by halex@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.171 2016/09/27 09:19:11 rzalamena Exp $
d8 3
a10 2
# Strip comment lines from a file.
# Strip leading and trailing whitespace if IFS is set.
@


1.171
log
@Delay switch(4) interface start up so it can attach virtual interfaces
like vether(4).

nits from and ok benno@@, phessler@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.170 2016/09/09 19:48:16 jasper Exp $
d170 15
d196 1
a196 1
# interfaces (or bridges) and return.
d200 1
d281 1
a281 10
[[ -z $dhcpif ]] && stripcom /etc/mygate | while read gw; do
		[[ $gw == @@(*:*) ]] && continue
		route -qn delete default >/dev/null 2>&1
		route -qn add -host default $gw && break
done
[[ -z $rtsolif ]] && stripcom /etc/mygate | while read gw; do
		[[ $gw == !(*:*) ]] && continue
		route -qn delete -inet6 default >/dev/null 2>&1
		route -qn add -host -inet6 default $gw && break
done
@


1.170
log
@print a clear error message when not ran as root instead of just falling
through and try whatever it can do with the invoking user's perms

feedback/ok aja@@ rpe@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.169 2016/07/19 08:03:01 mpi Exp $
d254 1
a254 1
ifmstart "" "trunk svlan vlan carp gif gre pfsync pppoe tun bridge pflow"
d286 1
a286 1
ifmstart "pppoe tun gif gre bridge pflow"
@


1.169
log
@Do not consider tap(4) a special interface and start if before other
pseudo-interfaces.

This unbreak vlan(4) on top of tap(4) since the refactoring to turn it
MP-safe.

ok claudio@@, deraadt@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.168 2016/03/27 20:32:42 sthen Exp $
d169 6
@


1.168
log
@Don't delete the 224/4 route in netstart, unless it's being done to ensure that
a -reject route can be added. Restores the ability to set an interface route
before daemons are started, lost during the previous simplification.
ok millert mpi
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.167 2015/12/29 19:37:31 rpe Exp $
d248 1
a248 1
ifmstart "" "trunk svlan vlan carp gif gre pfsync pppoe tun tap bridge pflow"
d280 1
a280 1
ifmstart "pppoe tun tap gif gre bridge pflow"
@


1.167
log
@Remove backslash, not necessary after '&&'

OK halex@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.166 2015/12/29 19:33:43 rpe Exp $
d271 2
a272 2
route -qn delete 224.0.0.0/4 >/dev/null 2>&1
[[ $multicast != YES ]] &&
d274 1
@


1.166
log
@Replace last remaining `` with $()

OK halex@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.165 2015/12/18 08:49:53 ajacoutot Exp $
d272 1
a272 1
[[ $multicast != YES ]] && \
@


1.165
log
@Drop the now useless multicast setup comment.

prodded by tim@@, ok mpi@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.164 2015/12/17 23:19:23 ajacoutot Exp $
d35 1
a35 1
	set -A stat -- `ls -nL $file`
@


1.164
log
@Simplify multicast option handling (10 less lines) by matching /etc/rc behavior
towards other YES|NO options and drop the error warning.


with and ok tim@@, ok rpe@@ on an earlier diff
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.163 2015/12/05 18:43:12 mpi Exp $
a270 6
#
# The routing to the 224.0.0.0/4 net is setup according to these rules:
# multicast			route			comment
# NO				-reject			no multicast
# YES				none installed		daemon can run
# Any other combination		-reject			config error
@


1.163
log
@It does not make sense to insert a specific route for 224/4 when the
default one is good enough.

So merge rc.conf(8)'s 'multicast_router' and 'multicast_host' into a
single 'multicast'.  If set to YES the reject route for 224/4 is not
inserted by netstart(8).

Manual bits from jmc@@

ok henning@@, ajacoutot@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.162 2015/11/12 23:11:11 rpe Exp $
d278 1
a278 2
case $multicast in
NO)
a279 9
	;;
YES)
	;;
*)
	echo 'config error, multicasting disabled until rc.conf is fixed'
	route -qn add -net 224.0.0.0/4 -interface 127.0.0.1 -reject >/dev/null
	;;
esac

@


1.162
log
@Changes to ifautostart():
- Rename function to ifv6autoconf() to make IPv6 relation clearer
- Localize and rename variables

OK krw@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.161 2015/11/12 23:00:13 rpe Exp $
d273 4
a276 5
# multicast_host	multicast_router	route		comment
# NO			NO			-reject		no multicast
# NO			YES			none installed	daemon will run
# YES/interface		NO			-interface	YES=def. iface
#	   Any other combination		-reject		config error
d278 2
a279 2
case "$multicast_host:$multicast_router" in
NO:NO)
d282 1
a282 1
NO:YES)
d284 1
a284 19
*:NO)
	maddr=$(if [[ $multicast_host == YES ]]; then
		ed -s '!route -qn show -inet' <<EOF
/^default/p
EOF
	else
		ed -s "!ifconfig $multicast_host" <<EOF
/^	inet /p
EOF
	fi 2>/dev/null)
	if [[ -n $maddr ]]; then
		set $maddr
		route -qn add -net 224.0.0.0/4 -interface $2 >/dev/null
	else
		route -qn add -net 224.0.0.0/4 -interface \
			127.0.0.1 -reject >/dev/null
	fi
	;;
*:*)
@


1.161
log
@Changes to ifmstart():
- Change comments to make it clearer that ifmstart() takes two lists
  of interface driver names (of which the second is optional) and not
  the actual interface instances.
- Use localized variables and use slightly more verbose names.
- Use continue 2 to skip to the next hostname.if file.
- Use shell pattern @@() instead of testing _sif individually.

OK krw@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.160 2015/11/12 22:50:46 rpe Exp $
d156 5
a160 3
# IPv6 autoconf the interfaces in the list at $rtsolif
# Usage: ifautoconf
ifautoconf() {
d163 5
a167 5
	if ifconfig lo0 inet6 >/dev/null 2>&1; then
		for curif in $rtsolif; do
			ifconfig $curif inet6 autoconf
		done
	fi
d178 1
a178 1
	ifautoconf
d256 1
a256 1
ifautoconf
@


1.160
log
@Changes to stripcom():
- Align comments with /etc/rc version
- Use localized variables
- Use safer "print -r --" instead of plain echo

Changes to ifstart():
- Tweak comment
- Add usage

OK krw@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.159 2015/11/01 15:37:18 rpe Exp $
d133 2
a134 2
# Start multiple:
# Usage: ifmstart "if1 if2" "if3 if4"
d136 1
a136 1
#   Don't start "$2" interfaces.
d138 6
a143 5
	for sif in ${1:-ALL}; do
		for hn in /etc/hostname.*; do
			# Strip off /etc/hostname. prefix.
			if=${hn#/etc/hostname.}
			[ "$if" = "*" ] && continue
d146 2
a147 3
			s=""
			for xf in $2; do
				[ "$xf" = "${if%%[0-9]*}" ] && s="1" && break
a148 1
			[ "$s" = "1" ] && continue
d151 1
a151 2
			[ "$sif" = "ALL" -o "$sif" = "${if%%[0-9]*}" ] &&
				ifstart $if
@


1.159
log
@Start the rework of the /etc/netstart shell script.

General changes:
- apply a similar 'style' as used in the installer scripts
- improve comments to be more to the point, remove where code is obvious
- document usage of functions if they have arguments
- rename variables where it improves readability
- replace really old-school shell code with more contemporary idioms

Other changes:
- No need to care about "autoboot" because netstart doesn't inherit the
  positional parameters from /etc/rc anymore. /etc/rc executes netstart
  instead of sourcing it since r1.439.
- Use simpler for-loop to process list of interfaces with ifstart.

OK halex@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.158 2015/10/26 19:24:04 rpe Exp $
d8 3
a10 2
# Strip comments (and leading/trailing whitespace if IFS is set) from a file
# and spew to stdout.
d12 7
a18 5
	local _l
	[[ -f $1 ]] || return
	while read _l; do
		[[ -n ${_l%%#*} ]] && echo $_l
	done<$1
d21 2
a22 1
# Start the $1 interface.
@


1.158
log
@The hostname variable is not used since r1.99. Remove it and use
stripcom() output directly with the hostname command.

OK deraadt@@ krw@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.157 2015/10/23 15:22:49 claudio Exp $
d172 2
a173 8
if [[ $1 == autoboot ]]; then
	shift
fi
if [ $# -gt 0 ]; then
	while [ $# -gt 0 ]; do
		ifstart $1
		shift
	done
d181 1
a181 3
if [ -f /etc/myname ]; then
	hostname "$(stripcom /etc/myname)"
fi
d282 1
a282 1
	maddr=`if [ "$multicast_host" = "YES" ]; then
d290 2
a291 2
	fi 2>/dev/null`
	if [ "X${maddr}" != "X" ]; then
d315 1
a315 1
if [ "$ip6kernel" = "YES" ]; then
d318 1
a318 1
	while [ $((count++)) -lt 10 -a "x"`sysctl -n net.inet6.ip6.dad_pending` != "x0" ]; do
@


1.157
log
@netstart bits for tap(4)
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.156 2015/09/27 20:32:33 sthen Exp $
d188 1
a188 4
	hostname=`stripcom /etc/myname`
	hostname $hostname
else
	hostname=`hostname`
@


1.156
log
@Don't print output when setting autoconf on interfaces. Suggested by deraadt,
ok florian@@ rpe@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.155 2015/09/13 13:51:57 sthen Exp $
d255 1
a255 1
ifmstart "" "trunk svlan vlan carp gif gre pfsync pppoe tun bridge pflow"
d321 1
a321 1
ifmstart "pppoe tun gif gre bridge pflow"
@


1.155
log
@only print the "IPv6 autoconf" line if there are interfaces to configure
feedback/ok rpe
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.154 2015/09/11 12:21:52 sthen Exp $
d157 6
a162 11
	if [[ -n $rtsolif ]]; then
		printf 'IPv6 autoconf:'
		# $ip6kernel will not have been set if we were invoked with a
		# list of interface names
		if ifconfig lo0 inet6 >/dev/null 2>&1; then
			for curif in $rtsolif; do
				printf ' %s' $curif
				ifconfig $curif inet6 autoconf
			done
		fi
		echo
@


1.154
log
@Set "inet6 autoconf" individually on interfaces that have rtsol set in
hostname.if, previously netstart tried to configure them all at once
("ifconfig if0 if1 if2 inet6 autoconf").  From Delan Azabani, ok phessler@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.153 2015/07/20 06:59:39 rpe Exp $
d157 11
a167 8
	printf 'IPv6 autoconf:'
	# $ip6kernel will not have been set if we were invoked with a
	# list of interface names
	if ifconfig lo0 inet6 >/dev/null 2>&1; then
		for curif in $rtsolif; do
			printf ' %s' $curif
			ifconfig $curif inet6 autoconf
		done
a168 1
	echo
@


1.153
log
@Disable Strict Bourne shell mode for /etc/rc and /etc/netstart to be
able to use ksh syntax within these scripts. This way init doesn't
need to be changed, which starts /etc/rc using /bin/sh and people
can still use "sh /etc/netstart ifname".

Idea from and OK halex@@
OK deraadt@@ krw@@ guenther@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.152 2015/07/19 23:42:58 florian Exp $
d154 15
d183 1
d265 2
a266 4
if [ "$ip6kernel" = "YES" -a "x$rtsolif" != "x" ]; then
	echo "IPv6 autoconf:$rtsolif"
	ifconfig $rtsolif inet6 autoconf
fi
@


1.152
log
@Bring up pflow last as it might send with a source address that is on
any of the other interfaces.
OK deraadt, phessler, benno
@
text
@d3 4
a6 1
#	$OpenBSD: netstart,v 1.151 2015/07/19 19:52:36 rpe Exp $
@


1.151
log
@Always source rc.subr to be able to use the rc.conf parsing routine
to get the network related vars from rc.conf. This is even necessary
if netstart is run from within /etc/rc. Remove test of $INRC which
unintentionally evaluated always to true.

problem with previous change found by nigel@@
OK sthen@@ aja@@ halex@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.150 2015/07/19 14:17:21 ajacoutot Exp $
d239 1
a239 1
ifmstart "" "trunk svlan vlan carp gif gre pfsync pppoe tun bridge"
d303 5
a307 4
# Configure PPPoE, GIF, GRE and TUN interfaces, delayed because they require
# routes to be set.  TUN might depend on PPPoE, and GIF or GRE may depend on
# either of them.
ifmstart "pppoe tun gif gre bridge"
@


1.150
log
@Revert 1.148 for now until I can talk to rpe@@
It introduced a regression reported by nigel@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.149 2015/07/19 04:44:36 rpe Exp $
d151 2
a152 2
# Re-read rc.subr if we are not inside /etc/rc.
[ -n ${INRC} ] && FUNCS_ONLY=1 . /etc/rc.d/rc.subr
@


1.149
log
@Replace test command with [].

OK halex@@ krw@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.148 2015/07/19 01:37:45 rpe Exp $
d151 3
a153 5
# Source rc.subr and parse rc.conf only if we are not inside /etc/rc.
if [ -z "${INRC}" ]; then
	FUNCS_ONLY=1 . /etc/rc.d/rc.subr
	_rc_parse_conf
fi
@


1.148
log
@Ensure, that we source rc.subr and parse rc.conf ONLY if we are not
inside /etc/rc.

With help from and OK halex@@, ajacoutot@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.147 2015/07/18 00:37:23 rpe Exp $
d135 1
a135 1
			test "$if" = "*" && continue
d140 1
a140 1
				test "$xf" = "${if%%[0-9]*}" && s="1" && break
d142 1
a142 1
			test "$s" = "1" && continue
d145 2
a146 3
			test "$sif" = "ALL" -o \
			     "$sif" = "${if%%[0-9]*}" \
				&& ifstart $if
@


1.147
log
@- remove trailing blanks introduced in previous commit
- no space in redirections like </foo or >$bar
- few other minor whitespaces

OK krw@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.146 2015/07/18 00:03:34 rpe Exp $
d152 5
a156 3
# Re-read rc.subr if we are not inside /etc/rc.
[ -n ${INRC} ] && FUNCS_ONLY=1 . /etc/rc.d/rc.subr
_rc_parse_conf
@


1.146
log
@Improve comments
- Add comments for functions
- Start comments with capital letters
- End comments with a full stop
- Allow comments to extend up to column 80

OK krw@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.145 2015/06/06 13:13:07 florian Exp $
d123 1
a123 1
	done < /etc/hostname.$if
d188 1
a188 1
	route -qn add -inet6 fe80:: -prefixlen 10 ::1 -reject > /dev/null
d194 1
a194 1
	route -qn add -inet6 fec0:: -prefixlen 10 ::1 -reject > /dev/null
d197 1
a197 1
	route -qn add -inet6 ::ffff:0.0.0.0 -prefixlen 96 ::1 -reject > /dev/null
d200 4
a203 4
	route -qn add -inet6 ::224.0.0.0 -prefixlen 100 ::1 -reject > /dev/null
	route -qn add -inet6 ::127.0.0.0 -prefixlen 104 ::1 -reject > /dev/null
	route -qn add -inet6 ::0.0.0.0 -prefixlen 104 ::1 -reject > /dev/null
	route -qn add -inet6 ::255.0.0.0 -prefixlen 104 ::1 -reject > /dev/null
d206 4
a209 4
	route -qn add -inet6 2002:e000:: -prefixlen 20 ::1 -reject > /dev/null
	route -qn add -inet6 2002:7f00:: -prefixlen 24 ::1 -reject > /dev/null
	route -qn add -inet6 2002:0000:: -prefixlen 24 ::1 -reject > /dev/null
	route -qn add -inet6 2002:ff00:: -prefixlen 24 ::1 -reject > /dev/null
d212 2
a213 2
	route -qn add -inet6 ff01:: -prefixlen 16 ::1 -reject > /dev/null
	route -qn add -inet6 ff02:: -prefixlen 16 ::1 -reject > /dev/null
d230 1
a230 1
	route -qn add -inet6 ::0.0.0.0 -prefixlen 96 ::1 -reject > /dev/null
d255 1
a255 1
		route -qn delete default > /dev/null 2>&1
d260 1
a260 1
		route -qn delete -inet6 default > /dev/null 2>&1
d272 1
a272 1
route -qn delete 224.0.0.0/4 > /dev/null 2>&1
d275 1
a275 1
	route -qn add -net 224.0.0.0/4 -interface 127.0.0.1 -reject > /dev/null
d288 1
a288 1
	fi 2> /dev/null`
d291 1
a291 1
		route -qn add -net 224.0.0.0/4 -interface $2 > /dev/null
d294 1
a294 1
			127.0.0.1 -reject > /dev/null
d299 1
a299 1
	route -qn add -net 224.0.0.0/4 -interface 127.0.0.1 -reject > /dev/null
d310 1
a310 1
route -qn add -net 127 127.0.0.1 -reject > /dev/null
@


1.145
log
@Allow rtsol keyword in hostname.if(5) with net.inet6.ip6.forwarding=1.
"inet6 autoconf" was working before and rtsol should behave the same.
OK phessler
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.144 2014/12/03 19:55:49 florian Exp $
d5 2
a6 2
# Strip comments (and leading/trailing whitespace if IFS is set)
# from a file and spew to stdout
d15 1
a15 1
# Start the $1 interface
d27 1
a27 1
	# Not using stat(1), we can't rely on having /usr yet
d37 1
a37 1
	# Now parse the hostname.* file
d45 1
a45 1
			# like the read below
d53 2
a54 2
		# $af can be "dhcp", "up", "rtsol", an address family,
		# commands, or a comment.
d56 1
a56 1
		"#"*|"") # skip comments and empty lines
d59 1
a59 1
		"!"*) # parse commands
d77 1
a77 1
				# perform a 'shift' of sorts
d127 3
a129 2
#   start "$1" interfaces in order or all interfaces if empty
#   don't start "$2" interfaces
d133 1
a133 1
			# Strip off /etc/hostname. prefix
d137 1
a137 1
			# Skip unwanted ifs
d144 1
a144 1
			# Start wanted ifs
d152 1
a152 1
# re-read rc.subr if we are not inside /etc/rc
d171 1
a171 1
# /etc/myname contains my symbolic name
d216 1
d227 1
d309 1
a309 1
# reject 127/8 other than 127.0.0.1
d313 1
a313 1
	# this is to make sure DAD is completed before going further.
@


1.144
log
@The kernel handles rtsol(8) functionality since some time now.
Treat rtsol in hostname.if as a keyword like dhcp and call ifconfig
inet6 autoconf.
"reads good" todd@@
OK krw@@ (who is *not* an IPv6 person), but I recruited him in his
capacity as an installer person.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.143 2014/09/28 12:58:02 claudio Exp $
d245 2
a246 7
	fw=`sysctl -n net.inet6.ip6.forwarding`
	if [ "x$fw" = "x0" ]; then
		echo "IPv6 autoconf:$rtsolif"
		ifconfig $rtsolif inet6 autoconf
	else
		echo "IPv6 autoconf not supported while IPv6 forwarding is enabled"
	fi
@


1.143
log
@Revert 1.142. Without the down netstart will just print the ifconfig
output because it may end up just calling 'ifconfig $if'. This needs
to be done better and properly tested.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.142 2014/09/26 15:18:01 halex Exp $
d248 1
a248 1
		rtsol $rtsolif
@


1.142
log
@remove explicit 'down' of an interface before starting a dhcp request, thereby
avoiding annoying delays for some switch configurations

ok claudio@@ deraadt@@

i would add ok phessler@@, but it was not valid without an ok krw@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.141 2014/07/12 14:39:31 stsp Exp $
d66 1
a66 1
			cmd="ifconfig $if $name $mask $bcaddr $ext1 $ext2"
@


1.141
log
@Fix netstart after autoconf6 change so 'rtsol' lines in hostname.if work again.
found by pelikan@@; ok pelikan@@ henning@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.140 2014/07/12 10:14:03 robert Exp $
d66 1
a66 1
			cmd="ifconfig $if $name $mask $bcaddr $ext1 $ext2 down"
@


1.140
log
@Make rc.conf a parsed configuration file and stop sourcing it as a shell
script.
From now on rc.conf has a fixed syntax (key=val) and it is not allowed
to add anything to it besides the supported syntax, it all going to be
ignored.

discussed with and help from deraadt@@ and halex@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.139 2013/08/22 07:53:11 mpi Exp $
d246 1
a246 2
	ra=`sysctl -n net.inet6.ip6.accept_rtadv`
	if [ "x$fw" = "x0" -a "x$ra" = "x1" ]; then
d250 1
a250 1
		echo "WARNING: inconsistent config - check /etc/sysctl.conf for IPv6 autoconf"
@


1.139
log
@Like for dhclient, do no create a route to alias addresses via 127.0.0.1.
Our stack is able to tell if the address is local or not.

ok todd@@, krw@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.138 2013/03/20 15:26:28 todd Exp $
d151 3
a153 2
# Re-read /etc/rc.conf
. /etc/rc.conf
@


1.138
log
@fix lies in netstart; replacement wording from halex@@
pointed out by Ryan Kavannagh rak at debian dot org
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.137 2012/12/05 07:08:38 rpe Exp $
a105 1
				[ "$alias" ] && rtcmd=";route -qn add -host $name 127.0.0.1"
d119 1
a119 1
			cmd="$cmd $ext1 $ext2$rtcmd" rtcmd=
@


1.137
log
@remove "Invalid interface name" message
requested by krw@@

ok halex@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.136 2012/12/02 21:02:45 rpe Exp $
d255 1
a255 2
# /etc/mygate, if it exists, contains the name of my gateway host
# that name must be in /etc/hosts.
@


1.136
log
@use the more compact version of the check for ifconfig'able interfaces
from install.sub

with feedback from and ok halex
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.135 2012/12/02 16:19:18 rpe Exp $
d20 1
a20 4
	if [[ $if != +([[:alpha:]])+([[:digit:]]) ]]; then 
		echo "netstart: $if: Invalid interface name"
		return
	fi
@


1.135
log
@- remove isalphanumeric() and replace it with a shell pattern, that
  tries a bit harder to identify invalid interface names and in
  this case emit an error message.
- use [[ $1 == autoboot ]] to avoid a shell error message due to
  possible spaces in first argument
- no change in functionality

discussed with krw and halex
ok ("I like this") krw
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.134 2011/10/07 16:36:26 deraadt Exp $
d37 2
a38 6
	if ! ifconfig $if > /dev/null 2>&1; then
		# Try to create interface if it does not exist
		if ! ifconfig $if create > /dev/null 2>&1; then
			return
		fi
	fi
@


1.134
log
@The new ypbind changes requires that the domainname be set before
rc.conf is run.  There's no real downside.
ok aja
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.133 2011/07/07 23:09:46 guenther Exp $
a14 14
# Returns true if $1 contains only alphanumerics
isalphanumeric() {
	local _n
	_n=$1
	while [ ${#_n} != 0 ]; do
		case $_n in
			[A-Za-z0-9]*)	;;
			*)		return 1;;
		esac
		_n=${_n#?}
	done
	return 0
}

d20 2
a21 1
	if ! isalphanumeric "$if"; then
d164 1
a164 1
if [ $1x = autobootx ]; then
@


1.133
log
@Eliminate some $? tests by rolling the command into the condition

ok halex@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.132 2011/05/26 15:22:53 mpf Exp $
a195 4
fi

if [ -f /etc/defaultdomain ]; then
	domainname `stripcom /etc/defaultdomain`
@


1.132
log
@Add svlan(4) startup bits.
From markus@@. OK naddy, claudio, reyk.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.131 2011/02/09 17:22:06 sobrado Exp $
d50 1
a50 2
	ifconfig $if > /dev/null 2>&1
	if [ "$?" != "0" ]; then
d52 1
a52 2
		ifconfig $if create > /dev/null 2>&1
		if [ "$?" != "0" ]; then
@


1.131
log
@fix an unbalanced parenthesis in a comment; while here, split the comment
in a better place to make it more readable.

ok jmc@@ and miod@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.130 2010/06/16 23:45:57 todd Exp $
d263 1
a263 1
ifmstart "" "trunk vlan carp gif gre pfsync pppoe tun bridge"
d266 1
a266 1
# The vlan interfaces need to come up after trunk.
d268 1
a268 1
ifmstart "trunk vlan carp"
@


1.130
log
@permit e.g. -inet6 syntax by slurping all lines not just some
noticed by rhsv6 at hushmail dot com, ok sthen@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.129 2010/01/12 07:43:41 henning Exp $
d204 2
a205 2
# Set the address for the loopback interface.  Bringing the
# interface up, automatically invokes the IPv6 address ::1)
@


1.129
log
@when setting up lo0 use 127.0.0.1/8 instead of 127.0.0.1 for clarity and
correctness. it's not 1992 any more, kids. ok mcbride dlg krw
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.128 2009/12/10 00:51:55 todd Exp $
d114 1
a114 1
			[a-z!]*)
@


1.128
log
@o stop reordering ifconfig arguments (e.g. after 'up ..')
o only stop processing if inet or inet6 lines are malformed
o everything not a specially handled bit is passed to ifconfig unmangled
noticed by several after the move from bridgename.bridge0 -> hostname.bridge0
prodded by deraadt@@, tested by and feedback from several
man page bits 'look fine' jmc@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.127 2009/11/22 23:09:50 deraadt Exp $
d206 1
a206 1
ifconfig lo0 inet 127.0.0.1
@


1.127
log
@Stop supporting bridgename.bridge* files, and move to hostname.bridge*
files.  To cope with this change, read about the mv command.
ok claudio todd
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.126 2009/09/17 08:22:22 simon Exp $
a95 5
		"up")
			# The only one of these guaranteed to be set is $if.
			# The remaining ones exist so that media controls work.
			cmd="ifconfig $if $name $mask $bcaddr $ext1 $ext2 up"
			;;
a117 4
			if [ ! -n "$name" ]; then
				echo "/etc/hostname.$if: invalid network configuration file"
				return
			fi
d120 4
d130 6
a135 1
			inet6) [ "$mask" ] && cmd="$cmd prefixlen $mask"
@


1.126
log
@change variable i to $i in an expression of ifstart() for consistency
with the rest of the file.  no functional change.

feedback from sthen@@, ok krw@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.125 2009/07/10 19:08:08 jdixon Exp $
a83 3
		"bridge")
			cmd="echo /etc/hostname.$if: bridges now supported via bridgename.* files"
			;;
a173 33
# Start the $1 bridge
bridgestart() {
	# Interface names must be alphanumeric only.  We check to avoid
	# configuring backup or temp files, and to catch the "*" case.
	if ! isalphanumeric "$1"; then
		return
	fi
	brconfig $1 > /dev/null 2>&1
	if [ "$?" != "0" ]; then
		# Try to create interface if it does not exist
		ifconfig $1 create > /dev/null 2>&1
		if [ "$?" != "0" ]; then
			return
		fi
	fi

	# Now parse the bridgename.* file
	# All lines are run as brconfig(8) commands.
	while read line ; do
		line=${line%%#*}		# strip comments
		test -z "$line" && continue
		case "$line" in
		"!"*)
			cmd="${line#*!}"
			;;
		*)
			cmd="brconfig $1 $line"
			;;
		esac
		eval "$cmd"
	done < /etc/bridgename.$1
}

d184 1
a184 5
		if [ -f /etc/bridgename.$1 ]; then
			bridgestart $1
		else
			ifstart $1
		fi
d262 2
a263 3
# do not start interfaces which must be delayed.
# Refer to hostname.if(5) and bridgename.if(5)
ifmstart "" "trunk vlan carp gif gre pfsync pppoe tun"
d337 1
a337 1
ifmstart "pppoe tun gif gre"
a340 9

# Configure all the bridges.
for bn in /etc/bridgename.*; do
	# Strip off /etc/bridgename. prefix
	if=${bn#/etc/bridgename.}
	test "$if" = "*" && continue

	bridgestart $if
done
@


1.125
log
@Delay creation of tun(4) interfaces until the underlying interface and
routes are available.  This fixes usage for some OpenVPN users that start
it from hostname.tun*.

Tested by Johan Huldtgren.  ok sthen@@, johan@@.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.124 2008/11/25 12:11:44 markus Exp $
d69 1
a69 1
			while [ i -lt 6 -a -n "$1" ]; do shift; let i=i+1; done
@


1.124
log
@delay /etc/netstart until IPv6-DAD (dup-address-detection) is completed.
ok fries, hshoexer, claudio
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.123 2008/08/14 00:59:50 sthen Exp $
d304 1
a304 1
ifmstart "" "trunk vlan carp gif gre pfsync pppoe"
d375 4
a378 3
# Configure PPPoE, GIF, GRE interfaces, delayed because they require routes
# to be set.  PPPoE must be first, as GIF and GRE may depend on it.
ifmstart "pppoe gif gre"
@


1.123
log
@Tools from /usr may not be used in netstart since it may be NFS-mounted
and not available at that time. Rewrite the hostname.if permission check
to use only /bin/ls and the shell. Requested by deraadt.

ok todd, "Twisted." deraadt
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.122 2008/07/23 16:05:47 sthen Exp $
d393 4
a396 1
	sleep `sysctl -n net.inet6.ip6.dad_count`
@


1.122
log
@Prevent warning about insecure hostnames where no /etc/hostname.*
exists. From wcmaier@@.

Check target of symbolic links to avoid noise at boot and in
seucrity output where you have several interfaces symlinked to one
config file.

"If you think this is the right thing to do" deraadt@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.121 2008/06/09 22:56:42 todd Exp $
d43 3
a45 1
	if [ "$(stat -Lf "%SLp %u %g" $file)" != "--- 0 0" ]; then
@


1.121
log
@warn once not 3 times in case of a non existent file, discussed with deraadt
originally pointed out by Johan Torin
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.120 2008/06/09 22:46:42 deraadt Exp $
d43 1
a43 1
	if [ "$(stat -f "%SLp %u %g" $file)" != "--- 0 0" ]; then
d45 2
a46 2
		chmod o-rwx $file
		chown root.wheel $file
@


1.120
log
@Ensure that hostname.* files are also re-chowned to root.wheel at each
boot as discussed with claudio while eating tasty donairs.  ok todd
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.119 2008/04/17 19:03:25 deraadt Exp $
d39 4
@


1.119
log
@before using them, force hostname.* files to be unreadable by world
first version from todd, ok millert
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.118 2008/01/17 12:36:33 brad Exp $
d39 1
a39 1
	if [ "$(stat -f "%SLp" $file)" != "---" ]; then
d42 1
@


1.118
log
@Execute rtsol after turning up trunk(4) and vlan(4) interfaces so they're
taken into consideration for rtsol.

ok reyk@@ dlg@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.117 2008/01/09 21:38:19 mpf Exp $
d38 5
@


1.117
log
@Do not bring up pfsync(4) before the working ruleset
has been loaded. Otherwise, states that are received during the
initial bulk update mismatch the correct pf-checksum and
do not attach to the rules.
Problem identified by david@@. Fix done in collaboration.
OK henning@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.116 2007/08/02 03:19:10 david Exp $
d294 5
a308 5

# The trunk interfaces need to come up first in this list.
# The vlan interfaces need to come up after trunk.
# Configure all the carp interfaces which we know about before default route.
ifmstart "trunk vlan carp"
@


1.116
log
@move the delay for IPv6 DAD to after all interfaces have started
fixes problems with daemons being unable to bind to all addreses at boot
ok itojun@@ hshoexer@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.115 2006/11/15 06:28:33 itojun Exp $
d307 2
a308 4
# The pfsync interfaces need to come up before carp.
# Configure all the carp interfaces which we know about.
# They must come up after pfsync but before default route.
ifmstart "trunk vlan pfsync carp"
@


1.115
log
@reject multicast packet without scope identifier specified.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.114 2006/06/29 17:23:28 todd Exp $
a303 4
if [ "$ip6kernel" = "YES" ]; then
	# this is to make sure DAD is completed before going further.
	sleep `sysctl -n net.inet6.ip6.dad_count`
fi
d380 5
@


1.114
log
@do not add an extra space; nwid and description come out wrong
fix as proposed by maja@@, thanks!
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.113 2005/12/28 04:55:35 david Exp $
d263 4
@


1.113
log
@nuke extra whitespace
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.112 2005/12/06 17:24:18 reyk Exp $
d105 1
a105 1
			cmd="ifconfig $if $af $alias $name "
@


1.112
log
@multicast_host=YES only works if a valid default gateway is available.
validate this condition and reject multicast traffic on failure.

ok todd@@ naddy@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.111 2005/11/02 18:45:26 todd Exp $
d149 1
a149 1
	
d151 1
a151 1
			s=""	
@


1.111
log
@fix inspired by pr#4590
ok krw@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.110 2005/10/25 14:18:38 todd Exp $
d333 1
d341 1
a341 1
	set `if [ $multicast_host = YES ]; then
d349 8
a356 2
	fi`
	route -qn add -net 224.0.0.0/4 -interface $2 > /dev/null
@


1.110
log
@better logic from krw@@:
- do not process mygate for v4 if dhcp
- do not process mygate for v6 if rtsol
this also makes the mygate processing logic more readable
ok krw@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.109 2005/10/14 15:46:41 todd Exp $
d175 1
a175 1
		ifconfig $if create > /dev/null 2>&1
@


1.109
log
@add v6 support for /etc/mygate
ok deraadt@@ mickey@@ krw@@
same functionality tested/ok'ed by by mickey, brad, matthieu, and me
with this one may now put a v6 IP in /etc/mygate on a separate line from
the v4 default gateway and netstart will do the right thing
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.108 2005/10/12 13:11:55 todd Exp $
d9 1
d81 1
a81 1
			setgateway=N
d314 10
a323 12
if [ "X${setgateway}" != X"N" -a -f /etc/mygate ]; then
	route -qn delete default > /dev/null 2>&1
	route -qn delete -inet6 default > /dev/null 2>&1
	# Now parse the mygate file
	stripcom /etc/mygate | while read gw; do
		case "$gw" in
		*:*)	af=-inet6;;
		*)	af=;;
		esac
		route -qn add -host $af default $gw
	done
fi
@


1.108
log
@shrink stripcom(), sync with install.sub
ok krw@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.107 2005/10/04 12:50:15 todd Exp $
d315 9
a323 1
	route -qn add -host default `stripcom /etc/mygate`
@


1.107
log
@trunk must be started after physical ethernet devices, but before vlan.
populate ifmstart lines accordingly.
prodded/tested by brad@@
ok reyk@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.106 2005/09/28 17:40:30 todd Exp $
d8 4
a11 10
	local _file="$1"
	local _line

	{
		while read _line ; do
			_line=${_line%%#*}		# strip comments
			test -z "$_line" && continue
			echo $_line
		done
	} < $_file
@


1.106
log
@use eval consistently, fixes description quotes on rtsol and dhcp
fix inspired by and closes pr 4495
ok krw@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.105 2005/05/22 08:56:08 todd Exp $
d293 1
a293 1
ifmstart "" "carp gif gre pfsync pppoe"
d310 3
a312 1
# The pfsync interface needs to come up before carp.
d315 1
a315 1
ifmstart "pfsync carp"
@


1.105
log
@Introduce 'ifmstart' to deal with starting multiple interfaces minus a list
of interfaces.

This reduces the netstart script by 174 chars, 13 words, and 19 lines, but
more importantly, makes it more simple and less cluttered should more special
case/orderings be needed.

ok brad@@ and pr 4197 submitter, inspired by and closes pr 4197
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.104 2005/04/04 04:26:27 djm Exp $
d84 2
a85 2
			ifconfig $if $name $mask $bcaddr $ext1 $ext2 down
			cmd="dhclient $if"
a88 1
			ifconfig $if $name $mask $bcaddr $ext1 $ext2 up
d90 1
a90 1
			cmd=
@


1.104
log
@unbreak; ok pval@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.103 2005/04/03 19:39:31 deraadt Exp $
d146 25
d290 3
a292 1
# Configure all the non-loopback interfaces which we know about.
d294 1
a294 16
for hn in /etc/hostname.*; do
	# Strip off /etc/hostname. prefix
	if=${hn#/etc/hostname.}
	test "$if" = "*" && continue

	case $if in
	"carp"*|"gif"*|"gre"*|"pfsync"*)
		# CARP, GIF, GRE and PFSYNC interfaces need the routes to be setup
		# before they are configured.
		continue
		;;
	*)
		ifstart $if
		;;
	esac
done
a311 4
if [ -f /etc/hostname.pfsync0 ]; then
	ifstart pfsync0
fi

d314 1
a314 15
for hn in /etc/hostname.*; do
	# Strip off /etc/hostname. prefix
	if=${hn#/etc/hostname.}
	test "$if" = "*" && continue

	case $if in
	"carp"*)
		ifstart $if
		;;
	*)
		# Regular interfaces have already been configured.
		continue
		;;
	esac
done
d355 4
a358 17
# Configure all the gif and gre interfaces which we know about.
# They were delayed because they require the routes to be set.
for hn in /etc/hostname.*; do
	# Strip off /etc/hostname. prefix
	if=${hn#/etc/hostname.}
	test "$if" = "*" && continue

	case $if in
	"gif"*|"gre"*)
		ifstart $if
		;;
	*)
		# Regular interfaces have already been configured.
		continue
		;;
	esac
done
@


1.103
log
@if dhcp is used to get an address on any interface, ignore /etc/mygate
ok krw
(this lets us do something rather cool with the zaurus in particular)
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.102 2005/01/04 15:40:53 mcbride Exp $
d324 1
a324 1
if [ "X${setgateway} != X"N" -a -f /etc/mygate ]; then
@


1.102
log
@Bring up the carp(4) interface before default route.

ok pascoe@@ mpf@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.101 2004/12/30 17:33:59 millert Exp $
d86 1
d324 1
a324 1
if [ -f /etc/mygate ]; then
@


1.101
log
@Add a copy of stripcom so /etc/netstart can be run standalone again.
OK deraadt@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.100 2004/12/19 15:37:58 millert Exp $
d298 23
d360 1
a360 6
# The pfsync interface needs to come up before carp.
if [ -f /etc/hostname.pfsync0 ]; then
		ifstart pfsync0
fi

# Configure all the carp, gif and gre interfaces which we know about.
d368 1
a368 1
	"carp"*|"gif"*|"gre"*)
@


1.100
log
@Allow comments in /etc/{myname,mygate,defaultdomain}; OK deraadt@@
@
text
@d3 16
a18 1
#	$OpenBSD: netstart,v 1.99 2004/12/04 00:17:05 itojun Exp $
@


1.99
log
@remove "route $hostname 127.0.0.1" line.  deraadt ok
*** please update /etc/netstart and test if it works ok for you ***
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.98 2004/10/20 21:17:34 deraadt Exp $
d187 1
a187 1
	hostname=`cat /etc/myname`
d194 1
a194 1
	domainname `cat /etc/defaultdomain`
d287 1
a287 1
	route -qn add -host default `cat /etc/mygate`
@


1.98
log
@make all route commands use -qn; ok mcbride henning
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.97 2004/05/29 07:01:03 deraadt Exp $
d345 1
a345 2
# Use loopback, not the wire.
route -qn add -host $hostname 127.0.0.1 > /dev/null
@


1.97
log
@one last route command lacking -qn
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.96 2004/03/22 04:31:42 mcbride Exp $
d206 1
a206 1
	route -q add -inet6 fe80:: -prefixlen 10 ::1 -reject > /dev/null
d212 1
a212 1
	route -q add -inet6 fec0:: -prefixlen 10 ::1 -reject > /dev/null
d215 1
a215 1
	route -q add -inet6 ::ffff:0.0.0.0 -prefixlen 96 ::1 -reject > /dev/null
d218 4
a221 4
	route -q add -inet6 ::224.0.0.0 -prefixlen 100 ::1 -reject > /dev/null
	route -q add -inet6 ::127.0.0.0 -prefixlen 104 ::1 -reject > /dev/null
	route -q add -inet6 ::0.0.0.0 -prefixlen 104 ::1 -reject > /dev/null
	route -q add -inet6 ::255.0.0.0 -prefixlen 104 ::1 -reject > /dev/null
d224 4
a227 4
	route -q add -inet6 2002:e000:: -prefixlen 20 ::1 -reject > /dev/null
	route -q add -inet6 2002:7f00:: -prefixlen 24 ::1 -reject > /dev/null
	route -q add -inet6 2002:0000:: -prefixlen 24 ::1 -reject > /dev/null
	route -q add -inet6 2002:ff00:: -prefixlen 24 ::1 -reject > /dev/null
d242 1
a242 1
	route -q add -inet6 ::0.0.0.0 -prefixlen 96 ::1 -reject > /dev/null
@


1.96
log
@Make sure pfsync is brought up before carp.

ok deraadt@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.95 2004/03/13 00:59:02 mcbride Exp $
d286 1
a286 1
	route delete default > /dev/null 2>&1
@


1.95
log
@Delay pfsync(4) configuration, as the syncif has to be configured in
advance. From Thorsten Lockert.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.94 2004/01/14 04:41:02 deraadt Exp $
d322 6
a327 1
# Configure all the carp, gif, gre and pfsync interfaces which we know about.
d335 1
a335 1
	"carp"*|"gif"*|"gre"*|"pfsync"*)
@


1.94
log
@ok, it took quite a bit of prodding but itojun finally explained why the
extra sleep 1 is in here, and we came to the conclusion it is safe to
delete it.  whee.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.93 2004/01/13 08:36:57 deraadt Exp $
d257 2
a258 2
	"carp"*|"gif"*|"gre"*)
		# CARP, GIF and GRE interfaces need the routes to be setup
d322 1
a322 1
# Configure all the carp, gif and gre interfaces which we know about.
d330 1
a330 1
	"carp"*|"gif"*|"gre"*)
@


1.93
log
@repair v6 lo0 documentation
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.92 2004/01/11 06:07:16 deraadt Exp $
a280 1
	sleep 1
@


1.92
log
@add loopback routes late
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.91 2004/01/09 10:02:23 deraadt Exp $
d197 2
a198 2
# Set the address for the loopback interface.
# It will also initialize IPv6 address for lo0 (::1 and others).
@


1.91
log
@create all routes with -q; markus ok
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.90 2003/12/04 01:19:37 millert Exp $
d199 1
a199 5
ifconfig lo0 inet localhost

# Use loopback, not the wire.
route -qn add -host $hostname localhost > /dev/null
route -qn add -net 127 127.0.0.1 -reject > /dev/null
d340 4
@


1.90
log
@Need to do "ifconfig create" for bridge interfaces too.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.89 2003/12/03 13:28:36 markus Exp $
d114 1
a114 1
				[ "$alias" ] && rtcmd=";route -n add -host $name 127.0.0.1"
d202 2
a203 2
route -n add -host $hostname localhost > /dev/null
route -n add -net 127 127.0.0.1 -reject > /dev/null
d210 1
a210 1
	route add -inet6 fe80:: -prefixlen 10 ::1 -reject > /dev/null
d216 1
a216 1
	route add -inet6 fec0:: -prefixlen 10 ::1 -reject > /dev/null
d219 1
a219 1
	route add -inet6 ::ffff:0.0.0.0 -prefixlen 96 ::1 -reject > /dev/null
d222 4
a225 4
	route add -inet6 ::224.0.0.0 -prefixlen 100 ::1 -reject > /dev/null
	route add -inet6 ::127.0.0.0 -prefixlen 104 ::1 -reject > /dev/null
	route add -inet6 ::0.0.0.0 -prefixlen 104 ::1 -reject > /dev/null
	route add -inet6 ::255.0.0.0 -prefixlen 104 ::1 -reject > /dev/null
d228 4
a231 4
	route add -inet6 2002:e000:: -prefixlen 20 ::1 -reject > /dev/null
	route add -inet6 2002:7f00:: -prefixlen 24 ::1 -reject > /dev/null
	route add -inet6 2002:0000:: -prefixlen 24 ::1 -reject > /dev/null
	route add -inet6 2002:ff00:: -prefixlen 24 ::1 -reject > /dev/null
d246 1
a246 1
	route add -inet6 ::0.0.0.0 -prefixlen 96 ::1 -reject > /dev/null
d292 1
a292 1
	route -n add -host default `cat /etc/mygate`
d305 1
a305 1
	route -n add -net 224.0.0.0/4 -interface 127.0.0.1 -reject > /dev/null
d311 1
a311 1
		ed -s '!route -n show -inet' <<EOF
d319 1
a319 1
	route -n add -net 224.0.0.0/4 -interface $2 > /dev/null
d323 1
a323 1
	route -n add -net 224.0.0.0/4 -interface 127.0.0.1 -reject > /dev/null
@


1.89
log
@add support for ifconfig clone; from netbsd; ok deraadt, henning
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.88 2003/10/20 17:53:32 david Exp $
d139 5
a143 1
		return
@


1.88
log
@delay carp initialization until after physical interfaces are configured
ok mcbride@@ henning@@ deraadt@@ todd@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.87 2003/08/27 11:49:36 henning Exp $
d30 5
a34 1
		return
@


1.87
log
@only try to set hostname to what /etc/myname says if that file actually exists,
otherwise preserve `hostname`
netbooted machines can live perfectly fine without it; they get their hostname
earlier.

ok krw@@ cedric@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.86 2003/02/16 23:25:40 krw Exp $
d253 3
a255 3
	"gif"*|"gre"*)
		# GIF and GRE interfaces need the routes to be setup before
		# they are configured.
d319 1
a319 1
# Configure all the gif and gre interfaces which we know about.
d327 1
a327 1
	"gif"*|"gre"*)
@


1.86
log
@Fix up some DNS verbiage to make it consistant.

Fix up default route selection by

a) Forcing user to explicitly chose 'dhcp' as a mechanism for
specifying a default route, rather than guessing based on one or more
interfaces being configured by dhcp.

b) If the user specified default route does not work, re-present the
existing default route rather than losing it.

c) Move default route selection to after nameserver activation so the
user can specify a hostname as the default route.

Change /etc/netstart so that /etc/mygate wins if a default route was
already specified (i.e. by dhcp).

ok deraadt@@.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.85 2002/05/16 20:48:25 todd Exp $
d178 7
a184 2
hostname=`cat /etc/myname`
hostname $hostname
@


1.85
log
@ignore non-existent cases where '$if' evaluates to '*'.
From Andr Lucas <andre@@ae-35.com>, fixes pr # 2658.
'Looks good' from miod@@, millert@@, and krw@@.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.84 2002/02/23 01:55:24 deraadt Exp $
d278 1
@


1.84
log
@re-add support for $if expansion; hamajima@@nagoya.ydc.co.jp
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.83 2002/02/21 02:32:01 miod Exp $
d245 1
d318 1
d335 1
@


1.83
log
@Change the network components initialization order.
Change from:
o all interfaces
o all bridges
o routes
to:
o physical interfaces
o routes
o gif and gre interfaces
o bridges

Fixeski PR #2400.
Manual page updates coming soon.
Ok angelos@@ chris@@ deraadt@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.82 2001/07/31 08:27:35 hugh Exp $
d21 1
d24 1
a24 1
	if ! isalphanumeric "$1"; then
d28 1
a28 1
	ifconfig $1 > /dev/null 2>&1
d59 1
a59 1
			cmd="echo /etc/hostname.$1: bridges now supported via bridgename.* files"
d65 2
a66 2
			ifconfig $1 $name $mask $bcaddr $ext1 $ext2 down
			cmd="dhclient $1"
d69 2
a70 2
			ifconfig $1 $name $mask $bcaddr $ext1 $ext2 up
			rtsolif="$rtsolif $1"
d74 1
a74 1
			# The only one of these guaranteed to be set is $1.
d76 1
a76 1
			cmd="ifconfig $1 $name $mask $bcaddr $ext1 $ext2 up"
d91 1
a91 1
			cmd="ifconfig $1 $af $alias $name "
d101 1
a101 1
				echo "/etc/hostname.$1: invalid network configuration file"
d123 1
a123 1
	done < /etc/hostname.$1
@


1.82
log
@a space before a redirect
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.81 2001/07/06 05:53:17 angelos Exp $
d19 135
d157 19
a176 1
#
d183 2
a184 2
# set the address for the loopback interface
# it will also initialize IPv6 address for lo0 (::1 and others).
d187 1
a187 1
# use loopback, not the wire
d195 1
a195 1
	# disallow link-local unicast dest without outgoing scope identifiers.
d198 1
a198 1
	# disallow site-local unicast dest without outgoing scope identifiers.
d204 1
a204 1
	# disallow "internal" addresses to appear on the wire.
d207 1
a207 1
	# disallow packets to malicious IPv4 compatible prefix.
d213 1
a213 1
	# disallow packets to malicious 6to4 prefix.
d239 2
a240 2
# configure all of the non-loopback interfaces which we know about.
# refer to hostname.if(5) and bridgename.if(5)
d242 2
a243 2
    # Strip off /etc/hostname. prefix
    if=${hn#/etc/hostname.}
d245 6
a250 52
    # Interface names must be alphanumeric only.  We check to avoid
    # configuring backup or temp files, and to catch the "*" case.
    if ! isalphanumeric "$if"; then
	continue
    fi
    ifconfig $if > /dev/null 2>&1
    if [ "$?" != "0" ]; then
	continue
    fi

    # Now parse the hostname.* file
    while :; do
	if [ "$cmd2" ]; then
	    # we are carrying over from the 'read dt dtaddr' last time
	    set -- $cmd2
	    af="$1" name="$2" mask="$3" bcaddr="$4" ext1="$5" cmd2=
	    # make sure and get any remaining args in ext2, like the read below
	    i=1; while [ i -lt 6 -a -n "$1" ]; do shift; let i=i+1; done
	    ext2="$@@"
	else
	    # read the next line or exit the while loop
	    read af name mask bcaddr ext1 ext2 || break
	fi
	# $af can be "dhcp", "up", "rtsol", an address family, commands, or
	# a comment.
	case "$af" in
	"#"*|"") # skip comments and empty lines
	    continue
	    ;;
	"!"*) # parse commands
	    cmd="${af#*!} ${name} ${mask} ${bcaddr} ${ext1} ${ext2}"
	    ;;
	"bridge")
	    cmd="echo ${hn}: bridges now supported via bridgename.* files"
	    ;;
	"dhcp")
	    [ "$name" = "NONE" ] && name=
	    [ "$mask" = "NONE" ] && mask=
	    [ "$bcaddr" = "NONE" ] && bcaddr=
	    ifconfig $if $name $mask $bcaddr $ext1 $ext2 down
	    cmd="dhclient $if"
	    ;;
	"rtsol")
	    ifconfig $if $name $mask $bcaddr $ext1 $ext2 up
	    rtsolif="$rtsolif $if"
	    cmd=
	    ;;
	"up")
	    # The only one of these guaranteed to be set is $if
	    # the remaining ones exist so that media controls work
	    cmd="ifconfig $if $name $mask $bcaddr $ext1 $ext2 up"
	    ;;
d252 1
a252 19
	    read dt dtaddr
	    if [ "$name"  = "alias" ]; then
		# perform a 'shift' of sorts
		alias=$name
		name=$mask
		mask=$bcaddr
		bcaddr=$ext1
		ext1=$ext2
		ext2=
	    else
		alias=
	    fi
	    cmd="ifconfig $if $af $alias $name "
	    case "$dt" in
	    dest)
		cmd="$cmd $dtaddr"
		;;
	    [a-z!]*)
		cmd2="$dt $dtaddr"
a253 20
	    esac
	    if [ ! -n "$name" ]; then
		    echo "/etc/hostname.$if: invalid network configuration file"
		return
	    fi
	    case $af in
	    inet)
		[ "$mask" ] && cmd="$cmd netmask $mask"
		if [ "$bcaddr" -a "X$bcaddr" != "XNONE" ]; then
		    cmd="$cmd broadcast $bcaddr"
		fi
		[ "$alias" ] && rtcmd="; route -n add -host $name 127.0.0.1"
		;;
	    inet6) [ "$mask" ] && cmd="$cmd prefixlen $mask"
		cmd="$cmd $bcaddr"
		;;
	    *) cmd="$cmd $mask $bcaddr"
	    esac
	    cmd="$cmd $ext1 $ext2$rtcmd" rtcmd=
	    ;;
a254 2
	eval "$cmd"
    done < /etc/hostname.$if
a272 33
for bn in /etc/bridgename.*; do
    # Strip off /etc/bridgename. prefix
    if=${bn#/etc/bridgename.}

    # Interface names must be alphanumeric only.  We check to avoid
    # configuring backup or temp files, and to catch the "*" case.
    if ! isalphanumeric "$if"; then
        continue
    fi
    brconfig $if > /dev/null 2>&1
    if [ "$?" != "0" ]; then
	continue
    fi

    # Now parse the bridgename.* file
    {
	# All lines are run as brconfig(8) commands.
	while read line ; do
	    line=${line%%#*}		# strip comments
	    test -z "$line" && continue
	    case "$line" in
	    "!"*)
		cmd="${line#*!}"
		;;
	    *)
		cmd="brconfig $if $line"
		;;
	    esac
	    eval "$cmd"
	done
    } < /etc/bridgename.$if
done

d310 25
@


1.81
log
@Also, source /etc/rc.conf so we can pull in the
multicast_host/multicast_router settings; this is useful if one
flushes the routing table and re-initializes.

We really need a netconfig tool of sorts.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.80 2001/07/06 05:44:40 angelos Exp $
d255 1
a255 1
	route -n add -net 224.0.0.0/4 -interface 127.0.0.1 -reject> /dev/null
@


1.80
log
@Use "route -n show -inet" to determine the default multicast iface.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.79 2001/07/03 03:28:19 deraadt Exp $
d18 3
@


1.79
log
@pull in rc.conf early so that pf(1) startup is right; tested by jasoni, comments from millert
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.78 2001/05/30 02:11:08 deraadt Exp $
d258 1
a258 1
		ed -s '!route -n show' <<EOF
@


1.78
log
@Remove ipf.  Darren Reed has interpreted his (old, new, whichever)
licence in a way that makes ipf not free according to the rules we
established over 5 years ago, at www.openbsd.org/goals.html (and those
same basic rules govern the other *BSD projects too).  Specifically,
Darren says that modified versions are not permitted.  But software
which OpenBSD uses and redistributes must be free to all (be they
people or companies), for any purpose they wish to use it, including
modification, use, peeing on, or even integration into baby mulching
machines or atomic bombs to be dropped on Australia.  Furthermore, we
know of a number of companies using ipf with modification like us, who
are now in the same situation, and we hope that some of them will work
with us to fill this gap that now exists in OpenBSD (temporarily, we
hope).
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.77 2001/03/13 21:15:09 deraadt Exp $
a25 3

# pick up option configuration
. /etc/rc.conf
@


1.77
log
@spelling; maurice@@maurice.wan.nl
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.76 2001/02/06 23:05:45 todd Exp $
a29 8
# Configure the IP filter before configuring network interfaces
if [ X"${ipfilter}" = X"YES" -a -f "${ipfilter_rules}" ]; then
	echo 'configuring IP filter'
	ipf -Fa -f ${ipfilter_rules}
else
	ipfilter=NO
fi

a275 8

# Configure NAT after configuring network interfaces
if [ "${ipnat}" = "YES" -a "${ipfilter}" = "YES" -a -f "${ipnat_rules}" ]; then
	echo 'configuring NAT'
	ipnat -CF -f ${ipnat_rules}
else
	ipnat=NO
fi
@


1.76
log
@ignore blank lines in addition to comments
fixes pr#1660 from wilfried@@telia.com .. Thanks!
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.75 2001/01/10 22:17:10 jason Exp $
d53 1
a53 1
	# disallow site-local unicast dest without outgoing scope identifiers..
d77 1
a77 1
	#     comatible destination.  The KAME node has no IPv4 compatible
d82 1
a82 1
	# (2) An IPv6-only node originates a packet to IPv4 compatible
d85 1
a85 1
	# Due to rare use of IPv4 compatible address, and security issues
@


1.75
log
@support !command in bridgename.if files, too
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.74 2000/11/27 17:14:00 millert Exp $
d126 1
a126 1
	"#"*) # skip comments
@


1.74
log
@Use -n to test if a variable is non-zero.  Otherwise, if the variable's
contents start with a '-' test becomes unhappy (since it interprets it
as another option).
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.73 2000/11/08 19:09:29 todd Exp $
d234 9
a242 1
	    brconfig $if $line
@


1.73
log
@This fixes pr 1481, we now handle args > 6 in /etc/hostname.if in the
cases where we did not previously handle them.
Thanks to Scott Atwood <atwood@@cs.stanford.edu> for reminding us of this.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.72 2000/09/02 15:59:29 todd Exp $
d117 1
a117 1
	    i=1; while [ i -lt 6 -a "$1" ]; do shift; let i=i+1; done
@


1.72
log
@
subtle bug .. global variables in a while loop need reset 'just incase'
With:
	hostname.fxp0 having a last line of:
		inet6 alias 3ffe:...
	and hostname.gif0 having a first two lines of:
		giftunnel 1.2.3.4
		dest 1.2.4.3
	We end up with the command:
		ifconfig gif0 giftunnel alias 1.2.3.4  1.2.4.3
.. which is clearly wrong and fixed by this change
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.71 2000/06/18 19:02:24 todd Exp $
d115 4
a118 2
	    af="$1" name="$2" mask="$3" bcaddr="$4" ext1="$5" ext2="$6"
	    cmd2=
@


1.71
log
@rc.conf now parses ${local_rcconf} internally; closes pr 1259
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.70 2000/05/08 21:44:39 todd Exp $
d160 2
@


1.70
log
@fix dhcp 'NONE' ness from install to allow media parsing to work
.. ok deraadt@@, millert@@
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.68 2000/04/04 13:44:51 millert Exp $
a28 3
if [ -f $local_rcconf ]; then
	. $local_rcconf
fi
@


1.69
log
@rc.conf.local support, inspired by chuck yerkes
@
text
@d137 3
@


1.68
log
@Remove the -E flag from ipf as it is implicitly enabled and using
the -E flag here causes the kernel to printf 'IP Filter: already
initialized'.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.67 2000/03/18 19:45:45 deraadt Exp $
d29 3
@


1.67
log
@silence all extra route addition printouts
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.66 2000/03/17 17:40:31 itojun Exp $
d33 1
a33 1
	ipf -Fa -f ${ipfilter_rules} -E
@


1.66
log
@correct reject route installations for IPv6.  improve comments.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.65 2000/03/12 04:18:47 itojun Exp $
d43 2
a44 2
route -n add -host $hostname localhost
route -n add -net 127 127.0.0.1 -reject
d51 1
a51 1
	route add -inet6 fe80:: -prefixlen 10 ::1 -reject
d57 1
a57 1
	route add -inet6 fec0:: -prefixlen 10 ::1 -reject
d60 1
a60 1
	route add -inet6 ::ffff:0.0.0.0 -prefixlen 96 ::1 -reject
d63 4
a66 4
	route add -inet6 ::224.0.0.0 -prefixlen 100 ::1 -reject
	route add -inet6 ::127.0.0.0 -prefixlen 104 ::1 -reject
	route add -inet6 ::0.0.0.0 -prefixlen 104 ::1 -reject
	route add -inet6 ::255.0.0.0 -prefixlen 104 ::1 -reject
d69 4
a72 4
	route add -inet6 2002:e000:: -prefixlen 20 ::1 -reject
	route add -inet6 2002:7f00:: -prefixlen 24 ::1 -reject
	route add -inet6 2002:0000:: -prefixlen 24 ::1 -reject
	route add -inet6 2002:ff00:: -prefixlen 24 ::1 -reject
d87 1
a87 1
	route add -inet6 ::0.0.0.0 -prefixlen 96 ::1 -reject
d248 2
a249 1
	route -n add -net 224.0.0.0/4 -interface 127.0.0.1 -reject;;
d262 2
a263 1
	route -n add -net 224.0.0.0/4 -interface $2;;
d266 2
a267 1
	route -n add -net 224.0.0.0/4 -interface 127.0.0.1 -reject;;
@


1.65
log
@disallow packets to malicious 6to4 prefix, based on
http://playground.iijlab.net/i-d/draft-itojun-ipv6-transition-abuse-00.txt
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.64 2000/03/10 13:21:51 todd Exp $
d50 1
a50 1
	# disallow scoped unicast dest without outgoing scope identifiers.
d52 7
a58 1
	route add -inet6 fc80:: -prefixlen 10 ::1 -reject
d61 8
a68 2
	route add -inet6 ::0.0.0.0 -prefixlen 96 ::1 -reject
	# disallow packets to malicious 6to4 prefix
d71 17
a87 2
	route add -inet6 2002:0000:0000:: -prefixlen 48 ::1 -reject
	route add -inet6 2002:ffff:ffff:: -prefixlen 48 ::1 -reject
@


1.64
log
@fix non behavior
with this `!' lines in /etc/hostname.* run even without certain lines
(like a comment) preceeding it.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.63 2000/01/10 02:04:07 todd Exp $
d56 5
@


1.63
log
@allow arbitrary commands in /etc/hostname.* files if the line starts with '!'
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.62 2000/01/02 06:50:09 deraadt Exp $
d127 1
a127 1
	    case $dt in
d131 1
a131 1
	    [a-z]*)
@


1.62
log
@rtsol case can configure the interface up, since it would be nice to finish
DAD before the actual rtsol(8) run happens later.  and since it will rtsol,
it is going to be up in any case.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.61 2000/01/02 06:43:42 itojun Exp $
d89 2
a90 3
	# skip comments
	[ "${af#*#}" = "${af}" ] || continue
	# $af can be either "dhcp", "up" or an address family.
d92 6
@


1.61
log
@one more indentation fix.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.60 2000/01/02 06:42:13 itojun Exp $
d101 1
a101 1
	    ifconfig $if $name $mask $bcaddr $ext1 $ext2 down
@


1.60
log
@indentation fix (todd's part)
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.59 2000/01/02 06:39:08 todd Exp $
d141 1
a141 1
	    ;;
@


1.59
log
@fix rtsold case, reset cmd for each iteration!
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.58 2000/01/02 06:32:44 itojun Exp $
d129 2
a130 2
	     esac
	     if [ ! -n "$name" ]; then
d133 3
a135 3
	     fi
	     case $af in
	     inet)
d141 2
a142 2
	     ;;
	     inet6) [ "$mask" ] && cmd="$cmd prefixlen $mask"
d145 4
a148 4
	     *) cmd="$cmd $mask $bcaddr"
	     esac
	     cmd="$cmd $ext1 $ext2$rtcmd" rtcmd=
	     ;;
@


1.58
log
@allow options after "rtsol".
XXX both "dhcp" and "rtsol" has keyword *down* at the end.  is it okay?
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.57 2000/01/02 05:21:55 itojun Exp $
d103 1
@


1.57
log
@echo "IPv6 autoconf: interfaces" before invoking rtsol.
sleep for net.inet6.ip6.dad_count seconds to ensure that IPv6 DAD is completed.
TODO: rtsold (rc.conf line), manpage
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.56 2000/01/02 05:14:52 itojun Exp $
d101 1
@


1.56
log
@ipv6 autoconf on hosts (non-routers).

to do this,
1. in sysctl.conf, add these lines:
	net.inet6.ip6.forwarding=0
	net.inet6.ip6.accept_rtadv=1
2. in hostname.foo, add
	rtsol

specifying two or more interfaces with "rtsol" may result in strange
behavior - ipv6 spec does not permit multi-interface node to be autoconfig'ed.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.55 2000/01/02 04:38:17 todd Exp $
d156 1
d161 5
@


1.55
log
@add to hostname.* parsing:
- multiple entries support (read: aliases)
- inet6 support
- support for comments (#)
(look for hostname.if(5) commit for syntax details)
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.54 1999/12/31 04:32:53 itojun Exp $
d56 2
d100 3
d151 11
@


1.54
log
@install IPv6 reject routes only if kernel is capable of IPv6.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.53 1999/12/09 14:22:38 itojun Exp $
d69 1
a69 1
        continue
d77 12
a88 3
    {
        read af name mask bcaddr extras

d95 1
a95 1
	    ifconfig $if $name $mask $bcaddr $extras down
d101 12
a112 7
	    cmd="ifconfig $if $name $mask $bcaddr $extras up"
 	    ;;
 	*)
            read dt dtaddr
	    if [ ! -n "$name" ]; then
		echo "/etc/hostname.$if: invalid network configuration file"
		continue
d114 28
a141 9

	    cmd="ifconfig $if $af $name "
	    if [ "${dt}" = "dest" ]; then cmd="$cmd $dtaddr"; fi
	    if [ -n "$mask" ]; then cmd="$cmd netmask $mask"; fi
	    if [ -n "$bcaddr" -a "X$bcaddr" != "XNONE" ]; then
		cmd="$cmd broadcast $bcaddr";
	    fi
	    cmd="$cmd $extras";
	    ;;
a142 1

d144 1
a144 1
    } < /etc/hostname.$if
@


1.53
log
@avoid transmitting invalid IPv6 packets out to the wire.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.52 1999/12/09 13:59:57 itojun Exp $
d46 14
a173 8
# IPv6 configurations.
# disallow scoped unicast dest without outgoing scope identifiers.
route add -inet6 fe80:: -prefixlen 10 ::1 -reject
route add -inet6 fc80:: -prefixlen 10 ::1 -reject
# disallow "internal" addresses to appear on the wire.
route add -inet6 ::ffff:0.0.0.0 -prefixlen 96 ::1 -reject
route add -inet6 ::0.0.0.0 -prefixlen 96 ::1 -reject
	
@


1.52
log
@do not perform IPv6 initialization for loopback interface.
MUST make lo0 up before any IPv6 operations.
it will be considered a pilot error if you don't.
(I prefer to have lo0 initialized automatically)
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.51 1999/09/01 18:07:34 deraadt Exp $
d159 8
@


1.51
log
@support # characters in bridgename.* files; millert
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.50 1999/09/01 05:07:50 deraadt Exp $
d39 1
@


1.50
log
@cleanup parsing of hostname.* files, and seperate bridge control into
bridgename.* files; all documented in new hostname.if(5) and
bridgename.if(5) man pages
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.49 1999/08/09 21:49:04 angelos Exp $
d117 2
a118 1
	    # XXX should support # comments and skip blank lines 
@


1.49
log
@Only parse/setup the hostname.foo file if interface foo exists (this
is useful for laptops with different ethernet cards etc.)
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.48 1999/03/29 22:09:58 niklas Exp $
d46 1
a46 39
# do this by reading /etc/hostname.* files, where * is the name
# of a given interface.
#
# these files are formatted like the following, but with no # at the
# beginning of the line
#
# addr_family hostname netmask broadcast_addr options
# dest dest_addr
#
# OR
#
# dhcp
#
# OR
#
# bridge
# brconfig-arguments [ several lines if needed ]
#
# addr_family is the address family of the interface, generally inet
# hostname is the host name that belongs to the interface, in /etc/hosts.
# netmask is the network mask for the interface.
# broadcast_addr is the broadcast address for the interface
# options are misc. options to ifconfig for the interface.
#
# dest is simply the string "dest" (no quotes, though) if the interface
# has a "destination" (i.e. it's a point-to-point link, like SLIP).
# dest_addr is the hostname of the other end of the link, in /etc/hosts
#
# the only required contents of the file in this mode are the addr_family field
# and the hostname.
#
# dhcp is simply the string "dhcp" (no quotes, though) if the interface
# is to be configured using DHCP.  See dhclient(8) and dhclient.conf(5)
# for details.
#
# bridge is the string "bridge" (still no quotes).  Bridge interfaces
# are just configured "up" and then brconfig(8) is called for each
# line of arguments following this first line.

d56 1
a56 3

    # If the interface does not exist, just skip processing the file
    /sbin/ifconfig $if > /dev/null 2>&1
d65 1
a65 1
	# $af can be either "bridge", "dhcp", "up" or an address family.
d68 2
a69 3
	    ifconfig $if up
	    cmd=`sed "s/\(.*\)/brconfig $if \1;/"`
 	    ;;
d71 2
a72 2
	    ifconfig $if $extras down
	    cmd="/sbin/dhclient $if"
d76 1
d83 1
a83 1
		exit
d98 23
@


1.48
log
@New multicast route setup style
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.47 1999/03/26 14:34:31 niklas Exp $
d93 6
@


1.47
log
@Add bridge interface handling
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.46 1999/03/01 05:04:24 millert Exp $
a137 6

	# default multicast route for hosts with a gateway
	route -n add -net 224.0.0.0 -interface default
else
	# default multicast route
	route -n add -net 224.0.0.0 -interface $hostname
d140 29
@


1.46
log
@Add support in /etc/hostname.xxx for files of the format:
    up [options]
Any of the following may or may not be set:
    $name $mask $bcaddr $extras
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.45 1998/10/28 19:17:10 millert Exp $
d57 6
a62 1
# dhcp 
d74 3
d81 33
a113 17
# the only required contents of the file are the addr_family field
# and the hostname.

(
    for hn in /etc/hostname.*; do
	# Strip off /etc/hostname. prefix
	if=${hn#/etc/hostname.}

	# Interface names must be alphanumeric only.  We check to avoid
	# configuring backup or temp files, and to catch the "*" case.
	if ! isalphanumeric "$if"; then
	    continue
	fi

	# Now parse the hostname.* file
        (
            read af name mask bcaddr extras
d115 4
d120 5
a124 20
	    # $af can be either "up", "dhcp", or an address family.
	    if [ "$af" = "up" ]; then
		# The only one of these guaranteed to be set is $if
		ifconfig $if $name $mask $bcaddr $extras up
	    elif [ "$af" = "dhcp" ]; then
		ifconfig $if $extras down
		cmd="/sbin/dhclient $if";
	    else
		if [ ! -n "$name" ]; then
		    echo "/etc/hostname.$if: invalid network configuration file"
		    exit
		fi

		cmd="ifconfig $if $af $name "
		if [ "${dt}" = "dest" ]; then cmd="$cmd $dtaddr"; fi
		if [ -n "$mask" ]; then cmd="$cmd netmask $mask"; fi
		if [ -n "$bcaddr" -a "X$bcaddr" != "XNONE" ]; then
		    cmd="$cmd broadcast $bcaddr";
		fi
		cmd="$cmd $extras";
d126 7
a132 5

	    $cmd
        ) < /etc/hostname.$if
    done
)
@


1.45
log
@Kill the awful hack used to match and split /etc/hostname.* We now use
a function, isalphanumeric, to determine whether an interface name is
likely to be valid.  This means that things like /etc/hostname.le0.bak,
/etc/hostname.le0#, /etc/hostname.le0~, etc. will be ignored as they
should.  There is no longer an implicate assumption that /etc/hostname.*
only contains a single '.'.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.44 1998/10/06 23:25:21 deraadt Exp $
d92 5
a96 2
	    # check to see if device should be configure by dhcp
	    if [ "$af" = "dhcp" ]; then
@


1.44
log
@move ipnat to end of netstart, to support dhcp+ipnat
@
text
@d3 15
a17 1
#	$OpenBSD: netstart,v 1.43 1998/09/18 18:42:10 deraadt Exp $
d77 9
a85 5
    tmp="$IFS"
    IFS="$IFS."
    set -- `echo /etc/hostname*`
    IFS=$tmp
    unset tmp
d87 1
a87 2
    while [ $# -ge 2 ] ; do
        shift            # get rid of "hostname"
d94 2
a95 2
		ifconfig $1 $extras down
		cmd="/sbin/dhclient $1";
d98 1
a98 1
		    echo "/etc/hostname.$1: invalid network configuration file"
d102 1
a102 1
		cmd="ifconfig $1 $af $name "
d112 1
a112 2
        ) < /etc/hostname.$1
        shift
a134 1

@


1.43
log
@apply media directives on dhcp interfaces
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.42 1998/09/10 16:01:32 marc Exp $
a16 1
#
a23 9
# Configure NAT before configuring network interfaces
#
if [ "${ipnat}" = "YES" -a "${ipfilter}" = "YES" -a -f "${ipnat_rules}" ]; then
	echo 'configuring NAT'
	ipnat -CF -f ${ipnat_rules}
else
	ipnat=NO
fi

d111 9
@


1.42
log
@better way of handling dhcp client; Jason Ish <jbi130@@mail.usask.ca>
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.41 1998/09/08 20:26:41 marc Exp $
d87 1
@


1.41
log
@dhcp client stuff. "Angelos D. Keromytis" <angelos@@dsl.cis.upenn.edu>
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.40 1998/08/24 09:32:50 downsj Exp $
a40 4
if [ "X${dhcp_client}" != X"NO" ]; then
# Do DHCP discovery
      dhclient ${dhcp_client}
else
d51 4
d65 4
d72 1
a72 1
    (
d85 16
a100 10
            if [ ! -n "$name" ]; then
                echo "/etc/hostname.$1: invalid network configuration file"
                exit
            fi

	    cmd="ifconfig $1 $af $name "
	    if [ "${dt}" = "dest" ]; then cmd="$cmd $dtaddr"; fi
	    if [ -n "$mask" ]; then cmd="$cmd netmask $mask"; fi
	    if [ -n "$bcaddr" -a "X$bcaddr" != "XNONE" ]; then
		cmd="$cmd broadcast $bcaddr";
a101 1
	    cmd="$cmd $extras"
d107 1
a107 1
    )
d111 1
a111 1
    if [ -f /etc/mygate ]; then
d116 1
a116 1
    else
a118 1
    fi
@


1.40
log
@You can't use -interface default when there's no default gateway
set (yet).  Use -interface $hostname if mygate doesn't exist so that
this actually works on routers.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.39 1998/07/04 13:55:51 deraadt Exp $
d41 4
d68 1
a68 1
(
d98 1
a98 1
)
d102 1
a102 1
if [ -f /etc/mygate ]; then
d107 1
a107 1
else
d110 1
@


1.39
log
@put 224 route on default, to avoid a hostname lookup
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.38 1998/05/22 04:25:50 deraadt Exp $
d100 6
a106 3

# default multicast route
route -n add -net 224.0.0.0 -interface default
@


1.38
log
@use route -n, what the heck
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.37 1998/03/28 00:11:00 deraadt Exp $
d103 1
a103 1
route -n add -net 224.0.0.0 -interface $hostname
@


1.37
log
@s/^nat/ipnat/
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.36 1998/02/23 20:47:35 niklas Exp $
d38 2
a39 2
route add -host $hostname localhost
route add -net 127 127.0.0.1 -reject
d99 1
a99 1
	route add -host default `cat /etc/mygate`
d103 1
a103 1
route add -net 224.0.0.0 -interface $hostname
@


1.36
log
@remove trailing blank line
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.35 1998/02/07 20:51:50 deraadt Exp $
d27 1
a27 1
if [ "${nat}" = "YES" -a "${ipfilter}" = "YES" -a -f "${nat_rules}" ]; then
d29 1
a29 1
	ipnat -CF -f ${nat_rules}
d31 1
a31 1
	nat=NO
@


1.35
log
@ipforward is in sysctl.conf now
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.34 1997/12/21 01:17:21 deraadt Exp $
a103 1

@


1.34
log
@ugh
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.33 1997/12/20 23:19:30 deraadt Exp $
a31 4
fi

if [ X"${ipforward}" = X"YES" ]; then
	sysctl -w net.inet.ip.forwarding=1
@


1.33
log
@ipforwarding option in rc.conf
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.32 1997/11/29 02:03:43 kstailey Exp $
d34 1
a34 1
if [ X"${iproute}" = X"YES" ]; then
@


1.32
log
@NAT requires IPF
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.31 1997/11/04 09:15:31 deraadt Exp $
d32 4
@


1.31
log
@kill spaces at ends of lines; m4
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.30 1997/10/14 20:34:55 deraadt Exp $
d27 1
a27 1
if [ X"${nat}" = X"YES" -a -f "${nat_rules}" ]; then
@


1.30
log
@set hostname/domainname before running rc.conf; m4@@umn.edu
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.29 1997/09/04 01:12:23 deraadt Exp $
d75 1
a75 1
            read dt dtaddr 
@


1.29
log
@fork netstart; new child is rc.conf
@
text
@d3 1
a3 4
#	$OpenBSD: netstart,v 1.28 1997/08/25 20:50:37 millert Exp $

# pick up option configuration
. /etc/rc.conf
d12 3
@


1.28
log
@Explicately pass -host flag to route(8) to avoid confusion with networks.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.27 1997/08/19 21:55:15 niklas Exp $
d5 2
a6 38
# set these to "NO" to turn them off.  otherwise, they're used as flags
routed_flags=NO		# for 'normal' use: routed_flags=-q
mrouted_flags=NO	# for 'normal' use: mrouted_flags=""
rarpd_flags=NO		# for 'normal' use: rarpd_flags="-a"
bootparamd_flags=NO	# for 'normal' use: bootparamd_flags=""
rbootd_flags=NO		# for 'normal' use: rbootd_flags=""
sendmail_flags=NO	# for 'normal' use: sendmail_flags="-bd -q30m"
named_flags=NO		# for 'normal' use: named_flags=""
timed_flags=NO		# for 'normal' use: timed_flags=""
photurisd_flags=""      # for 'normal' use: photurisd_flags=""

# set the following to "YES" to turn them on
rwhod=NO
nfs_server=NO
nfs_client=NO
lockd=NO
gated=NO
kerberos_server=NO
amd=NO
ipfilter=NO
nat=NO
portmap=YES			# almost always needed
inetd=YES			# almost always needed
lpd=NO				# printing daemons
check_quotas=YES		# NO may be desireable in some YP environments

# miscellaneous other flags
# only used if the appropriate server is marked YES above
gated_flags=
ypserv_flags=			# E.g. -1 for YP v1, -d for DNS etc
yppasswdd_flags=		# "-d /etc/yp" if passwd files is in /etc/yp
nfsd_flags="-tun 4"		# Crank the 4 for a busy fileserver
amd_dir=/tmp_mnt		# AMD's mount directory
amd_master=/etc/amd/master	# AMD 'master' map
ipfilter_rules=/etc/ipf.rules	# Rules for IP packet filtering
nat_rules=/etc/nat.rules	# Rules for Network Address Translation
ipmon_flags=-s			# To disable logging, use ipmon_flags=NO
rfc1323=YES			# TCP RFC1323 extensions (disable if tcp is slow)
@


1.27
log
@Add hook for rpc.lockd, make nfsd flags settable in netstart
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.26 1997/07/31 02:23:46 downsj Exp $
d74 1
a74 1
route add $hostname localhost
d135 1
a135 1
	route add default `cat /etc/mygate`
@


1.26
log
@Make quotas optional; wedged into netstart for the time being.
/etc/rc.conf, anyone?
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.25 1997/07/30 21:35:15 deraadt Exp $
d20 1
d36 1
@


1.25
log
@do not run routed by default
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.24 1997/07/28 19:31:47 kstailey Exp $
d28 1
@


1.24
log
@Move configuration of loopback interface to before all other interfaces.
Allows the use of local caching-only nameserver with no "nameserver"
entry in /etc/resolv.conf to configure a route between the hostname
and loopback.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.23 1997/07/25 00:06:03 provos Exp $
d6 1
a6 1
routed_flags=-q
@


1.23
log
@earlier start of keymanagement
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.22 1997/07/24 22:11:59 deraadt Exp $
d67 2
d70 5
a74 1
# configure all of the interfaces which we know about.
a128 3
# set the address for the loopback interface
ifconfig lo0 inet localhost

a133 4

# use loopback, not the wire
route add $hostname localhost
route add -net 127 127.0.0.1 -reject
@


1.22
log
@make amd use /tmp_mnt by default
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.21 1997/07/22 10:02:47 provos Exp $
d14 1
a14 1
photurisd_flags="-f"    # for 'normal' use: photurisd_flags="-f"
@


1.21
log
@start the photuris daemon per default. hilfe.
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.20 1997/06/17 13:13:48 niklas Exp $
d34 1
a34 1
amd_dir=/amd			# AMD's mount directory
@


1.20
log
@Put in hooks to start ypserv with flags
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.19 1997/06/17 10:20:06 niklas Exp $
d14 1
@


1.19
log
@Put in hooks to start rpc.yppasswdd with flags
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.18 1997/04/15 09:42:33 deraadt Exp $
d31 1
@


1.18
log
@kill route flush until .. hmm kernel routing socket bug or something
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.17 1997/04/09 03:00:05 kstailey Exp $
d31 1
@


1.17
log
@add NAT startup
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.16 1997/04/07 22:18:05 rees Exp $
a44 2

route flush
@


1.16
log
@flush all old routes before adding new interfaces or routes.
ref: netbsd pr3228/misc, Matthias Scheler
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.15 1997/03/03 01:13:11 downsj Exp $
d23 1
d34 1
d56 10
@


1.15
log
@fix typo
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.14 1997/02/11 18:46:08 deraadt Exp $
d43 2
@


1.14
log
@add default route before fiddling with loopback route to avoid DNS problems; m4@@umn.edu, #97
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.13 1997/02/03 12:04:44 deraadt Exp $
d13 1
a13 1
timed_flags=NO		# for 'normal' use: timed_flags=
@


1.13
log
@do ifaliases after /usr/bin exists in nfs diskless env; pr#77, matthieu@@laas.fr
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.12 1996/11/02 00:52:02 deraadt Exp $
d111 6
a123 5
# /etc/mygate, if it exists, contains the name of my gateway host
# that name must be in /etc/hosts.
if [ -f /etc/mygate ]; then
	route add default `cat /etc/mygate`
fi
@


1.12
log
@timed off by default
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.11 1996/09/23 13:06:37 deraadt Exp $
a121 17
fi

# /etc/ifaliases, if it exists, contains the names of additional IP
# addresses for each interface. It is formatted as a series of lines
# that contain
#	interface address netmask
if [ -f /etc/ifaliases ]; then
(
	# delete comments and blank lines
	set -- `sed -e 's/#.*$//' /etc/ifaliases | grep -v '^$'`

	while [ $# -ge 3 ] ; do
		ifconfig $1 inet alias $2 netmask $3
		route add $2 localhost
		shift 3
	done
)
@


1.11
log
@rfc1323 variable
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.10 1996/09/04 10:25:55 deraadt Exp $
d13 1
a13 1
timed_flags=
@


1.10
log
@control portmap, inetd, and lpd from netstart; idea from tqbf@@enteract.com
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.9 1996/08/27 11:46:20 deraadt Exp $
d34 1
@


1.9
log
@224.0.0.0 not 0.0.0.224; from peter@@demon.net
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.8 1996/06/18 15:30:02 deraadt Exp $
d23 3
@


1.8
log
@move std stuff from rc.local to rc
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.7 1996/06/16 12:57:31 deraadt Exp $
d112 1
a112 1
route add -net 224 -interface $hostname
@


1.7
log
@install sample commented /etc/ifaliases file; which can now contain #
comments and blank lines. new format is "interface address netmask"
(yes, i changed the order of the entries). inspired by netbsd pr#2474;
gillhaa@@ghost.whirlpool.com
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.6 1996/06/02 21:17:58 tholo Exp $
d109 1
a109 1
route add -net 127 127.1 -reject
@


1.6
log
@Install a multicast route by default
@
text
@d3 1
a3 1
#	$OpenBSD: netstart,v 1.5 1996/05/26 10:25:24 deraadt Exp $
d123 1
a123 1
# address interface
d126 2
a127 1
	set -- `cat /etc/ifaliases`
d129 4
a132 4
	while [ $# -ge 2 ] ; do
		ifconfig $2 inet alias $1
		route add $1 localhost
		shift 2
@


1.5
log
@sync & label
@
text
@d3 1
a3 1
#	$OpenBSD$
d109 4
@


1.4
log
@added IP filter to netstat/rc and put examples in /usr/share/ipf
@
text
@d3 1
a3 2
#	$NetBSD: netstart,v 1.23 1995/12/30 01:30:03 thorpej Exp $
#	@@(#)netstart	5.9 (Berkeley) 3/30/91
@


1.3
log
@from netbsd: start mrouted like routed
@
text
@d23 1
d30 2
d39 9
@


1.2
log
@/etc/ifaliases support by randy@@zyzzyva.com
@
text
@d3 1
a3 1
#	$NetBSD: netstart,v 1.22 1995/12/17 18:31:09 perry Exp $
d8 1
@


1.1
log
@Initial revision
@
text
@d3 1
a3 1
#	$NetBSD: netstart,v 1.21 1995/10/08 18:11:40 thorpej Exp $
d102 16
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
