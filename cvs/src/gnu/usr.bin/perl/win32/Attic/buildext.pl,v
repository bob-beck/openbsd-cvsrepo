head	1.2;
access;
symbols
	OPENBSD_4_6:1.1.1.4.0.6
	OPENBSD_4_6_BASE:1.1.1.4
	OPENBSD_4_5:1.1.1.4.0.2
	OPENBSD_4_5_BASE:1.1.1.4
	PERL_5_10_0:1.1.1.4
	OPENBSD_4_4:1.1.1.3.0.10
	OPENBSD_4_4_BASE:1.1.1.3
	OPENBSD_4_3:1.1.1.3.0.8
	OPENBSD_4_3_BASE:1.1.1.3
	OPENBSD_4_2:1.1.1.3.0.6
	OPENBSD_4_2_BASE:1.1.1.3
	OPENBSD_4_1:1.1.1.3.0.4
	OPENBSD_4_1_BASE:1.1.1.3
	OPENBSD_4_0:1.1.1.3.0.2
	OPENBSD_4_0_BASE:1.1.1.3
	PERL_5_8_8:1.1.1.3
	OPENBSD_3_9:1.1.1.2.0.6
	OPENBSD_3_9_BASE:1.1.1.2
	OPENBSD_3_8:1.1.1.2.0.4
	OPENBSD_3_8_BASE:1.1.1.2
	OPENBSD_3_7:1.1.1.2.0.2
	OPENBSD_3_7_BASE:1.1.1.2
	PERL_5_8_6:1.1.1.2
	OPENBSD_3_6:1.1.1.1.0.8
	OPENBSD_3_6_BASE:1.1.1.1
	PERL_5_8_5:1.1.1.1
	PERL_5_8_3:1.1.1.1
	OPENBSD_3_5:1.1.1.1.0.6
	OPENBSD_3_5_BASE:1.1.1.1
	PERL_5_8_2:1.1.1.1
	OPENBSD_3_4:1.1.1.1.0.4
	OPENBSD_3_4_BASE:1.1.1.1
	OPENBSD_3_3:1.1.1.1.0.2
	OPENBSD_3_3_BASE:1.1.1.1
	PERL_5_8_0:1.1.1.1
	CPAN:1.1.1;
locks; strict;
comment	@# @;
expand	@o@;


1.2
date	2009.10.12.18.30.28;	author millert;	state dead;
branches;
next	1.1;

1.1
date	2002.10.27.22.15.12;	author millert;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2002.10.27.22.15.12;	author millert;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2005.01.15.21.18.25;	author millert;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2006.03.28.18.49.55;	author millert;	state Exp;
branches;
next	1.1.1.4;

1.1.1.4
date	2008.09.29.17.19.04;	author millert;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Merge in perl 5.10.1; part two
@
text
@=head1 NAME

buildext.pl - build extensions

=head1 SYNOPSIS

    buildext.pl make [-make_opts] dep directory [target] !ext1 !ext2

E.g.

    buildext.pl nmake -nologo perldll.def ..\ext

    buildext.pl nmake -nologo perldll.def ..\ext clean

    buildext.pl dmake perldll.def ..\ext

    buildext.pl dmake perldll.def ..\ext clean

Will skip building extensions which are marked with an '!' char.
Mostly because they still not ported to specified platform.

=cut

use File::Basename;
use Cwd;
use FindExt;

# @@ARGV with '!' at first position are exclusions
my %excl = map {$_=>1} map {/^!(.*)$/} @@ARGV;
@@ARGV = grep {!/^!/} @@ARGV;

my $here = getcwd();
my $perl = $^X;
$here =~ s,/,\\,g;
if ($perl =~ m#^\.\.#)
 {
  $perl = "$here\\$perl";
 }
(my $topdir = $perl) =~ s/\\[^\\]+$//;
# miniperl needs to find perlglob and pl2bat
$ENV{PATH} = "$topdir;$topdir\\win32\\bin;$ENV{PATH}";
#print "PATH=$ENV{PATH}\n";
my $pl2bat = "$topdir\\win32\\bin\\pl2bat";
unless (-f "$pl2bat.bat") {
    my @@args = ($perl, ("$pl2bat.pl") x 2);
    print "@@args\n";
    system(@@args) unless defined $::Cross::platform;
}
my $make = shift;
$make .= " ".shift while $ARGV[0]=~/^-/;
my $dep  = shift;
my $dmod = -M $dep;
my $dir  = shift;
chdir($dir) || die "Cannot cd to $dir\n";
my $targ  = shift;
(my $ext = getcwd()) =~ s,/,\\,g;
my $code;
FindExt::scan_ext($ext);

my @@ext = FindExt::extensions();

foreach my $dir (sort @@ext)
 {
  if (exists $excl{$dir}) {
    warn "Skipping extension $ext\\$dir, not ported to current platform";
    next;
  }
  if (chdir("$ext\\$dir"))
   {
    my $mmod = -M 'Makefile';
    if (!(-f 'Makefile') || $mmod > $dmod)
     {
      print "\nRunning Makefile.PL in $dir\n";
      my @@perl = ($perl, "-I$here\\..\\lib", 'Makefile.PL',
                  'INSTALLDIRS=perl', 'PERL_CORE=1');
      if (defined $::Cross::platform) {
	@@perl = (@@perl[0,1],"-MCross=$::Cross::platform",@@perl[2..$#perl]);
      }
      print join(' ', @@perl), "\n";
      $code = system(@@perl);
      warn "$code from $dir's Makefile.PL" if $code;
      $mmod = -M 'Makefile';
      if ($mmod > $dmod)
       {
        warn "Makefile $mmod > $dmod ($dep)\n";
       }
     }  
    if ($targ)
     {
      print "Making $targ in $dir\n$make $targ\n";
      $code = system("$make $targ");
      die "Unsuccessful make($dir): code=$code" if $code!=0;
     }
    else
     {
      print "Making $dir\n$make\n";
      $code = system($make);
      die "Unsuccessful make($dir): code=$code" if $code!=0;
     }
    chdir($here) || die "Cannot cd to $here:$!";
   }
  else
   {
    warn "Cannot cd to $ext\\$dir:$!";
   }
 }

@


1.1
log
@Initial revision
@
text
@@


1.1.1.1
log
@stock perl 5.8.0 from CPAN
@
text
@@


1.1.1.2
log
@perl 5.8.6 from CPAN
@
text
@d7 1
a7 1
    buildext.pl make [-make_opts] dep directory [target] [--static|--dynamic] !ext1 !ext2
a21 8
If '--static' specified, only static extensions will be built.
If '--dynamic' specified, only dynamic extensions will be built.

--create-perllibst-h
    creates perllibst.h file for inclusion from perllib.c
--list-static-libs:
    prints libraries for static linking and exits

a26 1
use Config;
a31 33
# --static/--dynamic
my %opts = map {$_=>1} map {/^--([\w\-]+)$/} @@ARGV;
@@ARGV = grep {!/^--([\w\-]+)$/} @@ARGV;
my ($static,$dynamic) = ((exists $opts{static}?1:0),(exists $opts{dynamic}?1:0));
if ("$static,$dynamic" eq "0,0") {
  ($static,$dynamic) = (1,1);
}
if ($opts{'list-static-libs'} || $opts{'create-perllibst-h'}) {
  my @@statics = grep{!/^DynaLoader$/} split /\s+/, $Config{static_ext};
  if ($opts{'create-perllibst-h'}) {
    # at moment of creation of perllibst.h no luck consulting Config.pm,
    # so list of static extensions passed with @@ARGV
    @@statics = grep{!/^DynaLoader$/} @@ARGV;
    open my $fh, ">perllibst.h";
    my @@statics1 = map {local $_=$_;s/\//__/g;$_} @@statics;
    my @@statics2 = map {local $_=$_;s/\//::/g;$_} @@statics;
    print $fh "/*DO NOT EDIT\n  this file is included from perllib.c to init static extensions */\n";
    print $fh "#ifdef STATIC1\n",(map {"    \"$_\",\n"} @@statics),"#undef STATIC1\n#endif\n";
    print $fh "#ifdef STATIC2\n",(map {"    EXTERN_C void boot_$_ (pTHX_ CV* cv);\n"} @@statics1),"#undef STATIC2\n#endif\n";
    print $fh "#ifdef STATIC3\n",(map {"    newXS(\"$statics2[$_]::bootstrap\", boot_$statics1[$_], file);\n"} 0 .. $#statics),"#undef STATIC3\n#endif\n";
  }
  else {
    my %extralibs;
    for (@@statics) {
      open my $fh, "<..\\lib\\auto\\$_\\extralibs.ld" or die "can't open <..\\lib\\auto\\$_\\extralibs.ld: $!";
      $extralibs{$_}++ for grep {/\S/} split /\s+/, join '', <$fh>;
    }
    print map {/([^\/]+)$/;"..\\lib\\auto\\$_/$1.lib "} @@statics;
    print map {"$_ "} sort keys %extralibs;
  }
  exit;
}

a60 4
my %static_exts = map {$_=>1} split /\s+/, $Config{static_ext};

if ("$static$dynamic" eq "01") {@@ext = grep {!exists $static_exts{$_}} @@ext}
elsif ("$static$dynamic" eq "10") {@@ext = grep {exists $static_exts{$_}} @@ext}
d62 1
a62 1
foreach $dir (sort @@ext)
d75 1
a75 3
                  'INSTALLDIRS=perl', 'PERL_CORE=1',
		  ($static_exts{$dir}?('LINKTYPE=static'):()), # if ext is static
		);
d81 1
a81 1
      warn "$code from $dir\'s Makefile.PL" if $code;
@


1.1.1.3
log
@perl 5.8.8 import
@
text
@d32 1
d49 1
a49 1
  my @@statics = split /\s+/, $Config{static_ext};
d51 3
d68 1
a68 1
    print map {s|/|\\|g;m|([^\\]+)$|;"..\\lib\\auto\\$_\\$1$Config{_a} "} @@statics;
a100 1
FindExt::set_static_extensions(split ' ', $Config{static_ext}) if $ext ne "ext";
d102 5
a106 3
my @@ext;
push @@ext, FindExt::static_ext() if $static;
push @@ext, FindExt::dynamic_ext(), FindExt::nonxs_ext() if $dynamic;
d122 1
a122 2
		  (FindExt::is_static($dir)
                   ? ('LINKTYPE=static') : ()), # if ext is static
@


1.1.1.4
log
@import perl 5.10.0 from CPAN
@
text
@d7 1
a7 1
    buildext.pl make [-make_opts] dep directory [target] [--static|--dynamic] +ext2 !ext1
a21 4
If any extensions are listed with a '+' char then only those
extensions will be built, but only if they arent countermanded
by an '!ext' and are appropriate to the type of building being done.

a38 3
# @@ARGV with '+' at first position are inclusions
my %incl = map {$_=>1} map {/^\+(.*)$/} @@ARGV;
@@ARGV = grep {!/^\+/} @@ARGV;
d50 1
a50 2
    open my $fh, ">perllibst.h"
        or die "Failed to write to perllibst.h:$!";
d57 2
a58 2
    close $fh;
  } else {
d67 1
a67 1
  exit(0);
d70 1
a70 1
(my $here = getcwd()) =~ s{/}{\\}g;
d72 5
a76 3
if ($perl =~ m#^\.\.#) {
    $perl = "$here\\$perl";
}
d80 1
d94 1
a94 1
(my $ext = getcwd()) =~ s{/}{\\}g;
a102 1

a104 4
  if (%incl and !exists $incl{$dir}) {
    #warn "Skipping extension $ext\\$dir, not in inclusion list\n";
    next;
  }
@


