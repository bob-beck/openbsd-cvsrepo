head	1.25;
access;
symbols
	OPENBSD_5_4:1.23.0.12
	OPENBSD_5_4_BASE:1.23
	OPENBSD_5_3:1.23.0.10
	OPENBSD_5_3_BASE:1.23
	OPENBSD_5_2:1.23.0.8
	OPENBSD_5_2_BASE:1.23
	OPENBSD_5_1_BASE:1.23
	OPENBSD_5_1:1.23.0.6
	OPENBSD_5_0:1.23.0.4
	OPENBSD_5_0_BASE:1.23
	OPENBSD_4_9:1.23.0.2
	OPENBSD_4_9_BASE:1.23
	OPENBSD_4_8:1.22.0.4
	OPENBSD_4_8_BASE:1.22
	OPENBSD_4_7:1.22.0.2
	OPENBSD_4_7_BASE:1.22
	OPENBSD_4_6:1.21.0.12
	OPENBSD_4_6_BASE:1.21
	OPENBSD_4_5:1.21.0.8
	OPENBSD_4_5_BASE:1.21
	OPENBSD_4_4:1.21.0.6
	OPENBSD_4_4_BASE:1.21
	OPENBSD_4_3:1.21.0.4
	OPENBSD_4_3_BASE:1.21
	OPENBSD_4_2:1.21.0.2
	OPENBSD_4_2_BASE:1.21
	OPENBSD_4_1:1.20.0.2
	OPENBSD_4_1_BASE:1.20
	OPENBSD_4_0:1.19.0.6
	OPENBSD_4_0_BASE:1.19
	OPENBSD_3_9:1.19.0.4
	OPENBSD_3_9_BASE:1.19
	OPENBSD_3_8:1.19.0.2
	OPENBSD_3_8_BASE:1.19
	OPENBSD_3_7:1.18.0.2
	OPENBSD_3_7_BASE:1.18
	OPENBSD_3_6:1.15.0.2
	OPENBSD_3_6_BASE:1.15
	OPENBSD_3_5:1.14.0.4
	OPENBSD_3_5_BASE:1.14
	OPENBSD_3_4:1.14.0.2
	OPENBSD_3_4_BASE:1.14
	OPENBSD_3_3:1.12.0.4
	OPENBSD_3_3_BASE:1.12
	OPENBSD_3_2:1.12.0.2
	OPENBSD_3_2_BASE:1.12
	OPENBSD_3_1:1.10.0.4
	OPENBSD_3_1_BASE:1.10
	OPENBSD_3_0:1.10.0.2
	OPENBSD_3_0_BASE:1.10
	OPENBSD_2_9:1.9.0.4
	OPENBSD_2_9_BASE:1.9
	OPENBSD_2_8:1.9.0.2
	OPENBSD_2_8_BASE:1.9
	OPENBSD_2_7:1.8.0.4
	OPENBSD_2_7_BASE:1.8
	OPENBSD_2_6:1.8.0.2
	OPENBSD_2_6_BASE:1.8
	OPENBSD_2_5:1.6.0.2
	OPENBSD_2_5_BASE:1.6
	OPENBSD_2_4:1.5.0.2
	OPENBSD_2_4_BASE:1.5
	OPENBSD_2_3:1.2.0.8
	OPENBSD_2_3_BASE:1.2
	OPENBSD_2_2:1.2.0.6
	OPENBSD_2_2_BASE:1.2
	OPENBSD_2_1:1.2.0.4
	OPENBSD_2_1_BASE:1.2
	OPENBSD_2_0:1.2.0.2
	OPENBSD_2_0_BASE:1.2
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@.\" @;


1.25
date	2013.10.07.01.50.26;	author guenther;	state dead;
branches;
next	1.24;

1.24
date	2013.08.14.06.32.28;	author jmc;	state Exp;
branches;
next	1.23;

1.23
date	2010.10.27.19.07.27;	author deraadt;	state Exp;
branches;
next	1.22;

1.22
date	2009.07.09.10.14.41;	author eric;	state Exp;
branches;
next	1.21;

1.21
date	2007.05.31.19.19.32;	author jmc;	state Exp;
branches;
next	1.20;

1.20
date	2007.02.09.14.41.54;	author otto;	state Exp;
branches;
next	1.19;

1.19
date	2005.06.18.18.09.42;	author millert;	state Exp;
branches;
next	1.18;

1.18
date	2005.02.23.20.24.57;	author robert;	state Exp;
branches;
next	1.17;

1.17
date	2004.10.03.00.11.26;	author jmc;	state Exp;
branches;
next	1.16;

1.16
date	2004.10.02.18.31.25;	author matthieu;	state Exp;
branches;
next	1.15;

1.15
date	2004.07.14.16.52.00;	author jfb;	state Exp;
branches;
next	1.14;

1.14
date	2003.07.04.22.07.45;	author millert;	state Exp;
branches;
next	1.13;

1.13
date	2003.06.02.20.18.39;	author millert;	state Exp;
branches;
next	1.12;

1.12
date	2002.08.09.09.29.50;	author pjanzen;	state Exp;
branches;
next	1.11;

1.11
date	2002.08.06.18.45.03;	author aaron;	state Exp;
branches;
next	1.10;

1.10
date	2001.07.31.05.45.33;	author art;	state Exp;
branches;
next	1.9;

1.9
date	2000.10.18.05.12.09;	author aaron;	state Exp;
branches;
next	1.8;

1.8
date	99.06.29.14.09.55;	author aaron;	state Exp;
branches;
next	1.7;

1.7
date	99.05.16.19.55.25;	author alex;	state Exp;
branches;
next	1.6;

1.6
date	99.02.27.21.56.17;	author deraadt;	state Exp;
branches;
next	1.5;

1.5
date	98.07.06.18.27.23;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	98.06.23.05.45.58;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	98.06.15.17.55.17;	author mickey;	state Exp;
branches;
next	1.2;

1.2
date	95.12.14.02.21.10;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.42.25;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.42.25;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.25
log
@getdirentries(2) is dead; long live getdents(2)!

confirmation that getdirentries(2) is unused by ports from sthen@@ and naddy@@
@
text
@.\"	$OpenBSD: getdirentries.2,v 1.24 2013/08/14 06:32:28 jmc Exp $
.\"	$NetBSD: getdirentries.2,v 1.7 1995/10/12 15:40:50 jtc Exp $
.\"
.\" Copyright (c) 1989, 1991, 1993
.\"	The Regents of the University of California.  All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\" 3. Neither the name of the University nor the names of its contributors
.\"    may be used to endorse or promote products derived from this software
.\"    without specific prior written permission.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
.\" ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
.\" ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
.\" FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\" DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
.\" OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
.\" LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
.\" OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
.\" SUCH DAMAGE.
.\"
.\"	@@(#)getdirentries.2	8.1 (Berkeley) 6/9/93
.\"
.Dd $Mdocdate: August 14 2013 $
.Dt GETDIRENTRIES 2
.Os
.Sh NAME
.Nm getdirentries
.Nd get directory entries in a filesystem independent format
.Sh SYNOPSIS
.Fd #include <dirent.h>
.Ft int
.Fn getdirentries "int fd" "char *buf" "int nbytes" "off_t *basep"
.Sh DESCRIPTION
.Fn getdirentries
reads directory entries from the directory
referenced by the file descriptor
.Fa fd
into the buffer pointed to by
.Fa buf ,
in a filesystem independent format.
Up to
.Fa nbytes
of data will be transferred.
.Fa nbytes
must be greater than or equal to the
block size associated with the file (see
.Xr stat 2 ) .
Some filesystems may not support
.Fn getdirentries
with buffers smaller than this size.
.Pp
The data in the buffer is a series of
.Em dirent
structures each containing the following entries:
.Bd -literal -offset indent
u_int32_t	d_fileno;
u_int16_t	d_reclen;
u_int8_t	d_type;
u_int8_t	d_namlen;
char    	d_name[MAXNAMLEN + 1]; /* see below */
.Ed
.Pp
The
.Fa d_fileno
entry is a number which is unique for each distinct file in the filesystem.
Files that are linked by hard links (see
.Xr link 2 )
have the same
.Fa d_fileno .
The
.Fa d_reclen
entry is the length, in bytes, of the directory record.
.Pp
The
.Fa d_type
is the type of file, where the following are possible types:
.Dv DT_UNKNOWN ,
.Dv DT_FIFO ,
.Dv DT_CHR ,
.Dv DT_DIR ,
.Dv DT_BLK ,
.Dv DT_REG ,
.Dv DT_LNK ,
and
.Dv DT_SOCK .
.Pp
The
.Fa d_namlen
entry specifies the length of the file name excluding the NUL byte.
Thus the actual size of
.Fa d_name
may vary from 1 to
.Dv MAXNAMLEN
\&+ 1.
.Pp
The
.Fa d_name
entry contains a NUL-terminated file name.
.Pp
Entries may be separated by extra space.
The
.Fa d_reclen
entry may be used as an offset from the start of a
.Fa dirent
structure to the next structure, if any.
.Pp
Invalid entries with
.Fa d_fileno
set to 0 may be returned among regular entries.
.Pp
The actual number of bytes transferred is returned.
The current position pointer associated with
.Fa fd
is set to point to the next block of entries.
The pointer may not advance by the number of bytes returned by
.Fn getdirentries .
.Pp
.Fn getdirentries
writes the position of the block read into the location pointed to by
.Fa basep .
Alternatively, the current position pointer may be set and retrieved by
.Xr lseek 2 .
The current position pointer should only be set to a value returned by
.Xr lseek 2 ,
a value returned in the location pointed to by
.Fa basep ,
or zero.
.Sh RETURN VALUES
If successful, the number of bytes actually transferred is returned.
A value of zero is returned when
the end of the directory has been reached.
Otherwise, \-1 is returned and the global variable
.Va errno
is set to indicate the error.
.Sh ERRORS
.Fn getdirentries
will fail if:
.Bl -tag -width Er
.It Bq Er EBADF
.Fa fd
is not a valid file descriptor open for reading.
.It Bq Er EFAULT
Either
.Fa buf
or
.Fa basep
points outside the allocated address space.
.It Bq Er EINVAL
The file referenced by
.Fa fd
is not a directory, or
.Fa nbytes
is too small for returning a directory entry or block of entries,
or the current position pointer is invalid.
.It Bq Er EIO
An
.Tn I/O
error occurred while reading from or writing to the file system.
.El
.Sh SEE ALSO
.Xr lseek 2 ,
.Xr open 2 ,
.Xr opendir 3 ,
.Xr dirent 5
.Sh STANDARDS
The
.Fn getdirentries
call is not a portable interface and should not be used directly by
applications.
Use
.Xr readdir 3
instead.
.Sh HISTORY
The
.Fn getdirentries
function first appeared in
.Bx 4.4 .
@


1.24
log
@no longer any need to quote macro lines with >9 args;
From: Jan Stary
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.23 2010/10/27 19:07:27 deraadt Exp $
d33 1
a33 1
.Dd $Mdocdate: October 27 2010 $
@


1.23
log
@Remove the EXAMPLE, since *noone* should use this non-portable API
directly -- it exists for libc use only.  Tell people to use readdir(3).
discussed with millert
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.22 2009/07/09 10:14:41 eric Exp $
d33 1
a33 1
.Dd $Mdocdate: July 9 2009 $
d38 1
a38 1
.Nd "get directory entries in a filesystem independent format"
@


1.22
log
@promote correct style for error checking

ok tedu@@ deraadt@@ krw@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.21 2007/05/31 19:19:32 jmc Exp $
d33 1
a33 1
.Dd $Mdocdate: May 31 2007 $
d42 1
a42 1
.Fn getdirentries "int fd" "char *buf" "int nbytes" "long *basep"
a144 35
.Sh EXAMPLES
The following code may be used to iterate on all entries in a
directory:
.Bd -literal -offset indent
char *buf, *ebuf, *cp;
long base;
size_t bufsize;
int fd, nbytes;
char *path;
struct stat sb;
struct dirent *dp;

if ((fd = open(path, O_RDONLY)) == -1)
	err(2, "cannot open %s", path);
if (fstat(fd, &sb) == -1)
	err(2, "fstat");
bufsize = sb.st_size;
if (bufsize < sb.st_blksize)
	bufsize = sb.st_blksize;
if ((buf = malloc(bufsize)) == NULL)
	err(2,  "cannot malloc %lu bytes", (unsigned long)bufsize);
while ((nbytes = getdirentries(fd, buf, bufsize, &base)) > 0) {
	ebuf = buf + nbytes;
	cp = buf;
	while (cp < ebuf) {
		dp = (struct dirent *)cp;
		if (dp->d_fileno != 0)
			printf("%s\en", dp->d_name);
		cp += dp->d_reclen;
	}
}
if (nbytes == -1)
	err(2, "getdirentries");
free(buf);
.Ed
d175 8
@


1.21
log
@convert to new .Dd format;
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.20 2007/02/09 14:41:54 otto Exp $
d33 1
a33 1
.Dd $Mdocdate$
d157 1
a157 1
if ((fd = open(path, O_RDONLY)) < 0)
d159 1
a159 1
if (fstat(fd, &sb) < 0)
d176 1
a176 1
if (nbytes < 0)
@


1.20
log
@improve example by showing how to skip invalid entries; ok millert@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.19 2005/06/18 18:09:42 millert Exp $
d33 1
a33 1
.Dd June 9, 1993
@


1.19
log
@Remove remaining whiteout tentacles; OK deraadt@@ miod@@ weingart@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.18 2005/02/23 20:24:57 robert Exp $
d171 2
a172 1
		printf("%s\en", dp->d_name);
@


1.18
log
@use a string format argument instead of nothing in the example

ok otto@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.17 2004/10/03 00:11:26 jmc Exp $
a93 1
.Dv DT_SOCK ,
d95 1
a95 1
.Dv DT_WHT .
@


1.17
log
@put EXAMPLES in the correct place, and change a stop to a colon;
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.16 2004/10/02 18:31:25 matthieu Exp $
d172 1
a172 1
		printf("%\en", dp->d_name);
@


1.16
log
@- move the fact that it returns 0 on directory end in RETURN VALUES
- add an example
- add .Xr opendir
Ok millert@@, ok and some tweaks jaredy@@.
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.15 2004/07/14 16:52:00 jfb Exp $
a145 25
.Sh ERRORS
.Fn getdirentries
will fail if:
.Bl -tag -width Er
.It Bq Er EBADF
.Fa fd
is not a valid file descriptor open for reading.
.It Bq Er EFAULT
Either
.Fa buf
or
.Fa basep
points outside the allocated address space.
.It Bq Er EINVAL
The file referenced by
.Fa fd
is not a directory, or
.Fa nbytes
is too small for returning a directory entry or block of entries,
or the current position pointer is invalid.
.It Bq Er EIO
An
.Tn I/O
error occurred while reading from or writing to the file system.
.El
d148 1
a148 1
directory.
d180 25
@


1.15
log
@MAXNAMELEN -> MAXNAMLEN

ok jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.14 2003/07/04 22:07:45 millert Exp $
a127 2
A value of zero is returned when
the end of the directory has been reached.
d141 2
d171 34
d208 1
@


1.14
log
@Fix the types in struct dirent and document d_type (description
taken from NetBSD).
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.13 2003/06/02 20:18:39 millert Exp $
d70 1
a70 1
char    	d_name[MAXNAMELEN + 1]; /* see below */
d104 1
a104 1
.Dv MAXNAMELEN
@


1.13
log
@Remove the advertising clause in the UCB license which Berkeley
rescinded 22 July 1999.  Proofed by myself and Theo.
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.12 2002/08/09 09:29:50 pjanzen Exp $
d66 4
a69 3
unsigned long	d_fileno;
unsigned short	d_reclen;
unsigned short	d_namlen;
d83 1
d85 13
a97 2
.Fa d_name
entry contains a null-terminated file name.
d100 1
a100 1
entry specifies the length of the file name excluding the null byte.
d107 4
d173 2
a174 1
.Xr open 2
@


1.12
log
@grammar nits
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.11 2002/08/06 18:45:03 aaron Exp $
d15 1
a15 5
.\" 3. All advertising materials mentioning features or use of this software
.\"    must display the following acknowledgement:
.\"	This product includes software developed by the University of
.\"	California, Berkeley and its contributors.
.\" 4. Neither the name of the University nor the names of its contributors
@


1.11
log
@Comma splice introduced in last commit.
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.10 2001/07/31 05:45:33 art Exp $
d60 2
a61 3
block size associated with the file,
see
.Xr stat 2 .
d145 1
a145 1
point outside the allocated address space.
@


1.10
log
@Document that entries with d_fileno == 0 are invalid.
From Egil Möller <redhog@@mini.dhs.org>
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.9 2000/10/18 05:12:09 aaron Exp $
d108 1
a108 1
set to 0, may be returned among regular entries.
@


1.9
log
@Another round of man page cleanup, this time to remove more hard sentence
breaks and getting rid of short lines, making these files easier to work with.
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.8 1999/06/29 14:09:55 aaron Exp $
d105 4
@


1.8
log
@- change references to nil to null; tschroed@@acm.org
- remove trailing spaces from end of lines
- add some .Dv
- change -1 to \-1, so `-' is taken as a negative sign
- other misc formatting fixes
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.7 1999/05/16 19:55:25 alex Exp $
d79 1
a79 2
entry is a number which is unique for each
distinct file in the filesystem.
@


1.7
log
@Cleanup xrefs under SEE ALSO.  Specifically:

  - Sort xrefs by section, and then alphabetically.
  - Add missing commas between xref items.
  - Remove commas from the last xref entry.
  - Remove duplicate entries.
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.6 1999/02/27 21:56:17 deraadt Exp $
d90 1
a90 1
entry contains a null terminated file name.
d128 1
a128 1
Otherwise, -1 is returned and the global variable
@


1.6
log
@make function names the correct case
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.5 1998/07/06 18:27:23 deraadt Exp $
d157 2
a158 2
.Xr open 2 ,
.Xr lseek 2
@


1.5
log
@fix openbsd tag
@
text
@d1 1
a1 1
.\"	$OpenBSD: getdirentries.2,v 1.7 1995/10/12 15:40:50 jtc Exp $
d48 1
a48 1
.Fn Getdirentries
d58 1
a58 1
.Fa Nbytes
d116 1
a116 1
.Fn Getdirentries
d132 1
a132 1
.Fn Getdirentries
@


1.4
log
@doc EINVAL; bde
@
text
@d1 1
@


1.3
log
@use Bx macro for BSD versions
@
text
@d143 7
@


1.2
log
@from netbsd:
add & fix a bunch of system call pages
@
text
@d154 2
a155 1
function first appeared in 4.4BSD.
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
.\"	$NetBSD: getdirentries.2,v 1.6 1995/02/27 12:32:41 cgd Exp $
d43 1
a43 1
.Fd #include <sys/dirent.h>
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
