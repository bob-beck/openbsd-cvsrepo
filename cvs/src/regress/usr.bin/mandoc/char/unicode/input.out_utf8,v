head	1.5;
access;
symbols
	OPENBSD_6_1:1.5.0.6
	OPENBSD_6_1_BASE:1.5
	OPENBSD_6_0:1.5.0.4
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.2
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.1.0.6
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.4
	OPENBSD_5_7_BASE:1.1;
locks; strict;
comment	@# @;


1.5
date	2015.12.02.11.45.52;	author schwarze;	state Exp;
branches;
next	1.4;
commitid	JYR7ENgJBt87Dzmf;

1.4
date	2015.11.06.15.37.16;	author schwarze;	state Exp;
branches;
next	1.3;
commitid	aMqgX0X3PTECpS2u;

1.3
date	2015.10.13.23.30.42;	author schwarze;	state Exp;
branches;
next	1.2;
commitid	A4ygCil1Mn9VDkml;

1.2
date	2015.09.08.22.57.28;	author schwarze;	state Exp;
branches;
next	1.1;
commitid	sGR3KrRS7sfcRrYc;

1.1
date	2014.12.19.04.57.11;	author schwarze;	state Exp;
branches;
next	;
commitid	bjUOzumNjzY2mijc;


desc
@@


1.5
log
@Fix the mandoc test suite after afresh1@@ changed wcwidth(3) in libc
for the private use area starting at U+E000.
Sometimes, even i'm surprised how much stuff these tests keep track of.
Originally, they were only intended to catch regressions in mandoc...
Issue noticed by daniel@@, thanks!
@
text
@CHAR-UNICODE-INPUT(1)       General Commands Manual      CHAR-UNICODE-INPUT(1)



NNAAMMEE
       char-unicode-input - Unicode characters in the input file

DDEESSCCRRIIPPTTIIOONN
       lowest valid: ï¿½

   OOnnee--bbyyttee rraannggee

       U+0000   0x00   ï¿½?   lowest ASCII
       U+001f   0x1f   ï¿½?   highest ASCII control character
       U+007f   0x7f   ï¿½?   highest ASCII
                0x80   ?    leading lowest continuation
                0xbf   ?    leading highest continuation

   TTwwoo--bbyyttee rraannggee

       U+0000   0xc080     ??   lowest obfuscated ASCII
       U+007f   0xc1bf     ??   highest obfuscated ASCII
                0xc278     ?x   ASCII continuation
       U+0080   0xc280     ï¿½ï¿½   lowest two-byte
                0xc2c380   ?Ã€   high continuation
       U+07FF   0xdfbf     ß¿ß¿     highest two-byte

   TThhrreeee--bbyyttee rraannggee

       U+0000   0xe08080   ???    lowest obfuscated ASCII
       U+007f   0xe081bf   ???    highest obfuscated ASCII
       U+0080   0xe08280   ???    lowest obfuscated two-byte
       U+07FF   0xe09fbf   ???    highest obfuscated two-byte
       U+0800   0xe0a080   à €à €     lowest three-byte
       U+0FFF   0xe0bfbf   à¿¿à¿¿       end of first middle byte
       U+1000   0xe18080   á€€á€€     begin of second middle byte
       U+CFFF   0xecbfbf   ì¿¿ì¿¿   end of last normal middle byte
       U+D000   0xed8080   í€€í€€   begin of strange middle byte
       U+D7FF   0xed9fbf   íŸ¿íŸ¿       highest public three-byte
       U+D800   0xeda080   ???    lowest surrogate
       U+DFFF   0xedbfbf   ???    highest surrogate
       U+E000   0xee8080   î€€î€€     lowest private use
       U+FFFF   0xefbfbf   ï¿¿ï¿¿       highest three-byte

   FFoouurr--bbyyttee rraannggee

       U+0000     0xf0808080     ????    lowest obfuscated ASCII
       U+007f     0xf08081bf     ????    highest obfuscated ASCII
       U+0080     0xf0808280     ????    lowest obfuscated two-byte
       U+07FF     0xf0809fbf     ????    highest obfuscated two-byte
       U+0800     0xf080a080     ????    lowest obfuscated three-byte
       U+FFFF     0xf08fbfbf     ????    highest obfuscated three-byte
       U+10000    0xf0908080     ğ€€ğ€€      lowest four-byte
       U+3FFFF    0xf0bfbfbf     ğ¿¿¿ğ¿¿¿        end of first middle byte
       U+40000    0xf1808080     ñ€€€ñ€€€        second middle byte
       U+FFFFF    0xf3bfbfbf     ó¿¿¿ó¿¿¿        last normal middle byte
       U+100000   0xf4808080     ô€€€ô€€€        strange middle byte
       U+10FFFF   0xf48fbfbf     ô¿¿ô¿¿        last valid four-byte
       U+110000   0xf4908080     ????    lowest beyond Unicode
       U+13FFFF   0xf4bfbfbf     ????    end of strange middle byte
       U+140000   0xf5808080     ????    lowest invalid middle byte
       U+1FFFFF   0xf7bfbfbf     ????    highest four-byte
       U+200000   0xf888808080   ?????   lowest five-byte



OpenBSD                        December 19, 2014         CHAR-UNICODE-INPUT(1)
@


1.4
log
@The recent update to /usr/share/locale/UTF-8/LC_CTYPE by afresh1@@
fixed wcwidth(3) for various unusual characters.
@
text
@d42 1
a42 1
       U+E000   0xee8080   î€€î€€       lowest private use
@


1.3
log
@Reject the escape sequences \[uD800] to \[uDFFF] in the parser.
These surrogates are not valid Unicode codepoints,
so treat them just like any other undefined character escapes:
Warn about them and do not produce output.
Issue noticed while talking to stsp@@, semarie@@, and bentley@@.
@
text
@d16 2
a17 2
                0x80   ?   leading lowest continuation
                0xbf   ?   leading highest continuation
d24 1
a24 1
       U+0080   0xc280     ï¿½ï¿½     lowest two-byte
d53 1
a53 1
       U+10000    0xf0908080     ğ€€ğ€€        lowest four-byte
@


1.2
log
@Apparently, some recent update of Unicode data in the base system
changed the output of wcwidth(3) for some weird Unicode characters,
causing harmless whitespace changes in mandoc(1) output; fix up the
regression suite accordingly.
The processing of the characters themselves still works correctly,
as it did before, and that's what these tests are intended to make
sure.  They were never intended to check for whitespace issues.
Problem reported by jsg@@.
@
text
@d40 2
a41 2
       U+D800   0xeda080   í €???    lowest surrogate
       U+DFFF   0xedbfbf   í¿¿???    highest surrogate
@


1.1
log
@Rewrite the low-level UTF-8 parser from scratch.
It accepted invalid byte sequences like 0xc080-c1bf, 0xe08080-e09fbf,
0xeda080-edbfbf, and 0xf0808080-f08fbfbf, produced valid roff Unicode
escape sequences from them, and the algorithm contained strong
defenses against any attempt to fix it.

This cures an assertion failure in the terminal formatter caused
by sneaking in ASCII 0x08 (backspace) by "encoding" it as an (invalid)
multibyte UTF-8 sequence, found by jsg@@ with afl.

As a bonus, the new algorithm also reduces the code in the function
by about 20%.
@
text
@d16 2
a17 2
                0x80   ?    leading lowest continuation
                0xbf   ?    leading highest continuation
d24 1
a24 1
       U+0080   0xc280     ï¿½ï¿½   lowest two-byte
d34 1
a34 1
       U+0800   0xe0a080   à €à €       lowest three-byte
d40 3
a42 3
       U+D800   0xeda080   í €???   lowest surrogate
       U+DFFF   0xedbfbf   í¿¿???   highest surrogate
       U+E000   0xee8080   î€€î€€     lowest private use
d57 1
a57 1
       U+100000   0xf4808080     ô€€€ô€€€      strange middle byte
@

