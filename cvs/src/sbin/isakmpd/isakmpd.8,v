head	1.118;
access;
symbols
	OPENBSD_6_1_BASE:1.118
	OPENBSD_6_0:1.118.0.2
	OPENBSD_6_0_BASE:1.118
	OPENBSD_5_9:1.117.0.2
	OPENBSD_5_9_BASE:1.117
	OPENBSD_5_8:1.116.0.6
	OPENBSD_5_8_BASE:1.116
	OPENBSD_5_7:1.116.0.2
	OPENBSD_5_7_BASE:1.116
	OPENBSD_5_6:1.114.0.4
	OPENBSD_5_6_BASE:1.114
	OPENBSD_5_5:1.113.0.4
	OPENBSD_5_5_BASE:1.113
	OPENBSD_5_4:1.112.0.2
	OPENBSD_5_4_BASE:1.112
	OPENBSD_5_3:1.111.0.2
	OPENBSD_5_3_BASE:1.111
	OPENBSD_5_2:1.109.0.4
	OPENBSD_5_2_BASE:1.109
	OPENBSD_5_1_BASE:1.109
	OPENBSD_5_1:1.109.0.2
	OPENBSD_5_0:1.108.0.2
	OPENBSD_5_0_BASE:1.108
	OPENBSD_4_9:1.107.0.4
	OPENBSD_4_9_BASE:1.107
	OPENBSD_4_8:1.107.0.2
	OPENBSD_4_8_BASE:1.107
	OPENBSD_4_7:1.105.0.2
	OPENBSD_4_7_BASE:1.105
	OPENBSD_4_6:1.104.0.12
	OPENBSD_4_6_BASE:1.104
	OPENBSD_4_5:1.104.0.8
	OPENBSD_4_5_BASE:1.104
	OPENBSD_4_4:1.104.0.6
	OPENBSD_4_4_BASE:1.104
	OPENBSD_4_3:1.104.0.4
	OPENBSD_4_3_BASE:1.104
	OPENBSD_4_2:1.104.0.2
	OPENBSD_4_2_BASE:1.104
	OPENBSD_4_1:1.101.0.2
	OPENBSD_4_1_BASE:1.101
	OPENBSD_4_0:1.93.0.2
	OPENBSD_4_0_BASE:1.93
	OPENBSD_3_9:1.83.0.2
	OPENBSD_3_9_BASE:1.83
	OPENBSD_3_8:1.82.0.2
	OPENBSD_3_8_BASE:1.82
	OPENBSD_3_7:1.67.0.2
	OPENBSD_3_7_BASE:1.67
	OPENBSD_3_6:1.65.0.2
	OPENBSD_3_6_BASE:1.65
	OPENBSD_3_5:1.61.0.2
	OPENBSD_3_5_BASE:1.61
	OPENBSD_3_4:1.55.0.2
	OPENBSD_3_4_BASE:1.55
	OPENBSD_3_3:1.49.0.2
	OPENBSD_3_3_BASE:1.49
	OPENBSD_3_2:1.43.0.2
	OPENBSD_3_2_BASE:1.43
	OPENBSD_3_1:1.39.0.2
	OPENBSD_3_1_BASE:1.39
	OPENBSD_3_0:1.33.0.2
	OPENBSD_3_0_BASE:1.33
	OPENBSD_2_9:1.24.0.2
	OPENBSD_2_9_BASE:1.24
	OPENBSD_2_8:1.19.0.4
	OPENBSD_2_8_BASE:1.19
	OPENBSD_2_7:1.19.0.2
	OPENBSD_2_7_BASE:1.19
	OPENBSD_2_6:1.14.0.2
	OPENBSD_2_6_BASE:1.14
	OPENBSD_2_5:1.6.0.2
	OPENBSD_2_5_BASE:1.6
	NIKLAS_981114:1.1.1.1
	NIKLAS:1.1.1;
locks; strict;
comment	@.\" @;


1.118
date	2016.03.05.08.38.36;	author jmc;	state Exp;
branches;
next	1.117;
commitid	GODpZdrjg1xdrRsD;

1.117
date	2015.09.25.14.27.26;	author schwarze;	state Exp;
branches;
next	1.116;
commitid	RJbc5hgF2DAFLTEG;

1.116
date	2015.01.16.14.19.07;	author schwarze;	state Exp;
branches;
next	1.115;
commitid	RKlECfEd4Q3a0eeA;

1.115
date	2015.01.16.09.08.41;	author bentley;	state Exp;
branches;
next	1.114;
commitid	pxxrmnHqt03XeO0z;

1.114
date	2014.03.11.15.25.34;	author sthen;	state Exp;
branches;
next	1.113;

1.113
date	2013.11.14.08.47.21;	author bentley;	state Exp;
branches;
next	1.112;

1.112
date	2013.07.14.16.37.41;	author jmc;	state Exp;
branches;
next	1.111;

1.111
date	2012.09.25.13.58.00;	author otto;	state Exp;
branches;
next	1.110;

1.110
date	2012.08.24.14.49.21;	author jmc;	state Exp;
branches;
next	1.109;

1.109
date	2011.09.29.17.57.09;	author jmc;	state Exp;
branches;
next	1.108;

1.108
date	2011.06.06.08.05.05;	author jmc;	state Exp;
branches;
next	1.107;

1.107
date	2010.06.07.08.38.09;	author jmc;	state Exp;
branches;
next	1.106;

1.106
date	2010.06.03.16.57.40;	author reyk;	state Exp;
branches;
next	1.105;

1.105
date	2010.01.03.16.43.45;	author schwarze;	state Exp;
branches;
next	1.104;

1.104
date	2007.05.31.19.19.45;	author jmc;	state Exp;
branches;
next	1.103;

1.103
date	2007.05.23.07.28.15;	author hshoexer;	state Exp;
branches;
next	1.102;

1.102
date	2007.05.07.01.50.46;	author joel;	state Exp;
branches;
next	1.101;

1.101
date	2007.03.01.20.30.09;	author jmc;	state Exp;
branches;
next	1.100;

1.100
date	2006.12.05.14.29.14;	author jmc;	state Exp;
branches;
next	1.99;

1.99
date	2006.11.30.11.24.49;	author markus;	state Exp;
branches;
next	1.98;

1.98
date	2006.11.29.19.44.50;	author jmc;	state Exp;
branches;
next	1.97;

1.97
date	2006.11.29.14.50.06;	author jmc;	state Exp;
branches;
next	1.96;

1.96
date	2006.11.29.07.27.55;	author mcbride;	state Exp;
branches;
next	1.95;

1.95
date	2006.11.28.09.27.09;	author markus;	state Exp;
branches;
next	1.94;

1.94
date	2006.10.05.09.11.27;	author tom;	state Exp;
branches;
next	1.93;

1.93
date	2006.09.09.07.52.04;	author jmc;	state Exp;
branches;
next	1.92;

1.92
date	2006.09.01.00.49.45;	author jmc;	state Exp;
branches;
next	1.91;

1.91
date	2006.08.31.19.06.53;	author jmc;	state Exp;
branches;
next	1.90;

1.90
date	2006.08.31.17.07.23;	author jmc;	state Exp;
branches;
next	1.89;

1.89
date	2006.08.30.20.27.52;	author jmc;	state Exp;
branches;
next	1.88;

1.88
date	2006.08.30.16.56.56;	author hshoexer;	state Exp;
branches;
next	1.87;

1.87
date	2006.06.29.10.00.49;	author hshoexer;	state Exp;
branches;
next	1.86;

1.86
date	2006.06.10.21.23.50;	author hshoexer;	state Exp;
branches;
next	1.85;

1.85
date	2006.05.26.09.26.07;	author jmc;	state Exp;
branches;
next	1.84;

1.84
date	2006.05.26.04.02.59;	author deraadt;	state Exp;
branches;
next	1.83;

1.83
date	2005.09.23.14.45.25;	author hshoexer;	state Exp;
branches;
next	1.82;

1.82
date	2005.08.23.15.02.31;	author jmc;	state Exp;
branches;
next	1.81;

1.81
date	2005.06.04.17.22.42;	author hshoexer;	state Exp;
branches;
next	1.80;

1.80
date	2005.06.02.10.03.37;	author jmc;	state Exp;
branches;
next	1.79;

1.79
date	2005.05.18.20.22.19;	author jmc;	state Exp;
branches;
next	1.78;

1.78
date	2005.05.14.09.28.18;	author jmc;	state Exp;
branches;
next	1.77;

1.77
date	2005.05.14.09.25.51;	author jmc;	state Exp;
branches;
next	1.76;

1.76
date	2005.05.06.19.06.50;	author jmc;	state Exp;
branches;
next	1.75;

1.75
date	2005.05.05.14.14.38;	author jmc;	state Exp;
branches;
next	1.74;

1.74
date	2005.05.05.14.05.51;	author jmc;	state Exp;
branches;
next	1.73;

1.73
date	2005.05.05.12.09.35;	author jmc;	state Exp;
branches;
next	1.72;

1.72
date	2005.05.05.11.32.05;	author jmc;	state Exp;
branches;
next	1.71;

1.71
date	2005.04.10.14.17.49;	author jmc;	state Exp;
branches;
next	1.70;

1.70
date	2005.04.08.22.32.10;	author cloder;	state Exp;
branches;
next	1.69;

1.69
date	2005.04.05.21.32.13;	author jmc;	state Exp;
branches;
next	1.68;

1.68
date	2005.04.05.18.06.05;	author cloder;	state Exp;
branches;
next	1.67;

1.67
date	2005.02.25.14.14.31;	author hshoexer;	state Exp;
branches;
next	1.66;

1.66
date	2005.02.24.13.55.51;	author hshoexer;	state Exp;
branches;
next	1.65;

1.65
date	2004.07.08.10.37.12;	author jmc;	state Exp;
branches;
next	1.64;

1.64
date	2004.07.07.22.25.39;	author hshoexer;	state Exp;
branches;
next	1.63;

1.63
date	2004.05.13.06.56.34;	author ho;	state Exp;
branches;
next	1.62;

1.62
date	2004.04.15.00.27.40;	author deraadt;	state Exp;
branches;
next	1.61;

1.61
date	2004.03.24.16.44.24;	author hshoexer;	state Exp;
branches;
next	1.60;

1.60
date	2004.01.23.23.08.46;	author jmc;	state Exp;
branches;
next	1.59;

1.59
date	2004.01.16.10.51.57;	author hshoexer;	state Exp;
branches;
next	1.58;

1.58
date	2003.11.20.11.23.01;	author jmc;	state Exp;
branches;
next	1.57;

1.57
date	2003.10.25.07.47.28;	author jmc;	state Exp;
branches;
next	1.56;

1.56
date	2003.10.13.13.57.51;	author ho;	state Exp;
branches;
next	1.55;

1.55
date	2003.08.20.12.25.02;	author ho;	state Exp;
branches;
next	1.54;

1.54
date	2003.08.09.08.45.58;	author jmc;	state Exp;
branches;
next	1.53;

1.53
date	2003.06.04.07.31.17;	author ho;	state Exp;
branches;
next	1.52;

1.52
date	2003.06.03.13.16.08;	author jmc;	state Exp;
branches;
next	1.51;

1.51
date	2003.05.10.21.13.41;	author jmc;	state Exp;
branches;
next	1.50;

1.50
date	2003.04.27.11.17.14;	author ho;	state Exp;
branches;
next	1.49;

1.49
date	2003.02.22.06.56.20;	author kjell;	state Exp;
branches;
next	1.48;

1.48
date	2003.02.05.10.29.49;	author jmc;	state Exp;
branches;
next	1.47;

1.47
date	2002.12.03.20.05.10;	author ho;	state Exp;
branches;
next	1.46;

1.46
date	2002.11.27.14.36.20;	author ho;	state Exp;
branches;
next	1.45;

1.45
date	2002.11.09.02.22.33;	author fgsch;	state Exp;
branches;
next	1.44;

1.44
date	2002.11.09.00.57.20;	author fgsch;	state Exp;
branches;
next	1.43;

1.43
date	2002.09.06.21.36.52;	author deraadt;	state Exp;
branches;
next	1.42;

1.42
date	2002.08.07.13.19.20;	author ho;	state Exp;
branches;
next	1.41;

1.41
date	2002.08.02.13.27.22;	author ho;	state Exp;
branches;
next	1.40;

1.40
date	2002.06.09.08.13.06;	author todd;	state Exp;
branches;
next	1.39;

1.39
date	2002.04.10.20.56.28;	author ho;	state Exp;
branches;
next	1.38;

1.38
date	2002.03.17.21.49.26;	author angelos;	state Exp;
branches;
next	1.37;

1.37
date	2001.12.21.11.41.50;	author mpech;	state Exp;
branches;
next	1.36;

1.36
date	2001.12.13.20.16.48;	author mpech;	state Exp;
branches;
next	1.35;

1.35
date	2001.12.10.04.06.45;	author ho;	state Exp;
branches;
next	1.34;

1.34
date	2001.12.10.03.45.03;	author ho;	state Exp;
branches;
next	1.33;

1.33
date	2001.08.31.12.22.19;	author ho;	state Exp;
branches;
next	1.32;

1.32
date	2001.08.30.09.03.18;	author ho;	state Exp;
branches;
next	1.31;

1.31
date	2001.08.23.18.14.16;	author niklas;	state Exp;
branches;
next	1.30;

1.30
date	2001.08.15.09.16.29;	author ho;	state Exp;
branches;
next	1.29;

1.29
date	2001.07.20.18.07.11;	author mpech;	state Exp;
branches;
next	1.28;

1.28
date	2001.06.27.03.31.42;	author angelos;	state Exp;
branches;
next	1.27;

1.27
date	2001.05.24.15.59.30;	author ho;	state Exp;
branches;
next	1.26;

1.26
date	2001.04.30.14.38.12;	author ho;	state Exp;
branches;
next	1.25;

1.25
date	2001.04.30.12.51.13;	author provos;	state Exp;
branches;
next	1.24;

1.24
date	2001.04.09.21.21.57;	author ho;	state Exp;
branches;
next	1.23;

1.23
date	2001.04.05.23.31.05;	author ho;	state Exp;
branches;
next	1.22;

1.22
date	2001.04.05.23.22.57;	author ho;	state Exp;
branches;
next	1.21;

1.21
date	2001.03.13.14.05.18;	author ho;	state Exp;
branches;
next	1.20;

1.20
date	2000.12.12.05.01.01;	author todd;	state Exp;
branches;
next	1.19;

1.19
date	2000.05.02.14.36.51;	author niklas;	state Exp;
branches
	1.19.4.1;
next	1.18;

1.18
date	2000.04.07.22.23.14;	author niklas;	state Exp;
branches;
next	1.17;

1.17
date	2000.03.18.22.55.59;	author aaron;	state Exp;
branches;
next	1.16;

1.16
date	2000.02.01.02.46.18;	author niklas;	state Exp;
branches;
next	1.15;

1.15
date	2000.01.26.15.22.30;	author niklas;	state Exp;
branches;
next	1.14;

1.14
date	99.10.17.19.35.23;	author aaron;	state Exp;
branches;
next	1.13;

1.13
date	99.10.01.14.09.20;	author niklas;	state Exp;
branches;
next	1.12;

1.12
date	99.07.18.20.13.39;	author niklas;	state Exp;
branches;
next	1.11;

1.11
date	99.07.18.09.33.21;	author niklas;	state Exp;
branches;
next	1.10;

1.10
date	99.07.07.22.08.10;	author niklas;	state Exp;
branches;
next	1.9;

1.9
date	99.07.03.02.11.07;	author aaron;	state Exp;
branches;
next	1.8;

1.8
date	99.06.04.02.45.22;	author aaron;	state Exp;
branches;
next	1.7;

1.7
date	99.05.28.23.00.02;	author aaron;	state Exp;
branches;
next	1.6;

1.6
date	98.12.21.01.02.25;	author niklas;	state Exp;
branches;
next	1.5;

1.5
date	98.12.15.01.20.42;	author aaron;	state Exp;
branches;
next	1.4;

1.4
date	98.11.28.19.56.32;	author aaron;	state Exp;
branches;
next	1.3;

1.3
date	98.11.17.11.10.15;	author niklas;	state Exp;
branches;
next	1.2;

1.2
date	98.11.15.00.43.57;	author niklas;	state Exp;
branches;
next	1.1;

1.1
date	98.11.15.00.03.48;	author niklas;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	98.11.15.00.03.48;	author niklas;	state Exp;
branches;
next	;

1.19.4.1
date	2001.05.08.12.45.23;	author ho;	state Exp;
branches;
next	;


desc
@@


1.118
log
@fix steps for cert creation;
issue reported by igor.kos

(temporary) fix entirely provided by sthen
@
text
@.\" $OpenBSD: isakmpd.8,v 1.117 2015/09/25 14:27:26 schwarze Exp $
.\" $EOM: isakmpd.8,v 1.23 2000/05/02 00:30:23 niklas Exp $
.\"
.\" Copyright (c) 1998, 1999, 2000, 2001 Niklas Hallqvist.
.\" All rights reserved.
.\" Copyright (c) 1999 Angelos D. Keromytis.  All rights reserved.
.\" Copyright (c) 2001, 2002 Håkan Olsson.  All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
.\" IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
.\" OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
.\" IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
.\" INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
.\" NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
.\" DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
.\" THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
.\" (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
.\" THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
.\"
.\" This code was written under funding by Ericsson Radio Systems.
.\"
.\" Manual page, using -mandoc macros
.\"
.Dd $Mdocdate: September 25 2015 $
.Dt ISAKMPD 8
.Os
.Sh NAME
.Nm isakmpd
.Nd ISAKMP/Oakley a.k.a. IKEv1 key management daemon
.Sh SYNOPSIS
.Nm isakmpd
.Op Fl 46adKLnSTv
.Op Fl c Ar config-file
.Op Fl D Ar class Ns = Ns Ar level
.Op Fl f Ar fifo
.Op Fl i Ar pid-file
.Op Fl l Ar packetlog-file
.Op Fl N Ar udpencap-port
.Op Fl p Ar listen-port
.Op Fl R Ar report-file
.Sh DESCRIPTION
The
.Nm
daemon establishes security associations for encrypted
and/or authenticated network traffic.
At this moment, and probably forever, this means
.Xr ipsec 4
traffic.
Traditionally,
.Nm
was configured using the
.Xr isakmpd.conf 5
file format.
A newer, much simpler format is now available:
.Xr ipsec.conf 5 .
.Pp
.Nm
implements the IKEv1 protocol which is defined in the standards
ISAKMP/Oakley (RFC 2408), IKE (RFC 2409), and the Internet DOI (RFC 2407).
The newer IKEv2 protocol,
as defined in RFC 5996,
is not supported by
.Nm
but by
.Xr iked 8 .
It follows then that references to IKE in this document
pertain to IKEv1 only,
and not IKEv2.
.Pp
The way
.Nm
goes about its work is by maintaining an internal configuration
as well as a policy database which describes what kinds of SAs to negotiate,
and by listening for different events that trigger these negotiations.
The events that control
.Nm
consist of negotiation initiations from a remote party, user input via
a FIFO or by signals, upcalls from the kernel via a
.Dv PF_KEY
socket, and lastly by scheduled events triggered by timers running out.
.Pp
Most uses of
.Nm
will be to implement so called "virtual private networks" (VPNs).
The ability to provide redundancy is made available through
.Xr carp 4
and
.Xr sasyncd 8 .
For other uses, some more knowledge of IKEv1 as a protocol is required.
The RFCs mentioned below are a possible starting point.
.Pp
On startup
.Nm
forks into two processes for privilege separation.
The unprivileged child jails itself with
.Xr chroot 8
to
.Pa /var/empty .
The privileged process communicates with the child, reads configuration files
and PKI information, and binds to privileged ports on its behalf.
See the
.Sx CAVEATS
section below.
.Pp
The options are as follows:
.Bl -tag -width Ds
.It Fl 4 | 6
These options control what address family
.Pf ( Dv AF_INET
and/or
.Dv AF_INET6 )
.Nm
will use.
The default is to use both IPv4 and IPv6.
.It Fl a
If given,
.Nm
does not set up flows automatically.
Instead manual flows may be configured using
.Xr ipsec.conf 5
or by programs such as
.Xr bgpd 8 .
Thus
.Nm
only takes care of SA establishment.
.It Fl c Ar config-file
If given, the
.Fl c
option specifies an alternate configuration file instead of
.Pa /etc/isakmpd/isakmpd.conf .
As this file may contain sensitive information, it must be readable
only by the user running the daemon.
.Nm
will reread the configuration file when sent a
.Dv SIGHUP
signal.
.Pp
Note that this option applies only to configuration files in the
.Xr isakmpd.conf 5
format, not those in the
.Xr ipsec.conf 5
format.
.It Fl D Ar class Ns = Ns Ar level
Debugging class.
It's possible to specify this argument many times.
It takes a parameter of the form
.Ar class Ns = Ns Ar level ,
where both
.Ar class
and
.Ar level
are numbers.
.Ar class
denotes a debugging class, and
.Ar level
the level you want that debugging class to
limit debug printouts at (i.e. all debug printouts above the level specified
will not output anything).
If
.Ar class
is set to
.Sq A ,
then all debugging classes are set to the specified level.
.Pp
Valid values for
.Ar class
are as follows:
.Pp
.Bl -tag -width 2n -offset indent -compact
.It 0
Misc
.It 1
Transport
.It 2
Message
.It 3
Crypto
.It 4
Timer
.It 5
Sysdep
.It 6
SA
.It 7
Exchange
.It 8
Negotiation
.It 9
Policy
.It 10
FIFO user interface
.It A
All
.El
.Pp
Currently used values for
.Ar level
are 0 to 99.
.It Fl d
The
.Fl d
option is used to make the daemon run in the foreground, logging to stderr.
.It Fl f Ar fifo
The
.Fl f
option specifies the
.Tn FIFO
(a.k.a. named pipe) where the daemon listens for
user requests.
If the path given is a dash
.Pq Sq \&- ,
.Nm
will listen to stdin instead.
.It Fl i Ar pid-file
By default the PID of the daemon process will be written to
.Pa /var/run/isakmpd.pid .
This path can be overridden by specifying another one as the argument to the
.Fl i
option.
Note that only paths beginning with
.Pa /var/run
are allowed.
.It Fl K
When this option is given,
.Nm
does not read the policy configuration file and no
.Xr keynote 4
policy check is accomplished.
This option can be used when policies for flows and SA establishment are
arranged by other programs like
.Xr ipsecctl 8
or
.Xr bgpd 8 .
.It Fl L
Enable IKE packet capture.
When this option is given,
.Nm
will write an unencrypted copy of the negotiation packets it
is sending and receiving to the file
.Pa /var/run/isakmpd.pcap ,
which can later be read by
.Xr tcpdump 8
and other utilities using
.Xr pcap 3 .
.It Fl l Ar packetlog-file
As option
.Fl L
above, but capture to a specified file.
Note that only paths beginning with
.Pa /var/run
are allowed.
.It Fl N Ar udpencap-port
The
.Fl N
option specifies the listen port for encapsulated UDP
that the daemon will bind to.
.It Fl n
When the
.Fl n
option is given, the kernel will not take part in the negotiations.
This is a non-destructive mode, so to speak, in that it won't alter any
SAs in the IPsec stack.
.It Fl p Ar listen-port
The
.Fl p
option specifies the listen port the daemon will bind to.
.It Fl R Ar report-file
When you signal
.Nm
a
.Dv SIGUSR1 ,
it will report its internal state to a report file, normally
.Pa /var/run/isakmpd.report ,
but this can be changed by feeding
the file name as an argument to the
.Fl R
flag.
Note that only paths beginning with
.Pa /var/run
are allowed.
.It Fl S
This option is used for setups using
.Xr sasyncd 8
and
.Xr carp 4
to provide redundancy.
.Nm
starts in passive mode and will not initiate any connections
or process any incoming traffic until
sasyncd has determined that the host is the carp master.
Additionally,
.Nm
will not delete SAs on shutdown
by sending delete messages to all peers.
.It Fl T
When this option is given, NAT-Traversal will be disabled and
.Nm
will not advertise support for NAT-Traversal to its peers.
.It Fl v
Enables verbose logging.
Normally,
.Nm
is silent and outputs only messages when a warning or an error occurs.
With verbose logging
.Nm
reports successful completion of phase 1 (Main and Aggressive) and phase 2
(Quick) exchanges (Information and Transaction exchanges do not generate any
additional status information).
.El
.Sh THE FIFO USER INTERFACE
When
.Nm
starts, it creates a FIFO (named pipe) where it listens for user
requests.
All commands start with a single letter, followed by command-specific options.
Available commands are:
.Pp
.Bl -tag -width Ds -compact
.It Ic C add Oo Ar section Oc : Ns Ar tag Ns = Ns Ar value
.It Ic C rmv Oo Ar section Oc : Ns Ar tag Ns = Ns Ar value
.It Ic C rm Oo Ar section Oc : Ns Ar tag
.It Ic C rms Op Ar section
.It Ic C set Oo Ar section Oc : Ns Ar tag Ns = Ns Ar value Op Ic force
Update the running
.Nm
configuration atomically.
.Sq set
sets a configuration value consisting of a section, tag, and value triplet.
.Sq set
will fail if the configuration already contains a section with the named tag;
use the
.Sq force
option to change this behaviour.
.Sq add
appends a configuration value to the named configuration list tag,
unless the value is already in the list.
.Sq rm
removes a tag in a section.
.Sq rms
removes an entire section.
.Sq rmv
removes an entry from a list, thus reversing an
.Sq add
operation.
.Pp
NOTE: Sending
.Nm
a
.Dv SIGHUP
or an "R" through the FIFO will void any updates done to the configuration.
.Pp
.It Ic C get Oo Ar section Oc : Ns Ar tag
Get the configuration value of the specified section and tag.
The result is stored in
.Pa /var/run/isakmpd.result .
.Pp
.It Ic c Ar name
Start the named connection, if stopped or inactive.
.Pp
.It Ic D Ar class level
.It Ic D A Ar level
.It Ic D T
Set debug class
.Ar class
to level
.Ar level .
If
.Ar class
is specified as
.Sq A ,
the level applies to all debug classes.
.Ic D T
toggles all debug classes to level zero.
Another
.Ic D T
command will toggle them back to the earlier levels.
.Pp
.It Ic d Ar cookies msgid
Delete the specified SA from the system.
Specify
.Ar msgid
as
.Sq -
to match a Phase 1 SA.
.Pp
.It Ic M active
.It Ic M passive
Set
.Nm
to active or passive mode.
In passive mode no packets are sent to peers.
.Pp
.It Ic p on Ns Op = Ns Ar path
.It Ic p off
Enable or disable cleartext IKE packet capture.
When enabling, optionally specify which file
.Nm
should capture the packets to
(the default is
.Pa /var/run/isakmpd.pcap ) .
Note that only paths beginning with
.Pa /var/run
are allowed.
.Pp
.It Ic Q
Cleanly shutdown the daemon, as when sent a
.Dv SIGTERM
signal.
.Pp
.It Ic R
Reinitialize
.Nm isakmpd ,
as when sent a
.Dv SIGHUP
signal.
.Pp
.It Ic r
Report
.Nm
internal state to
.Xr syslog 3 .
See the
.Fl R
option.
Same as when sent a
.Dv SIGUSR1
signal.
.Pp
.It Ic S
Report information on all known SAs to the
.Pa /var/run/isakmpd.result
file.
.Pp
.It Ic T
Tear down all active quick mode connections.
.Pp
.It Ic t Oo Ar phase Oc Ar name
Tear down the named connection, if active.
For
.Ar name ,
the tag specified in
.Xr isakmpd.conf 5
or the IP address of the remote host can be used.
The optional parameter
.Ar phase
specifies whether to delete a phase 1 or phase 2 SA.
The value
.Sq main
indicates a phase 1 connection;
the value
.Sq quick
a phase 2 connection.
If no phase is specified,
.Sq quick
will be assumed.
.El
.Sh SETTING UP AN IKE PUBLIC KEY INFRASTRUCTURE (PKI)
In order to use public key based authentication, there has to be an
infrastructure managing the key signing.
Either there is an already existing PKI
.Nm
should take part in, or there will be a need to set one up.
The procedures for using a pre-existing PKI varies depending on the
actual Certificate Authority (CA) used, and is therefore not covered here,
other than mentioning that
.Xr openssl 1
needs to be used to create a Certificate Signing Request (CSR) that the
CA understands.
.Pp
A number of methods exist to allow authentication:
.Bl -ohang -offset indent
.It Passphrase:
This method does not use keys at all, but relies on a shared passphrase.
.It Host Keys:
Public keys are used to authenticate.
See
.Sx PUBLIC KEY AUTHENTICATION
below.
.It X.509 Certificates:
X.509 Certificates are used to authenticate.
See
.Sx X.509 AUTHENTICATION
below.
.It Keynote Certificates:
Keynote Certificates are used to authenticate.
See
.Sx KEYNOTE AUTHENTICATION
below.
.El
.Pp
When configuring
.Nm
for key- and certificate-based authentication,
the
.Dq Transforms
tag in
.Xr isakmpd.conf 5
should include
.Dq RSA_SIG .
For example, the transform
.Dq 3DES-SHA-RSA_SIG
means:
3DES encryption, SHA hash, authentication using RSA signatures.
.Sh PUBLIC KEY AUTHENTICATION
It is possible to store trusted public keys to make them directly
usable by
.Nm ,
bypassing the need to use certificates.
The keys should be saved in PEM format (see
.Xr openssl 1 )
and named and stored after this easy formula:
.Pp
.Bl -tag -width "for_ufqdn_identitiesXX" -offset 3n -compact
.It For IPv4 identities:
.Pa /etc/isakmpd/pubkeys/ipv4/A.B.C.D
.It For IPv6 identities:
.Pa /etc/isakmpd/pubkeys/ipv6/abcd:abcd::ab:bc
.It For FQDN identities:
.Pa /etc/isakmpd/pubkeys/fqdn/foo.bar.org
.It For UFQDN identities:
.Pa /etc/isakmpd/pubkeys/ufqdn/user@@foo.bar.org
.El
.Pp
Depending on the
.Dv ID-type
field of
.Xr isakmpd.conf 5 ,
keys may be named after their IPv4 address (IPV4_ADDR or IPV4_ADDR_SUBNET),
IPv6 address (IPV6_ADDR or IPV6_ADDR_SUBNET),
fully qualified domain name (FDQN),
user fully qualified domain name (USER_FQDN),
or key ID (KEY_ID).
.Pp
For example,
.Nm
can authenticate using the pre-generated keys if the local public key,
by default
.Pa /etc/isakmpd/local.pub ,
is copied to the remote gateway as
.Pa /etc/isakmpd/pubkeys/ipv4/local.gateway.ip.address
and the remote gateway's public key
is copied to the local gateway as
.Pa /etc/isakmpd/pubkeys/ipv4/remote.gateway.ip.address .
Of course, new keys may also be generated
(the user is not required to use the pre-generated keys).
In this example,
.Dv ID-type
would also have to be set to IPV4_ADDR or IPV4_ADDR_SUBNET
in
.Xr isakmpd.conf 5 .
.Sh X.509 AUTHENTICATION
X.509 is a framework for public key certificates.
Certificates can be generated using
.Xr openssl 1
and provide a means for PKI authentication.
In the following example, a CA is created along with host certificates
to be signed by the CA.
.Bl -enum
.It
Create your own Certificate Authority (CA).
.Pp
First, create a private key for the CA, and a Certificate Signing Request
(CSR) to enable the CA to sign its own key:
.Bd -literal -offset indent
# openssl genrsa -out /etc/ssl/private/ca.key 2048
# openssl req -new -key /etc/ssl/private/ca.key \e
	-out /etc/ssl/private/ca.csr
.Ed
.Pp
.Ic openssl req
will prompt for information that will be incorporated
into the certificate request.
The information entered comprises a Distinguished Name (DN).
There are quite a few fields, but some can be left blank.
For some fields there will be a default value; if
.Sq \&.
is entered, the field will be left blank.
.Pp
After the CSR has been generated, it is used to create and sign
a certificate for the CA:
.Bd -literal -offset indent
# openssl x509 -req -days 365 -in /etc/ssl/private/ca.csr \e
	-signkey /etc/ssl/private/ca.key \e
	-extfile /etc/ssl/x509v3.cnf -extensions x509v3_CA \e
	-out /etc/ssl/ca.crt
.Ed
.It
Create Certificate Signing Requests (CSRs) for IKE peers.
The CSRs are signed with a pre-generated private key.
.Pp
This step, as well as the next one, needs to be done for every peer.
Furthermore the last step will need to be done once for each ID you
want the peer to have.
The 10.0.0.1 below symbolizes that ID, in this case an IPv4 ID,
and should be changed for each invocation.
You will be asked for a DN for each run.
Encoding the ID in the common name is recommended, as it should be unique.
.Bd -literal -offset indent
# openssl req -new -key /etc/isakmpd/private/local.key \e
	-out /etc/isakmpd/private/10.0.0.1.csr
.Ed
.Pp
Now take these certificate signing requests to your CA and process
them as below.
A
.Em subjectAltName
extension field should be added to the certificate.
Replace 10.0.0.1 with the IP address which
.Nm
will use as the certificate identity.
.Pp
Copy
.Pa /etc/ssl/x509v3.cnf
to a temporary file and edit it to replace
.Dv $ENV::CERTIP
with 10.0.0.1, then run:
.Bd -literal -offset indent
# openssl x509 -req \e
	-days 365 -in 10.0.0.1.csr \e
	-CA /etc/ssl/ca.crt -CAkey /etc/ssl/private/ca.key \e
	-CAcreateserial -extfile /etc/ssl/x509v3.cnf \e
	-extensions x509v3_IPAddr -out 10.0.0.1.crt
.Ed
.Pp
For a FQDN certificate, replace
.Dv $ENV::CERTIP
with the hostname and run:
.Bd -literal -offset indent
# openssl x509 -req \e
	-days 365 -in somehost.somedomain.csr \e
	-CA /etc/ssl/ca.crt -CAkey /etc/ssl/private/ca.key \e
	-CAcreateserial -extfile /etc/ssl/x509v3.cnf \e
	-extensions x509v3_FQDN -out somehost.somedomain.crt
.Ed
.Pp
If CERTFQDN is being used,
make sure that the
.Va subjectAltName
field of the certificate is specified using
.Ic srcid
in
.Xr ipsec.conf 5 .
A similar setup will be required if
.Xr isakmpd.conf 5
is being used instead.
.Pp
Put the certificate (the file ending in .crt) in
.Pa /etc/isakmpd/certs/
on your local system.
Also carry over the CA cert
.Pa /etc/ssl/ca.crt
and put it in
.Pa /etc/isakmpd/ca/ .
.El
.Pp
To revoke certificates, create a Certificate Revocation List (CRL) file
and install it in the
.Pa /etc/isakmpd/crls/
directory.
See
.Xr openssl 1
and the
.Sq crl
subcommand for more info.
.Sh KEYNOTE AUTHENTICATION
Keynote is a trust-management framework.
Keys can be generated using
.Xr keynote 1
and provide an alternative means for
.Nm
to authenticate.
See
.Xr keynote 4
for further information.
.Sh FILES
.Bl -tag -width Ds
.It Pa /etc/isakmpd/ca/
The directory where CA certificates are kept.
.It Pa /etc/isakmpd/certs/
The directory where IKE certificates are kept, both the local
certificate(s) and those of the peers, if a choice to have them kept
permanently has been made.
.It Pa /etc/isakmpd/crls/
The directory where CRLs are kept.
.It Pa /etc/isakmpd/isakmpd.conf
The configuration file.
As this file can contain sensitive information
it must not be readable by anyone but the user running
.Nm .
.It Pa /etc/isakmpd/isakmpd.policy
The keynote policy configuration file.
The same mode requirements as
.Pa isakmpd.conf .
.It Pa /etc/isakmpd/keynote/
The directory where KeyNote credentials are kept.
.It Pa /etc/isakmpd/private/
The directory where local private keys used for public key authentication
are kept.
By default, the system startup script
.Xr rc 8
generates a key-pair when starting, if one does not already exist.
The entire keypair is in
.Pa local.key ,
and a copy of the public key suitable for transferring to other hosts
is extracted into
.Pa /etc/isakmpd/local.pub .
There has to be a certificate for
.Pa local.key
in the certificate directory,
.Pa /etc/isakmpd/certs/ .
.Pa local.key
has the same mode requirements as
.Pa isakmpd.conf .
.It Pa /etc/isakmpd/pubkeys/
The directory in which trusted public keys are kept.
The keys must be named in the fashion described above.
.It Pa /var/run/isakmpd.fifo
The FIFO used to manually control
.Nm isakmpd .
.It Pa /var/run/isakmpd.pcap
The default IKE packet capture file.
.It Pa /var/run/isakmpd.pid
The PID of the current daemon.
.It Pa /var/run/isakmpd.report
The report file written when
.Dv SIGUSR1
is received.
.It Pa /var/run/isakmpd.result
The report file written when the
.Sq S
or
.Sq "C get"
command is issued in the command FIFO.
.El
.Sh SEE ALSO
.Xr openssl 1 ,
.Xr getnameinfo 3 ,
.Xr pcap 3 ,
.Xr ipsec 4 ,
.Xr ipsec.conf 5 ,
.Xr isakmpd.conf 5 ,
.Xr isakmpd.policy 5 ,
.Xr iked 8 ,
.Xr sasyncd 8 ,
.Xr ssl 8 ,
.Xr tcpdump 8
.Sh STANDARDS
.Rs
.%A D. Piper
.%D November 1998
.%R RFC 2407
.%T The Internet IP Security Domain of Interpretation for ISAKMP
.Re
.Pp
.Rs
.%A D. Maughan
.%A M. Schertler
.%A M. Schneider
.%A J. Turner
.%D November 1998
.%R RFC 2408
.%T Internet Security Association and Key Management Protocol (ISAKMP)
.Re
.Pp
.Rs
.%A D. Harkins
.%A D. Carrel
.%D November 1998
.%R RFC 2409
.%T The Internet Key Exchange (IKE)
.Re
.Pp
.Rs
.%A T. Kivinen
.%A B. Swander
.%A A. Huttunen
.%A V. Volpe
.%D January 2005
.%R RFC 3947
.%T Negotiation of NAT-Traversal in the IKE
.Re
.Sh HISTORY
This implementation of the ISAKMP/Oakley key management protocol
was done in 1998 by Niklas Hallqvist and Niels Provos,
sponsored by Ericsson Radio Systems.
.Sh CAVEATS
When storing a trusted public key for an IPv6 identity, the
.Em most efficient
form of address representation, i.e. "::" instead of ":0:0:0:",
must be used or the matching will fail.
.Nm
uses the output from
.Xr getnameinfo 3
for the address-to-name translation.
The privileged process only allows binding to the default port 500 or
unprivileged ports (>1024).
It is not possible to change the interfaces
.Nm
listens on without a restart.
.Pp
For redundant setups,
.Xr sasyncd 8
must be manually restarted every time
.Nm
is restarted.
@


1.117
log
@drop useless .Xo and .Bk, and shorten by avoiding some .Sm
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.116 2015/01/16 14:19:07 schwarze Exp $
d33 1
a33 1
.Dd $Mdocdate: January 16 2015 $
d620 6
d627 1
a627 1
# env CERTIP=10.0.0.1 openssl x509 -req \e
d634 3
a636 1
For a FQDN certificate, do:
d638 1
a638 1
# env CERTFQDN=somehost.somedomain openssl x509 -req \e
@


1.116
log
@Tweak previous: Do not put punctuation on its own line, put it at the end
of the preceding macro line; no output change with mandoc, fixes output
with groff.  Also, if you want spacing back after .Sm off, do not add
an argument containing a blank character, simply rely on .Sm on.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.115 2015/01/16 09:08:41 bentley Exp $
a40 1
.Bk -words
d43 1
a43 4
.Xo
.Oo Fl D
.Ar class Ns = Ns Ar level Oc
.Xc
a49 1
.Ek
d328 5
a332 40
.It Xo
.Ic C add
.Sm off
.Op Ar section :
.Ar tag No = Ar value
.Sm on
.Xc
.It Xo
.Ic C rmv
.Sm off
.Op Ar section :
.Ar tag No = Ar value
.Sm on
.Xc
.It Xo
.Ic C rm
.Sm off
.Op Ar section :
.Ar tag
.Sm on
.Xc
.It Xo
.Ic C rms
.Op Ar section
.Xc
.It Xo
.Ic C set
.Sm off
.Op Ar section :
.Ar tag No = Ar value
.Sm on
.Xc
.It Xo
.Ic C set
.Sm off
.Op Ar section :
.Ar tag No = Ar value
.Sm on
.Ic force
.Xc
d361 1
a361 7
.It Xo
.Ic C get
.Sm off
.Op Ar section :
.Ar tag
.Sm on
.Xc
d369 2
a370 9
.It Xo
.Ic D
.Ar class
.Ar level
.Xc
.It Xo
.Ic D A
.Ar level
.Xc
d387 1
a387 5
.It Xo
.Ic d
.Ar cookies
.Ar msgid
.Xc
d402 1
a402 7
.It Xo
.Ic p
.Sm off
.Ic on
.Op No = Ar path
.Sm on
.Xc
d446 1
a446 5
.It Xo
.Ic t
.Op Ar phase
.Ar name
.Xc
@


1.115
log
@Clean up macros in isakmpd(8).

- Fix mandoc warnings ("WARNING: skipping empty macro: No")
- Mark up arguments with Ar, not Aq Ic
- Mark up pathnames with Pa

ok jmc@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.114 2014/03/11 15:25:34 sthen Exp $
d33 1
a33 1
.Dd $Mdocdate: March 11 2014 $
d336 1
a336 2
.Op Ar section
:
d343 1
a343 2
.Op Ar section
:
d350 1
a350 2
.Op Ar section
:
d361 1
a361 2
.Op Ar section
:
d368 2
a369 3
.Op Ar section
:
.Ar tag No = Ar value " " Ic force
d371 1
d404 1
a404 2
.Op Ar section
:
@


1.114
log
@For CA generation, go back to using a two-step procedure to create a CSR and
then self-sign it rather than using the "openssl req" shortcut. This allows
us to specify -extfile and thus set the correct certificate extensions so
that stricter SSL implementations will trust this as a CA cert, and matches
how things are done in ssl(8). This is basically a partial revert of r1.77.

Researched by chrisz@@, tweak/ok jmc@@ ok beck@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.113 2013/11/14 08:47:21 bentley Exp $
d33 1
a33 1
.Dd $Mdocdate: November 14 2013 $
d336 3
a338 3
.Op Ic section
.No :
.Ic tag No = Ic value
d344 3
a346 3
.Op Ic section
.No :
.Ic tag No = Ic value
d352 3
a354 3
.Op Ic section
.No :
.Ic tag
d359 1
a359 1
.Op Ic section
d364 3
a366 3
.Op Ic section
.No :
.Ic tag No = Ic value
d372 3
a374 3
.Op Ic section
.No :
.Ic tag No = Ic value\ \&force
d408 3
a410 3
.Op Ic section
.No :
.Ic tag
d417 1
a417 1
.It Ic c Aq Ic name
d422 2
a423 2
.Aq Ic class
.Aq Ic level
d427 1
a427 1
.Aq Ic level
d431 1
a431 1
.Aq Ic class
d433 1
a433 1
.Aq Ic level .
d435 1
a435 1
.Aq Ic class
d447 2
a448 2
.Aq Ic cookies
.Aq Ic msgid
d452 1
a452 1
.Aq Ic msgid
d468 1
a468 1
.Op No = Aq Ic path
d516 2
a517 2
.Op Aq Ic phase
.Aq Ic name
d596 1
a596 1
/etc/isakmpd/pubkeys/ipv4/A.B.C.D
d598 1
a598 1
/etc/isakmpd/pubkeys/ipv6/abcd:abcd::ab:bc
d600 1
a600 1
/etc/isakmpd/pubkeys/fqdn/foo.bar.org
d602 1
a602 1
/etc/isakmpd/pubkeys/ufqdn/user@@foo.bar.org
d750 1
a750 1
.It /etc/isakmpd/ca/
d752 1
a752 1
.It /etc/isakmpd/certs/
d756 1
a756 1
.It /etc/isakmpd/crls/
d758 1
a758 1
.It /etc/isakmpd/isakmpd.conf
d763 1
a763 1
.It /etc/isakmpd/isakmpd.policy
d767 1
a767 1
.It /etc/isakmpd/keynote/
d769 1
a769 1
.It /etc/isakmpd/private/
d787 1
a787 1
.It /etc/isakmpd/pubkeys/
d790 1
a790 1
.It /var/run/isakmpd.fifo
d793 1
a793 1
.It /var/run/isakmpd.pcap
d795 1
a795 1
.It /var/run/isakmpd.pid
d797 1
a797 1
.It /var/run/isakmpd.report
d801 1
a801 1
.It /var/run/isakmpd.result
@


1.113
log
@Add STANDARDS section to isakmpd(8).

tweaks/ok jmc@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.112 2013/07/14 16:37:41 jmc Exp $
d33 1
a33 1
.Dd $Mdocdate: July 14 2013 $
d643 2
a644 5
Create a self-signed root certificate.
The CA certificate is named
.Pa ca.crt ,
and its private key
.Pa ca.key :
d646 3
a648 3
# openssl req -x509 -days 365 -newkey rsa:2048 \e
	-keyout /etc/ssl/private/ca.key \e
	-out /etc/ssl/ca.crt
d659 9
@


1.112
log
@"r" logs to syslog; From: Anders Berggren
ok millert sthen
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.111 2012/09/25 13:58:00 otto Exp $
d33 1
a33 1
.Dd $Mdocdate: September 25 2012 $
d814 35
d850 2
a851 4
The ISAKMP/Oakley key management protocol is described in
RFC 2407, RFC 2408, and RFC 2409.
NAT-Traversal is described in RFC 3947.
This implementation was done in 1998 by Niklas Hallqvist and Niels Provos,
@


1.111
log
@lost preposition "in"
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.110 2012/08/24 14:49:21 jmc Exp $
d33 1
a33 1
.Dd $Mdocdate: August 24 2012 $
d497 2
a498 1
internal state to a file.
@


1.110
log
@ikev2 is described in rfc 5996 now;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.109 2011/09/29 17:57:09 jmc Exp $
d33 1
a33 1
.Dd $Mdocdate: September 29 2011 $
d817 1
a817 1
This implementation was done 1998 by Niklas Hallqvist and Niels Provos,
@


1.109
log
@ssl.8: Certifying Authority -> Certificate Authority
isakmpd.8: rsa:1024 -> rsa:2048 (ok markus)
all: X509 -> X.509

from Lawrence Teo
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.108 2011/06/06 08:05:05 jmc Exp $
d33 1
a33 1
.Dd $Mdocdate: June 6 2011 $
d75 1
a75 1
as defined in RFC 4306,
@


1.108
log
@some improvements for the text on packet capture; from Lawrence Teo
ok sthen
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.107 2010/06/07 08:38:09 jmc Exp $
d33 1
a33 1
.Dd $Mdocdate: June 7 2010 $
d559 2
a560 2
.It X509 Certificates:
X509 Certificates are used to authenticate.
d562 1
a562 1
.Sx X509 AUTHENTICATION
d631 2
a632 2
.Sh X509 AUTHENTICATION
X509 is a framework for public key certificates.
d648 1
a648 1
# openssl req -x509 -days 365 -newkey rsa:1024 \e
@


1.107
log
@make clearer the relationship between isakmpd and ikev1; and iked and ikev2;
ok reyk
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.106 2010/06/03 16:57:40 reyk Exp $
d33 1
a33 1
.Dd $Mdocdate: June 3 2010 $
d252 4
a255 3
will capture to file an unencrypted copy of the negotiation packets it
is sending and receiving.
This file can later be read by
d475 6
a480 1
should capture the packets to.
@


1.106
log
@update the manpages for isakmpd(8) and ipsec.conf(5) to point to iked(8)
for IKEv2 and to clarify that a) isakmpd is IKEv1/ISAKMP only and b) iked(8)
is IKEv2 only.  ISAKMP/IKEv1 support is currently not supported by iked(8)
and not worked on, but maybe in the future - I want to get IKEv2 support
first done right.  So keep on using isakmpd(8) for IKEv1 for now...

ok deraadt@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.105 2010/01/03 16:43:45 schwarze Exp $
d33 1
a33 1
.Dd $Mdocdate: January 3 2010 $
d74 1
a74 1
The IKEv2 protocol,
d77 1
a77 1
.Nm ;
d79 4
a82 2
.Xr iked 8
instead.
d803 1
a832 6
.Pp
The IKEv2 protocol is not supported by
.Nm ;
but by
.Xr iked 8
instead.
@


1.105
log
@Neither .Pp nor unqualified text are allowed at the top level of .Bl;
instead, .It is required.  Thus, move .Pp and text before the .Bl,
and remove the .Pp altogether where it is not needed.

Syntax errors found by mandoc(1), also required to fix the mandoc build;
feedback and ok jmc@@, and sobrado@@ also supports the direction.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.104 2007/05/31 19:19:45 jmc Exp $
d33 1
a33 1
.Dd $Mdocdate: May 31 2007 $
d38 1
a38 1
.Nd ISAKMP/Oakley a.k.a. IKE key management daemon
d71 11
d101 1
a101 1
For other uses, some more knowledge of IKE as a protocol is required.
d830 6
@


1.104
log
@convert to new .Dd format;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.103 2007/05/23 07:28:15 hshoexer Exp $
d33 1
a33 1
.Dd $Mdocdate$
d317 1
a318 1
.Pp
@


1.103
log
@Get rid of some obsolete exampels.

ok and prodding @@jmc
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.102 2007/05/07 01:50:46 joel Exp $
d33 1
a33 1
.Dd September 9, 2006
@


1.102
log
@Document "M active|passive" ui command.



ok jmc@@ mpf@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.101 2007/03/01 20:30:09 jmc Exp $
a763 4
.It /usr/share/ipsec/isakmpd/
A directory containing some sample
.Nm
and keynote policy configuration files.
@


1.101
log
@improve the description of -a. specifically, make it clear that
ipsec.conf users do not want to run isakmpd -a unless they are
messing with manual flows;

closes documentation/5399, from sthen
original diff and feedback from sthen

ok hshoexer
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.100 2006/12/05 14:29:14 jmc Exp $
d442 7
@


1.100
log
@some carp/sasyncd bits from msf and myself;
ok mpf
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.99 2006/11/30 11:24:49 markus Exp $
d120 3
a122 3
This is useful when flows are configured with
.Xr ipsecctl 8
or by other programs like
d126 1
a126 1
only takes care of the SA establishment.
@


1.99
log
@new ui command 'rmv': removes an entry from a list, thus reversing an
'add' operation; ok ho, hshoexer, jmc
eVS: ----------------------------------------------------------------------
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.98 2006/11/29 19:44:50 jmc Exp $
d86 4
d282 10
a291 1
When this option is given,
d293 2
a294 1
will not delete SAs on shutdown by sending delete messages to all peers.
d787 1
d810 6
@


1.98
log
@no need to document generation of local.key 3 times;
spotted by mcbride, ok hshoexer;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.97 2006/11/29 14:50:06 jmc Exp $
d314 8
d366 4
@


1.97
log
@zap trailing spaces;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.96 2006/11/29 07:27:55 mcbride Exp $
a551 6
By default, the system startup script
.Xr rc 8
generates a key-pair in
.Pa local.key
if it does not already exist, and the public key is extracted into
.Pa local.pub .
d564 3
a566 1
can authenticate using the pre-generated keys if the local public key
a611 6
By default, the system startup script
.Xr rc 8
generates a key-pair in
.Pa local.key
if it does not already exist, and the public key is extracted into
.Pa local.pub .
@


1.96
log
@Document the new location of local.pub, and clarify the fact that local.key
contains the entire keypair.

ok deraadt jmc
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.95 2006/11/28 09:27:09 markus Exp $
d556 1
a556 1
if it does not already exist, and the public key is extracted into 
d620 1
a620 1
if it does not already exist, and the public key is extracted into 
d728 1
a728 1
and a copy of the public key suitable for transferring to other hosts 
@


1.95
log
@do not re-add existing entries; ok hshoexer
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.94 2006/10/05 09:11:27 tom Exp $
d554 1
a554 2
generates a key-pair when starting, if one does not already exist.
The private and public keys are named
d556 2
a557 3
and
.Pa local.pub ,
respectively.
d618 1
a618 2
generates a key-pair when starting, if one does not already exist.
The private and public keys are named
d620 2
a621 3
and
.Pa local.pub ,
respectively.
d721 2
a722 2
The directory where local private keys for certificate-based authentication,
and their public key counterparts, are kept.
d726 5
a730 5
The private and public keys are named
.Pa local.key
and
.Pa local.pub ,
respectively.
@


1.94
log
@Reword sentence to fix grammar nit.

ok jmc@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.93 2006/09/09 07:52:04 jmc Exp $
d352 2
a353 1
appends a configuration value to the named configuration list tag.
@


1.93
log
@point people towards ipsec.conf.5; after some discussion w/ reyk
ok hshoexer reyk
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.92 2006/09/01 00:49:45 jmc Exp $
d87 1
a87 1
One source of information are the RFCs mentioned below.
@


1.92
log
@use shell-independent examples;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.91 2006/08/31 19:06:53 jmc Exp $
d33 1
a33 1
.Dd August 07, 2002
d63 7
d134 6
d771 1
@


1.91
log
@document an issue with subjectAltName found by reyk;
ok hshoexer ho reyk
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.90 2006/08/31 17:07:23 jmc Exp $
d634 2
a635 2
# setenv CERTIP 10.0.0.1
# openssl x509 -req -days 365 -in 10.0.0.1.csr \e
d643 2
a644 2
# setenv CERTFQDN somehost.somedomain
# openssl x509 -req -days 365 -in somehost.somedomain.csr \e
@


1.90
log
@remove a confusing sentence; ok hshoexer ho
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.89 2006/08/30 20:27:52 jmc Exp $
d649 11
@


1.89
log
@rewording; from reyk cloder hshoexer
ok ho
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.88 2006/08/30 16:56:56 hshoexer Exp $
a629 4
This field is not mandatory, but is highly recommended since it allows
.Nm
to avoid
spoofing attacks from users with valid certificates.
@


1.88
log
@Make SA deletion on shutdown the default again.  Use -S for failover
situations where you do not want this.

Discussed and agreed on with ho, mcbride, markus, cloder,...  We
will have to teach sasyncd to deal with this.

Testing by msf and hshoexer with help from mtu

ok markus cloder
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.87 2006/06/29 10:00:49 hshoexer Exp $
d633 1
a633 2
.Dq man in the middle
attacks.
@


1.87
log
@Document that pcap files can only be writen to the /var/run directory.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.86 2006/06/10 21:23:50 hshoexer Exp $
d267 1
a267 1
will delete SAs on shutdown by sending delete messages to all peers.
@


1.86
log
@Document -S and the "Delete-SAs" tag.  Those will enable SA deletion
on shutdown.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.85 2006/05/26 09:26:07 jmc Exp $
d232 3
@


1.85
log
@vpn.8 removal;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.84 2006/05/26 04:02:59 deraadt Exp $
d42 1
a42 1
.Op Fl 46adKLnTv
d261 4
@


1.84
log
@let us not talk about ipsecadm and vpn anymore; ok reyk
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.83 2005/09/23 14:45:25 hshoexer Exp $
a78 5
The
.Xr vpn 8
manual page describes how to set up
.Nm
for a simple VPN.
a480 3
See
.Xr vpn 8
for an example implementation.
d748 1
a748 2
.Xr tcpdump 8 ,
.Xr vpn 8
@


1.83
log
@Document new UI commands

ok and help jmc@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.82 2005/08/23 15:02:31 jmc Exp $
d115 1
a115 1
.Xr ipsecadm 8
d220 1
a220 1
.Xr ipsecadm 8
@


1.82
log
@note that RSA_SIG should be part of the "Transforms" tag when setting
up key- and cert-based authentication;

problem found by andrew fresh;
help/ok hshoexer@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.81 2005/06/04 17:22:42 hshoexer Exp $
d443 1
a443 1
Tear down all active connections.
d445 5
a449 1
.It Ic t Aq Ic name
d451 17
@


1.81
log
@Clarify that for -i/-R only paths beginning with /var/run are valid.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.80 2005/06/02 10:03:37 jmc Exp $
d484 14
@


1.80
log
@expand the section on pki:

- list different methods available
- document key-based method
- move x509-based into its own section
- add keynote stub section

ok hshoexer@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.79 2005/05/18 20:22:19 jmc Exp $
d209 3
d263 3
@


1.79
log
@remove certpatch(8) stuff;
ok hshoexer@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.78 2005/05/14 09:28:18 jmc Exp $
d275 1
a275 1
.Ss The FIFO user interface
d442 1
a442 1
.Ss Setting up an IKE public key infrastructure (a.k.a. PKI)
d448 2
a449 2
In the former case, what is needed to be done varies depending on the
actual Certificate Authority used, and is therefore not covered here,
d452 1
a452 1
needs to be used to create a certificate signing request that the
d454 84
a537 1
The latter case, however, is described here:
d589 6
a594 3
extension field has to be added
to the certificate in order to make it usable by
.Nm .
d633 10
a642 19
.Pp
It is also possible to store trusted public keys to make them directly
usable by
.Nm ,
bypassing the need to use X509 certificates.
The keys should be saved in PEM format (see
.Xr openssl 1 )
and named and stored after this easy formula:
.Pp
.Bl -tag -width "for_ufqdn_identitiesXX" -offset 3n -compact
.It For IPv4 identities:
/etc/isakmpd/pubkeys/ipv4/A.B.C.D
.It For IPv6 identities:
/etc/isakmpd/pubkeys/ipv6/abcd:abcd::ab:bc
.It For FQDN identities:
/etc/isakmpd/pubkeys/fqdn/foo.bar.org
.It For UFQDN identities:
/etc/isakmpd/pubkeys/ufqdn/user@@foo.bar.org
.El
@


1.78
log
@more logical section order;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.77 2005/05/14 09:25:51 jmc Exp $
a508 5
There are two possible ways to add the extensions to the certificate:
either run
.Xr certpatch 8
or make use of an OpenSSL configuration file, such as
.Pa /etc/ssl/x509v3.cnf .
a511 13
.Pp
To use
.Xr certpatch 8 ,
do the following:
.Bd -literal -offset indent
# openssl x509 -req -days 365 -in 10.0.0.1.csr \e
	-CA /etc/ssl/ca.crt -CAkey /etc/ssl/private/ca.key \e
	-CAcreateserial -out 10.0.0.1.crt
# certpatch -i 10.0.0.1 -k /etc/ssl/private/ca.key \e
	10.0.0.1.crt 10.0.0.1.crt
.Ed
.Pp
Otherwise do:
a528 11
Or with
.Xr certpatch 8 :
.Bd -literal -offset indent
# certpatch -t fqdn -i somehost.somedomain \e
	-k /etc/ssl/private/ca.key \e
	somehost.somedomain.crt somehost.somedomain.crt
.Ed
.Pp
(This assumes the previous steps were used to create a request for
somehost.somedomain instead of 10.0.0.1.)
.Pp
a636 1
.Xr certpatch 8 ,
@


1.77
log
@- openssl req can create self-signed certs in one step
- no need to encourage people to generate system keys: rc(8) already does it

ok hshoexer@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.76 2005/05/06 19:06:50 jmc Exp $
a274 153
.Ss Setting up an IKE public key infrastructure (a.k.a. PKI)
In order to use public key based authentication, there has to be an
infrastructure managing the key signing.
Either there is an already existing PKI
.Nm
should take part in, or there will be a need to set one up.
In the former case, what is needed to be done varies depending on the
actual Certificate Authority used, and is therefore not covered here,
other than mentioning that
.Xr openssl 1
needs to be used to create a certificate signing request that the
CA understands.
The latter case, however, is described here:
.Bl -enum
.It
Create your own Certificate Authority (CA).
.Pp
Create a self-signed root certificate.
The CA certificate is named
.Pa ca.crt ,
and its private key
.Pa ca.key :
.Bd -literal -offset indent
# openssl req -x509 -days 365 -newkey rsa:1024 \e
	-keyout /etc/ssl/private/ca.key \e
	-out /etc/ssl/ca.crt
.Ed
.Pp
.Ic openssl req
will prompt for information that will be incorporated
into the certificate request.
The information entered comprises a Distinguished Name (DN).
There are quite a few fields, but some can be left blank.
For some fields there will be a default value; if
.Sq \&.
is entered, the field will be left blank.
.It
Create Certificate Signing Requests (CSRs) for IKE peers.
The CSRs are signed with a pre-generated private key.
By default, the system startup script
.Xr rc 8
generates a key-pair when starting, if one does not already exist.
The private and public keys are named
.Pa local.key
and
.Pa local.pub ,
respectively.
.Pp
This step, as well as the next one, needs to be done for every peer.
Furthermore the last step will need to be done once for each ID you
want the peer to have.
The 10.0.0.1 below symbolizes that ID, in this case an IPv4 ID,
and should be changed for each invocation.
You will be asked for a DN for each run.
Encoding the ID in the common name is recommended, as it should be unique.
.Bd -literal -offset indent
# openssl req -new -key /etc/isakmpd/private/local.key \e
	-out /etc/isakmpd/private/10.0.0.1.csr
.Ed
.Pp
Now take these certificate signing requests to your CA and process
them as below.
A
.Em subjectAltName
extension field has to be added
to the certificate in order to make it usable by
.Nm .
There are two possible ways to add the extensions to the certificate:
either run
.Xr certpatch 8
or make use of an OpenSSL configuration file, such as
.Pa /etc/ssl/x509v3.cnf .
Replace 10.0.0.1 with the IP address which
.Nm
will use as the certificate identity.
.Pp
To use
.Xr certpatch 8 ,
do the following:
.Bd -literal -offset indent
# openssl x509 -req -days 365 -in 10.0.0.1.csr \e
	-CA /etc/ssl/ca.crt -CAkey /etc/ssl/private/ca.key \e
	-CAcreateserial -out 10.0.0.1.crt
# certpatch -i 10.0.0.1 -k /etc/ssl/private/ca.key \e
	10.0.0.1.crt 10.0.0.1.crt
.Ed
.Pp
Otherwise do:
.Bd -literal -offset indent
# setenv CERTIP 10.0.0.1
# openssl x509 -req -days 365 -in 10.0.0.1.csr \e
	-CA /etc/ssl/ca.crt -CAkey /etc/ssl/private/ca.key \e
	-CAcreateserial -extfile /etc/ssl/x509v3.cnf \e
	-extensions x509v3_IPAddr -out 10.0.0.1.crt
.Ed
.Pp
For a FQDN certificate, do:
.Bd -literal -offset indent
# setenv CERTFQDN somehost.somedomain
# openssl x509 -req -days 365 -in somehost.somedomain.csr \e
	-CA /etc/ssl/ca.crt -CAkey /etc/ssl/private/ca.key \e
	-CAcreateserial -extfile /etc/ssl/x509v3.cnf \e
	-extensions x509v3_FQDN -out somehost.somedomain.crt
.Ed
.Pp
Or with
.Xr certpatch 8 :
.Bd -literal -offset indent
# certpatch -t fqdn -i somehost.somedomain \e
	-k /etc/ssl/private/ca.key \e
	somehost.somedomain.crt somehost.somedomain.crt
.Ed
.Pp
(This assumes the previous steps were used to create a request for
somehost.somedomain instead of 10.0.0.1.)
.Pp
Put the certificate (the file ending in .crt) in
.Pa /etc/isakmpd/certs/
on your local system.
Also carry over the CA cert
.Pa /etc/ssl/ca.crt
and put it in
.Pa /etc/isakmpd/ca/ .
.El
.Pp
To revoke certificates, create a Certificate Revocation List (CRL) file
and install it in the
.Pa /etc/isakmpd/crls/
directory.
See
.Xr openssl 1
and the
.Sq crl
subcommand for more info.
.Pp
It is also possible to store trusted public keys to make them directly
usable by
.Nm ,
bypassing the need to use X509 certificates.
The keys should be saved in PEM format (see
.Xr openssl 1 )
and named and stored after this easy formula:
.Pp
.Bl -tag -width "for_ufqdn_identitiesXX" -offset 3n -compact
.It For IPv4 identities:
/etc/isakmpd/pubkeys/ipv4/A.B.C.D
.It For IPv6 identities:
/etc/isakmpd/pubkeys/ipv6/abcd:abcd::ab:bc
.It For FQDN identities:
/etc/isakmpd/pubkeys/fqdn/foo.bar.org
.It For UFQDN identities:
/etc/isakmpd/pubkeys/ufqdn/user@@foo.bar.org
.El
d441 153
@


1.76
log
@sync the CERTIP and CERTFQDN sections;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.75 2005/05/05 14:14:38 jmc Exp $
d292 5
a296 2
First, create a private key for the CA, and a Certificate Signing Request
(CSR) to enable the CA to sign its own key:
d298 3
a300 3
# openssl genrsa -out /etc/ssl/private/ca.key 1024
# openssl req -new -key /etc/ssl/private/ca.key \e
	-out /etc/ssl/private/ca.csr
d311 11
a322 11
After the CSR has been generated, it is used to create and sign
a certificate for the CA:
.Bd -literal -offset indent
# openssl x509 -req -days 365 -in /etc/ssl/private/ca.csr \e
	-signkey /etc/ssl/private/ca.key \e
	-extfile /etc/ssl/x509v3.cnf -extensions x509v3_CA \e
	-out /etc/ssl/ca.crt
.Ed
.Pp
.It
Create keys and CSRs for IKE peers.
a330 1
# openssl genrsa -out /etc/isakmpd/private/local.key 1024
@


1.75
log
@document /etc/isakmpd/pubkeys a little better;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.74 2005/05/05 14:05:51 jmc Exp $
d374 2
a375 3
	-CAcreateserial \e
	-extfile /etc/ssl/x509v3.cnf -extensions x509v3_FQDN \e
	-out somehost.somedomain.crt
@


1.74
log
@cleanup FIFO section;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.73 2005/05/05 12:09:35 jmc Exp $
d158 1
a158 1
.Bl -tag -width 2n -compact -offset indent
d411 2
a412 1
.Nm isakmpd .
@


1.73
log
@first stab at improving PKI section;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.72 2005/05/05 11:32:05 jmc Exp $
d435 36
a470 8
.It Ic "c <name>"
Start the named connection, if stopped or inactive.
.Pp
.It Ic "C set [section]:tag=value"
.It Ic "C set [section]:tag=value force"
.It Ic "C add [section]:tag=value"
.It Ic "C rm  [section]:tag"
.It Ic "C rms [section]"
d488 5
a492 2
NOTE: Sending isakmpd a SIGHUP or an "R" through the FIFO will
void any updates done to the configuration.
d494 8
a501 1
.It Ic "C get [section]:tag"
d506 33
a538 1
.It Ic "d <cookies> <msgid>"
d540 14
a553 12
Specify <msgid> as "-" to match a Phase 1 SA.
.Pp
.It Ic "D <class> <level>"
.It Ic "D A <level>"
.It Ic "D T"
Set debug class <class> to level <level>.
If <class> is specified as "A", the level applies to all debug classes.
"D T" toggles all debug classes to level zero.
Another "D T" command will toggle them back to the earlier levels.
.Pp
.It Ic "p on[=<path>]"
.It Ic "p off"
d559 1
a559 1
.It Ic "Q"
d564 8
a571 1
.It Ic "r"
d582 1
a582 8
.It Ic "R"
Reinitialize
.Nm isakmpd ,
as when sent a
.Dv SIGHUP
signal.
.Pp
.It Ic "S"
d587 4
a590 1
.It Ic "t <name>"
a591 3
.Pp
.It Ic "T"
Tear down all active connections.
@


1.72
log
@improve FILES;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.71 2005/04/10 14:17:49 jmc Exp $
d290 4
a293 1
Create your own CA as root.
d300 11
a310 7
You are then asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name (DN).
There are quite a few fields but you can leave some blank.
For some fields there will be a default value; if you enter
.Sq \&. ,
the field will be left blank.
d319 1
a319 1
Create keys and certificates for your IKE peers.
d334 4
a337 2
them like below.
You have to add a subjectAltName extension field
d339 3
a341 3
.Nm isakmpd .
There are two possible ways to add the extensions to the certificate.
Either run
d343 1
a343 1
or make use of an OpenSSL configuration file, for example
@


1.71
log
@- sort synopsis + options list
- sync usage()
- tidy up lists and displays
- misc tweaks
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.70 2005/04/08 22:32:10 cloder Exp $
d514 4
a517 4
.It Pa /etc/isakmpd/ca/
The directory where CA certificates can be found.
.It Pa /etc/isakmpd/certs/
The directory where IKE certificates can be found, both the local
d520 3
a522 3
.It Pa /etc/isakmpd/crls/
The directory where CRLs can be found.
.It Pa /etc/isakmpd/isakmpd.conf
d526 2
a527 2
.Nm isakmpd .
.It Pa /etc/isakmpd/isakmpd.policy
d531 22
a552 8
.It Pa /etc/isakmpd/private/local.key
A local private key for certificate based authentication.
There has to be a certificate for this key in the certificate directory
mentioned above.
The same mode requirements as
.Nm isakmpd.conf .
.It Pa /etc/isakmpd/pubkeys/
Directory in which trusted public keys can be kept.
d554 5
a558 3
.It Pa /var/run/isakmpd.pid
The PID of the current daemon.
.It Pa /var/run/isakmpd.fifo
d561 1
a561 1
.It Pa /var/run/isakmpd.pcap
d563 3
a565 1
.It Pa /var/run/isakmpd.report
d569 1
a569 1
.It Pa /var/run/isakmpd.result
a574 4
.It Pa /usr/share/ipsec/isakmpd/
A directory containing some sample
.Nm
and keynote policy configuration files.
@


1.70
log
@Make deterministic randomness (only ever used for testing) a compile-time
option.  Reduces chances of somehow setting regrand when it's not supposed
to be set.  Remove "-r" option from man page.  Also xref certpatch(8) while
we are in there.  And remove some include sysdep.h where it is no longer
needed.
OK hshoexer
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.69 2005/04/05 21:32:13 jmc Exp $
d42 1
a42 2
.Op Fl 4
.Op Fl 6
d44 4
a47 3
.Op Fl a
.Op Fl d
.Op Fl D Ar class=level
d50 1
a50 1
.Op Fl n
a52 3
.Op Fl K
.Op Fl L
.Op Fl l Ar packetlog-file
a53 2
.Op Fl T
.Op Fl v
d78 1
a78 2
will be to implement so called "virtual private
networks" or VPNs for short.
d95 2
a96 2
and PKI information and binds to privileged ports on its behalf.
See
d102 1
a102 1
.It Fl 4 | Fl 6
d132 1
a132 7
.It Fl d
The
.Fl d
option is used to make the daemon run in the foreground, logging to stderr.
.It Xo Fl D
.Ar class Ns = Ns Ar level
.Xc
d146 1
a146 1
limit debug printouts at (i.e., all debug printouts above the level specified
d188 4
a208 14
.It Fl n
When the
.Fl n
option is given, the kernel will not take part in the negotiations.
This is a non-destructive mode, so to speak, in that it won't alter any
SAs in the IPsec stack.
.It Fl N Ar udpencap-port
The
.Fl N
option specifies the listen port for encapsulated udp the daemon will bind to.
.It Fl p Ar listen-port
The
.Fl p
option specifies the listen port the daemon will bind to.
d234 15
d291 1
a291 1
.Bd -literal
d304 1
a304 1
.Bd -literal
d313 1
a313 1
This step as well as the next one, needs to be done for every peer.
d320 1
a320 1
.Bd -literal
d332 1
a332 1
Either you have to run
d334 1
a334 1
or you have to make use of an OpenSSL configuration file, for example
d336 1
a336 1
Replace 10.0.0.1 with the IP-address which
d342 5
a346 5
do the following
.Bd -literal
# openssl x509 -req -days 365 -in 10.0.0.1.csr -CA /etc/ssl/ca.crt \e
	-CAkey /etc/ssl/private/ca.key -CAcreateserial \e
	-out 10.0.0.1.crt
d351 2
a352 2
Otherwise do
.Bd -literal
d354 4
a357 4
# openssl x509 -req -days 365 -in 10.0.0.1.csr -CA /etc/ssl/ca.crt \e
	-CAkey /etc/ssl/private/ca.key -CAcreateserial \e
	-extfile /etc/ssl/x509v3.cnf -extensions x509v3_IPAddr \e
	-out 10.0.0.1.crt
d360 2
a361 2
For a FQDN certificate, do
.Bd -literal
d370 3
a372 3
or with
.Xr certpatch 8
.Bd -literal
d379 1
a379 1
somehost.somedomain instead of 10.0.0.1)
d406 3
a408 2
.Bl -tag -width for_ufqdn_identities
.It For IPv4 identities
d410 1
a410 1
.It For IPv6 identities
d412 1
a412 1
.It For FQDN identities
d414 1
a414 1
.It For UFQDN identities
d438 1
a438 1
sets a configuration value consisting of a section, tag and value triplet.
d487 1
a487 1
See
d513 1
a513 1
.Bl -tag -width /etc/isakmpd/private/local.
d530 1
a530 1
.Nm isakmpd.conf .
d574 3
a576 7
The ISAKMP/Oakley key management protocol is described in the RFCs
.%T RFC 2407 ,
.%T RFC 2408
and
.%T RFC 2409 .
NAT-Traversal is described in
.%T RFC 3947 .
d582 1
a582 1
form of address representation, i.e "::" instead of ":0:0:0:",
@


1.69
log
@ipsecadm lives in section 8, not 4;
missing word;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.68 2005/04/05 18:06:05 cloder Exp $
a55 1
.Op Fl r Ar seed
a255 3
.It Fl r Ar seed
If given, a deterministic random number sequence will be used internally.
This is useful for setting up regression tests.
d575 1
@


1.68
log
@Add -T flag to isakmpd to disable NAT-T support from the command line.
This lets binat setups work again without having to recompile isakmpd.
OK ho, hshoexer.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.67 2005/02/25 14:14:31 hshoexer Exp $
d122 1
a122 1
.Xr ipsecadm 4
d272 1
a272 1
When this option is given, NAT-Traversal will disabled and
@


1.67
log
@Zap -P option.  It has never done anything.  While there tweak descripton of
-N.

zap -P ok ho@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.66 2005/02/24 13:55:51 hshoexer Exp $
d58 1
d271 4
d588 2
@


1.66
log
@Add -N switch to select port for udpencap.  Thus it's possible to run multiple
isakmpds on different ports specified with -p and -N.

ok ho@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.65 2004/07/08 10:37:12 jmc Exp $
d51 1
a51 1
.Op Fl N
a52 1
.Op Fl P Ar local-port
a230 5
.It Fl P Ar local-port
On the other hand, the port specified to capital
.Fl P
will be what the daemon binds its local end to when acting as
initiator.
a598 4
.Sh BUGS
The
.Fl P
flag does not do what we document, rather it does nothing.
@


1.65
log
@typo, and line adjustment;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.64 2004/07/07 22:25:39 hshoexer Exp $
d51 1
d224 4
@


1.64
log
@document -a/-K and "Acquire-Only"/"Use-Keynote".

ok markus@@ henning@@ ho@@
english polish and mdoc help and ok jmc@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.63 2004/05/13 06:56:34 ho Exp $
d461 2
a462 2
Get the configuration value of the specified section and tag. The
result is stored in
@


1.63
log
@Extensions to the FIFO interface:
"C get [section]:tag" fetches a configuration value.
"C add [section]:tag=value" adds 'value' to a list, typically for the
[Phase 2]:Connections tag. FIFO "S" command destination file changed.
Various KNF cleanups. hshoexer@@ ok.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.62 2004/04/15 00:27:40 deraadt Exp $
d45 1
d53 1
d116 11
d232 11
@


1.62
log
@spaces
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.61 2004/03/24 16:44:24 hshoexer Exp $
d413 1
d426 2
d433 8
d485 1
a485 1
.Pa /var/run/isakmpd_sa
d533 1
a533 1
.It Pa /var/run/isakmpd_sa
d536 2
@


1.61
log
@Add some notes about privsep to manpage.

ok ho@@ jmc@@ deraadt@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.60 2004/01/23 23:08:46 jmc Exp $
d100 1
a100 1
See 
@


1.60
log
@`Ns' implies `No', so `Ns No' -> `Ns'; (even simpler in adduser(8))
discussed with todd@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.59 2004/01/16 10:51:57 hshoexer Exp $
d91 13
d558 5
@


1.59
log
@Added -v option.  Enables logging of successful exchange completion.
ok ho@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.58 2003/11/20 11:23:01 jmc Exp $
d117 1
a117 1
.Ar class Ns No = Ns Ar level
d122 1
a122 1
.Ar class Ns No = Ns Ar level ,
@


1.58
log
@use .Dv for AF_INET and AF_INET6 (kills ugly line break);
spotted by Alexey E. Suslikov;

also kill some .Pp's before displays/lists for better PostScript output;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.57 2003/10/25 07:47:28 jmc Exp $
d56 1
d234 10
@


1.57
log
@receiveing -> receiving; from Jared Yanovich;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.56 2003/10/13 13:57:51 ho Exp $
d93 4
a96 1
These options control what address family (AF_INET and/or AF_INET6)
a246 1
.Pp
a249 1
.Pp
a262 1
.Pp
a278 1
.Pp
@


1.56
log
@Add a UI FIFO debug class. ok markus@@ plus I think henning@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.55 2003/08/20 12:25:02 ho Exp $
d207 1
a207 1
is sending and receiveing.
@


1.55
log
@certpatch(8) can be used to create FQDN X509v3 extensions too.
From Fridtjof Busse, via henning@@. Thanks.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.54 2003/08/09 08:45:58 jmc Exp $
d140 1
a140 1
.Bl -tag -width 1n -compact -offset indent
d161 2
@


1.54
log
@new sentence, new line + small cleanup;
ok ho@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.53 2003/06/04 07:31:17 ho Exp $
d326 8
@


1.53
log
@Remove the rest of clauses 3 and 4. Approved by Niklas Hallqvist, Angelos
D. Keromytis and Niels Provos.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.52 2003/06/03 13:16:08 jmc Exp $
d95 2
a96 1
will use. Default is to use both IPv4 and IPv6.
d105 3
a107 1
will reread the configuration file when sent a SIGHUP signal.
d132 2
a133 1
is set to 'A',
d249 1
a249 1
# openssl req -new -key /etc/ssl/private/ca.key \\
d257 3
a259 2
For some fields there will be a default value; if you enter '.', the field
will be left blank.
d262 3
a264 3
# openssl x509 -req -days 365 -in /etc/ssl/private/ca.csr \\
	-signkey /etc/ssl/private/ca.key \\
	-extfile /etc/ssl/x509v3.cnf -extensions x509v3_CA \\
d280 1
a280 1
# openssl req -new -key /etc/isakmpd/private/local.key \\
d302 2
a303 2
# openssl x509 -req -days 365 -in 10.0.0.1.csr -CA /etc/ssl/ca.crt \\
	-CAkey /etc/ssl/private/ca.key -CAcreateserial \\
d305 1
a305 1
# certpatch -i 10.0.0.1 -k /etc/ssl/private/ca.key \\
d312 3
a314 3
# openssl x509 -req -days 365 -in 10.0.0.1.csr -CA /etc/ssl/ca.crt \\
	-CAkey /etc/ssl/private/ca.key -CAcreateserial \\
	-extfile /etc/ssl/x509v3.cnf -extensions x509v3_IPAddr \\
d321 4
a324 4
# openssl x509 -req -days 365 -in somehost.somedomain.csr \\
	-CA /etc/ssl/ca.crt -CAkey /etc/ssl/private/ca.key \\
	-CAcreateserial \\
	-extfile /etc/ssl/x509v3.cnf -extensions x509v3_FQDN \\
d343 2
a344 1
directory. See
d346 3
a348 1
and the 'crl' subcommand for more info.
d370 3
a372 2
requests. All commands start with a single letter, followed by
command-specific options. Available commands are:
d384 12
a395 5
configuration atomically. 'set' sets a configuration value consisting
of a section, tag and value triplet. 'set' will fail if the
configuration already contains a section with the named tag, use
the 'force' option to change this behaviour. 'rm' removes a tag in a
section. 'rms' removes an entire section.
d398 2
a399 2
Delete the specified SA from the system. Specify <msgid> as "-" to match a
Phase 1 SA.
d404 2
a405 2
Set debug class <class> to level <level>. If <class> is specified as
"A", the level applies to all debug classes.
d411 2
a412 2
Enable or disable cleartext IKE packet capture. When enabling,
optionally specify which file
d417 3
a419 1
Cleanly shutdown the daemon, as when sent a SIGTERM signal.
d424 2
a425 1
internal state to a file. See
d427 4
a430 1
option. Same as when sent a SIGUSR1 signal.
d435 3
a437 1
as when sent a SIGHUP signal.
d490 3
a492 1
The report file written when the 'S' command is issued in the command FIFO.
@


1.52
log
@- section reorder
- some mdoc fixes
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.51 2003/05/10 21:13:41 jmc Exp $
a16 5
.\" 3. All advertising materials mentioning features or use of this software
.\"    must display the following acknowledgement:
.\"	This product includes software developed by Ericsson Radio Systems.
.\" 4. The name of the author may not be used to endorse or promote products
.\"    derived from this software without specific prior written permission.
@


1.51
log
@typos;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.50 2003/04/27 11:17:14 ho Exp $
a362 1
.Pp
a430 13
.Sh BUGS
The
.Fl P
flag does not do what we document, rather it does nothing.
.Sh CAVEATS
When storing a trusted public key for an IPv6 identity, the
.Em most efficient
form of address representation, i.e "::" instead of ":0:0:0:",
must be used or the matching will fail.
.Nm
uses the output from
.Xr getnameinfo 3
for the address-to-name translation.
d495 13
@


1.50
log
@Describe the 'C set' FIFO command better. (PR#3148, also)
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.49 2003/02/22 06:56:20 kjell Exp $
d235 1
a235 1
should take part in, or there will be a need to setup one.
d384 1
a384 1
the 'force' option to change this behaviour. 'rm' removes a tag in a 
@


1.49
log
@Clarify some language, grammar. ho@@ okayed this many moons ago,
and I forgot all about it.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.48 2003/02/05 10:29:49 jmc Exp $
d376 1
d382 3
a384 1
of a section, tag and value triplet. 'rm' removes a tag in a
@


1.48
log
@typos; isakmpd(8) ok niklas@@, mailwrapper(8) help kjell@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.47 2002/12/03 20:05:10 ho Exp $
d286 2
a287 2
You have to add some extensions to the certificate in order to make it
usable for
@


1.47
log
@Add -4/-6 cmdline options to select what address family (IPv4,v6) to use.
niklas@@ ok.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.46 2002/11/27 14:36:20 ho Exp $
d46 1
d61 1
d75 1
a75 1
and by listening for different events that triggers these negotiations.
d78 1
a78 1
consists of negotiation initiations from a remote party, user input via
d89 1
a89 1
manual page describes how to setup
d118 1
a118 1
This argument is possible to specify many times.
d120 1
a120 1
.Ar class Ns No = Ns Ar level
d190 1
a190 1
This is a non-destructive mode so to say, in that it won't alter any
d216 1
a216 1
If given a deterministic random number sequence will be used internally.
d222 1
a222 1
.Dv SIGUSR1
d238 1
a238 1
more than mentioning that
d242 1
a242 1
The latter case however is described here:
d254 1
a254 1
You are now being asked to enter information that will be incorporated
d256 1
a256 1
What you are about to enter is what is called a Distinguished Name or a DN.
d258 1
a258 1
For some fields there will be a default value, if you enter '.', the field
d290 1
a290 1
Either you have to to run
d337 1
a337 1
.Pa /etc/isakmpd/ca/.
d341 1
a341 1
and install it to the
d404 1
a404 1
Cleanly shutdown of the daemon, as when sent a SIGTERM signal.
d469 1
a469 1
The keys must be named after a fashion described above.
@


1.46
log
@Update document date.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.45 2002/11/09 02:22:33 fgsch Exp $
d46 2
d95 4
@


1.45
log
@more SEE ALSO fixes.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.44 2002/11/09 00:57:20 fgsch Exp $
d38 1
a38 1
.Dd July 31, 1998
@


1.44
log
@SEE ALSO reordering and corrections.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.42 2002/08/07 13:19:20 ho Exp $
d482 2
a486 2
.Xr getnameinfo 3 ,
.Xr pcap 3 ,
@


1.43
log
@remove Xr to photuris
@
text
@d481 1
a485 1
.Xr openssl 1 ,
@


1.42
log
@A rewrite of the CRL support code, also from <Thomas.Walpuski@@gmx.net>.
Some style mods, and checks added for OpenSSL version 0.9.7 or later.
Currently CRLs are not supported for earlier versions.
Manual pages updated.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.41 2002/08/02 13:27:22 ho Exp $
a486 1
.Xr photurisd 8 ,
@


1.41
log
@Mention CRL support, tag and default value.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.40 2002/06/09 08:13:06 todd Exp $
d333 3
a335 3
and install it to
.Pa /etc/isakmpd/crl.pem .
See
d442 2
a443 2
.It Pa /etc/isakmpd/crl.pem
A list of revoked certificates.
@


1.40
log
@rm trailing whitespace
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.39 2002/04/10 20:56:28 ho Exp $
d332 7
d442 2
@


1.39
log
@Document the FIFO ui. deraadt@@ ok.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.38 2002/03/17 21:49:26 angelos Exp $
d378 1
a378 1
"D T" toggles all debug classes to level zero. 
d396 1
a396 1
option. Same as when sent a SIGUSR1 signal. 
@


1.38
log
@Mention isakmpd_sa file.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.37 2001/12/21 11:41:50 mpech Exp $
d7 1
a7 1
.\" Copyright (c) 2001 Håkan Olsson.  All rights reserved.
d347 66
@


1.37
log
@Initial patch for a new mdoc issue.
Powered by @@mantoya:
o) kill extra line in the end of file;
o) kill extra space in the end of line;
o) replace blank lines with .Pp;

millert@@ ok
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.36 2001/12/13 20:16:48 mpech Exp $
d398 2
@


1.36
log
@o) start new sentence on a new line;
o) wrap long lines;
o) fix bogus .Xr usage;
o) we don't like blank lines;
o) always close .Bl tags;
o) OpenBSD -> .Ox;
o) don't like .Pp before .Ss;

millert@@ ok;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.35 2001/12/10 04:06:45 ho Exp $
d79 1
a79 1
Most uses of 
d85 1
a85 1
manual page describes how to setup 
d195 1
a195 1
When this option is given, 
d199 1
a199 1
This file can later be read by 
d201 1
a201 1
and other utilities using 
d335 1
a335 1
The keys should be saved in PEM format (see 
d353 1
a353 1
When storing a trusted public key for an IPv6 identity, the 
d356 1
a356 1
must be used or the matching will fail. 
d399 2
a400 2
A directory containing some sample 
.Nm 
@


1.35
log
@Add example on how to create FQDN certificates suitable for use with isakmpd. Requires an FQDN addition to /etc/ssl/x509v3.cnf
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.34 2001/12/10 03:45:03 ho Exp $
d62 2
a63 2
and/or authenticated network traffic.  At this moment,
and probably forever, this means
d82 2
a83 1
networks" or VPNs for short.  The
d87 3
a89 3
for a simple VPN.  For other
uses, some more knowledge of IKE as a protocol is required.  One source
of information are the RFCs mentioned below.
d194 2
a195 1
Enable IKE packet capture. When this option is given, 
d198 2
a199 1
is sending and receiveing. This file can later be read by 
d224 2
a225 2
infrastructure managing the key signing.  Either there is an already
existing PKI
d227 4
a230 4
should take part in, or there will be a need to setup one.  In the former
case, what is needed to be done varies depending on the actual Certificate
Authority used, and is therefore not covered here, more than
mentioning that
d233 2
a234 1
CA understands.  The latter case however is described here:
d247 5
a251 4
into your certificate request.  What you are about to enter is what is
called a Distinguished Name or a DN.  There are quite a few fields but
you can leave some blank.  For some fields there will be a default
value, if you enter '.', the field will be left blank.
d261 8
a268 7
Create keys and certificates for your IKE peers.  This step as well
as the next one, needs to be done for every peer.  Furthermore the
last step will need to be done once for each ID you want the peer
to have.  The 10.0.0.1 below symbolizes that ID, in this case an IPv4 ID,
and should be changed for each invocation.  You will be asked for a DN
for each run.  Encoding the ID in the common name is recommended, as
it should be unique.
d277 3
a279 2
them like below.  You have to add some extensions to the certificate
in order to make it usable for 
d325 2
a326 1
on your local system.  Also carry over the CA cert
d370 2
a371 1
The configuration file. As this file can contain sensitive information
d375 2
a376 2
The keynote policy configuration file.  The same mode 
requirements as
d379 4
a382 3
A local private key for certificate based authentication.  There has
to be a certificate for this key in the certificate directory mentioned
above.  The same mode requirements as
d385 2
a386 2
Directory in which trusted public keys can be kept. The keys must be
named after a fashion described above.
@


1.34
log
@Mention that SIGHUP will cause isakmpd to reread isakmpd.conf
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.33 2001/08/31 12:22:19 ho Exp $
d259 4
a262 4
to have.  The 10.0.0.1 below symbolizes that ID, and should be
changed for each invocation.  You will be asked for a DN for each
run too.  See to encode the ID in the common name too, so it gets
unique.
d281 1
a281 1
will be using for identity.
d283 2
a284 2
For using
.Xr certpach 8 ,
d302 13
@


1.33
log
@(c)-2001
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.32 2001/08/30 09:03:18 ho Exp $
d99 2
@


1.32
log
@Mention which debug levels we currently use.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.31 2001/08/23 18:14:16 niklas Exp $
d7 1
@


1.31
log
@RSA-enabling is not necessary anymore.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.30 2001/08/15 09:16:29 ho Exp $
d153 4
@


1.30
log
@Support trusted public (RSA) keys as files too. niklas@@ ok.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.29 2001/07/20 18:07:11 mpech Exp $
d4 2
a5 1
.\" Copyright (c) 1998, 1999 Niklas Hallqvist.  All rights reserved.
a225 7
.It
An RSA-enabled
.Pa libcrypto
(see
.Xr crypto 3 )
needs to be installed.  This is described in
.Xr ssl 8 .
@


1.29
log
@we don't like:
o) .Pp before/after .Sh;
o) .Pp before/after .Rs/.Re;
o) .Nm without argument in SYNOPSIS;
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.28 2001/06/27 03:31:42 angelos Exp $
d220 1
a220 1
.Xr openssl 8
d309 17
d330 9
d360 3
d383 2
a384 1
.Xr openssl 8 ,
@


1.28
log
@Consistently use "IPsec" capitalization (jsyn@@nthought.com)
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.27 2001/05/24 15:59:30 ho Exp $
d43 1
a43 1
.Nm 
@


1.27
log
@Add isakmpd.pid to the FILES section.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.26 2001/04/30 14:38:12 ho Exp $
d174 1
a174 1
SAs in the IPSEC stack.
@


1.26
log
@Mention the sample configuration directory. Cleanup some .Nm usage.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.25 2001/04/30 12:51:13 provos Exp $
d334 2
@


1.25
log
@mention how to generate extended attributes for certs with openssl;
from tim newsham; okay niklas@@ ho@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.24 2001/04/09 21:21:57 ho Exp $
d43 1
a43 1
.Nm isakmpd
d77 3
a79 1
Most uses of isakmpd will be to implement so called "virtual private
d82 3
a84 1
manual page describes how to setup isakmpd for a simple VPN.  For other
d271 3
a273 2
in order to make it usable for isakmpd.  There are two
possible ways to add the extensions to the certificate.
d298 1
a298 1
        -extfile /etc/ssl/x509v3.cnf -extensions x509v3_IPAddr \\
d314 1
a314 1
.Bl -tag -width /var/run/isakmpd.report
d323 2
a324 1
it must not be readable by anyone but the user running isakmpd.
d326 3
a328 2
The keynote policy configuration file. Same mode requirements as
for isakmpd.conf.
d332 2
a333 1
above. Same mode requirements as isakmpd.conf.
d343 4
@


1.24
log
@isakmpd can now capture un-encrypted IKE negotiation packets to a
file. In pcap(3) format, so tcpdump(8) can read it.
Idea by Tim Newsham <newsham@@lava.net>, work by him and me.
Ok angelos@@, niklas@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.23 2001/04/05 23:31:05 ho Exp $
d246 1
d267 6
a272 3
in order to make it usable for isakmpd, which is why you will need
to run
.Xr certpatch 8 .
d277 3
d286 9
@


1.23
log
@Also mention mode requirements for the private key file, plus one less typo.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.22 2001/04/05 23:22:57 ho Exp $
d52 2
d178 14
a191 1
will be what the daemon binds its local end to when acting as initiator.
d313 2
d325 1
d328 1
@


1.22
log
@Be more clear about configuration file mode requirements.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.21 2001/03/13 14:05:18 ho Exp $
d293 2
a294 2
to be a certificate for this key in the cerifcate directory mentioned
above.
@


1.21
log
@Add logging classes for Negotiation and Policy, and change a number of
debug messages to use these instead. Change a number of 'log_print'
to debug messages to keep the noise down. Use 'log_error' instead of
'log_print' in some cases when we have errno. Some indentation fixes.
(niklas@@ ok)
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.20 2000/12/12 05:01:01 todd Exp $
d286 2
a287 1
The configuration file.
d289 2
a290 1
The keynote policy configuration file.
@


1.20
log
@enumerate debugging number meanings; ok angelos@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.19 2000/05/02 14:36:51 niklas Exp $
d139 4
@


1.19
log
@Merge with EOM 1.23

author: niklas
Describe PKI setup

author: ho
Mention requirement for config file owner and mode.

author: niklas
save pid in a pidfile, based on code from Lawrence A. Wimble.  Also retry
to dlopen libcrypto after SIGHUP, useful if /usr was mounted in between.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.18 2000/04/07 22:23:14 niklas Exp $
d46 1
a46 1
.Op Fl D Ar debug-class=level
d96 1
a96 1
.Ar debug-class Ns No = Ns Ar level
d98 1
d117 25
@


1.19.4.1
log
@Pull in isakmpd from 2.9 to 2.8 branch.
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.26 2001/04/30 14:38:12 ho Exp $
d43 1
a43 1
.Nm 
d46 1
a46 1
.Op Fl D Ar class=level
a51 2
.Op Fl L
.Op Fl l Ar packetlog-file
d75 1
a75 3
Most uses of 
.Nm
will be to implement so called "virtual private
d78 1
a78 3
manual page describes how to setup 
.Nm
for a simple VPN.  For other
d96 1
a96 1
.Ar class Ns No = Ns Ar level
a97 1
Debugging class.
a115 29
.Pp
Valid values for
.Ar class
are as follows:
.Pp
.Bl -tag -width 1n -compact -offset indent
.It 0
Misc
.It 1
Transport
.It 2
Message
.It 3
Crypto
.It 4
Timer
.It 5
Sysdep
.It 6
SA
.It 7
Exchange
.It 8
Negotiation
.It 9
Policy
.It A
All
.El
d146 1
a146 14
will be what the daemon binds its local end to when acting as
initiator.
.It Fl L
Enable IKE packet capture. When this option is given, 
.Nm
will capture to file an unencrypted copy of the negotiation packets it
is sending and receiveing. This file can later be read by 
.Xr tcpdump 8
and other utilities using 
.Xr pcap 3 .
.It Fl l Ar packetlog-file
As option
.Fl L
above, but capture to a specified file.
a200 1
	-extfile /etc/ssl/x509v3.cnf -extensions x509v3_CA \\
d221 3
a223 7
in order to make it usable for 
.Nm isakmpd .
There are two possible ways to add the extensions to the certificate.
Either you have to to run
.Xr certpatch 8
or you have to make use of an OpenSSL configuration file, for example
.Pa /etc/ssl/x509v3.cnf .
a227 3
For using
.Xr certpach 8 ,
do the following
a235 9
Otherwise do
.Bd -literal
# setenv CERTIP 10.0.0.1
# openssl x509 -req -days 365 -in 10.0.0.1.csr -CA /etc/ssl/ca.crt \\
	-CAkey /etc/ssl/private/ca.key -CAcreateserial \\
	-extfile /etc/ssl/x509v3.cnf -extensions x509v3_IPAddr \\
	-out 10.0.0.1.crt
.Ed
.Pp
d248 1
a248 1
.Bl -tag -width /etc/isakmpd/private/local.
d256 1
a256 3
The configuration file. As this file can contain sensitive information
it must not be readable by anyone but the user running
.Nm isakmpd .
d258 1
a258 3
The keynote policy configuration file.  The same mode 
requirements as
.Nm isakmpd.conf .
d261 2
a262 3
to be a certificate for this key in the certificate directory mentioned
above.  The same mode requirements as
.Nm isakmpd.conf .
a265 2
.It Pa /var/run/isakmpd.pcap
The default IKE packet capture file.
a269 4
.It Pa /usr/share/ipsec/isakmpd/
A directory containing some sample 
.Nm 
and keynote policy configuration files.
a275 1
.Xr pcap 3 ,
a277 1
.Xr tcpdump 8 ,
@


1.18
log
@apps/certpatch/certpatch.8: Merge with EOM 1.5
isakmpd.8: Merge with EOM 1.20
isakmpd.conf.5: Merge with EOM 1.40
isakmpd.policy.5: Merge with EOM 1.13

author: niklas
Changes from OpenBSD
@
text
@d1 2
a2 2
.\" $OpenBSD: isakmpd.8,v 1.17 2000/03/18 22:55:59 aaron Exp $
.\" $EOM: isakmpd.8,v 1.20 2000/04/07 22:17:11 niklas Exp $
d41 1
a41 1
.Nd ISAKMP/Oakley aka IKE key management daemon
d48 1
d58 4
a61 1
and/or authenticated network traffic.
d63 18
a80 5
The daemon listens to a named pipe
.Pa isakmpd.fifo
for user requests and on a
.Dv PF_ENCAP
socket for kernel requests.
d89 2
d127 6
d162 81
d249 6
d256 7
a262 1
The configuration file
d265 1
a265 1
.Nm isakmpd
d267 3
a269 1
The report file
d275 4
a278 1
.Xr photurisd 8
@


1.17
log
@Remove hard sentence breaks, and some other cleanup along the way.
@
text
@d1 2
a2 2
.\" $OpenBSD: isakmpd.8,v 1.16 2000/02/01 02:46:18 niklas Exp $
.\" $EOM: isakmpd.8,v 1.19 2000/01/31 22:33:46 niklas Exp $
@


1.16
log
@apps/certpatch/certpatch.8: Merge with EOM 1.4
apps/certpatch/certpatch.c: Merge with EOM 1.6
exchange.c: Merge with EOM 1.114
ike_quick_mode.c: Merge with EOM 1.110
ike_phase_1.c: Merge with EOM 1.16
ike_auth.c: Merge with EOM 1.41
ike_aggressive.c: Merge with EOM 1.4
libcrypto.c: Merge with EOM 1.10
libcrypto.h: Merge with EOM 1.10
isakmpd.8: Merge with EOM 1.19
isakmpd.c: Merge with EOM 1.42
ipsec.h: Merge with EOM 1.40
init.c: Merge with EOM 1.22
message.c: Merge with EOM 1.143
message.h: Merge with EOM 1.49
sa.c: Merge with EOM 1.98
sa.h: Merge with EOM 1.54
policy.c: Merge with EOM 1.14
pf_key_v2.c: Merge with EOM 1.36
x509.c: Merge with EOM 1.32
x509.h: Merge with EOM 1.9
udp.c: Merge with EOM 1.46

author: niklas
Angelos copyrights
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.15 2000/01/26 15:22:30 niklas Exp $
d79 2
a80 2
This argument is possible to specify many times.  It takes a parameter of
the form
d92 2
a93 1
will not output anything). If
d103 2
a104 1
user requests.  If the path given is a dash
@


1.15
log
@Merge with EOM 1.18
@
text
@d1 2
a2 2
.\" $OpenBSD: isakmpd.8,v 1.14 1999/10/17 19:35:23 aaron Exp $
.\" $EOM: isakmpd.8,v 1.18 1999/10/10 21:46:50 angelos Exp $
d5 1
@


1.14
log
@Few fixes.
@
text
@d1 2
a2 2
.\" $OpenBSD: isakmpd.8,v 1.13 1999/10/01 14:09:20 niklas Exp $
.\" $EOM: isakmpd.8,v 1.17 1999/09/20 19:57:50 angelos Exp $
d67 3
a69 1
Specifies an alternate configuration file instead of the default
d72 3
a74 1
Cause the daemon run in the foreground, logging to stderr.
d93 1
a93 2
is set to
.Sq A ,
d96 3
a98 1
Specifies the
d106 3
a108 1
Cause the kernel to not take part in the negotiations.
d110 1
a110 1
SAs in the IPsec stack.
d112 3
a114 3
Specifies the port
.Nm
will bind to.
d139 1
a139 1
.Bl -tag -width /etc/isakmpd/isakmpd.conf -compact
d141 1
a141 1
configuration file
d143 1
a143 1
FIFO used to manually control
d146 1
a146 1
report file
d151 1
@


1.13
log
@isakmpd.8: Merge with EOM 1.17
isakmpd.c: Merge with EOM 1.38

author: angelos
Allow "-DA=xx" to mean "set all debug classes to level xx"
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.12 1999/07/18 20:13:39 niklas Exp $
d67 1
a67 3
If given, the
.Fl c
option specifies an alternate configuration file instead of
d70 1
a70 3
The
.Fl d
option is used to make the daemon run in the foreground, logging to stderr.
d89 2
a90 1
is set to 'A',
d93 1
a93 3
The
.Fl f
option specifies the
d101 1
a101 3
When the
.Fl n
option is given, the kernel will not take part in the negotiations.
d103 1
a103 1
SAs in the IPSEC stack.
d105 3
a107 3
The
.Fl p
option specifies the listen port the daemon will bind to.
d132 1
a132 1
.Bl -tag -width /var/run/isakmpd.report
d134 1
a134 1
The configuration file
d136 1
a136 1
The FIFO used to manually control
d139 1
a139 1
The report file
@


1.12
log
@Merge with EOM 1.16

author: niklas
1999
@
text
@d1 2
a2 2
.\" $OpenBSD: isakmpd.8,v 1.11 1999/07/18 09:33:21 niklas Exp $
.\" $EOM: isakmpd.8,v 1.16 1999/07/18 20:12:12 niklas Exp $
d91 4
a94 1
will not output anything).
@


1.11
log
@conf.h: Merge with EOM 1.9
isakmpd.8: Merge with EOM 1.15

author: niklas
Moving /etc/isakmpd.conf to /etc/isakmpd/isakmpd.conf.
@
text
@d1 2
a2 2
.\" $OpenBSD: isakmpd.8,v 1.10 1999/07/07 22:08:10 niklas Exp $
.\" $EOM: isakmpd.8,v 1.15 1999/07/18 09:20:27 niklas Exp $
d4 1
a4 1
.\" Copyright (c) 1998 Niklas Hallqvist.  All rights reserved.
@


1.10
log
@isakmpd.8: Merge with EOM 1.14
pf_key_v2.c: Merge with EOM 1.17

author: niklas
Merge in fixes done in the OpenBSD tree
@
text
@d1 2
a2 2
.\" $OpenBSD: isakmpd.8,v 1.9 1999/07/03 02:11:07 aaron Exp $
.\" $EOM: isakmpd.8,v 1.14 1999/07/07 19:17:30 niklas Exp $
d70 1
a70 1
.Pa /etc/isakmpd.conf .
d137 1
a137 1
.It Pa /etc/isakmpd.conf
@


1.9
log
@remove redundant .Pp macros
@
text
@d1 2
a2 2
.\" $OpenBSD: isakmpd.8,v 1.8 1999/06/04 02:45:22 aaron Exp $
.\" $EOM: isakmpd.8,v 1.13 1998/12/21 00:09:36 niklas Exp $
@


1.8
log
@start to remove non-escaped trailing whitespace, it can confuse troff; pjanzen@@
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.7 1999/05/28 23:00:02 aaron Exp $
a130 1
.Pp
@


1.7
log
@more .El madness
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.6 1998/12/21 01:02:25 niklas Exp $
d56 1
a56 1
and/or authenticated network traffic. 
d58 1
a58 1
The daemon listens to a named pipe 
@


1.6
log
@Last months worth of work on isakmpd, lots done
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.5 1998/12/15 01:20:42 aaron Exp $
d95 3
a97 1
option specifies the FIFO (a.k.a. named pipe) where the daemon listens for
d122 3
a124 2
a SIGUSR1 it will report its internal state to a report file,
normally
d145 1
@


1.5
log
@always give .Nm macros an argument in SYNOPSIS sections; krw@@tcn.net
@
text
@d1 2
a2 2
.\" $OpenBSD: isakmpd.8,v 1.4 1998/11/28 19:56:32 aaron Exp $
.\" $EOM: isakmpd.8,v 1.8 1998/10/10 17:28:13 niklas Exp $
d51 1
a105 3
.It Fl r Ar seed
If given a deterministic random number sequence will be used internally.
This is useful for setting up regression tests.
d114 13
d129 13
d147 3
a149 3
The ISAKMP/Oakley key management protocol is described in the Internet drafts
.%T draft-ietf-ipsec-isakmp ,
.%T draft-ietf-ipsec-ipsec-doi
d151 1
a151 1
.%T draft-ietf-ipsec-isakmp-oakley .
a153 1

@


1.4
log
@kill redundant .Nm macro arguments; other misc fixes
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.3 1998/11/17 11:10:15 niklas Exp $
d42 1
a42 1
.Nm
@


1.3
log
@Add RCS Ids from the EOM repository
@
text
@d1 1
a1 1
.\" $OpenBSD: isakmpd.8,v 1.2 1998/11/15 00:43:57 niklas Exp $
d42 1
a42 1
.Nm isakmpd
d53 1
a53 1
.Nm ISAKMP
d60 1
a60 1
.Nm PF_ENCAP
d65 1
a65 1
.It Fl c
d74 3
a76 1
.It Fl D
d78 14
a91 5
the form: class=level where both class and level are numbers.  Class denotes
a debugging class, and level the level you want that debugging class to
limit debug printouts at.  I.e. all debug printouts above the level specified
will not output anything.
.It Fl f
d94 4
a97 3
option specifies the fifo (aka named pipe) where the daemon listens for
user requests.  If the path given is a dash,
.Nm isakmpd
d105 1
a105 1
.It Fl r
d108 1
a108 1
.It Fl p
d112 2
a113 2
.It Fl P
On the other hand, the port spcified to capital
d119 1
d121 1
a121 2
.Xr photurisd 8 ,
.Xr ipsec 4 .
d123 5
a127 4
The ISAKMP/Oakley keymanagement protocol is described in the internet drafts
.Nm draft-ietf-ipsec-isakmp ,
.Nm draft-ietf-ipsec-ipsec-doi &
.Nm draft-ietf-ipsec-isakmp-oakley .
@


1.2
log
@openBSD RCS IDs
@
text
@d1 2
a2 1
.\" $OpenBSD: isakmpd.8,v 1.1.1.1 1998/11/15 00:03:48 niklas Exp $
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
.\" $Id: isakmpd.8,v 1.8 1998/10/10 17:28:13 niklas Exp $
@


1.1.1.1
log
@Initial import of isakmpd, an IKE (ISAKMP/Oakley) implementation for the
OpenBSD IPSEC stack by me, Niklas Hallqvist and Niels Provos, funded by
Ericsson Radio Systems.  It is not yet complete or usable in a real scenario
but the missing pieces will soon be there.  The early commit is for people
who wants early access and who are not afraid of looking at source.
isakmpd interops with Cisco, Timestep, SSH & Pluto (Linux FreeS/WAN) so
far, so it is not that incomplete.  It is really mostly configuration that
is lacking.
@
text
@@
