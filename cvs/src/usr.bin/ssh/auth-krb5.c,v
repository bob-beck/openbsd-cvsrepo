head	1.22;
access;
symbols
	OPENBSD_6_2:1.22.0.2
	OPENBSD_6_2_BASE:1.22
	OPENBSD_6_1:1.22.0.6
	OPENBSD_6_1_BASE:1.22
	OPENBSD_6_0:1.22.0.4
	OPENBSD_6_0_BASE:1.22
	OPENBSD_5_9:1.21.0.2
	OPENBSD_5_9_BASE:1.21
	OPENBSD_5_8:1.20.0.10
	OPENBSD_5_8_BASE:1.20
	OPENBSD_5_7:1.20.0.4
	OPENBSD_5_7_BASE:1.20
	OPENBSD_5_6:1.20.0.8
	OPENBSD_5_6_BASE:1.20
	OPENBSD_5_5:1.20.0.6
	OPENBSD_5_5_BASE:1.20
	OPENBSD_5_4:1.20.0.2
	OPENBSD_5_4_BASE:1.20
	OPENBSD_5_3:1.19.0.28
	OPENBSD_5_3_BASE:1.19
	OPENBSD_5_2:1.19.0.26
	OPENBSD_5_2_BASE:1.19
	OPENBSD_5_1_BASE:1.19
	OPENBSD_5_1:1.19.0.24
	OPENBSD_5_0:1.19.0.22
	OPENBSD_5_0_BASE:1.19
	OPENBSD_4_9:1.19.0.20
	OPENBSD_4_9_BASE:1.19
	OPENBSD_4_8:1.19.0.18
	OPENBSD_4_8_BASE:1.19
	OPENBSD_4_7:1.19.0.14
	OPENBSD_4_7_BASE:1.19
	OPENBSD_4_6:1.19.0.16
	OPENBSD_4_6_BASE:1.19
	OPENBSD_4_5:1.19.0.12
	OPENBSD_4_5_BASE:1.19
	OPENBSD_4_4:1.19.0.10
	OPENBSD_4_4_BASE:1.19
	OPENBSD_4_3:1.19.0.8
	OPENBSD_4_3_BASE:1.19
	OPENBSD_4_2:1.19.0.6
	OPENBSD_4_2_BASE:1.19
	OPENBSD_4_1:1.19.0.2
	OPENBSD_4_1_BASE:1.19
	OPENBSD_4_0:1.19.0.4
	OPENBSD_4_0_BASE:1.19
	OPENBSD_3_9:1.16.0.2
	OPENBSD_3_9_BASE:1.16
	OPENBSD_3_8:1.15.0.8
	OPENBSD_3_8_BASE:1.15
	OPENBSD_3_7:1.15.0.6
	OPENBSD_3_7_BASE:1.15
	OPENBSD_3_6:1.15.0.4
	OPENBSD_3_6_BASE:1.15
	OPENBSD_3_5:1.15.0.2
	OPENBSD_3_5_BASE:1.15
	OPENBSD_3_4:1.12.0.2
	OPENBSD_3_4_BASE:1.12
	OPENBSD_3_3:1.10.0.2
	OPENBSD_3_3_BASE:1.10
	OPENBSD_3_2:1.9.0.2
	OPENBSD_3_2_BASE:1.9
	OPENBSD_3_1:1.8.0.2
	OPENBSD_3_1_BASE:1.8
	OPENBSD_3_0:1.1.0.6
	OPENBSD_3_0_BASE:1.1
	OPENBSD_2_9:1.1.0.4
	OPENBSD_2_8:1.1.0.2;
locks; strict;
comment	@ * @;


1.22
date	2016.05.04.14.22.33;	author markus;	state Exp;
branches;
next	1.21;
commitid	hyxgmNlwF7h4Eao2;

1.21
date	2016.01.27.06.44.58;	author djm;	state Exp;
branches;
next	1.20;
commitid	m7SD7bd0vPOsEPK9;

1.20
date	2013.07.20.01.55.13;	author djm;	state Exp;
branches;
next	1.19;

1.19
date	2006.08.03.03.34.41;	author deraadt;	state Exp;
branches;
next	1.18;

1.18
date	2006.05.06.08.35.40;	author dtucker;	state Exp;
branches;
next	1.17;

1.17
date	2006.03.19.18.51.18;	author deraadt;	state Exp;
branches;
next	1.16;

1.16
date	2005.11.21.09.42.10;	author dtucker;	state Exp;
branches
	1.16.2.1;
next	1.15;

1.15
date	2003.11.21.11.57.02;	author djm;	state Exp;
branches
	1.15.6.1
	1.15.8.1;
next	1.14;

1.14
date	2003.11.04.08.54.09;	author djm;	state Exp;
branches;
next	1.13;

1.13
date	2003.09.23.20.17.11;	author markus;	state Exp;
branches;
next	1.12;

1.12
date	2003.08.28.12.54.34;	author markus;	state Exp;
branches
	1.12.2.1;
next	1.11;

1.11
date	2003.07.16.15.02.06;	author markus;	state Exp;
branches;
next	1.10;

1.10
date	2002.11.21.23.03.51;	author deraadt;	state Exp;
branches
	1.10.2.1;
next	1.9;

1.9
date	2002.09.09.06.48.06;	author itojun;	state Exp;
branches
	1.9.2.1;
next	1.8;

1.8
date	2002.03.19.10.49.35;	author markus;	state Exp;
branches
	1.8.2.1;
next	1.7;

1.7
date	2002.03.16.17.41.25;	author stevesk;	state Exp;
branches;
next	1.6;

1.6
date	2002.03.04.17.27.39;	author stevesk;	state Exp;
branches;
next	1.5;

1.5
date	2002.02.15.23.54.10;	author markus;	state Exp;
branches;
next	1.4;

1.4
date	2002.01.27.15.12.09;	author markus;	state Exp;
branches;
next	1.3;

1.3
date	2001.12.19.07.18.56;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	2001.11.12.01.47.09;	author dugsong;	state Exp;
branches;
next	1.1;

1.1
date	2001.06.26.16.15.23;	author dugsong;	state Exp;
branches
	1.1.2.1
	1.1.4.1
	1.1.6.1;
next	;

1.1.2.1
date	2001.09.27.18.27.43;	author miod;	state Exp;
branches;
next	1.1.2.2;

1.1.2.2
date	2001.11.15.22.50.30;	author miod;	state Exp;
branches;
next	1.1.2.3;

1.1.2.3
date	2002.03.08.17.04.41;	author brad;	state Exp;
branches;
next	;

1.1.4.1
date	2001.09.27.19.03.54;	author jason;	state Exp;
branches;
next	1.1.4.2;

1.1.4.2
date	2001.11.15.22.51.15;	author miod;	state Exp;
branches;
next	1.1.4.3;

1.1.4.3
date	2002.03.09.00.20.43;	author miod;	state Exp;
branches;
next	1.1.4.4;

1.1.4.4
date	2002.06.02.22.56.09;	author miod;	state Exp;
branches;
next	;

1.1.6.1
date	2001.11.14.03.24.38;	author jason;	state Exp;
branches;
next	1.1.6.2;

1.1.6.2
date	2002.03.07.17.37.46;	author jason;	state Exp;
branches;
next	1.1.6.3;

1.1.6.3
date	2002.05.17.00.03.23;	author miod;	state Exp;
branches;
next	1.1.6.4;

1.1.6.4
date	2002.10.11.14.53.06;	author miod;	state Exp;
branches;
next	;

1.8.2.1
date	2002.10.11.14.51.51;	author miod;	state Exp;
branches;
next	1.8.2.2;

1.8.2.2
date	2003.04.03.22.35.16;	author miod;	state Exp;
branches;
next	;

1.9.2.1
date	2003.04.01.00.12.13;	author margarida;	state Exp;
branches;
next	1.9.2.2;

1.9.2.2
date	2003.09.16.21.20.24;	author brad;	state Exp;
branches;
next	;

1.10.2.1
date	2003.09.16.20.50.42;	author brad;	state Exp;
branches;
next	1.10.2.2;

1.10.2.2
date	2004.03.04.18.18.15;	author brad;	state Exp;
branches;
next	;

1.12.2.1
date	2004.02.28.03.51.32;	author brad;	state Exp;
branches;
next	;

1.15.6.1
date	2006.02.03.02.53.44;	author brad;	state Exp;
branches;
next	;

1.15.8.1
date	2006.02.03.03.01.55;	author brad;	state Exp;
branches;
next	1.15.8.2;

1.15.8.2
date	2006.10.06.03.19.32;	author brad;	state Exp;
branches;
next	;

1.16.2.1
date	2006.09.30.04.06.50;	author brad;	state Exp;
branches;
next	;


desc
@@


1.22
log
@move SSH_MSG_NONE, so we don't have to include ssh1.h; ok deraadt@@
@
text
@/* $OpenBSD: auth-krb5.c,v 1.21 2016/01/27 06:44:58 djm Exp $ */
/*
 *    Kerberos v5 authentication and ticket-passing routines.
 *
 * From: FreeBSD: src/crypto/openssh/auth-krb5.c,v 1.6 2001/02/13 16:58:04 assar
 */
/*
 * Copyright (c) 2002 Daniel Kouril.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

#include <sys/types.h>
#include <pwd.h>
#include <stdarg.h>

#include "xmalloc.h"
#include "ssh.h"
#include "packet.h"
#include "log.h"
#include "buffer.h"
#include "servconf.h"
#include "uidswap.h"
#include "key.h"
#include "hostfile.h"
#include "auth.h"

#ifdef KRB5
#include <krb5.h>

extern ServerOptions	 options;

static int
krb5_init(void *context)
{
	Authctxt *authctxt = (Authctxt *)context;
	krb5_error_code problem;

	if (authctxt->krb5_ctx == NULL) {
		problem = krb5_init_context(&authctxt->krb5_ctx);
		if (problem)
			return (problem);
		krb5_init_ets(authctxt->krb5_ctx);
	}
	return (0);
}

int
auth_krb5_password(Authctxt *authctxt, const char *password)
{
	krb5_error_code problem;
	krb5_ccache ccache = NULL;
	const char *errmsg;

	temporarily_use_uid(authctxt->pw);

	problem = krb5_init(authctxt);
	if (problem)
		goto out;

	problem = krb5_parse_name(authctxt->krb5_ctx, authctxt->pw->pw_name,
		    &authctxt->krb5_user);
	if (problem)
		goto out;

	problem = krb5_cc_new_unique(authctxt->krb5_ctx,
	     krb5_mcc_ops.prefix, NULL, &ccache);
	if (problem)
		goto out;

	problem = krb5_cc_initialize(authctxt->krb5_ctx, ccache,
		authctxt->krb5_user);
	if (problem)
		goto out;

	restore_uid();

	problem = krb5_verify_user(authctxt->krb5_ctx, authctxt->krb5_user,
	    ccache, password, 1, NULL);

	temporarily_use_uid(authctxt->pw);

	if (problem)
		goto out;

	problem = krb5_cc_new_unique(authctxt->krb5_ctx,
	     krb5_fcc_ops.prefix, NULL, &authctxt->krb5_fwd_ccache);
	if (problem)
		goto out;

	problem = krb5_cc_copy_cache(authctxt->krb5_ctx, ccache,
	    authctxt->krb5_fwd_ccache);
	krb5_cc_destroy(authctxt->krb5_ctx, ccache);
	ccache = NULL;
	if (problem)
		goto out;

	authctxt->krb5_ticket_file = (char *)krb5_cc_get_name(authctxt->krb5_ctx,
	    authctxt->krb5_fwd_ccache);

 out:
	restore_uid();

	if (problem) {
		if (ccache)
			krb5_cc_destroy(authctxt->krb5_ctx, ccache);

		if (authctxt->krb5_ctx != NULL) {
			errmsg = krb5_get_error_message(authctxt->krb5_ctx,
			    problem);
			debug("Kerberos password authentication failed: %s",
			    errmsg);
			krb5_free_error_message(authctxt->krb5_ctx, errmsg);
		} else
			debug("Kerberos password authentication failed: %d",
			    problem);

		krb5_cleanup_proc(authctxt);

		if (options.kerberos_or_local_passwd)
			return (-1);
		else
			return (0);
	}
	return (authctxt->valid ? 1 : 0);
}

void
krb5_cleanup_proc(Authctxt *authctxt)
{
	debug("krb5_cleanup_proc called");
	if (authctxt->krb5_fwd_ccache) {
		krb5_cc_destroy(authctxt->krb5_ctx, authctxt->krb5_fwd_ccache);
		authctxt->krb5_fwd_ccache = NULL;
	}
	if (authctxt->krb5_user) {
		krb5_free_principal(authctxt->krb5_ctx, authctxt->krb5_user);
		authctxt->krb5_user = NULL;
	}
	if (authctxt->krb5_ctx) {
		krb5_free_context(authctxt->krb5_ctx);
		authctxt->krb5_ctx = NULL;
	}
}

#endif /* KRB5 */
@


1.21
log
@change old $FreeBSD version string in comment so it doesn't become an
RCS ident downstream; requested by des AT des.no
@
text
@d1 1
a1 1
/* $OpenBSD: auth-krb5.c,v 1.20 2013/07/20 01:55:13 djm Exp $ */
a36 1
#include "ssh1.h"
@


1.20
log
@fix kerberos/GSSAPI deprecation warnings and linking; "looks okay" millert@@
@
text
@d1 1
a1 1
/* $OpenBSD: auth-krb5.c,v 1.19 2006/08/03 03:34:41 deraadt Exp $ */
d5 1
a5 1
 * $FreeBSD: src/crypto/openssh/auth-krb5.c,v 1.6 2001/02/13 16:58:04 assar Exp $
@


1.19
log
@almost entirely get rid of the culture of ".h files that include .h files"
ok djm, sort of ok stevesk
makes the pain stop in one easy step
@
text
@d1 1
a1 1
/* $OpenBSD: auth-krb5.c,v 1.18 2006/05/06 08:35:40 dtucker Exp $ */
d72 1
d85 2
a86 1
	problem = krb5_cc_gen_new(authctxt->krb5_ctx, &krb5_mcc_ops, &ccache);
d105 2
a106 2
	problem = krb5_cc_gen_new(authctxt->krb5_ctx, &krb5_fcc_ops,
	    &authctxt->krb5_fwd_ccache);
d127 3
a129 1
		if (authctxt->krb5_ctx != NULL)
d131 3
a133 2
			    krb5_get_err_text(authctxt->krb5_ctx, problem));
		else
@


1.18
log
@Add $OpenBSD$ in comment here too
@
text
@d1 1
a1 1
/* $OpenBSD$ */
d31 3
a33 1
#include "includes.h"
d35 1
a38 1
#include "xmalloc.h"
d40 1
d43 2
@


1.17
log
@RCSID() can die
@
text
@d1 1
@


1.16
log
@Perform Kerberos calls even for invalid users to prevent leaking information
about account validity.  bz #975, patch originally from Senthil Kumar,
sanity checked by Simon Wilkinson, tested by djm@@, biorn@@, ok markus@@
@
text
@a30 1
RCSID("$OpenBSD: auth-krb5.c,v 1.15 2003/11/21 11:57:02 djm Exp $");
@


1.16.2.1
log
@upgrade to OpenSSH 4.4
@
text
@a0 1
/* $OpenBSD: auth-krb5.c,v 1.19 2006/08/03 03:34:41 deraadt Exp $ */
d30 2
a31 3
#include <sys/types.h>
#include <pwd.h>
#include <stdarg.h>
a32 1
#include "xmalloc.h"
d36 1
a37 1
#include "buffer.h"
a39 2
#include "key.h"
#include "hostfile.h"
@


1.15
log
@unexpand and delete whitespace at EOL; ok markus@@
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.14 2003/11/04 08:54:09 djm Exp $");
a67 3
	if (!authctxt->valid)
		return (0);

d134 1
a134 1
	return (1);
@


1.15.8.1
log
@upgrade to OpenSSH 4.3
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.16 2005/11/21 09:42:10 dtucker Exp $");
d68 3
d137 1
a137 1
	return (authctxt->valid ? 1 : 0);
@


1.15.8.2
log
@upgrade to OpenSSH 4.4
@
text
@a0 1
/* $OpenBSD: auth-krb5.c,v 1.19 2006/08/03 03:34:41 deraadt Exp $ */
d30 2
a31 3
#include <sys/types.h>
#include <pwd.h>
#include <stdarg.h>
a32 1
#include "xmalloc.h"
d36 1
a37 1
#include "buffer.h"
a39 2
#include "key.h"
#include "hostfile.h"
@


1.15.6.1
log
@upgrade to OpenSSH 4.3
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.16 2005/11/21 09:42:10 dtucker Exp $");
d68 3
d137 1
a137 1
	return (authctxt->valid ? 1 : 0);
@


1.14
log
@standardise arguments to auth methods - they should all take authctxt.
check authctxt->valid rather then pw != NULL; ok markus@@
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.13 2003/09/23 20:17:11 markus Exp $");
d86 1
a86 1
	problem = krb5_cc_initialize(authctxt->krb5_ctx, ccache, 
d101 1
a101 1
	problem = krb5_cc_gen_new(authctxt->krb5_ctx, &krb5_fcc_ops, 
@


1.13
log
@replace fatal_cleanup() and linked list of fatal callbacks with static
cleanup_exit() function.  re-refine cleanup_exit() where appropriate,
allocate sshd's authctxt eary to allow simpler cleanup in sshd.
tested by many, ok deraadt@@
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.12 2003/08/28 12:54:34 markus Exp $");
d68 1
a68 1
	if (authctxt->pw == NULL)
@


1.12
log
@remove kerberos support from ssh1, since it has been replaced with GSSAPI;
but keep kerberos passwd auth for ssh1 and 2; ok djm, hin, henning, ...
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.11 2003/07/16 15:02:06 markus Exp $");
a51 1
	static int cleanup_registered = 0;
a58 4
	if (!cleanup_registered) {
		fatal_add_cleanup(krb5_cleanup_proc, authctxt);
		cleanup_registered = 1;
	}
d141 1
a141 1
krb5_cleanup_proc(void *context)
a142 2
	Authctxt *authctxt = (Authctxt *)context;

@


1.12.2.1
log
@upgrade to OpenSSH 3.8
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.15 2003/11/21 11:57:02 djm Exp $");
d52 1
d60 4
d73 1
a73 1
	if (!authctxt->valid)
d91 1
a91 1
	problem = krb5_cc_initialize(authctxt->krb5_ctx, ccache,
d106 1
a106 1
	problem = krb5_cc_gen_new(authctxt->krb5_ctx, &krb5_fcc_ops,
d146 1
a146 1
krb5_cleanup_proc(Authctxt *authctxt)
d148 2
@


1.11
log
@mcc -> fcc; from Love Hörnquist Åstrand <lha@@it.su.se>
otherwise the kerberos credentinal is stored in a memory cache
in the privileged sshd. ok jabob@@, hin@@ (some time ago)
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.10 2002/11/21 23:03:51 deraadt Exp $");
a66 140
/*
 * Try krb5 authentication. server_user is passed for logging purposes
 * only, in auth is received ticket, in client is returned principal
 * from the ticket
 */
int
auth_krb5(Authctxt *authctxt, krb5_data *auth, char **client, krb5_data *reply)
{
	krb5_error_code problem;
	krb5_principal server;
	krb5_ticket *ticket;
	int fd, ret;

	ret = 0;
	server = NULL;
	ticket = NULL;
	reply->length = 0;

	problem = krb5_init(authctxt);
	if (problem)
		goto err;

	problem = krb5_auth_con_init(authctxt->krb5_ctx,
	    &authctxt->krb5_auth_ctx);
	if (problem)
		goto err;

	fd = packet_get_connection_in();
	problem = krb5_auth_con_setaddrs_from_fd(authctxt->krb5_ctx,
	    authctxt->krb5_auth_ctx, &fd);
	if (problem)
		goto err;

	problem = krb5_sname_to_principal(authctxt->krb5_ctx, NULL, NULL,
	    KRB5_NT_SRV_HST, &server);
	if (problem)
		goto err;

	problem = krb5_rd_req(authctxt->krb5_ctx, &authctxt->krb5_auth_ctx,
	    auth, server, NULL, NULL, &ticket);
	if (problem)
		goto err;

	problem = krb5_copy_principal(authctxt->krb5_ctx, ticket->client,
	    &authctxt->krb5_user);
	if (problem)
		goto err;

	/* if client wants mutual auth */
	problem = krb5_mk_rep(authctxt->krb5_ctx, authctxt->krb5_auth_ctx,
	    reply);
	if (problem)
		goto err;

	/* Check .k5login authorization now. */
	if (!krb5_kuserok(authctxt->krb5_ctx, authctxt->krb5_user,
	    authctxt->pw->pw_name))
		goto err;

	if (client)
		krb5_unparse_name(authctxt->krb5_ctx, authctxt->krb5_user,
		    client);

	ret = 1;
 err:
	if (server)
		krb5_free_principal(authctxt->krb5_ctx, server);
	if (ticket)
		krb5_free_ticket(authctxt->krb5_ctx, ticket);
	if (!ret && reply->length) {
		xfree(reply->data);
		memset(reply, 0, sizeof(*reply));
	}

	if (problem) {
		if (authctxt->krb5_ctx != NULL)
			debug("Kerberos v5 authentication failed: %s",
			    krb5_get_err_text(authctxt->krb5_ctx, problem));
		else
			debug("Kerberos v5 authentication failed: %d",
			    problem);
	}

	return (ret);
}

int
auth_krb5_tgt(Authctxt *authctxt, krb5_data *tgt)
{
	krb5_error_code problem;
	krb5_ccache ccache = NULL;
	char *pname;

	if (authctxt->pw == NULL || authctxt->krb5_user == NULL)
		return (0);

	temporarily_use_uid(authctxt->pw);

	problem = krb5_cc_gen_new(authctxt->krb5_ctx, &krb5_fcc_ops, &ccache);
	if (problem)
		goto fail;

	problem = krb5_cc_initialize(authctxt->krb5_ctx, ccache,
	    authctxt->krb5_user);
	if (problem)
		goto fail;

	problem = krb5_rd_cred2(authctxt->krb5_ctx, authctxt->krb5_auth_ctx,
	    ccache, tgt);
	if (problem)
		goto fail;

	authctxt->krb5_fwd_ccache = ccache;
	ccache = NULL;

	authctxt->krb5_ticket_file = (char *)krb5_cc_get_name(authctxt->krb5_ctx, authctxt->krb5_fwd_ccache);

	problem = krb5_unparse_name(authctxt->krb5_ctx, authctxt->krb5_user,
	    &pname);
	if (problem)
		goto fail;

	debug("Kerberos v5 TGT accepted (%s)", pname);

	restore_uid();

	return (1);

 fail:
	if (problem)
		debug("Kerberos v5 TGT passing failed: %s",
		    krb5_get_err_text(authctxt->krb5_ctx, problem));
	if (ccache)
		krb5_cc_destroy(authctxt->krb5_ctx, ccache);

	restore_uid();

	return (0);
}

d118 2
a119 1
	authctxt->krb5_ticket_file = (char *)krb5_cc_get_name(authctxt->krb5_ctx, authctxt->krb5_fwd_ccache);
a157 5
	}
	if (authctxt->krb5_auth_ctx) {
		krb5_auth_con_free(authctxt->krb5_ctx,
		    authctxt->krb5_auth_ctx);
		authctxt->krb5_auth_ctx = NULL;
@


1.10
log
@KNF
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.9 2002/09/09 06:48:06 itojun Exp $");
d211 1
d227 1
a227 2
	problem = krb5_cc_gen_new(authctxt->krb5_ctx, &krb5_mcc_ops,
	    &authctxt->krb5_fwd_ccache);
d231 2
a232 2
	problem = krb5_cc_initialize(authctxt->krb5_ctx,
	    authctxt->krb5_fwd_ccache, authctxt->krb5_user);
d237 1
d239 2
a240 1
	    authctxt->krb5_fwd_ccache, password, 1, NULL);
d246 12
d264 3
@


1.10.2.1
log
@upgrade to OpenSSH 3.7
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.12 2003/08/28 12:54:34 markus Exp $");
d67 140
a210 1
	krb5_ccache ccache = NULL;
d226 2
a227 1
	problem = krb5_cc_gen_new(authctxt->krb5_ctx, &krb5_mcc_ops, &ccache);
d231 2
a232 2
	problem = krb5_cc_initialize(authctxt->krb5_ctx, ccache, 
		authctxt->krb5_user);
a236 1

d238 1
a238 2
	    ccache, password, 1, NULL);

d244 1
a244 14
	problem = krb5_cc_gen_new(authctxt->krb5_ctx, &krb5_fcc_ops, 
	    &authctxt->krb5_fwd_ccache);
	if (problem)
		goto out;

	problem = krb5_cc_copy_cache(authctxt->krb5_ctx, ccache,
	    authctxt->krb5_fwd_ccache);
	krb5_cc_destroy(authctxt->krb5_ctx, ccache);
	ccache = NULL;
	if (problem)
		goto out;

	authctxt->krb5_ticket_file = (char *)krb5_cc_get_name(authctxt->krb5_ctx,
	    authctxt->krb5_fwd_ccache);
a249 3
		if (ccache)
			krb5_cc_destroy(authctxt->krb5_ctx, ccache);

d280 5
@


1.10.2.2
log
@upgrade to OpenSSH 3.8upgrade to OpenSSH 3.8upgrade to OpenSSH 3.8
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.15 2003/11/21 11:57:02 djm Exp $");
d52 1
d60 4
d73 1
a73 1
	if (!authctxt->valid)
d91 1
a91 1
	problem = krb5_cc_initialize(authctxt->krb5_ctx, ccache,
d106 1
a106 1
	problem = krb5_cc_gen_new(authctxt->krb5_ctx, &krb5_fcc_ops,
d146 1
a146 1
krb5_cleanup_proc(Authctxt *authctxt)
d148 2
@


1.9
log
@kerberos support for privsep.  confirmed to work by lha@@stacken.kth.se
patch from markus
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.8 2002/03/19 10:49:35 markus Exp $");
d100 1
a100 1
	problem = krb5_sname_to_principal(authctxt->krb5_ctx,  NULL, NULL ,
@


1.9.2.1
log
@Update to OpenSSH 3.6
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.10 2002/11/21 23:03:51 deraadt Exp $");
d100 1
a100 1
	problem = krb5_sname_to_principal(authctxt->krb5_ctx, NULL, NULL,
@


1.9.2.2
log
@upgrade to OpenSSH 3.7
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.12 2003/08/28 12:54:34 markus Exp $");
d67 140
a210 1
	krb5_ccache ccache = NULL;
d226 2
a227 1
	problem = krb5_cc_gen_new(authctxt->krb5_ctx, &krb5_mcc_ops, &ccache);
d231 2
a232 2
	problem = krb5_cc_initialize(authctxt->krb5_ctx, ccache, 
		authctxt->krb5_user);
a236 1

d238 1
a238 2
	    ccache, password, 1, NULL);

d244 1
a244 14
	problem = krb5_cc_gen_new(authctxt->krb5_ctx, &krb5_fcc_ops, 
	    &authctxt->krb5_fwd_ccache);
	if (problem)
		goto out;

	problem = krb5_cc_copy_cache(authctxt->krb5_ctx, ccache,
	    authctxt->krb5_fwd_ccache);
	krb5_cc_destroy(authctxt->krb5_ctx, ccache);
	ccache = NULL;
	if (problem)
		goto out;

	authctxt->krb5_ticket_file = (char *)krb5_cc_get_name(authctxt->krb5_ctx,
	    authctxt->krb5_fwd_ccache);
a249 3
		if (ccache)
			krb5_cc_destroy(authctxt->krb5_ctx, ccache);

d280 5
@


1.8
log
@KNF whitespace
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.7 2002/03/16 17:41:25 stevesk Exp $");
d73 1
a73 1
auth_krb5(Authctxt *authctxt, krb5_data *auth, char **client)
a76 1
	krb5_data reply;
d83 1
a83 1
	reply.length = 0;
d117 1
a117 1
	    &reply);
a129 5
	packet_start(SSH_SMSG_AUTH_KERBEROS_RESPONSE);
	packet_put_string((char *) reply.data, reply.length);
	packet_send();
	packet_write_wait();

d136 4
a139 2
	if (reply.length)
		xfree(reply.data);
@


1.8.2.1
log
@Update to OpenSSH 3.5
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.9 2002/09/09 06:48:06 itojun Exp $");
d73 1
a73 1
auth_krb5(Authctxt *authctxt, krb5_data *auth, char **client, krb5_data *reply)
d77 1
d84 1
a84 1
	reply->length = 0;
d118 1
a118 1
	    reply);
d131 5
d142 2
a143 4
	if (!ret && reply->length) {
		xfree(reply->data);
		memset(reply, 0, sizeof(*reply));
	}
@


1.8.2.2
log
@Merge OpenSSH 3.6.1
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.10 2002/11/21 23:03:51 deraadt Exp $");
d100 1
a100 1
	problem = krb5_sname_to_principal(authctxt->krb5_ctx, NULL, NULL,
@


1.7
log
@BSD license.  from Daniel Kouril via Dug Song.  ok markus@@
@
text
@d3 1
a3 1
 * 
d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.6 2002/03/04 17:27:39 stevesk Exp $");
@


1.6
log
@$OpenBSD$ and RCSID() cleanup: don't use RCSID() in .h files; add
missing RCSID() to .c files and remove dup /*$OpenBSD$*/ from .c
files.  ok markus@@
@
text
@d6 23
d31 1
a31 1
RCSID("$OpenBSD:$");
@


1.5
log
@krb5_get_err_text() does not like context==NULL; he@@nordu.net via google; ok provos@@
@
text
@a4 1
 * $OpenBSD: auth-krb5.c,v 1.4 2002/01/27 15:12:09 markus Exp $
d8 2
@


1.4
log
@need privileged uid for krb5_verify_user(), ok hin@@, dugsong@@, netbsd
@
text
@d5 1
a5 1
 * $OpenBSD: auth-krb5.c,v 1.3 2001/12/19 07:18:56 deraadt Exp $
d121 8
a128 3
	if (problem)
		debug("Kerberos v5 authentication failed: %s",
		    krb5_get_err_text(authctxt->krb5_ctx, problem));
d230 6
a235 2
		debug("Kerberos password authentication failed: %s",
		    krb5_get_err_text(authctxt->krb5_ctx, problem));
@


1.3
log
@basic KNF done while i was looking for something else
@
text
@d5 1
a5 1
 * $OpenBSD: auth-krb5.c,v 1.2 2001/11/12 01:47:09 dugsong Exp $
d211 1
d214 2
@


1.2
log
@fix krb5 authorization check. found by <jhawk@@MIT.EDU>. from art@@, deraadt@@ ok
@
text
@d5 1
a5 1
 * $OpenBSD: auth-krb5.c,v 1.1 2001/06/26 16:15:23 dugsong Exp $
d29 1
a29 1
	
d48 1
a48 1
int 
d61 1
a61 1
	
d63 1
a63 1
	if (problem) 
d65 1
a65 1
	
d70 1
a70 1
	
d76 1
a76 1
	
d81 1
a81 1
	
d86 1
a86 1
	
d91 1
a91 1
	
d97 1
a97 1
	
d102 1
a102 1
	
d106 1
a106 1
	
d120 1
a120 1
	
d134 1
a134 1
	
d137 1
a137 1
	
d139 1
a139 1
	
d143 1
a143 1
	
d148 1
a148 1
	
d153 1
a153 1
	
d156 1
a156 1
	
d158 1
a158 1
	
d163 1
a163 1
	
d165 1
a165 1
	
d167 1
a167 1
	
d169 1
a169 1
	
d176 1
a176 1
	
d178 1
a178 1
	
d186 1
a186 1
	
d189 1
a189 1
	
d191 1
a191 1
	
d195 1
a195 1
	
d200 1
a200 1
	
d205 1
a205 1
	
d210 1
a210 1
	
d215 1
a215 1
	
d217 1
a217 1
	
d220 1
a220 1
	
d224 1
a224 1
		
d226 1
a226 1
		
d239 1
a239 1
	
@


1.1
log
@Kerberos v5 support for SSH1, mostly from Assar Westerlund <assar@@freebsd.org> and Bjorn Gronvall <bg@@sics.se>. markus@@ ok
@
text
@d5 1
a5 1
 * $OpenBSD$
d55 3
a57 2
	int fd;
	
d111 2
a112 1
	
d121 1
a121 1
	if (problem) {
d124 2
a125 3
		return (0);
	}
	return (1);
@


1.1.6.1
log
@Pull in patches from current (Errata 002):
Update to OpenSSH-3.0.1 via errata patch (Instead of using release tarball)
@
text
@d5 1
a5 1
 * $OpenBSD: auth-krb5.c,v 1.2 2001/11/12 01:47:09 dugsong Exp $
d55 2
a56 3
	int fd, ret;

	ret = 0;
d110 1
a110 2

	ret = 1;
d119 1
a119 1
	if (problem)
d122 3
a124 2

	return (ret);
@


1.1.6.2
log
@Update to OpenSSH-3.1 on 3.0-stable branch
@
text
@d5 1
a8 2
RCSID("$OpenBSD: auth-krb5.c,v 1.6 2002/03/04 17:27:39 stevesk Exp $");

d29 1
a29 1

d48 1
a48 1
int
d61 1
a61 1

d63 1
a63 1
	if (problem)
d65 1
a65 1

d70 1
a70 1

d76 1
a76 1

d81 1
a81 1

d86 1
a86 1

d91 1
a91 1

d97 1
a97 1

d102 1
a102 1

d106 1
a106 1

d120 4
a123 9

	if (problem) {
		if (authctxt->krb5_ctx != NULL)
			debug("Kerberos v5 authentication failed: %s",
			    krb5_get_err_text(authctxt->krb5_ctx, problem));
		else
			debug("Kerberos v5 authentication failed: %d",
			    problem);
	}
d134 1
a134 1

d137 1
a137 1

d139 1
a139 1

d143 1
a143 1

d148 1
a148 1

d153 1
a153 1

d156 1
a156 1

d158 1
a158 1

d163 1
a163 1

d165 1
a165 1

d167 1
a167 1

d169 1
a169 1

d176 1
a176 1

d178 1
a178 1

d186 1
a186 1

d189 1
a189 1

d191 1
a191 1

d195 1
a195 1

d200 1
a200 1

d205 1
a205 1

d210 1
a210 2

	restore_uid();
a212 2
	temporarily_use_uid(authctxt->pw);

d215 1
a215 1

d217 1
a217 1

d220 1
a220 1

d222 3
a224 7
		if (authctxt->krb5_ctx != NULL)
			debug("Kerberos password authentication failed: %s",
			    krb5_get_err_text(authctxt->krb5_ctx, problem));
		else
			debug("Kerberos password authentication failed: %d",
			    problem);

d226 1
a226 1

d239 1
a239 1

@


1.1.6.3
log
@Update OpenSSH to version 3.2.2.
@
text
@d3 1
a3 1
 *
a5 23
/*
 * Copyright (c) 2002 Daniel Kouril.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
d8 1
a8 1
RCSID("$OpenBSD: auth-krb5.c,v 1.8 2002/03/19 10:49:35 markus Exp $");
@


1.1.6.4
log
@Update to OpenSSH 3.5
@
text
@d31 1
a31 1
RCSID("$OpenBSD: auth-krb5.c,v 1.9 2002/09/09 06:48:06 itojun Exp $");
d73 1
a73 1
auth_krb5(Authctxt *authctxt, krb5_data *auth, char **client, krb5_data *reply)
d77 1
d84 1
a84 1
	reply->length = 0;
d118 1
a118 1
	    reply);
d131 5
d142 2
a143 4
	if (!ret && reply->length) {
		xfree(reply->data);
		memset(reply, 0, sizeof(*reply));
	}
@


1.1.4.1
log
@Pull in OpenSSH-2.9.9
@
text
@d5 1
a5 1
 * $OpenBSD: auth-krb5.c,v 1.1 2001/06/26 16:15:23 dugsong Exp $
@


1.1.4.2
log
@Merge OpenSSH 3.0.1.
@
text
@d5 1
a5 1
 * $OpenBSD: auth-krb5.c,v 1.1.4.1 2001/09/27 19:03:54 jason Exp $
d55 2
a56 3
	int fd, ret;

	ret = 0;
d110 1
a110 2

	ret = 1;
d119 1
a119 1
	if (problem)
d122 3
a124 2

	return (ret);
@


1.1.4.3
log
@Merge OpenSSH 3.1, keeping /etc as configuration files directory.
(i.e. OpenSSH 3.1 + openbsd29_3.1.patch)
@
text
@d5 1
a8 2
RCSID("$OpenBSD: auth-krb5.c,v 1.6 2002/03/04 17:27:39 stevesk Exp $");

d29 1
a29 1

d48 1
a48 1
int
d61 1
a61 1

d63 1
a63 1
	if (problem)
d65 1
a65 1

d70 1
a70 1

d76 1
a76 1

d81 1
a81 1

d86 1
a86 1

d91 1
a91 1

d97 1
a97 1

d102 1
a102 1

d106 1
a106 1

d120 4
a123 9

	if (problem) {
		if (authctxt->krb5_ctx != NULL)
			debug("Kerberos v5 authentication failed: %s",
			    krb5_get_err_text(authctxt->krb5_ctx, problem));
		else
			debug("Kerberos v5 authentication failed: %d",
			    problem);
	}
d134 1
a134 1

d137 1
a137 1

d139 1
a139 1

d143 1
a143 1

d148 1
a148 1

d153 1
a153 1

d156 1
a156 1

d158 1
a158 1

d163 1
a163 1

d165 1
a165 1

d167 1
a167 1

d169 1
a169 1

d176 1
a176 1

d178 1
a178 1

d186 1
a186 1

d189 1
a189 1

d191 1
a191 1

d195 1
a195 1

d200 1
a200 1

d205 1
a205 1

d210 1
a210 2

	restore_uid();
a212 2
	temporarily_use_uid(authctxt->pw);

d215 1
a215 1

d217 1
a217 1

d220 1
a220 1

d222 3
a224 7
		if (authctxt->krb5_ctx != NULL)
			debug("Kerberos password authentication failed: %s",
			    krb5_get_err_text(authctxt->krb5_ctx, problem));
		else
			debug("Kerberos password authentication failed: %d",
			    problem);

d226 1
a226 1

d239 1
a239 1

@


1.1.4.4
log
@Upgrade to OpenSSH 3.2.3.

Except for improbable compilation error fixes, this should be the last
commit made to the 2.9-STABLE branche. Have fun upgrading.
@
text
@d3 1
a3 1
 *
a5 23
/*
 * Copyright (c) 2002 Daniel Kouril.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
d8 1
a8 1
RCSID("$OpenBSD: auth-krb5.c,v 1.8 2002/03/19 10:49:35 markus Exp $");
@


1.1.2.1
log
@A few files forgotten during last OpenSSH update. Spotted by naddy@@
@
text
@d5 1
a5 1
 * $OpenBSD: auth-krb5.c,v 1.1 2001/06/26 16:15:23 dugsong Exp $
@


1.1.2.2
log
@Merge OpenSSH 3.0.1.

This is likely to be the last commit to the 2.8-STABLE branch.
@
text
@d5 1
a5 1
 * $OpenBSD: auth-krb5.c,v 1.1.2.1 2001/09/27 18:27:43 miod Exp $
d55 2
a56 3
	int fd, ret;

	ret = 0;
d110 1
a110 2

	ret = 1;
d119 1
a119 1
	if (problem)
d122 3
a124 2

	return (ret);
@


1.1.2.3
log
@Merge OpenSSH 3.1.
@
text
@d5 1
a8 2
RCSID("$OpenBSD: auth-krb5.c,v 1.6 2002/03/04 17:27:39 stevesk Exp $");

d29 1
a29 1

d48 1
a48 1
int
d61 1
a61 1

d63 1
a63 1
	if (problem)
d65 1
a65 1

d70 1
a70 1

d76 1
a76 1

d81 1
a81 1

d86 1
a86 1

d91 1
a91 1

d97 1
a97 1

d102 1
a102 1

d106 1
a106 1

d120 4
a123 9

	if (problem) {
		if (authctxt->krb5_ctx != NULL)
			debug("Kerberos v5 authentication failed: %s",
			    krb5_get_err_text(authctxt->krb5_ctx, problem));
		else
			debug("Kerberos v5 authentication failed: %d",
			    problem);
	}
d134 1
a134 1

d137 1
a137 1

d139 1
a139 1

d143 1
a143 1

d148 1
a148 1

d153 1
a153 1

d156 1
a156 1

d158 1
a158 1

d163 1
a163 1

d165 1
a165 1

d167 1
a167 1

d169 1
a169 1

d176 1
a176 1

d178 1
a178 1

d186 1
a186 1

d189 1
a189 1

d191 1
a191 1

d195 1
a195 1

d200 1
a200 1

d205 1
a205 1

d210 1
a210 2

	restore_uid();
a212 2
	temporarily_use_uid(authctxt->pw);

d215 1
a215 1

d217 1
a217 1

d220 1
a220 1

d222 3
a224 7
		if (authctxt->krb5_ctx != NULL)
			debug("Kerberos password authentication failed: %s",
			    krb5_get_err_text(authctxt->krb5_ctx, problem));
		else
			debug("Kerberos password authentication failed: %d",
			    problem);

d226 1
a226 1

d239 1
a239 1

@


