head	1.17;
access;
symbols
	OPENBSD_6_2_BASE:1.17
	OPENBSD_6_1:1.16.0.6
	OPENBSD_6_1_BASE:1.16
	OPENBSD_6_0:1.16.0.2
	OPENBSD_6_0_BASE:1.16
	OPENBSD_5_9:1.15.0.2
	OPENBSD_5_9_BASE:1.15
	OPENBSD_5_8:1.15.0.4
	OPENBSD_5_8_BASE:1.15
	OPENBSD_5_7:1.14.0.2
	OPENBSD_5_7_BASE:1.14
	OPENBSD_5_6:1.13.0.4
	OPENBSD_5_6_BASE:1.13
	OPENBSD_5_5:1.12.0.6
	OPENBSD_5_5_BASE:1.12
	OPENBSD_5_4:1.12.0.2
	OPENBSD_5_4_BASE:1.12
	OPENBSD_5_3:1.11.0.2
	OPENBSD_5_3_BASE:1.11
	OPENBSD_5_2:1.10.0.2
	OPENBSD_5_2_BASE:1.10
	OPENBSD_5_1_BASE:1.8
	OPENBSD_5_1:1.8.0.2
	OPENBSD_5_0:1.7.0.2
	OPENBSD_5_0_BASE:1.7
	OPENBSD_4_9:1.5.0.4
	OPENBSD_4_9_BASE:1.5
	OPENBSD_4_8:1.5.0.2
	OPENBSD_4_8_BASE:1.5
	OPENBSD_4_7:1.3.0.2
	OPENBSD_4_7_BASE:1.3;
locks; strict;
comment	@ * @;


1.17
date	2017.08.12.11.20.34;	author goda;	state Exp;
branches;
next	1.16;
commitid	ccl4VRXLf9CVdvt9;

1.16
date	2016.03.08.01.38.04;	author yasuoka;	state Exp;
branches;
next	1.15;
commitid	u4vWmGLSbAexHfKe;

1.15
date	2015.07.23.09.04.06;	author yasuoka;	state Exp;
branches;
next	1.14;
commitid	UzaYgcNQWA1XOOah;

1.14
date	2015.01.19.01.48.59;	author deraadt;	state Exp;
branches;
next	1.13;
commitid	a1BWBASyBgKKetQd;

1.13
date	2014.03.22.04.30.31;	author yasuoka;	state Exp;
branches;
next	1.12;

1.12
date	2013.04.16.07.42.27;	author yasuoka;	state Exp;
branches;
next	1.11;

1.11
date	2012.09.18.13.14.08;	author yasuoka;	state Exp;
branches;
next	1.10;

1.10
date	2012.05.08.13.18.37;	author yasuoka;	state Exp;
branches;
next	1.9;

1.9
date	2012.05.08.13.15.12;	author yasuoka;	state Exp;
branches;
next	1.8;

1.8
date	2012.01.18.03.13.04;	author yasuoka;	state Exp;
branches;
next	1.7;

1.7
date	2011.07.08.06.14.54;	author yasuoka;	state Exp;
branches;
next	1.6;

1.6
date	2011.07.06.20.52.28;	author yasuoka;	state Exp;
branches;
next	1.5;

1.5
date	2010.07.02.21.20.57;	author yasuoka;	state Exp;
branches;
next	1.4;

1.4
date	2010.07.01.03.38.17;	author yasuoka;	state Exp;
branches;
next	1.3;

1.3
date	2010.01.31.05.49.51;	author yasuoka;	state Exp;
branches;
next	1.2;

1.2
date	2010.01.13.07.49.44;	author yasuoka;	state Exp;
branches;
next	1.1;

1.1
date	2010.01.11.04.20.57;	author yasuoka;	state Exp;
branches;
next	;


desc
@@


1.17
log
@add a new option to set limits on max-sessions each IPCP.

It can set limits on different max-sessions if there're using several protocols
such as PPPoE and L2TP/IPsec.

ok yasuoka@@
@
text
@/*	$OpenBSD: npppd_local.h,v 1.16 2016/03/08 01:38:04 yasuoka Exp $ */

/*-
 * Copyright (c) 2009 Internet Initiative Japan Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */
#ifndef	_NPPPD_LOCAL_H
#define	_NPPPD_LOCAL_H	1

#ifndef	NPPPD_BUFSZ
/** buffer size */
#define	NPPPD_BUFSZ			BUFSZ
#endif

#include <net/if.h>

#include "npppd_defs.h"

#include "slist.h"
#include "hash.h"
#include "debugutil.h"

#ifdef	USE_NPPPD_RADIUS
#include "radius_req.h"
#endif

#ifdef	USE_NPPPD_L2TP
#include "bytebuf.h"
#include "l2tp.h"
#endif

#ifdef	USE_NPPPD_PPTP
#include "bytebuf.h"
#include "pptp.h"
#endif
#ifdef	USE_NPPPD_PPPOE
#if defined(__NetBSD__)
#include <net/if_ether.h>
#else
#include <netinet/if_ether.h>
#endif
#include "bytebuf.h"
#include "pppoe.h"
#endif
#include "npppd_auth.h"
#include "npppd.h"
#include "npppd_iface.h"

#include "privsep.h"

#include "addr_range.h"
#include "npppd_pool.h"
#include "npppd_ctl.h"

/** structure of pool */
struct _npppd_pool {
	/** base of npppd structure */
	npppd		*npppd;
	/** ipcp name */
	char		ipcp_name[NPPPD_GENERIC_NAME_LEN];
	/** size of sockaddr_npppd array */
	int		addrs_size;
	/** pointer indicated to sockaddr_npppd array */
	struct sockaddr_npppd *addrs;
	/** list of addresses dynamically allocated */
	slist 		dyna_addrs;
	int		/** whether initialized or not */
			initialized:1,
			/** whether in use or not */
			running:1;
};

/** structure for control socket. (control.c) */
struct control_sock {
	const char      *cs_name;
	struct event     cs_ev;
	struct event     cs_evt;
	int              cs_fd;
	int              cs_restricted;
	void            *cs_ctx;
};

/**
 * npppd
 */
struct _npppd {
	/** event handler */
	struct event ev_sigterm, ev_sigint, ev_sighup, ev_sigchld, ev_timer;

	/** interface which concentrates PPP  */
	npppd_iface		iface[NPPPD_MAX_IFACE];

	npppd_pool		*iface_pool[NPPPD_MAX_IFACE];

	/** address pool */
	npppd_pool		pool[NPPPD_MAX_POOL];

	/** radish pool which uses to manage allocated address */
	struct radish_head *rd;

	/** map of username to slist of npppd_ppp */
	hash_table *map_user_ppp;

	/** authentication realms */
	slist realms;

	/** interval time(in seconds) which finalizes authentication realms */
	int auth_finalizer_itvl;

	/** name of configuration file */
	char 	config_file[PATH_MAX];

	/** name of pid file */
	char 	pidpath[PATH_MAX];

	/** process id */
	pid_t	pid;

	/** boot identifier */
	uint32_t boot_id;

#ifdef	USE_NPPPD_L2TP
	/** structure of L2TP daemon */
	l2tpd l2tpd;
#endif
#ifdef	USE_NPPPD_PPTP
	/** structure of PPTP daemon */
	pptpd pptpd;
#endif
#ifdef	USE_NPPPD_PPPOE
	/** structure of PPPOE daemon */
	pppoed pppoed;
#endif
	/** configuration file  */
	struct npppd_conf conf;

	/** the time in seconds which process was started.*/
	uint32_t	secs;

	/** delay time in seconds reload configuration */
	int16_t		delayed_reload;
	/** counter of reload configuration */
	int16_t		reloading_count;

	int		nsession;

	struct ipcpstat_head ipcpstats;

	struct control_sock  ctl_sock;

	u_int /** whether finalizing or not */
	    finalizing:1,
	    /** whether finalize completed or not */
	    finalized:1,
	    /** npppd stopped itself because of an error. */
	    stop_by_error:1;
};

#define	ppp_iface(ppp)	(&(ppp)->pppd->iface[(ppp)->ifidx])
#define	ppp_ipcp(ppp)	((ppp)->pppd->iface[(ppp)->ifidx].ipcpconf)
#define	ppp_pool(ppp)	((ppp)->pppd->iface_pool[(ppp)->ifidx])

#define	SIN(sa)		((struct sockaddr_in *)(sa))

#define	TIMER_TICK_RUP(interval)			\
	((((interval) % NPPPD_TIMER_TICK_IVAL) == 0)	\
	    ? (interval)				\
	    : (interval) + NPPPD_TIMER_TICK_IVAL	\
		- ((interval) % NPPPD_TIMER_TICK_IVAL))

#endif
@


1.16
log
@Remove __cplusplus include guard.

Diff from Tiago Silva
@
text
@d1 1
a1 1
/*	$OpenBSD: npppd_local.h,v 1.15 2015/07/23 09:04:06 yasuoka Exp $ */
d167 2
@


1.15
log
@Make npppd use libradius(3).  Remove radius+ files.
@
text
@d1 1
a1 1
/*	$OpenBSD: npppd_local.h,v 1.14 2015/01/19 01:48:59 deraadt Exp $ */
a188 4

#ifdef __cplusplus
}
#endif
@


1.14
log
@move to <limits.h> universe
ok yasuoka
@
text
@d1 1
a1 1
/*	$OpenBSD: npppd_local.h,v 1.13 2014/03/22 04:30:31 yasuoka Exp $ */
a44 1
#include <radius+.h>
@


1.13
log
@Reimplement control part of npppd(8) with imsg.  Also add "monitor"
command for npppctl(8) to monitor PPP session start/stop events.
@
text
@d1 1
a1 1
/*	$OpenBSD: npppd_local.h,v 1.12 2013/04/16 07:42:27 yasuoka Exp $ */
a35 1
#include <sys/param.h>
d133 1
a133 1
	char 	config_file[MAXPATHLEN];
d136 1
a136 1
	char 	pidpath[MAXPATHLEN];
@


1.12
log
@Fixed `max-session' and `user-max-session'.  They has been broken by the
configuration reworking.
@
text
@d1 1
a1 1
/*	$OpenBSD: npppd_local.h,v 1.11 2012/09/18 13:14:08 yasuoka Exp $ */
a73 14
#include "npppd_ctl.h"
typedef struct _npppd_ctl {
	/** event context */
	struct event ev_sock;
	/** socket */
	int sock;
	/** enabled or disabled */
	int enabled;
	/** parent of npppd structure */
	void *npppd;
	/** pathname of socket */
	char pathname[MAXPATHLEN];
} npppd_ctl;

d76 1
d96 10
a159 1
	npppd_ctl ctl;
d170 2
a190 10



#ifdef __cplusplus
extern "C" {
#endif

void  npppd_ctl_init (npppd_ctl *, npppd *, const char *);
int   npppd_ctl_start (npppd_ctl *);
void  npppd_ctl_stop (npppd_ctl *);
@


1.11
log
@New configuration syntax for npppd(8).  `npppd.conf' will be based on
parse.y and `npppd-users' will be based on getcap(3).  Add man pages.

feedback from giovanni
@
text
@d1 1
a1 1
/*	$OpenBSD: npppd_local.h,v 1.10 2012/05/08 13:18:37 yasuoka Exp $ */
a172 2
	int		user_max_session;
	int		max_session;
@


1.10
log
@Trivial changes from the upstream(IIJ).
 - fix styles, compile errors in some ifdef condition and compiler warnings.
 - delete rtev* that was to work around routing socket overflows.
 - delete is_ctrl argument from l2tp_ctrl_send_packet().  It's not used.
 - tweak returning the exit status.
 - use IPV6_IPSEC_POLICY for IPv6 socket.
   (though npppd cannot set up a ipsec policy to the socket yet.)

ok mcbride henning
@
text
@d1 1
a1 1
/*	$OpenBSD: npppd_local.h,v 1.9 2012/05/08 13:15:12 yasuoka Exp $ */
a42 1
#include "properties.h"
d69 1
a70 1
#include "npppd.h"
d95 2
a96 4
	/** name of label */
	char		label[NPPPD_GENERIC_NAME_LEN];
	/** name */
	char		name[NPPPD_GENERIC_NAME_LEN];
a108 52
/** structure of IPCP configuration */
typedef struct _npppd_ipcp_config {
	/** name */
	char	name[NPPPD_GENERIC_NAME_LEN];
	/** label (to associate with npppd structure) */
	char	label[NPPPD_GENERIC_NAME_LEN];
	/** pointer indicated to parent npppd structure */
	npppd	*npppd;
	/**
	 * primary DNS server. INADDR_NONE if not inform peer this.
	 * specified in network byte order.
	 */
	struct in_addr	dns_pri;

	/** secondary DNS server. INADDR_NONE if not inform peer this.
	 * specified in network byte order.
	 */
	struct in_addr	dns_sec;

	/**
	 * primary WINS server. INADDR_NONE if not inform peer this.
	 * specified in network byte order.
	 */
	struct in_addr	nbns_pri;

	/**
	 * secondary WINS server. INADDR_NONE if not inform peer this.
	 * specified in network byte order.
	 */
	struct in_addr	nbns_sec;

	/**
	 * bit flag which specifies the way of IP address assignment.
	 * @@see	#NPPPD_IP_ASSIGN_FIXED
	 * @@see	#NPPPD_IP_ASSIGN_USER_SELECT
	 * @@see	#NPPPD_IP_ASSIGN_RADIUS
	 */
	int 		ip_assign_flags;

	int		/** whether use tunnel end point address as DNS server or not */
			dns_use_tunnel_end:1,
			/** whether initialized or not */
			initialized:1,
			reserved:30;
} npppd_ipcp_config;

/** structure which holds an interface of IPCP configuration and references of pool address */
typedef struct _npppd_iface_binding {
	npppd_ipcp_config	*ipcp;
	slist			pools;
} npppd_iface_binding;

d118 2
a119 2
	/** reference of interface of IPCP configuration and pool address */
	npppd_iface_binding	iface_bind[NPPPD_MAX_IFACE];
a126 3
	/** IPCP configuration */
	npppd_ipcp_config ipcp_config[NPPPD_MAX_IPCP_CONFIG];

d161 1
a161 4
	struct properties * properties;

	/** user properties file */
	struct properties * users_props;
d172 2
a173 1
	/** maximum PPP sessions */
a183 6
#ifndef	NPPPD_CONFIG_BUFSIZ
#define	NPPPD_CONFIG_BUFSIZ	65536	// 64K
#endif
#ifndef	NPPPD_KEY_BUFSIZ
#define	NPPPD_KEY_BUFSIZ	512
#endif
d185 2
a186 2
#define	ppp_ipcp(ppp)	((ppp)->pppd->iface_bind[(ppp)->ifidx].ipcp)
#define	ppp_pools(ppp)	(&(ppp)->pppd->iface_bind[(ppp)->ifidx].pools)
d196 6
a204 3
#define	sin46_port(x)	(((x)->sa_family == AF_INET6)	\
	? ((struct sockaddr_in6 *)(x))->sin6_port		\
	: ((struct sockaddr_in *)(x))->sin_port)
d206 3
@


1.9
log
@Fix comments and styles.  Delete unused variables and labels.
No binary changes.

ok mcbride henning
@
text
@d1 1
a1 1
/*	$OpenBSD: npppd_local.h,v 1.8 2012/01/18 03:13:04 yasuoka Exp $ */
d44 1
a51 1
#include "debugutil.h"
a231 3

	/** serial number of routing event which was completed */
	int		rtev_event_serial;
@


1.8
log
@Replace npppdctl(8) by new npppctl(8).  npppctl was written from
scratch, it uses parser.c derived from ikectl(8) to have OpenBSD's
fashion.  This includes related changes listed below:
- changed npppd control IPC heavyly.
- support IPv6 as tunnel source address.
- deleted support changing the configuration of npppd_ctl on running.
  Because it is not so needed but it requires privilege operations.
- refactors.

man page helps from jmc.  tested by sebastia.
ok deraadt sebastia sthen
@
text
@d1 1
a1 1
/* $OpenBSD: npppd_local.h,v 1.7 2011/07/08 06:14:54 yasuoka Exp $ */
@


1.7
log
@Improved npppd privileged separations:
- Changed finalizing way to the privileged process.  In old way, the
  privileged process could not aware abnormal exit of the process in
  jail.  Then the processes in jail remained as zombies.  Created a
  pipe to monitor the privileged process, the privileged process can
  exit in peace by using the pipe.
- npppd will exit abnormally when the privileged process exits
  abnormally.
- PF_KEY socket requires privileges.
- Return correct "errno" to the jail in priv_open().
- Cleanup.

ok hsuenaga@@
@
text
@d1 1
a1 1
/* $OpenBSD: npppd_local.h,v 1.6 2011/07/06 20:52:28 yasuoka Exp $ */
d75 1
a75 1
#ifdef	USE_NPPPD_NPPPD_CTL
a86 2
	/** maximum length of message */
	int max_msgsz;
a87 1
#endif
a223 1
#ifdef	USE_NPPPD_NPPPD_CTL
a224 1
#endif
a264 1
#ifdef	USE_NPPPD_NPPPD_CTL
a267 1
#endif
@


1.6
log
@Add RADIUS accounting support and some authentication related changes:

- Add functions to radius+.c that are required to implement RADIUS
  accounting.
- Send RADIUS Account-Start and Account-Stop messages with attributes that
  are defined by RFC 2866, 2868, 2869.
- If any authentication realm is deleted from the configuration, npppd may
  exit by segmentation fault.
- Delete radius_common.c, radius_common.h and eap.c because they are not
  used.
- Retransmission and failover are reimplemented.
- Cleanup
@
text
@d1 1
a1 1
/* $OpenBSD: npppd_local.h,v 1.5 2010/07/02 21:20:57 yasuoka Exp $ */
d172 1
a172 1
	struct event ev_sigterm, ev_sigint, ev_sighup, ev_timer;
d244 1
a244 1
	int /** whether finalizing or not */
d247 3
a249 1
	    finalized:1;
@


1.5
log
@add $OpenBSD$ and remove trailing space.  no functional change.
@
text
@d1 1
a1 1
/* $OpenBSD$ */
d205 3
@


1.4
log
@Translate Japanese comments or labels into English.  Translation was
done by IIJ people (MATSUI Yoshihiro, SAITOH Masanobu, Tomoyuki Sahara),
yuo@@ and myself.

This diff also includes
 - delete part of useless comments, correct spelling.
 - add man page of npppdctl.

There is no functional change.
@
text
@d1 2
d31 1
a31 1
#ifndef	NPPPD_BUFSZ	
@


1.3
log
@privilege separation of npppd.

- Drop privilege after daemon initializing.
- Some system calls that requires root privileges were replaced to
  wrapper functions that communicate with a separated privileged
  process via IPC.  And the privileged process checks whether the
  operations are acceptable.
@
text
@d30 1
a30 1
/** バッファサイズ */
d75 1
a75 1
	/** イベントコンテキスト */
d77 1
a77 1
	/** ソケット */
d79 1
a79 1
	/** 有効/無効 */
d81 1
a81 1
	/** 親 npppd */
d83 1
a83 1
	/** ソケットのパス名 */
d85 1
a85 1
	/** 最大メッセージ長 */
d93 1
a93 1
/** プールを示す型 */
d95 1
a95 1
	/** 基となる npppd */
d97 1
a97 1
	/** ラベル名 */
d99 1
a99 1
	/** 名前(name) */
d101 1
a101 1
	/** sockaddr_npppd 配列のサイズ */
d103 1
a103 1
	/** sockaddr_npppd 配列 */
d105 1
a105 1
	/** 動的に割り当てるアドレスのリスト */
d107 1
a107 1
	int		/** 初期化済 */
d109 1
a109 1
			/** 利用中 */
d113 1
a113 1
/** IPCP設定を示す型 */
d115 1
a115 1
	/** 名前 */
d117 1
a117 1
	/** ラベル(紐付けるため) */
d119 1
a119 1
	/** 親 npppd へのポインタ */
d122 2
a123 2
	 * プライマリDNSサーバ。先方に通知しない場合は INADDR_NONE。
	 * ネットワークバイトオーダー。
d127 2
a128 2
	/** セカンダリDNSサーバ。先方に通知しない場合は INADDR_NONE。
	 * ネットワークバイトオーダー。
d133 2
a134 2
	 * プライマリWINSサーバ。先方に通知しない場合は INADDR_NONE。
	 * ネットワークバイトオーダー。
d139 2
a140 2
	 * セカンダリWINSサーバ。先方に通知しない場合は INADDR_NONE。
	 * ネットワークバイトオーダー。
d145 1
a145 1
	 * IPアドレス割り当て方法のビットフラグ。
d152 1
a152 1
	int		/** DNS サーバとしてトンネル終端アドレスを使う */
d154 1
a154 1
			/** 初期化済かどうか */
d159 1
a159 1
/** インタフェースの IPCP 設定やプールアドレスへの参照を保持する型 */
d169 1
a169 1
	/** イベントハンドラー */
d172 1
a172 1
	/** PPPを集約するインターフェース */
d174 1
a174 1
	/** インタフェースの IPCP 設定やプールアドレスへの参照 */
d177 1
a177 1
	/** アドレスプール */
d180 1
a180 1
	/** radish プール、割り当てアドレス管理用 */
d183 1
a183 1
	/** IPCP 設定 */
d186 1
a186 1
	/** ユーザ名 → slist of npppd_ppp のマップ */
d189 1
a189 1
	/** 認証レルム */
d192 1
a192 1
	/** 認証レルム終了化処理のインターバル時間(sec) */
d195 1
a195 1
	/** 設定ファイル名 */
d198 1
a198 1
	/** PIDファイル名 */
d201 1
a201 1
	/** プロセス ID */
d205 1
a205 1
	/** L2TP デーモン */
d209 1
a209 1
	/** PPTP デーモン */
d213 1
a213 1
	/** PPPOE デーモン */
d216 1
a216 1
	/** 設定ファイル */
d219 1
a219 1
	/** ユーザ設定ファイル */
d225 1
a225 1
	/** 起動してからの秒数。*/
d228 1
a228 1
	/** 設定再読み込みを何秒猶予するか */
d230 1
a230 1
	/** 設定再読み込みカウンタ */
d233 1
a233 1
	/** 処理済みのルーティングイベントシリアル */
d236 1
a236 1
	/** 接続できる最大の PPPセッション数 */
d239 1
a239 1
	int /** 終了処理中 */
d241 1
a241 1
	    /** 終了処理完了 */
@


1.2
log
@cleanup npppd code.  delete IIJ local ifdef switches and fix warnings.
ok @@dlg
@
text
@d71 2
@


1.1
log
@Initial import npppd(8).  npppd is a new PPP daemon that handles many
ppp sessions as a server.  It supports L2TP, PPTP and PPPoE as
tunneling.

ok mcbride@@ dlg@@ deraadt@@ reyk@@.
@
text
@a208 4
#ifdef	IDGW_SSLDIP
	/** SSLDIP 用 PPTP デーモン */
	pptpd ssldipd;
#endif
@

