head	1.7;
access;
symbols
	OPENBSD_6_2:1.7.0.10
	OPENBSD_6_2_BASE:1.7
	OPENBSD_6_1:1.7.0.8
	OPENBSD_6_1_BASE:1.7
	OPENBSD_6_0:1.7.0.4
	OPENBSD_6_0_BASE:1.7
	OPENBSD_5_9:1.7.0.2
	OPENBSD_5_9_BASE:1.7
	OPENBSD_5_8:1.6.0.8
	OPENBSD_5_8_BASE:1.6
	OPENBSD_5_7:1.6.0.2
	OPENBSD_5_7_BASE:1.6
	OPENBSD_5_6:1.6.0.4
	OPENBSD_5_6_BASE:1.6
	OPENBSD_5_5:1.5.0.8
	OPENBSD_5_5_BASE:1.5
	OPENBSD_5_4:1.5.0.4
	OPENBSD_5_4_BASE:1.5
	OPENBSD_5_3:1.5.0.2
	OPENBSD_5_3_BASE:1.5
	OPENBSD_5_2:1.4.0.2
	OPENBSD_5_2_BASE:1.4
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.8
	OPENBSD_5_0:1.3.0.6
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.4
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.2
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.1.0.2
	OPENBSD_4_7_BASE:1.1;
locks; strict;
comment	@ * @;


1.7
date	2015.12.05.16.10.31;	author yasuoka;	state Exp;
branches;
next	1.6;
commitid	CAVUqjHZb5KSEF4I;

1.6
date	2014.07.21.01.51.11;	author guenther;	state Exp;
branches;
next	1.5;
commitid	ro8JUTvBpvQMiFY9;

1.5
date	2012.09.18.13.14.08;	author yasuoka;	state Exp;
branches;
next	1.4;

1.4
date	2012.05.08.13.15.12;	author yasuoka;	state Exp;
branches;
next	1.3;

1.3
date	2010.07.02.21.20.57;	author yasuoka;	state Exp;
branches;
next	1.2;

1.2
date	2010.07.01.03.38.17;	author yasuoka;	state Exp;
branches;
next	1.1;

1.1
date	2010.01.11.04.20.57;	author yasuoka;	state Exp;
branches;
next	;


desc
@@


1.7
log
@Pass the pppx_hdr when sending packets through the pppx device and use the
ppp_id in the pppx_hdr to find the associated ppp when receiving the packets
from the device.
@
text
@/*	$OpenBSD: pppoe.h,v 1.6 2014/07/21 01:51:11 guenther Exp $ */

/*-
 * Copyright (c) 2009 Internet Initiative Japan Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */
#ifndef	PPPOE_H
#define	PPPOE_H 1

/*
 * Constant variables and types from PPPoE protocol (RFC 2516)
 */
#define PPPOE_RFC2516_TYPE	0x01
#define PPPOE_RFC2516_VER	0x01

/** The PPPoE Active Discovery Initiation (PADI) packet */
#define	PPPOE_CODE_PADI		0x09

/** The PPPoE Active Discovery Offer (PADO) packet */
#define	PPPOE_CODE_PADO		0x07

/** The PPPoE Active Discovery Request (PADR) packet */
#define	PPPOE_CODE_PADR		0x19

/** The PPPoE Active Discovery Session-confirmation (PADS) packet */
#define	PPPOE_CODE_PADS		0x65

/** The PPPoE Active Discovery Terminate (PADT) packet */
#define	PPPOE_CODE_PADT		0xa7

#define	PPPOE_TAG_END_OF_LIST		0x0000
#define	PPPOE_TAG_SERVICE_NAME		0x0101
#define	PPPOE_TAG_AC_NAME		0x0102
#define	PPPOE_TAG_HOST_UNIQ		0x0103
#define	PPPOE_TAG_AC_COOKIE		0x0104
#define	PPPOE_TAG_VENDOR_SPECIFIC	0x0105
#define	PPPOE_TAG_RELAY_SESSION_ID	0x0110
#define	PPPOE_TAG_SERVICE_NAME_ERROR	0x0201
#define	PPPOE_TAG_AC_SYSTEM_ERROR	0x0202
#define	PPPOE_TAG_GENERIC_ERROR		0x0203

/** PPPoE Protocol Header */
struct pppoe_header {
#if BYTE_ORDER == BIG_ENDIAN
    uint8_t ver:4, type:4;
#else
    uint8_t type:4, ver:4;
#endif
    uint8_t code;
    uint16_t session_id;
    uint16_t length;
} __attribute__((__packed__));

/** PPPoE TLV Header */
struct pppoe_tlv {
	uint16_t	type;
	uint16_t	length;
	uint8_t		value[0];
} __attribute__((__packed__));

/*
 * Constant variables and types for implementions
 */
#include "pppoe_conf.h"

/** Default data link layer  */
#define PPPOED_DEFAULT_LAYER2_LABEL	"PPPoE"

#define	PPPOED_CONFIG_BUFSIZ		65535
#define	PPPOED_HOSTUNIQ_LEN		64
#define PPPOED_PHY_LABEL_SIZE		16

/*
 * pppoed status
 */
#define	PPPOED_STATE_INIT 		0 /** Initial */
#define	PPPOED_STATE_RUNNING 		1 /** Running */
#define	PPPOED_STATE_STOPPED 		2 /** Stopped */

#define pppoed_is_stopped(pppoed)	\
	(((pppoed)->state == PPPOED_STATE_STOPPED)? 1 : 0)
#define pppoed_is_running(pppoed)	\
	(((pppoed)->state == PPPOED_STATE_RUNNING)? 1 : 0)

#define	PPPOED_LISTENER_INVALID_INDEX	UINT16_MAX

/** PPPoE listener type */
typedef struct _pppoed_listener {
	/** Descriptor of bpf(4) */
	int bpf;
	/** Context of event(3) for the descriptor of bpf(4) */
	struct event ev_bpf;
	/** Pointer to base PPPoE daemon */
	struct _pppoed *self;
	/** Ethernet address */
	u_char	ether_addr[ETHER_ADDR_LEN];
	/** Listener index numbered  by the base PPPoE daemon */
	uint16_t	index;
	/** Listening interface name */
	char	listen_ifname[IF_NAMESIZE];
	/** Label of physcal layer */
	char	tun_name[PPPOED_PHY_LABEL_SIZE];
	/** Configuration */
	struct pppoe_conf *conf;
} pppoed_listener;

/** PPPoE daemon type */
typedef struct _pppoed {
	/** PPPoE daemon Id */
	int id;
	/** List of {@@link pppoed_listener} */
	slist listener;
	/** Status of this daemon */
	int state;

	/** Hashmap that maps from session number to {@@link pppoe_session} */
	hash_table	*session_hash;
	/** List of free session numbers */
	slist	session_free_list;

	/** Hashmap that contains uniq cookie value */
	hash_table	*acookie_hash;
	/** Next cookie number */
	uint32_t	acookie_next;

	/** Flags */
	uint32_t
	    listen_incomplete:1,
	    reserved:31;
} pppoed;

/** PPPoE session type */
typedef struct _pppoe_session {
	/** State of this session */
	int 		state;
	/** Pointer to base {@@link pppoed *} PPPoE daemon */
	pppoed		*pppoed;
	/** Pointer to the PPP context */
	void 		*ppp;
	/** Session id */
	uint16_t	session_id;
	/** Cookie number */
	int		acookie;
	/** Peer ethernet address */
	u_char 		ether_addr[ETHER_ADDR_LEN];
	/** Index of listener */
	uint16_t	listener_index;
	/** Cache for ethernet frame header */
	struct ether_header ehdr;
	int lcp_echo_interval;			/* XXX can remove */
	int lcp_echo_max_failure;		/* XXX can remove */
	/** Context of event(3) for disposing */
	struct event ev_disposing;
} pppoe_session;

#define	PPPOE_SESSION_STATE_INIT		0 /** Inital */
#define	PPPOE_SESSION_STATE_RUNNING		1 /** Running */
#define	PPPOE_SESSION_STATE_DISPOSING		2 /** Disposing */

#define	pppoed_need_polling(pppoed)	\
    (((pppoed)->listen_incomplete != 0)? 1 : 0)

#ifdef __cplusplus
extern "C" {
#endif

int         pppoe_session_init (pppoe_session *, pppoed *, int, int, u_char *);
void        pppoe_session_fini (pppoe_session *);
void        pppoe_session_stop (pppoe_session *);
int         pppoe_session_recv_PADR (pppoe_session *, slist *);
int         pppoe_session_recv_PADT (pppoe_session *, slist *);
void        pppoe_session_input (pppoe_session *, u_char *, int);
void        pppoe_session_disconnect (pppoe_session *);

int         pppoed_add_listener (pppoed *, int, const char *, const char *);
int         pppoed_reload_listeners(pppoed *);

int         pppoed_init (pppoed *);
int         pppoed_start (pppoed *);
void        pppoed_stop (pppoed *);
void        pppoed_uninit (pppoed *);
void        pppoed_pppoe_session_close_notify(pppoed *, pppoe_session *);
const char *pppoed_tlv_value_string(struct pppoe_tlv *);
int         pppoed_reload(pppoed *, struct pppoe_confs *);

#ifdef __cplusplus
}
#endif
#endif
@


1.6
log
@Switch from <sys/endian.h> or <machine/endian.h> to the new,
being-standardized <endian.h>

ok deraadt@@ millert@@ beck@@
@
text
@d1 1
a1 1
/*	$OpenBSD: pppoe.h,v 1.5 2012/09/18 13:14:08 yasuoka Exp $ */
d162 1
a162 1
	int		session_id;
@


1.5
log
@New configuration syntax for npppd(8).  `npppd.conf' will be based on
parse.y and `npppd-users' will be based on getcap(3).  Add man pages.

feedback from giovanni
@
text
@d1 1
a1 1
/*	$OpenBSD: pppoe.h,v 1.4 2012/05/08 13:15:12 yasuoka Exp $ */
d65 1
a65 1
#if _BYTE_ORDER == _BIG_ENDIAN
@


1.4
log
@Fix comments and styles.  Delete unused variables and labels.
No binary changes.

ok mcbride henning
@
text
@d1 1
a1 1
/*	$OpenBSD: pppoe.h,v 1.3 2010/07/02 21:20:57 yasuoka Exp $ */
d85 3
a87 1
/** Default data link layer label */
d123 3
a125 1
	char	phy_label[PPPOED_PHY_LABEL_SIZE];
a146 3
	/** Configuration {@@link struct properties properties} */
	struct properties *config;

a148 4
	    desc_in_pktdump:1,
	    desc_out_pktdump:1,
	    session_in_pktdump:1,
	    session_out_pktdump:1,
d150 1
a150 1
	    reserved:27;
a195 1

d199 7
a205 16
int   pppoed_init (pppoed *);
int   pppoed_start (pppoed *);
void  pppoed_stop (pppoed *);
void  pppoed_uninit (pppoed *);
void  pppoed_pppoe_session_close_notify(pppoed *, pppoe_session *);
const char * pppoed_tlv_value_string(struct pppoe_tlv *);
int pppoed_reload(pppoed *, struct properties *, const char *, int);
const char   *pppoed_config_str (pppoed *, const char *);
int          pppoed_config_int (pppoed *, const char *, int);
int          pppoed_config_str_equal (pppoed *, const char *, const char *, int);
int          pppoed_config_str_equali (pppoed *, const char *, const char *, int);

const char   *pppoed_listener_config_str (pppoed_listener *, const char *);
int          pppoed_listener_config_int (pppoed_listener *, const char *, int);
int          pppoed_listener_config_str_equal (pppoed_listener *, const char *, const char *, int);
int          pppoed_listener_config_str_equali (pppoed_listener *, const char *, const char *, int);
@


1.3
log
@add $OpenBSD$ and remove trailing space.  no functional change.
@
text
@d1 1
a1 1
/* $OpenBSD$ */
@


1.2
log
@Translate Japanese comments or labels into English.  Translation was
done by IIJ people (MATSUI Yoshihiro, SAITOH Masanobu, Tomoyuki Sahara),
yuo@@ and myself.

This diff also includes
 - delete part of useless comments, correct spelling.
 - add man page of npppdctl.

There is no functional change.
@
text
@d1 2
@


1.1
log
@Initial import npppd(8).  npppd is a new PPP daemon that handles many
ppp sessions as a server.  It supports L2TP, PPTP and PPPoE as
tunneling.

ok mcbride@@ dlg@@ deraadt@@ reyk@@.
@
text
@d30 1
a30 1
 * プロトコル上の定数 (RFC 2516)
d61 1
a61 1
/** PPPoE ヘッダ */
d73 1
a73 1
/** PPPoE TLV ヘッダ */
d81 1
a81 1
 * 実装
d83 1
a83 1
/** デフォルトの物理層ラベル */
d91 1
a91 1
 * pppoed ステータス
d93 3
a95 6
/** 初期状態 */
#define	PPPOED_STATE_INIT 		0
/** 走行中 */
#define	PPPOED_STATE_RUNNING 		1
/** 停止j状態 */
#define	PPPOED_STATE_STOPPED 		2
d104 1
a104 1
/** PPPoE デーモン待ち受け型 */
d106 1
a106 1
	/** bpf(4) デバイスファイルのディスクリプタ */
d108 1
a108 1
	/** bpf 用のイベントコンテキスト */
d110 1
a110 1
	/** PPPoE デーモン自身 */
d112 1
a112 1
	/** イーサネットアドレス */
d114 1
a114 1
	/** インデックス番号 */
d116 1
a116 1
	/** 待ち受けるインタフェース名 */
d118 1
a118 1
	/** 物理層のラベル */
d122 1
a122 1
/** PPPoE デーモンを示す型です。*/
d124 1
a124 1
	/** PPPoE デーモンの Id */
d126 1
a126 1
	/** 待ち受けリスト */
d128 1
a128 1
	/** このデーモンの状態 */
a129 1
	/** タイムアウトイベント **/
d131 1
a131 1
	/** セッション番号 => pppoe_session のハッシュマップ */
d133 1
a133 1
	/** 空きセッション番号リスト */
d136 1
a136 1
	/** クッキー所持セッションのハッシュマップ */
d138 1
a138 1
	/** 次のクッキー番号 */
d141 1
a141 1
	/** 設定プロパティ */
d144 1
a144 1
	/** フラグ */
a150 1
	    /* phy_label_with_ifname:1,	PPPoE は不要 */
d154 1
a154 1
/** PPPoE セッションを示す型です */
d156 1
d158 1
a158 1
	/** 親 PPPoE デーモン */
d160 1
a160 1
	/** PPP コンテキスト */
d162 1
a162 1
	/** セッション Id */
d164 1
a164 1
	/** クッキー番号 */
d166 1
a166 1
	/** 対抗のイーサネットアドレス */
d168 1
a168 1
	/** リスナインデックス */
d170 1
a170 1
	/** イーサヘッダキャッシュ */
d172 3
a174 7

	/** echo の送信間隔(秒) */
	int lcp_echo_interval;
	/** echo の最大連続失敗回数 */
	int lcp_echo_max_failure;

	/** 終了処理のための event コンテキスト */
d178 3
a180 8
/** pppoe_session の状態が初期状態であることを示す定数です */
#define	PPPOE_SESSION_STATE_INIT		0

/** pppoe_session の状態が走行状態であることを示す定数です */
#define	PPPOE_SESSION_STATE_RUNNING		1

/** pppoe_session の状態が終了中であることを示す定数です */
#define	PPPOE_SESSION_STATE_DISPOSING		2
d182 2
a183 1
#define	pppoed_need_polling(pppoed)	(((pppoed)->listen_incomplete != 0)? 1 : 0)
@

