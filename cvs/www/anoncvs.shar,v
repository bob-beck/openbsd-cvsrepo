head	1.30;
access;
symbols;
locks; strict;
comment	@# @;


1.30
date	2017.09.26.11.46.42;	author ajacoutot;	state Exp;
branches;
next	1.29;
commitid	rigUwZvghW65s6jn;

1.29
date	2016.05.17.03.24.18;	author beck;	state Exp;
branches;
next	1.28;
commitid	mAHVo7E4h5koNWtr;

1.28
date	2016.05.17.02.54.53;	author beck;	state Exp;
branches;
next	1.27;
commitid	Fr0ejFrrdv11IXb4;

1.27
date	2016.03.11.19.29.52;	author sthen;	state Exp;
branches;
next	1.26;
commitid	Ono8rZpmGmZzqYh3;

1.26
date	2016.03.03.02.12.43;	author sthen;	state Exp;
branches;
next	1.25;
commitid	z8dEHP0b1ecbhNtz;

1.25
date	2016.02.07.21.39.58;	author sthen;	state Exp;
branches;
next	1.24;
commitid	TZrL8fX4FyKNReBn;

1.24
date	2012.10.16.23.09.45;	author dtucker;	state Exp;
branches;
next	1.23;

1.23
date	2010.06.26.17.27.15;	author beck;	state Exp;
branches;
next	1.22;

1.22
date	2009.08.10.09.16.52;	author landry;	state Exp;
branches;
next	1.21;

1.21
date	2009.04.19.21.01.54;	author landry;	state Exp;
branches;
next	1.20;

1.20
date	2008.06.11.04.51.44;	author joris;	state Exp;
branches;
next	1.19;

1.19
date	2008.06.10.22.52.11;	author beck;	state Exp;
branches;
next	1.18;

1.18
date	2005.02.25.20.33.16;	author millert;	state Exp;
branches;
next	1.17;

1.17
date	2005.01.19.21.08.09;	author espie;	state Exp;
branches;
next	1.16;

1.16
date	2003.07.30.20.27.32;	author millert;	state Exp;
branches;
next	1.15;

1.15
date	2003.06.17.23.06.36;	author millert;	state Exp;
branches;
next	1.14;

1.14
date	2002.10.02.21.56.53;	author millert;	state Exp;
branches;
next	1.13;

1.13
date	2002.08.13.02.12.47;	author millert;	state Exp;
branches;
next	1.12;

1.12
date	2002.02.06.18.54.07;	author miod;	state Exp;
branches;
next	1.11;

1.11
date	99.01.06.22.07.47;	author millert;	state Exp;
branches;
next	1.10;

1.10
date	98.12.22.22.55.19;	author beck;	state Exp;
branches;
next	1.9;

1.9
date	97.10.13.21.28.47;	author beck;	state Exp;
branches;
next	1.8;

1.8
date	97.10.13.21.18.48;	author beck;	state Exp;
branches;
next	1.7;

1.7
date	97.10.12.21.52.09;	author beck;	state Exp;
branches;
next	1.6;

1.6
date	97.09.10.07.25.19;	author deraadt;	state Exp;
branches;
next	1.5;

1.5
date	96.09.20.07.57.45;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	96.09.14.22.16.56;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	96.06.22.13.30.06;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	96.05.13.23.47.51;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	96.05.13.18.43.55;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.30
log
@Needs err.h for err(3).

ok sthen@@
@
text
@# This is a shell archive.  Save it in a file, remove anything before
# this line, and then unpack it by entering "sh file".  Note, it may
# create directories; files and directories will be owned by you and
# have default permissions.
#
# This archive contains:
#
#	Makefile
#	README
#	anoncvssh.c
#
echo x - Makefile
sed 's/^X//' >Makefile << 'END-of-Makefile'
X#CVSROOT=anoncvs@@anoncvs1.usa.openbsd.org:/cvs
XPROG=   anoncvssh
XBINOWN= root
XBINMODE=4111
XBINDIR=/open
XNOMAN=
X
X.include <bsd.prog.mk>
X
END-of-Makefile
echo x - README
sed 's/^X//' >README << 'END-of-README'
X
X        So, you want to run an anoncvs server.
X
X        A summary of the steps you'll need to do is:
X
X1) Find enough disk space to hold the anoncvs tree, and mount it in an
X   appropriate place.
X
X2) Compile and install anoncvssh, the shell used for the anoncvs user.
X   Install the cvsync client using 'pkg_add cvsync' command.
X   ( If you aren't using OpenBSD you'll probably need to compile a cvsync
X     client as well. The easier path is to use OpenBSD ;).
X
X3) Add the anoncvs user to the password file, with no password, and
X   anoncvssh as it's shell. Decide on a user that will run cvsync to maintain
X   the archive (this is a different user, NOT the anoncvs user).
X
X4) Make a home directory for the anoncvs user. The anoncvs user's
X   home directory is a chroot jail in which the anoncvssh processes
X   run when servicing anoncvs requests. The jail must contain the
X   cvs binary as well as whatever shared libraries and support files
X   are needed to run them unless you compile and link everything
X   statically. This example shows what is needed for OpenBSD. If you
X   use another platform you'll need to be familiar with what needs
X   to go in a chroot jail for your platform.
X
X5) Get permission to use cvsync to obtain the cvs tree from a server.
X
X6) Set up cvsync to retrieve the cvs tree from an appropriate place.
X
X7) Run cvsync to retrieve the distribution from the server.
X
X8) Once you get the distribution in, set up a cron job to run cvsync
X   periodically to keep your server up to date.
X
X**********************************************************************
XSTEP 1) find enough disk space.
X    You need roughly 6GB.
X    Mount it on /open, make sure it doesn't have nosuid and nodev flags.
X    If you are not able to mount it as /open, substitute it's location
X    throughout the rest of this description.
X
X**********************************************************************
XSTEP 2) compile the anoncvssh binary.
X    In the Makefile, change the variable CVSROOT.
X    Install the binary setuid-root in /open/anoncvssh.
X
X**********************************************************************
XSTEP 3) Create the anoncvs account and decide who will run "cvsync"
X    to maintain the archive. The anoncvs account should *NOT* be the one
X    running cvsync to maintain the archive.
X
Xcreate an account similar to:
X
X    anoncvs::32766:32766::0:0:Anonymous CVS User:/open/anoncvs:/open/anoncvssh
X
XYes, that is right - the account has no password. Be sure that the
Xuid and gid are unique for your system, if the ones above aren't,
Xpick different values.
X
XDecide who will run cvsync to maintain the archive. Call that user
X$CVSYNCUSER.  Oh, and in case it hasn't been previously mentioned,
X$CVSYNCUSER should *NOT* be the anoncvs user :).
X
XAdd the following to the end of your /etc/ssh/sshd_config and restart
Xyour sshd daemon:
X
XMatch User anoncvs
X        PermitEmptyPasswords yes
X        AllowTcpForwarding no
X        AllowAgentForwarding no
X        X11Forwarding no
X        PermitTTY no
X
X**********************************************************************
XSTEP 4) Build the anoncvs user's home directory chroot jail. This
X    example assumes that you're using OpenBSD. If you're not you
X    may need different files in the chroot.
X
Xmkdir /open/anoncvs
Xmkdir /open/anoncvs/cvs
Xchown -R $CVSYNCUSER /open/anoncvs/cvs /open/anoncvs
X
XStart filling the account up with nice stuff. You are building a chroot
Xjail for anoncvs in /open/anoncvs.
X
X    cd /open/anoncvs
X    touch .hushlogin
X    touch .profile
X    mkdir bin dev tmp usr var etc
X    cp /bin/{cat,pwd,rm,sh} bin/
X
XUsing mknod, make a dev/null that has the same major/minor numbers as
X    your /dev/null, and make it mode 666.
X
XSome shared library systems require a dev/zero created in the same way.
X
XFill etc space for the account
X    cp /etc/{group,hosts,passwd,protocols} etc/
X    cp /etc/{pwd.db,resolv.conf,services,ttys} etc/
X    modify these files to suit your idea of system security
X
Xanoncvssh (by setting the environment variable CVSREADONLYFS) uses
Xa tiny extension provided in the openbsd cvs server code which
Xpermits the use of read-only cvs repositories, therefore you MUST
Xcompile the openbsd version of cvs.  Luckily this is not a problem
Xon a non-openbsd machine, since the cvs sources are imported verbatim
Xinto the openbsd tree.  They are in gnu/usr.bin/cvs.  The sources
Xare integrated in such way that Makefile.bsd-wrapper knows how to build
Xthe sources on an OpenBSD machine, using obj directories.
X
XCreate tmp space for the account
X    # (cd var && ln -s ../tmp tmp)
X    # chmod a+rwx tmp
X
X    # mkdir usr/{bin,lib}
X    # cp /usr/bin/cvs usr/bin/
X
XIf your system has ld.so in /usr/libexec,
X    # mkdir usr/libexec
X    # cp /usr/libexec/ld.so usr/libexec/
X
XIf using shared libraries, use ldd to find out which shared libs you need:
X    # ldd /usr/bin/cvs
X        /usr/bin/cvs:
X                Start    End      Type Open Ref GrpRef Name
X                1c000000 3c01f000 exe  1    0   0      /usr/bin/cvs
X                0f802000 2f80a000 rlib 0    1   0      /usr/lib/libz.so.5.0
X                094d2000 2950b000 rlib 0    1   0      /usr/lib/libc.so.84.2
X                094ca000 094ca000 rtld 0    1   0      /usr/libexec/ld.so
X
X    and then copy the required libraries to usr/lib/
X
XAs a final pass, make sure that all the files you have just created are
Xnot world writable (except dev/null).
X
XFor :pserver: support (optional)
X  - Create an entry in /etc/services
X     cvspserver 2401/tcp    # CVS client/server operations
X  - Create an entry in /etc/inetd.conf
X     cvspserver stream tcp nowait anoncvs /open/anoncvssh anoncvssh pserver
X  - Create a file /open/anoncvs/cvs/CVSROOT/passwd with the following entry
X        anoncvs:AHDysQkJIubEc
X    which would be a password of "anoncvs" (as per anoncvs.html)
X  - Create a file /open/anoncvs/cvs/CVSROOT/readers with a single entry:
X        anoncvs
X    which tells cvs that user "anoncvs" is allowed readonly access.
X  - Create a zero-length file /open/anoncvs/cvs/CVSROOT/writers since you don't
X    want anyone to be able to write to the mirror.
X        % cp /dev/null /open/anoncvs/cvs/CVSROOT/writers
X
XSee the example layout below for full details.
X
X**********************************************************************
XSTEP 5): Get cvsync permission.
Xsend mail to sup@@openbsd.org
X1) to have cvsync permissions granted on an appropriate machine for you
X   to cvsync from. We will need to know your host's real hostname and
X   IP address.
X2) to have an anoncvsN.COUNTRY.openbsd.org alias created.
X3) to have your site mentioned in the http://www.openbsd.org/anoncvs.html page.
X
X**********************************************************************
XSTEP 6): Configure cvsync.
X
XYou have to install cvsync package.
X
XThe file /etc/cvsync.conf contains the configuration of cvsync. It will
Xnormally contain:
X
Xconfig {
X        base-prefix /open/anoncvs/
X        hostname anoncvs.ca.openbsd.org
X        collection {
X                name openbsd-cvsroot release rcs
X                prefix cvs
X        }
X        collection {
X                name openbsd-src release rcs
X                prefix cvs
X        }
X        collection {
X                name openbsd-ports release rcs
X                prefix cvs
X        }
X        collection {
X                name openbsd-www release rcs
X                prefix cvs
X        }
X        collection {
X                name openbsd-xenocara release rcs
X                prefix cvs
X        }
X}
X
X**********************************************************************
XSTEP 7): Run cvsync to retrieve the tree for the first time.
X
XLog in as or become the $CVSYNCUSER, and run
X
Xcvsync > /tmp/cvsynclog &; tail -f /tmp/cvsynclog
X
XIf you have cvsync permission, and have specified the correct host and
Xprefix in /etc/cvsync.conf you should see a list of files start
Xcoming in after a short while. Don't panic if nothing happens
Ximmediately.  Watch for errors (cvsync can timeout or die). If you can't
Xaccess files contact the cvsync server maintainer. If you get a timeout
Xor if cvsync dies you can restart and it should continue where it left off.
X
XIt can take a good while (and a couple of restarts) to obtain the
Xwhole tree for the first time.
X
X**********************************************************************
XSTEP 8): Set up cron to keep the tree up to date.
X
XYou run cvsync periodically from the cron by setting up the crontab file
Xof the $CVSYNCUSER.
X
XFor example, to update every two hours:
X
X15 */2 * * * /usr/local/bin/cvsync > /dev/null
X
X**********************************************************************
X
XEXAMPLE LAYOUT
X
XExample layout for OpenBSD. In this example "deraadt" is the $CVSYNCUSER.
X
X$ cd /open
X$ ls -alF
Xtotal 64
Xdrwxr-xr-x   5 root    wheel     512 Jun 18 22:29 ./
Xdrwxr-xr-x  13 root    wheel     512 Jun  4 05:14 ../
Xdrwxr-xr-x   9 deraadt wheel     512 Jun  3 02:15 anoncvs/
X---s--x--x   1 root    wheel   14302 Jun 18 22:29 anoncvssh*
Xdrwxr-xr-x   4 root    wheel    5120 Jun 10 14:34 ftp/
X
X$ cd anoncvs
X$ ls -alF
Xtotal 68
Xdrwxr-xr-x   9 root    wheel    512 Jun  3 02:15 ./
Xdrwxr-xr-x   5 root    wheel    512 Jun 10 14:32 ../
X-rw-r--r--   1 root    wheel      0 Jun  3 01:50 .hushlogin
X-rw-r--r--   1 root    wheel     84 Jun  3 01:50 .plan
X-rw-r--r--   1 root    wheel      0 Jun  3 01:50 .profile
Xdrwxr-xr-x   2 root    wheel    512 Jun  3 01:40 bin/
Xdrwxr-xr-x   7 deraadt wheel    512 Jun 18 22:19 cvs/
Xdrwxr-xr-x   2 root    wheel    512 Jun  3 01:51 dev/
Xdrwxr-xr-x   2 root    wheel    512 Jun  3 01:53 etc/
Xdrwxrwxrwx  10 root    wheel    512 Jun 18 17:38 tmp/
Xdrwxr-xr-x   5 root    wheel    512 Jun  3 01:54 usr/
Xdrwxr-xr-x   2 root    wheel    512 Jun  3 01:54 var/
X$ ls -alFR bin usr tmp etc dev
Xbin:
Xtotal 1984
Xdrwxr-xr-x  2 root  wheel     512 Jun  3 01:40 ./
Xdrwxr-xr-x  9 root  wheel     512 Jun  3 02:15 ../
X-r-xr-xr-x  1 root  wheel  132368 Jun  3 01:40 cat*
X-r-xr-xr-x  1 root  wheel  124176 Jun  3 01:40 pwd*
X-r-xr-xr-x  1 root  wheel  238864 Jun  3 01:40 rm*
X-r-xr-xr-x  1 root  wheel  460048 Jun  3 01:40 sh*
X  
Xdev:
Xtotal 8
Xdrwxr-xr-x  2 root  wheel       512 Jun  3 01:51 ./
Xdrwxr-xr-x  9 root  wheel       512 Jun  3 02:15 ../
Xcrw-rw-rw-  1 root  wheel    3,   2 Jun  3 01:51 null
Xcrw-rw-rw-  1 root  wheel    3,  12 Jun  3 01:51 zero
X  
Xetc:
Xtotal 188
Xdrwxr-xr-x  2 root  wheel    512 Jun  3 01:53 ./
Xdrwxr-xr-x  9 root  wheel    512 Jun  3 02:15 ../
X-r--r--r--  1 root  wheel     64 Jun  3 01:52 group*
X-r--r--r--  1 root  wheel    576 Jun  3 01:52 hosts*
X-r--r--r--  1 root  wheel    291 Jun  3 01:53 passwd*
X-r--r--r--  1 root  wheel   5625 Jun  3 01:52 protocols*
X-r--r--r--  1 root  wheel  40960 Jun  3 01:52 pwd.db*
X-r--r--r--  1 root  wheel     93 Jun  3 01:52 resolv.conf*
X-r--r--r--  1 root  wheel   9875 Jun  3 01:52 services*
X-r--r--r--  1 root  wheel  26428 Jun  3 01:52 ttys*
X
Xusr:
Xtotal 20
Xdrwxr-xr-x  5 root  wheel  512 Jun  3 01:54 ./
Xdrwxr-xr-x  9 root  wheel  512 Jun  3 02:15 ../
Xdrwxr-xr-x  2 root  wheel  512 Jun  3 01:57 bin/
Xdrwxr-xr-x  2 root  wheel  512 Jun  3 01:56 lib/
Xdrwxr-xr-x  2 root  wheel  512 Jun  3 01:55 libexec/
X
Xusr/bin:
Xtotal 3016
Xdrwxr-xr-x  2 root  wheel     512 Jun  3 01:57 ./
Xdrwxr-xr-x  5 root  wheel     512 Jun  3 01:54 ../
X-r-xr-xr-x  1 root  wheel  643728 Jun  3 01:54 cvs*
X
Xusr/lib:
Xtotal 42344
Xdrwxr-xr-x  2 root  wheel      512 Jun  3 01:56 ./
Xdrwxr-xr-x  5 root  wheel      512 Jun  3 01:54 ../
X-r--r--r--  1 root  wheel  4605409 Jun  3 01:56 libc.so.84.2
X-r--r--r--  1 root  wheel   182556 Jun  3 01:55 libz.so.5.0
X
Xusr/libexec:
Xtotal 120
Xdrwxr-xr-x  2 root  wheel    512 Jun  3 01:55 ./
Xdrwxr-xr-x  5 root  wheel    512 Jun  3 01:54 ../
X-r-xr-xr-x  1 root  wheel  55683 Jun  3 01:55 ld.so*
X$ ls cvs
XCVSROOT  ports    src      www      xenocara
X
END-of-README
echo x - anoncvssh.c
sed 's/^X//' >anoncvssh.c << 'END-of-anoncvssh.c'
X/*
X * Copyright (c) 2002 Todd C. Miller <Todd.Miller@@courtesan.com>
X * Copyright (c) 1997 Bob Beck <beck@@obtuse.com>
X * Copyright (c) 1996 Thorsten Lockert <tholo@@sigmasoft.com>
X *
X * Permission to use, copy, modify, and distribute this software for any
X * purpose with or without fee is hereby granted, provided that the above
X * copyright notice and this permission notice appear in all copies.
X *
X * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
X * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
X * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
X * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
X * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
X * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
X * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
X */
X
X#include <stdio.h>
X#include <stdlib.h>
X#include <err.h>
X#if defined(__OpenBSD__) || defined(__NetBSD__) || defined(__FreeBSD__)
X#include <paths.h>
X#endif
X#include <pwd.h>
X#include <unistd.h>
X#include <sys/types.h>
X
X#ifndef __P
X#if defined(__STDC__) || defined(__cplusplus)
X#define	__P(protos)	protos		/* full-blown ANSI C */
X#else
X#define	__P(protos)	()		/* traditional C preprocessor */
X#endif
X#endif
X
X/*
X * You may need to change this path to ensure that RCS, CVS and diff
X * can be found
X */
X#ifndef _PATH_DEFPATH
X#define	_PATH_DEFPATH	"/bin:/usr/bin"
X#endif
X
X/*
X * This should not normally have to be changed
X */
X#ifndef _PATH_BSHELL
X#define _PATH_BSHELL	"/bin/sh"
X#endif
X
X/*
X * Location of CVS tree, relative to the anonymous CVS user's
X * home directory
X */
X#ifndef LOCALROOT
X#define	LOCALROOT	"/cvs"
X#endif
X
X/*
X * Hostname to be used when accessing the remote repository.
X */
X#ifndef HOSTNAME
X#define	HOSTNAME	"anoncvs1.usa.openbsd.org"
X#endif
X
X/*
X * Username to be used when accessing the remote repository.
X */
X#ifndef USERNAME
X#define USERNAME	"anoncvs"
X#endif
X
X/*
X * $CVSROOT is created based on USERNAME HOSTNAME and LOCALROOT above
X */
X#ifndef CVSROOT
X#define	CVSROOT		USERNAME "@@" HOSTNAME ":"LOCALROOT
X#endif
X
X/*
X * We define PSERVER_SUPPORT to allow anoncvssh to spawn a "cvs pserver".
X * You may undefine this if you aren't going to be running pserver.
X */
X#ifndef PSERVER_SUPPORT
X#define PSERVER_SUPPORT
X#endif
X
X
X/*
X * Define USE_SYSLOG if you want anoncvssh to log pserver connections
X * using syslog()
X */
X#define USE_SYSLOG
X
X#ifdef USE_SYSLOG
X#include <string.h>
X#include <syslog.h>
X#include <netinet/in.h>
X#include <sys/socket.h>
X#include <arpa/inet.h>
X#define LOG_FACILITY LOG_DAEMON
X#define LOG_PRIO LOG_INFO
X#endif
X
X/* Define ANONCVS_USER if you want anoncvssh to complain if invoked by
X * anyone other than root or ANONCVS_USER.
X */
X/* #define ANONCVS_USER USERNAME */
X
Xint main __P((int, char *[]));
X
Xchar * const env[] = {
X	"PATH="_PATH_DEFPATH,
X	"SHELL="_PATH_BSHELL,
X	"CVSROOT="LOCALROOT,
X	"HOME=/",
X	"CVSREADONLYFS=1",
X	NULL
X};
X
Xint
Xmain(argc, argv)
Xint argc;
Xchar *argv[];
X{
X	struct passwd *pw;
X#ifdef DEBUG
X	int i;
X#endif /* DEBUG */
X
X	pw = getpwuid(getuid());
X	if (pw == NULL) {
X		fprintf(stderr, "no user for uid %d\n", getuid());
X		exit(1);
X	}
X	if (pw->pw_dir == NULL) {
X		fprintf(stderr, "no directory\n");
X		exit(1);
X	}
X
X#ifdef USE_SYSLOG
X	openlog("anoncvssh", LOG_PID | LOG_NDELAY, LOG_FACILITY);
X#endif /* USE_SYSLOG */
X
X#ifdef ANONCVS_USER
X	/*
X	 * I love lusers who have to test every setuid binary on my machine.
X	 */
X	if (getuid() != 0 && (strcmp (pw->pw_name, ANONCVS_USER) != 0)) {
X		fprintf(stderr, "You're not supposed to be running me!\n");
X#ifdef USE_SYSLOG
X		syslog(LOG_NOTICE,
X		       "User %s(%d) invoked anoncvssh - Possible twink?",
X		       pw->pw_name, pw->pw_uid);
X#endif /* USE_SYSLOG */
X		exit(1);
X	}
X#endif /* ANONCVS_USER */
X
X
X	setuid(0);
X	if (chroot(pw->pw_dir) == -1) {
X		perror("chroot");
X		exit (1);
X	}
X	chdir("/");
X	setuid(pw->pw_uid);
X
X	if (pledge("stdio inet exec", NULL) == -1)
X		err(1, "pledge");
X
X	/*
X	 * program now "safe"
X	 */
X
X#ifdef PSERVER_SUPPORT
X	/* If we want pserver functionality */
X	if ((argc == 2) && (strcmp("pserver", argv[1]) == 0)) {
X#ifdef USE_SYSLOG
X 	        int slen;
X		struct sockaddr_in my_sa, peer_sa;
X		char *us, *them;
X
X		slen = sizeof(my_sa);
X		if (getsockname(0, (struct sockaddr *) &my_sa, &slen)
X		    != 0) {
X		  perror("getsockname");
X		  exit(1);
X		}
X		us = strdup(inet_ntoa(my_sa.sin_addr));
X		if (us == NULL) {
X		  fprintf(stderr, "malloc failed\n");
X		  exit(1);
X		}
X		slen = sizeof(peer_sa);
X		if (getpeername(0, (struct sockaddr *) &peer_sa, &slen)
X		    != 0) {
X		  perror("getpeername");
X		  exit(1);
X		}
X		them=strdup(inet_ntoa(peer_sa.sin_addr));
X		if (them == NULL) {
X		  fprintf(stderr, "malloc failed\n");
X		  exit(1);
X		}
X	        syslog(LOG_PRIO,
X		       "pserver connection from %s:%d to %s:%d\n",
X		       them, ntohs(peer_sa.sin_port),
X		       us, ntohs(my_sa.sin_port));
X#endif /* USE_SYSLOG */
X		execle("/usr/bin/cvs", "cvs",
X		    "--allow-root="LOCALROOT, "pserver", (char *)NULL, env);
X		perror("execle: cvs");
X		fprintf(stderr, "unable to exec CVS pserver!\n");
X		exit(1);
X		/* NOTREACHED */
X	}
X#endif
X
X	if (argc != 3 ||
X		strcmp("anoncvssh",  argv[0]) != 0 ||
X		strcmp("-c",         argv[1]) != 0 ||
X		(strcmp("cvs server", argv[2]) != 0 &&
X		 strcmp("cvs -d "LOCALROOT" server", argv[2]) != 0)) {
X		fprintf(stderr, "\nTo use anonymous CVS install the latest ");
X		fprintf(stderr,"version of CVS on your local machine.\n");
X		fprintf(stderr,"Then set your CVSROOT environment variable ");
X		fprintf(stderr,"to the following value:\n");
X		fprintf(stderr,"\t%s\n\n", CVSROOT);
X#ifdef DEBUG
X		fprintf(stderr, "argc = %d\n", argc);
X		for (i = 0 ; i < argc ; i++)
X			fprintf(stderr, "argv[%d] = \"%s\"\n", i, argv[i]);
X#endif /* DEBUG */
X		sleep(10);
X		exit(0);
X	}
X
X		execle("/usr/bin/cvs", "cvs", "server", (char *)NULL, env);
X
X	perror("execle: cvs");
X	fprintf(stderr, "unable to exec CVS server!\n");
X	exit(1);
X	/* NOTREACHED */
X}
X
END-of-anoncvssh.c
exit

@


1.29
log
@pledge anoncvssh
@
text
@d360 1
@


1.28
log
@nuke trailing whitespace - no binary change
@
text
@d1 587
a587 20
ELF          >    ê      @@       P          @@ 8  @@         @@       @@       @@       ÿ      ÿ                                                                                        >      >                   @@      @@     @@     ¨      ¨                                     Ä      Ä                   p      p0     p0                                `      `@@     `@@            `                    0      0      0      @@      @@                   ,      ,      ,                           PÂtd   ò      ò     ò     D       D              Ê€£e                                                                                                                                                          /usr/libexec/ld.so           OpenBSD         %   +   '   (                           !       )               *   #           $                                 "   &       %                                                                                                                                                                                                                                          0                   
 ê                    0                    @@                   ò                   ‡                                       ¯                                         @@0                   P0                   `@@                   Ä@@                                  ±    Òˇ`0                           D                    †      #                     *              a       •    Òˇp0             0              ∏       8                     >                     F              »      K              V       œ    Òˇp@@             R              G       \              ∏       c              o       l              	       €     0              s                                   R       ã              â      »    Òˇp@@             ∂    Òˇ¿@@             n                     ª     `@@             ‚                       í                     ô                      libc.so.86.0 chroot perror execle getuid sleep fprintf chdir openlog __sF strdup inet_ntoa syslog getpwuid atexit getpeername _csu_finish fwrite setuid getsockname __got_start __got_end __data_start _edata __bss_start __fini _Jv_RegisterClasses                 H                  ;                  I                  V                   ]     00            0      (0                   80        (           à0                   ê0                   ò0                   †0                   ®0                   ∞0                   ∏0                   ¿0                   »0                   –0                   ÿ0                   ‡0                   Ë0                   0        !           ¯0        "            0        #           0        &           0        (           0        )            0        *           HÉÏËó  HÉƒ√  ˇ520 ˇ%40 êêêêˇ%20 h    È‡ˇˇˇˇ%*0 h   È–ˇˇˇˇ%"0 h   È¿ˇˇˇˇ%0 h   È∞ˇˇˇˇ%0 h   È†ˇˇˇˇ%
0 h   Èêˇˇˇˇ%0 h   ÈÄˇˇˇˇ%˙0 h   Èpˇˇˇˇ%Ú0 h   È`ˇˇˇˇ%Í0 h	   ÈPˇˇˇˇ%‚0 h
   È@@ˇˇˇˇ%⁄0 h   È0ˇˇˇˇ%“0 h   È ˇˇˇˇ% 0 h   Èˇˇˇˇ%¬0 h   È ˇˇˇˇ%∫0 h   È˛ˇˇˇ%≤0 h   È‡˛ˇˇˇ%™0 h   È–˛ˇˇˇ%¢0 h   È¿˛ˇˇˇ%ö0 h   È∞˛ˇˇHâ—Hã<$HçT¸Hçt$HÉÏHÉ‰HÉƒÎêUHâÂLâeIâÙHâ]ËHâ÷Lâm¯Hâ HÉÏ0Aâ˝LâÁËXˇˇˇHâ√1¿ËN˛ˇˇHãDâÔLâÊ1¿ËN  â«ËWˇˇˇêêêêêêêUHâÂ…√fffêffêffêUHâÂATSHÉÏHÉ=%0  t?Hç0 ∫   Hâ»HÉ¬HÉ<— uıHçZ˛Lçd–¯HÉ˚ˇtfêHÉÎIã$IÉÏˇ–HÉ˚ˇuÏHÉƒ[A\…√ffêUHâÂSHÉÏHãÿ
0 HÖ¿tHçÃ
0 fffêˇ–HãCHÉ√HÖ¿uÒHÉƒ[…√fffêffêffêUãµ
@@ HâÂÖ¿t…√«¢
@@    …Î£ffêUHâÂHÉÏãä
@@ Ö“t…√Hç5ï
@@ Hç=. «l
@@    Ëˇ˛ˇˇHÉ=Ô   tHÉ=%
0  tHç=‹  Ë?˛ˇˇËÍ˛ˇˇHã=
0 …È›˝ˇˇêêêêêêêêêêêêêATAâ¸UHâıSHÉÏ0Hãõ  HâD$(1¿Ë˝ˇˇâ«Ëò˝ˇˇHÖ¿Hâ√ÑÇ  HÉx0 Ñ§  Hç=‹ ∫   æ	   Ë+˝ˇˇ1ˇË‘˝ˇˇHã{0Ë´¸ˇˇÉ¿Ñ£  Hç=¶ Ëˆ¸ˇˇã{ËÆ˝ˇˇAÉ¸Ñl  AÉ¸uHã} Hç5Ö π
   ¸Û¶Ñ®   Hã6	0 Hç=ü ∫)   æ   Hçã0  Ë1˝ˇˇHçã0  Hç=´ ∫&   æ   Ë˝ˇˇHçã0  Hç=∂ ∫+   æ   Ë˜¸ˇˇHçã0  Hç=© ∫   æ   Ë⁄¸ˇˇHç≥ Hç5• Hçª0  1¿Ë¸ˇˇø
   Ë¸ˇˇ1ˇËΩ¸ˇˇHã}Hç5L π   Û¶Ö@@ˇˇˇLãEHç5? π   Lâ«Û¶tHç5$ π   Lâ«Û¶ÖˇˇˇLç   Hç Hç5€ Hç=ø 1…1¿Ër˚ˇˇHç=º ËV˚ˇˇHã0 Hç= ∫   æ   HÅ¡0  Ë¸ˇˇø   Ë¸ˇˇLç%4 Hã}π   ¸LâÊÛ¶Öó˛ˇˇHçl$$Hçt$1ˇ«D$$   HâÍË¸ˇˇÖ¿ÖÔ   ã|$Ë_˚ˇˇHâ«ËG˚ˇˇHÖ¿Hâ√t71ˇHâÊHâÍ«D$$   Ëz˚ˇˇÖ¿Öf  ã|$Ë)˚ˇˇHâ«Ë˚ˇˇHÖ¿Öµ   HãY0 Hç=± ∫   æ   HÅ¡0  ËT˚ˇˇø   ËZ˚ˇˇËÖ˙ˇˇHã=&0 Hç57 â¬1¿HÅ«0  Ëá˙ˇˇø   Ë-˚ˇˇHã˛0 Hç=# ∫   æ   HÅ¡0  Ë˘˙ˇˇø   Ëˇ˙ˇˇHç= Ë˙ˇˇø   ËÈ˙ˇˇHç= ËÌ˘ˇˇø   Ë”˙ˇˇHç5Ï Hâ¬D∑L$∑L$Iâÿø   1¿fA¡…f¡…E∑…∑…Ë?˙ˇˇLçH  Hç„  Hç5 Hç=Á  E1¿Lâ·1¿Ëñ˘ˇˇHç=‡  Ëz˘ˇˇHã;0 Hç=Ÿ  ∫   æ   HÅ¡0  Ë6˙ˇˇø   Ë<˙ˇˇHç={  Ë@@˘ˇˇø   Ë&˙ˇˇêê    HÉÏËw˚ˇˇHÉƒ√  no user for uid %d
 no directory
 anoncvssh chroot pserver getsockname malloc failed
 getpeername --allow-root=/cvs /usr/bin/cvs execle: cvs unable to exec CVS pserver!
 -c cvs -d /cvs server to the following value:
 	%s
a588 15
 unable to exec CVS server!
 SHELL=/bin/sh CVSROOT=/cvs HOME=/ CVSREADONLYFS=1    pserver connection from %s:%d to %s:%d
 
To use anonymous CVS install the latest        version of CVS on your local machine.
  Then set your CVSROOT environment variable      anoncvs@@anoncvs1.usa.openbsd.org:/cvs   PATH=/usr/bin:/bin:/usr/sbin:/sbin:/usr/X11R6/bin:/usr/local/bin        main    ;D      ¯Ôˇ`   h¯Ôˇà   x¯Ôˇ®   ÿ¯Ôˇ»   ˘ÔˇË   8˘Ôˇ  ®˘Ôˇ(             zR xê  $      ∞˜ÔˇI    AÜCDåUçÉ          D   ÿ˜Ôˇ    AÜC          d   »˜Ôˇ]    AÜCGÉå     Ñ   ¯Ôˇ6    AÜCEÉ       §   (¯Ôˇ    AÜI          ƒ   (¯Ôˇc    AÜC       $   ‰   x¯ÔˇÍ   BåDÜD DPÉ                             H     ;     I     V     ]                                  H             ò             ê      
       ˆ                                           p0            ‡                           P
             ê	             ¿       	              ˘ˇˇo                                                                                           0                      V      f      v      Ü      ñ      ¶      ∂      ∆      ÷      Ê      ˆ                  &      6      F      V      f      v      Ü              0              ˇˇˇˇˇˇˇˇ        ˇˇˇˇˇˇˇˇ                         .symtab .strtab .shstrtab .interp .note.openbsd.ident .hash .dynsym .dynstr .rela.dyn .rela.plt .init .text .fini .rodata .eh_frame_hdr .eh_frame .openbsd.randomdata .jcr .data.rel.ro .dynamic .got .ctors .dtors .data .bss                                                                                                                        #             ,      ,                                    7             H      H      H                           =             ê      ê                                E             ò      ò      ˆ                              M             ê	      ê	      ¿                            W             P
      P
      ‡         	                 a             0      0                                    \             @@      @@      P                            g             ê      ê      ú                             m             0      0                                    s             @@     @@      U                             {             ò     ò      D                              â             ‡     ‡                                   ì                                                       ß             ¯      ¯                                    ¨                           0                               π             0      0      @@                           ¬             p0     p      –                             «             @@0     @@                                    Œ             P0     P                                    ’             `@@     `                                    €             Ä@@     p      @@                                                     p      ‡                                                    !      0                          	                      @@'      n                                                                               ,                    H                    ê                    ò                    ê	                    P
                    0                   	 @@                   
 ê                    0                    @@                   ò                   ‡                                       ¯                                         0                    p0                   @@0                   P0                   `@@                   Ä@@                                                                                   Òˇ                   Òˇ0                 Òˇp0             ,                     3    Òˇ`0             =              D      D              †      K                     R              a       X    `@@            e                 s     0              z    Òˇp0             Ü              ∏       é                     î    
 ê              ú    
 ê              £                     ´              »      ∞              V       ∑    Òˇp@@             √    
 @@      Í      »              G       “              ∏       Ÿ              o       ‚              	       È     0                                   ¸            0                     R                    â         Òˇp@@                Òˇ¿@@                                 $    `@@             1                      E                    L  " 
               b                     anoncvssh.c _DYNAMIC _GLOBAL_OFFSET_TABLE_ chroot __got_end perror execle getuid sleep __dso_handle __guard_local __init __got_start fprintf chdir __start _start openlog __sF strdup __bss_start main inet_ntoa syslog getpwuid atexit __fini getpeername env _csu_finish fwrite _edata _end exit __data_start _Jv_RegisterClasses setuid __register_frame_info getsockname @


1.27
log
@anoncvs.shar updates, from Sevan Janiyan

- remove reference to .plan, a quick sample of anoncvs servers
didn't find any running finger

- remove opencvs references in anoncvsssh.c
@
text
@d1 20
a20 583
# This is a shell archive.  Save it in a file, remove anything before
# this line, and then unpack it by entering "sh file".  Note, it may
# create directories; files and directories will be owned by you and
# have default permissions.
#
# This archive contains:
#
#	Makefile
#	README
#	anoncvssh.c
#
echo x - Makefile
sed 's/^X//' >Makefile << 'END-of-Makefile'
X#CVSROOT=anoncvs@@anoncvs1.usa.openbsd.org:/cvs
XPROG=   anoncvssh
XBINOWN= root
XBINMODE=4111
XBINDIR=/open
XNOMAN=
X
X.include <bsd.prog.mk>
X
END-of-Makefile
echo x - README
sed 's/^X//' >README << 'END-of-README'
X
X        So, you want to run an anoncvs server.
X
X        A summary of the steps you'll need to do is:
X
X1) Find enough disk space to hold the anoncvs tree, and mount it in an
X   appropriate place.
X
X2) Compile and install anoncvssh, the shell used for the anoncvs user.
X   Install the cvsync client using 'pkg_add cvsync' command.
X   ( If you aren't using OpenBSD you'll probably need to compile a cvsync
X     client as well. The easier path is to use OpenBSD ;).
X
X3) Add the anoncvs user to the password file, with no password, and
X   anoncvssh as it's shell. Decide on a user that will run cvsync to maintain
X   the archive (this is a different user, NOT the anoncvs user).
X
X4) Make a home directory for the anoncvs user. The anoncvs user's
X   home directory is a chroot jail in which the anoncvssh processes
X   run when servicing anoncvs requests. The jail must contain the
X   cvs binary as well as whatever shared libraries and support files
X   are needed to run them unless you compile and link everything
X   statically. This example shows what is needed for OpenBSD. If you
X   use another platform you'll need to be familiar with what needs
X   to go in a chroot jail for your platform.
X
X5) Get permission to use cvsync to obtain the cvs tree from a server.
X
X6) Set up cvsync to retrieve the cvs tree from an appropriate place.
X
X7) Run cvsync to retrieve the distribution from the server.
X
X8) Once you get the distribution in, set up a cron job to run cvsync
X   periodically to keep your server up to date.
X
X**********************************************************************
XSTEP 1) find enough disk space.
X    You need roughly 6GB.
X    Mount it on /open, make sure it doesn't have nosuid and nodev flags.
X    If you are not able to mount it as /open, substitute it's location
X    throughout the rest of this description.
X
X**********************************************************************
XSTEP 2) compile the anoncvssh binary.
X    In the Makefile, change the variable CVSROOT.
X    Install the binary setuid-root in /open/anoncvssh.
X
X**********************************************************************
XSTEP 3) Create the anoncvs account and decide who will run "cvsync"
X    to maintain the archive. The anoncvs account should *NOT* be the one
X    running cvsync to maintain the archive.
X
Xcreate an account similar to:
X
X    anoncvs::32766:32766::0:0:Anonymous CVS User:/open/anoncvs:/open/anoncvssh
X
XYes, that is right - the account has no password. Be sure that the
Xuid and gid are unique for your system, if the ones above aren't,
Xpick different values.
X
XDecide who will run cvsync to maintain the archive. Call that user
X$CVSYNCUSER.  Oh, and in case it hasn't been previously mentioned,
X$CVSYNCUSER should *NOT* be the anoncvs user :).
X
XAdd the following to the end of your /etc/ssh/sshd_config and restart
Xyour sshd daemon:
X
XMatch User anoncvs
X        PermitEmptyPasswords yes
X        AllowTcpForwarding no
X        AllowAgentForwarding no
X        X11Forwarding no
X        PermitTTY no
X
X**********************************************************************
XSTEP 4) Build the anoncvs user's home directory chroot jail. This
X    example assumes that you're using OpenBSD. If you're not you
X    may need different files in the chroot.
X
Xmkdir /open/anoncvs
Xmkdir /open/anoncvs/cvs
Xchown -R $CVSYNCUSER /open/anoncvs/cvs /open/anoncvs
X
XStart filling the account up with nice stuff. You are building a chroot
Xjail for anoncvs in /open/anoncvs.
X
X    cd /open/anoncvs
X    touch .hushlogin
X    touch .profile
X    mkdir bin dev tmp usr var etc
X    cp /bin/{cat,pwd,rm,sh} bin/
X
XUsing mknod, make a dev/null that has the same major/minor numbers as
X    your /dev/null, and make it mode 666.
X
XSome shared library systems require a dev/zero created in the same way.
X
XFill etc space for the account
X    cp /etc/{group,hosts,passwd,protocols} etc/
X    cp /etc/{pwd.db,resolv.conf,services,ttys} etc/
X    modify these files to suit your idea of system security
X
Xanoncvssh (by setting the environment variable CVSREADONLYFS) uses
Xa tiny extension provided in the openbsd cvs server code which
Xpermits the use of read-only cvs repositories, therefore you MUST
Xcompile the openbsd version of cvs.  Luckily this is not a problem
Xon a non-openbsd machine, since the cvs sources are imported verbatim
Xinto the openbsd tree.  They are in gnu/usr.bin/cvs.  The sources
Xare integrated in such way that Makefile.bsd-wrapper knows how to build
Xthe sources on an OpenBSD machine, using obj directories.
X
XCreate tmp space for the account
X    # (cd var && ln -s ../tmp tmp)
X    # chmod a+rwx tmp
X
X    # mkdir usr/{bin,lib}
X    # cp /usr/bin/cvs usr/bin/
X
XIf your system has ld.so in /usr/libexec,
X    # mkdir usr/libexec
X    # cp /usr/libexec/ld.so usr/libexec/
X
XIf using shared libraries, use ldd to find out which shared libs you need:
X    # ldd /usr/bin/cvs
X        /usr/bin/cvs:
X                Start    End      Type Open Ref GrpRef Name
X                1c000000 3c01f000 exe  1    0   0      /usr/bin/cvs
X                0f802000 2f80a000 rlib 0    1   0      /usr/lib/libz.so.5.0
X                094d2000 2950b000 rlib 0    1   0      /usr/lib/libc.so.84.2
X                094ca000 094ca000 rtld 0    1   0      /usr/libexec/ld.so
X
X    and then copy the required libraries to usr/lib/
X
XAs a final pass, make sure that all the files you have just created are
Xnot world writable (except dev/null).
X
XFor :pserver: support (optional)
X  - Create an entry in /etc/services
X     cvspserver 2401/tcp    # CVS client/server operations
X  - Create an entry in /etc/inetd.conf
X     cvspserver stream tcp nowait anoncvs /open/anoncvssh anoncvssh pserver
X  - Create a file /open/anoncvs/cvs/CVSROOT/passwd with the following entry
X        anoncvs:AHDysQkJIubEc
X    which would be a password of "anoncvs" (as per anoncvs.html)
X  - Create a file /open/anoncvs/cvs/CVSROOT/readers with a single entry:
X        anoncvs
X    which tells cvs that user "anoncvs" is allowed readonly access.
X  - Create a zero-length file /open/anoncvs/cvs/CVSROOT/writers since you don't
X    want anyone to be able to write to the mirror.
X        % cp /dev/null /open/anoncvs/cvs/CVSROOT/writers
X
XSee the example layout below for full details.
X
X**********************************************************************
XSTEP 5): Get cvsync permission.
Xsend mail to sup@@openbsd.org
X1) to have cvsync permissions granted on an appropriate machine for you
X   to cvsync from. We will need to know your host's real hostname and
X   IP address.
X2) to have an anoncvsN.COUNTRY.openbsd.org alias created.
X3) to have your site mentioned in the http://www.openbsd.org/anoncvs.html page.
X
X**********************************************************************
XSTEP 6): Configure cvsync.
X
XYou have to install cvsync package.
X
XThe file /etc/cvsync.conf contains the configuration of cvsync. It will
Xnormally contain:
X
Xconfig {
X        base-prefix /open/anoncvs/
X        hostname anoncvs.ca.openbsd.org
X        collection {
X                name openbsd-cvsroot release rcs
X                prefix cvs
X        }
X        collection {
X                name openbsd-src release rcs
X                prefix cvs
X        }
X        collection {
X                name openbsd-ports release rcs
X                prefix cvs
X        }
X        collection {
X                name openbsd-www release rcs
X                prefix cvs
X        }
X        collection {
X                name openbsd-xenocara release rcs
X                prefix cvs
X        }
X}
X
X**********************************************************************
XSTEP 7): Run cvsync to retrieve the tree for the first time.
X
XLog in as or become the $CVSYNCUSER, and run
X
Xcvsync > /tmp/cvsynclog &; tail -f /tmp/cvsynclog
X
XIf you have cvsync permission, and have specified the correct host and
Xprefix in /etc/cvsync.conf you should see a list of files start
Xcoming in after a short while. Don't panic if nothing happens
Ximmediately.  Watch for errors (cvsync can timeout or die). If you can't
Xaccess files contact the cvsync server maintainer. If you get a timeout
Xor if cvsync dies you can restart and it should continue where it left off.
X
XIt can take a good while (and a couple of restarts) to obtain the
Xwhole tree for the first time.
X
X**********************************************************************
XSTEP 8): Set up cron to keep the tree up to date.
X
XYou run cvsync periodically from the cron by setting up the crontab file
Xof the $CVSYNCUSER.
X
XFor example, to update every two hours:
X
X15 */2 * * * /usr/local/bin/cvsync > /dev/null
X
X**********************************************************************
X
XEXAMPLE LAYOUT
X
XExample layout for OpenBSD. In this example "deraadt" is the $CVSYNCUSER.
X
X$ cd /open
X$ ls -alF
Xtotal 64
Xdrwxr-xr-x   5 root    wheel     512 Jun 18 22:29 ./
Xdrwxr-xr-x  13 root    wheel     512 Jun  4 05:14 ../
Xdrwxr-xr-x   9 deraadt wheel     512 Jun  3 02:15 anoncvs/
X---s--x--x   1 root    wheel   14302 Jun 18 22:29 anoncvssh*
Xdrwxr-xr-x   4 root    wheel    5120 Jun 10 14:34 ftp/
X
X$ cd anoncvs
X$ ls -alF
Xtotal 68
Xdrwxr-xr-x   9 root    wheel    512 Jun  3 02:15 ./
Xdrwxr-xr-x   5 root    wheel    512 Jun 10 14:32 ../
X-rw-r--r--   1 root    wheel      0 Jun  3 01:50 .hushlogin
X-rw-r--r--   1 root    wheel     84 Jun  3 01:50 .plan
X-rw-r--r--   1 root    wheel      0 Jun  3 01:50 .profile
Xdrwxr-xr-x   2 root    wheel    512 Jun  3 01:40 bin/
Xdrwxr-xr-x   7 deraadt wheel    512 Jun 18 22:19 cvs/
Xdrwxr-xr-x   2 root    wheel    512 Jun  3 01:51 dev/
Xdrwxr-xr-x   2 root    wheel    512 Jun  3 01:53 etc/
Xdrwxrwxrwx  10 root    wheel    512 Jun 18 17:38 tmp/
Xdrwxr-xr-x   5 root    wheel    512 Jun  3 01:54 usr/
Xdrwxr-xr-x   2 root    wheel    512 Jun  3 01:54 var/
X$ ls -alFR bin usr tmp etc dev
Xbin:
Xtotal 1984
Xdrwxr-xr-x  2 root  wheel     512 Jun  3 01:40 ./
Xdrwxr-xr-x  9 root  wheel     512 Jun  3 02:15 ../
X-r-xr-xr-x  1 root  wheel  132368 Jun  3 01:40 cat*
X-r-xr-xr-x  1 root  wheel  124176 Jun  3 01:40 pwd*
X-r-xr-xr-x  1 root  wheel  238864 Jun  3 01:40 rm*
X-r-xr-xr-x  1 root  wheel  460048 Jun  3 01:40 sh*
X  
Xdev:
Xtotal 8
Xdrwxr-xr-x  2 root  wheel       512 Jun  3 01:51 ./
Xdrwxr-xr-x  9 root  wheel       512 Jun  3 02:15 ../
Xcrw-rw-rw-  1 root  wheel    3,   2 Jun  3 01:51 null
Xcrw-rw-rw-  1 root  wheel    3,  12 Jun  3 01:51 zero
X  
Xetc:
Xtotal 188
Xdrwxr-xr-x  2 root  wheel    512 Jun  3 01:53 ./
Xdrwxr-xr-x  9 root  wheel    512 Jun  3 02:15 ../
X-r--r--r--  1 root  wheel     64 Jun  3 01:52 group*
X-r--r--r--  1 root  wheel    576 Jun  3 01:52 hosts*
X-r--r--r--  1 root  wheel    291 Jun  3 01:53 passwd*
X-r--r--r--  1 root  wheel   5625 Jun  3 01:52 protocols*
X-r--r--r--  1 root  wheel  40960 Jun  3 01:52 pwd.db*
X-r--r--r--  1 root  wheel     93 Jun  3 01:52 resolv.conf*
X-r--r--r--  1 root  wheel   9875 Jun  3 01:52 services*
X-r--r--r--  1 root  wheel  26428 Jun  3 01:52 ttys*
X
Xusr:
Xtotal 20
Xdrwxr-xr-x  5 root  wheel  512 Jun  3 01:54 ./
Xdrwxr-xr-x  9 root  wheel  512 Jun  3 02:15 ../
Xdrwxr-xr-x  2 root  wheel  512 Jun  3 01:57 bin/
Xdrwxr-xr-x  2 root  wheel  512 Jun  3 01:56 lib/
Xdrwxr-xr-x  2 root  wheel  512 Jun  3 01:55 libexec/
X
Xusr/bin:
Xtotal 3016
Xdrwxr-xr-x  2 root  wheel     512 Jun  3 01:57 ./
Xdrwxr-xr-x  5 root  wheel     512 Jun  3 01:54 ../
X-r-xr-xr-x  1 root  wheel  643728 Jun  3 01:54 cvs*
X
Xusr/lib:
Xtotal 42344
Xdrwxr-xr-x  2 root  wheel      512 Jun  3 01:56 ./
Xdrwxr-xr-x  5 root  wheel      512 Jun  3 01:54 ../
X-r--r--r--  1 root  wheel  4605409 Jun  3 01:56 libc.so.84.2
X-r--r--r--  1 root  wheel   182556 Jun  3 01:55 libz.so.5.0
X
Xusr/libexec:
Xtotal 120
Xdrwxr-xr-x  2 root  wheel    512 Jun  3 01:55 ./
Xdrwxr-xr-x  5 root  wheel    512 Jun  3 01:54 ../
X-r-xr-xr-x  1 root  wheel  55683 Jun  3 01:55 ld.so*
X$ ls cvs
XCVSROOT  ports    src      www      xenocara
X
END-of-README
echo x - anoncvssh.c
sed 's/^X//' >anoncvssh.c << 'END-of-anoncvssh.c'
X/*
X * Copyright (c) 2002 Todd C. Miller <Todd.Miller@@courtesan.com>
X * Copyright (c) 1997 Bob Beck <beck@@obtuse.com>
X * Copyright (c) 1996 Thorsten Lockert <tholo@@sigmasoft.com>
X *
X * Permission to use, copy, modify, and distribute this software for any
X * purpose with or without fee is hereby granted, provided that the above
X * copyright notice and this permission notice appear in all copies.
X *
X * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
X * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
X * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
X * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
X * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
X * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
X * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
X */
X
X#include <stdio.h>
X#include <stdlib.h>
X#if defined(__OpenBSD__) || defined(__NetBSD__) || defined(__FreeBSD__)
X#include <paths.h>
X#endif
X#include <pwd.h>
X#include <unistd.h>
X#include <sys/types.h>
X
X#ifndef __P
X#if defined(__STDC__) || defined(__cplusplus)
X#define	__P(protos)	protos		/* full-blown ANSI C */
X#else
X#define	__P(protos)	()		/* traditional C preprocessor */
X#endif
X#endif
X
X/*
X * You may need to change this path to ensure that RCS, CVS and diff
X * can be found
X */
X#ifndef _PATH_DEFPATH
X#define	_PATH_DEFPATH	"/bin:/usr/bin"
X#endif
X
X/*
X * This should not normally have to be changed
X */
X#ifndef _PATH_BSHELL
X#define _PATH_BSHELL	"/bin/sh"
X#endif
X
X/*
X * Location of CVS tree, relative to the anonymous CVS user's
X * home directory
X */
X#ifndef LOCALROOT
X#define	LOCALROOT	"/cvs"
X#endif
X
X/*
X * Hostname to be used when accessing the remote repository.
X */
X#ifndef HOSTNAME
X#define	HOSTNAME	"anoncvs1.usa.openbsd.org"
X#endif
X
X/*
X * Username to be used when accessing the remote repository.
X */
X#ifndef USERNAME
X#define USERNAME	"anoncvs"
X#endif
X
X/*
X * $CVSROOT is created based on USERNAME HOSTNAME and LOCALROOT above
X */
X#ifndef CVSROOT
X#define	CVSROOT		USERNAME "@@" HOSTNAME ":"LOCALROOT
X#endif
X
X/*
X * We define PSERVER_SUPPORT to allow anoncvssh to spawn a "cvs pserver".
X * You may undefine this if you aren't going to be running pserver.
X */
X#ifndef PSERVER_SUPPORT
X#define PSERVER_SUPPORT
X#endif
X
X/*
X * Define USE_SYSLOG if you want anoncvssh to log pserver connections 
X * using syslog()
X */
X#define USE_SYSLOG
X
X#ifdef USE_SYSLOG
X#include <string.h>
X#include <syslog.h>
X#include <netinet/in.h>
X#include <sys/socket.h>
X#include <arpa/inet.h>
X#define LOG_FACILITY LOG_DAEMON
X#define LOG_PRIO LOG_INFO
X#endif
X
X/* Define ANONCVS_USER if you want anoncvssh to complain if invoked by
X * anyone other than root or ANONCVS_USER.
X */
X/* #define ANONCVS_USER USERNAME */
X
Xint main __P((int, char *[]));
X
Xchar * const env[] = {
X	"PATH="_PATH_DEFPATH,
X	"SHELL="_PATH_BSHELL,
X	"CVSROOT="LOCALROOT,
X	"HOME=/",
X	"CVSREADONLYFS=1",
X	NULL
X};
X
Xint
Xmain(argc, argv)
Xint argc;
Xchar *argv[];
X{
X	struct passwd *pw;
X#ifdef DEBUG
X	int i;
X#endif /* DEBUG */
X
X	pw = getpwuid(getuid());
X	if (pw == NULL) {
X		fprintf(stderr, "no user for uid %d\n", getuid());
X		exit(1);
X	}
X	if (pw->pw_dir == NULL) {
X		fprintf(stderr, "no directory\n");
X		exit(1);
X	}
X
X#ifdef USE_SYSLOG
X	openlog("anoncvssh", LOG_PID | LOG_NDELAY, LOG_FACILITY);
X#endif /* USE_SYSLOG */
X	
X#ifdef ANONCVS_USER
X	/* 
X	 * I love lusers who have to test every setuid binary on my machine.
X	 */
X	if (getuid() != 0 && (strcmp (pw->pw_name, ANONCVS_USER) != 0)) {
X		fprintf(stderr, "You're not supposed to be running me!\n"); 
X#ifdef USE_SYSLOG
X		syslog(LOG_NOTICE,
X		       "User %s(%d) invoked anoncvssh - Possible twink?",
X		       pw->pw_name, pw->pw_uid); 
X#endif /* USE_SYSLOG */
X		exit(1);
X	}
X#endif /* ANONCVS_USER */
X
X
X	setuid(0);
X	if (chroot(pw->pw_dir) == -1) {
X		perror("chroot");
X		exit (1);
X	}
X	chdir("/");
X	setuid(pw->pw_uid);
X
X	/*
X	 * program now "safe"
X	 */
X
X#ifdef PSERVER_SUPPORT
X	/* If we want pserver functionality */
X	if ((argc == 2) && (strcmp("pserver", argv[1]) == 0)) {
X#ifdef USE_SYSLOG
X 	        int slen;
X		struct sockaddr_in my_sa, peer_sa;
X		char *us, *them;
X
X		slen = sizeof(my_sa);
X		if (getsockname(0, (struct sockaddr *) &my_sa, &slen)
X		    != 0) {
X		  perror("getsockname");
X		  exit(1);
X		}
X		us = strdup(inet_ntoa(my_sa.sin_addr));
X		if (us == NULL) {
X		  fprintf(stderr, "malloc failed\n");
X		  exit(1);
X		}
X		slen = sizeof(peer_sa);
X		if (getpeername(0, (struct sockaddr *) &peer_sa, &slen)
X		    != 0) {
X		  perror("getpeername");
X		  exit(1);
X		}
X		them=strdup(inet_ntoa(peer_sa.sin_addr));
X		if (them == NULL) {
X		  fprintf(stderr, "malloc failed\n");
X		  exit(1);
X		}
X	        syslog(LOG_PRIO, 
X		       "pserver connection from %s:%d to %s:%d\n",
X		       them, ntohs(peer_sa.sin_port),
X		       us, ntohs(my_sa.sin_port));
X#endif /* USE_SYSLOG */
X		execle("/usr/bin/cvs", "cvs",
X		    "--allow-root="LOCALROOT, "pserver", (char *)NULL, env);
X		perror("execle: cvs");
X		fprintf(stderr, "unable to exec CVS pserver!\n");
X		exit(1);
X		/* NOTREACHED */
X	}
X#endif
X
X	if (argc != 3 || 
X		strcmp("anoncvssh",  argv[0]) != 0 ||
X		strcmp("-c",         argv[1]) != 0 ||
X		(strcmp("cvs server", argv[2]) != 0 &&
X		 strcmp("cvs -d "LOCALROOT" server", argv[2]) != 0)) {
X		fprintf(stderr, "\nTo use anonymous CVS install the latest ");
X		fprintf(stderr,"version of CVS on your local machine.\n");
X		fprintf(stderr,"Then set your CVSROOT environment variable ");
X		fprintf(stderr,"to the following value:\n");
X		fprintf(stderr,"\t%s\n\n", CVSROOT);
X#ifdef DEBUG
X		fprintf(stderr, "argc = %d\n", argc);
X		for (i = 0 ; i < argc ; i++)
X			fprintf(stderr, "argv[%d] = \"%s\"\n", i, argv[i]);
X#endif /* DEBUG */
X		sleep(10);
X		exit(0);
X	}
X
X		execle("/usr/bin/cvs", "cvs", "server", (char *)NULL, env);
X
X	perror("execle: cvs");
X	fprintf(stderr, "unable to exec CVS server!\n");
X	exit(1);
X	/* NOTREACHED */
X}
X
END-of-anoncvssh.c
exit
d22 15
@


1.26
log
@anoncvs.shar tweaks: update libs in the directory listing,
add PermitTTY no to the example ssh config, from Sevan Janiyan.
@
text
@a114 7
X
XPut a message like the following in .plan:
X    To use anonymous CVS install the latest version of CVS on your local
X    machine.
X    Then set your CVSROOT environment variable to the following value:
X            anoncvs@@anoncvs.openbsd.org:/cvs
X
a447 6
X/*
X * If you want to be able to run an alternate OpenCVS binary on your
X * anoncvs server, define OPENCVS_USER as the user who will invoke it.
X */
X#define OPENCVS_USER "opencvs"
X
a467 3
X#if defined(OPENCVS_USER)
X	int opencvs;
X#endif
a506 7
X#if defined(OPENCVS_USER)
X	if (!strcmp(pw->pw_name, OPENCVS_USER))
X		opencvs = 1;
X	else
X		opencvs = 0;
X#endif
X
a518 8
X#if defined(OPENCVS_USER)
X		if (opencvs == 1) {
X			fprintf(stderr, "OpenCVS does not support pserver\n");
X			sleep(10);
X			exit(1);
X		}
X#endif
X
a563 4
X#if defined(OPENCVS_USER)
X		fprintf(stderr, "\t%s@@%s:%s for OpenCVS\n", OPENCVS_USER,
X		    HOSTNAME, LOCALROOT);
X#endif
a573 6
X#if defined(OPENCVS_USER)
X	if (opencvs == 1) {
X		execle("/usr/bin/opencvs", "opencvs",
X		    "server", (char *)NULL, env);
X	} else {
X#endif
a574 3
X#if defined(OPENCVS_USER)
X	}
X#endif
@


1.25
log
@update repo size and ldd output; from Sevan Janiyan (thanks!).
@
text
@d98 1
d333 2
a334 6
X-r--r--r--  1 root  wheel  4605409 Jun  3 01:56 libc.so.50.1
X-r--r--r--  1 root  wheel  9659802 Jun  3 01:56 libcrypto.so.18.0
X-r--r--r--  1 root  wheel   190814 Jun  3 01:56 libdes.so.9.0
X-r--r--r--  1 root  wheel  1593303 Jun  3 01:55 libgssapi.so.5.0
X-r--r--r--  1 root  wheel  5337583 Jun  3 01:56 libkrb5.so.16.0
X-r--r--r--  1 root  wheel   182556 Jun  3 01:55 libz.so.4.1
@


1.24
log
@add Match User to sshd_config example to better lock down; ok beck@@
@
text
@d63 1
a63 1
X    You need roughly 2GB.
d159 2
a160 6
X                0f802000 2f80a000 rlib 0    1   0      /usr/lib/libz.so.4.1
X                020f3000 220f8000 rlib 0    1   0      /usr/lib/libgssapi.so.5.0
X                0530c000 2531c000 rlib 0    1   0      /usr/lib/libkrb5.so.17.0
X                03801000 23841000 rlib 0    1   0      /usr/lib/libcrypto.so.18.0
X                0a8fb000 2a900000 rlib 0    1   0      /usr/lib/libdes.so.9.0
X                094d2000 2950b000 rlib 0    1   0      /usr/lib/libc.so.51.0
@


1.23
log
@remove stuff about opencvs - no longer linked in build.
@
text
@d90 8
a97 2
XSet "PermitEmptyPasswords yes" option in /etc/ssh/sshd_config and
Xrestart your sshd daemon.
@


1.22
log
@sup is old, teach users how to install and use cvsync instead.
While here, update anoncvs home directory layout to be more in sync with
reality, and remove some outdated informations.
requested by beck@@ at c2k9, ok beck@@
@
text
@a7 1
#	anoncvs.shar
a60 2
X9) Enabling OpenCVS anoncvs.
X
a252 17
XSTEP 9): Enabling OpenCVS anoncvs.
X
XThe next step is to enable OpenCVS, which will run on your system next
Xto the normal GNU cvs server. This will become the default in the
Xfuture. 
X
XFirst off, create a new user account "opencvs" like you did for your
Xnormal anoncvs user:
X
Xopencvs::32766:32766::0:0:Anonymous OpenCVS User:/open/anoncvs:/open/anoncvssh
X
XBe sure that the uid and gid are unique for your system, if the ones
Xabove aren't, pick different values.
X
X#define OPENCVS_USER	"opencvs"
X
XRecompile anoncvssh.c and install the binary setuid-root in /open/anoncvssh.
a253 11
XCompile and install a current /usr/bin/opencvs. 
X
XCopy /usr/bin/opencvs to /open/anoncvs/usr/bin/opencvs
X
XYou can now use OpenCVS anoncvs by using the correct CVSROOT:
X
X	opencvs@@anoncvs.openbsd.org:/cvs
X
XIf you encounter bugs, send them to joris@@openbsd.org
X
X**********************************************************************
a324 1
X-r-xr-xr-x  1 root  wheel  841240 Jun  3 01:57 opencvs*
@


1.21
log
@Mention that the partition used for anoncvs chroot shouldn't have nodev
and nosuid flags, got bitten by this mistake...
ok miod@@
@
text
@d36 2
a37 1
X   ( If you aren't using OpenBSD you'll probably need to compile a sup
d41 1
a41 1
X   anoncvssh as it's shell. Decide on a user that will run sup to maintain
d53 1
a53 1
X5) Get permission to use sup to obtain the cvs tree from a server.
d55 1
a55 3
X6) Set up sup to retrieve the cvs tree from an appropriate place.
X   (If you aren't using OpenBSD you will need to compile and install
X    a sup client).
d57 1
a57 1
X7) Run sup to retrieve the distribution from the server.
d59 1
a59 1
X8) Once you get the distribution in, set up a cron job to run sup
d77 1
a77 1
XSTEP 3) Create the anoncvs account and decide who will run "sup"
d79 1
a79 1
X    running sup to maintain the archive.
d89 3
a91 3
XDecide who will run sup to maintain the archive. Call that user
X$SUPUSER.  Oh, and in case it hasn't been previously mentioned,
X$SUPUSER should *NOT* be the anoncvs user :).
d103 1
a103 2
Xmkdir /open/anoncvs/sup
Xchown -R $SUPUSER /open/anoncvs/cvs /open/anoncvs/sup /open/anoncvs
a117 2
X    chown root:wheel .hushlogin .profile .plan
X
d154 9
a162 11
X                Start    End      Type Ref Name
X                00000000 00000000 exe   1  /usr/bin/cvs
X                0015f000 20165000 rlib  1  /usr/lib/libz.so.2.0
X                0016d000 20172000 rlib  1  /usr/lib/libgssapi.so.2.0
X                0017f000 2018d000 rlib  1  /usr/lib/libkrb5.so.5.2
X                00141000 20145000 rlib  1  /usr/lib/libasn1.so.3.1
X                00089000 200ba000 rlib  1  /usr/lib/libcrypto.so.10.0
X                00177000 2017c000 rlib  1  /usr/lib/libdes.so.8.0
X                00169000 2016d000 rlib  1  /usr/lib/libcom_err.so.1.0
X                00009000 20053000 rlib  1  /usr/lib/libc.so.30.0
X                00002000 00002000 rtld  1  /usr/libexec/ld.so
d187 1
a187 1
XSTEP 5): Get sup permission.
d189 2
a190 2
X1) to have sup permissions granted on an appropriate machine for you
X   to sup from. We will need to know your host's real hostname and
d193 1
a193 1
X3) to have your site mentioned in the http://www.openbsd.org page.
d196 3
a198 1
XSTEP 6): Configure sup.
d200 2
a201 20
XIf you're running OpenBSD, you already have a sup client in
X/usr/bin/sup.  If not you may need to build it. On an IRIX or other
XSYSV machine, ensure that your kernel does not allow a user to chown
Xa file to another user (you may have heard of this particular brand
Xof evil referred to as "chown giveaway"). This will cause sup to
Xgive away the files to root before chmod'ing them readable.
Xmichaels@@openbsd.org knows how to fix this.
X
XThe file /open/anoncvs/sup/ss contains a line that tells sup where
Xto get the cvs tree from. It will normally contain:
X
X    cvs host=anoncvs.ca.openbsd.org hostbase=/usr/OpenBSD base=/open/anoncvs delete
X
XThe file /open/anoncvs/sup/cvs/refuse tells sup what files it should not get.
XIt should contain the following lines:
X
X    cvs/CVSROOT/history
X    cvs/CVSROOT/readers
X    cvs/CVSROOT/writers
X    cvs/CVSROOT/passwd
d203 24
a226 2
XIf you ever fetch the file cvs/CVSROOT/history, delete it. It will
Xcause you problems.
d229 1
a229 1
XSTEP 7): Run sup to retrieve the tree for the first time.
d231 1
a231 1
XLog in as or become the $SUPUSER, and run
d233 1
a233 1
Xsup -v  /open/anoncvs/sup/ss > /tmp/suplog &; tail -f /tmp/suplog
d235 2
a236 2
XIf you have sup permission, and have specified the correct host and
Xhostbase in /open/anoncvs/sup/ss you should see a list of files start
d238 3
a240 3
Ximmediately.  Watch for errors (sup can timeout or die). If you can't
Xaccess files contact the sup server maintainer. If you get a timeout
Xor if sup dies you can restart and it should continue where it left off.
d248 2
a249 5
XYou run sup periodically from the cron by setting up the crontab file
Xof the $SUPUSER.
X
XFor example:  To run every three hours 'sup -v supfile', and thrice
Xweekly 'sup -vo supfile' .. because sup is not reliable ..
d251 1
a251 3
X0 0,3,6,9,12,15,18,21 * * 0,2,4,5 sup -v  /open/anoncvs/sup/ss > /dev/null
X0 0,12,15,18,21       * *  1,3,6  sup -v  /open/anoncvs/sup/ss > /dev/null
X0 3                   * *  1,3,6  sup -vo /open/anoncvs/sup/ss > /dev/null
d253 1
a253 2
Xanoncvs5.usa.openbsd.org uses this particular set of entries.  A `sup
X-o' is done every few days because sup is not very robust.
d287 1
a287 1
XExample layout for OpenBSD. In this example "deraadt" is the $SUPUSER.
d289 25
a313 28
X[eap open 5 ]> cd /open
X[eap open 6 ]> ls -alF
Xtotal 46
Xdrwxr-xr-x   7 root     wheel    512 Feb 20 09:58 ./
Xdrwxr-xr-x  17 root     wheel    512 Jun 14 14:05 ../
Xdrwxr-xr-x   9 root     wheel    512 Jan  3 21:55 anoncvs/
X---s--x--x   1 root     bin    16384 Nov 30  1995 anoncvssh*
Xlrwxr-xr-x   1 root     wheel     11 Jan  3 21:52 cvs@@ -> anoncvs/cvs
Xdrwxr-xr-x   5 root     wheel    512 Feb 22 13:22 ftp/
Xdrwxrwxrwt   2 anoncvs  wheel   1024 Jan  1 13:18 lost+found/
Xdrwxr-xr-x   4 root     wheel    512 Nov 30  1995 src/
Xdrwxrwxr-x   3 deraadt  wheel    512 Dec  4  1995 sup/
X[eap open 7 ]> cd anoncvs
X[eap anoncvs 8 ]> ls -alF
Xtotal 20
Xdrwxr-xr-x  9 root     wheel  512 Jan  3 21:55 ./
Xdrwxr-xr-x  7 root     wheel  512 Feb 20 09:58 ../
X-r--r--r--  1 root     wheel    0 Nov 30  1995 .hushlogin
X-r--r--r--  1 root     wheel  188 Nov 30  1995 .plan
X-r--r--r--  1 root     wheel    0 Nov 29  1995 .profile
Xdrwxrwxr-x  2 deraadt  wheel  512 Nov 29  1995 bin/
Xdrwxrwxr-x  6 deraadt  cvs    512 Jun 16 20:28 cvs/
Xdrwxr-xr-x  2 root     wheel  512 Nov 30  1995 dev/
Xdrwxr-xr-x  2 root     wheel  512 Nov 29  1995 etc/
Xdrwxrwxrwx  3 root     wheel  512 Jun 22 07:42 tmp/
Xdrwxr-xr-x  5 deraadt  wheel  512 Nov 30  1995 usr/
Xdrwxr-xr-x  2 root     wheel  512 Jan  3 21:55 var/
X[eap anoncvs 8 ]> ls -alFR bin usr tmp etc dev
d315 8
a322 8
Xtotal 948
Xdrwxrwxr-x  2 deraadt  wheel     512 Nov 29  1995 ./
Xdrwxr-xr-x  9 root     wheel     512 Jan  3 21:55 ../
X--wx--x--x  1 deraadt  wheel   40960 Jun 18 09:45 cat*
X--wx--x--x  1 deraadt  wheel   40960 Jun 18 09:45 pwd*
X--wx--x--x  1 deraadt  wheel  122880 Jun 18 09:45 rm*
X--wx--x--x  1 deraadt  wheel  262144 Jun 18 09:45 sh*
X
d324 6
a329 5
Xtotal 4
Xdrwxr-xr-x  2 root  wheel       512 Nov 30  1995 ./
Xdrwxr-xr-x  9 root  wheel       512 Jan  3 21:55 ../
Xcrw-rw-rw-  1 root  wheel    2,   2 Nov 30  1995 null
X
d331 11
a341 11
Xtotal 112
Xdrwxr-xr-x  2 root  wheel    512 Nov 29  1995 ./
Xdrwxr-xr-x  9 root  wheel    512 Jan  3 21:55 ../
X-rw-r--r--  1 root  wheel    252 Nov 29  1995 group
X-rw-r--r--  1 root  wheel    296 Nov 29  1995 hosts
X-rw-r--r--  1 root  wheel    540 Nov 29  1995 passwd
X-rw-r--r--  1 root  wheel   1094 Nov 29  1995 protocols
X-rw-r--r--  1 root  wheel  40960 Nov 29  1995 pwd.db
X-rw-r--r--  1 root  wheel     89 Nov 29  1995 resolv.conf
X-rw-r--r--  1 root  wheel   5529 Nov 29  1995 services
X-rw-r--r--  1 root  wheel   1361 Nov 29  1995 ttys
d344 6
a349 6
Xtotal 10
Xdrwxr-xr-x  5 deraadt  wheel   512 Nov 30  1995 ./
Xdrwxr-xr-x  9 root     wheel   512 Jan  3 21:55 ../
Xdrwxr-xr-x  2 deraadt  wheel   512 Nov 30  1995 bin/
Xdrwxr-xr-x  2 deraadt  wheel  1024 Jun 18 09:50 lib/
Xdrwxr-xr-x  2 deraadt  wheel   512 Nov 29  1995 libexec/
d352 5
a356 4
Xtotal 1968
Xdrwxr-xr-x  2 deraadt  wheel     512 Nov 30  1995 ./
Xdrwxr-xr-x  5 deraadt  wheel     512 Nov 30  1995 ../
X--wx--x--x  1 deraadt  wheel  317787 Jun 18 09:46 cvs*
d359 9
a367 12
Xtotal 5594
Xdrwxr-xr-x  2 deraadt  wheel    1024 Jun 18 09:50 ./
Xdrwxr-xr-x  5 deraadt  wheel     512 Nov 30  1995 ../
X-rw-r--r--  1 deraadt  wheel  351730 Jun 18 09:50 libasn1.so.2.0
X-rw-r--r--  1 deraadt  wheel  351730 Jun 18 09:50 libc.so.28.5
X-rw-r--r--  1 deraadt  wheel   16608 Jun 18 09:50 libcrypto.so.6.0
X-rw-r--r--  1 deraadt  wheel   44424 Jun 18 09:50 libdes.so.7.0
X-rw-r--r--  1 deraadt  wheel   16665 Jun 18 09:50 libgssapi.so.1.0
X-rw-r--r--  1 deraadt  wheel   86198 Jun 18 09:50 libkafs.so.10.0
X-rw-r--r--  1 deraadt  wheel   42254 Jun 18 09:50 libkrb.so.10.0
X-rw-r--r--  1 deraadt  wheel   66099 Jun 18 09:50 libkrb5.so.4.0
X-rw-r--r--  1 deraadt  wheel  387976 Jun 18 09:50 libz.so.1.4
d370 7
a376 50
Xtotal 100
Xdrwxr-xr-x  2 deraadt  wheel    512 Nov 29  1995 ./
Xdrwxr-xr-x  5 deraadt  wheel    512 Nov 30  1995 ../
X-rwxr-xr-x  1 deraadt  wheel  49152 Jun 18 09:47 ld.so*
X
X[eap anoncvs 14 ]> ls cvs
XCVSROOT/        src/            sup/            www/
X[eap anoncvs 15 ]> cd /open
X[eap anoncvs 16 ]> ls -alF sup
Xtotal 8
Xdrwxrwxr-x  3 deraadt  wheel  512 Dec  4  1995 ./
Xdrwxr-xr-x  7 root     wheel  512 Feb 20 09:58 ../
Xdrwxr-xr-x  2 deraadt  wheel  512 Jun 22 06:05 cvs/
X-rw-rw-r--  1 deraadt  wheel   54 Dec  4  1995 ss
X
X
X***************************************************************
XNOTES FOR OTHER PLATFORMS:
X
XIf you're not that familiar with your other platform (i.e. you haven't
Xbuilt a chroot jail for a server on it) you may be better off
Xfinding an OpenBSD machine to use and duplicating the example above.
X
X**SunOS 5)
XBob Beck <Bob.Beck@@ualberta.ca> has done this. E-mail for
Xhelp if you need it.
X
X**OSF 1)
XFrom Todd Fries <toddf@@acm.org> to the adventurous.
XA note for those installing anoncvs on non-OpenBSD operating systems.
XYou are in for some fun.
X
XFor OSF1, on a DEC alpha, I had to do the following in addition to the
Xabove:
X
X- I do not know how to setup dynamic libraries on osf1 and as a result
X  everything had to be compiled statically.
X- Therefore, everything but /bin/sh I had to recmpile in order to
X  get the chroot setup.  In order that there be no guesswork
X  involved, the following packages' binaries must exist in the chroot
X  environment:
X
X GNU
X   cvs         (from the OpenBSD source tree)
X
XSome notes on compiling.
X
X   cvs fails to install if you don't have makeinfo ... just search for the
X   string ' install-info$' with regex and remove it from the Makefile for the
X   install and you'll be fine, or install 'texinfo', your choice.
@


1.20
log
@unbreak anoncvs.shar
@
text
@d68 1
a68 1
X    Mount it on /open.
@


1.19
log
@Modify anoncvssh.c to support opencvs server, and include instructions
for adding an opencvs user to anoncvs sites to support the optional use
of opencvs server for checkouts - hopefully this way we can eat a little
more of our own dog food and find the bugs.

ok joris@@
@
text
@a12 17
echo x - anoncvs.shar
sed 's/^X//' >anoncvs.shar << 'END-of-anoncvs.shar'
X# This is a shell archive.  Save it in a file, remove anything before
X# this line, and then unpack it by entering "sh file".  Note, it may
X# create directories; files and directories will be owned by you and
X# have default permissions.
X#
X# This archive contains:
X#
X#	anoncvs.shar
X#	Makefile
X#	README
X#	anoncvssh.c
X#
Xecho x - anoncvs.shar
Xsed 's/^X//' >anoncvs.shar << 'END-of-anoncvs.shar'
END-of-anoncvs.shar
@


1.18
log
@Document master.passwd entry, not v7-style passwd.
@
text
@d8 1
d13 17
d80 2
d279 29
d509 1
a509 2
X * Account and host name to be used when accessing the
X * CVS repository remotely
d512 8
a519 1
X#define	HOSTNAME	"anoncvs@@anoncvs1.usa.openbsd.org"
d523 1
a523 1
X * $CVSROOT is created based on HOSTNAME and LOCALROOT above
d526 1
a526 1
X#define	CVSROOT		HOSTNAME ":"LOCALROOT
d556 7
a562 1
X/* #define ANONCVS_USER "anoncvs" */
d584 3
d626 7
d644 9
a652 1
X		
d698 4
d711 12
a722 1
X	execle("/usr/bin/cvs", "cvs", "server", (char *)NULL, env);
@


1.17
log
@zap bogus use of __CONCAT that messes up with gcc3.
okay millert@@
@
text
@d81 1
a81 1
X    anoncvs::32766:32766:Anonymous CVS User:/open/anoncvs:/open/anoncvssh
@


1.16
log
@From Andrey Smagin:

anoncvssh.c:
o NULL --> (char *)NULL in execle

README:
o update the size of repository in the README file
o fix typos, whitespace, grammar and some indentation
o update the output of ldd /usr/bin/cvs
o add a note about enabling "PermitEmptyPasswords yes" in sshd_config
@
text
@a427 16
X#ifndef __CONCAT
X#if defined(__STDC__) || defined(__cplusplus)
X#define __CONCAT(x,y)		x ## y
X#else
X#define __CONCAT(x,y)		x/**/y
X#endif
X#endif
X
X#ifndef __CONCAT3
X#if defined(__STDC__) || defined(__cplusplus)
X#define __CONCAT3(x,y,z)	x ## y ## z
X#else
X#define __CONCAT3(x,y,z)	x/**/y/**/z
X#endif
X#endif
X
d471 1
a471 1
X#define	CVSROOT		__CONCAT3(HOSTNAME,":",LOCALROOT)
d506 3
a508 3
X	__CONCAT("PATH=",_PATH_DEFPATH),
X	__CONCAT("SHELL=",_PATH_BSHELL),
X	__CONCAT("CVSROOT=",LOCALROOT),
d602 1
a602 1
X		    __CONCAT("--allow-root=",LOCALROOT), "pserver", (char *)NULL, env);
d614 1
a614 1
X		 strcmp(__CONCAT3("cvs -d ",LOCALROOT," server"), argv[2]) != 0)) {
@


1.15
log
@Add copyright to anoncvssh.c; noticed by nate@@
OK beck@@ and tholo@@
@
text
@d27 1
a27 1
X	So, you want to run an anoncvs server.
d31 1
a31 1
X1) Find enough disk space to hold the anoncvs tree, and mount it in an 
d36 1
a36 1
X     client as well. The easier path is to use OpenBSD ;)	 
d40 1
a40 1
X   the archive (this is a different user, NOT the anoncvs user) 
d47 1
a47 1
X   staticly. This example shows what is needed for OpenBSD. If you
d53 1
a53 1
X6) Set up sup to retrieve the cvs tree from an appropriate place. 
d57 1
a57 1
X7) Run sup to retrieve the distribution from the server
d59 1
a59 1
X8) Once you get the distribution in, set up a cron job to run sup 
d64 1
a64 1
X    You need roughly 1.6GB.
d67 1
a67 1
X	throughout the rest of this description.
d70 2
a71 2
XSTEP 2) compile the anoncvssh binary
X    In the Makefile, change the variable CVSROOT
d75 1
a75 1
XSTEP 3) Create the anoncvs account. and decide who will run "sup"
d83 1
a83 1
XYes, that is right. the account has no password. Be sure that the
d86 2
a87 2
X 
XDecide who will run sup to maintain the archive. call that user
d89 4
a92 1
X$SUPUSER should *NOT* be the anoncvs user :)
d112 1
a112 1
X    To use anonymous CVS install the latest version of CVS on your local 
d125 1
a125 1
XSome shared library systems require a dev/zero created in the same way
d133 6
a138 6
Xan tiny extension provided in the openbsd cvs server code which
Xpermits the use of read-only cvs repositories.  therefore you MUST
Xcompile the openbsd version of cvs.  luckily this is not a problem
Xon a non-openbsd machine since the cvs sources are imported verbatim
Xinto the openbsd tree.  they are in gnu/usr.bin/cvs.  The sources
Xare integrated such that Makefile.bsd-wrapper knows how to build
d142 1
a142 1
X    # cd var; ln -s ../tmp tmp
d154 12
a165 10
X    /usr/bin/cvs:
X	    -lz.1 => /usr/lib/libz.so.1.4 (0x40097000)
X	    -lgssapi.1 => /usr/lib/libgssapi.so.1.0 (0x400a4000)
X	    -lkrb.10 => /usr/lib/libkrb.so.10.0 (0x400ae000)
X	    -lkrb5.4 => /usr/lib/libkrb5.so.4.0 (0x400c8000)
X	    -lasn1.2 => /usr/lib/libasn1.so.2.0 (0x400ff000)
X	    -lcrypto.6 => /usr/lib/libcrypto.so.6.0 (0x4011d000)
X	    -ldes.7 => /usr/lib/libdes.so.7.0 (0x40203000)
X	    -lkafs.10 => /usr/lib/libkafs.so.10.0 (0x4020d000)
X	    -lc.28 => /usr/lib/libc.so.28.5 (0x40210000)
d174 1
a174 1
X     cvspserver		2401/tcp		# CVS client/server operations
d176 1
a176 1
X     cvspserver	stream	tcp nowait anoncvs /open/anoncvssh anoncvssh pserver
d178 1
a178 1
X	anoncvs:AHDysQkJIubEc
d181 1
a181 1
X	anoncvs
d185 1
a185 1
X	% cp /dev/null /open/anoncvs/cvs/CVSROOT/writers
d190 1
a190 1
XSTEP 5): Get sup permission. 
d195 1
a195 1
X2) to have an anoncvsN.COUNTRY.openbsd.org alias created
d199 1
a199 1
XSTEP 6): Configure sup
d204 2
a205 2
Xa file to another user (You may have heard of this particular brand
Xof evil referred to as "chown giveaway"). this will cause sup to
d210 1
a210 1
Xto get the cvs tree from. it will normally contain:
d222 1
a222 1
Xif you ever fetch the file cvs/CVSROOT/history, delete it. it will
d226 1
a226 1
XSTEP 7): Run sup to retrieve the tree for the first time
d228 1
a228 1
XLog in as or become the $SUPUSER, and run 
d236 1
a236 1
Xaccess files contact the sup server maintainer, If you get a timeout
d264 1
a264 1
X[eap open 6 ]> ls -alF 
d369 1
a369 1
Xfinding an OpenBSD machine to use. (and duplicating the example above)
d618 1
a618 1
X		    __CONCAT("--allow-root=",LOCALROOT), "pserver", NULL, env);
d644 1
a644 1
X	execle("/usr/bin/cvs", "cvs", "server", NULL, env);
@


1.14
log
@README changes:
Change 2 occurrences of /open/sup to /open/anoncvs/sup; Jolan Luff
Fix up some formatting to make this more readable
Nuke a remaining bit that talks about rcs & friends (not needed)
@
text
@d397 15
a411 1
X * anoncvssh
@


1.13
log
@Fix instructions:
 o the only thing we need in /usr/bin is cvs (not rcs, not diff)
 o the only libs we need are those used by cvs so talk about ldd
 o source tree takes up 1.6GB now
@
text
@d32 1
a32 1
Xappropriate place.
d39 2
a40 2
Xanoncvssh as it's shell. Decide on a user that will run sup to maintain
Xthe archive (this is a different user, NOT the anoncvs user) 
d42 8
a49 8
X4) Make a home directory for the anoncvs user. The anoncvs user's home
Xdirectory is a chroot jail in which the anoncvssh processes run when
Xservicing anoncvs requests. The jail must contain the cvs binary and
Xrelated programs (rcs, etc) as well as whatever shared libraries and
Xsupport files are needed to run them unless you compile and link
Xeverything staticly. This example shows what is needed for OpenBSD. If
Xyou use another platform you'll need to be familiar with what needs
Xto go in a chroot jail for your platform.
d64 4
a67 4
X    you need roughly 1.6GB.
X    mount it on /open
X    if you are not able to mount it as /open, substitute it's location
X    throughout the rest of this description
d71 2
a72 2
X    in the Makefile, change the variable CVSROOT
X    install the binary setuid-root in /open/anoncvssh.
d76 2
a77 2
Xto maintain the archive. The anoncvs account should *NOT* be the one
Xrunning sup to maintain the archive.
d83 3
a85 3
Xyes, that is right. the account has no password. Be sure that the uid
Xand gid are unique for your system, if the ones above aren't, pick different
Xvalues.
d87 3
a89 3
XDecide on who will run sup to maintain the archive. call that user $SUPUSER.
XOh, and in case it hasn't been previously mentioned, $SUPUSER should *NOT*
Xbe the anoncvs user :)
d92 3
a94 3
XSTEP 4) Build the anoncvs user's home directory chroot jail. This example
Xassumes that you're using OpenBSD. If you're not you may need different 
Xfiles in the chroot.
d101 1
a101 1
Xstart filling the account up with nice stuff. You are building a chroot
d108 1
a108 1
Xput a message like the following in .plan:
d114 1
a114 1
X    chown root.wheel .hushlogin .profile .plan
d119 1
a119 1
Xusing mknod, make a dev/null that has the same major/minor numbers as
d122 1
a122 1
Xsome shared library systems require a dev/zero created in the same way
d124 1
a124 1
Xfill etc space for the account
d129 8
a136 8
Xanoncvssh (by setting the environment variable CVSREADONLYFS) uses an
Xtiny extension provided in the openbsd cvs server code which permits
Xthe use of read-only cvs repositories.  therefore you MUST compile the
Xopenbsd version of cvs.  luckily this is not a problem on a
Xnon-openbsd machine since the cvs sources are imported verbatim into
Xthe openbsd tree.  they are in gnu/usr.bin/cvs.  The sources are
Xintegrated such that Makefile.bsd-wrapper knows how to build the
Xsources on an OpenBSD machine, using obj directories.
d138 1
a138 1
Xcreate tmp space for the account
d145 1
a145 1
Xif your system has ld.so in /usr/libexec,
d149 1
a149 1
Xif using shared libraries, use ldd to find out which shared libs you need:
d164 2
a165 2
Xas a final pass, make sure that all the files you have just created are
Xnot world writable (except dev/null)
d198 5
a202 5
XSYSV machine, ensure that your kernel does not allow a user to chown a
Xfile to another user (You may have heard of this particular brand of
Xevil referred to as "chown giveaway"). this will cause sup to give
Xaway the files to root before chmod'ing them
Xreadable. michaels@@openbsd.org knows how to fix this.
d204 2
a205 2
XThe file /open/sup/ss contains a line that tells sup where to get the
Xcvs tree from. it will normally contain:
d207 1
a207 1
X    cvs host=anoncvs1.ca.openbsd.org hostbase=/usr/OpenBSD base=/open/anoncvs delete
d209 1
a209 1
XThe file /open/sup/cvs/refuse tells sup what files it should not get.
@


1.12
log
@Size of a whole CVS mirror has grown since this file was written;
PR 2377
@
text
@d64 1
a64 1
X    you need roughly 1.5GB.
d139 2
a140 2
X    cd var; ln -s ../tmp tmp
X    chmod a+rwx tmp
d142 2
a143 4
X    mkdir usr/{bin,lib}
X    cp /usr/bin/{ci,co,cvs,diff,diff3,gzip,rcs,rcsclean} usr/bin/
X    cp /usr/bin/{rcsdiff,rcsfreeze,rcsmerge,rlog,sdiff,zdiff} usr/bin/
X    cp /usr/bin/grep usr/bin
d146 2
a147 2
X    mkdir usr/libexec
X    cp /usr/libexec/ld.so usr/libexec/
d149 14
a162 2
Xif using shared libraries, copy the shared libs you might need:
X    cp /usr/lib/lib*.so.* usr/lib/
a325 2
X--wx--x--x  1 deraadt  wheel   73728 Jun 18 09:46 ci*
X--wx--x--x  1 deraadt  wheel   73728 Jun 18 09:46 co*
a326 11
X--wx--x--x  1 deraadt  wheel   73728 Jun 18 09:46 diff*
X--wx--x--x  1 deraadt  wheel   24576 Jun 18 09:46 diff3*
X--wx--x--x  1 deraadt  wheel   90112 Jun 18 09:46 gzip*
X--wx--x--x  1 deraadt  wheel   73728 Jun 18 09:46 rcs*
X--wx--x--x  1 deraadt  wheel   65536 Jun 18 09:46 rcsclean*
X--wx--x--x  1 deraadt  wheel   57344 Jun 18 09:46 rcsdiff*
X--wx--x--x  1 deraadt  wheel    3228 Jun 18 09:46 rcsfreeze*
X--wx--x--x  1 deraadt  wheel   57344 Jun 18 09:46 rcsmerge*
X--wx--x--x  1 deraadt  wheel   57344 Jun 18 09:46 rlog*
X--wx--x--x  1 deraadt  wheel   24576 Jun 18 09:46 sdiff*
X--wx--x--x  1 deraadt  wheel    2006 Jun 18 09:46 zdiff*
d332 9
a340 35
X-rw-r--r--  1 deraadt  wheel   16665 Jun 18 09:50 libacl.so.4.0
X-rw-r--r--  1 deraadt  wheel  351730 Jun 18 09:50 libc.so.12.3
X-rw-r--r--  1 deraadt  wheel  377359 Jun 18 09:50 libc.so.12.6
X-rw-r--r--  1 deraadt  wheel   16608 Jun 18 09:50 libcrypt.so.0.0
X-rw-r--r--  1 deraadt  wheel   16465 Jun 18 09:50 libcrypt.so.1.0
X-rw-r--r--  1 deraadt  wheel   44424 Jun 18 09:50 libcurses.so.2.1
X-rw-r--r--  1 deraadt  wheel   86198 Jun 18 09:50 libcurses.so.3.0
X-rw-r--r--  1 deraadt  wheel   42254 Jun 18 09:50 libdes.so.4.1
X-rw-r--r--  1 deraadt  wheel   66099 Jun 18 09:50 libedit.so.0.0
X-rw-r--r--  1 deraadt  wheel   43131 Jun 18 09:50 libform.so.0.0
X-rw-r--r--  1 deraadt  wheel  387976 Jun 18 09:50 libg++.so.2.0
X-rw-r--r--  1 deraadt  wheel  305738 Jun 18 09:50 libg++.so.27.1
X-rw-r--r--  1 deraadt  wheel   25544 Jun 18 09:50 libgnumalloc.so.0.0
X-rw-r--r--  1 deraadt  wheel   42696 Jun 18 09:50 libiberty.so.0.0
X-rw-r--r--  1 deraadt  wheel   25282 Jun 18 09:50 libkadm.so.4.0
X-rw-r--r--  1 deraadt  wheel   16610 Jun 18 09:50 libkafs.so.4.0
X-rw-r--r--  1 deraadt  wheel   25539 Jun 18 09:50 libkdb.so.4.0
X-rw-r--r--  1 deraadt  wheel   59943 Jun 18 09:50 libkrb.so.4.0
X-rw-r--r--  1 deraadt  wheel   25328 Jun 18 09:50 libkvm.so.4.0
X-rw-r--r--  1 deraadt  wheel  102104 Jun 18 09:50 libm.so.0.1
X-rw-r--r--  1 deraadt  wheel   26540 Jun 18 09:50 libmenu.so.0.0
X-rw-r--r--  1 deraadt  wheel   44424 Jun 18 09:50 libocurses.so.2.1
X-rw-r--r--  1 deraadt  wheel   16881 Jun 18 09:50 libpanel.so.0.0
X-rw-r--r--  1 deraadt  wheel   60222 Jun 18 09:50 libpcap.so.0.0
X-rw-r--r--  1 deraadt  wheel   25060 Jun 18 09:50 libresolv.so.1.0
X-rw-r--r--  1 deraadt  wheel   16465 Jun 18 09:50 libresolv.so.2.0
X-rw-r--r--  1 deraadt  wheel   33538 Jun 18 09:50 libskey.so.0.0
X-rw-r--r--  1 deraadt  wheel   25764 Jun 18 09:50 libss.so.4.0
X-rw-r--r--  1 deraadt  wheel  277954 Jun 18 09:50 libstdc++.so.27.1
X-rw-r--r--  1 deraadt  wheel   16835 Jun 18 09:50 libtelnet.so.1.0
X-rw-r--r--  1 deraadt  wheel   16691 Jun 18 09:50 libtermcap.so.0.0
X-rw-r--r--  1 deraadt  wheel   16691 Jun 18 09:50 libtermlib.so.0.0
X-rw-r--r--  1 deraadt  wheel   75039 Jun 18 09:50 libtermlib.so.1.0
X-rw-r--r--  1 deraadt  wheel   16625 Jun 18 09:50 libutil.so.3.1
X-rw-r--r--  1 deraadt  wheel   25628 Jun 18 09:50 libutil.so.3.2
d363 1
a363 1
Xbuilt a chroot jail for a server on it) You may be better off
a386 3
X   diff[utils] (unless you're running *BSD, probably better get it from a gnu
X                 mirror...the Makefile doesn't work otherwise)
X   rcs         (from the OpenBSD source tree)
a389 3
X   rcs must have diff3 capable of diff3 -m during configure.
X   OSF doesn't by default, thus I had to compile diffutils first.
X
a392 1
X
@


1.11
log
@better pserver support and info
@
text
@d64 1
a64 1
X    you need roughly 750MB.
@


1.10
log
@	- Tell people to use anoncvs1.ca.openbsd.org to sup from.
	- Fix strange dir permissions on example
@
text
@d162 9
d200 1
a200 1
XIt should contain the single line:
d203 3
d587 1
a587 1
X	seteuid(0);
d593 1
a593 1
X	setuid(getuid());
d634 2
a635 1
X		execle("/usr/bin/cvs", "cvs", "pserver", NULL, env);
@


1.9
log
@	Minor README mod - take care of another possible gotcha.
@
text
@d64 1
a64 1
X    you need roughly 500MB.
d169 2
a170 1
X   to sup from. 
d186 1
a186 1
Xcvs tree from. it can contain *one* of:
a188 3
X    cvs host=cvs.openbsd.org hostbase=/ base=/open/anoncvs delete
X
X    You should ask which one to use when obtaining sup permission.	
d256 1
a256 1
Xdrwxrwxrwx  2 deraadt  wheel  512 Nov 29  1995 bin/
d266 1
a266 1
Xdrwxrwxrwx  2 deraadt  wheel     512 Nov 29  1995 ./
d384 1
a384 1
XBob Beck <beck@@panopticon.ucs.ualberta.ca> has done this. E-mail for
d416 1
@


1.8
log
@anoncvssh.c
     	-Fix bug in testing for anoncvs pserver.
	-Add optional support for syslogging pserver connections.
	-Add optional check for anoncvs user when starting.
@
text
@d79 2
a80 1
Xcreate an account:
a81 1
Xyes, that is right. the account has no password.
d83 5
a87 1
Xdecide on who will run sup to maintain the archive. call that user $SUPUSER.
@


1.7
log
@ Redo README in anoncvs.shar file to be (hopefully) a bit easier
on a first-timer. Update anoncvs1.ca's info in anoncvs.html.
@
text
@d492 29
d551 21
d584 1
d586 33
a618 1
X	if (strcmp("pserver", argv[1])) {
d625 1
a631 1
X
a644 1
X
@


1.6
log
@new anoncvs.shar; includes pserver work by todd@@
@
text
@a25 9
Xfind enough disk space.
X    you need roughly 300MB.
X    mount it on /open
X    if you are not able to mount it as /open, substitute it's location
X    throughout this description
X    
Xcompile the anoncvssh binary
X    in the Makefile, change the variable CVSROOT
X    install the binary setuid-root.
d27 25
a51 3
Xcreate an account:
X    anoncvs::32766:32766:Anonymous CVS User:/open/anoncvs:/open/anoncvssh
Xyes, that is right. the account has no password.
d53 3
a55 5
XFor :pserver: support (optional)
X  - Create an entry in /etc/services
X     cvspserver		2401/tcp		# CVS client/server operations
X  - Create an entry in /etc/inetd.conf
X     cvspserver	stream	tcp nowait anoncvs /open/anoncvssh anoncvssh pserver
d57 1
a57 2
Xinstall a crontab entry which runs as any user besides anoncvs (ie. run
Xit as yourself, or as root). call that user $SUPUSER
d59 2
a60 2
XFor example:  To run every three hours 'sup -v supfile', and thrice
Xweekly 'sup -vo supfile' .. because sup is not reliable ..
d62 6
a67 3
X0 0,3,6,9,12,15,18,21 * * 0,2,4,5 sup -v  /open/anoncvs/sup/ss > /dev/null
X0 0,12,15,18,21       * *  1,3,6  sup -v  /open/anoncvs/sup/ss > /dev/null
X0 3                   * *  1,3,6  sup -vo /open/anoncvs/sup/ss > /dev/null
d69 4
a72 2
Xanoncvs5.usa.openbsd.org uses this particular set of entries.  A `sup
X-o' is done every few days because sup is not very robust.
d74 4
a77 2
Xthe file /open/sup/ss contains
X    cvs host=cvs.openbsd.org hostbase=/ base=/open/anoncvs delete
d79 3
a81 4
Xthe file /open/sup/cvs/refuse should contain the single line
X    cvs/CVSROOT/history
Xif you ever fetch the file cvs/CVSROOT/history, delete it. it will
Xcause you problems.
d83 8
a90 4
Xon an IRIX or other SYSV machine, ensure that your kernel does not allow
Xa user to chown a file to another user. this will cause sup to give away
Xthe files to root before chmod'ing them readable. michaels@@openbsd.org
Xknows how to fix this.
a91 1
Xmkdir /open/
d97 3
a99 1
Xstart filling the account up with nice stuff
d151 1
a151 1
Xnot world writeable (except dev/null)
d153 13
a165 2
Xsend mail to deraadt@@openbsd.org
X1) to have sup permissions granted.
d169 64
a232 1
XExample layout. In this example "deraadt" is the $SUPUSER.
d374 10
a383 1
XThat's pretty much it.
d385 1
@


1.5
log
@new anoncvs from thorsten
@
text
@d8 1
a9 1
#	Makefile
d12 12
d40 6
a47 2
X    0       */3     * * 0,1,3,4,6   /usr/local/bin/sup -v /open/sup/ss
X    0       */6     * * 2,5         /usr/local/bin/sup -vo /open/sup/ss
d49 8
a56 1
Xanoncvs1.usa.openbsd.org uses this particular set of entries.  A `sup
d75 2
a76 2
Xmkdir /open/sup
Xchown -R $SUPUSER /open/anoncvs/cvs /open/sup
d84 2
a85 1
X    To use anonymous CVS install the latest version of CVS on your local machine.
d120 1
d270 1
a270 1
X[eap anoncvs 15 ]> ls /open
d280 29
a309 12
echo x - Makefile
sed 's/^X//' >Makefile << 'END-of-Makefile'
X#CVSROOT=anoncvs@@anoncvs1.usa.openbsd.org:/cvs
XPROG=   anoncvssh
XBINOWN= root
XBINMODE=4111
XBINDIR=/open
XNOMAN=
X
X.include <bsd.prog.mk>
X
END-of-Makefile
d428 9
@


1.4
log
@new anoncvs.shar file
@
text
@d362 3
d390 2
a391 1
X		strcmp("cvs server", argv[2]) != 0) {
d398 5
d411 1
@


1.3
log
@more complete anoncvs instructions
@
text
@d39 10
a111 1
X
d274 67
d342 1
a342 1
X#define CVSROOT "anoncvs@@anoncvs1.usa.openbsd.org:/cvs"
d345 10
a354 4
X#include <stdio.h>
X#include <unistd.h>
X#include <pwd.h>
X#include <sys/types.h>
d378 1
a378 1
X	seteuid(getuid());
d398 2
a399 11
X	/*                     
X	 * since the only things in annocvs's bin entire chroot space will
X	 * be "safe commands", this is not a big deal
X	 */
X	putenv("SHELL=/bin/sh");
X	putenv("CVSROOT=/cvs");
X	putenv("HOME=/");
X	putenv("CVSREADONLYFS=");
X
X	execl("/usr/bin/cvs", "cvs", "server", NULL);
X	perror("execl: cvs");
@


1.2
log
@the anoncvs account has no password
@
text
@d22 1
a22 1
X    anoncvs is installed setuid-root.
d30 5
a34 1
X    0 5,9,13,17,21,1 * * * /usr/local/bin/sup -v /open/sup/ss
d70 8
a77 6
Xanoncvssh (by setting an extra environment variable) use an extension
Xprovided in the openbsd cvs server code. therefore you want to compile
Xthe openbsd version. luckily this is not a problem on a non-openbsd
Xmachine since the cvs sources are imported verbatim into the openbsd
Xtree. they are in gnu/usr.bin/cvs. (explanation: the extension allows
Xa way to have read-only cvs repositories)
d97 149
a245 1
Xsend mail to deraadt@@openbsd.org to have sup permissions granted.
@


1.1
log
@put anoncvs setup info in the www area
@
text
@d25 2
a26 1
X    anoncvs:*:32766:32766:Anonymous CVS User:/open/anoncvs:/open/anoncvssh
@
