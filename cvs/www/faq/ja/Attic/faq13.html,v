head	1.36;
access;
symbols;
locks; strict;
comment	@# @;


1.36
date	2005.08.13.08.19.34;	author saad;	state dead;
branches;
next	1.35;

1.35
date	2005.01.31.11.02.52;	author saad;	state Exp;
branches;
next	1.34;

1.34
date	2005.01.29.17.01.31;	author jufi;	state Exp;
branches;
next	1.33;

1.33
date	2004.05.09.09.58.22;	author saad;	state Exp;
branches;
next	1.32;

1.32
date	2004.01.04.22.43.22;	author horacio;	state Exp;
branches;
next	1.31;

1.31
date	2003.11.03.16.52.23;	author jufi;	state Exp;
branches;
next	1.30;

1.30
date	2003.07.26.13.08.15;	author jufi;	state Exp;
branches;
next	1.29;

1.29
date	2003.07.04.22.16.13;	author jufi;	state Exp;
branches;
next	1.28;

1.28
date	2003.06.27.21.20.01;	author jufi;	state Exp;
branches;
next	1.27;

1.27
date	2003.06.15.12.36.09;	author jufi;	state Exp;
branches;
next	1.26;

1.26
date	2003.05.10.13.21.29;	author jufi;	state Exp;
branches;
next	1.25;

1.25
date	2003.04.04.14.44.32;	author jufi;	state Exp;
branches;
next	1.24;

1.24
date	2003.04.02.08.57.35;	author jufi;	state Exp;
branches;
next	1.23;

1.23
date	2003.03.26.16.54.59;	author jufi;	state Exp;
branches;
next	1.22;

1.22
date	2003.03.19.19.08.27;	author jufi;	state Exp;
branches;
next	1.21;

1.21
date	2003.02.28.19.46.47;	author jufi;	state Exp;
branches;
next	1.20;

1.20
date	2003.02.25.19.56.58;	author jufi;	state Exp;
branches;
next	1.19;

1.19
date	2003.02.21.17.24.50;	author jufi;	state Exp;
branches;
next	1.18;

1.18
date	2003.02.19.18.12.52;	author jufi;	state Exp;
branches;
next	1.17;

1.17
date	2003.01.15.18.16.57;	author jufi;	state Exp;
branches;
next	1.16;

1.16
date	2003.01.14.11.59.23;	author jufi;	state Exp;
branches;
next	1.15;

1.15
date	2003.01.04.23.29.57;	author jufi;	state Exp;
branches;
next	1.14;

1.14
date	2002.12.14.23.48.43;	author jufi;	state Exp;
branches;
next	1.13;

1.13
date	2002.11.04.12.12.23;	author jufi;	state Exp;
branches;
next	1.12;

1.12
date	2002.09.28.19.31.29;	author jufi;	state Exp;
branches;
next	1.11;

1.11
date	2002.07.13.07.58.28;	author jufi;	state Exp;
branches;
next	1.10;

1.10
date	2002.07.09.10.47.50;	author jufi;	state Exp;
branches;
next	1.9;

1.9
date	2002.07.02.09.13.42;	author jufi;	state Exp;
branches;
next	1.8;

1.8
date	2002.06.20.11.18.24;	author jufi;	state Exp;
branches;
next	1.7;

1.7
date	2002.06.03.20.00.44;	author jufi;	state Exp;
branches;
next	1.6;

1.6
date	2002.05.08.11.02.49;	author jufi;	state Exp;
branches;
next	1.5;

1.5
date	2002.04.28.10.26.23;	author jufi;	state Exp;
branches;
next	1.4;

1.4
date	2002.03.23.10.19.40;	author jufi;	state Exp;
branches;
next	1.3;

1.3
date	2002.01.13.12.01.46;	author jufi;	state Exp;
branches;
next	1.2;

1.2
date	2001.10.21.09.07.11;	author jufi;	state Exp;
branches;
next	1.1;

1.1
date	2001.06.16.17.32.26;	author jufi;	state Exp;
branches;
next	;


desc
@@


1.36
log
@remove unmaintained [ja] translation files. requested by translator.
@
text
@<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>13 - Using IPsec</title>
<link rev= "made" href= "mailto:www@@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=iso-2022-jp">
<meta name= "resource-type" content= "document">
<meta name= "description"   content= "the OpenBSD FAQ page">
<meta name= "keywords"      content= "openbsd,faq">
<meta name= "distribution"  content= "global">
<meta name= "copyright"     content= "This document copyright 2000-2004 by OpenBSD">
</head>

<body bgcolor= "#ffffff" text= "#000000">
<a href="../index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../images/smalltitle.gif" border="0">    
</a>
<p>
<font color= "#0000e0">
<a href= "index.html">[FAQ の目次]</a>
<a href= "faq12.html">[12 章 - 高度なユーザ向け]</a>
<a href= "faq14.html">[14 章 - OpenBSD のハードディスク]</a>
</font>

<h1><font color="#e00000">13 - IPsec (IP Security Protocol) を使う</font></h1>
<hr>
 
<p>
メンテナンスが不十分でしたので、この章は削除されました。

<p>
できれば、将来は復活させたいと思います。
 

<p>
<font color= "#0000e0">
<a href= "index.html">[FAQ の目次]</a>
<a href= "faq12.html">[12 章 - 高度なユーザ向け]</a>
<a href= "faq14.html">[14 章 - OpenBSD のハードディスク]</a>
</font>

<p>
<hr>
<a href= "index.html"><img height= "24" width= "24" src= "../../images/back.gif" border= "0" alt="[back]"></a>
<a href="mailto:www@@openbsd.org">www@@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: faq13.html,v 1.82 ]
<br>
$Translation: faq13.html,v 1.35 2005/01/29 09:23:19 toshi Exp $
<br>
$OpenBSD: faq13.html,v 1.35 2005/01/31 11:02:52 saad Exp $
</small>

</body>
</html>
@


1.35
log
@sync with Steelix CVS
@
text
@d52 1
a52 1
$OpenBSD: faq13.html,v 1.81 2004/01/01 04:13:34 nick Exp $
@


1.34
log
@sync with steelix translation CVS
@
text
@@


1.33
log
@sync with Steelix CVS
@
text
@d15 3
a17 1
<img alt="[OpenBSD]" height=30 width=141 src="../../images/smalltitle.gif">
d48 1
a48 1
Originally [OpenBSD: faq13.html,v 1.81 ]
d50 1
a50 1
$Translation: faq13.html,v 1.34 2004/01/03 02:42:02 toshi Exp $
@


1.32
log
@Sync with Steelix CVS
@
text
@@


1.31
log
@sync with steelix translation CVS
@
text
@d11 1
a11 1
<meta name= "copyright"     content= "This document copyright 2000-2003 by OpenBSD">
d46 1
a46 1
Originally [OpenBSD: faq13.html,v 1.80 ]
d48 1
a48 1
$Translation: faq13.html,v 1.33 2003/07/26 02:39:51 toshi Exp $
d50 1
a50 1
$OpenBSD: faq13.html,v 1.80 2003/07/25 19:55:38 nick Exp $
@


1.30
log
@sync with steelix translation CVS
@
text
@@


1.29
log
@sync with steelix translation CVS
@
text
@d27 1
a27 14
<h3>目次</h3>
<ul>
<li><a href="#What"     >13.1 - IPsec とは何でしょう ?</a>
<li><a href="#Why"      >13.2 - それはすごい。しかし、なぜ IPsec を使う必要があるのでしょう ?</a>
<li><a href="#Protocols">13.3 - IPsec の裏にあるプロトコルは ?</a>
<li><a href="#Wire"     >13.4 - ネットワーク上のパケットフォーマット</a>
<li><a href="#Config"   >13.5 - IPsec の誓瀋鹿畩
殊蘊釈鱚羹■浴酲纖庄凱賓黼を手動鍵誓瀋蠅濃箸Δ砲鹿畩
殊蘊釈鱚羹■蜩瘠逅笄庄凱蜩瘠逅のセットアップは ?</a>
<li><a href="#x509"     >13.8 - isakmpd を X.509 証明製颪隼藩僂垢襪砲鹿畩
殊蘊釈鱚羹■彬塔譬庄凱彬クライアントで isakmpd と互換誓△襪里鹿畩
殊蘊釈鱚羹■夸阨碎紜庄凱碓偕繝侘ぢのトラブルシューティング</a>
<li><a href="#SeeAlso"  >13.11 - 関連ドキュメンテーション</a>
</ul>
d30 1
a30 979
<font size="-1">
このドキュメントの一部は、以下のドキュメントから取ってきています。
</font>
<ul style="font-size: small">
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&sektion=4&format=html">ipsec(4)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&sektion=8&format=html">vpn(8)</a>
<li><a href="http://www.freebsd.org/~julian/IPSEC_4_Dummies.html">IPsec for Dummies</a> by Julian Elischer
<li><a href="http://www.secureops.com/vpn/vpn.html">ISAKMP Howto</a> by Patrick Ethier
<li><a href="http://hem.passagen.se/hojg/isakmpd/">X.509v3 certificates with isakmpd</a> by J&ouml;rgen Granstam
</ul>

<hr>

<p>
<a name= "What"></a>
<a name= "13.1"></a>
<h2>13.1 - IPsec とは何でしょう ?</h2>

<p>
IPsec は、IP プロトコルファミリーに対する拡張であり、
暗号セキュリティサービスを提供するものです。このサービスで、認証、
完全誓蜴苒蜚、アクセス誓罅〔性が提供されます。IPsec は
SSL と似たサービスを、ネットワーク層で提供しており、しかもアプリケーションには
完全に透過的で、しかもずっと強力なものです。透過的とは、IPsec を使用する上で、
アプリケーションは IPsec のことを何ひとつ知らなくて良い、
ということです。
IPsec 上では<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/protocols?rev=1.13">あらゆる IP プロトコル</a>を使用可能です。暗号化トンネル (VPN) も作誓椎修任垢掘▲灰鵐團紂璽心屬巴噂磴憤店羃修鬚垢襪海箸發任泙后
ただ澄▲廛轡腑鵑造砲い蹐い蹐△襪燭瓩法賓黼は少し複雑かも知れません (それも SSL よりずっと !)。

<p>
IPsec を使う前に、
FAQ <a href="../faq6.html">6 章</a>の推奨文献には
ぜひ目を通しておいてくだ世気ぁＦ辰法△發アドレスの考え方がわかっていないのでしたら、
<a href="http://www.3com.com/corpinfo/en_US/technology/tech_paper.jsp?DOC_ID=135">Understanding
IP Addressing</a> (または、
<a href="http://www.3com.com/other/pdfs/infra/corpinfo/en_US/501302.pdf">ここ</a>)
を特に推奨します。

<p>
論斥砲蓮賓黼は以下のどのような形でも機能します。

<ul>
<li>Host-to-Host
<li>Host-to-Network
<li>Network-to-Network
</ul>

<p>
ネットワークの関係するすべてのシナリオで、私たちはルータを念頭に置いています。
つまりは Host-to-Router (そしてこのルータは、ある<i>Network</i>の
トラフィックを誓罎靴動店羃修靴泙ぢ。

<p>
これから見るように、IPsec は VPN 誓楝獲僂縫肇薀侫奪鬟肇鵐優襪垢襪海箸任泙后
でも、その応用は VPN よりはるかに広いものです。中央インターネット鍵交換登録所があれば、
インターネット上の全マシンは、お互いにやり取りする際に
強力な暗号や認証が使用可能になるのです !

<p>
<a name= "Why"></a>
<a name= "13.2"></a>
<h2>13.2 - それはすごい。しかし、なぜ IPsec を使う必要があるのでしょう ?</h2>

<p>
インターネットのプロトコルである IP または IPv4 は、それ自体としては、転送しているデータに対して何の保護も提供しません。
送信元が、自分で名乗っているとおりの存在かどうかすら保証してくれないのです。
IPsec はこれを解決しようとします。以下のサービスはそれぞれ独立と考えられていますが、
IPsec はそれを統一的な形でサポートしています。

<p>
<h4>機密誓鹿茣受信者以外の人には、どのようなデータが通信されたかを
理解しにくいようにしておきます。たとえば、インターネット経由で
リモートのマシンにログインする際に、パスワードのセキュリティを
保証します。

<p>
<h4>完全誓侮苒蜚鹿茣データが途中で改竄されないようにします。
誓禅畚颯如璽燭鬟鵐薀ぅ鵑覗垢訃豺腓法
数量や金額やアカウント番号が誓騎里如
途中で改竄されたりしていないかどうかを確認したいはずです。

<p>
<h4>Authenticity (誓疑神性／確実誓款ぢデータに署名して、それを送信したのが本当にあなただ世搬召凌佑
確認できるようにします。ドキュメントが改竄されていないことが確認できるのは、
明世卜匹い海箸任靴腓Α

腫取款再送保護 (Replay protection)</h4> やり取りは、何度受信されたかに関係ないもの以外、
データグラムの処理が確実に一回だ世韻靴圓錣譴覆い茲Δ砲垢詈，廚任后
つまり、攻撃者が (銀行口座からの引き出しのような) トランザクションを記録し、
それをそのまま再送して、(引き出し要求の) 新しいメッセージを受信したと
相手に思わせるようなことができてしまうようではいけません。
<i>警告: 通常の仕様に関する限り、手動鍵の IPsec を使用している場合
(たとえば
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&amp;sektion=8">ipsecadm(8)</a>)</i>
を使用している場合) には、再送からの保護は実行されません</i>。

<p>
<a name= "Protocols"></a>
<a name= "13.3"></a>
<h2>13.3 - IPsec の裏にあるプロトコルは ?</h2>

<p>
IPsec は、機密誓袷汗性、authenticity (誓疑神性)、再送保護を提供するのに、
新しいプロトコルを 2 つ使用します。そのプロトコルとは、認証ヘッダ組装緕竅闔縺粤鬧ぢと暗号ペイロード (ESP: Encapsulating Security Payload) です。

<p>
AH は認証と完全誓蛤徳欷遒鯆鷆，靴泙が、機密誓歪鷆，靴泙擦ぢ。
認証機能についての AH と ESP との主な差は、AH はパケットの
IP ヘッダ世琉貮たとえばパケットの送信元・送信誓茱▲疋譽も
認証するのに対して、ESP はパケットのペイロードのみを認証する
ということです。

<p>
ESP は認証、完全誓∈徳欷遏▲如璽慎〔性を
提供します (ヘッダ世紡海僖吋奪汎發里垢戮討鯤欷遒靴泙ぢ。
再送保護には認証と完全誓廚任
ぢこのふたつは必ず対となるものです)。機密誓暗号化) は、
認証/完全誓陵気亡悗錣蕕沙藩儔椎修任后
同様に、認証/完全誓狼〔性なしでも使用できます。

<p>実際には、ほとんどのアプリケーションに対して ESP の使用が推奨されています。

<p>
<a name= "Wire"></a>
<a name= "13.4"></a>
<h2>13.4 - ネットワーク上のパケットフォーマット</h2>

<p>
<b>認証ヘッダ装緕竅闔縺粤鬧鹿眈
肌ぢは基本的な IP ヘッダ世慮紊砲董▲如璽燭琉店罐魯奪轡紊
識別情報を持っています。ハッシュは 
IP ヘッダ声里痢疏罎肪佑儔修靴覆ど皀弌爾任泙后
組ぢに使う実際のアルゴリズムについては、いくつかの個別の RFC があって選択可能になっていますが、
そのいずれについても、<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC2402</a> に指定されたガイドラインには準拠していなくてはならない。

<p>
<b>暗号ペイロード (Encapsulating
Security Payload)</b> (ESP) ヘッダ世蓮▲撻ぅ蹇璽匹魄店羃修気譴新舛能颪垢┐襪海箸魏椎修砲靴泙后
途ヘッダ世蓮△修譴棒先立つ IP
ヘッダ世楼靴い泙擦鵑里如▲撻ぅ蹇璽桧奮阿里發里砲弔い討呂泙辰燭歉擇靴泙擦鵝
それぞれ各種の ESP は <a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC2406</a> に従う必要があります。
ESP ヘッダ世蓮▲撻ぅ蹇璽匹稜Ь擇眥鷆，任泙が、ESP の外の
ヘッダ世砲弔い討惑Ь擇任泙擦ぢ。

<p>
IPsec 機能の直交誓ほとんどの) 部分は、IPsec カプセル化を
実行する終端がデータの元の発信源なのかゲートウェイなのかに
応じて適用されます。

<ul>
<li><b>Transport</b> モードは、パケットを誓言成しているホストが使用するものです。
Transport モードでは、セキュリティヘッダ世魯肇薀鵐好檗璽帆弛嫩乂ぢのヘッダ世料阿法賓ヘッダ世僖吋奪箸寮先頭に付与される前の段階で追加されます。
言世ご垢┐譴弌▲僖吋奪箸膨媛辰気譴が
TCP ヘッダ世函緕筬鈔ヘッダ世琉貮凜侫璽襯匹離魯奪轡鵐阿鮹甘垢襪箸いΔ海箸覆里任后
そして、TCP ヘッダ世肇如璽燭琉店羃修嗤ぢヘッダ世弌爾靴泙垢△靴掘
それは end-to-end IP ヘッダ世泙念店羃修靴討譴襪錣韻任呂△蠅泙擦鵝

殊蘊錫ぢトンネル</b>モードは、すでに end-to-end IP ヘッダ世
パケットに追加されている場合に、さらにセキュア誓楝海諒卻涼爾
単なるゲートウェイの場合に使用されます。このモードでは、AH と ESP ヘッダ世蓮鈔鎰緕蒹痲纈ぢを含め、
パケット全体をカバーするのに使用されます。そして、セキュア誓楝海慮海Δ涼爾泙任離曠奪廚里
ぢただ世掘△海譴呂發舛蹐麒瑤ホップをまたがっているかも知れません) をカバーする、
新しい IP ヘッダ世佞営召気譴泙后
鹿
腫症偕繝ぢで保護されたリンクは、<b>Security Associations
</b>(SAs) によって定義づけられます。各 SA は単一の単方向のデータの流れについて定義されており、
普通は (マルチキャストは無視して) ひとつの点世虔未療誓までについて、何らかの
<b>ユニークなセレクタ</b>によって識別できるトラフィックフローを指します。単一の SA 上を流れるトラフィックは
すべて同じ扱いを受けます。トラフィックの中には、複数の SA を経るものもあって、
そのそれぞれが何らかの変換を加えます。また、SA の集団を SA <b>Bundle</b> と呼びます。
入ってくるパケットは、3 つの定義フィールド (<b>宛誓アドレス、セキュリティパラメータインデックス
(Security Parameter Index)、セキュリティプロトコル</b>) に応じて指定の SA に割り当てることができます。
セキュリティパラメータインデックス (Security Parameter Index、略して SPI) は、
誓楝海離僖薀瓠璽燭離優乾轡─璽轡腑鵑圓錣譴觝櫃法啻ぢの受け手が手渡すクッキーだ世隼廚┐侘匹い任靴腓Α
また、セキュリティプロトコルは、AH か ESP のどちらかでなくてはなりません。受け手の IP アドレスが
この 3 つ 1 組の中に含まれていますので、これはユニークな値になることが保証されています。
これは外側の IP ヘッダ世藐弔韻襪海箸發任泙垢掘∈能蕕離札絅螢謄悒奪誓
(これは SPI とセキュリティプロトコルを含む) から見つけることもできます。

<p>
以下にトンネルモードの AH パケットの例を挙げます。

<p>
<table border="1">
<tr>
<td><b>IPヘッダ鹿眈鹿儒箴錫樵伴昭箴
儒箴賓ヘッダ下箴
儒箴埣ぢヘッダ鹿儒箴データ</td>
</tr>
</table>

<p>
また、transport モード AH パケットの例を挙げます。

<p>
<table border="1">
<tr>
<td><b>IPヘッダ鹿眈鹿儒箴錫樵伴昭箴
儒箴埣ぢヘッダ鹿儒箴データ</td>
</tr>
</table>

<p>
ESP ヘッダ世漏安Δヘッダ世鯒Ь擇任泙擦鵑里如
組ぢと ESP ヘッダ世鯀箸濆腓錣擦動焚爾里茲Δ砲垢戮任靴腓Α

腫儒痰跂闥粤鮟⊂
儒鮠
儒箴錫症ぢヘッダ鹿眈鹿儒箴錫樵伴昭箴
儒箴錫湘嗤鹿眈鹿儒箴守菖弛ヘッダ鹿蘊鹿儒箴守ぢデータ</i></td>
</tr>
</table>

<p>これは <b>Transport Adjacency</b> と呼ばれるものです。
トンネル版の場合には、以下の例のようになります。

<p>
<table border="1">
<tr>
<td><b>IPヘッダ鹿眈鹿儒箴錫樵伴昭箴
儒箴錫湘嗤鹿眈鹿儒箴守症ぢヘッダ下昭箴
儒箴守菖弛ヘッダ鹿蘊鹿儒箴守ぢデータ</i></td>
</tr>
</table>

<p>
しかし、これは RFC には明声傍劼気譴討呂い泙擦鵝夸瘤齔闥痲裃竇釿と同様に、これはIP ヘッダ世涼罎離悒奪誓いくつかを除いて全パケットを認証した上で、
ペイロード (イタリックで表示) を暗号化します。
AH と ESP ヘッダ世海里茲Δ膨樟接同時に適用されている場合には、
ヘッダ世僚臠屬肋綉里茲Δ砲覆辰討い詆廚△蠅泙后肇鵐優襯癲璽匹任蓮
任意の再帰的なカプセル化を行うことで、この順番が指定されないようにすることも可能です。

<p>
<a name= "Config"></a>
<a name="13.5"></a>
<h2>13.5 - IPsec の誓瀋鹿莢
腫賓黼システムとゲートウェイがどのように誓瀋蠅気譴襪蓮△△訥戮論設計者に任されて
いることではありますが、RFC にはそれがどのように実装されるべきかについての強い推奨があり、
混乱を最小限に抑えようとしています。

<p>
パケットに何が起こるかをコントロールするための管理エンティティが 2 つあます。
ひとつは <b>Security Association Database</b> (SAD、
OpenBSD の IPsec ソースコードの中では、TDB または TDB table と呼ばれるものです) で、
もう一つは<b>Security Policy Database</b> (SPD) です。

<p>
このふたつは、あるトラフィックを表現したセレクタをいくつか与えられると、
必要となる処理を記述したエントリを提供してくれるという点世濃討い泙后
しかし、SPD は実際の処理からは二段階ほど遠いところにあります。
SPD は外へ出るパケットに使用されて、どの SAD エントリを使用すべきか決定するのに利用されます。
逆に SAD エントリは、実際のプロセスとそこで使用されるパラメータを記述します。
SPD のエントリは、既存の SAD エントリのうちのどれを使用するのか
(バンドルなら、SAD エントリは複数あり得世泙垢里を指定しますが、しかし、既に
適誓擇覆發里覆ぞ豺腓砲蓮△修離┘鵐肇蠅鮖藩僂靴匿靴靴い發里鄒成されます。作誓気譴のフィールドは、
SPD エントリから持ってくる場合もありますし、そのフィールド新誓澆
開始させたパケットから持ってくる場合もあります。

<p>
外行きのパケットは、SPD エントリから個別の SA に行ってエンコーディング用
パラメータを取得世靴泙后Ｆ辰討襯僖吋奪箸蓮嗤逼宛誓賓ぢプロトコルの 3 点瀬札奪箸鮖藩僂靴
直誓楡正しい SA にたどりつき、そこから SPD エントリにたどりつきます。

<p>
SPD はまた、どのトラフィックが IPsec をバイパスすべきか、また、どのトラフィックを
破棄すべきかを指定できますので、入ってくる非 IPsec のトラフィックについても参照されなくてはなりません。
SPD エントリは、順番が明声房┐気譴討い詆廚△蠅泙后△襯僖吋奪箸吠瑤里發里泪奪舛垢覯椎柔性がありますし、
処理には再現誓覆討呂覆蕕覆い蕕覆里任后

腫嗤というのは、パケットフィルタと似たようなものだ世隼廚┐侘匹い眞里譴泙擦鵝修海之萃蠅気譴襯▲轡腑鵑蓮
啻ぢプロセスの起動になるのです。セレクタとして使用できるのは
送信元と宛誓茱▲疋譽后愀犬△訃豺腓砲魯檗璽犯峭罅▲▲廛螢院璽轡腑鵑筺△△訃豺腓砲魯罅璽ぢこれは host based transport SA のみ)、ホスト名、セキュリティ
感度レベル、プロトコルなどです。

<p>
SAD エントリに含まれるのはたとえば、

<ul>
<li>宛誓アドレス
<li>IPsec プロトコル(AH か ESP)
<li>SPI (クッキー)
<li>シーケンスカウンタ
<li>Seq O/F フラグ
<li>Anti-replay window info
<li>AH の種類と情報
<li>ESP の種類と情報
<li>寿命情報
<li>Tunnel/transport モードフラグ
<li>Path MTU 情報
</ul>

<p>
SPD エントリに含まれるのは、

<ul>
<li>SA起動ポインタ
<li>セレクタフィールド
</ul>

<p>
各 SA は、ESP ヘッダ世劼箸弔ヘッダ世劼箸弔箸鯆蟲舛任泙后
賓黼セッションはこのどちらか、あるいは両方を持たなければなりません。どちらのヘッダ世發覆靴把蟲舛気譴襪海箸
できければなりません――さもないと、SA を参照するための SPI を指定するヘッダ世覆い海箸砲覆辰討靴泙い泙后
卞は、AH と ESP ヘッダ世佗ぢの値について
別々の指定をしている場合のことは定義していません。
これはバンドル中の複数の SA を意味するものと判断されることが考えられます。

<p>
OpenBSD の SPD は、<tt>ipsecadm flow</tt> コマンドを使用して管理されます
(これに変更を加えるのは、手動鍵誓瀋蠅鮖藩僂垢訃豺腓誓けです)。
SAD エントリは、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&amp;sektion=8">ipsecadm(8)</a>
を使用すればマニュアルで誓瀋蠅任泙垢錨堝ぢはセッションや
鍵交換の初期化などの自動メカニズムも定義しています。
OpenBSD は ISAKMP 自動鍵交換
(<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">RFC2407</a>、
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC2408</a> ならびに
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">RFC2409</a>)
を実装していて、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&amp;sektion=8">isakmpd(8)</a>
デーモンで使用されています。

<p>
a name= "ManKey"></a>
<a name= "13.6"></a>
<h2>13.6 - IPsec を手動鍵誓瀋蠅濃箸Δ砲鹿莢
腫賓黼の手始めとして最も簡単なのが手動鍵誓瀋蠅任后
この手法でネットワーク間を暗号化して VPN を作れます。
この部分を読んだ世蕁△海寮設定を自動化するのに
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.3">/usr/share/ipsec/rc.vpn</a>
を使用する、ということも実行してみると良いかも知れません。

<p>
まず、OpenBSD カーネルの IP AH と IP ESP オプションが有効になっていることを
確認してくだ世気ぁ海譴魯妊侫襯箸罵修気譴討い泙垢焚爾里茲Δ砲靴
それを確認しておいてくだ世気ぁ

錫跫站髟阡緇儒
錫杖笏鈬蜴續齔釶碎綣昭碣鈬蜴續齔釶碎閏碣鹿昭跫站髟阡緇

腫ぢ同様に、もし AH が必要なら、以下のようにして有効化されていることを確認してくだ世気ぁ
錫跫站髟阡緇儒
錫杖笏鈬蜴續莅緕痰跂鹿眈錫鮠
鈬蜴續莅緕痰跂
鹿昭跫站髟阡緇


腫もし、必要でしたら、
これらのプロトコルは
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=8">sysctl(8)</a>
で <i>-w</i> オプションを使用して有効化することができるはずです。

<p>
起動時にこれを有効 (または無効) にするには <tt>/etc/sysctl.conf</tt> を編集します。
使用したいものに応じて、net.inet.esp.enable および/または
net.inet.ah.enable の前の # を外し、それが 1 にセットされている
ことを確かめてくだ世気ぁ

腫ほとんどの場合、<i>rc.vpn</i> スクリプトや以下の例のように、
ESP だ世韻弋瓩気譴襪海箸肪躇佞靴討誓さい。このような場合、
<i>AH を有効にする必要はありません</i>。事際には使用しないのに、AH
を有効にすることに関して、セキュリティ上の懸念があるかも知れません。

<p>
次に、手動鍵の誓言成も必要になります。
VPN のセキュリティは、この鍵を推定するのが不可能という点世砲辰討い泙垢里如
この鍵を選ぶのには強力な乱数源を使用するということが大変重要なのです。
これを誓言成するのに実用誓發な，里劼箸弔箸靴董
釈鱚羹∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈鱇鈔闕逅雌繼闔輯⊂鱇鈔闕┫デバイスを使用する方法があります。たとえば、160 ビット (20 バイト) 分の乱数誓鮑鄒成するには、以下のようにします。

<blockquote><tt>
# <b>openssl rand 20 | hexdump -e '20/1 "%02x"'</b>
</tt></blockquote>

<p>
誓言成されるビット数は重要です。暗号の種類によって、必要な鍵のサイズは異なります。

<pre>
暗号方式    鍵長
DES       56 bits
3DES      168 bits
BLF       可変 (160 bits 推奨)
CAST      可変 (40-128 bits 推奨)
SKIPJACK  80 bits
</pre>

<p>
では、SA (Security Associations) の誓瀋蠅鬚靴泙靴腓Α
嚆笊鱸齠閭蛛闔ぢとは、IP アドレス、SPI、
セキュリティプロトコル (AH および/または ESP) の組み合わせです。IP アドレスは、あなた自身のものと、
送信誓茲里發里箸領省任后嗤繝蜚倚鱇辣侮粤ぢは各種 SA の分類に OpenBSD が使う番号のことです。

<p>
<i>これらの例は、トラフィックの暗号化に ESP しか使用しません。ESP は
暗号化された中身のデータの認証は行いますが、AH とは異なり、
それを包む IP ヘッダ世泙任惑Ь擇靴泙擦鵝海痢峺造蕕譴診Ь據廚任癲
ほとんどの場合にはまったく十分なものでしょう。特にトンネル環境での
ESP の場合にはそうです。</i>

<blockquote><tt>
# <b>ipsecadm new esp -spi SPI_OUT -src MY_EXTERNAL_IP -dst PEER_EXTERNAL_IP
-forcetunnel -enc blf -auth sha1 -key ENC_KEY -authkey AUTH_KEY</b>
</tt></blockquote>

<p>
これをふたつのルータ 192.168.5.1 と 192.168.25.9 に実際に誓瀋蠅靴討澆泙靴腓Α

腫ホスト 192.168.5.1 上では:

<blockquote><tt>
# <b>ipsecadm new esp -spi 1000 -src 192.168.5.1 -dst 192.168.25.9 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b><br>
# <b>ipsecadm new esp -spi 1001 -dst 192.168.5.1 -src 192.168.25.9 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b>
</tt></blockquote>

<p>
ホスト 192.168.25.9 上では:

<blockquote><tt>
# <b>ipsecadm new esp -spi 1001 -src 192.168.25.9 -dst 192.168.5.1 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b><br>
# <b>ipsecadm new esp -spi 1000 -dst 192.168.25.9 -src 192.168.5.1 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b>
</tt></blockquote>

<p>
SPI が異なっていることに注意してくだ世気ぁ嗤が何であり、それがどこで使用されるのかについての完全な誓睫誓は、<a href="#13.4">On the wire format</a> を参照してくだ世気ぁ

腫これで Security Associations が作誓気譴燭里如
フローを誓瀋蠅靴泙后

腫まずは 192.168.5.1 です。

<p>
さてここでいきなり、フローが<b>ふたつ</b>作誓気譴泙后劼箸弔魯蹇璽襪離宗璽好▲疋譽垢如
ローカルホストから出て目的地に向かうすべてのパケットをカバーし、
もうひとつのフローは送信誓茲薀蹇璽襯曠好箸北瓩辰討
フローです。

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 192.168.25.9 -spi 1000 -addr 192.168.5.1 255.255.255.255 192.168.25.9 255.255.255.255</b>
</tt></blockquote>

<p>
次は 192.168.25.9 側です。

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 192.168.5.1 -spi 1001 -addr 192.168.25.9 255.255.255.255 192.168.5.1 255.255.255.255</b>
</tt></blockquote>

<p>
もし、Host-to-Host VPN のオーバーヘッドを減らしたい場合には、SPI を作誓垢襪里
儒闥竇銕繻鹿を外しておくと、transport モードが使用できます (<tt>-forcetunnel</tt>
を使用すると IP ヘッダ世泙粘泙鵑誓 IP パケットのすべてが必ず SPI にカプセル化
されます)。もし、
発信元か送信誓茲里匹舛蕕優奪肇錙璽両豺腓砲蓮▲肇鵐優襯癲璽匹鮖藩僂垢襪靴△蠅泙擦鵝
ネットワークから出入りするトラフィックに SA を使用すると、自動的に
トンネルモードの SPI が確実に作誓気譴襪海箸砲覆蠅泙后

腫これは IPsec を使い始める簡単な方法です。

<p>
IPsec を使えば、プライベート IP アドレス空間をインターネット経由で誓楝害椎修任后
良い例を挙げましょう……  208.1.1.1 の背後にある 192.168.99.0/24 と、
208.2.2.2 の背後にある 208.1.5.0/24 と 208.1.2.0/24 とをトンネルで誓楝海垢襪箸靴泙后
以下の例は <a href="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.3">rc.vpn</a> スクリプトを使用して誓言成したものです。

<p>
ご覧のとおり、IPsec を手動鍵誓瀋蠅濃藩僂靴討い襪函
実行して欲しいことを<b>すべて誓騎里鹿眈指定しなければなりません。
あなたのかわりに見当をつけてくれたりはしないのです。以下の例を見てくだ世気ぁ


取仮屋軒窺窺の側では:</h2>
まず、security associations (SA) を誓瀋蠅靴泙后錫鮠
ぢこれで SPI、暗号化の方法と鍵が誓瀋蠅気譴泙ぢ。

<blockquote><tt>
# <b>ipsecadm new esp -src 208.1.1.1 -dst 208.2.2.2 -forcetunnel -spi 1001 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b><br>
# <b>ipsecadm new esp -src 208.2.2.2 -dst 208.1.1.1 -forcetunnel -spi 1000 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b><br>
</tt></blockquote>

<p>
次に、208.1.1.1 から 208.2.2.2 へのフローを誓瀋蝓

錫跫站髟阡緇儒
錫冗頌繝痲肚阯頏阡纉齡宛齔碓葦痲糅宛亀亀亀亀宛亀亀亀亀鹿眈錫鮠
鹿昭跫站髟阡緇

腫次に  208.2.2.2 の背後にある 208.1.2.0/24 から 192.168.99.0/24 へのフローを誓瀋蝓

錫跫站髟阡緇儒
錫冗頌繝痲肚阯頏阡纉齡宛齔碓葦痲糅慌狂庚乙貴乙貴乙貴屋軒窺荻乙貴乙貴乙貴絢昭碣鹿昭跫站髟阡緇

腫次に 208.2.2.2の背後にある 208.1.5.0/24 から 192.168.99.0/24 へのフローを誓瀋蝓

錫跫站髟阡緇儒
錫冗頌繝痲肚阯頏阡纉齡宛齔碓葦痲糅慌狂庚乙貴乙貴乙貴屋軒窺貴乙貴乙貴乙貴絢昭碣鹿昭跫站髟阡緇

腫そして、208.2.2.2 の背後にある 208.1.2.0/24 からルータ 208.1.1.1 へのフローを誓瀋蝓

錫跫站髟阡緇儒
錫冗頌繝痲肚阯頏阡纉齡宛齔碓葦痲糅宛亀亀亀亀宛亀亀亀鹿眈錫鮠
鹿昭跫站髟阡緇

腫そして、208.2.2.2の 背後の 208.1.5.0/24 からルータ 208.1.1.1 へのフローを誓瀋
錫跫站髟阡緇儒
錫冗頌繝痲肚阯頏阡纉齡宛齔碓葦痲糅宛亀亀亀亀宛亀亀亀鹿眈錫鮠
鹿昭跫站髟阡緇

腫最後に、ルータ 208.2.2.2 から 192.168.99.0/24 へのフローを誓瀋蠅靴泙后

錫跫站髟阡緇儒
錫冗頌繝痲肚阯頏阡纉齡宛齔碓葦痲糅慌狂庚乙貴乙貴乙貴屋軒荻荻乙貴乙貴乙貴乙擬昭碣鹿昭跫站髟阡緇


取仮屋軒荻荻側では:</h2>

<p>
前と同様に、まずは SA の誓瀋蠅蕕任后

錫跫站髟阡緇儒
錫冗頌繝痲鈬纉鱆宛糂屋軒窺窺闥竇銕繻齔碓旭緕碎鼈甕諷祁恐筝薫群亀箙郡蔚吾矜延卸贋呉繖眼矮崖挟癜諷況絏宴橋綉甦扱街籵温潟羃繙過翫橋宜羲昭碣錫冗頌繝痲鈬纉鱆宛糂屋軒荻荻闥竇銕繻齔碓葦緕碎鼈甕諷祁恐筝薫群亀箙郡蔚吾矜延卸贋呉繖眼矮崖挟癜諷況絏宴橋綉甦扱街籵温潟羃繙過翫橋宜羲昭碣鹿昭跫站髟阡緇

腫さて、こちらは裏返しになるので、
ルータ 208.2.2.2 から 208.1.1.1 へのフローを誓瀋蝓

錫跫站髟阡緇儒
錫冗頌繝痲肚阯頏阡纉齡宛齔碓旭痲糅宛亀亀亀亀宛亀亀亀亀鹿眈錫鮠
鹿昭跫站髟阡緇

腫屋軒窺窺の背後にあるネットワーク 192.168.99.0/24 から 208.1.2.0/24 へのフローを誓瀋蝓

錫跫站髟阡緇儒
錫冗頌繝痲肚阯頏阡纉齡宛齔碓旭痲糅宛亀亀亀慌狂庚乙貴乙貴乙貴絢昭碣鹿昭跫站髟阡緇

腫屋軒窺窺の背後にあるネットワーク 192.168.99.0/24 から 208.1.5.0/24 へのフローを誓瀋蝓

錫跫站髟阡緇儒
錫冗頌繝痲肚阯頏阡纉齡宛齔碓旭痲糅宛亀亀亀慌狂庚乙貴乙貴乙貴絢昭碣鹿昭跫站髟阡緇

腫では 208.1.1.1 の背後の 192.169.99.0/24 からルータ 208.2.2.2 へのフローを誓瀋蝓

錫跫站髟阡緇儒
錫冗頌繝痲肚阯頏阡纉齡宛齔碓旭痲糅宛亀亀亀亀慌狂庚乙貴乙貴乙貴絢昭碣鹿昭跫站髟阡緇

腫これでほぼ終了です。後は、
208.1.2.0/24 と 208.1.5.0/24 をルータ 208.2.2.2 から 208.1.1.1 まで届けるのに、
残りのフローはふたつだ世韻任后

錫跫站髟阡緇儒
錫冗頌繝痲肚阯頏阡纉齡宛齔碓旭痲糅宛亀亀亀宛亀亀亀亀蜴苒纉鷦昭碣錫冗頌繝痲肚阯頏阡纉齡宛齔碓旭痲糅宛亀亀亀宛亀亀亀亀蜴苒纉鷦昭碣鹿昭跫站髟阡緇

腫蜷黼竅粱ぢを使用していて、自分の行った作業をすべてご破算にして
一からやり直したければ、次のようにします。

<blockquote><tt>
# <b>ipsecadm flush</b>
</tt></blockquote>

<p>
これですべての IPsec 情報 (SPI、フロー、ルーティングのエントリ) がシステムから一掃されます。


<p>
<a name= "isakmpd"></a>
<h2>13.7 - isakmpd の誓瀋蠅鹿莢
腫嶄列ぢをはじめ IPsec の各種伝統的なアプリケーションを考えているのでしたら、
おそらく ISAKMP を使用することになります。IPsec の一部の商業実装では、
手動鍵誓瀋蠅鮖藩僂垢襪海箸任泙擦鵑里如
何らかの形の ISAKMP を使用するしかありません。


<p>
<h3>13.7.1 - isakmpd とは ?</h3>

<p>
ISAKMP とは Internet Security Association and Key Management Protocol のことです。
これは、IKE あるいはインターネット鍵交換 (Internet Key Exchange) と呼ばれることもあります。
これは、IPsec 用の標準鍵交換メカニズムです。これは、
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">RFC 2407</a>、
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC 2408,</a>
ならびに
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">RFC 2409</a>
に記述された手法を使用して、セキュリティの問題をクリアしています。
ISAKMP は、通常なら
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&amp;sektion=8">ipsecadm(8)</a>
を使用しなくてはならないような暗号鍵のやり取りを管理してくれます。
これは、ふたつの IPsec ノード間で IPsec パラメータを確立するために、
二段階プロセスを採用しています。

<p>
<b>フェーズ 1</b> - ISAKMP ピアふたつは、保護され認証されたチャネルを確立し、
ふたつのデーモン間で通信ができるようにします。これは
両ホスト間で Security Association (SA) を確立します。このチャネルを確立するための手法には、
<b>Main Mode</b> と <b>Aggressive Mode</b> とがあります。
Main Mode は各種認証情報を
特定の順番で送り、アイデンティティの保護を提供します。また、Aggressive Mode は
アイデンティティ保護は提供しません。これは、認証情報を
すべて一気に送信するためですが、この Aggressive mode を使用するのは、
盗聴者に対して識別情報を暴露することになってしまうことがありますので、
ネットワークの帯域幅が狭いときだ世韻砲靴燭曚Δ匹い任靴腓Α

腫錫ぢフェーズ 2</b> - IPsec のために Security Associations のネゴシエーションが行われます。
フェーズ 2 では、IPsec ホスト間にトンネルか endpoint SA を確立します。また、
フェーズ 2 では <b>Quick Mode</b> が使用されます。これは、フェーズ 1 で
既に SA が確立していますので、完全な認証をくり返さなくても良いからなのです。

<p>
手短にいえば、フェーズ 1 は保護されたチャネルを確保するのに使用され、そこで
(より素早い) フェーズ 2 の誓瀋蠅圓錣譴襪里任后Ｆ韻献侫А璽ぢチャネルの中で、
複数のフェーズ 2 誓瀋蠅鬚垢襪海箸發△蠅泙后修靴董△海離侫А璽ぢは、実際の
トンネルを誓瀋蠅垢襪里忙藩僂気譴泙后
フェーズ 1 では IPsec ノード同士が誓楝海魍領靴毒Ь擇鮓魎垢靴泙悽軌証明世
事前に共有した秘密鍵のいずれか)。これで両端とも、相手が認証されたことを
確認できます。フェーズ 2 は鍵の交換で、両者の間のデータが
どのように暗号化されるかを決定します。

<h3>13.7.2 - isakmpd ことはじめ</h3>

<p>
デフォルトで OpenBSD には、ISAKMP と IPsec スタック用として必要となる
すべてのバイナリが附属しています。サンプルの誓瀋螢侫．ぅ襪
儒齟葹鱚頌繝黶謐鞣鹿にあります。
この例で使用するのに、<i>policy</i> を
<tt>/etc/isakmpd/isakmpd.policy</tt> をコピーし、<i>VPN-east.conf</i> を
<tt>/etc/isakmpd/isakmpd.conf</tt> にコピーしてくだ世気ぁ
ここでは、VPN (トンネル) の誓瀋蠅了妬鮴説明世靴泙后
蜩瘠逅を個別ホスト間で使用する場合には、<i>samples</i> ディレクトリにそのためのサンプルが
入っています。man ページに詳しい情報がありますので、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&amp;sektion=5">isakmpd.conf(5)</a> と
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&amp;sektion=5">isakmpd.policy(5)</a>
も忘れずに参照してくだ世気ぁ

腫デフォルトではカーネルで AH と ESP の両方が有効になっているのですが、
FAQ セクションの <a href="#ManKey">Manual Keying</a> の概要にある手続きによって、
必要とするプロトコルが有効化されていることを確認しておいてくだ世気ぁ
次に、<tt>/etc/isakmpd/isakmpd.policy</tt> を編集してくだ世気ぁ
このファイルは ISAKMP に、誰が IPsec にアクセスできるのかを教えるためのものです。このシナリオでは、
この policy ファイルは、Encapsulating Security Payload (ESP) を使用してデータを送信してきて、
<i>mekmitasdigoat</i> というパスワード (これはあなたが自由に決めてくだ世気で認証された相手なら、
誰でも isakmpd と通信できることが記述されています。特定のデジタル証明製颪能靆召気譴織如璽燭誓けを認めたり、
特定の暗号変換を使用したデータだ世韻鯒Г瓩燭蠅垢襪海箸髻瓶阻熔ぢに伝えるため、このファイルを変更することが
できます。また、誰もが IPsec を使用できるようにすることもできます。もちろん、これはテストのためだ世韻
すべきですが、もし、そのようにしたい場合には、policy ファイルを編集して以下の記述だ世韻砲靴泙后

錫跫站髟阡緇腫鱚妹阡絖帙鴦蜿邵
装闥蝴纈佻棉遅
鹿頏緇鹿碎閭鞫
腫同じ policy ファイルには $ のついた行が二行あります。使用する前に、
これらの二行は削除する必要があります。これらの行は、CVS が使用していたものです。

<p>
より便利な policy ファイルは以下の例のようなものでしょう。

<blockquote><pre>
KeyNote-Version: 2
Comment: この policy は誓気靴ぅ僖好錙璽匹鮖箸Ε螢癲璽箸蕕嗤を受け付ける
Authorizer: &quot;POLICY&quot;
Licensees: &quot;passphrase:mekmitasdigoat&quot;
Conditions: app_domain == &quot;IPsec policy&quot; &amp;&amp;
            esp_present == &quot;yes&quot; -&gt; &quot;true&quot;; 
</pre></blockquote>

<p>
これを実装することにより、ESP だ世韻鮖藩僂靴心靄榲侘トンネル) を作誓垢襪海箸任泙后
ホスト A では <tt>/etc/isakmpd/isakmpd.conf</tt> を編集します。見本に入っている 249.2.2.2 という IP アドレスは、
ホスト A の実際の外部 IP アドレスに書き換えてくだ世気ぁ

錫跫站髟阡緇腫鱚枅緕纈瘡
吶瘤鼾蜚鷭		祷竏瘤艱癢蜊綵	渦也齡緕扈		牡庚荻荻鹿頏緇鹿碎閭鞫
腫同様にして、ホスト B の isakmpd.conf にも誓瀋蠅靴泙后海海如牡庚凱凱は
ホスト B の外部 IP アドレスです。

<blockquote><pre>
[General]
Retransmits=		5
Exchange-max-time=	120
Listen-on=		249.3.3.3
</pre></blockquote>

<p>
ここで isakmpd の主な挙動を決定する変数を誓瀋蠅任襦海海任
デフォルトを使用すれば良いでしょう。
<b>Listen-on</b>= value は、isakmpd がリスンすべき IP アドレス
を指定します。あなたのゲートウェイのインターネット IP だ世韻廚箸覆蠅泙后
ゲートウェイに複数の外部インターフェイスがある場合には、
カンマで区誓擇辰唇賤措阿覇呂靴董△匹離ぅ鵐拭璽侫Дぅ垢鬟螢好鵑垢戮魄賤砲任泙后

腫次にホスト A で、もう一度 isakmpd.conf を編集します。

<blockquote><pre>
[Phase 1]
249.3.3.3=		HostB
</pre></blockquote>

<p>
ホスト B では以下のようになります。

<blockquote><pre>
[Phase 1]
249.2.2.2=		HostA
</pre></blockquote>

<p>
この部分は、フェーズ 1 誓楝海離優乾轡─璽轡腑鵑虜櫃房栄佞韻襪戮アドレスを記述します。
ここでの値は下の部分を指しています (フェーズ 1 は単にリモートのピアを認証して、
それが主張通りの相手だ世罰稜Г垢襪誓けであることに注意してくだ世気ぢ。また、
IP_Address=<i> &lt;PEER-NAME&gt;</i> という形式で複数のピアを記述することができます。

<p>
次にホスト A では:

<blockquote><pre>
[Phase 2]
Connections=		HostA-HostB
</pre></blockquote>

<p>
ホスト B では:

<blockquote><pre>
[Phase 2]
Connections=		HostB-HostA
</pre></blockquote>

<p>
これは誓楝海離侫А璽ぢを記述しています。このフェーズは、通信に両
ピアが使うプロトコルを決定するためのものです。

<p>
<b>Connections</b>= タグは、その下のセクションを指します。
フェーズ 2 を誓瀋蠅垢襪燭瓩房影譴蕕譴襯瓮愁奪匹簍弖錣魍呂靴泙后海譴呂泙拭
いったん開始したらどの誓楝海魍呂垢戮砲弔い啻僕伉ぢに示しています。
複数のピアホストに誓楝海垢訃豺腓砲蓮
以下のように複数のセクションを記述可能であることに注意してくだ世気ぁ

腫リモートホストの IP アドレスがわからない場合には、<b>Connections</b>= タグに
列挙されていない IP からの誓楝海濃仮箸気譴詒突僖┘鵐肇蠅髻△△襯札轡腑鵑傍劼靴討い董
それを Default= で指定するようにします。

<p>
ホスト A では:

<blockquote><pre>
[HostB]
Phase=			1
Transport=		udp
Local-address=		249.2.2.2
Address=		249.3.3.3
Configuration=		Default-main-mode
Authentication=		mekmitasdigoat
#Flags=
</pre></blockquote>

<p>
ホスト B では:

<blockquote><pre>
[HostA]
Phase=			1
Transport=		udp
Local-address=		249.3.3.3
Address=		249.2.2.2
Configuration=		Default-main-mode
Authentication=		mekmitasdigoat
#Flags=
</pre></blockquote>

<p>
これらは上で誓睫誓したフェーズ 1 の部分で参照されているセクションです。それぞれ
フェーズ 2 に進むためにピアのゲートウェイが満足しなければならない要件を記述しています。他にもオプションは
多数ありますが、上記のものは最低限必要なものです。

<ul>
<li><b>Phase=1 </b>が必要なのは、ISAKMPD のコードがフェーズ 1 とフェーズ 2 を処理するのに
同じプロシージャを使うからで、これを <b>1</b> にしなければ、何ひとつ機能しなくなります。
<li><b>Transport= </b> は、ピアごとに異なる可能誓△蠅泙后海海任槻ぢを使用することになっていますので、
そのままにしておきます。一部のピアはファイアーウォールの背後にあり、UDP トラフィックを通さない場合が
あることに注意してくだ世気ぁＥ海任垢△海譴論設定前に確認しておく必要があります。
<li><b>Local-address </b>は入ってくるパケットが指す目的アドレスです。一部のケースでは、
フェーズ 1 の誓楝海里燭瓩縫螢好鵑垢襯ぅ鵐拭璽侫Дぅ垢曚覆辰討い襪眞里譴泙擦鵝
この例では、インターフェイスはひとつしかありませんので、このピアでリスンする
インターフェイスの IP がそれになります。
<li><b>Address= </b>は、入ってくるパケットのソース IP です。これはピアゲートウェイを
指すのが一般的です。この部分はより詳しい誓睫誓が必要です。
これは、ピアの発信する IP アドレスは事前にはわからないことがあるからです。
<li><b>Configuration= </b> は、下のセクションを指します。ここに示したような形で
複数のセクションを指定できます。ここではサンプルファイルにあった
デフォルト値を使用します。
<li><b>Authentication=</b> は、このピアが使用するはずの事前に共有している秘密鍵です。
このパスワードが policy に渡され、このピアがこのホストと IPsec を使用して良いかどうかを確認します。
このパスワードを変える場合には、policy ファイルでの記述も変える必要があります。
これは、sample ファイルがこのパスワードに応じて提供されているからです。
最低限の policy ファイルを使用するつもりでしたら、ここでは好きなものを指定してくだ世気ぁ
殊蘊錫焼赱苴充は現在では使用されていません。
RFC では、フェーズ 1 用の追加オプションを指定するための予備としてこれを残しています。
<p>他のオプションを指定するためのタグも多数あります。詳しくは
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&amp;sektion=5">isakmpd.conf(5)</a>
を参照してくだ世気ぁ
鹿
腫ホスト A では:

<blockquote><pre>
[HostA-HostB]
Phase=			2
ISAKMP-peer=		HostB
Configuration=		Default-quick-mode
Local-ID=		Net-A
Remote-ID=		Net-B
</pre></blockquote>

<p>
ホスト B では:

<blockquote><pre>
[HostB-HostA]
Phase=			2
ISAKMP-peer=		HostA
Configuration=		Default-quick-mode
Local-ID=		Net-B
Remote-ID=		Net-A
</pre></blockquote>

<p>
これらは、上記のフェーズ 2 で参照されているセクションを表しています。これは
個別の誓楝海里燭瓩法△佞燭弔離押璽肇ΕДご屬馬辰鬚垢襪里啻僕伉ぢが使用すべき
個別誓瀋蠅覆里任后

受貍
殊蘊錫笑葹黼讐鹿眈ぢは必須です。ISAKMPD のコードは、フェーズ 1 と
フェーズ 2 の認証に同じ関数を使うからです。これがない場合には VPN は機能しません。
<li><b>ISAKMPD-Peer=</b> は、上でのホストのセクションの名前です。つまり、フェーズ 2 誓楝海魍領垢襪燭瓩法
ここで指定したピアと話している、という意味です。これがあるのは、isakmp ピアや誓楝海魑劼垢襪里
複数のセクションがある場合もあるからなのです。
<li><b>Configuration=</b> は、下のセクションで、このホストと誓楝海砲韻觧慊蠅離團△箸
従うべき規格を記述した部分を指します。
<li><b>Local-ID=</b> は、ピアのゲートウェイへのこのプライベートネットワークを
記述した、以下の IPsec-ID セクションを指しています。この部分が送られることで、対向側のゲートウェイが VPN 経由で
こちらのネットワークにデータを転送するためのルーティングテーブルを誓気靴設定できるようになります。
<li><b>Remote-ID=</b> は、こちらのホストの対向のリモートのプライベートネットワークであるはずのものを記述した、
下の IPsec-ID セクションを参照しています。こちらのプライベートネットワークから VPN 経由でリモートのプライベート
ネットワークにデータを転送するためのルーティングテーブルを誓気靴設定するためにこの部分が解釈されます。
<p>ここでサポートされるもうひとつのタグが Flags= です。このタグが必要な場合には、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&amp;sektion=5">isakmpd.conf(5)</a> を参照してくだ世気ぁ
鹿
腫ここは IPsec-ID セクションです。以下のエントリは、ホスト A とホスト B の
両方の isakmpd.conf ファイルの中に存在していなければなりません。この例の場合、
ホスト A (これは上の Net-A に誓楝海気譴討い襪發里任では 192.168.1.0/255.255.255.0、
ホスト B (これは上の Net-B に誓楝海気譴討い襪里里任では 192.168.20.0/255.255.255.0 となります。

<blockquote><pre>
[Net-A]
ID-type=		IPV4_ADDR_SUBNET
Network=		192.168.1.0
Netmask=		255.255.255.0

[Net-B]
ID-type=		IPV4_ADDR_SUBNET
Network=		192.168.20.0
Netmask=		255.255.255.0
</pre></blockquote>

<p>
このふたつのセクションが各ホストの <b>conf</b> ファイルに含まれています。これが <b>Local-ID</b> と <b>Remote-ID</b>
の識別しで参照されるセクションです。ひとつのプライベートネットワークから、別のプライベートネットワークへの
トラフィックを可能にする際に誓瀋蠅気譴襪戮佻劼気譴討い泙后錫症牒鞳鹿眈は <b>IPV4_ADDR_SUBNET</b> か
<b>IPV4_ADDR</b> を記述できます (RFC2708 には他にも有効な値が記述されています。OpenBSD の現状の実装では IPv4 しかサポートされていませんが、IPv6 は OpenBSD-current でサポートされているかも知れません)。
 
<p>
これで両方のホストで、sample ファイルは以下の例のようになったはずです。

<blockquote><pre>
[Default-main-mode]
DOI=			IPSEC
EXCHANGE_TYPE=		ID_PROT
Transforms=		3DES-SHA
</pre></blockquote>

<p>
このセクションは、フェーズ 1 誓楝海濃藩僂気譴覦店翳阿陵弖錣魑劼靴討い泙后Ｌ樵阿
守消闔肅苺鱇闔充変数のとる値を反映しています。ご覧のとおり、Domain of Interest (DOI) を
IPSEC として記述しています。<b>EXCHANGE_TYPE</b> 変数は、フェーズ 1 では <b>ID_PROT</b> に誓瀋蠅靴討蝓
これはこの認証でカバーされるプロトコルを指定しているものです。
<b>Transforms=</b> はこのやり取りで必要とされる (または指定される) 暗号変換方式です。この例では、
これは誓瀋螢侫．ぅ襪硫爾離札轡腑鵑鮖悗靴討い董△修海任蓮△錣譴錣譴津で暗号化され、
SHA で確認できるチェックサムを持つパケットを受け取る、と記述されています。サンプルの <b>VPN-east.conf</b> には、
各種変換方式が多数記述されています。なぜなら、3DES や SHA は各種のプラットホームで必ずしもサポートされいる
とは限らないからです。OpenBSD の場合、これを基本的な誓瀋蠅琶僂┐襪戮海脇辰砲△蠅泙擦鵝海離札轡腑鵑
コピーして変換方式を変えるのは、自由です。唯一、必要になるのは、Configuration= 変数も変えることだ世韻任后

錫跫站髟阡緇腫鱚枋繙癜踉站閼縹
掴表			賓單努暖僧播灣捐貼		冲秒盆溶津
囎蜚纉		冤嗤津哭喩銑估哭嗾不適冤嗤途諜酉嬋堙
鹿頏緇鹿碎閭鞫
腫このセクションは、VPN 経由で転送れるデータの暗号の要件を記述するところで、
上の <i>Configuration</i> で参照される部分です。このセクションと、
すぐ上のフェーズ 1 のこの部分に相当する部分との違いは、 <b>EXCHANGE_TYPE</b> が <b>QUICK_MODE</b>に
なっているということに注目してくだ世気ぁ侫А璽ぢでは必ずこのようになるのです。
また、<b>Suites=</b> は IPsec Suite セクションを指しています。
両ホスト間で提供されている各種の暗号方式を記述したものです。
ISAKMP と IPsec については、他にも誓睫誓すべきことが多数あります。ここまでの基本的な誓睫誓をもとに、
自立して誓瀋蠅靴討癲噂磴覆蕕盞瓦侘ぢを構誓任泙后
しかし、これは、両ホストにとって<i>必要最低最小限の</i> 
<b>isakmpd.conf</b> でしかありません。
a31 419
<h3>13.7.3 - isakmpdの起動</h3>

<p>
最初にこのデーモンを実行する場合には、以下のコマンドを使用します。

<blockquote><tt>
# <b>isakmpd -d -DA=90</b>
</tt></blockquote>

<p>
デーモンはデーモンモードでは実行されず、通常の (フォアグラウンド)
プロセスとして実行されます。そして、すべてをターミナルに出力します。
isakmpd を止めて経路を一掃するには、各ノードで isakmpd プロセスを
kill してから <b>ipsecadm flush</b>
を実行します。


<p>
<a name= "x509"></a>
<h2>13.8 - isakmpd を X.509 証明製颪隼藩僂垢襪砲鹿莢
腫事前に共有した鍵のかわりに証明製颪鮖藩僂垢襪茲Δ黶謐鞣ぢを誓瀋蠅垢襪里蓮
保護されていないピアが多く存在する巨大ネットワークの場合には、
小さなネットワークと比較してそれほど難しいことではありません。
むしろ、誓瀋蠅蔽韻砲覆襪眞里譴泙擦鵑掘△気蕕暴斗廚覆海箸箸靴董
鍵管理が非常に柔斉陲砲覆蠅泙后


取仮証明製颪寮生誓鹿莢
腫鍵や証明製颪寮生誓了妬砲弔い董蜩瘠逅ソースディレクトリの
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/README.PKI?rev=1.7">README.PKI</a>
ファイルに詳しく記述されています。
CA 鍵、対応する CA X.509
証明製顱▲優奪肇錙璽紊黶謐鞣ぢを使うコンピュータそれぞれに秘密鍵ひとつと、その秘密鍵のそれぞれに対して X.509
証明製颪劼箸弔困弔廚箸覆蠅泙后

腫蜩瘠逅で使用できるものにするために、X.509 証明製颪蓮⊂斂誓書の持ち主を記述する
Subject Alternative Name (subjectAltName) 拡張が追加される必要があります。
この拡張は証明製颪了措腓凌噺気魑劼垢襪發里任△蝓
これは、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=certpatch&amp;sektion=8">certpatch(8)</a>
か、または、
<tt>/etc/ssl/x509v3.cnf</tt>
のような、OpenSSL の特別な誓瀋螢侫．ぅ襪鮖藩僂靴督媛辰気譴襪眞里譴覆い發里任后
釈鱚羹∵雕關緕碵筮闥膀竍薛砠遲笆齬繧鱆砠遲蜩瘠逅箝凖祖妖防崇纐襲⊂凖祖妖防鹿畩
の例は、subjectAltName 識別子として IP アドレスを使用するこの手順について誓睫誓しています。

<p>
IP アドレスは subjectAltName 拡張のデフォルトのメカニズムですが、
certpatch は、FQDN (Fully Qualified Domain Name) か、または
UFQDN (User FQDN) を使用する方法もサポートしています。
これは、モバイルユーザには大変便利なものでしょう。FQDN の例は、
<tt>www.openbsd.org</tt> です。また、UFQDN の例としては、
<tt>Jorgen.Granstam@@abc.se</tt> のような電子メールアドレスかも知れません。
これは、IP ベースの識別子とは異なるものとして注意すべきものであり、
isakmpd は FQDN あるいは UFQDN ベースの識別方法によるデータの検証を
行わず、識別子は単なる文字列と見なされます。

<p>
以下の例では subjectAltNames として FQDN を使用しています。

<p>
FQDN subjectAltName を証明製颪貌譴襪砲蓮
以下の例のように記述します。

<blockquote><tt>
$ <b>/usr/sbin/certpatch -t fqdn -i home.mysite.se -k ca.key originalcert.crt newcert.crt</b>
</tt></blockquote>

<p>
ここで、ca.key は CA の秘密鍵ですので、これを実行できるのは
CA 秘密鍵にアクセスできる人だ世韻箸いΔ海箸砲覆蠅泙后
蓖辣蜚絎黼ぢというのは (実在しませんが) 証明製颪冒淨気譴襪戮冂です。
originalcert.crt と newcert.crt のファイル名は同じ名前にしても良いでしょう。
この場合、元のファイルは新しい変更済みの証明製颪
上書きされることになります。

<p>
この鍵と証明製颪髻凖祖妖防ぢの最後に誓睫誓に従ってディレクトリに置きます。
もし、本当に鍵を使用するつもりでしたら、CA 鍵 (ca.key) は、
どこか安全なところに保管するようにしてくだ世気ぁ
腫儒痰跂儒鮠儒箴儒黶謐鞣畆鹿儒箴信頼された CA の公開鍵 (PEM フォーマット) 証明製鹿昭鮠
儒鮠儒箴儒黶謐鞣纈鹿昭箴
儒箴信頼された公開鍵 (PEM フォーマット) 証明製齦礪繝踉令辣ぢ拡張あり)</td></tr>
<tr><td><tt>/etc/isakmpd/private</tt></td>
<td>秘密鍵。これらは上記の <tt>cert</tt> ディレクトリ中の
関係する公開鍵を持つべきです。</td></tr>
</table>

<p>
これらの位置は、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&amp;sektion=5">isakmpd.conf(5)</a>
の中の [X509-certificates] セクションの値によってオーバーライドされるかも知れません。

<p>
CA のインフラストラクチャーを信頼すべきものにするためには、CA の秘密鍵
(<tt>/etc/isakmpd/ca/ca.key</tt>) は安全な場所に保管されなければならず、
そして、(たとえば 2048 ビットのような) 適誓気淵咼奪板垢任△襪戮任△蝓
協力なパスフレーズで暗号化されるべきである、ということに注意してくだ世気ぁ


取仮蜩瘠逅の誓瀋鹿莢
腫儒黶謐鞣黶謐鞣闔羲ぢ誓瀋螢侫．ぅ襪鮓討澆泙靴腓Α
これはもともと
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&amp;sektion=5">isakmpd.conf(5)</a>
のサンプルファイルから取ってきたものですが、かなり変更されています。
さらに、この誓瀋蠅陵鬚鬚茲蟯蔽韻砲垢襪燭瓩法轣ページにある
ものよりもかなり短いファイルを使用しています。そして、コメントも追加して
 (一部のコメントは isakmpd.conf(5)にあったものです)、名前も少し変更しました。
ここで使用したドメイン名は、私たちの知る限りではひとつも実在していません。

<p>
実際には、ここを読む人は既に事前共有鍵について実際に動く誓瀋蠅
持っているはずですので (前の誓瓩鮖仮ぢ、このファイルには目新しいところは
あまりないことでしょう。ですので、すべてを詳細に誓睫誓するのは控えます。
誓睫誓しない部分については isakmpd.conf(5) を
参照してくだ世気ぁ

腫全体の構誓楼焚爾里茲Δ覆發里魏渉蠅靴泙后

腫若緕鮠
腫鱚闔絎逋皷鈬闥謫蜚絎黼
慌狂握握握噂十蒐十十十碓厩荻蔚軒荻
逋皷范闥謫蜚絎黼
慌狂慌狂
鎬逋皷闥謫蜚絎黼
慌狂厩荻蔚軒荻鹿頏緇
鹿竇銓纈
腫これはつまり、ふたつのネットワークが、保護されていないネットワーク上の IPsec トンネル
経由で誓楝海気譴討い襦△箸いΔ發里任后海海任魯廛薀ぅ戞璽肇ぅ鵐拭璽優奪藩僂僕縮鵑気譴
賓ぢアドレス (RFC1918) を使用していることは無視してくだ世気ぁ海譴話韻法燭鮖藩僂垢
必要があったというだ世韻里海箸誓ったのです。isakmpd を NAT と組み合わせて使用するなどの
ことに関しては誓睫誓しないつもりです (私自身に経験がないからです)。

<p>
では、誓瀋螢侫．ぅ襪鮓討澆泙靴腓Α０焚爾蓮
セキュリティゲートウェイ gw.mysite.se 用のファイルです。

<blockquote><pre>

# *****************************************************************
# ************* Start of the gw.mysite.se isakmpd.conf ************
# *****************************************************************

# A configuration sample for the isakmpd ISAKMP/Oakley (aka IKE) daemon.
[General]
Policy-File=            /etc/isakmpd/policy
Retransmits=            5
Exchange-max-time=      120
Listen-on=              10.0.0.1


# The name work-gw here is used just as a section name and a tag for
# use in this configuration file below and need not actually be the 
# real hostname or domain name of the peer (but it could be). The IP 
# address however needs to be correct. Phase 1, as you might already
# know, is to negotiate an ISAKMP security association (SA). There 
# should of course be one IP and name for each peer we want to
# communicate with.
[Phase 1]
10.0.0.2=               work-gw


# Now phase 2 is negotiating IPsec SAs. As in phase 1, the name here
# is a section name to be used later. Actually, it can be a comma
# separated list of section names here. Thus if traffic from many
# networks (or individual hosts) should be forwarded through this
# tunnel, more section names would be added (and of course corresponding 
# new sections further down). 
[Phase 2]
Connections=            work-gw-my-gw


# Now, here are some parameters for the ISAKMP SA negotiations. Almost 
# self documenting. The section name is from [Phase 1] above. The most 
# interesting tag might be the ID tag. The ID tag is set to the name
# of the section where the identity information about this host that 
# will be presented to connecting peers, can be found. If the ID tag 
# is not available, isakmpd will assume that it will identify itself 
# using the IP address. You might also notice that there is no longer 
# any authentication tag here in this configuration. The authentication
# data is currently used only in the preshared key case. 
[work-gw]
Phase=                  1
Transport=              udp
Local-address=          10.0.0.1                # Local address
Address=                10.0.0.2                # Peer address
ID=                     my-ID
Configuration=          Default-main-mode


# This is the identity data. ID-type may also be IPV4_ADDR (the
# default), IPV4_ADDR_SUBNET or UFQDN. The Name tag is used for 
# FQDN and UFQDN, for IPV4_ADDR an Address tag would be used instead.
# For IPV4_ADDR_SUBNET a Network and a Netmask tag would be used.  
[my-ID]
ID-type=                FQDN
Name=                   gw.mysite.se


# This is the section for the IPsec connection. The section name is
# from the list in the [Phase 2] section above. The ISAKMP-peer is,
# of course, the tag of our peer from section [Phase 1] above. The 
# Local-ID and Remote-ID tags should be section names describing which
# packages should be forwarded over the IPsec tunnel to the remote 
# network.
[work-gw-my-gw]
Phase=                  2
ISAKMP-peer=            work-gw
Configuration=          Default-quick-mode
Local-ID=               Net-west
Remote-ID=              Net-east

# Any packet originating from a computer on the network described
# here... 
[Net-west]
ID-type=                IPV4_ADDR_SUBNET
Network=                192.168.1.0
Netmask=                255.255.255.0

# ... and with a destination matching the network described here, 
# will be encrypted and forwarded over the IPsec tunnel to the remote 
# system. 
[Net-east]
ID-type=                IPV4_ADDR_SUBNET
Network=                192.168.2.0
Netmask=                255.255.255.0

# Main mode descriptions


# Here are the data for main mode. Using DES here for real purposes
# is not very smart since DES is no longer considered a secure
# encryption algorithm. 3DES is generally considered to have much better
# security since it has enough bits in the key to be considered secure. 
# Transforms is a list of tags describing main mode transforms. In 
# this example we have only one.
[Default-main-mode]
DOI=                    IPSEC
EXCHANGE_TYPE=          ID_PROT
Transforms=             3DES-MD5


# Certificates stored in PEM format
# This is important when using certificates. The CA certificates should 
# be in the CA-directory (but not the CA private key of course).
# The Cert-directory should have at least the certificate for the
# local host but other certificates are also allowed. The private key 
# should be the private key of the local host. 
[X509-certificates]
CA-directory=           /etc/isakmpd/ca/
Cert-directory=         /etc/isakmpd/certs/
Private-key=            /etc/isakmpd/private/local.key

# Main mode transforms
######################

# Here is our main mode transform. The important thing here is to use
# RSA_SIG as authentication method when using certificates. It is the
# only method supported when using certificates so far. Commercial
# entities in the US will thus have to wait until September 2000 to
# use this due to the RSA patent. Luckily, I am not living in the US. 
# Also important is the GROUP_DESCRIPTION tag. It must match the
# GROUP_DESCRIPTION tag in the Quick mode transforms further down. 
# The Life tag here could possibly be modified. The LIFE_60_SECS might 
# be shorter than necessary for normal use. 

[3DES-MD5]
ENCRYPTION_ALGORITHM=   3DES_CBC
HASH_ALGORITHM=         MD5
AUTHENTICATION_METHOD=  RSA_SIG
GROUP_DESCRIPTION=      MODP_1024
Life=                   LIFE_60_SECS,LIFE_1000_KB

# Quick mode description
########################

[Default-quick-mode]
DOI=                    IPSEC
EXCHANGE_TYPE=          QUICK_MODE
Suites=                 QM-ESP-3DES-MD5-PFS-SUITE

# Quick mode protection suites
##############################
# 3DES

[QM-ESP-3DES-MD5-PFS-SUITE]
Protocols=              QM-ESP-3DES-MD5-PFS

# 3DES

[QM-ESP-3DES-MD5-PFS]
PROTOCOL_ID=            IPSEC_ESP
Transforms=             QM-ESP-3DES-MD5-PFS-XF

# Quick mode transforms

# Don't forget. The GROUP_DESCRIPTION must match the GROUP_DESCRIPTION 
# in main mode above. For forwarding packets between two networks (or
# from a host to a network) we use TUNNEL mode. Between two hosts we
# may also use TRANSPORT mode instead. 
[QM-ESP-3DES-MD5-PFS-XF]
TRANSFORM_ID=           3DES
ENCAPSULATION_MODE=     TUNNEL
AUTHENTICATION_ALGORITHM=       HMAC_MD5
GROUP_DESCRIPTION=      MODP_1024
Life=                   LIFE_60_SECS


# As we know from the isakmpd.config manpage the LIFE_DURATION here is 
# an offer value (60), a minimum acceptable value (45) and a maximum
# acceptable value. The isakmpd.conf example has this set to 
# 600,450/720 instead. That might be a better value for normal use.
[LIFE_60_SECS]
LIFE_TYPE=              SECONDS
LIFE_DURATION=          60,45:72

[LIFE_1000_KB]
LIFE_TYPE=              KILOBYTES
LIFE_DURATION=          1000,768:1536

# *****************************************************************
# ************* End of the gw.mysite.se isakmpd.conf **************
# *****************************************************************
</pre></blockquote>

<p>
ここまではローカルシステム用の誓瀋蠅砲覆蠅泙后螢癲璽肇轡好謄爐寮設定も
まったく同じですが、この裏返しになります。ですから、異なるのは isakmpd.conf
ファイルの冒頭のところだ世韻箸いΔ海箸砲覆蠅泙后札絅螢謄押璽肇ΕД
范闥謫蜚絎黼ぢの isakmpd.conf ファイルの冒頭のところだ世姥討澆泙靴腓Α

錫跫站髟阡緇腫鱚囈癇閹蒹鳬皷蜩瘠逅筮竢鈕
枅緕纈瘡倆跚笙蛹綵黶謐鞣黶謐鞣闌蜒吶瘤鼾蜚鷭祷竏瘤艱癢蜊綵渦也齡緕扈碓

柞葹黼碓逋
柞葹黼衷銕繝闔鷭鳬逋
檮范俶癈綵夸瘤齔闥弥竅讚痲糅纉鷭碓弥竅痲糅纉槍糅纉鷭碓倥纈粐鱚齠
苗鳬衷鈕蜃癆蜿扈偵聲轣蜴閼
棊闥覘苗苗綵苫栂
令辣范闥謫蜚絎黼

棊闥覘范范俶癈綵瓶阻熔繞鮟逋衷鈕蜃癆蜿扈偵聲髟蜒覘迴粤
弥竅讚苗励縺齡
吶迴捗励齡

矼闔銛繖鹿頏緇鹿碎閭鞫
腫あまり難しくはないと思います。ただ世掘匹爐里肋径犇誓ったかも知れませんね。
次の部分は、もう少しおもしろくなるはずです。


<h2>policy ファイル</h2>

<p>
実のところ、policy ファイルは初めての人には少々難解なものかも知れません。
特に思いどおりに動かないときにはそうだ世隼廚い泙后轣ページ
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&amp;sektion=5">isakmpd.policy(5)</a>
は、実はそれほど悪くはないと思います。ところどころ
はっきりしないところがあるにはあるのですが、全体としては良く記述されています。

<p>
最も簡単な、誓犠錣傍’修垢闌蜒ファイルは
たった一行だ世韻里發里任后

錫跫站髟阡緇腫鱚癜闥蝴纈佻棉遅
鹿頏緇鹿碎閭鞫
腫これはつまり、誰が誓楝害椎修箸いΔ海箸砲弔い討離櫂螢掘湿紊寮制約が何もない、
ということなのです。ですから、決してセキュリティの高い誓瀋蠅任呂△蠅泙擦鵝
この authorizer タグは、policy を決定する権限を持つユーザです。
特別 authorizer である &quot;POLICY&quot; は、policy についての
最終的かつ無限の権限を持ちます。それ以外の authorizer については、
ここで権限を持つためには、まず &quot;POLICY&quot; の認定を受ける必要があります。
a33 675
さらに何が許されるかについて、条件群があるかも知れません。
ですから、以下の policy は本物の暗号を何か使用して ESP
プロトコルを使用したユーザだ世韻蠅気譴襪箸いΔ海箸覆里任本物とは言世─
これですと DES を使用するユーザも認められますが、DES は
現在ではほとんどダ瀬瓩覆發里塙佑┐椴匹い蕕い里發里覆里如津を認めないよう、
この policy を変更するのは、読者の練習問題として残しておくことにしましょう)。
これですと ESP で暗号化するユーザなら、誰でも認められることに注意してくだ世気ぁ

錫跫站髟阡緇腫鱚癜闥蝴纈佻棉遅
竢鈔蜚蜿銖瘰鞏粹轣蜴賓黼竟跚笙瘢雹逅纉鞏頏纉緕十髟阡児纉瘢雹逅纉鞏緕窰瘡―髟阡試讀髟阡苳
鹿頏緇鹿碎閭鞫
腫さらに、権限を誰か他の存在 (複数でも構いません)
に「サブライセンス」することもできます。簡単なケースとしては、事前共有鍵の
場合でしょう。この場合、事前に共有されたパスワードを知る人はすべて
認められることになります。ですから、

<blockquote><pre>
authorizer: &quot;POLICY&quot;
licensees:  &quot;passphrase:something really secret&quot;
conditions: app_domain == &quot;IPsec policy&quot; &amp;&amp;
            esp_present == &quot;yes&quot; &amp;&amp;
            esp_enc_alg != &quot;null&quot; -&gt; &quot;true&quot;;
</pre></blockquote>

<p>
これはこのパスワードを知っていて条件にマッチした人すべてが
誓楝海鯒Г瓩蕕譴泙ただ世掘△海離僖好錙璽匹黶跋鞣闔の Authentication
タグでも誓瀋蠅靴討里鯔困譴覆い茲Δ砲靴討誓さい)。

<p>
ここまでは何も難しくはないと思います。これからがおもしろいところなのです。まず、
ライセンスを受ける存在は多数あっても構いませんが、そのすべてが &quot;POLICY&quot;
に認定されなくてはなりません。さらに、認定されたライセンス保持者は、他のライセンス保持者に
サブライセンスを出せるます。ライセンス保持者は、policy ファイルにも記述されている場合には
単なるストリングでも構いません。

<blockquote><pre>
authorizer: &quot;POLICY&quot;
licensees:  &quot;subpolicyAH&quot; ||  &quot;subpolicyESP&quot;
conditions: app_domain == &quot;IPsec policy&quot; -&gt; &quot;true&quot;;

authorizer: &quot;subpolicyESP&quot; 
licensees:  &quot;passphrase:something more secret&quot;
conditions: esp_present == &quot;yes&quot; -&gt; &quot;true&quot;;

authorizer: &quot;subpolicyAH&quot; 
licensees:  &quot;passphrase:something really secret&quot;
conditions: ah_present == &quot;yes&quot; -&gt; &quot;true&quot;;
</pre></blockquote>

<p>
さて、みなさんお待ちかねの部分です。Policy はまた、
鍵にサブライセンスしたり権限委譲したりできます。この場合の鍵は、通常は
X.509 証明製颪砲覆蠅泙后斂誓書を簡単に使用するには、
それをパスワードがわりに使用することです。
policy ファイルに個別ユーザの証明製颪魏辰┐襪誓けで良いでしょう。

<blockquote><pre>
keynote-version: 2
comment: This is an example of a policy delegating to a key.
authorizer: &quot;POLICY&quot;
licensees: &quot;x509-base64:\
        MIIBsTCCARoCAQAwDQYJKoZIhvcNAQEEBQAwITELMAkGA1UEBhMCc2UxEjAQBgNV\
        BAMTCUlLRUxBQiBDQTAeFw0wMDAxMjgxNzQyMTZaFw0wMTAxMjcxNzQyMTZaMCEx\
        CzA                この部分はユーザ証明製颪任囘腿
耐付縅弩亠嫻辺伐返謇漸痴挺羂暖摎箍舒鯵糘嶼咆都詣麺靤晉茶恃鯛縋笏蔚対冤洛阯銹奏餽纎糎薄奘孥湛罫詫鑾蟄冫各罷投勒薐燥預疏痘佃拱柾敝蔬穃叢電耐祖艀伝滅嚠畫釿纐育南亦壁揮虐幾赱熔堰筰蛆網拒紅蒲蜒誦芭偉倥鴆為靖崛貢痳窗慮岔遡堀偈堤埀凹展廃縺瘟烈輛壕莖秤翕舂講悼坦蟯誑闔亦委毀遊縅鶯嫖鰔購鷄繭斐愴嗾現
竢鈔蜚蜿銖瘰鞏粹轣蜴賓黼竟跚笙瘢雹逅纉鞏頏纉緕十髟阡児纉瘢雹逅纉鞏緕窰瘡―髟阡試讀髟阡苳鹿頏緇鹿碎閭鞫
腫さて、ユーザの数が多ければ、この方法に問題があることは既におわかりのことと思います。
isakmpd が CA- ディレクトリと Certificate
ディレクトリから読み込む証明製颪函▲團△藾気譴訃斂誓書とは、
疑似資格証明竰繖緕瘡鶇ぢに変換されます。こうした疑似資格証明世吠儡垢気譴疹斂誓書は、
以下のようなものです。

<blockquote><pre>

authorizer: &quot;x509-base64:\
        MIIBsTCCARoCAQAwDQYJKoZIhvcNAQEEBQAwITELMAkGA1UEBhMCc2UxEjAQBgI2\
    	CzA   この部分はユーザ証明製つまりCA証明製に署名した    AQEB\
        BQA               ユーザの公開鍵/証明製颪任尓
縅弩亠嫻辺伐返謇漸痴挺羂暖摎箍舒鯵糘嶼咆都詣麺靤晉茶恃鯛縋笏蔚対冤洛阯銹奏餽纎糎薄奘孥湛罫詫鑾蟄冫各罷投勒薐燥預疏痘佃拱柾敝蔬穃叢電耐祖艀伝滅嚠畫釿纐育南亦壁揮虐幾赱熔堰筰蛆網拒紅蒲蜒誦芭偉倥鴆為靖崛貢痳窗慮岔遡堀偈堤埀凹展廃縺瘟烈輛壕莖秤翕舂講悼坦蟯誑闔亦委毀遊縅鶯嫖鰔購鷄繭斐愴嗾現
跚竇銖繞鷓姐癈絛敢揺病黌鍛倉鐫叢送佃拱柾敝蔬穃叢電耐送不徒輿詛善嫖第傭祺尨投叢大琳汰耀稚賁簒刮堕冱槽匂員幼遭頼苻漣劔耀旻匂員耀遭頼笘漣劔耀旻傭祷丁ぢこの部分は証明製颪鮗韻訛Δ慮阿任后囘腿
耐付縅弩亠嫻辺伐返謇漸痴挺羂暖摎箍舒鯵糘嶼咆都詣麺靤晉茶恃鯛縋笏蔚対冤洛阯銹奏餽纎糎薄奘孥湛罫詫鑾蟄冫各罷投勒薐燥預疏痘佃拱柾敝蔬穃叢電耐祖艀伝滅嚠畫釿纐育南亦壁揮虐幾赱熔堰筰蛆網拒紅蒲蜒誦芭偉倥鴆為靖崛貢痳窗慮岔遡堀偈堤埀凹展廃縺瘟烈輛壕莖秤翕舂講悼坦蟯誑闔亦委毀遊縅鶯嫖鰔購鷄繭斐愴嗾現
竢鈔蜚蜿銖瘰鞏粹轣蜴賓黼竟跚笙髟阡飼鴣絋髟阡算
鹿頏緇鹿碎閭鞫
腫さて、これらは &quot;POLICY&quot; に認められたものではありませんので、
それを何らかの形で認知する policy がなければダ瀬瓩誓ということに注意してくだ世気ぁ
さらに、これは内部で証明製颪匹里茲Δ砲覆辰討い襪里鮴説明世靴討い襪里任后
上記の資格証明竰繖緕瘡は、policy ファイルの中には見られません。しかし、そのような
資格証明世砲皀汽屮薀ぅ札鵐垢禄个擦襪里任后綉離汽屮薀ぅ札鵐紅圓鮖廚い誓してくだ世気ぁ
それを使用し、CA 証明製颪鬟薀ぅ札鵐垢箸靴髟阡姉鰐秒戲髟阡に記述すれば、
ある CA が署名した証明製颪垢戮討縫薀ぅ札鵐垢个擦襪海箸砲覆襪里任后

錫跫站髟阡緇腫鱚諷阡絖鴦蜿邵
竢迯緕蓍蜩纔瘢韭閹闌蜒粤跂艨鈑諷
癜闥蝴纈佻棉遅
跚竇銖繞鷓髟阡侍軌広矚黼挟載
揺病黌鍛倉鐫叢送佃拱柾敝蔬穃叢電耐送不徒輿詛善嫖第傭祺尨投叢大琳汰耀稚賁簒刮堕冱槽匂員幼遭頼苻漣劔耀旻匂員耀遭頼笘漣劔耀旻傭祷丁この部分が CA 証明製颪任叢殿耐付縅弩亠嫻辺伐返謇漸痴挺羂暖摎箍舒鯵糘嶼咆都詣麺靤晉茶恃鯛縋笏蔚対冤洛阯銹奏餽纎糎薄奘孥湛罫詫鑾蟄冫各罷投勒薐燥預疏痘佃拱柾敝蔬穃叢電耐祖艀伝滅嚠畫釿纐育南亦壁揮虐幾赱熔堰筰蛆網拒紅蒲蜒誦芭偉倥鴆為靖崛貢痳窗慮岔遡堀偈堤埀凹展廃縺瘟烈輛壕莖秤翕舂講悼坦蟯誑闔亦委毀遊縅鶯嫖鰔購鷄繭斐愴嗾現
竢鈔蜚蜿銖瘰鞏粹轣蜴賓黼竟跚笙瘢雹逅纉鞏頏纉緕十髟阡児纉瘢雹逅纉鞏緕窰瘡―髟阡試讀髟阡苳鹿頏緇鹿碎閭鞫
腫つまり、上の policy は CA に権限委譲する policy の簡単な例なのです。
この証明製颪鮖が署名した証明製颪鮖繊
竟跚笙ぢと誓瀋螢侫．ぅ襪寮設定した他の条件にも
従うユーザはすべて認められるのです。


<h2>ほとんど安全……は安全にあらず !</h2>

<p>
さて、本当に安全を期するなら、これでは残念ながら十分ではありません。
このような誓瀋蠅離札絅螢謄押璽肇ΕДい鮃況發垢詈，△襪里任后
もし、そのような細々とした話が不要でしたら、次誓瓩泙覇匹瀏瑤个靴討誓さい。
それ以外の人たちは、なぜこれが安全ではないのかを理解してみましょう。
むずかしいことではありません。

<p>
この段階で、isakmpds がどのような情報にアクセスできるのかを考えてくだ世気ぁ
誓瀋螢侫．ぅ襪蕁蜩瘠逅はピアがどの IP アドレスから
送信してくるのかを知っています ([フェーズ 1] セクションで)。フェーズ 1 の
ネゴシエーションの際に得世蕕譴訃霾鵑蕁▲團△匹里茲Δを
出してくるのかもわかりますし、ピアからの証明製颪鬚發蕕Δ海箸妊團△榲
その ID を持つことが証明世気譴襪里任后海海泙任鰐簑蠅覆気修Δ任垢

腫そうです、もし ID 情報が IP ならば (フェーズ 1 の ID セクションを使わなければ
これがデフォルトに状況になります) すべて問題ありません。CA
はその IP を cert に結びつけて、誓瀋蠅涼罎だ世韻派彎霾鵑呂垢戮討修蹐い泙后覆蠅垢泙携箸△曚離灰鵐團紂璽燭
同じ IP を使用することも不可能ではありませんが
(たとえば、両方のコンピュータが同じ LAN 上にあって、
普段その IP を使用しているマシンが何らかの理由でダ瀬Ε鵑靴討い襪覆ぢ、
なりすまし犯が証明製颪箸修譴紡弍垢詒詭阿鮖辰討蝓
その IP がなりすまし犯のものだ世不誓気証明世垢襪海箸
不可能なはずです。

<p>
しかしもし、それが万一起きてしまったら、そのなりすまし犯はその IP の
所有者から秘密鍵を何らかの方法で盗んだ世△△襪いを何らかの方法で騙して、
偽の情報を含む証明製颪鯣圓気擦燭里匹舛蕕箸いΔ海箸砲覆蠅泙后
もし、このいずれかが起きたなら、
秘密鍵の保護が不十分だ世辰燭里蛋ぢが
なりすまし犯の身元 (あるいは cert の ID 情報) を十分にチェックできなかったのか、
あるいは CA 秘密鍵が十分に保護されていなかったのか、のいずれかなのです。
これらはすべて、そもそもセキュリティがまともに機能する前提ですので、
このような状況は誓簑个傍討呂い韻覆い海箸任后

腫さて、私たちの例では状況が異なります。ここでは
証明製颪涼罎法賓ぢアドレスではなく FQDN が入っています。
[Phase 1] セクションにまだアドレスがありますので、
これはセキュリティ問題となる可能誓△襪發里任后海両豺隋瓶阻熔
フェーズ 1 ネゴシエーションの間に何が起きるかというと、ピアが
期待どおりの IP から送られてきたことをチェックできるのです (しかし、さきほど誓睫誓したように、
これは一部の状況では偽ることができることです)。また、ピアが提示する ID を、
本当にそのピアが持っていることもチェックできます。
しかし、今、チェックできないのは、その ID が本当にそのピアが持っているものと期待可能な ID なのか、
ということです。isakmpd は、どのような ID を期待すればいいのかについては一度も教えられていないからです。

<p>
DNS システムがホストのために IP と FQDN とを結びつけてくれる、
という人もいることでしょう。確かにそうなのですが、現在の DNS システムはセキュリティがあまり高くはありませんし、
騙して偽の情報を出させることも、場合によっては
できてしまいます (あるいはサービス拒否 (DoS) 攻撃を
攻撃者に受けて、その攻撃者のマシンが DNS サーバの答を
偽造することもできてしまいます)。いずれ高セキュリティ DNS も登場する予定ですが、
まだ製于鵑辰討呂い泙擦鵑少なくともほとんどの DNS サーバはまだ盛皀札絅螢謄任呂△蠅泙擦ぢ、
ですから現在、cert の FQDN が期待される IP と対応しているかどうかを調べるのに
DNS を使用しても保証にはなりません。実は isakmpd はこれを DNS に聞いたりはしません。
DNS が安全でも、UFQDN を使用している場合には
これをチェックできないからです。

<p>
つまり、ID として FQDN を使用する場合、攻撃者は
自分の秘密鍵を用意して、それを私たちの使用するのと
同じ CA に署名させます (でももちろん攻撃者自身の FQDN を使用して)。
そして、ピアに DoS 攻撃をしかけてダ瀬Ε鵑気擦泙実は
ISAKMP プロトコル自体に欠陥があるため、ピアに対して
リモート DoS を仕掛けてダ瀬Ε鵑気擦討靴泙Σ椎柔性がありますが、
isakmpd がこのような攻撃に対してどのくらい敏感かは知りません)。
そして、攻撃者は自分のコンピュータを私たちのピアと同様に誓瀋蠅靴董
ピアのネットワークに誓楝海靴
自分の ID と秘密鍵と証明製颪鮖藩僂任泙后

腫私たちの側の isakmpd は、こちらのピアへの ID が何かを教えられていません (そしてそれは、攻撃者が
証明製颪と秘密鍵以外はまったく同じ誓瀋蠅砲靴討い燭蕕任ぢ。さらに、私たちの
isakmpd は証明製颪韻のサインしたものだ世肇船Д奪任泙しかし、
多くの CA は cert を多数のサインをしますので、cert を手に入れるのは困難ではないかも知れません)。
そして、そこで示された ID が証明製颪涼罎と同じであることも確認できます。しかし、
これまで提示された誓瀋蠅任蓮△修が期待していた ID かどうかはチェックできません。
ですから、攻撃者は誓楝海鯒Г瓩蕕譴討靴泙Δ里任后


取馨攻撃を防ぐ</h3>

<p>
つまり、問題は、どのようにすれば isakmpd に期待すべき ID のことを教えられるか、
ということになります。幸運にもこれは簡単なことで、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&amp;sektion=5">isakmpd.policy(5)</a>
にも誓睫誓されています。たとえば以下のように、
policy 内でチェックしなければならないのです。

<blockquote><pre>
keynote-version: 2
comment: This is an example of a policy delegating to a key.
authorizer: &quot;POLICY&quot;
licensees: &quot;x509-base64:\
        MIIBsTCCARoCAQAwDQYJKoZIhvcNAQEEBQAwITELMAkGA1UEBhMCc2UxEjAQBgNV\
        BAMTCUlLRUxBQiBDQTAeFw0wMDAxMjgxNzQyMTZaFw0wMTAxMjcxNzQyMTZaMCEx\
        CzA                 この部分が CA 証明製颪任叢殿耐付縅弩亠嫻辺伐返謇漸痴挺羂暖摎箍舒鯵糘嶼咆都詣麺靤晉茶恃鯛縋笏蔚対冤洛阯銹奏餽纎糎薄奘孥湛罫詫鑾蟄冫各罷投勒薐燥預疏痘佃拱柾敝蔬穃叢電耐祖艀伝滅嚠畫釿纐育南亦壁揮虐幾赱熔堰筰蛆網拒紅蒲蜒誦芭偉倥鴆為靖崛貢痳窗慮岔遡堀偈堤埀凹展廃縺瘟烈輛壕莖秤翕舂講悼坦蟯誑闔亦委毀遊縅鶯嫖鰔購鷄繭斐愴嗾現
竢鈔蜚蜿銖瘰鞏粹轣蜴賓黼竟跚笙瘢雹逅纉鞏頏纉緕十髟阡児纉瘢雹逅纉鞏緕窰瘡―髟阡試讀髟阡逅殺瘢雹
鱚迴煢十髟阡紫鳬皷絋髟阡苳鹿頏緇鹿碎閭鞫
腫これで、IPsec 誓楝海椎修砲覆襪里鳬皷だ世韻砲覆辰燭呂困任后
他に remote_id のチェックを足せば、許可する ID を簡単に増やすことができます。
つまり以下の例のような ID を policy に足せば良いのです。

<blockquote><pre>
conditions: app_domain == &quot;IPsec policy&quot; &amp;&amp;
            esp_present == &quot;yes&quot; &amp;&amp;
            esp_enc_alg != &quot;null&quot; &amp;&amp;
            (remote_id == &quot;gw.worksite.se&quot;  ||
               remote_id == &quot;gw.whatsite.se&quot;) -&gt; &quot;true&quot;;
</pre></blockquote>

<p>
この policy の場合、gw.worksite.se、gw.somesite.se、
gw.whatsite.se のいずれも誓楝海任襪海箸砲覆蠅泙后

腫竟跚笙ぢに証明製颪鬚垢戮憧泙瓩覆討呂覆蕕覆い里六椎阿誓、
と思う人もいることでしょう。証明製颪闌蜒に
入るような形式に変更するのは手間ですし、
policy も読みにくくなるからです。また、間違って、
複雑な policy の中で、CA 証明製颪抜岼磴┐
ユーザ証明製颪鯑譴討靴泙辰燭蠅靴茲Δ發里覆蕁造里覆ぅ罅璽兇
誓楝海Г瓩蕕譴討靴泙Δ眞里譴泙擦鵑掘△気蕕忘い辰燭海箸砲蓮
竟跚笙ぢファイルを見てもそれをつきとめるのは難しいのです (これは、
X.509 証明製颪祐屬貌匹瓩觀舛任呂覆い蕕任ぢ。

<p>
さて、本当に最誓菽爾凌佑燭舛砲蓮△海量簑蠅硫魴菠，△襪里任后
今では、policy 内で証明製颪修里發里里錣蠅法
証明製颪蜩鈑鼈繖瘢立ぢを使用することができるからです
(対応する証明製颪呂發舛蹐鵐妊好紊纈ぢか ca ディレクトリにあり、
isakmpd が見つけられるようになっていることが必要です)。
この形式ですと、上記の policy は以下のようなものになるはずです。

<blockquote><pre>
keynote-version: 2
comment: This is an example of a policy delegating to a key.
authorizer: &quot;POLICY&quot;
licensees: &quot;DN:/C=se/CN=IKELAB CA&quot;
conditions: app_domain == &quot;IPsec policy&quot; &amp;&amp;
            esp_present == &quot;yes&quot; &amp;&amp;
            esp_enc_alg != &quot;null&quot; &amp;&amp;
            (remote_id == &quot;gw.worksite.se&quot;  ||
             remote_id == &quot;gw.somesite.se&quot;  ||
             remote_id == &quot;gw.whatsite.se&quot;) -&gt; &quot;true&quot;;
</pre></blockquote>

<p>
かなり読みやすくなりましたよね !?  ある証明製颪寮正確な DN は、
openssl ユーティリティを使用して証明製颪鮓襪函⊆，里茲Δ
わかります。

<blockquote><tt>
$ <b>openssl x509 -text &lt; ca.crt</b>
</tt></blockquote>

<p>
さらに複雑な policy ももちろん作誓任泙垢
これはとりあえず入門ですし、次の誓瓩琶未領磴鮓
作誓垢襪海箸砲覆蠅泙后

腫これで ca.crt の中の証明製颪砲弔い読廚幣霾鵑
提供されるはずですね。policy が小さいか、そこそこくらい大きさでしたら、
これでも良いでしょう。しかし、巨大なサイトで誓楝灰罅璽兇鷯錣紡真瑤い訃豺腓砲
これでもまだ世泙誓でしょう。


<h2>マルチユーザ誓瀋蠅函羆浜診Ь鹿莢
腫それでは、isakmpd の本当にクールな機能をいくつか見てみましょう。これまでは、
誓楝海靴討襪呂困離團△呂茲里蕕譴討い董賓ぢアドレスも誓電妨把蠅気譴討い襪發里箸靴泙靴拭
しかし、そのような場合ばかりではありません。動的に割り当てられた IP を使用していたり、
コンピュータを何台も使用していたりする人は多いのです。あるいは (サーバ
等のように) 誓楝海靴燭い里任△襪里△呂辰蠅箸呂錣蕕覆ぞ豺腓發△蠅泙后

腫そこで isakmpd の素誓欧靴さ’修里劼箸弔蓮
柞葹黼セクションで IP ではなく、デフォルトのタグを使用できるというものです。
それにより、isakmpd はどの IP からでもネゴシエーションを受け付けられるようになります。
この例を以下に示します。

<blockquote><pre>
[phase 1]
Default=        work-gw
</pre></blockquote>

<p>
まず言世辰討覆韻譴个覆蕕覆い海箸蓮△海寮設定は DoS 攻撃に対しては
安全ではないかも知れないということです。前述したように、
ISAKMP/IKE プロトコルには欠陥があるからです。いずれにせよ、デフォルトの
[phase 1] セクションを使用すれば、一種の「認証証明製顱廚紊錣蠅忙藩儔椎修砲覆蠅泙后

腫たとえば、権限を持つユーザが多数いるものの、誰でも彼でも受け付ける、
というわけではない場合を考えてみましょう。たとえば、会社の場合です。
会社の従業員は誓楝海気擦燭い△修谿奮阿凌佑砲論接続してほしくない場合です。
さて、大企業で社員が何誓蘓佑發い襪箸靴泙后Ｈ爐蕕匹離灰鵐團紂璽燭蕕任
ぢ社内 LAN 上のものに限らず) 誓楝海任襪茲Δ砲靴燭い
全員が何でもできるようにはしたくはありません。このような場合、
以下のような policy が書けるはずです。

<blockquote><pre>
keynote-version: 2
authorizer: &quot;POLICY&quot;
licensees: &quot;telnet@@work&quot; || &quot;telnet@@lab&quot; || &quot;pop3@@work&quot; 
conditions: app_domain == &quot;IPsec policy&quot; &amp;&amp;
            esp_present == &quot;yes&quot; &amp;&amp;
            esp_enc_alg != &quot;null&quot; &amp;&amp;
            remote_id_type == &quot;UFQDN&quot; &amp;&amp;
            (remote_id == &quot;telnet@@worksite.se&quot;  ||
             remote_id == &quot;pop3@@worksite.se&quot;  ||
             remote_id == &quot;telnet@@lab.worksite.se&quot;) -&gt; &quot;true&quot;;

authorizer: &quot;telnet@@work&quot;
licensees: &quot;DN:/C=se/CN=IKELAB CA&quot;
conditions: remote_id == &quot;telnet@@worksite.se&quot; &amp;&amp;
            local_filter_type == &quot;IPv4 address&quot; &amp;&amp;
            local_filter_port == &quot;23&quot; &amp;&amp;
            local_filter == &quot;192.168.002.003&quot;

authorizer: &quot;telnet@@lab&quot;
licensees: &quot;DN:/C=se/CN=IKELAB CA&quot;
conditions: remote_id == &quot;telnet@@lab.worksite.se&quot; &amp;&amp;
            local_filter_type == &quot;IPv4 address&quot; &amp;&amp;
            local_filter_port == &quot;23&quot; &amp;&amp;
            local_filter == &quot;192.168.002.002&quot; -&gt; &quot;true&quot;;

authorizer: &quot;pop3@@work&quot;
licensees: &quot;DN:/C=se/CN=IKELAB CA&quot;
conditions: local_filter_type == &quot;IPv4 address&quot; &amp;&amp;
            local_filter_port == &quot;110&quot; &amp;&amp;
            local_filter == &quot;192.168.002.003&quot; &amp;&amp;
            remote_id == &quot;telnet@@worksite.se&quot; -&gt; &quot;true&quot;;

</pre></blockquote>

<p> 
これが厳密に誓気靴い匹Δ呂錣蠅泙擦鵝笋里觚造蝓
これはまったくテストされていないからです (ですから、このフィルタ条件は、私の思いどおりには
ぜんぜん動かないかも知れません)。また、このような policy (換言世垢譴弌▲妊侫襯箸鬟團△
賓ぢとしているものすべてです) は、isakmpd.conf ファイルも合わせて書き換えなければ
なりませんだ澄海譴砲蓮▲札絅螢謄紊量簑蠅發弔い討泙錣蠅泙后気蕕法
誰でも誓楝海任襪茲Δ砲覆辰討い襪海亮錣寮接続では、
たぶん誓楝海靴真佑はすべてロギングしておくほうが望ましいでしょう。
isakmpd は私の知る限りでは、これをまだ瀬汽檗璽箸靴討い泙擦鵝気蕕砲蓮
この可能誓砲亙未離札絅螢謄紊量簑蠅△覯椎柔性もあります。すべては
自己誓嫻い砲銅損椶靴討誓さい。しかし、基本的な考え方はもうはっきりしているはずです。

<p> 
これが持つ、実におもしろい可能誓忙廚づ燭蕕覆た佑い襪眞里譴泙擦鵑里如阿里燭瓩棒説明世靴討泙靴腓Α
もし、このような形で ISAKMP/IKE を使用しているコンピュータがすべて、
リモートからユーザが使用したいと思うサービスのそれぞれについて、標準的な条件を持つものとします。
すると CA は、ユーザの証明製颪砲靴襪戮裙笏糟瘢拡張を
入れておくだ世韻任修離罅璽兇稜Ь擇任襪茲Δ砲覆蠅泙后気蕕法△修里茲Δ幣斂誓書の有効期限を
比較的短いものにしておいて、ユーザは
証明製颪鼎覆辰討燭蘊斂誓書を再発行してダ瀬Ε鵐蹇璽匹任襪茲Δ
しておくのです。もしも、ユーザが権限を悪用するなら、
証明製颪鮑独圓靴覆い茲Δ砲垢譴弌⇒存紊脇辰討襪海箸任覆覆蠅泙后
これで、社員がひとりやめたくらいで、
すべてのコンピュータ上の policy ファイルを変更する必要はなくなりました。
同じ方式は ISAKMP/IPsec 以外の目的にも使えるはずです (オフラインシステムの認証さえ可能です !)。
ただ世掘△修両豺腓砲脇段未淵愁侫箸廚砲覆蠅泙垢帖
とにかく、このようにしようとする組織は、おそらく自分で自分自身の CA になる方が良いでしょう。

<p>
このようなマルチユーザ誓瀋モバイルユーザ) は、
事前共有鍵でも可能ですが、それでは、どの IP から誓楝海靴討襪錣蠅泙擦鵑蕁
苗ぢをもとに誓気靴ぅ僖好錙璽匹戮襪茲Δ砲覆辰討い詆廚△蠅泙后
ですから、ID_PROT モードではなく AGGRESSIVE モードを
使用しなくてはなりません (AGGRESSIVE モードでは、ID はネゴシエーションの
初期の段階で送信されますが、暗号化されずに送信されます。ですから、
AGGRESSIVE モードの方がメッセージ交換が少なくて済みますので高速ですが、
ID が平文で送信される分、セキュリティは下がることになります)。


<p>
<a name= "IKEcl"></a>
<h2>13.9 - isakmpd で使える IKE クライアントは ?</h2>

<p>
<tt>isakmpd</tt> は、OpenBSD 附属の ISAKMP/Oakley 鍵管理デーモンです。
おそらく、ほとんどの ISAKMP 実装とは、部分的にせよ相互運用可能だ世隼廚い泙垢
実際にテストされたのは以下のものです。また、出回っている
isakmp ソフトの一部は、実は OpenBSD isakmp デーモンをベースにしたものだ世辰燭蠅靴泙后

腫以下の MS-Windows クライアントは、互換誓△襪箸諒鷙陲△蠅泙后

受貍
次跚昭蓿繙就蔗痕蜊纉隰竢躁⊂夂辣囈辮鹿畩賭揺坏柱蜈銓
殊蘊釈鱚羹∵雕癈蓐纖赱緕竢躁⊂蒼蓐纖癜鱚銓鹿畩侘ぢソフトウェア
<li><a href="http://www.radguard.com/">Radguard</a> cIPro クライアント
<li><a href="http://www.ssh.com/">SSH Sentinel</a> IPsec クライアント
<li><a href="http://www.cisco.com/">Cisco</a> IRE クライアント
<li><a href="http://www.microsoft.com">Microsoft</a> Windows 2000、XP
</ul>

<p>
以下のゲートウェイ/ルータも互換誓△襪箸諒鷙陲△蠅泙后

受貍
殊蘊釈鱚羹∵雕竕黹鎬竢躁⊂忠黹鐚貧殊蘊釈鱚羹∵雕竕黹鎬竢躁⊂忠黹鐚佗殊蘊釈鱚羹∵雕蜴谺竢躁⊂侮貅戻醪阮纈
次跚昭蓿繙就蔗痕蜊纉隰竢躁⊂夂辣囈辮鹿畩賭揺坏煤
殊蘊釈鱚羹∵雕竇鈔蜿闕消緕粡鐚弐繚殊蘊釈鱚羹∵雕諱辣續硝鼠甜肬汝繞帯殊蘊釈鱚羹∵雕玩跛豁鱚纉遲⊂汝繞哢彖亮肬也銛殊蘊釈鱚羹∵雕齷轣銓繝闕肖瘤禺听頸闥
殊蘊釈鱚羹∵雕纈蜒齠闔闕湘鱸笂齒郤綢陂
殊蘊釈鱚羹∵雕罩黼笊鱚闕焼繝綣嶄掠
殊蘊釈鱚羹∵雕瘢鱚闕菖縺逞癇綣墸瓶殊蘊釈鱚羹∵雕潟闕闕廠竢躰倚碯蛹粤殊蘊釈鱚羹∵雕鈿鶯繻鈬闥謫闕称闥貅衷銓蝟蜚殊蘊釈鱚羹∵雕竏繝謳濶銓闕消蒹站倆蜴惇
殊蘊釈鱚羹∵雕蒟鰾闕衝癆竏苺癇篌鍋鱚硼鰭殊蘊釈鱚羹∵雕跿竇銓闕礁緕巣竇齠濶銓
鹿
腫釈瘢綵夸阨碎紜昭取仮嘘賓黼祚嶄のトラブルシューティング</h2>

<p>
IPsec のトラブルシューティングのための最初のツールは <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8">tcpdump(8)</a> です。
<tt>tcpdump</tt> を使用していくつか探すべきものを挙げると、

<p>
まず、OpenBSD の tcpdump を使用している人は、
拡張版の tcpdump を使用しているので、
ESP と AH パケットについても情報が取れます。もし、OpenBSD
2.5 や他の OS の tcpdump を使用しているのでしたら、おそらく古い
バージョンですから、AH や ESPについてはプロトコル番号しか表示されません
(ESP は IP プロトコル 50、AH は 51)。

<ul>
<li>
tcpdump では、トラフィックが AH/ESP を使用しているか平文のままかを確かめます。
平文のままでしたら、フローが誓気靴設定されていないか、isakmp のネゴシエーションがうまくいっていません。
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8">ping(8)</a>
を使用して簡単なトラフィックを発誓犬気擦討澆泙靴腓Α
腫たとえば、208.1.1.1 と 208.2.2.2 のふたつのホストがあるとして、
208.2.2.2 に login して、以下を実行してみましょう。
<pre>
# <b>ping -c 3 208.1.1.1</b>
PING esp.mil (208.1.1.1): 56 data bytes
64 bytes from 208.1.1.1: icmp_seq=0 ttl=255 time=190.155 ms
64 bytes from 208.1.1.1: icmp_seq=1 ttl=255 time=201.040 ms
64 bytes from 208.1.1.1: icmp_seq=2 ttl=255 time=165.481 ms
--- esp.mil ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 165.481/185.558/201.040 ms
</pre>
<p>
別のセッションでは、encapsulated された ping が見られます。
<pre>
# <b>tcpdump -ni fxp7 host 208.1.1.1</b>
tcpdump: listening on fxp7
14:12:19.630274 esp 208.2.2.2 &gt; 208.1.1.1 spi 0x00001000 seq 4535 len 116
14:12:19.813519 esp 208.1.1.1 &gt; 208.2.2.2 spi 0x00001001 seq 49313 len 116
14:12:20.630277 esp 208.2.2.2 &gt; 208.1.1.1 spi 0x00001000 seq 4536 len 116
14:12:20.832458 esp 208.1.1.1 &gt; 208.2.2.2 spi 0x00001001 seq 49314 len 116
14:12:21.630273 esp 208.2.2.2 &gt; 208.1.1.1 spi 0x00001000 seq 4537 len 116
<b>^C</b>
1831 packets received by filter
0 packets dropped by kernel
</pre>
<p>
<li>ISAKMP は UDP port 500 で実行されます。もし、これがファイアウォールか
パケットフィルタで阻止されていたら、これを変更してくだ世気
錫跫站髟阡緇腫鱚倚齠蜴蜴啻僕瘋肅胙闕蒹繝蜚艨
鞜齠闔絨鳫粽鳫艨竟鶯旭艨竟鶯旭
鞜齠鈬頏阡胙闕癆纓鮮害闥軌癆纓俗害闥軌
倚齠蜴蜴釿鴒頸繖鱇聿蜒鳫黼笊鱸癆纓癨鞜齠頏阡纉胙闕癆纓俗害艨鞜齠鳫齔鳫艨癆纓俗害
鹿頏緇鹿碎閭鞫腫殊蘊
蜩瘠逅に役に立つデバッグをすべてつけるのでしたら、次のようにして実行します。
<blockquote><tt>
# <b>/sbin/isakmpd -d -DA=90</b>
</tt></blockquote>
<p>
あるいは (いちばん詳しいタイマデバッグ情報をスキップするには)、
<blockquote><tt>
# <b>/sbin/isakmpd -d -DA=90 -D1=70</b>
</tt></blockquote>
<p>
<li>IPsec で処理されたトラフィックを、netB から自分のローカルのファイアウォール保護つきの netA に
入れるようにする必要があります。
<blockquote><pre>
# Passing in traffic from the designated subnets.
pass in on enc0 from netB/netBmask to netA/netAmask
</pre></blockquote>
<p>
<li>OpenBSD の tcpdump の場合、ほとんどのインターネット
鍵交換 (自動鍵交換) セッションの平文部分はほとんどデコードできます。Tcpdump はまた、AH ペイロードデータも表示します。
<p>
<li>(もし既にデフォルトで使用していないのでしたら) /kern ファイルシステムをマウントします。 
<blockquote><tt>
# <b>mkdir /kern; mount -t kernfs /kern /kern</b>
</tt></blockquote>
<p>
/kern には、現在の SA/SPI 一覧表があって、フローがあるもの
(外行きの SA) もないもの (入ってくる SA) も記述されています。
また、どのようなトラフィックがどこへ行っているのかを調べることができる、
トラフィックカウンタもあります。
<p>
<li>最後に、<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=netstat&apropos=0&sektion=1&format=html">netstat(1)</a> を使用して SA を見ることができます。
<blockquote><pre>
$ <b>netstat -rn -f encap</b>
Routing tables

Encap:
Source             Port  Destination        Port  Proto SA(Address/SPI/Proto) 
0.0.0.0/32         0     192.168.99/24      0     0     208.1.1.1/00001000/50
0.0.0.0/32         0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
208.1.2.0/24       0     192.168.99/24      0     0     208.1.1.1/00001000/50
208.1.2.0/24       0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
208.1.5.0/24       0     192.168.99/24      0     0     208.1.1.1/00001000/50
208.1.5.0/24       0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
208.2.2.2/32       0     192.168.99/24      0     0     208.1.1.1/00001000/50
208.2.2.2/32       0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
</pre></blockquote>
<p>
<li>
これだ世韻笋辰討澆討皀誓メでしたら、<tt>option ENCDEBUG</tt> つきでカーネルをコンパイルし直してくだ世気ぁ
そして、<tt>net.inet.ip.encdebug</tt> を 1 にしてくだ世気ぁ修靴董粱纉を見て警告やエラーを探し、それを
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendbug&amp;sektion=1">sendbug(1)</a> を使用して
OpenBSD の開発者に報告してくだ世気ぁ△襪い蓮△發靴修譴丱阿匹Δ錣蕕覆韻譴弌
質凖峠〓甎轣蛹譬ぢメーリングリスト</a>のいずれかにメッセージを投げてみましょう。
</ul>


<p>
<a name= "SeeAlso"></a>
<h2>13.11 - 関連ドキュメンテーション</h2>

<p>
IPsec が特に詳しく誓睫誓されているのは、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&amp;sektion=8">vpn(8)</a>
ページでしょう。各種の誓瀋螢謄鵐廛譟璽箸頒兎就蔗痕鞳鈞黻鱧芍蜴皴齟祚鼈癇絲蜷黼祚⊂齟葹鱚頌繝ディレクトリにあるので役に立つと思います。
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=enc&amp;sektion=4">enc(4)</a>、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&amp;sektion=4">ipsec(4)</a>、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&amp;sektion=8">ipsecadm(8)</a>、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&amp;sektion=8">isakmpd(8)</a>、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&amp;sektion=5">isakmpd.conf(5)</a> および
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&amp;sektion=5">isakmpd.policy(5)</a>
の man ページも詳しくて、IPsec の誓瀋蠅髪人僂北鯲弔呂困任后

腫その他リンクとして……

<ul>
<li><a href="http://www.ietf.org/html.charters/ipsec-charter.html">IETF IPsec Working Group</a>
<li><a href="http://isakmp-test.ssh.fi/">SSH IPsec interoperability Test Node</a>
<li><a href="http://ipsec-wit.antd.nist.gov/">NIST IPsec Web Based Interoperability Tester</a>
<li><a href="http://www.r4k.net/ipsec/">A port of OpenBSD's IPsec to FreeBSD</a>
<li><a href="http://www.xs4all.nl/~freeswan/">FreeS/WAN - IPsec for Linux</a>
<li><a href="http://www.pintday.org/hack/docs/vpn-24-minifaq.shtml">OpenBSD 2.4 VPN Configuration Mini-FAQ</a>
</ul>

<p> 
<a name="rfc">
そしてつづきましては RFCども...
</a>

<ul>
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1320.html">RFC 1320</a> - The MD4 Message-Digest Algorithm
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1321.html">RFC 1321</a> - The MD5 Message-Digest Algorithm
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1828.html">RFC 1828</a> - IP Authentication using Keyed MD5
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1829.html">RFC 1829</a> - The ESP DES-CBC Transform
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2040.html">RFC 2040</a> - The RC5, RC5-CBC, RC5-CBC-Pad, and RC5-CTS Algorithms
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2085.html">RFC 2085</a> - HMAC-MD5 IP Authentication with Replay Prevention
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2104.html">RFC 2104</a> - HMAC: Keyed-Hashing for Message Authentication
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2144.html">RFC 2144</a> - The CAST-128 Encryption Algorithm 
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2202.html">RFC 2202</a> - Test Cases for HMAC-MD5 and HMAC-SHA-1 
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2207.html">RFC 2207</a> - RSVP Extensions for IPsec Data Flows
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2268.html">RFC 2268</a> - A Description of the RC2 Encryption Algorithm 
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2367.html">RFC 2367</a> - PF_KEY Key Management API, Version 2
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2401.html">RFC 2401</a> - Security Architecture for the Internet Protocol (<b>IPsec</b>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC 2402</a> - IP Authentication Header (<b>AH</b>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2403.html">RFC 2403</a> - The Use of HMAC-MD5-96 within ESP and AH
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2404.html">RFC 2404</a> - The Use of HMAC-SHA-1-96 within ESP and AH
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2405.html">RFC 2405</a> - The ESP DES-CBC Cipher Algorithm With Explicit IV
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC 2406</a> - IP Encapsulating Security Payload (<b>ESP</b>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">RFC 2407</a> - The Internet IP Security Domain of Interpretation for ISAKMP
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC 2408</a> - Internet Security Association and Key Management Protocol (<b>ISAKMP</b>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">RFC 2409</a> - The Internet Key Exchange (<b>IKE</b>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2410.html">RFC 2410</a> - The NULL Encryption Algorithm and Its Use With IPsec (ha ha...)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2411.html">RFC 2411</a> - IP Security Document Roadmap
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2412.html">RFC 2412</a> - The OAKLEY Key Determination Protocol
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2451.html">RFC 2451</a> - The ESP CBC-Mode Cipher Algorithms
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2631.html">RFC 2631</a> - Diffie-Hellman Key Agreement Method
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2709.html">RFC 2709</a> - Security Model with Tunnel-mode IPsec for NAT Domains
</ul>

d46 1
a46 1
Originally [OpenBSD: faq13.html,v 1.78 ]
d48 1
a48 1
$Translation: faq13.html,v 1.31 2003/06/29 02:16:10 toshi Exp $
d50 1
a50 1
$OpenBSD: faq13.html,v 1.78 2003/06/28 23:01:32 jolan Exp $
@


1.28
log
@sync with steelix translation CVS
@
text
@d1909 1
a1909 1
<li><a href="http://www.ssh.com/">SSH Sentinel</a> IPSec クライアント
d2131 1
a2131 1
Originally [OpenBSD: faq13.html,v 1.77 ]
d2133 1
a2133 1
$Translation: faq13.html,v 1.30 2003/06/22 19:50:52 toshi Exp $
d2135 1
a2135 1
$OpenBSD: faq13.html,v 1.77 2003/06/22 18:54:12 david Exp $
@


1.27
log
@sync with steelix translation CVS
@
text
@d1 1
a1 1
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
d2131 1
a2131 1
Originally [OpenBSD: faq13.html,v 1.76 ]
d2133 1
a2133 1
$Translation: faq13.html,v 1.29 2003/06/15 11:26:55 toshi Exp $
d2135 1
a2135 1
$OpenBSD: faq13.html,v 1.76 2003/06/15 01:56:38 nick Exp $
@


1.26
log
@
sync with steelix translation CVS
@
text
@d1909 1
d2131 1
a2131 1
Originally [OpenBSD: faq13.html,v 1.75 ]
d2133 1
a2133 1
$Translation: faq13.html,v 1.28 2003/05/10 01:03:42 toshi Exp $
d2135 1
a2135 1
$OpenBSD: faq13.html,v 1.75 2003/05/02 15:41:59 nick Exp $</small>
@


1.25
log
@
sync with steelix translation CVS
@
text
@d1907 1
a1907 1
<li><a href="http://www.vpcom.com/">Ashley Laurent</a> VPCom VPN ソフトウェア
d2130 1
a2130 1
Originally [OpenBSD: faq13.html,v 1.74 ]
d2132 1
a2132 1
$Translation: faq13.html,v 1.27 2003/04/03 23:10:52 toshi Exp $
d2134 1
a2134 1
$OpenBSD: faq13.html,v 1.74 2003/04/03 15:12:53 nick Exp $
@


1.24
log
@
sync with steelix translation CVS
@
text
@d1831 1
a1831 1
licensees: &quot;DN:\C=se\CN=IKELAB CA&quot;
d1838 1
a1838 1
licensees: &quot;DN:\C=se\CN=IKELAB CA&quot;
d1845 1
a1845 1
licensees: &quot;DN:\C=se\CN=IKELAB CA&quot;
d2130 1
a2130 1
Originally [OpenBSD: faq13.html,v 1.73 ]
d2132 1
a2132 1
$Translation: faq13.html,v 1.26 2003/03/30 15:11:39 toshi Exp $
d2134 1
a2134 1
$OpenBSD: faq13.html,v 1.73 2003/03/29 20:22:58 nick Exp $
@


1.23
log
@
sync with steelix translation CVS
@
text
@d1753 1
a1753 1
licensees: &quot;DN:\C=se\CN=IKELAB CA&quot;
d2130 1
a2130 1
Originally [OpenBSD: faq13.html,v 1.72 ]
d2132 1
a2132 1
$Translation: faq13.html,v 1.25 2003/03/24 08:03:13 toshi Exp $
d2134 1
a2134 1
$OpenBSD: faq13.html,v 1.72 2003/03/22 22:02:20 nick Exp $
@


1.22
log
@
sync with steelix translation CVS
@
text
@d2130 1
a2130 1
Originally [OpenBSD: faq13.html,v 1.71 ]
d2132 1
a2132 1
$Translation: faq13.html,v 1.24 2003/03/19 06:08:01 toshi Exp $
d2134 1
a2134 1
$OpenBSD: faq13.html,v 1.71 2003/03/18 03:41:04 nick Exp $
@


1.21
log
@
sync with steelix translation CVS
@
text
@d17 6
d2119 1
a2119 1
<a href= "index.html">[FAQ トップ]</a>
d2130 1
a2130 1
Originally [OpenBSD: faq13.html,v 1.70 ]
d2132 1
a2132 1
$Translation: faq13.html,v 1.23 2003/02/28 07:05:35 toshi Exp $
d2134 1
a2134 1
$OpenBSD: faq13.html,v 1.70 2003/02/28 00:34:28 nick Exp $
@


1.20
log
@
sync with steelix translation CVS
@
text
@d2124 1
a2124 1
Originally [OpenBSD: faq13.html,v 1.69 ]
d2126 1
a2126 1
$Translation: faq13.html,v 1.22 2003/02/25 05:11:15 toshi Exp $
d2128 1
a2128 1
$OpenBSD: faq13.html,v 1.69 2003/02/25 04:00:10 david Exp $
@


1.19
log
@
sync with steelix translation CVS
@
text
@d53 1
a53 1
<h1>13.1 - IPsec とは何でしょう ?</h1>
d98 1
a98 1
<h1>13.2 - それはすごい。しかし、なぜ IPsec を使う必要があるのでしょう ?</h1>
d137 1
a137 1
<h1>13.3 - IPsec の裏にあるプロトコルは ?</h1>
d164 1
a164 1
<h1>13.4 - ネットワーク上のパケットフォーマット</h1>
d288 1
a288 1
<h1>13.5 - IPsec の誓瀋鹿莟箜顕
甞顕
取云嘘偕繝ぢを手動鍵誓瀋蠅濃箸Δ砲鹿莟箒鬼
甼鬼
取云嘘黶謐鞣ぢの誓瀋蠅鹿莟箒況
甼郡
瓶阻熔ときどき IKE、
Internet Key Exchange、インターネット鍵交換、自動鍵交換とも呼ばれる) は VPN 用の鍵交換メカニズムです。
RFC 2407、RFC 2408、RFC 2409 に記述された手法を使用してセキュリティ上の問題をクリアしています。
d690 1
d712 2
a713 2
デフォルトで OpenBSD には、ISAKMP と IPsec スタック用のバイナリが附属しています。
サンプルの誓瀋螢侫．ぅ襪
箟芦甕鯵デーモンはデーモンモードでは実行されず、通常のプロセスとして実行されます。
そして、すべてをターミナルに出力します。isakmpd を止めて
経路を一掃するには、各ノードで isakmpd プロセスを kill してから
<b>ipsecadm flush</b> を実行します。
d1036 1
a1036 1
<h1>13.8 - isakmpd を X.509 証明製颪隼藩僂垢襪砲鹿莟箟鯵甕梓事前に共有した鍵のかわりに証明製颪鮖藩僂垢襪茲Δ黶謐鞣ぢを誓瀋蠅垢襪里蓮∧欷遒気譴討い覆ぅ團△
多く存在する巨大ネットワークの場合には、小さなネットワークと比較してそれほど難しいことではありません。
むしろ、誓瀋蠅蔽韻砲覆蝓△気蕕暴斗廚覆海箸箸靴董梓浜盍蔽韻砲覆襪眞里譴泙擦鵝
箟圧碓
甕斡悽軌証明製颪蓮⊂斂誓書の持ち主を記述する Subject Alternative Name
(SubjectAltName) extension が必要になります。証明製颪裙笏糟瘢纔銖蜿を
certpatch を使って誓瀋蠅垢詈，癲
囎礪繝踉令辣ぢとして IP アドレスを誓瀋蠅垢訃豺腓寮説明世伝塚溺佶に記述されています。
ここで IP アドレスを使用するのは、isakmpd の
デフォルトの挙動でもあります。
d1070 9
a1078 4
Certpatch はまた、 FQDN (Fully Qualified Domain
Name) か UFQDN (User FQDN) の使用もサポートしています。FQDN の例は、たとえば
<tt>www.openbsd.org</tt> ですし、UFQDN の例としては
メールアドレスがあります。これはたとえば、<tt>Jorgen.Granstam@@abc.se</tt> などです。
d1081 1
a1081 4
この how to 文書では、 FQDN を
SubjectAltNames で使用していますが、IP アドレスを使用するほうがやや簡単になります。
それが isakmpd のデフォルトの挙動だ世蕕覆里任后
しかし、すぐにわかるように大した差ではありません。
d1084 1
a1084 1
FQDN SubjectAltName を証明製颪貌譴襪砲蓮
箟碓臆
箟碍甕碍倆跚笙蛹綵黶謐鞣闌蜒箟原甕原すると CA は、ユーザの証明製颪砲靴襪戮裙笏糟瘢拡張を
d1888 1
a1888 1
<h1>13.9 - isakmpd で使える IKE クライアントは ?</h1>
d1931 1
a1931 1
<h1>13.10 - IPsec/VPN のトラブルシューティング</h1>
d2050 1
a2050 1
<h1>13.11 - 関連ドキュメンテーション</h1>
d2124 1
a2124 1
Originally [OpenBSD: faq13.html,v 1.65 ]
d2126 1
a2126 1
$Translation: faq13.html,v 1.19 2003/02/20 06:32:59 toshi Exp $
d2128 1
a2128 1
$OpenBSD: faq13.html,v 1.65 2003/02/20 03:09:56 nick Exp $
@


1.18
log
@
sync with steelix translation CVS
@
text
@d4 1
a4 1
<title>13.0 - IPsec を使う</title>
d17 1
a17 1
<h1><font color="#e00000">13.0 - IPsec (IP Security Protocol) を使う</font></h1>
d2076 3
a2078 3
<a href= "index.html">[FAQ トップへ]</a>
<a href= "faq12.html">[12.0 - 高度なユーザ向け]</a>
<a href= "faq14.html">[14.0 - OpenBSD のハードディスク]</a>
d2087 1
a2087 1
Originally [OpenBSD: faq13.html,v 1.64 ]
d2089 1
a2089 1
$Translation: faq13.html,v 1.18 2003/02/19 00:12:40 toshi Exp $
d2091 1
a2091 1
$OpenBSD: faq13.html,v 1.64 2003/02/18 02:53:38 nick Exp $
@


1.17
log
@
sync with steelix translation CVS
@
text
@d411 1
a411 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&sektion=8">sysctl(8)</a>
d2087 1
a2087 1
Originally [OpenBSD: faq13.html,v 1.63 ]
d2089 1
a2089 1
$Translation: faq13.html,v 1.17 2003/01/14 10:22:14 toshi Exp $
d2091 1
a2091 1
$OpenBSD: faq13.html,v 1.63 2003/01/12 22:48:23 kjell Exp $
@


1.16
log
@
sync with steelix translation CVS, work by Toshihiko UEKI
@
text
@@


1.15
log
@
sync with steelix translation CVS
@
text
@d108 3
a110 3
理解しにくいようにしておきます。インターネット経由で
リモートのマシンにログインする際に、
他の人にはパスワードを知られたくありませんよね。
d124 7
a130 10
<h4>再送保護 (Replay protection)</h4> やり取りは、何度も繰り返すよう認められたもの以外は、
確実に一回だ世韻靴圓錣譴覆い茲Δ砲垢詈，廚任后弔泙蝓
誰かがやり取りを記録しておいて、
それをそのまま再送して、結果として同じ応答を何度も取得世垢襦△箸いΔ海箸任覆い茲Δ砲垢詆廚△襪里任后
たとえば、攻撃者が暗号クラック以外の他の手段でトラフィックの趣旨を取得世靴董
そしてそのトラフィックが、その人物にとって有利なイベントを誓犬犬気擦襪發里
しましょう (彼の口座にお金を振り込ませる等)。
その人物が、後から単純に同じトラフィックを再送しても
誓靴覆い茲Δ砲垢詆廚△襪里任后
守ぢ警告: 通常の仕様に関する限り、手動鍵の IPsec を使用している場合 (たとえば
d141 2
a142 2
新しいプロトコルを 2 つ使用します。そのプロトコルとは、AH (
Authentication header、認証ヘッダと ESP (Encapsulated security payload、暗号ペイロード) です。
d146 1
a146 1
ESP との主な差は、AH はパケットの
d148 2
a149 1
保護することです。
d158 3
a161 1

d392 3
a394 5
まず、OpenBSD カーネルの IP AH と IP ESP オプションを有効にします
(もし rc.vpn スクリプトを使用していたり、あるいは、この次の例のように、
ESP だ世韻鮖藩僂靴討い襪茲Δ幣豺腓砲蘊組ぢは有効にしなくて構いません</i>。
むしろ、使用してもいないのに AH を有効にすると、セキュリティ上の問題が
発誓犬垢襪眞里譴泙擦ぢ。
d396 4
a399 2
<p>
これらのプロトコルを有効にするための、すてきな sysctl があります。
d401 1
d403 2
a404 4
# <b>sysctl -w net.inet.esp.enable=1</b><br>
net.inet.esp.enable: 0 -&gt; 1<br>
# <b>sysctl -w net.inet.ah.enable=1</b><br>
net.inet.ah.enable: 0 -&gt; 1
d407 7
d415 1
a415 1
起動時にこれを実行させるには<tt>/etc/sysctl.conf</tt> を編集します。
d417 1
a417 1
net.inet.ah.enableの前の # を外し、それが 1 にセットされている
d421 7
a427 1
さらに手動鍵の誓言成も必要になります。
d432 1
a432 1
デバイスを使用する方法があります。たとえば、160 ビット分の乱数誓鮑鄒成するには、以下のようにします。
d435 1
a435 1
# <b>dd if=/dev/urandom bs=1024 count=1 | sha1</b>
d707 6
a712 14
残念ながら、サンプルファイルはデフォルトではありません。
これを入手するには、ソースツリーから
/usr/src/sbin/isakmpd/samples/VPN-east.conf および
/usr/src/sbin/isakmpd/samples/policy を取得世靴泙后
団詫当然ありますよね) からでも良いでしょうし、
<a href="http://www.openbsd.org/cgi-bin/cvsweb/">cvsweb</a> や
<a href="http://www.usa.openbsd.org/anoncvs.html">コマンドライン CVS
クライアント</a>を使用しても良いでしょう (cvsweb は
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/samples/VPN-east.conf">VPN-east.conf</a>
と
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/samples/policy">policy</a>
を用意しています)。この例で使用するのに、<i>policy</i> を
/etc/isakmpd/isakmpd.policy にコピーします。また、<i>VPN-east.conf</i> は /etc/isakmpd/isakmpd.conf
にコピーします。ここでは、VPN (トンネル) の誓瀋蠅了妬鮴説明世靴泙后
箏屋
畄桶
まず、esp を起動します。FAQ セクションの冒頭の <a href="#ManKey"> Manual Keying</a> で、
それぞれ実行時・起動時にこれを実行する方法を誓睫誓しています。次は /etc/isakmpd/isakmpd.policy を編集します。
d725 2
a726 2
この policy ファイルは、Encapsulate Security Payload (ESP) を使用してデータを送信してきて、
mekmitasdigoat というパスワード (これはあなたが自由に決めてくだ世気で認証された相手なら、
d755 1
a755 1
ホスト A では /etc/isakmpd/isakmpd.conf を編集します。見本に入っている 249.2.2.2 という IP アドレスは、
d1017 1
a1017 1
# <b>isakmpd -d -DA=99</b>
d1093 1
a1093 1
/etc/isakmpd/isakmpd.conf 誓瀋螢侫．ぅ襪鮓討澆泙靴腓Α
箟控甕控蜩瘠逅にデバッグをすべてつけるのでしたら、次のようにして実行します。
d1957 1
a1957 1
# <b>/sbin/isakmpd -d -DA=99</b>
d1962 1
a1962 1
# <b>/sbin/isakmpd -d -DA=99 -D1=70</b>
d2087 1
a2087 1
Originally [OpenBSD: faq13.html,v 1.62 ]
d2089 1
a2089 1
$Translation: faq13.html,v 1.16 2003/01/04 15:40:51 toshi Exp $
d2091 1
a2091 1
$OpenBSD: faq13.html,v 1.62 2003/01/01 13:01:59 nick Exp $
@


1.14
log
@
sync with badlands translation CVS
@
text
@d11 1
a11 1
<meta name= "copyright"     content= "This document copyright 2000-2002 by OpenBSD">
d2081 1
a2081 1
Originally [OpenBSD: faq13.html,v 1.61 ]
d2083 1
a2083 1
$Translation: faq13.html,v 1.15 2002/12/13 16:00:25 toshi Exp $
d2085 1
a2085 1
$OpenBSD: faq13.html,v 1.58 2002/07/12 02:51:35 nick Exp $
@


1.13
log
@
sync with badlands translation CVS
@
text
@d1 1
d6 1
a11 1
<meta http-equiv="Content-Type" content="text/html; charset=iso-2022-jp">
d17 1
a17 1
<h1><font color=#e00000>13.0 - IPsec (IP Security Protocol) を使う</font></h1>
d22 4
a25 4
<UL>
<li><a href="#What"     >13.1 - IPsecって何 ?</a>
<li><a href="#Why"      >13.2 - そりゃ結構だ世韻譴鼻△海里椶覆偕繝ぢなんか使わにゃならんの ?</a>
<li><a href="#Protocols">13.3 - IPsecの裏にあるプロトコルは?</a>
d30 1
a30 1
<li><a href="#x509"     >13.8 - isakmpd を X.509 証明製颪隼箸Δ砲鹿畩
箜甞鹿嫐箜甦柴闔皷就⊂
このドキュメントの一部は、以下のドキュメントからとっている:
<UL>
d46 2
a47 2
</UL>
</font>
d49 1
d53 2
a54 2
<h1>13.1 - IPsecってなに?</h1>
</p>
d56 10
a65 9
IPsec は、IP プロトコルファミリーに対する拡張だ澄
暗号セキュリティサービスを提供する。このサービスで、認証、
完全誓蜴苒蜚、アクセス誓罅〔性が提供される。IPsec は
SSL と似たサービスを、ネットワーク層で提供して、しかもアプリケーションにはまったく
透過的で、しかもずっと強力。透過的というのは、
アプリケーションのほうでは IPsec を使うのに、IPsec のことを何一つ知らなくていい、
ということだ澄
賓黼上では<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/protocols?rev=1.13">あらゆる IP プロトコル</a>を使える。暗号化トンネル (VPN) も作れるし、コンピュータ間で単純な暗号化をしてもいい。
オプションが実にいろいろあるせいで、IPsec はちょっとややこしいのである (それも SSL よりずっと!)
d68 2
a69 2
FAQ <a href="../faq6.html">6章</a> の推奨文献には
誓鵑箸睫椶鯆未靴討い討曚靴ぁＦ辰法△發アドレスの考え方がわかっていなかったら、
d73 13
a85 9
は大いにお奨めだ澄
斜論斥砲蓮賓黼は以下のどんな形でも機能する:
<UL>
<LI>Host-to-Host
<LI>Host-to-Network
<LI>Network-to-Network
</UL>
ネットワークのからむすべてのシナリオで、ぼくたちはルータを念頭においている。
d87 7
a93 6
トラフィックを誓罎靴動店羃修垢ぢ。
<P>
これから見るように、IPsec は VPN 誓楝獲僂縫肇薀侫奪鬟肇鵐優襪任襦
でも、その応用は VPN よりはるかに広い。中央インターネット鍵交換登録所があれば、
インターネット上の全マシンはお互いにやりとりをするときに、
強力な暗号や認証が使えるようになるんだ澄
箙畊取云嘘ぢそりゃ結構だ世韻譴鼻△海里椶覆偕繝なんか使わにゃならんの?</h1>
</p>
d101 4
a104 4
インターネットのプロトコルである IP または IPv4 は、それ自体としては、転送しているデータに対して何の保護も提供しない。
送り主が、自分で名乗っている通りの存在かどうかすら保証してくれない。
IPsec はこれを解決しようとする。以下のサービスはそれぞれ独立と考えられているけれど、
IPsec はそれを統一的な形でサポートしている。
d107 5
a111 4
<h4>機密誓鹿茣受信者以外の人には、どんなデータが通信されたかを
理解しにくいようにしておく。インターネット経由で
リモートのマシンにログインするとき、
ほかの人にパスワードを知られたくないよね。
d113 2
a114 2
<h4>完全誓侮苒蜚鹿茣データが途中で改竄されないようにする。
誓禅畚颯如璽燭鬟鵐薀ぅ鵑覗襪鵑覆蕁
箟蔚
甕臆
途中で改竄されたりしていないか確かめたいでしょう。
d124 5
a128 9
<h4>Authenticity (誓疑神性／確実誓款ぢデータに署名して、それを送ったのが本当にあなただ世搬召凌佑
確認できるようにする。ドキュメントがインチキじゃないと確認できるのは、
どう考えてもよいことだ澄
腫取款再送保護 (Replay protection)</h4> やりとりは、何度も繰り返すよう認められたもの以外は、
確実に一回だ世韻靴生じないようにする方法が必要だ澄弔泙蝓
だ世譴笋蠅箸蠅魑燭靴討い董
それをそのまま再送して、結果として同じ応答を何度ももらう、ということができないようにする必要がある。
たとえば、攻撃者が暗号クラック以外の手段でトラフィックの趣旨を他の方法でつきとめて、
d130 6
a135 6
しよう (かれの口座にお金を振り込むとか)。
その人物が、あとから単純に同じトラフィックを再送しても
うまくいかないようにする必要がある。
<i>警告: 通常の仕様に関する限り、手動鍵の IPsec を使っているとき 
(たとえば <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&amp;apropos=0&amp;sektion=8&amp;format=html">ipsecadm(8)</a> を使っているとき)
には再送からの保護は実行されない</i>.
d140 1
a140 2
<h1>13.3 - IPsec の裏にあるプロトコルは?</h1>
</p>
d144 5
a148 4
新しいプロトコルを 2 つ使う。このプロトコルは AH (
Authentication header, 認証ヘッダと ESP (Encapsulated security payload、暗号ペイロード) だ澄
斜組ぢは認証と完全誓蛤徳欷遒鯆鷆，垢が機密誓歪鷆，靴覆ぢ。
d150 4
a153 3
IP ヘッダ世琉貮たとえばパケットの発信元・送り誓茱▲疋譽も
保護することだ澄
斜箟亀
甕宜
提供する (ヘッダ世砲弔鼎僖吋奪汎發里垢戮討鯤欷遒垢ぢ。
再送保護は認証と完全誓廚誓
(この二つはいつもペアでくる)。機密誓暗号化) は、
認証/完全誓△辰討發覆討盪箸┐襦
同じように、認証・完全誓狼〔性なしでも使える。
a164 1
</p>
d166 2
a167 1
<p>   <B>認証ヘッダ装緕竅闔縺粤鬧鹿他
箟狭
甕群
識別情報を持っている。ハッシュは 
IP ヘッダ声里痢疏罎肪佑儔修靴覆ど皀弌爾任襦
組ぢに使う実際のアルゴリズムについては、いくつか別個の RFC があって選べるようになっているけれど、
そのどれも、<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC2402</a>に指定されたガイドラインには準拠していなくてはならない。
d174 3
a176 2
<P>The <B>暗号ペイロード (Encapsulating
Security Payload)</B> (ESP) ヘッダ世蓮▲撻ぅ蹇璽匹魄店羃修気譴新舛能颪垢┐襪海箸魏椎修砲垢襦
箟係
甕原
ヘッダ世楼靴錣覆い里如▲撻ぅ蹇璽桧奮阿里發里砲弔い討呂泙辰燭歉擇靴覆ぁ
それぞれ各種の ESP は <A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC2406</A>にしたがう必要がある。
ESP ヘッダ世蓮▲撻ぅ蹇璽匹稜Ь擇眥鷆，任が ESP の外の
ヘッダ世砲弔い討惑Ь擇任覆ぢ。

<P>IPsec 機能の (ほとんど) 独立した部分が、IPsec encapsulation を
やっているのがデータのもとの発信源かゲートウェイかに
応じて適用される:
d188 2
a189 2
<UL>
<LI><B>Transport</B> モードは、パケットを誓言成しているホストが使うものだ澄
箟恒甓憶弛嫩乂ぢのヘッダ世料阿法賓ヘッダ世僖吋奪箸寮先頭につけられる前の段階で追加される。
言世ご垢┐襪函▲僖吋奪箸膨媛辰気譴が
TCP ヘッダ世函緕筬鈔ヘッダ世琉貮凜侫璽襯匹離魯奪轡鵐阿鮹甘垢襪箸いΔ海箸誓。
そしてTCP ヘッダ世肇如璽燭琉店羃修嗤
ヘッダ世弌爾垢襪韻譴鼻△任發修譴鈔鎰緕賓ぢヘッダ世楼店羃修靴討譴覆ぁ鹿棉
写評実ぢトンネル</B> モードは、すでに end-to-end IP ヘッダ世
パケットに追加されているときで、さらにセキュア誓楝海諒卻涼爾
ただ世離押璽肇ΕДい里箸忙箸錣譴襦海離癲璽匹任蓮組ぢと ESP ヘッダ世蓮鈔鎰緕蒹痲纈ぢを含め
パケット全体をカバーするのに使われる。そしてセキュア誓楝海慮海γ爾泙任離曠奪廚里
ぢといっても、これはもちろん複数の IP ホップをまたがるかもしれないけれど) をカバーする、
新しい IP ヘッダ世弔韻覆気譴襦鹿棉鹿嫐
斜症偕繝ぢで保護されたリンクは、<B>Security Associations
</B>(SAs) によって定義づけられる。各 SA は単一の単方向のデータの流れについて定義されて、
普通は (マルチキャストは無視して) 一つの点世虔未療誓までについて、
なんらかの<B>ユニークなセレクタ</B>によって識別できるトラフィックフローをさす。単一の SA 上を流れるトラフィックはすべて
同じ扱いを受ける。トラフィックの中には、複数の SA を経るものもあって、
そのそれぞれがなんらかの変換を加える。SA の集団を
SA <B>Bundle</B> と呼ぶ。入ってくるパケットは、3 つの定義フィールド
(<B>宛誓アドレス, セキュリティパラメータインデックス (Security Parameter
Index), セキュリティプロトコル</B>)に応じて指定の SA に割り当てることができる。
セキュリティパラメータインデックス (Security Parameter
Index、略して SPI) は誓楝海離僖薀瓠璽燭離優乾轡─璽轡腑鵑圓錣譴襪箸法啻ぢの受け手が手渡すクッキーだ世隼廚┐个いぁ
セキュリティプロトコルは AH か ESP のどちらかでなくてはならない。受け手の IP
アドレスがこの３つ１組の中に含まれているので、これはユニークな値になることが保証されている。
これは外側の IP ヘッダ世藐弔韻襪海箸發任襪掘∈能蕕離札絅螢謄悒奪誓 (これは SPI とセキュリティプロトコルを含む) から見つけることもできる。
a222 1
<P>トンネルモードの AH パケットの例を挙げよう:
d226 2
a227 2
<td><B>IPヘッダ鹿他鹿儒箴実樵伴昭箴
箍慨
甓涯
斜浄鱇銖竟鶯ぢモード AH パケットの例を挙げよう:
d240 2
a241 2
<td><B>IPヘッダ鹿他鹿儒箴実樵伴昭箴
箍慣
甓軌
斜湘嗤ぢヘッダ世漏安Δヘッダ世鯒Ь擇任覆い里如
組ぢと ESP ヘッダ世鯀箸濆腓錣擦銅，里茲Δ砲靴燭曚Δい箍鬼
甓妓
儒箴実症ぢヘッダ鹿他鹿儒箴実樵伴昭箴
儒箴実湘嗤鹿他鹿儒箴蕊菖弛ヘッダ鹿評鹿儒箴蕊ぢデータ</I></td>
d262 3
a264 2
<P>これは <B>Transport Adjacency</B> と呼ばれる。トンネル版だ世
こんな感じだ箍狂
甓軍
儒箴実症ぢヘッダ鹿他鹿儒箴実樵伴昭箴
儒箴実湘嗤鹿他鹿儒箴蕊症ぢヘッダ下昭箴
儒箴蕊菖弛ヘッダ鹿評鹿儒箴蕊ぢデータ</I></td>
d277 7
a283 6
<P>でも、これは RFC には明声傍劼気譴討い覆ぁ夸瘤齔闥痲裃竇釿と同じように、これはIP ヘッダ世涼罎離悒奪誓いくつかを除いて全パケットを認証したうえで、
ペイロード (イタリクスで表示) を暗号化する。
AH と ESP ヘッダ世海里茲Δ膨樟接いっしょに適用されているときには、
ヘッダ世僚臠屬肋綉里茲Δ砲覆辰討い詆廚△襦肇鵐優襯癲璽匹任蓮
任意の recursive encapsulation をやることで、この順番が指定されずにすむようにすることもできる。
a288 1
</p>
d290 10
a299 28
<P>IPsec システムとゲートウェイがどう誓瀋蠅気譴襪蓮△△訥戮論設計者まかせに
なってはいるのだ世韻譴鼻△任特ぢはそれがどう実装されるべきかについて強いレコメンデーションを行って
混乱を最小限におさえようとしている。

<p>パケットに何が起こるかをコントロールする、管理エンティティが２つある。
一つは<B>Security Association Database</B> (SAD, 
OpenBSDの IPsecソースコードの中では、TDB または TDB table と呼ばれている) で、
もう一つは<B>Security Policy Database</B> (SPD)だ澄

斜ぢこの二つは、あるトラフィックを表現したセレクタをいくつか与えられると、
必要となる処理を記述したエントリを提供してくれるという点世濃討い襦
でもSPD は実際の処理から二段階ほど遠いところにある: 
SPD は外へ出るパケットに使われて、どの SAD エントリを使うべきか決めるのに利用される。
逆に SAD エントリは、実際のプロセスとそこで使うパラメータを記述する。
SPD のエントリは、既存の SAD エントリのうちどれを使うか
(バンドルなら、SAD エントリは複数あり得世襪里を指定するけれど、でもすでに
適誓擇覆發里覆い覆蕁△修離┘鵐肇蠅鮖箸辰匿靴靴い發里弔蕕譴襦弔蕕譴のフィールドは、
SPD エントリから持ってくる場合もあるし、そのフィールド新誓澆
開始させたパケットから持ってくる場合もある。

<P>　外行きのパケットは、SPD エントリから個別の SA に行ってエンコーディング用
パラメータをもらう。入ってくるパケットは、SPI/宛誓賓ぢプロトコルの 3 点瀬札奪箸鮖箸辰
直誓楡正しい SA にたどりつき、そこから SPD エントリにたどりつく。

<P>　SPD はまたどのトラフィックが IPsec をバイパスすべきか、またどのトラフィックを
捨てるべきかを指定できるので、入ってくる非 IPsec のトラフィックについても参照されなくてはならない。
SPD エントリは、順番が明声房┐気譴討い詆廚△襦△襯僖吋奪箸吠瑤里發里泪奪舛垢覯椎柔性があるし、
処理には再現誓覆討呂覆蕕覆い蕕誓。
d301 26
a326 2
<P>SPD というのは、パケットフィルタと似たようなものだ世隼廚┐个いい發靴譴覆ぁ修海之萃蠅気譴襯▲轡腑鵑箸いΔ里蓮
啻ぢプロセスの起動になるわけだ澄札譽燭箸靴道箸┐襪里
箜恩甞換
ぢこれは host based transport SAのみ)、ホスト名、セキュリティ
感度レベル、プロトコルなどだ澄
箜輝
甞鬼
斜肖祖ぢエントリに含まれるのはたとえば:
d356 7
a362 27
<UL>
<LI>宛誓アドレス
<LI>IPsec プロトコル(AH か ESP)
<LI>SPI (クッキー)
<LI>シーケンスカウンタ
<LI>Seq O/F フラグ
<LI>Anti-replay window info
<LI>AH の種類と情報
<LI>ESP の種類と情報
<LI>寿命情報
<LI>Tunnel/transport モードフラグ
<LI>Path MTU 情報
</UL>

<P>SPD エントリに含まれるのは:

<UL>
<LI>SA起動ポインタ
<LI>セレクタフィールド
</UL>

<P>各 SA は、ESP ヘッダ整譴弔ヘッダ整譴弔鯆蟲舛任襦
賓黼セッションはこのどちらか、あるいは両方を持たなきゃならない。どちらのヘッダ世發覆靴把蟲舛気譴襪海箸
できない――さもないと、SA を参照するための SPI を指定するヘッダ世覆い海箸砲覆辰討靴泙Α
卞は、AH とESP ヘッダ世佗ぢの値について
別々の指定をしている場合のことは定義していない。察するに、
これはバンドル中の複数の SA を意味するものと判断されるだ世蹐Α
箜挟
甞橋
斜章鞳鄲喞ぢの SPD は、<tt>ipsecadm flow</tt> コマンドを使って管理される
(これに変更を加えるのは、手動鍵誓瀋蠅鮖箸豺腓誓けだぢ。
d368 3
a370 3
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&apropos=0&sektion=8&format=html">ipsecadm(8)</a>を使えばマニュアルで誓瀋蠅任襪韻譴鼻
錨堝ぢはセッションや鍵交換の初期化などの
自動メカニズムも定義している。
d372 3
a374 3
(<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">RFC2407</a>、
<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC2408</A> ならびに
<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">RFC2409</A>)
d376 2
a377 2
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&apropos=0&sektion=8&format=html">isakmpd(8)</a>
デーモンで使われている。
d382 21
a402 17
<h1>13.6 - 手動鍵誓瀋蠅偕繝ぢを誓瀋蠅垢襪砲呂匹Δ垢襪深云
鹿霈
斜賓黼の手始めとしていちばんかんたんなのが手動鍵誓瀋蠅誓。
この手法でネットワーク間を暗号化して VPN をつくれる。
この部分を読んだ世蕁△海寮設定を
自動化するのに<A HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.3">/usr/share/ipsec/rc.vpn</a>
を使う、なんていうのもやってみるといいかもしれない。
<P>
まず、OpenBSDカーネルの IP AH と IP ESP オプションを有効にしよう
(もし rc.vpn スクリプトを使っていたり、あるいは
この次の例のように、ESP だ世韻鮖箸辰討い襪茲Δ幣豺腓砲蘊組ぢは有効にしないでいい。</i>それどころか、
使っていないのに AH を有効にするとセキュリティ上の問題が
発誓犬垢襪發靴譴覆ぢ。<P>
こういうプロトコルを有効にするための、すてきな sysctl がある。
<ul><tt>
# <b>sysctl -w net.inet.esp.enable=1</b><BR>
d406 17
a422 13
</tt></ul>
起動時にこれをたちあげるには<tt>/etc/sysctl.conf</tt> を編集すればいい。
使いたいものに応じてnet.inet.esp.enable そして/あるいは
net.inet.ah.enableの前の # をはずし、それが 1 にセットされている
ことを確かめよう。
<P>
さらに手動鍵の誓言成も必要だ澄
嶄のセキュリティは、この鍵を推定するのが不可能だ世箸いε誓にかかっているので、
この鍵を選ぶのには強力な乱数源を使うのがとてもだ世い犬誓。
これを誓言成するのに実用誓發な，琉譴弔箸靴董
質凖峠∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈鱇鈔闕繼闔輯闥轣蔗迪⊂鱇鈔闕┫デバイスを使う手がある。たとえば160ビット分の乱数誓鬚弔蠅誓すには、以下のようにする:
<UL><tt>
d424 6
a429 3
</TT></UL>
誓言成されるビット数はだ世い犬誓。暗号の種類によって、必要な鍵のサイズがちがう。
<PRE>
d436 17
a452 16
</PRE>
<P>
では、SA (Security Associations) の誓瀋蠅鬚靴茲Α
嚆笊鱸齠閭蛛闔ぢというのは、IP アドレス、SPI, 
セキュリティプロトコル (AH そして/または ESP) の組み合わせだ澄賓ぢアドレスは、あなた自身のものと、
送り誓茲里發領省誓。SPI (Security Parameter
Index) は各種 SA の分類に OpenBSD が使う番号だ澄
斜蕊ぢこれらの例は、トラフィックの暗号化に ESP しか使わない。ESP は
暗号化された中身のデータの認証はするけれど、AH とはちがって
それを包む IP ヘッダ世惑Ь擇靴討譴覆ぁ海痢峺造蕕譴診Ь據廚蓮
それでもほとんどの場合にはまったく十分なものだ澄Ｆ辰縫肇鵐優覺超任
途の場合には。</I>
<P>
<ul>
<tt>
d455 10
a464 9
</tt>
</ul>
<P>
これを二つのルータで実際にやってみよう。ルータの IP アドレスはそれぞれ 192.168.5.1 と 192.168.25.9 だ澄
斜ホスト192.168.5.1 上では:
<UL>
<TT>
# <b>ipsecadm new esp -spi 1000 -src 192.168.5.1 -dst 192.168.25.9 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b><BR>
d466 3
a468 2
</TT>
</UL>
d470 3
a472 3
<UL>
<TT>
# <b>ipsecadm new esp -spi 1001 -src 192.168.25.9 -dst 192.168.5.1 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b><BR>
d474 14
a487 10
</TT>
</UL>
<P>
ごらんのように、SPI がちがっている。SPI が何で、それがどこで使われているかについての完全な誓睫誓は、<A HREF="#13.4">On the wire format</a> を参照。
<P>
これで Security Associations ができあがったので、
フローを誓瀋蠅靴茲Α
斜まずは 192.168.5.1 から:<P>
さてここでいきなり、フローが<b>2つ</b>創られる。一つはローカルのソースアドレスで、
d489 38
a526 32
もう一つのフローは送り誓茲薀蹇璽襯曠好箸北瓩辰討
フローだ澄
受貍
儒
錫冗頌繝痲肚阯頏阡纉齡慌狂貴韈旭粐厩荻蔚軒貴乙貴乙貴乙貴乙厩荻蔚軒乙亀亀亀亀鹿眈
鹿昭貍
厩荻蔚軒乙側ではこんな具合だ受貍
儒
錫冗頌繝痲肚阯頏阡纉齡慌狂齔碓葦
粐厩荻蔚軒乙亀亀亀亀慌狂亀亀亀亀鹿眈
鹿昭貍
斜もし Host-to-Host VPN のオーバーヘッドを減らしたければ、SPI
を作るのに <tt>-forcetunnel</tt> をはずしておくと、transport モードが使える (<tt>-forcetunnel</tt>
を使うと IP ヘッダ世泙粘泙鵑誓 IP パケットのすべてが必ずSPIにカプセル化
される)。もし
発信元か送り誓茲里匹舛蕕優奪肇錙璽覆蕁▲肇鵐優襯癲璽匹鮖箸Δ靴覆ぁ
ネットワークから出入りするトラフィックに SA を使うと、自動的に
トンネルモードの SPI が確実に作られることになる。
<p>
これはIPsecを使い始める簡単なやりかただ澄
斜賓黼を使えば、プライベート IP アドレス空間をインターネットごしにつなげる。
いい例を挙げよう……208.1.1.1の背後にある 192.168.99.0/24 と、
208.2.2.2の背後にある 208.1.5.0/24 と 208.1.2.0/24 をトンネルでつなげたいとしよう。
以下の例は <A HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.3">rc.vpn</a> スクリプトを使って誓言成したものだ澄
斜ごらんのとおり、IPsecで手動鍵誓瀋蠅鮖箸辰討い襪函
やってほしいことを<b>ずばり誓騎里鹿眈指定しなきゃダ瀬瓩誓。
あなたのかわりに見当をつけてくれたりはしない。以下の例をみてごらん……
d528 4
a531 3
まず、security associations (SA) を誓瀋蠅靴茲瑳岱ぢこれで SPI, 暗号化の方法と鍵が誓瀋蠅気譴
謝名儒
箋慨
甬街
鹿昭貍
次に、208.1.1.1 から 208.2.2.2へのフローを誓瀋蝓
受貍儒
箋官甬騎
鹿昭貍
次に  208.2.2.2の背後にある208.1.2.0/24 から 192.168.99.0/24へのフローを誓瀋蝓
受貍儒
錫冗頌繝痲肚阯頏阡纉齡宛齔碓葦痲糅慌狂庚乙貴乙貴乙貴屋軒窺荻乙貴乙貴乙貴絢昭岱鹿昭貍
次に 208.2.2.2の背後にある 208.1.5.0/24 から 192.168.99.0/24へのフローを誓瀋蝓
受貍儒
箋亀
甬彊
鹿昭貍
こんどは 208.2.2.2の背後にある 208.1.2.0/24 からルータ 208.1.1.1へのフローを誓瀋蝓
受貍儒埔
箋恐
甬況
鹿昭貍
オッケー、では 208.2.2.2の背後の 208.1.5.0/24 からルータ 208.1.1.1へのフローを誓瀋
受貍儒
箋狭
甬郡
鹿昭貍
最後に、ルータ 208.2.2.2 から 192.168.99.0/24へのフローを誓瀋蠅靴茲
受貍儒
箋袈
甬鹸
鹿昭貍
斜取仮屋軒荻荻ぢ側では:</h2>
前と同じように、まずは SAの誓瀋蠅蕁帖
受貍儒
箋厳
甬抗
鹿昭貍
さてこっちは裏返しになるので……
ルータ 208.2.2.2 から 208.1.1.1へのフローを誓瀋蝓
受貍儒
箋控
甼旭
鹿昭貍
屋軒窺窺ぢの背後にあるネットワーク 192.168.99.0/24 から 208.1.2.0/24へのフローを誓瀋蝓
受貍儒
箒芦
甼扱
鹿昭貍
屋軒窺窺ぢの背後にあるネットワーク 192.168.99.0/24 から 208.1.5.0/24へのフローを誓瀋蝓
受貍儒
箒姐
甼唄
鹿昭貍
では208.1.1.1の背後の 192.169.99.0/24 からルータ 208.2.2.2へのフローを誓瀋蝓
受貍儒
箒蔚
甼桶
鹿昭貍
はーい、もうすぐおしまいですよー……
208.1.2.0/24 と 208.1.5.0/24 をルータ 208.2.2.2から 208.1.1.1まで届けるのに、
あとフロー2つだ世院
受貍儒
箒俺
甼害
鹿昭貍
斜蜷黼竅粱ぢを使っていて、自分のやった作業をぜんぶご破算にして
一からやりなおしたければ、次のようにする：
<ul><tt>
d634 5
a638 2
</tt></ul>
これですべての IPsec 情報 (SPI、フロー、ルーティングのエントリ) がシステムから一掃される。
d642 27
a668 21
<h1>13.7 - isakmpdの誓瀋蠅鹿莟鹿霈
腫蕉侘をはじめ IPsec の各種伝統的なアプリケーションを考えているなら、
たぶん ISAKMP を使うことになる。IPsec の商業実装の
一部は、手動鍵誓瀋蠅鬚気擦討譴覆い里如
なんらかの形の ISAKMP を使うしかなくなる。
<P>

<h3>13.7.1 - isakmpdってなに?</h3> ISAKMP (ときどき IKE, 
Internet Key Exchange、インターネット鍵交換、自動鍵交換とも呼ばれる) は VPN 用の鍵交換メカニズムだ澄
卞牡扱卞牡宛、RFC 2409に記述された手法を使ってセキュリティ上の問題をクリアしている。
ISAKMP は、通常なら <a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&apropos=0&sektion=8">ipsecadm(8)</a>
を使わなくてはならないような暗号家具のやりとりを管理してくれる。
二つの IPsec ノード間で IPsec パラメータを確立するために、
二段階プロセスを採用している。

<P> <b>フェーズ 1</b> - ISAKMP ピア２つは、保護され認証されたチャネルを確立し、
２つのデーモン間で通信ができるようにする。これは
両ホスト間で Security Association (SA) を確立する。このチャネルを確立するための手法は、<b>Main
Mode</b> と <b>Aggressive Mode</b> だ澄
箒薫畄旭特定の順番で送り、アイデンティティの保護を提供する。Aggressive Mode は
アイデンティティ保護は提供しない。認証情報を
すべて一気に送るからだ澄燥苒纉皷閼を使うのは、
ネットワークの帯域幅が狭いときだ世韻砲靴燭曚Δいぁ
斜
錫ぢフェーズ 2</b> - Security Associations が IPsec にかわってネゴされる。
フェーズ 2 は IPsec ホスト間にトンネルか endpoint SA を確立する。
フェーズ 2 では <b>Quick Mode</b> が使われる。フェーズ 1 ですでに SA が確立しているので、
完全な認証をくり返さなくていいからだ澄

斜
手短にいえば、フェーズ 1 は保護されたチャネルを確保するのに使われて、そこで
(もっと手早い) フェーズ 2 の誓瀋蠅圓錣譴襦Ｆ韻献侫А璽ぢチャネルの中で、複数のフェーズ 2 誓瀋蠅
することもある。フェーズ 2 は実際のトンネルを誓瀋蠅垢襪里忙箸錣譴襦
フェーズ 1 では IPsec ノード同士が誓楝海魍領靴
認証を交換する (X.509 証明世
事前に共有した秘密)。これで両端とも、相手が認証されたことを
確認できる。フェーズ 2 は鍵の交換で、両者の間のデータが
どう暗号化されるかを決める。

<h3>13.7.2 - isakmpdことはじめ</h3>

<P>
デフォルトで OpenBSD は ISAKMP と
IPsec スタック用のバイナリがついてくる。残念ながら、
サンプルファイルはデフォルトではない。これを手に入れるには、ソースツリーから以下のものを取ってこよう:
/usr/src/sbin/isakmpd/samples/VPN-east.conf and
/usr/src/sbin/isakmpd/samples/policy
CD-ROM (当然持ってるよね) からでもいいし、<A
href="http://www.openbsd.org/cgi-bin/cvsweb/">cvsweb</a> や
d702 25
a726 25
クライアント</a>. を使ってもいい (Cvsweb は <a
href="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/samples/VPN-east.conf">VPN-east.conf</a>
と <a
href="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/samples/policy">policy</a>
を用意してある)。この例で使うには、<i>policy</i>
を /etc/isakmpd/isakmpd.policy にコピーしよう。<i>VPN-east.conf</i> は /etc/isakmpd/isakmpd.confにコピーする。
ここでは、VPN (トンネル) の誓瀋蠅了妬鮴説明世靴討澆襦發
蜩瘠逅を個別ホスト間で使いたければ、<i>samples</i> ディレクトリにそれ用のサンプルが
入っている。
man ページに詳しい情報があるので、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&sektion=5">isakmpd.conf(5)</a> と
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a> をお忘れなく。

<p>
まずは esp の起動からだ澄徳セクションの頭のところの <a href="#ManKey">
Manual Keying</a> で、これを実行時・起動時にそれぞれやる方法を誓睫誓している。
次に /etc/isakmpd/isakmpd.policy の編集だ澄
このファイルは ISAKMP に、だ世譴偕繝ぢにアクセスできるかを教える。このシナリオでは、この policy ファイルは、
Encapsulate Security Payload(ESP) を使ってデータを送ってきて、mekmitasdigoat というパスワード (これはあなたが
勝手に決めればいい) で認証された相手なら、だ世譴任黶謐鞣ぢと通信できると述べている。このファイルをを変更して、
特定のデジタル証明製颪能靆召気譴織如璽燭誓けを認めるとか、特定の暗号変換を使ったデータだ世韻鯒Г瓩襪箸
希望をISAKMPに伝えられる。まただ世譴任偕繝ぢが使えるようにしてもいい。これはテスト用だ世韻砲靴討里召泙靴ぁ
万人にアクセスさせるには、policy ファイルを編集して以下だ世韻砲靴茲実匸
謝名斜凖箏温畄蓋
鹿侑転鹿嫐斜同じ policy ファイルには $ のついた行が二行ある。
使う前にこの２行は削除すること。CVS でしか使わない。
<P>
この例で、もっと使い物になる policy ファイルはこんな感じだ実匸謝名斜凖箏患
畄軌
鹿頏緇鹿嫐これを実装すれば、ESP だ世韻鮖箸辰心靄榲侘トンネル) ができあがる。
ホスト A では /etc/isakmpd/isakmpd.conf を編集する。見本で入っている249.2.2.2 という IP アドレスは、
ホスト A の実際の外部 IP アドレスに書き換えること。
d752 1
a752 1
<UL><PRE>
d757 1
a757 1
</PRE></UL>
d759 3
a761 2
同じようなことをホスト B の isakmpd.conf でもやろう。249.3.3.3 は
ホスト B の外部 IP アドレスだ澄
箏恭
畄恭
謝名斜凖箏狂
畄狂
鹿侑転鹿嫐箏薫
畄袈
腫ぢここで isakmpd のおもなふるまいを決める変数を誓瀋蠅任襦海海任
デフォルトを使っておけばいい。
<b>Listen-on</b>= value は、isakmpd が聞き耳をたてるべき IP 
を指定する。あなたのゲートウェイのインターネット IP だ世韻廚誓。
ゲートウェイに複数の外部インターフェースがあるなら、
コンマで区誓擇辰唇賤措阿覇呂靴董△匹離ぅ鵐拭璽侫А璽垢鯆阿い討曚靴い賤砲任襦
斜次にホスト A で、もう一度isakmpd.conf を編集しよう。
d778 4
a781 1
<UL><PRE>
d784 1
a784 1
</PRE></UL>
d786 2
a787 1
ホスト Bでは:
d789 1
a789 1
<UL><PRE>
d792 7
a798 1
</PRE></UL>
a799 4
<p>この部分は、フェーズ 1 誓楝海離優乾轡─璽轡腑鵑鬚垢襪箸房栄佞韻襪戮アドレスを記述する。
ここでの値は下の部分を指している (フェーズ 1 は単にリモートのピアを認証して、
それが主張通りの相手だ世罰稜Г垢襪誓けなのをお忘れなく)。
IP_Address=<i> &lt;PEER-NAME&gt;</i>という形式で複数のピアを記述できる。
d801 3
a803 2
次にホスト Aでは:
<UL><PRE>
d806 1
a806 1
</PRE></UL>
d808 2
a809 1
ホスト Bでは:
d811 1
a811 1
<UL><PRE>
d814 12
a825 1
</PRE></UL>
d827 7
a833 2
<p>これは誓楝海離侫А璽ぢを記述したもの。このフェーズは、通信に両
ピアが使うプロトコルを決めるところだ澄
筝概
畍概腫菖蒹眈衷銕繝闔鷦晶瘍ぢは、その下のセクションをさす。
フェーズ 2 を誓瀋蠅垢襪燭瓩房影譴蕕譴襯瓮愁奪匹簍弖錣鬟ぅ縫轡─璽箸垢襦海譴呂泙拭
いったん開始したらどの誓楝海鬟ぅ縫轡─璽箸垢戮瓶阻熔に告げる。
複数のピアホストにつなぐつもりなら、
以下のように複数のセクションを書いてもいいことに注意。

<p>リモートホストの IP アドレスがわからなければ、 <b>Connections</b>= tag に
挙がっていない IP からの誓楝海濃仮箸気譴襦突僖┘鵐肇蠅鬚△襯札轡腑鵑傍劼靴討い董
それを Default= で指定するようにすればいい。
<P>
ホスト Aでは:
<UL><PRE>
d844 1
a844 1
</PRE></UL>
d846 2
a847 1
ホスト Bでは:
d849 1
a849 1
<UL><PRE>
d858 6
a863 1
</PRE></UL>
a864 3
これらは上で誓睫誓したフェーズ 1 の部分で参照されているセクションだ澄修譴召
フェーズ 2 に進むためにピアのゲートウェイが満足しなければならない要件を記述している。ほかにもオプションは
たくさんあるけれど、上に挙げたものは最低限必要なものだ澄
筝橋畍弘殊蘊錫笑葹黼襲ぢが必要なのは、 ISAKMPD コードがフェーズ 1 とフェーズ 2 を処理するのに同じプロシージャを使うからだ澄
これを <b>1</b> にしないと、何一つ機能しなくなる。
<li><b>Transport= </b> は、ピアごとにちがう可能誓△襦海海任
を使うことにしてあるので、そういうことにしておこう。
一部のピアはファイアーウォールの背後にあって、UDP トラフィックを通さない場合があることに注意。これは当然ながら、誓瀋蠢阿乏稜Г靴討廚△襦
殊蘊錫礁閭瘡粐鱚齠ぢは入ってくるパケットが指す目的アドレスだ澄０貮瑤離院璽垢任蓮
フェーズ 1 の誓楝海里燭瓩膨阿ぅ鵐拭璽侫А璽垢舛辰討い襪發靴譴覆ぁ
この例では、インターフェースは一つしかないので、このピアで聞き耳をたてる
インターフェースの IP がそれになる。
<li><b>Address= </b>は、入ってくるパケットのソースIP。これはピアゲートウェイを
指すのがふつう。
ここはもっと誓睫誓が必要。ピアの発信する IP アドレスは事前にわからないことがあるから。
<li><b>Configuration= </b>は、下のセクションを指す。ここでやったような形で
複数のセクションを指定できる。ここではサンプルファイルにあった
デフォルト値を使おう。
<li><b>Authentication=</b> は、このピアが使うはずの、
事前に共有してある秘密。このパスワードが policy に渡されて、
このピアがこのホストと IPsec を使っていいことになっているかを確認する。ここのパスワードを変えたら、
policy ファイルでの記述も変える必要がある。sample ファイルがこのパスワードに応じて提供されるからだ澄
最低限の policy ファイルで行くつもりなら、ここでは好きなものを指定すればいい。
<li><b>Flags=</b> はいまは使われていない。RFC では、フェーズ 1 用の追加オプションを指定するための予備として
これを残している。
<p>ほかのオプションを指定するためのタグもたくさんある。詳しくは
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&apropos=0&sektion=5&format=html">isakmpd.conf(5)</a>
を参照。
d892 5
a896 3
<P>
ホスト Aでは:
<UL><PRE>
d903 1
a903 1
</PRE></UL>
d905 4
a908 2
ホスト Bでは:
<UL><PRE>
d915 6
a920 1
</PRE></UL>
a921 3
<p>これらは、上記のフェーズ2で参照されているセクションをあらわしている。これは
個別の誓楝海里燭瓩法鵑弔離押璽肇ΕДご屬馬辰鬚垢襪里啻僕伉ぢが使うべき
個別誓瀋蠅覆里誓。
d923 5
a927 5
<li><b>Phase=2</b> は必須。ISAKMPD コードは、フェーズ 1 と
フェーズ 2 の認証に同じ関数を使うから。これがないと VPN は機能しない。
<li><b>ISAKMPD-Peer=</b> は、上でのホストのセクションの名前だ澄弔泙螢侫А璽ぢ誓楝海魍領垢襪燭瓩法
ここで指定したピアと話をしているんですよ、という意味だ澄海譴△襪里蓮黶謐ピアや誓楝海魑劼垢襪里
複数のセクションがある場合もあるからだ澄
箙温
畊温
したがうべき規格を記述した部分をさす。
d931 7
a937 7
記述した、以下の IPsec-ID セクションを指す。この部分が送られて、向こう側のゲートウェイがVPN経由で
こちらのネットワークにデータを転送するためのルーティングテーブルをきちんと誓瀋蠅任襪茲Δ砲垢襦
殊蘊錫紹纃阡絖苗充これは、こちらのホストから見て、リモートのプライベートネットワークで
あるはずのものを記述した、下のIPsec-ID セクションを記述しているこの部分が解釈されて、こちらのプライベートネットワークから
VPN経由でリモートのプライベートネットワークにデータを転送するためのルーティングテーブルをきちんと誓瀋蠅垢襦
腫ぢここでサポートされているタグがもう一つあって、それが Flags= だ澄海離織阿廚覆
釈鱚羹∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜩瘠逅筮竢鈕頏關闢衆繼闔週闥轣蔗迪⊂蜩瘠逅筮竢鈕┻ぢを読んでほしい。
d939 8
a946 6
<P>
ここはIPsec-ID セクションだ澄０焚爾離┘鵐肇蠅蓮▲曠好ぢとホストBの
両方で isakmpd.conf ファイルの中になければいけない。この例だ世
ホストA (これは上の Net-Aに
つながっている) では 192.168.1.0/255.255.255.0 、ホストB (これは上の Net-Bにつながっている) では192.168.20.0/255.255.255.0 だ澄
謝名斜凖箙偽
畊偽
鹿侑転鹿嫐箙妓
畊恐
腫ぢこの二つのセクションが各ホストの <b>conf</b> ファイルに含まれている。これが
<b>Local-ID</b> と <b>Remote-ID</b>の識別しで参照されるセクションだ澄０譴弔
プライベートネットワークから、別のプライベートネットワークへのトラフィックを可能にするのに誓瀋蠅気譴襪戮佻筏劼靴討い襦
錫症牒鞳鹿眈は <b>IPV4_ADDR_SUBNET</b> か <b>IPV4_ADDR</b>がとれる (RFC2708 にはほかにも有効な値があがっている。OpenBSDの実装ではいまのところIPv4 しかサポートされていない。IPv6 は、OpenBSD-current でサポートされているかもしれない)。
d964 4
a967 3
<P>
　これで両方のホストで、sample ファイルはこんな具合になっているはずだ謝名斜凖箙群
畊群
鹿侑転鹿嫐箙郡畊鹸このセクションはフェーズ 1 誓楝海濃箸Π店翳阿陵弖錣魑劼靴討い襦Ｌ樵阿
守消闔肅苺鱇闔充変数のとる値を反映している。ごらんのとおり、
Domain of Interest (DOI) を IPSEC として記述した。<b>EXCHANGE_TYPE</b> 変数は、フェーズ 1 では <b>ID_PROT</b> に誓瀋蠅靴討△襦
これはこの認証でカバーされるプロトコルを指定している。
<b>Transforms=</b> はこのやりとりで必要とされる (または指定される) 暗号変換方式だ澄海領磴任蓮
これは誓瀋螢侫．ぅ襪硫爾離札轡腑鵑鬚気靴討い董△修海任蓮△錣譴錣譴劃途で暗号化されていて
SHAで確認できるチェックサムを持つパケットを受け取る、と書いてある。
サンプルの<b>VPN-east.conf</b>には、いろいろ変換方式が山ほどかいてある。なぜかというと 3DES や SHA は各種プラットホームで必ずしもサポートされいる
わけではないからだ澄緕帯の場合、これを基本的な誓瀋蠅琶僂┐襪戮海脇辰砲覆ぁ海離札轡腑鵑鬟灰圈爾靴栃儡絞阿鯤僂┐襪里蓮
ぞんぶんにやってほしい。唯一、必要になるのは、 Configuration= 変数も変えることだ澄
箙原
畊原
謝名斜凖箙恒
畊恒
鹿侑転鹿嫐箙抗甕旭碓
腫ぢこのセクションは、VPN経由で送られるデータの暗号の要件を記述するところで、
上の <i>Configuration</i> で参照される。このセクションと、
すぐ上のフェーズ 1 でここに相当するところとのちがいは、 <b>EXCHANGE_TYPE</b> が <b>QUICK_MODE</b>になっていることなのに注目。
フェーズ 2 では必ずこうなる。
<b>Suites=</b> は IPsec Suite セクションを指している。
両ホスト間で提供されている各種の暗号方式を記述したものだ澄
瓶阻熔ぢと IPsec については、ほかにも誓睫誓することがいっぱいある。いまの基本的な誓睫誓をもとに、
自立してやっていける単純ながらも堅牢なVPNができる。
でもこれは、両ホストにとって<i>必要最低最小限の</i> 
<b>isakmpd.conf</b> でしかない。
d1006 14
a1019 10
最初にこのデーモンを走らせるときには、以下のコマンドを使おう：
<P>
<ul>
<tt># <b>isakmpd -d -DA=99</b></tt>
</ul>
<P>
デーモンはデーモンモードでは走らず、ふつうのプロセスとして
走る。そしてすべてをターミナルに出力する。isakmpdを止めて
経路を一掃するには、各ノードでisakmpd プロセスを殺してから
<b>ipsecadm flush</b>を実行しよう。
d1023 7
a1029 7
<h1>13.8 - isakmpd を X.509 証明製颪箸い辰靴腓忙箸Δ砲深云
鹿霈
斜事前に共有した鍵のかわりに証明製颪鮖箸Δ茲Δ黶謐鞣ぢを誓瀋蠅垢襪里蓮∧欷遒気譴討い覆ぅ團△燭気鵑△覽霏腑優奪肇錙璽両豺腓砲蓮
小さなネットワークにくらべてそんなにむずかしくない。むしろ誓瀋蠅蔽韻砲覆辰董△気蕕暴斗廚覆海箸箸靴
鍵管理も簡単になるかもしれない。
<P>
d1033 2
a1034 1
鍵や証明製颪寮生誓了妬砲弔い討里茲さ劼蜩瘠逅箟鯵甕鯵ファイルに書いてある。必要なのは
d1039 3
a1041 2
証明製顱▲優奪肇錙璽紊黶謐鞣ぢを使うコンピュータそれぞれに秘密鍵一つと、その秘密鍵のそれぞれに対して X.509
証明製餔譴弔困弔誓。
d1044 1
a1044 1
(SubjectAltName) extension が必要だ澄斂誓書の SubjectAltName extension を
d1046 4
a1049 3
SubjectAltNameとしてIPアドレスを誓瀋蠅垢訃豺腓寮説明世伝塚溺佶に書いてある。
ここで IP アドレスを使うのは、isakmpd の
デフォルトのふるまいでもある。
d1052 10
a1061 8
Name) か UFQDN (User FQDN) の使用もサポートしている。FQDN の例はたとえば
<tt>www.openbsd.org</tt> だ世掘嫺冂の例としては
メールアドレスがある。たとえば <tt>Jorgen.Granstam@@abc.se</tt> など。
<p>
この howto 文書では、 FQDN を
SubjectAltNames で使う。IP アドレスを使うほうがちょっと簡単になる。
それが isakmpd のデフォルトのふるまいだ世蕕誓。
でも、すぐにわかるように大した差ではない。
d1064 6
a1069 1
こんな感じにすればいい：
d1071 17
a1087 18
<UL><TT>
$ <b>/usr/sbin/certpatch -t fqdn -i home.mysite.se -k ca.key originalcert.crt newcert.crt</b>
</TT></UL>
ここで ca.key は CA の秘密鍵なので、これが
できるのは CA 秘密鍵にアクセスできる人だ世韻誓。
home.mysite.se というのは (実在はしないけれど) 証明製颪冒淨気譴襪戮冂だ澄
闥蜃蜴瘡竇鶯鶯ぢと newcert.crt のファイル名は同じ名前にしてもいい。
この場合、もとのファイルは新しい変更済みの証明製颪
上書きされる。
<p>
この鍵と証明製颪髻凖祖妖防ぢの最後に誓睫誓にしたがってディレクトリに
放り込もう。もし本気で鍵を使うつもりなら、CA 鍵 (ca.key) は
どこか安全なところにしまっておこう。


<h2>isakmpdの誓瀋鹿莢
こんどは /etc/isakmpd/isakmpd.conf 誓瀋螢侫．ぅ襪鮓討笋蹐Α
箟宛甕姐釈鱚羹∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜩瘠逅筮竢鈕繼闔週⊂蜩瘠逅筮竢鈕┻のサンプルファイルから取ったものだ世韻譴鼻△覆蟒颪垢┐討△襦
箟姐甕姐ものよりもかなり短いファイルを使う。さらにコメントも追加して
 (一部のコメントは isakmpd.conf(5)にあったまま)、名前もちょっと変えた。
ここで使ったドメイン名は、ぼくの知る限りでは一つも実在していない。
<p>
実はこれを読む人はみんな、すでに事前共有鍵についてまともに動く
誓瀋蠅鮖辰討い襪里前の誓瓩鮖仮このファイルでも
目新しいところはあまりない。だ世蕕海譴蓮∩管戮棒説明世靴燭蠅呂靴覆ぁ
ぼくが誓睫誓しない部分については isakmpd.conf(5) を
見てほしい。
d1097 6
a1102 1
全体の構誓呂海鵑粉兇犬誓としようか。
d1104 1
d1106 1
d1119 11
a1129 10
要するに、二つのネットワークが、保護されていないネットワーク上を、IPsecトンネル経由で
誓楝海気譴襦△箸いΔ海函海海妊廛薀ぅ戞璽肇ぅ鵐拭璽優奪藩僂僕縮鵑気譴賓
アドレス (RFC1918) を使っていることは無視してほしい。
なにかしら例は必要だ世辰燭發鵑如蜩瘠逅を NAT
と組み合わせて使うとかその手のをどうするかは誓睫誓しない(ぼく自身やったことがないから)。
<p>
では誓瀋螢侫．ぅ襪鮓討笋蹐Α０焚爾蓮
セキュリティゲートウェイ gw.mysite.se用のファイルだ謝名
腫鱚箟嘘甕嘘逋皷蜩瘠逅筮竢鈕のはじまり       ************
d1158 1
a1158 1
# tunnel, more sectionnames would be added (and of course corresponding 
d1204 2
a1205 2
# ここで記述されたネットワーク上のコンピュータから発せられた
# パケットで... 
d1211 3
a1213 3
# ... 以下の記述とマッチする目的地を
# 持ったものは、暗号化されて
# IPsecトンネル経由でリモートシステムに転送される。
d1219 1
a1219 1
# Main mode の記述
d1236 1
a1236 1
# be in the CA-directory (but not the CA private key ofcourse).
d1315 2
a1316 2
</pre>
</UL>
d1318 6
a1323 7
ここまではローカルシステム用の誓瀋蝓螢癲璽肇轡好謄爐
誓瀋蠅發泙辰燭韻犬誓けれど、裏返しになる。だ世蕕舛Δ里
蜩瘠逅筮竢鈕ぢファイルの頭のところだ世韻誓。
セキュリティゲートウェイgw.worksite.seの isakmpd.conf ファイルの頭のところだ世姥討笋蹐腫謝名
腫鱚箟害甕害鳬皷蜩瘠逅筮竢鈕ぢのはじまり    **********
d1360 1
a1360 1
# **********************     ... つづく...      **********************
d1362 2
a1363 5
</pre>
</UL>
<p>
あまりむずかしくはなかったね。ただ斉匹爐里呂舛腓辰搬犇誓ったかもしれないけれど。次の部分は、
もうちょっとおもしろくなる。
d1365 2
a1370 5
実をいえば、policy ファイルは初めての人にはちょっとややこしいかもしれない。
特に思い通りに動かないときには。man-ページ
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a>
は、実はそんなに悪くない。ところどころ
はっきりしないところがあるけれど、全体としてはいい。
d1372 6
a1377 2
一番簡単な、ちゃんと機能する policy ファイルは
たった一行だ箟碍甕蓋謝名
腫鱚箟蓋甕蓋鹿頏緇
鹿嫐箟蓋鰻
甕完鰻
これは要するに、だ世譴接続していいかについて、ポリシー上の誓鵑呂覆砲發覆ぁ
ということだ澄誓からあまりセキュリティの高い誓瀋蠅任呂覆ぁ海海
癜闥蝴纈ぢタグは、policy を決める権限を持った人物、
ということだ澄Ｆ段蓖鱸である&quot;POLICY&quot; は、
policy について最終的かつ無限の権限を持つ。それ以外の authorizer は、
ここで権限を持つためにはまず &quot;POLICY&quot; に認定してもらわなければならない。
<p>
さらに何が許されるかについて、条件群があるかもしれない。
以下の policy はだ世蕁∨槓琉店罎魏燭箸辰嗤
プロトコルを使用した人だ世韻蠅気譴襪箸いΔ海箸誓 (本物といってもまあ、
これだ世途ぢを使っている人も認められて、DES は
いまやほとんどインチキと思ってもいいくらいだ世韻譴鼻△任途ぢを認めないように
この policy を変更するのは、読者の練習問題として残しておこうか)。
これだ世途で暗号化する人ならだ世譴任眷Г瓩蕕譴襪海箸肪躇奸
腫謝名
腫鱚箟完甕官鹿頏緇
鹿嫐箟官甕官さらに権限をだ世譴召梁減複数でも
いい) に「サブライセンス」することもできる。簡単なケースとしては、事前共有鍵の
場合だ澄海両豺隋∋阿剖ν気譴織僖好錙璽匹鮹里辰討い訖佑呂垢戮
認められる。だ世蕁
腫謝名
腫鱚箟寛甕寛鹿頏緇
鹿嫐箟寛甕寛これはこのパスワードを知って条件にマッチした人すべてに
誓楝海鯒Г瓩ただ世靴海離僖好錙璽匹黶跋鞣闔の Authentication タグでも
誓瀋蠅靴討里鬚困譴覆ぢ。
<p>
ここまでは何もむずかしくない。こっからがおもしろいところ。まず、
ライセンスを受ける存在はたくさんあってもいいけれど、そのすべてが &quot;POLICY&quot;に認定されなくてはならない。
さらに認定されたライセンス保持者は、他のライセンス保持者にサブライセンスを出せる。
ライセンス保持者は、policyファイルでさらに記述されていたら
単なるストリングでもいい:
d1431 7
a1437 2
<UL>
<pre>
d1449 2
a1450 2
</pre>
</UL>
d1452 7
a1458 8
さあみなさんお待ちかねの部分。Policy はまた、
鍵にサブライセンスしたり権限委譲したりできる。この場合の鍵は、ふつうは
X.509 証明製颪誓。証明製颪魎蔽韻忙箸Δ砲蓮
それをパスワードがわりに使うことだ澄
竟跚笙ぢファイルに個別ユーザの証明製颪魏辰┐襪誓けでいい:
<p>
<UL>
<pre>
d1465 1
a1465 1
        CzA           この部分はユーザ証明製颪任瓦兇い泙垢叢殿箟慣甕慣鹿頏緇
鹿嫐箟慣甕慣さて、ユーザの数が多ければ、このやり方がばかげているのはすぐわかる。
d1481 5
a1485 6
ディレクトリから読んでくる証明製颪函▲團△藾蕕譴討訃斂誓書は、
疑似資格証明竰繖緕瘡鶇ぢに変換される。こうした疑似資格証明世吠儡垢気譴疹斂誓書は、
こんな感じになっている:
<p>
<UL>
<pre>
d1489 2
a1490 2
    	CzA  この部分はユーザ証明製つまりCA証明製に署名した     AQEB\
        BQA             　人の公開鍵／証明製颪任垢付箟軌甕軌丁ぢここんとこは証明製颪鮗韻訛Δ慮阿法囘腿
耐ぢなります                       IUuz\
d1509 2
a1510 2
</pre>
</UL>
d1512 9
a1520 10
さて、これらが &quot;POLICY&quot; に認められたものではないので、
それをなんらかの形で認知する policy がなければダ瀬瓩誓ということに注意。さらに、これは
内部で証明製颪匹Δ覆辰討い襪鮴説明世靴討い襦紊了餝幣斂誓 (credential) は、
policy ファイルの中では見られない。でも、そういう資格証明世
サブライセンスは出せる。上のサブライセンス発行を思いだ世靴討曚靴ぁ△譴鮖箸┐弌
蛋証明製颪鬟薀ぅ札鵐垢箸靴髟阡姉鰐秒戲髟阡ぢに書いてやれば、
ある CA が署名した証明製颪垢戮討縫薀ぅ札鵐垢个擦襦
腫謝名
腫鱚箟飢甕飢丁この部分が CA 証明製颪任瓦兇い泙垢叢殿箟騎姥
甕亀鹿頏緇
鹿嫐箟亀甕偽屋
つまり上の policy は、CA に権限委譲する policy の簡単な例だ澄
この証明製颪鮖辰が署名した証明製颪鮖辰討い
竟跚笙ぢと誓瀋螢侫．ぅ襪寮設定したほかの条件にも
したがっているユーザはすべて認められる。
<p>

<h2>ほとんど安全……は安全に非ず!</h2>

さて、本当に安全を期するなら、これでは残念ながら十分ではないのだ澄
こういう誓瀋蠅離札絅螢謄押璽肇ΕДい鮃況發垢詈，△襦
もし細々した話がいらないなら、いますぐ次の誓瓩泙波瑤个修Α
それ以外の人たちは、なぜこれが安全でないかを理解してみようではないの。
むずかしくはないよ。
<p>
この段階で、isakmpds がどんな情報にアクセスできるか考えてほしい。
誓瀋螢侫．ぅ襪蕁蜩瘠逅はピアがどの IP-アドレスから
送信してくるかわかる ([フェーズ 1] セクションで)。フェーズ 1 の
ネゴシエーションをするときに得世蕕譴訃霾鵑蕁▲團△匹鵑を
出してくるかわかって、ピアからの証明製颪鬚發蕕辰燭蕕修譴妊團△榲
そのIDを持っていることが証明世気譴襦Ｌ簑蠅覆気修Δ誓ね?
d1565 2
a1566 2
うん、もしID 情報が IP なら (フェーズ 1 の ID セクションを使わなければ
これがデフォルトに状況になる) すべてはオッケーだ澄蛋
箟偽甕儀だ世韻派彎霾鵑呂垢戮討修蹐Α覆蠅垢泙携箸△曚離灰鵐團紂璽燭
同じ IP を使うことも不可能ではない
(たとえば両方のコンピュータが同じ LAN 上にあって、
ふだ世鵑修を使っているマシンがなんらかの理由でダ瀬Ε鵑靴討い襪覆ぢ。
でも、なりすまし犯が、証明製颪箸修譴紡弍垢詒詭阿鮖辰董
箟儀甕儀不可能なはずだ澄
箟儀欝
甕宜欝
もしそれが万が一起こったら、そのなりすまし犯はそのIPの所有者から秘密鍵を
どうにかして盗んだ世△△襪いをなんらかの方法でだ世泙靴董
にせの情報を含んだ西斂誓書を発行させたかのどちらかだ澄
もしこのいずれかが起こったなら、
秘密鍵の保護が不十分だ世辰燭蛋ぢが
なりすまし犯の身元 (あるいは cert の
ID 情報) を十分にチェックできなかったか、あるいは CA 秘密鍵が十分に保護されていなかったかだ澄
これらはすべて、そもそもセキュリティがまともに機能する前提なので、
こういう状況は誓簑个傍海辰討呂い韻覆ぁ

腫さてぼくたちの例では状況がちがう。ここでは
証明製颪涼罎法賓アドレスではなく FQDN が入っている。
[Phase 1] セクションにまだアドレスがあるので、
これはセキュリティ問題となる可能誓△襦瓶阻熔
箟宜輝
甕挟憾
期待どおりの IP から送られてきたことをチェックできる (でもさっき誓睫誓したように、
これは一部の状況ではごまかせる)。ピアが提示するIDを、
本当にそのピアが持っていることもチェックできる。
でも、いまチェックできないのは、そのID が本当にそのピアが持っていると期待すべき ID なのか、ということだ澄
蜩瘠逅は、どんな ID を期待すればいいか一度も教わっていないからだ澄
腫栂システムがホストのために IP を FQDN と
結びつけてくれる、という人もいるだ世蹐Α修譴呂修Δ覆鵑誓けれど、現在の DNS システムはセキュリティが高くないし、
だ世泙靴討砲擦両霾鵑鮟个気擦襪海箸癲⊂豺腓砲茲辰討
できる (あるいはサービス拒否 (DoS) 攻撃を
攻撃者に受けて、その攻撃者のマシンがDNSサーバの答を
偽造することもできる)。いずれ高セキュリティ DNS も登場するけれど、
まだ製于鵑辰討い覆い少なくともほとんどの DNS サーバはまだ盛皀札絅螢謄任呂覆ぢ、
だ世藐什漾竇鶯ぢの FQDN が期待される IP と対応しているかを調べるのに
DNS を使っても保証にはならない。実は isakmpd はこれを DNS にきいたりしない。
DNS が安全でも、UFQDNを使っている場合には
これをチェックできない。
<p>
つまり ID として FQDN を使う場合、アタッカーは
自分の秘密鍵を用意して、それをわれわれの使うのと
同じ CA に署名させる (でももちろんアタッカー自身の FQDN を使って)。それから
ピアに DoS 攻撃をしかけてダ瀬Ε鵑気擦実は
ISAKMP プロトコル自体に欠陥があって、ピアに対して
リモートDoS を仕掛けてダ瀬Ε鵑気擦討靴泙┐覯椎柔性があるけれど、
isakmpd がこういう攻撃に対してどのくらい敏感かは知らない)。それから
アタッカーは自分のコンピュータをわれわれのピアと同じように誓瀋蠅靴董
ピアのネットワークにつないで
自分のIDと秘密鍵と証明製颪鮖箸┐襦
腫ぼくたち側の isakmpd は、こっちのピアへの ID が何かを教わっていない (そしてそれは、アタッカーが
証明製颪苗と秘密鍵以外はまったく同じ誓瀋蠅砲靴討い燭ぢ。さらにぼくたちの
isakmpd は証明製颪韻のサインしたものだ世肇船Д奪任でも
多くの CA はcert をいっぱいサインするから、cert を手に入れるのはむずかしくないかも)。そして
そこで示された ID が証明製颪涼罎といっしょなのも確認できる。でも、
これまで提示された誓瀋蠅任蓮△修が期
待していた ID かどうかはチェックできない。だ世薀▲織奪爾論接続を認められてしまう。
<p>

<h3>攻撃をふせぐ</h3>

すると問題は、どうやったら isakmpd に期待すべき ID のことを教えてあげられるか、
ということだ澄△蠅燭い海箸砲海譴牢蔽韻如
釈鱚羹∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜩瘠逅筮竟跚笙繼闔週⊂蜩瘠逅筮竟跚笙┻ぢにも誓睫誓されている。
policy内でチェックをかけなきゃいけないのだ澄
たとえばこんなふうに:
<p>
<UL>
<pre>
d1650 1
a1650 1
        CzA             この部分が CA 証明製颪任瓦兇い泙垢叢殿箟橋甕橋鹿頏緇
鹿嫐箟橋甕橋これで、IPsec誓楝海鯑誓られるのは gw.worksite.se だ世韻里呂此
かに remote_idのチェックを足せば、許可されるIDは簡単に増える。
つまり以下のようなのを policy に足せばいい:
<p>
<UL>
<pre>
d1675 2
a1676 2
</pre>
</UL>
d1678 2
a1679 2
この policy だ世函范闥謫蜚絎黼范闕纉蜚絎黼、
gw.whatsite.se のいずれも誓楝海任襦
箟狂甕狭竟跚笙ぢに証明製餞櫃瓦抜泙瓩覆討呂覆蕕覆い里六椎亜
という人もいるだ世蹐Α斂誓書を policy に
入るような形式になおすのは手間だ世掘
竟跚笙ぢも読みにくくなる。だ世譴泙舛辰董
ややこしい policy のなかで、CA 証明製颪箸泙舛┐
ユーザ証明製颪鯑譴討靴泙辰燭蕁造里覆ぅ罅璽兇
誓楝海Г瓩蕕譴討靴泙Δ發靴譴此△気蕕忘い辰燭海箸法
竟跚笙ぢファイルを見てもそれをつきとめるのはむずかしい (X.509 証明製颪
人間に読める形ではないから)。
d1693 6
a1698 6
さて、本当にカリカリの最誓菽爾凌佑燭舛砲蓮
この問題の解決方法がある。いまでは、policy 内で証明製颪修里發里里錣蠅法
証明製颪堤齡蜴苺蜩蒹令辣栂を使うことができる (対応する
証明製颪呂發舛蹐鵐妊好紊纈
か ca ディレクトリにあって、isakmpd が見つけられるようになっていること)。この
形式だ世函⊂紊闌蜒は以下のような感じになるだ世蹐箟薫甕薫腫謝名
腫鱚箟訓甕訓鹿頏緇
鹿嫐箟訓甕訓ずっと読みやすい、でしょ？　ある証明製颪寮正確な DN
は、openssl ユーティリティを使って証明製颪鮓討笋襪箸錣襦
こんな具合:
<p>
<UL><tt>
d1720 2
a1721 1
</tt></UL>
d1723 4
a1726 3
もっと複雑な policy はもちろんできるけれど、
これはとりあえず入門だ世掘⊆，寮節で別の例を見て
やることになる。
d1729 3
a1731 3
提供されるはずだ澄竟跚笙ぢが小さいか、そこそこくらいなら
これでもいいだ世蹐Α任盖霏腓淵汽ぅ箸農接続ユーザが山ほどいるなら、
これでもまだ世泙誓だ澄
甕軍屡仮マルチユーザ誓瀋蠅函羆浜診Ь鹿莢箟軍甕軍それじゃ isakmpd のホントにクールな機能をいくつか見てやろう。これまでは、
誓楝海靴討襪呂困離團△呂茲里蕕譴討い董賓アドレスも誓電妨把蠅気譴討い襪發里箸靴拭
でも、そういう場合ばかりじゃない。動的に割り当てられたIPを使ったり、
コンピュータを何台も使ったりする人は多い。あるいは (サーバ
なんかだ世誓楝海靴燭い里誓れなのか、はっきりわからないこともある。
d1737 6
a1742 4
そこでisakmpdのすてきな機能の一つは、
[Phase 1]セクションでIPではなくデフォルトのタグを使えるというもの。
これによって、isakmpdはどのIPからでもネゴシエーションを受け付けられるようになる。
これはこんな感じになる：
d1744 6
a1749 2
<UL>
<pre>
d1752 8
a1759 2
</pre>
</UL>
d1761 9
a1769 15
まず言世辰討戮覆里蓮△海寮設定はDoS攻撃に対して
安全ではないかもしれないということ。まえにも言世辰燭茲Δ法
瓶阻熔謀プロトコルには欠陥がある。いずれにしても、デフォルトの [phase 1] セクションを使えば、
一種の「認証証明製顱廚僂錣蠅忙箸┐襪茲Δ砲覆襦
腫たとえば権限を持つユーザはたくさんいるけれど、
でも誰でもいいからうけつける、というわけではない場合を考えてみよう。たとえば会社なんかの場合。
会社の従業員は誓楝海気擦燭い韻譴鼻△修谿奮阿凌佑砲論接続してほしくない。さて、
大企業で社員が何誓蘓佑發い襪箸靴茲Α譴蕕
どのコンピュータからでも (社内LAN上のものに限らず) 誓楝海任襪茲Δ砲靴燭い韻譴鼻
全員がなんでもできるようにはしたくない。この場合、
次のようなpolicy が書けるはずだ澄
斜謝名
腫鱚箟鍵甕鍵鹿頏緇鹿嫐箟鍵碓
甕険臼

これは厳密に誓気靴い匹Δ呂錣蕕鵝椶里觚造蝓
こいつはまったくテストしていない (だ世蕕海離侫襯疹魴錣蓮△椶了廚つ未蠅砲
ぜんぜん動かないかもしれない)。それと、こいつみたいなpolicy  (というか、
デフォルトがピアのIPにしてあるものすべて) は、isakmpd.confファイルもあわせて書き換えないと
ダ瀬瓩誓。これには、セキュリティ上の問題もついてまわる。さらに、
だ世譴任眄接続できるようになっているこの種の誓楝海任蓮
たぶん誓楝海靴真佑はすべてログしておいたほうが
望ましい。isakmpd はぼくの知る限りでは、これをまだ瀬汽檗璽箸靴討い覆ぁ気蕕
この可能誓砲呂戮弔離札絅螢謄紊量簑蠅弔い討襪發靴譴覆ぁ覆砲△辰討癲
だ世譴眄責任はとってくれないので、覚悟して進むように。でも基本的な考え方はもうはっきりしているはずだ澄
箟険甕顕
いまのが持っている、実におもしろい可能誓忙廚づ燭蕕覆た佑い襪肇▲譴誓から、念のため誓睫誓しておこう、
もしこういう形でISAKMP/IKE を使っているコンピュータがすべて、
リモートからユーザが使いたいと思っているサービスのそれぞれについて、条件の束を持っていたとしよう。すると CA は、
ユーザの証明製颪砲靴襪戮裙笏糟瘢纔銖蜿を入れておくだ世韻任修離罅璽兇稜Ь擇任襦気蕕法△修Δい斂誓書の有効期限を
d1824 18
a1841 7
しておく。もしユーザが権限を悪用するなら、
証明製颪鮑独圓靴覆い茲Δ砲垢譴弌⇒存紊脇辰討海蕕譴覆ぁ
社員が一人やめたくらいで、
すべてのコンピュータ上のpolicyファイルを変える必要もない。
同じ方式はISAKMP/IPsec 以外の目的にも使えるはずだオフラインシステムの認証さえできる！)。
ただ世靴修両豺腓砲脇段未淵愁侫箸廚砲覆襪韻譴鼻
とにかく。これをやる組織はおそらく自分で自分自身のCAになったほうがいい。
d1844 8
d1853 10
a1862 8
こういうマルチユーザ誓瀋モバイルユーザ) は、
事前共有鍵でもできうけれど、でもそれだ世函△匹賓から誓楝海靴討襪錣蕕覆い蕁
苗をもとに誓気靴ぅ僖好錙璽匹戮襪茲Δ砲覆辰討い詆廚△襦
だ世苗瀰厦ぢモードではなくAGGRESSIVE モードを
使わなくてはならない(AGGRESSIVE モードでは、IDはネゴシエーションの
初期の段階で送られるけれど、暗号化されないで送られる。だ世
素拝途喇崚ぢモードのほうがメッセージ交換が少なくてすむので、高速だ世韻譴鼻
苗がナマのままで送られるからちょっとセキュリティは下がる)。
d1865 20
a1884 37
<a name= "IKEcl"></a>
<h1>13.9 - isakmpdで使えるIKE クライアントは ?</h1>
</a>
<P>
<tt>isakmpd</tt> は、OpenBSD についてくる ISAKMP/Oakley 鍵管理デーモンだ澄
たぶん、ほとんどの ISAKMP 実装とは、部分的にせよ相互運用可能だ世隼廚Δ韻譴鼻
実際にテストされたのは以下のものだ澄于鵑辰討い
蜩瘠逅ぢソフトの一部は、実は OpenBSD isakmp デーモンをベースにしたものだ世辰燭蠅垢襦
斜以下の MS-Windows クライアントは、互換誓△襪箸諒鷙陲△謝名
次棉昭蓿繙就蔗痕蜊纉隰竢躁⊂夂辣囈辮鹿畩賭揺坏柱蜈銓
写評釈鱚羹∵雕竢蹼竢躁⊂蒼蓐纖癜鱚銓鹿畩价闕侘ぢソフトウェア
<LI><a href="http://www.radguard.com/">Radguard</a> cIPro クライアント
<LI><a href="http://www.cisco.com/">Cisco</a> IRE クライアント
<LI><a href="http://www.microsoft.com">Microsoft</a> Windows 2000、XP
</UL>
<P>
以下のゲートウェイ/ルータも互換誓△襪箸諒鷙謝名
写評釈鱚羹∵雕竕黹鎬竢躁⊂忠黹鐚貧写評釈鱚羹∵雕竕黹鎬竢躁⊂忠黹鐚佗写評釈鱚羹∵雕蜴谺竢躁⊂侮貅戻醪阮纈
次棉昭蓿繙就蔗痕蜊纉隰竢躁⊂夂辣囈辮鹿畩賭揺坏煤
写評釈鱚羹∵雕竇鈔蜿闕消緕粡鐚弐繚写評釈鱚羹∵雕諱辣續硝鼠甜肬汝繞帯写評釈鱚羹∵雕玩跛豁鱚纉遲⊂汝繞哢彖亮肬也銛写評釈鱚羹∵雕齷轣銓繝闕肖瘤禺听頸闥
写評釈鱚羹∵雕纈蜒齠闔闕湘鱸笂齒郤綢陂
写評釈鱚羹∵雕罩黼笊鱚闕焼繝綣嶄掠
写評釈鱚羹∵雕瘢鱚闕菖縺逞癇綣墸瓶写評釈鱚羹∵雕潟闕闕廠竢躰倚碯蛹粤写評釈鱚羹∵雕鈿鶯繻鈬闥謫闕称闥貅衷銓蝟蜚写評釈鱚羹∵雕竏繝謳濶銓闕消蒹站倆蜴惇
写評釈鱚羹∵雕蒟鰾闕衝癆竏苺癇篌鍋鱚硼鰭写評釈鱚羹∵雕跿竇銓闕礁緕巣竇齠濶銓
鹿嫐箟幻屋
甕弘取云嘘夸阨碎纉蓖阡蜴賓黼祚嶄亮云
鹿霈
箟弘甕恒憶
賓黼トラブルシューティングの最初のツールは <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&apropos=0&sektion=8&format=html">tcpdump(8)</a>だ澄
儒鞣霄ぢを使っていくつか探すべきものを挙げると：
<P>
まずOpenBSDの tcpdump を使っている人は、
拡張版の tcpdump を使っているので、
ESP と AH パケットについても情報がとれる。もし OpenBSD
2.5 や他の OS の tcpdump を使っているなら、たぶん古い
バージョンだ世や ESPについてはプロトコル番号しか表示されない
(ESP は IP プロトコル 50, AH は 51)。
<UL>
<P>
<LI>
tcpdump では、トラフィックが AH/ESP を使っているか平文のままかを確かめよう。
平文のままなら、フローがちゃんと誓瀋蠅気譴討い覆い
蜩瘠逅ぢのネゴシエーションがうまくいっていない。<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&apropos=0&sektion=8&format=html">ping(8)</a>を使って
簡単なトラフィックを発誓犬気擦討澆茲Α
斜謝名
たとえば、208.1.1.1 と 208.2.2.2 の２つのホストがある。
208.2.2.2 にログオンして、以下をやってみよう:
<PRE>
d1920 4
a1923 3
</PRE>
別のセッションでは、encapsulated されたpingが見られる:
<PRE>
d1934 5
a1938 6
</PRE>
</ul>
<P>
<LI>ISAKMP はUDP port 500で実行される。もしこれがファイアーウォールか
パケットフィルタでロックアウトされていたら、これを変えること！
<UL><PRE>
d1946 5
a1950 6
</PRE></UL>
<P>
<LI>
isakmpd にデバッグを全部つけるなら、次のようにして実行しよう：
<P>
<UL><TT>
d1952 4
a1955 4
</TT></UL><P>
あるいは (いちばん詳しいタイマーデバッグ情報をとばすには)
<P>
<UL><TT>
d1957 5
a1961 5
</TT></UL>
<P>
<LI>IPsecで処理されたトラフィックを、netBから自分のローカルのファイアーウォール保護つきnetAに
入れるようにしてやる必要がある。
<UL><PRE>
d1964 7
a1970 8
</PRE></UL>
<P>
<LI>OpenBSD の tcpdump だ世函△曚箸鵑匹離ぅ鵐拭璽優奪
鍵交換 (自動鍵交換) セッションの平文部分はほとんどデコードできる。Tcpdump はまた AH ペイロードデータも表示する。
<P>
<LI>/kern ファイルシステムをマウントしよう (もしすでにデフォルトで使っていないなら)：
<P>
<UL><TT>
d1972 2
a1973 2
</TT></UL>
<P>
d1975 6
a1980 6
(外行きの SA) もないもの (入ってくる SA) も記述されている。
またどんなトラフィックがどこへ行っているのかしらべられる、トラフィックカウンタも
ある。
<P>
<LI>最後に、 <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=netstat&apropos=0&sektion=1&format=html">netstat(1)</a> を使って SAを見ることができる。
<UL><PRE>
d1994 10
a2003 9
</PRE></UL>
<P>
<LI>
これだ世韻笋辰討皀誓メなら、<tt>option ENCDEBUG</tt>つきでカーネルをコンパイルしなおすこと。
それから <tt>net.inet.ip.encdebug</tt> を 1 にする。そして dmesg を見て
警告やエラーをさがし、それを <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendbug&apropos=0&sektion=1&format=html">sendbug(1)</a>を使って
OpenBSD デベロッパーに報告しよう。 あるいはもしそれが
バグかどうかわからなかったら、<A HREF="../../ja/mail.html">メーリングリスト</a>のどれかにメッセージを投げてみよう。
</UL>
d2008 14
a2021 1
</p>
a2022 12
IPsec が特に詳しく誓睫誓してあるのは
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&apropos=0&sektion=0&format=html">vpn(8)</a>
ページだ澄３銅錣寮設定テンプレートが <A HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/">/usr/share/ipsec/</a>
ディレクトリにあるので役にたつだ世蹐Α
釈鱚羹∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈緕礒黼謾蜿扈刈上釿┫宵
釈鱚羹∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜷黼礒黼謾蜿扈刈冗頌繝┫宵
釈鱚羹∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜷黼竅粱繼闔集⊂蜷黼竅粱┯宵
釈鱚羹∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜩瘠逅筅黼謾蜿扈権冗黶謐鞣┯宵
釈鱚羹∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜩瘠逅筮竢鈕繼闔週⊂蜩瘠逅筮竢鈕┻瘤釈鱚羹∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜩瘠逅筮竟跚笙繼闔週⊂蜩瘠逅筮竟跚笙┻のmanページも詳しくて、IPsecの誓瀋蠅髪人僂北鯲弔呂困誓。
<P>
d2024 10
a2033 8
<UL>
<LI><a href="http://www.ietf.org/html.charters/ipsec-charter.html">IETF IPsec Working Group</a>
<LI><a href="http://isakmp-test.ssh.fi/">SSH IPsec interoperability Test Node</a>
<LI><a href="http://ipsec-wit.antd.nist.gov/">NIST IPsec Web Based Interoperability Tester</a>
<LI><a href="http://www.r4k.net/ipsec/">A port of OpenBSD's IPsec to FreeBSD</a>
<LI><a href="http://www.xs4all.nl/~freeswan/">FreeS/WAN - IPsec for Linux</a>
<LI><a href="http://www.pintday.org/hack/docs/vpn-24-minifaq.shtml">OpenBSD 2.4 VPN Configuration Mini-FAQ</a>
</UL>
d2035 32
a2066 30
<A name="rfc">
そしてつづきましては RFCども...</a>
<UL>
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1320.html">RFC 1320</a> - The MD4 Message-Digest Algorithm
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1321.html">RFC 1321</a> - The MD5 Message-Digest Algorithm
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1828.html">RFC 1828</a> - IP Authentication using Keyed MD5
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1829.html">RFC 1829</a> - The ESP DES-CBC Transform
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2040.html">RFC 2040</a> - The RC5, RC5-CBC, RC5-CBC-Pad, and RC5-CTS Algorithms
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2085.html">RFC 2085</a> - HMAC-MD5 IP Authentication with Replay Prevention
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2104.html">RFC 2104</a> - HMAC: Keyed-Hashing for Message Authentication
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2144.html">RFC 2144</a> - The CAST-128 Encryption Algorithm 
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2202.html">RFC 2202</a> - Test Cases for HMAC-MD5 and HMAC-SHA-1 
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2207.html">RFC 2207</a> - RSVP Extensions for IPsec Data Flows
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2268.html">RFC 2268</a> - A Description of the RC2 Encryption Algorithm 
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2367.html">RFC 2367</a> - PF_KEY Key Management API, Version 2
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2401.html">RFC 2401</a> - Security Architecture for the Internet Protocol (<b>IPsec</b>)
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC 2402</A> - IP Authentication Header (<b>AH</b>)
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2403.html">RFC 2403</A> - The Use of HMAC-MD5-96 within ESP and AH
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2404.html">RFC 2404</A> - The Use of HMAC-SHA-1-96 within ESP and AH
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2405.html">RFC 2405</A> - The ESP DES-CBC Cipher Algorithm With Explicit IV
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC 2406</A> - IP Encapsulating Security Payload (<b>ESP</b>)
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">RFC 2407</A> - The Internet IP Security Domain of Interpretation for ISAKMP
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC 2408</A> - Internet Security Association and Key Management Protocol (<b>ISAKMP</b>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">RFC 2409</A> - The Internet Key Exchange (<b>IKE</b>)
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2410.html">RFC 2410</A> - The NULL Encryption Algorithm and Its Use With IPsec (ha ha...)
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2411.html">RFC 2411</A> - IP Security Document Roadmap
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2412.html">RFC 2412</A> - The OAKLEY Key Determination Protocol
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2451.html">RFC 2451</a> - The ESP CBC-Mode Cipher Algorithms
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2631.html">RFC 2631</a> - Diffie-Hellman Key Agreement Method
<LI><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2709.html">RFC 2709</a> - Security Model with Tunnel-mode IPsec for NAT Domains
d2074 1
d2081 1
a2081 1
Originally [OpenBSD: faq13.html,v 1.60 ]
d2083 1
a2083 1
$Translation: faq13.html,v 1.14 2002/11/03 12:23:12 toshi Exp $
d2087 1
a2087 1
</p>
@


1.12
log
@
sync with badlands translation CVS
@
text
@d1725 2
a1726 1
<li><a href="http://www.watchguard.com/">Watchguard</a> Firebox III
d1919 1
a1919 1
Originally [OpenBSD: faq13.html,v 1.59 ]
d1921 1
a1921 1
$Translation: faq13.html,v 1.13 2002/09/27 13:32:11 toshi Exp $
@


1.11
log
@
sync with badlands translation CVS
@
text
@d339 3
a341 5
OpenBSD は Photuris (<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2522.html">RFC2522</a>および
<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2523.html">RFC2523</a>)
と ISAKMP 自動鍵交換
(<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">RFC2407</a>,
<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC2408,</A> and
d343 2
a344 3
を実装していて、それぞれ
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=photurisd&apropos=0&sektion=8&format=html">photurisd(8)</a>
と <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&apropos=0&sektion=8&format=html">isakmpd(8)</a>
d614 1
a614 1
次に /etc/isakmpd.policy の編集だ澄
甕係臼
写評俶阡蜩ぢは UDP port 468 で動く。考えるのは同じことだ世韻譴鼻▲廛蹈肇灰襪ぢだ澄
謝名斜凖倚齠蜴蜴蓖鱸瘋肅胙闕蒹繝蜚艨
鞜齠闔絨鳫粽鳫艨竟鶯狂艨竟鶯狂
鞜齠鈬頏阡胙闕癆纓鮮害闥感癆纓俗害闥感
倚齠蜴蜴釿鴒頸繖鱇聿蜒鳫黼笊鱸癆纓癨鞜齠頏阡瘉鳫艨癆纓鮮害
鞜齠鳫胙闕癆纓鮮害艨鹿侑転鹿嫐斜甕元釈鱚羹∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈韆阡蜩筅黼謾蜿扈権情蓖鱸黻┯宵
釈鱚羹∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈齡癇纖繼闔襲⊂齡癇纖┗宵
甕弘写評釈鱚羹∵雕竕鶤闊蜿糒蜴聶聶乙臆譬紹特飢下俶阡蜩嚆齠蜿遶妹浴釶艱辣銓鳫竢写評釈鱚羹∵雕竕鶤闊蜿糒蜴聶聶乙桶譬紹特飢骸俶阡蜩祷鈔繖竏纃纉鈔鱸碯箟恒甕恒蜃蜴瘡踟緕帯頂瘻嘘讙窺妓
箟慌甕慌ぴ鱇銖赱闔聲餘凱蔗迪屋芦君嘘浦梓佐鼈祷

窺碓
跫齷釿蜚矚粲瘤糂鱇銖赱闔嶝

絶厩涯
甕抗蜃蜴瘡踟緕帯頂瘻嘘讙窺儀
箟抗甕抗ぴ鱇銖赱闔聲餘凱蔗迪屋芦君宛該完叉鼈祷箟拘甕拘は鞳鄲喞聲餘凱蔗迪屋芦君扱浦妓魂鉗站


窺跫挽楊跂瘤

絶臆甞渦
写評釈鱚羹■怦癆庄凱賓黼ぢって何?</A></LI>
<LI><a href="#Why"      >13.2 - そりゃ結構だ世韻譴鼻△海里椶覆偕繝ぢなんか使わにゃならんの?</A></LI>
<LI><a href="#Protocols">13.3 - IPsecの裏にあるプロトコルは?</A>
<LI><a href="#Wire"     >13.4 - ネットワーク上のパケットフォーマット</A>
<LI><a href="#Config"   >13.5 - IPsec の誓瀋鹿曽
写評釈鱚羹■浴酲纖庄凱賓黼を手動鍵誓瀋蠅濃箸Δ砲深写評釈鱚羹■俶阡蜩庄凱韆阡蜩のセットアップは?</A>
<LI><a href="#isakmpd"  >13.8 - isakmpd のセットアップは?</A>
<LI><a href="#x509"     >13.9 - isakmpd を X.509 証明製颪隼箸Δ砲深写評釈鱚羹■彬塔譬庄凱碓謀ぢクライアントで isakmpd と互換誓△襪里深写評釈鱚羹■夸阨碎紜庄凱臼偕繝侘ぢのトラブルシューティング</A>
<LI><a href="#SeeAlso"  >13.12 - 関連ドキュメンテーション</A>
d38 5
a42 5
<LI><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&sektion=4&format=html">ipsec(4)</a>
<LI><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&sektion=8&format=html">vpn(8)</a>
<LI><a href="http://www.freebsd.org/~julian/IPSEC_4_Dummies.html">IPsec for Dummies</a> by Julian Elischer
<LI><a href="http://www.secureops.com/vpn/vpn.html">ISAKMP Howto</a> by Patrick Ethier
<LI><a href="http://hem.passagen.se/hojg/isakmpd/">X.509v3 certificates with isakmpd</a> by J&ouml;rgen Granstam
a544 52
<a name= "Photuris"></a>
<a name="13.7"></a>
<h1>13.7 - photurisd の誓瀋蠅呂匹Δ笋襪深云
鹿霈
斜俶阡蜩ぢはまだ世△泙蟷箸錣譴討い覆い掘
卞ぢのステータスから言世┐个泙誓実験段階だ澄任鞳鄲喞ぢではたくさんの人が
利用してきた。
<P>
photurisd を誓瀋蠅垢襪砲蓮△泙續祚韆阡蜩繝鱚闔を photurisd を持ったホストのすべてで編集すること。
<UL>
<PRE>
# <b>cat /etc/photuris/secrets.conf</b>
# Accepted keywords are:
# identity local &quot;id&quot; &quot;secret&quot;
# identity pair local &quot;receivedid&quot; &quot;myid&quot; &quot;secret&quot;
# identity remote &quot;id&quot; &quot;secret&quot;
# identity lookup &quot;tag&quot; username
# Simple 
identity local &quot;Default&quot; &quot;ここを変える&quot;
identity remote &quot;Default&quot; &quot;ここを変える&quot;
</PRE></UL>
&quot;ここを変える&quot; の部分を、local config 側で好きな鍵にして、
それから remote config では別の好きな鍵にしよう。
(リモートボックスでも config を使うこと。ただ世髟阡詞閭瘡鱚迴ぢを入れ替えて、リモートホスト側にとってはそっちがローカル鍵になるようにする。)
なお、これらの鍵は将来の photurisd のバージョンでは、
最初の鍵交換を公開鍵で行うような形で置き換わることになるので注意。
<P>
<tt>net.inet.ah.enable</tt> が 1に誓瀋蠅気譴討い襪海箸魍稜Г靴茲Α
謝名斜凖錫杖笏續鈬瘉釶碎綵閏鈬蜴續莅緕痰跂苳鹿侑転鹿嫐それから startkeyを実行。
<UL><PRE>
# <b>startkey dst=remote.host</B>
</PRE></UL>
それでは tcpdump を実行して、パケットが AHで暗号化されていることを確認してみよう
(別のウィンドウでpingするとか、なんかセッションを開始してトラフィックをつくること)。
<UL><PRE>
# <b>tcpdump proto ah</b>
</PRE></UL>
なにも出てこないようなら、tcpdump をホストアドレス側で使ってみる手がある。
<UL><PRE>
# <b>tcpdump host remote.host</b>
</PRE></UL>
photurisd が自動的に発信元と送り誓茲離曠好箸筌優奪肇錙璽鮴設定するように
するには、 /etc/photuris/photuris.startupに記述しておく。

<p>
d546 1
a546 2
<a name="13.8"></a>
<h1>13.8 - isakmpdの誓瀋蠅深云
箋鬼
甬鬼
取馨嘘黶謐鞣ってなに?</h3> ISAKMP (ときどき IKE, 
d590 1
a590 1
<h3>13.8.2 - isakmpdことはじめ</h3>
d871 1
a871 1
<h3>13.8.3 - isakmpdの起動</h3>
d885 1
a885 2
<a name="13.9"></a>
<h1>13.9 - isakmpd を X.509 証明製颪箸い辰靴腓忙箸Δ砲深云
箟狭甕狭釈瘢綵嘘唖取云嘘蜩瘠逅ぢで使えるIKE クライアントは?</h1>
d1733 1
a1733 2
<a name= "13.11"></a>
<h1>13.11 - Troubleshooting IPsec/VPN</h1>
d1864 1
a1864 2
<a name= "13.12"></a>
<h1>13.12 - 関連ドキュメンテーション</h1>
d1936 1
a1936 1
Originally [OpenBSD: faq13.html,v 1.56 ]
d1938 1
a1938 1
$Translation: faq13.html,v 1.10 2002/07/02 08:12:49 toshi Exp $
d1940 1
a1940 1
$OpenBSD: faq13.html,v 1.56 2002/07/02 01:17:58 nick Exp $
@


1.8
log
@
sync with badlands translation CVS
@
text
@d559 1
a559 1
bsd# <b>cat /etc/photuris/secrets.conf</b>
d578 1
a578 1
bsd# <b>sysctl -w net.inet.ah.enable=1</b>
d583 1
a583 1
bsd# <b>startkey dst=remote.host</B>
d588 1
a588 1
bsd# <b>tcpdump proto ah</b>
d592 1
a592 1
bsd# <b>tcpdump host remote.host</b>
d1784 1
d1814 1
a1814 1
vpn# <b>ping -c 3 208.1.1.1</b>
d1825 1
a1825 1
vpn# <b>tcpdump -ni fxp7 host 208.1.1.1</b>
d1896 1
a1896 1
vpn% <b>netstat -rn -f encap</b>
d1994 1
a1994 1
Originally [OpenBSD: faq13.html,v 1.54 ]
d1996 1
a1996 1
$Translation: faq13.html,v 1.9 2002/06/20 09:02:49 toshi Exp $
d1998 1
a1998 1
$OpenBSD: faq13.html,v 1.54 2002/06/20 06:17:32 chris Exp $
@


1.7
log
@
sync with badlands translation CVS
@
text
@d394 2
a395 2
BLF       可変 (40-160, 160 bits 推奨)
CAST      可変 (40-128, 128 bits 推奨)
d1765 1
a1765 1
<LI><a href="http://www.microsoft.com">Microsoft</a> Windows 2000 (Transport モードのみ)
d1993 1
a1993 1
Originally [OpenBSD: faq13.html,v 1.53 ]
d1995 1
a1995 1
$Translation: faq13.html,v 1.8 2002/05/30 00:16:32 toshi Exp $
d1997 1
a1997 1
$OpenBSD: faq13.html,v 1.53 2002/05/29 19:24:44 nick Exp $
@


1.6
log
@
sync with badlands translation CVS
@
text
@d999 2
a1000 3
さらに man ページにあるものよりもかなり短いファイルを使う。
この誓瀋蠅陵鬚鬚茲蟯蔽韻砲垢襪燭瓩法▲侫．ぅ襪蕁
この誓瀋蠅砲鷲廚覆い發里鬚曚箸鵑漂鐔靴拭気蕕縫灰瓮鵐箸眥媛辰靴
箟更甕更蜃蜴瘡踟緕帯頂瘻嘘讙窺飢
箟更甕更ぴ鱇銖赱闔聲餘凱蔗迪旭億圧宛些矯軌闢蓍
箟更甕更は鞳鄲喞聲餘凱蔗迪屋芦起鯵該牡些褥


窺跫齷釿蜚矚粲瘤糂鱇銖赱闔嶝

絶亀
甬完全誓蜴苒蜚ぢ）、アクセス誓罅〔性が提供される。IPsec は
d104 1
a104 1
<h4>完全誓侮苒蜚ぢ）</h4> データが途中で改竄されないようにする。
d109 1
a109 1
<h4>Authenticity（誓疑神性／確実誓鹿茣データに署名して、それを送ったのが本当にあなただ世搬召凌佑
箟嘘
甕嘘
取款再送保護（Replay protection）</h4> やりとりは、何度も繰り返すよう認められたもの以外は、
d119 1
a119 1
しよう（かれの口座にお金を振り込むとか）。
d133 3
a135 3
IPsec は、機密誓袷汗性、authenticity（誓疑神性）、再送保護を提供するのに、
新しいプロトコルを 2 つ使う。このプロトコルは AH（
Authentication header, 認証ヘッダ澄砲嗤（Encapsulated security payload、暗号ペイロード）だ澄
箟碍
甕碍
組ぢは認証と完全誓蛤徳欷遒鯆鷆，垢襦覆〔性は提供しない）。
d139 1
a139 1
IP ヘッダ世琉貮堯覆燭箸┐丱僖吋奪箸糧機α蠕先アドレス）も
d143 1
a143 1
提供する（ヘッダ世砲弔鼎僖吋奪汎發里垢戮討鯤欷遒垢襦法
箟患
甕患
（この二つはいつもペアでくる）。機密誓憤店羃宗砲蓮
箟亀
甕亀
腫実ぢ認証ヘッダ澄装緕竅闔縺粤ぢ）</B>
d162 2
a163 2
<P>The <B>暗号ペイロード（Encapsulating
Security Payload）</B> (ESP) ヘッダ世蓮▲撻ぅ蹇璽匹魄店羃修気譴新舛能颪垢┐襪海箸魏椎修砲垢襦
箟況
甕狂
途ヘッダ世蓮▲撻ぅ蹇璽匹稜Ь擇眥鷆，任襦覆嗤ぢの外の
ヘッダ世砲弔い討惑Ь擇任覆ぁ法
箟薫
甕薫
斜症偕繝ぢ機能の（ほとんど）独立した部分が、IPsec encapsulation を
d187 1
a187 1
（といっても、これはもちろん複数の IP ホップをまたがるかもしれないけれど）をカバーする、
d193 1
a193 1
普通は（マルチキャストは無視して）一つの点世虔未療誓までについて、
d198 4
a201 4
(<B>宛誓アドレス, セキュリティパラメータインデックス（Security Parameter
Index）, セキュリティプロトコル</B>)に応じて指定の SA に割り当てることができる。
セキュリティパラメータインデックス（Security Parameter
Index、略してSPI）は誓楝海離僖薀瓠璽燭離優乾轡─璽轡腑鵑圓錣譴襪箸法啻ぢの受け手が手渡すクッキーだ世隼廚┐个いぁ
箍梓
甓梓
これは外側の IP ヘッダ世藐弔韻襪海箸發任襪掘∈能蕕離札絅螢謄悒奪誓（これは SPI とセキュリティプロトコルを含む）から見つけることもできる。
d258 1
a258 1
ペイロード（イタリクスで表示）を暗号化する。
d275 1
a275 1
OpenBSDの IPsecソースコードの中では、TDB または TDB table と呼ばれている）で、
d284 1
a284 1
（バンドルなら、SAD エントリは複数あり得世襪里如砲鮖慊蠅垢襪韻譴鼻△任發垢任
箜葦
甞葦
（これは host based transport SAのみ)、ホスト名、セキュリティ
d335 1
a335 1
（これに変更を加えるのは、手動鍵誓瀋蠅鮖箸豺腓誓けだ澄法
箜完
甞完
緕帯はPhoturis (<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2522.html">RFC2522</a>および
d342 1
a342 1
と ISAKMP 自動かぎ交換
d357 2
a358 2
IPsecの手始めとしていちばんかんたんなのが手動鍵誓瀋蠅誓。
この手法でネットワーク間を暗号化してVPNをつくれる。
d365 1
a365 1
この次の例のように、ESP だ世韻鮖箸辰討い襪茲Δ幣豺腓砲蘊組は有効にしないでいい。</i>それどころか、
d367 1
a367 1
発誓犬垢襪發靴譴覆ぁ法斜箚扱
甦扱
それを包むIP ヘッダ世惑Ь擇靴討譴覆ぁ海痢峺造蕕譴診Ь據廚蓮
箚姥
甦姥
これを二つのルータで実際にやってみよう。ルータのIPアドレスはそれぞれ192.168.5.1 と 192.168.25.9だ澄
箚屋
甦屋
ホスト192.168.5.1上では:
d427 1
a427 1
ホスト 192.168.25.9上では:
d440 1
a440 1
まずは192.168.5.1から:<P>
d459 1
a459 1
を使うと IP ヘッダ世泙粘泙鵑誓IP パケットのすべてが必ずSPIにカプセル化
d475 2
a476 2
<h2>208.1.1.1の側では:</h2>
まず、security associations (SA)を誓瀋蠅靴茲瑳岱箋干
甬干
これですべての IPsec 情報 (SPI、フロー、ルーティングのエントリ）がシステムから一掃される。
d548 1
a548 1
<h1>13.7 - photurisdの誓瀋蠅呂匹Δ笋襪深云
箋飢
甬飢
卞ぢのステータスから言世┐个泙誓実験段階だ澄任緕帯ぢではたくさんの人が
d556 1
a556 1
を photurisdを持ったホストのすべてで編集すること。
d570 1
a570 1
それからremote configでは別の好きな鍵にしよう。
d586 1
a586 1
（別のウィンドウでpingするとか、なんかセッションを開始してトラフィックをつくること）。
d602 1
a602 1
<p>VPNs をはじめIPsecの各種伝統的なアプリケーションを考えているなら、
d605 1
a605 1
なんらかの形の ISAKMPを使うしかなくなる。
d614 1
a614 1
二つのIPsecノード間でIPsecパラメータを確立するために、
d628 3
a630 3
<b>フェーズ 2</b> - Security Associations がIPsecにかわってネゴされる。
フェーズ 2 はIPsecホスト間にトンネルか endpoint SA を確立する。
フェーズ 2 では<b>Quick Mode</b> が使われる。フェーズ 1 ですでに SA が確立しているので、
d636 1
a636 1
（もっと手早い）フェーズ 2 の誓瀋蠅圓錣譴襦Ｆ韻献侫А璽ぢチャネルの中で、複数のフェーズ 2 誓瀋蠅
箒街
甼完
認証を交換する (X509 証明世
事前に共有した秘密）。これで両端とも、相手が認証されたことを
d652 1
a652 1
CD-ROM（当然持ってるよね）からでもいいし、<A
d739 2
a740 2
ここでの値は下の部分を指している（フェーズ 1 は単にリモートのピアを認証して、
それが主張通りの相手だ世罰稜Г垢襪誓けなのをお忘れなく）。
d868 2
a869 2
ホストA（これは上の Net-Aに
つながっている）では 192.168.1.0/255.255.255.0 、ホストB（これは上の Net-Bにつながっている）では192.168.20.0/255.255.255.0 だ澄
箙旭
畊旭
錫菖鱇銖肬鴉鷭鹿眈ぢはこのやりとりで必要とされる（または指定される）暗号変換方式だ澄海領磴任蓮
箙験
畊験
蓖辣蜚絎黼ぢというのは（実在はしないけれど）証明製颪冒淨気譴襪戮冂だ澄
箟旭甕旭誓瀋蠅鮖辰討い襪里如柄阿寮節を参照）このファイルでも
d1030 1
a1030 1
と組み合わせて使うとかその手のをどうするかは誓睫誓しない(ぼく自身やったことがないから）。
d1303 1
a1303 1
プロトコルを使用した人だ世韻蠅気譴襪箸いΔ海箸誓（本物といってもまあ、
d1306 1
a1306 1
この policy を変更するのは、読者の練習問題として残しておこうか）。
d1319 2
a1320 2
さらに権限をだ世譴召梁減漾癖瑤任
いい）に「サブライセンス」することもできる。簡単なケースとしては、事前共有鍵の
d1335 2
a1336 2
誓楝海鯒Г瓩襦覆燭誓しこのパスワードは isalmpd.conf の Authentication タグでも
誓瀋蠅靴討里鬚困譴覆法
箟街甕街疑似資格証明澄竰繖緕瘡ぢ）に変換される。こうした疑似資格証明世吠儡垢気譴疹斂誓書は、
d1399 1
a1399 1
    	CzA  この部分はユーザ証明製顱覆弔泙蛋証明製顱砲暴靆召靴囘腿
箟寛甕寛内部で証明製颪匹Δ覆辰討い襪鮴説明世靴討い襦紊了餝幣斂誓（credential）は、
d1468 1
a1468 1
送信してくるかわかる（[フェーズ 1] セクションで)。フェーズ 1 の
d1473 2
a1474 2
うん、もしID 情報が IP なら（フェーズ 1 の ID セクションを使わなければ
これがデフォルトに状況になる）すべてはオッケーだ澄蛋
箟慣甕慣（たとえば両方のコンピュータが同じ LAN 上にあって、
ふだ世鵑修を使っているマシンがなんらかの理由でダ瀬Ε鵑靴討い襪覆鼻法
箟憾甕憾その IP がなりすまし犯のものだ世函壁埓正に）証明世垢襪海箸
箟憾甕換なりすまし犯の身元（あるいは cert の
ID 情報）を十分にチェックできなかったか、あるいは CA 秘密鍵が十分に保護されていなかったかだ澄
箟軌甕軌期待どおりの IP から送られてきたことをチェックできる（でもさっき誓睫誓したように、
これは一部の状況ではごまかせる）。ピアが提示するIDを、
d1509 1
a1509 1
できる（あるいはサービス拒否（DoS）攻撃を
d1511 2
a1512 2
偽造することもできる）。いずれ高セキュリティ DNS も登場するけれど、
まだ製于鵑辰討い覆い掘幣覆箸發曚箸鵑匹林ぢサーバはまだ盛皀札絅螢謄任呂覆ぁ法
箟飢甕飢同じ CA に署名させる（でももちろんアタッカー自身の FQDN を使って)。それから
d1529 4
a1532 4
ぼくたち側の isakmpd は、こっちのピアへの ID が何かを教わっていない（そしてそれは、アタッカーが
証明製颪苗と秘密鍵以外はまったく同じ誓瀋蠅砲靴討い燭蕁法気蕕砲椶燭舛
蜩瘠逅は証明製颪韻のサインしたものだ世肇船Д奪任襦覆任
多くの CA はcert をいっぱいサインするから、cert を手に入れるのはむずかしくないかも）。そして
d1600 1
a1600 1
証明製颪堤齡蜴苺蜩蒹令辣栂を使うことができる（対応する
d1643 2
a1644 2
コンピュータを何台も使ったりする人は多い。あるいは（サーバ
なんかだ世函棒接続したいのがだ世譴覆里△呂辰蠅錣蕕覆い海箸發△襦
箟橋甕橋どのコンピュータからでも（社内LAN上のものに限らず）誓楝海任襪茲Δ砲靴燭い韻譴鼻
箟訓甕訓こいつはまったくテストしていない（だ世蕕海離侫襯疹魴錣蓮△椶了廚つ未蠅砲
ぜんぜん動かないかもしれない）。それと、こいつみたいなpolicy （というか、
デフォルトがピアのIPにしてあるものすべて）は、isakmpd.confファイルもあわせて書き換えないと
d1734 1
a1734 1
同じ方式はISAKMP/IPsec 以外の目的にも使えるはずだ澄淵侫薀ぅ鵐轡好謄爐稜Ь擇気┐任襦法
箟郡甕郡こういうマルチユーザ誓瀋蝓淵皀丱ぅ襯罅璽供砲蓮
箟郡甕郡苗がナマのままで送られるからちょっとセキュリティは下がる）。
d1867 1
a1867 1
あるいは（いちばん詳しいタイマーデバッグ情報をとばすには）
d1881 1
a1881 1
鍵交換（自動鍵交換）セッションの平文部分はほとんどデコードできる。Tcpdump はまた AH ペイロードデータも表示する。
d1883 1
a1883 1
<LI>/kern ファイルシステムをマウントしよう（もしすでにデフォルトで使っていないなら）：
d1890 1
a1890 1
（外行きの SA）もないもの（入ってくる SA)も記述されている。
d1994 1
a1994 1
Originally [OpenBSD: faq13.html,v 1.51 ]
d1996 1
a1996 1
$Translation: faq13.html,v 1.6 2002/04/27 13:21:12 toshi Exp $
d1998 1
a1998 1
$OpenBSD: faq13.html,v 1.51 2002/02/20 03:13:15 nick Exp $
@


1.4
log
@
sync with badlands translation CVS
@
text
@d3 1
a3 1
<title>13.0 - IPsec を使う</title>
d16 1
a16 1
<h1><font color=#e00000>13.0 - IPsec (IP Security Protocol) を使う</font></h1>
d20 1
a20 1
<h3>目次</h3>
d22 12
a33 12
<LI><a href="#What"     >13.1 - IPsecって何?</A></LI>
<LI><a href="#Why"      >13.2 - そりゃ結構だ世韻譴鼻△海里椶覆賓黼ぢなんか使わにゃならんの?</A></LI>
<LI><a href="#Protocols">13.3 - IPsecの裏にあるプロトコルは?</A>
<LI><a href="#Wire"     >13.4 - ネットワーク上のパケットフォーマット</A>
<LI><a href="#Config"   >13.5 - IPsec の誓瀋鹿曽
<LI><a href="#ManKey"   >13.6 - IPsec を手動鍵誓瀋蠅濃箸Δ砲深
写評釈鱚羹■俶阡蜩庄凱韆阡蜩のセットアップは?</A>
<LI><a href="#isakmpd"  >13.8 - isakmpd のセットアップは?</A>
<LI><a href="#x509"     >13.9 - isakmpd を X.509 証明製颪隼箸Δ砲深
写評釈鱚羹■彬塔譬庄凱碓謀ぢクライアントで isakmpd と互換誓△襪里深
写評釈鱚羹■夸阨碎紜庄凱臼偕繝侘ぢのトラブルシューティング</A>
<LI><a href="#SeeAlso"  >13.12 - 関連ドキュメンテーション</A>
d37 1
a37 1
このドキュメントの一部は、以下のドキュメントからとっている:
d50 1
a50 1
<h1>13.1 - IPsecってなに?</h1>
d53 1
a53 1
IPsec は、IP プロトコルファミリーに対する拡張だ澄
箋甬完全誓蜴苒蜚ぢ）、アクセス誓罅〔性が提供される。IPsec は
d58 1
a58 1
アプリケーションのほうでは IPsec を使うのに、IPsec のことを何一つ知らなくていい、
d60 2
a61 2
IPsec 上では<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/protocols?rev=1.13">あらゆる IP プロトコル</a>を使える。暗号化トンネル (VPN) も作れるし、コンピュータ間で単純な暗号化をしてもいい。
オプションが実にいろいろあるせいで、IPsec はちょっとややこしいのである (それも SSL よりずっと!)
d64 3
a66 3
FAQ <a href="../faq6.html">6章</a> の推奨文献には
誓鵑箸睫椶鯆未靴討い討曚靴ぁＦ辰法△發賓 アドレスの考え方がわかっていなかったら、
<a href="http://www.3com.com/corpinfo/en_US/technology/tech_paper.jsp?DOC_ID=135">Understanding
d71 1
a71 1
論斥砲蓮賓黼ぢは以下のどんな形でも機能する:
d78 2
a79 2
つまりは Host-to-Router (そしてこのルータは、ある<i>Network</i>の
トラフィックを誓罎靴動店羃修垢ぢ。
d81 2
a82 2
これから見るように、IPsec は VPN 誓楝獲僂縫肇薀侫奪鬟肇鵐優襪任襦
でも、その応用は VPN よりはるかに広い。中央インターネット鍵交換登録所があれば、
d89 1
a89 1
<h1>13.2 - そりゃ結構だ世韻譴鼻△海里椶覆賓黼ぢなんか使わにゃならんの?</h1>
d93 1
a93 1
インターネットのプロトコルである IP または IPv4 は、それ自体としては、転送しているデータに対して何の保護も提供しない。
d99 1
a99 1
<h4>機密誓鹿茣ぢ受信者以外の人には、どんなデータが通信されたかを
d104 1
a104 1
<h4>完全誓侮苒蜚ぢ）</h4> データが途中で改竄されないようにする。
d109 1
a109 1
<h4>Authenticity（誓疑神性／確実誓鹿茣ぢデータに署名して、それを送ったのが本当にあなただ世搬召凌佑
箟嘘
甕嘘
取款再送保護（Replay protection）</h4> やりとりは、何度も繰り返すよう認められたもの以外は、
d122 3
a124 3
<i>警告: 通常の仕様に関する限り、手動鍵の IPsec を使っているとき 
(たとえば <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&amp;apropos=0&amp;sektion=8&amp;format=html">ipsecadm(8)</a> を使っているとき)
には再送からの保護は実行されない</i>.
d129 1
a129 1
<h1>13.3 - IPsec の裏にあるプロトコルは?</h1>
d133 3
a135 3
IPsec は、機密誓袷汗性、authenticity（誓疑神性）、再送保護を提供するのに、
新しいプロトコルを 2 つ使う。このプロトコルは AH（
Authentication header, 認証ヘッダ澄砲途ぢ（Encapsulated security payload、暗号ペイロード）だ澄
箟蓋
甕蓋
途との主な差は、AH はパケットの
d146 1
a146 1
認証/完全誓△辰討發覆討盪箸┐襦
箟飢
甕飢
取云嘘ぢネットワーク上のパケットフォーマット</h1>
d155 2
a156 2
<p>   <B>認証ヘッダ澄装緕竅闔 Header）</B>
(AH) は基本的な IP ヘッダ世慮紊砲董▲如璽燭琉店罐魯奪轡紊
箟宜
甕彊
組ぢに使う実際のアルゴリズムについては、いくつか別個の RFC があって選べるようになっているけれど、
そのどれも、<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC2402</a>に指定されたガイドラインには準拠していなくてはならない。
d162 3
a164 3
<P>The <B>暗号ペイロード（Encapsulating
Security Payload）</B> (ESP) ヘッダ世蓮▲撻ぅ蹇璽匹魄店羃修気譴新舛能颪垢┐襪海箸魏椎修砲垢襦
途ヘッダ世蓮△修譴棒先立つ IP
d166 2
a167 2
それぞれ各種の ESP は <A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC2406</A>にしたがう必要がある。
ESP ヘッダ世蓮▲撻ぅ蹇璽匹稜Ь擇眥鷆，任襦覆途ぢの外の
d170 1
a170 1
<P>IPsec 機能の（ほとんど）独立した部分が、IPsec encapsulation を
d172 1
a172 1
応じて適用される:
d177 5
a181 5
(e.g . TCP, UDP) のヘッダ世料阿法賓ヘッダ世僖吋奪箸寮先頭につけられる前の段階で追加される。
言世ご垢┐襪函▲僖吋奪箸膨媛辰気譴組 が
TCP ヘッダ世函緕筬鈔 IP ヘッダ世琉貮凜侫璽襯匹離魯奪轡鵐阿鮹甘垢襪箸いΔ海箸誓。
そしてTCP ヘッダ世肇如璽燭琉店羃修途
ヘッダ世弌爾垢襪韻譴鼻△任發修譴緕筬鈔 IP ヘッダ世楼店羃修靴討譴覆ぁ鹿棉
箟験
甕験
写評実ぢトンネル</B> モードは、すでに end-to-end IP ヘッダ世
箟元
甕元
ただ世離押璽肇ΕДい里箸忙箸錣譴襦海離癲璽匹任蓮組 と ESP ヘッダ世蓮緕筬鈔 header を含め
d187 2
a188 2
（といっても、これはもちろん複数の IP ホップをまたがるかもしれないけれど）をカバーする、
新しい IP ヘッダ世弔韻覆気譴襦鹿棉
箟恒
甕慌
斜症偕繝ぢで保護されたリンクは、<B>Security Associations
</B>(SAs) によって定義づけられる。各 SA は単一の単方向のデータの流れについて定義されて、
d194 9
a202 9
なんらかの<B>ユニークなセレクタ</B>によって識別できるトラフィックフローをさす。単一の SA 上を流れるトラフィックはすべて
同じ扱いを受ける。トラフィックの中には、複数の SA を経るものもあって、
そのそれぞれがなんらかの変換を加える。SA の集団を
SA <B>Bundle</B> と呼ぶ。入ってくるパケットは、3 つの定義フィールド
(<B>宛誓賓 アドレス, セキュリティパラメータインデックス（Security Parameter
Index）, セキュリティプロトコル</B>)に応じて指定の SA に割り当てることができる。
セキュリティパラメータインデックス（Security Parameter
Index、略してSPI）は誓楝海離僖薀瓠璽燭離優乾轡─璽轡腑鵑圓錣譴襪箸法啻 の受け手が手渡すクッキーだ世隼廚┐个いぁ
セキュリティプロトコルは AH か ESP のどちらかでなくてはならない。受け手の IP
d204 1
a204 1
これは外側の IP ヘッダ世藐弔韻襪海箸發任襪掘∈能蕕離札絅螢謄悒奪誓（これは SPI とセキュリティプロトコルを含む）から見つけることもできる。
d206 1
a206 1
<P>トンネルモードの AH パケットの例を挙げよう:
d210 1
a210 1
<td><B>IPヘッダ鹿他鹿
箍渦
甓唄
儒箴賓ヘッダ下箴
<td>TCPヘッダ鹿
儒箴データ</td>
d218 1
a218 1
<P>transport モード AH パケットの例を挙げよう:
d222 1
a222 1
<td><B>IPヘッダ鹿他鹿
箍牡
甓乙
儒箴埣ぢヘッダ鹿
儒箴データ</td>
d229 2
a230 2
<P>ESP ヘッダ世漏安Δ賓 ヘッダ世鯒Ь擇任覆い里如
組ぢと ESP ヘッダ世鯀箸濆腓錣擦銅，里茲Δ砲靴燭曚Δい
箍慨
甓慨
儒箴実症ぢヘッダ鹿他鹿
箍碍
甓蓋
儒箴蕊菖弛ヘッダ鹿評鹿
儒箴蕊ぢデータ</I></td>
d242 2
a243 2
<P>これは <B>Transport Adjacency</B> と呼ばれる。トンネル版だ世
こんな感じだ
箍慣
甓慣
儒箴実症ぢヘッダ鹿他鹿
箍軌
甓飢
儒箴蕊症ぢヘッダ下昭箴
<td><I>TCPヘッダ鹿評鹿
儒箴蕊ぢデータ</I></td>
d256 2
a257 2
<P>でも、これは RFC には明声傍劼気譴討い覆ぁ夸瘤齔闥
痲裃竇釿と同じように、これはIP ヘッダ世涼罎離悒奪誓いくつかを除いて全パケットを認証したうえで、
d259 1
a259 1
AH と ESP ヘッダ世海里茲Δ膨樟接いっしょに適用されているときには、
d261 1
a261 1
任意の recursive encapsulation をやることで、この順番が指定されずにすむようにすることもできる。
d266 1
a266 1
<h1>13.5 - IPsec の誓瀋鹿莟
箍薫
甓薫
なってはいるのだ世韻譴鼻△任卞ぢはそれがどう実装されるべきかについて強いレコメンデーションを行って
d274 3
a276 3
一つは<B>Security Association Database</B> (SAD, 
OpenBSDの IPsecソースコードの中では、TDB または TDB table と呼ばれている）で、
もう一つは<B>Security Policy Database</B> (SPD)だ澄
箍鍵
甓元
でもSPD は実際の処理から二段階ほど遠いところにある: 
SPD は外へ出るパケットに使われて、どの SAD エントリを使うべきか決めるのに利用される。
逆に SAD エントリは、実際のプロセスとそこで使うパラメータを記述する。
SPD のエントリは、既存の SAD エントリのうちどれを使うか
（バンドルなら、SAD エントリは複数あり得世襪里如砲鮖慊蠅垢襪韻譴鼻△任發垢任
適誓擇覆發里覆い覆蕁△修離┘鵐肇蠅鮖箸辰匿靴靴い發里弔蕕譴襦弔蕕譴啻 のフィールドは、
d289 3
a291 3
<P>　外行きのパケットは、SPD エントリから個別の SA に行ってエンコーディング用
パラメータをもらう。入ってくるパケットは、SPI/宛誓賓ぢプロトコルの 3 点瀬札奪箸鮖箸辰
直誓楡正しい SA にたどりつき、そこから SPD エントリにたどりつく。
d293 2
a294 2
<P>　SPD はまたどのトラフィックが IPsec をバイパスすべきか、またどのトラフィックを
捨てるべきかを指定できるので、入ってくる非 IPsec のトラフィックについても参照されなくてはならない。
d300 2
a301 2
送信元と宛誓茱▲疋譽后愀犬△訃豺腓砲魯檗璽犯峭罅▲▲廛螢院璽轡腑鵑筺△△訃豺腓砲魯罅璽苗
（これは host based transport SAのみ)、ホスト名、セキュリティ
d304 1
a304 1
<P>SAD エントリに含まれるのはたとえば:
d307 3
a309 3
<LI>宛誓賓 アドレス
<LI>IPsec プロトコル(AH か ESP)
<LI>SPI (クッキー)
d320 1
a320 1
<P>SPD エントリに含まれるのは:
d327 1
a327 1
<P>各 SA は、ESP ヘッダ整譴弔組 ヘッダ整譴弔鯆蟲舛任襦
箜温
甞外
できない――さもないと、SA を参照するための SPI を指定するヘッダ世覆い海箸砲覆辰討靴泙Α
卞は、AH とESP ヘッダ世嗤ぢの値について
d332 1
a332 1
これはバンドル中の複数の SA を意味するものと判断されるだ世蹐Α
箜慨
甞慨
斜章鞳鄲喞ぢの SPD は、<tt>ipsecadm flow</tt> コマンドを使って管理される
d340 1
a340 1
OpenBSD はPhoturis (<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2522.html">RFC2522</a>および
d342 1
a342 1
と ISAKMP 自動かぎ交換
d348 1
a348 1
と <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&apropos=0&sektion=8&format=html">isakmpd(8)</a>
d354 1
a354 1
<h1>13.6 - 手動鍵誓瀋蠅賓黼ぢを誓瀋蠅垢襪砲呂匹Δ垢襪深云
d358 1
a358 1
この手法でネットワーク間を暗号化してVPNをつくれる。
d360 1
a360 1
自動化するのに<A HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.3">/usr/share/ipsec/rc.vpn</a>
d363 6
a368 6
まず、OpenBSDカーネルの IP AH と IP ESP オプションを有効にしよう
(もし rc.vpn スクリプトを使っていたり、あるいは
この次の例のように、ESP だ世韻鮖箸辰討い襪茲Δ幣豺腓砲守樵ぢは有効にしないでいい。</i>それどころか、
使っていないのに AH を有効にするとセキュリティ上の問題が
発誓犬垢襪發靴譴覆ぁ法斜
こういうプロトコルを有効にするための、すてきな sysctl がある。
d375 3
a377 3
起動時にこれをたちあげるには<tt>/etc/sysctl.conf</tt> を編集すればいい。
使いたいものに応じてnet.inet.esp.enable そして/あるいは
net.inet.ah.enableの前の # をはずし、それが 1 にセットされている
d385 1
a385 1
デバイスを使う手がある。たとえば160ビット分の乱数誓鬚弔蠅誓すには、以下のようにする:
d394 2
a395 2
BLF       可変 (40-160, 160 bits 推奨)
CAST      可変 (40-128, 128 bits 推奨)
d399 9
a407 9
では、SA (Security Associations) の誓瀋蠅鬚靴茲Α
嚆笊鱸齠閭蛛闔ぢというのは、IP アドレス、SPI, 
セキュリティプロトコル (AH そして/または ESP) の組み合わせだ澄賓 アドレスは、あなた自身のものと、
送り誓茲里發領省誓。SPI (Security Parameter
Index) は各種 SA の分類に OpenBSD が使う番号だ澄
斜蕊ぢこれらの例は、トラフィックの暗号化に ESP しか使わない。ESP は
暗号化された中身のデータの認証はするけれど、AH とはちがって
それを包むIP ヘッダ世惑Ь擇靴討譴覆ぁ海痢峺造蕕譴診Ь據廚蓮
箚姐
甦姐
途の場合には。</I>
d418 1
a418 1
これを二つのルータで実際にやってみよう。ルータのIPアドレスはそれぞれ192.168.5.1 と 192.168.25.9だ澄
箚屋
甦屋
ホスト192.168.5.1上では:
d427 1
a427 1
ホスト 192.168.25.9上では:
d435 1
a435 1
ごらんのように、SPI がちがっている。SPI が何で、それがどこで使われているかについての完全な誓睫誓は、<A HREF="#13.4">On the wire format</a> を参照。
d437 1
a437 1
これで Security Associations ができあがったので、
d440 2
a441 2
まずは192.168.5.1から:<P>
さてここでいきなり、フローが<b>2つ</b>創られる。一つはローカルのソースアドレスで、
d450 1
a450 1
192.168.25.9側ではこんな具合だ
箚儀
甦彊
もし Host-to-Host VPN のオーバーヘッドを減らしたければ、SPI
を作るのに <tt>-forcetunnel</tt> をはずしておくと、transport モードが使える (<tt>-forcetunnel</tt>
を使うと IP ヘッダ世泙粘泙鵑誓IP パケットのすべてが必ずSPIにカプセル化
される)。もし
d462 2
a463 2
ネットワークから出入りするトラフィックに SA を使うと、自動的に
トンネルモードの SPI が確実に作られることになる。
d465 1
a465 1
これはIPsecを使い始める簡単なやりかただ澄
箚況
甦薫
賓黼を使えば、プライベート IP アドレス空間をインターネットごしにつなげる。
いい例を挙げよう……208.1.1.1の背後にある 192.168.99.0/24 と、
208.2.2.2の背後にある 208.1.5.0/24 と 208.1.2.0/24 をトンネルでつなげたいとしよう。
以下の例は <A HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.3">rc.vpn</a> スクリプトを使って誓言成したものだ澄
箚群
甦軍
ごらんのとおり、IPsecで手動鍵誓瀋蠅鮖箸辰討い襪函
やってほしいことを<b>ずばり誓騎里鹿眈指定しなきゃダ瀬瓩誓。
d475 3
a477 3
<h2>208.1.1.1の側では:</h2>
まず、security associations (SA)を誓瀋蠅靴茲瑳岱
ぢこれで SPI, 暗号化の方法と鍵が誓瀋蠅気譴箚顕
甦顕
次に、208.1.1.1 から 208.2.2.2へのフローを誓瀋蝓
箚原
甦原
次に  208.2.2.2の背後にある208.1.2.0/24 から 192.168.99.0/24へのフローを誓瀋蝓
箚弘
甦弘
次に 208.2.2.2の背後にある 208.1.5.0/24 から 192.168.99.0/24へのフローを誓瀋蝓
箚拘
甦拘
こんどは 208.2.2.2の背後にある 208.1.2.0/24 からルータ 208.1.1.1へのフローを誓瀋蝓
箚晃
甦晃
オッケー、では 208.2.2.2の背後の 208.1.5.0/24 からルータ 208.1.1.1へのフローを誓瀋
箋芦
甬芦
最後に、ルータ 208.2.2.2 から 192.168.99.0/24へのフローを誓瀋蠅靴茲
箋扱
甬宛
取仮屋軒荻荻ぢ側では:</h2>
前と同じように、まずは SAの誓瀋蠅蕁帖
箋唄
甬唄
ルータ 208.2.2.2 から 208.1.1.1へのフローを誓瀋蝓
箋姥
甬姥
屋軒窺窺ぢの背後にあるネットワーク 192.168.99.0/24 から 208.1.2.0/24へのフローを誓瀋蝓
箋臆
甬臆
屋軒窺窺ぢの背後にあるネットワーク 192.168.99.0/24 から 208.1.5.0/24へのフローを誓瀋蝓
箋俺
甬俺
では208.1.1.1の背後の 192.169.99.0/24 からルータ 208.2.2.2へのフローを誓瀋蝓
箋咳
甬害
屋軒窺荻渥牡ぢと 208.1.5.0/24 をルータ 208.2.2.2から 208.1.1.1まで届けるのに、
あとフロー2つだ世院
箋干
甬干
これですべての IPsec 情報 (SPI、フロー、ルーティングのエントリ）がシステムから一掃される。
d548 1
a548 1
<h1>13.7 - photurisdの誓瀋蠅呂匹Δ笋襪深云
d552 1
a552 1
RFCのステータスから言世┐个泙誓実験段階だ澄任緕帯ぢではたくさんの人が
d555 2
a556 2
photurisd を誓瀋蠅垢襪砲蓮△泙蓖鱸鶩黼竰續鶤竢鈕
を photurisdを持ったホストのすべてで編集すること。
d566 2
a567 2
identity local &quot;Default&quot; &quot;ここを変える&quot;
identity remote &quot;Default&quot; &quot;ここを変える&quot;
d569 5
a573 5
&quot;ここを変える&quot; の部分を、local config 側で好きな鍵にして、
それからremote configでは別の好きな鍵にしよう。
(リモートボックスでも config を使うこと。ただ世跫竅讀髟阡鱚迴ぢを入れ替えて、リモートホスト側にとってはそっちがローカル鍵になるようにする。)
なお、これらの鍵は将来の photurisd のバージョンでは、
d576 1
a576 1
<tt>net.inet.ah.enable</tt> が 1に誓瀋蠅気譴討い襪海箸魍稜Г靴茲Α
箋険
甬険
それから startkeyを実行。
d585 2
a586 2
それでは tcpdump を実行して、パケットが AHで暗号化されていることを確認してみよう
（別のウィンドウでpingするとか、なんかセッションを開始してトラフィックをつくること）。
d590 1
a590 1
なにも出てこないようなら、tcpdump をホストアドレス側で使ってみる手がある。
d595 1
a595 1
するには、 /etc/photuris/photuris.startupに記述しておく。
d600 1
a600 1
<h1>13.8 - isakmpdの誓瀋蠅深云
d602 2
a603 2
<p>VPNs をはじめIPsecの各種伝統的なアプリケーションを考えているなら、
たぶん ISAKMP を使うことになる。IPsec の商業実装の
d605 1
a605 1
なんらかの形の ISAKMPを使うしかなくなる。
d608 4
a611 4
<h3>13.8.1 - isakmpdってなに?</h3> ISAKMP (ときどき IKE, 
Internet Key Exchange、インターネット鍵交換、自動鍵交換とも呼ばれる) は VPN 用の鍵交換メカニズムだ澄
卞牡扱卞牡宛、RFC 2409に記述された手法を使ってセキュリティ上の問題をクリアしている。
ISAKMP は、通常なら <a
d614 1
a614 1
二つのIPsecノード間でIPsecパラメータを確立するために、
d617 1
a617 1
<P> <b>フェーズ 1</b> - ISAKMP ピア２つは、保護され認証されたチャネルを確立し、
d619 2
a620 2
両ホスト間で Security Association (SA) を確立する。このチャネルを確立するための手法は、<b>Main
Mode</b> と <b>Aggressive Mode</b> だ澄
箒臆
甼臆
特定の順番で送り、アイデンティティの保護を提供する。Aggressive Mode は
d624 1
a624 1
すべて一気に送るからだ澄燥苒纉皷 mode を使うのは、
d628 3
a630 3
<b>フェーズ 2</b> - Security Associations がIPsecにかわってネゴされる。
フェーズ 2 はIPsecホスト間にトンネルか endpoint SA を確立する。
フェーズ 2 では<b>Quick Mode</b> が使われる。フェーズ 1 ですでに SA が確立しているので、
d635 5
a639 5
手短にいえば、フェーズ 1 は保護されたチャネルを確保するのに使われて、そこで
（もっと手早い）フェーズ 2 の誓瀋蠅圓錣譴襦Ｆ韻献侫А璽ぢチャネルの中で、複数のフェーズ 2 誓瀋蠅
することもある。フェーズ 2 は実際のトンネルを誓瀋蠅垢襪里忙箸錣譴襦
フェーズ 1 では IPsec ノード同士が誓楝海魍領靴
認証を交換する (X509 証明世
箒官
甼官
確認できる。フェーズ 2 は鍵の交換で、両者の間のデータが
d644 1
a644 1
<h3>13.8.2 - isakmpdことはじめ</h3>
d647 1
a647 1
デフォルトで OpenBSD は ISAKMP と
d649 1
a649 1
サンプルファイルはデフォルトではない。これを手に入れるには、ソースツリーから以下のものを取ってこよう:
d652 1
a652 1
CD-ROM（当然持ってるよね）からでもいいし、<A
d654 2
a655 2
<a href="http://www.usa.openbsd.org/anoncvs.html">コマンドライン CVS
クライアント</a>. を使ってもいい (Cvsweb は <a
d657 1
a657 1
と <a
d659 4
a662 4
を用意してある)。この例で使うには、<i>policy</i>
を /etc/isakmpd/isakmpd.policy にコピーしよう。<i>VPN-east.conf</i> は /etc/isakmpd/isakmpd.confにコピーする。
ここでは、VPN (トンネル) の誓瀋蠅了妬鮴説明世靴討澆襦發
蜩瘠逅を個別ホスト間で使いたければ、<i>samples</i> ディレクトリにそれ用のサンプルが
d669 6
a674 6
まずは esp の起動からだ澄徳セクションの頭のところの <a href="#ManKey">
Manual Keying</a> で、これを実行時・起動時にそれぞれやる方法を誓睫誓している。
次に /etc/isakmpd.policy の編集だ澄
このファイルは ISAKMP に、だ世譴賓黼ぢにアクセスできるかを教える。このシナリオでは、この policy ファイルは、
Encapsulate Security Payload(ESP) を使ってデータを送ってきて、mekmitasdigoat というパスワード (これはあなたが
勝手に決めればいい) で認証された相手なら、だ世譴任蜩瘠逅ぢと通信できると述べている。このファイルをを変更して、
d676 2
a677 2
希望をISAKMPに伝えられる。まただ世譴任賓黼ぢが使えるようにしてもいい。これはテスト用だ世韻砲靴討里召泙靴ぁ
万人にアクセスさせるには、policy ファイルを編集して以下だ世韻砲靴茲
箒鹸
甼元
同じ policy ファイルには $ のついた行が二行ある。
使う前にこの２行は削除すること。CVS でしか使わない。
d687 1
a687 1
この例で、もっと使い物になる policy ファイルはこんな感じだ
箒弘
甼弘
衷迯緕ぢこの policy は誓気靴ぅ僖好錙璽匹鮖箸Ε螢癲璽箸蕕途啻 を受け付ける
d696 3
a698 3
これを実装すれば、ESP だ世韻鮖箸辰心靄榲嶄ぢトンネル) ができあがる。
ホスト A では /etc/isakmpd/isakmpd.conf を編集する。見本で入っている249.2.2.2 という IP アドレスは、
ホスト A の実際の外部 IP アドレスに書き換えること。
d707 2
a708 2
同じようなことをホスト B の isakmpd.conf でもやろう。249.3.3.3 は
ホスト B の外部 IP アドレスだ澄
箏鰻
畄鰻
腫ぢここで isakmpd のおもなふるまいを決める変数を誓瀋蠅任襦海海任
箏厩
畄屋
錫礁蜩遶闔鹿眈跿は、isakmpd が聞き耳をたてるべき IP 
を指定する。あなたのゲートウェイのインターネット IP だ世韻廚誓。
d724 1
a724 1
次にホスト A で、もう一度isakmpd.conf を編集しよう。
d731 1
a731 1
ホスト Bでは:
d738 2
a739 2
<p>この部分は、フェーズ 1 誓楝海離優乾轡─璽轡腑鵑鬚垢襪箸房栄佞韻襪戮賓 アドレスを記述する。
ここでの値は下の部分を指している（フェーズ 1 は単にリモートのピアを認証して、
d743 1
a743 1
次にホスト Aでは:
d749 1
a749 1
ホスト Bでは:
d756 1
a756 1
<p>これは誓楝海離侫А璽ぢを記述したもの。このフェーズは、通信に両
d760 2
a761 2
フェーズ 2 を誓瀋蠅垢襪燭瓩房影譴蕕譴襯瓮愁奪匹簍弖錣鬟ぅ縫轡─璽箸垢襦海譴呂泙拭
いったん開始したらどの誓楝海鬟ぅ縫轡─璽箸垢戮瓶阻熔ぢに告げる。
d765 3
a767 3
<p>リモートホストの IP アドレスがわからなければ、 <b>Connections</b>= tag に
挙がっていない IP からの誓楝海濃仮箸気譴襦突僖┘鵐肇蠅鬚△襯札轡腑鵑傍劼靴討い董
それを Default= で指定するようにすればいい。
d769 1
a769 1
ホスト Aでは:
d781 1
a781 1
ホスト Bでは:
d794 2
a795 2
これらは上で誓睫誓したフェーズ 1 の部分で参照されているセクションだ澄修譴召
フェーズ 2 に進むためにピアのゲートウェイが満足しなければならない要件を記述している。ほかにもオプションは
d798 2
a799 2
<li><b>Phase=1 </b>が必要なのは、 ISAKMPD コードがフェーズ 1 とフェーズ 2 を処理するのに同じプロシージャを使うからだ澄
これを <b>1</b> にしないと、何一つ機能しなくなる。
d802 1
a802 1
一部のピアはファイアーウォールの背後にあって、UDP トラフィックを通さない場合があることに注意。これは当然ながら、誓瀋蠢阿乏稜Г靴討廚△襦
筝梓
畍梓
フェーズ 1 の誓楝海里燭瓩膨阿ぅ鵐拭璽侫А璽垢舛辰討い襪發靴譴覆ぁ
筝斡
畍扱
インターフェースの IP がそれになる。
<li><b>Address= </b>は、入ってくるパケットのソースIP。これはピアゲートウェイを
d809 1
a809 1
ここはもっと誓睫誓が必要。ピアの発信する IP アドレスは事前にわからないことがあるから。
d814 5
a818 5
事前に共有してある秘密。このパスワードが policy に渡されて、
このピアがこのホストと IPsec を使っていいことになっているかを確認する。ここのパスワードを変えたら、
policy ファイルでの記述も変える必要がある。sample ファイルがこのパスワードに応じて提供されるからだ澄
最低限の policy ファイルで行くつもりなら、ここでは好きなものを指定すればいい。
<li><b>Flags=</b> はいまは使われていない。RFC では、フェーズ 1 用の追加オプションを指定するための予備として
d825 1
a825 1
ホスト Aでは:
d835 1
a835 1
ホスト Bでは:
d845 2
a846 2
<p>これらは、上記のフェーズ2で参照されているセクションをあらわしている。これは
個別の誓楝海里燭瓩法鵑弔離押璽肇ΕДご屬馬辰鬚垢襪里瓶阻熔ぢが使うべき
d849 4
a852 4
<li><b>Phase=2</b> は必須。ISAKMPD コードは、フェーズ 1 と
フェーズ 2 の認証に同じ関数を使うから。これがないと VPN は機能しない。
<li><b>ISAKMPD-Peer=</b> は、上でのホストのセクションの名前だ澄弔泙螢侫А璽ぢ誓楝海魍領垢襪燭瓩法
ここで指定したピアと話をしているんですよ、という意味だ澄海譴△襪里蓮蜩瘠逅 ピアや誓楝海魑劼垢襪里
筝儀
畍儀
記述した、以下の IPsec-ID セクションを指す。この部分が送られて、向こう側のゲートウェイがVPN経由で
d860 1
a860 1
あるはずのものを記述した、下のIPsec-ID セクションを記述しているこの部分が解釈されて、こちらのプライベートネットワークから
d862 1
a862 1
<p>ここでサポートされているタグがもう一つあって、それが Flags= だ澄海離織阿廚覆
筝橋
畍狭
ここはIPsec-ID セクションだ澄０焚爾離┘鵐肇蠅蓮▲曠好ぢとホストBの
両方で isakmpd.conf ファイルの中になければいけない。この例だ世
ホストA（これは上の Net-Aに
つながっている）では 192.168.1.0/255.255.255.0 、ホストB（これは上の Net-Bにつながっている）では192.168.20.0/255.255.255.0 だ澄
筝顕
畍験
腫ぢこの二つのセクションが各ホストの <b>conf</b> ファイルに含まれている。これが
<b>Local-ID</b> と <b>Remote-ID</b>の識別しで参照されるセクションだ澄０譴弔
筝元
畍元
錫症牒鞳鹿眈は <b>IPV4_ADDR_SUBNET</b> か <b>IPV4_ADDR</b>がとれる (RFC2708 にはほかにも有効な値があがっている。OpenBSDの実装ではいまのところIPv4 しかサポートされていない。IPv6 は、OpenBSD-current でサポートされているかもしれない)。
d888 1
a888 1
　これで両方のホストで、sample ファイルはこんな具合になっているはずだ
筝攻
畍攻
このセクションはフェーズ 1 誓楝海濃箸Π店翳阿陵弖錣魑劼靴討い襦Ｌ樵阿
筝晃
畍晃
弟轣蜴侮鱚齡掴菱ぢを IPSEC として記述した。<b>EXCHANGE_TYPE</b> 変数は、フェーズ 1 では <b>ID_PROT</b> に誓瀋蠅靴討△襦
箙葦
畊葦
これは誓瀋螢侫．ぅ襪硫爾離札轡腑鵑鬚気靴討い董△修海任蓮△錣譴錣譴劃途で暗号化されていて
d903 3
a905 3
サンプルの<b>VPN-east.conf</b>には、いろいろ変換方式が山ほどかいてある。なぜかというと 3DES や SHA は各種プラットホームで必ずしもサポートされいる
わけではないからだ澄緕帯ぢの場合、これを基本的な誓瀋蠅琶僂┐襪戮海脇辰砲覆ぁ海離札轡腑鵑鬟灰圈爾靴栃儡絞阿鯤僂┐襪里蓮
ぞんぶんにやってほしい。唯一、必要になるのは、 Configuration= 変数も変えることだ澄
箙唄
畊姥
腫ぢこのセクションは、VPN経由で送られるデータの暗号の要件を記述するところで、
上の <i>Configuration</i> で参照される。このセクションと、
すぐ上のフェーズ 1 でここに相当するところとのちがいは、 <b>EXCHANGE_TYPE</b> が <b>QUICK_MODE</b>になっていることなのに注目。
フェーズ 2 では必ずこうなる。
<b>Suites=</b> は IPsec Suite セクションを指している。
d920 3
a922 3
ISAKMP と IPsec については、ほかにも誓睫誓することがいっぱいある。いまの基本的な誓睫誓をもとに、
自立してやっていける単純ながらも堅牢なVPNができる。
でもこれは、両ホストにとって<i>必要最低最小限の</i> 
d925 1
a925 1
<h3>13.8.3 - isakmpdの起動</h3>
d933 2
a934 2
走る。そしてすべてをターミナルに出力する。isakmpdを止めて
経路を一掃するには、各ノードでisakmpd プロセスを殺してから
d940 1
a940 1
<h1>13.9 - isakmpd を X.509 証明製颪箸い辰靴腓忙箸Δ砲深云
d943 1
a943 1
事前に共有した鍵のかわりに証明製颪鮖箸Δ茲Δ蜩瘠逅ぢを誓瀋蠅垢襪里蓮∧欷遒気譴討い覆ぅ團△燭気鵑△覽霏腑優奪肇錙璽両豺腓砲蓮
箙憾
畊憾
取仮証明製颪寮生誓鹿莢
箙軌
畊軌
鍵や証明製颪寮生誓了妬砲弔い討里茲さ劼蜩瘠逅
箙鬼
畊亀
蛋ぢ鍵、対応する CA X.509
証明製顱▲優奪肇錙璽紊蜩瘠逅ぢを使うコンピュータそれぞれに秘密鍵一つと、その秘密鍵のそれぞれに対して X.509
d958 2
a959 2
X.509 証明製颪蓮⊂斂誓書の持ち主を記述する Subject Alternative Name
(SubjectAltName) extension が必要だ澄斂誓書の SubjectAltName extension を
d961 2
a962 2
SubjectAltNameとしてIPアドレスを誓瀋蠅垢訃豺腓寮説明世凖祖妖防 に書いてある。
ここで IP アドレスを使うのは、isakmpd の
d965 8
a972 8
Certpatch はまた、 FQDN (Fully Qualified Domain
Name) か UFQDN (User FQDN) の使用もサポートしている。FQDN の例はたとえば
<tt>www.openbsd.org</tt> だ世掘嫺冂ぢの例としては
メールアドレスがある。たとえば <tt>Jorgen.Granstam@@abc.se</tt> など。
<p>
この howto 文書では、 FQDN を
SubjectAltNames で使う。IP アドレスを使うほうがちょっと簡単になる。
それが isakmpd のデフォルトのふるまいだ世蕕誓。
d981 4
a984 4
ここで ca.key は CA の秘密鍵なので、これが
できるのは CA 秘密鍵にアクセスできる人だ世韻誓。
home.mysite.se というのは（実在はしないけれど）証明製颪冒淨気譴襪戮苫栂 だ澄
闥蜃蜴瘡竇鶯鶯ぢと newcert.crt のファイル名は同じ名前にしてもいい。
d988 2
a989 2
この鍵と証明製颪髻凖祖妖防 の最後に誓睫誓にしたがってディレクトリに
放り込もう。もし本気で鍵を使うつもりなら、CA 鍵 (ca.key) は
d993 1
a993 1
<h2>isakmpdの誓瀋鹿莢
箙控
畊控
こんどは /etc/isakmpd/isakmpd.conf 誓瀋螢侫．ぅ襪鮓討笋蹐Α
箙更
畊更
さらに man ページにあるものよりもかなり短いファイルを使う。
d1002 1
a1002 1
 (一部のコメントは isakmpd.conf(5)にあったまま)、名前もちょっと変えた。
d1008 1
a1008 1
ぼくが誓睫誓しない部分については isakmpd.conf(5) を
d1026 5
a1030 5
要するに、二つのネットワークが、保護されていないネットワーク上を、IPsecトンネル経由で
誓楝海気譴襦△箸いΔ海函海海妊廛薀ぅ戞璽肇ぅ鵐拭璽優奪藩僂僕縮鵑気譴賓
アドレス (RFC1918) を使っていることは無視してほしい。
なにかしら例は必要だ世辰燭發鵑如蜩瘠逅ぢを NAT
と組み合わせて使うとかその手のをどうするかは誓睫誓しない(ぼく自身やったことがないから）。
d1033 1
a1033 1
セキュリティゲートウェイ gw.mysite.se用のファイルだ
箟鯵甕鯵逋皷蜩瘠逅筮竢鈕のはじまり       ************
d1111 1
a1111 1
# パケットで... 
d1227 1
a1227 1
セキュリティゲートウェイgw.worksite.seの isakmpd.conf ファイルの頭のところだ世姥討笋蹐
箟桶甕桶鳬皷蜩瘠逅筮竢鈕ぢのはじまり    **********
d1267 1
a1267 1
# **********************     ... つづく...      **********************
d1277 1
a1277 1
<h2>policy ファイル</h2>
d1279 2
a1280 2
実をいえば、policy ファイルは初めての人にはちょっとややこしいかもしれない。
特に思い通りに動かないときには。man-ページ
d1285 2
a1286 2
一番簡単な、ちゃんと機能する policy ファイルは
たった一行だ
箟温甕温癜闥蝴纈ぢタグは、policy を決める権限を持った人物、
ということだ澄Ｆ段癜闥蝴纈 である&quot;POLICY&quot; は、
policy について最終的かつ無限の権限を持つ。それ以外の authorizer は、
ここで権限を持つためにはまず &quot;POLICY&quot; に認定してもらわなければならない。
d1302 1
a1302 1
以下の policy はだ世蕁∨槓琉店罎魏燭箸辰途
箟外甕外これだ世津ぢを使っている人も認められて、DES は
いまやほとんどインチキと思ってもいいくらいだ世韻譴鼻△任津ぢを認めないように
この policy を変更するのは、読者の練習問題として残しておこうか）。
これだ世途ぢで暗号化する人ならだ世譴任眷Г瓩蕕譴襪海箸肪躇奸
箟崖甕崖誓楝海鯒Г瓩襦覆燭誓しこのパスワードは isalmpd.conf の Authentication タグでも
d1339 1
a1339 1
ライセンスを受ける存在はたくさんあってもいいけれど、そのすべてが &quot;POLICY&quot;に認定されなくてはならない。
d1341 2
a1342 2
ライセンス保持者は、policyファイルでさらに記述されていたら
単なるストリングでもいい:
d1360 1
a1360 1
さあみなさんお待ちかねの部分。Policy はまた、
d1364 1
a1364 1
policy ファイルに個別ユーザの証明製颪魏辰┐襪誓けでいい:
d1374 1
a1374 1
        CzA           この部分はユーザ証明製颪任瓦兇い泙垢叢殿
箟蓋甕蓋蜩瘠逅が CA- ディレクトリと Certificate
d1391 2
a1392 2
疑似資格証明澄竰繖緕瘡ぢ）に変換される。こうした疑似資格証明世吠儡垢気譴疹斂誓書は、
こんな感じになっている:
d1399 2
a1400 2
    	CzA  この部分はユーザ証明製顱覆弔泙蛋証明製顱砲暴靆召靴叢殿
耐　人の公開鍵／証明製颪任垢IUuz¥
d1410 2
a1411 2
        CzA          ここんとこは証明製颪鮗韻訛Δ慮阿法叢殿
耐ぢなります                       IUuz¥
d1422 3
a1424 3
さて、これらが &quot;POLICY&quot; に認められたものではないので、
それをなんらかの形で認知する policy がなければダ瀬瓩誓ということに注意。さらに、これは
内部で証明製颪匹Δ覆辰討い襪鮴説明世靴討い襦紊了餝幣斂誓（credential）は、
d1427 2
a1428 2
CA証明製颪鬟薀ぅ札鵐垢箸靴佻棉遅に書いてやれば、
ある CA が署名した証明製颪垢戮討縫薀ぅ札鵐垢个擦襦
箟干甕干丁この部分が CA 証明製颪任瓦兇い泙垢AQEB¥
d1452 2
a1453 2
つまり上の policy は、CA に権限委譲する policy の簡単な例だ澄
この証明製颪鮖辰蛋 が署名した証明製颪鮖辰討い
箟患甕患取仮ほとんど安全……は安全に非ず!</h2>
d1466 4
a1469 4
この段階で、isakmpds がどんな情報にアクセスできるか考えてほしい。
誓瀋螢侫．ぅ襪蕁蜩瘠逅ぢはピアがどの IP-アドレスから
送信してくるかわかる（[フェーズ 1] セクションで)。フェーズ 1 の
ネゴシエーションをするときに得世蕕譴訃霾鵑蕁▲團△匹鵑苗 を
d1471 1
a1471 1
そのIDを持っていることが証明世気譴襦Ｌ簑蠅覆気修Δ誓ね?
d1473 3
a1475 3
うん、もしID 情報が IP なら（フェーズ 1 の ID セクションを使わなければ
これがデフォルトに状況になる）すべてはオッケーだ澄蛋
はその IP を cert に結びつけて、誓瀋蠅涼罎賓
d1477 3
a1479 3
同じ IP を使うことも不可能ではない
（たとえば両方のコンピュータが同じ LAN 上にあって、
ふだ世鵑修賓 を使っているマシンがなんらかの理由でダ瀬Ε鵑靴討い襪覆鼻法
箟憾甕憾その IP がなりすまし犯のものだ世函壁埓正に）証明世垢襪海箸
箟憾甕憾もしそれが万が一起こったら、そのなりすまし犯はそのIPの所有者から秘密鍵を
どうにかして盗んだ世△△襪い蛋 をなんらかの方法でだ世泙靴董
箟憾甕換秘密鍵の保護が不十分だ世辰燭蛋 が
なりすまし犯の身元（あるいは cert の
ID 情報）を十分にチェックできなかったか、あるいは CA 秘密鍵が十分に保護されていなかったかだ澄
箟換甕軌証明製颪涼罎法賓アドレスではなく FQDN が入っている。
[Phase 1] セクションにまだ賓 アドレスがあるので、
これはセキュリティ問題となる可能誓△襦瓶阻熔
フェーズ 1 ネゴシエーションの間に何が起きるかというと、ピアが
期待どおりの IP から送られてきたことをチェックできる（でもさっき誓睫誓したように、
これは一部の状況ではごまかせる）。ピアが提示するIDを、
d1503 2
a1504 2
でも、いまチェックできないのは、そのID が本当にそのピアが持っていると期待すべき ID なのか、ということだ澄
蜩瘠逅は、どんな ID を期待すればいいか一度も教わっていないからだ澄
箟軌甕軌栂システムがホストのために IP を FQDN と
結びつけてくれる、という人もいるだ世蹐Α修譴呂修Δ覆鵑誓けれど、現在の DNS システムはセキュリティが高くないし、
d1509 7
a1515 7
できる（あるいはサービス拒否（DoS）攻撃を
攻撃者に受けて、その攻撃者のマシンがDNSサーバの答を
偽造することもできる）。いずれ高セキュリティ DNS も登場するけれど、
まだ製于鵑辰討い覆い掘幣覆箸發曚箸鵑匹栂ぢサーバはまだ盛皀札絅螢謄任呂覆ぁ法
だ世藐什漾竇鶯 の FQDN が期待される IP と対応しているかを調べるのに
DNS を使っても保証にはならない。実は isakmpd はこれを DNS にきいたりしない。
DNS が安全でも、UFQDNを使っている場合には
d1518 1
a1518 1
つまり ID として FQDN を使う場合、アタッカーは
d1520 2
a1521 2
同じ CA に署名させる（でももちろんアタッカー自身の FQDN を使って)。それから
ピアに DoS 攻撃をしかけてダ瀬Ε鵑気擦ぢ実は
d1523 2
a1524 2
リモートDoS を仕掛けてダ瀬Ε鵑気擦討靴泙┐覯椎柔性があるけれど、
isakmpd がこういう攻撃に対してどのくらい敏感かは知らない)。それから
d1527 1
a1527 1
自分のIDと秘密鍵と証明製颪鮖箸┐襦
箟飢甕騎ぼくたち側の isakmpd は、こっちのピアへの ID が何かを教わっていない（そしてそれは、アタッカーが
証明製颪苗と秘密鍵以外はまったく同じ誓瀋蠅砲靴討い燭蕁法気蕕砲椶燭舛
蜩瘠逅は証明製颪韻蛋 のサインしたものだ世肇船Д奪任襦覆任
多くの CA はcert をいっぱいサインするから、cert を手に入れるのはむずかしくないかも）。そして
そこで示された ID が証明製颪涼罎苗 といっしょなのも確認できる。でも、
これまで提示された誓瀋蠅任蓮△修苗 が期
待していた ID かどうかはチェックできない。だ世薀▲織奪爾論接続を認められてしまう。
d1538 1
a1538 1
<h3>攻撃をふせぐ</h3>
d1540 1
a1540 1
すると問題は、どうやったら isakmpd に期待すべき ID のことを教えてあげられるか、
d1544 1
a1544 1
たとえばこんなふうに:
d1554 1
a1554 1
        CzA             この部分が CA 証明製颪任瓦兇い泙垢AQEB¥
d1569 3
a1571 3
これで、IPsec誓楝海鯑誓られるのは gw.worksite.se だ世韻里呂此
かに remote_idのチェックを足せば、許可されるIDは簡単に増える。
つまり以下のようなのを policy に足せばいい:
d1583 1
a1583 1
この policy だ世函范闥謫蜚絎黼范闕纉蜚絎黼、
d1588 1
a1588 1
という人もいるだ世蹐Α斂誓書を policy に
d1591 1
a1591 1
ややこしい policy のなかで、CA 証明製颪箸泙舛┐
箟宜甕宜竟跚笙ぢファイルを見てもそれをつきとめるのはむずかしい (X.509 証明製颪
人間に読める形ではないから)。
d1599 5
a1603 5
この問題の解決方法がある。いまでは、policy 内で証明製颪修里發里里錣蠅法
証明製颪堤齡蜴苺蜩蒹令辣 (DN) を使うことができる（対応する
証明製颪呂發舛蹐鵐妊好紊竇鶯
か ca ディレクトリにあって、isakmpd が見つけられるようになっていること)。この
形式だ世函⊂紊竟跚笙 は以下のような感じになるだ世蹐
箟恐甕恐ずっと読みやすい、でしょ？　ある証明製颪寮正確な DN
は、openssl ユーティリティを使って証明製颪鮓討笋襪箸錣襦
こんな具合:
d1629 1
a1629 1
もっと複雑な policy はもちろんできるけれど、
d1633 2
a1634 2
これで ca.crt の中の証明製颪砲弔い読廚幣霾鵑
提供されるはずだ澄竟跚笙 が小さいか、そこそこくらいなら
d1638 1
a1638 1
<H2>マルチユーザ誓瀋蠅函羆浜診Ь鹿莢
箟挟甕挟それじゃ isakmpd のホントにクールな機能をいくつか見てやろう。これまでは、
誓楝海靴討襪呂困離團△呂茲里蕕譴討い董賓アドレスも誓電妨把蠅気譴討い襪發里箸靴拭
でも、そういう場合ばかりじゃない。動的に割り当てられたIPを使ったり、
d1647 3
a1649 3
そこでisakmpdのすてきな機能の一つは、
[Phase 1]セクションでIPではなくデフォルトのタグを使えるというもの。
これによって、isakmpdはどのIPからでもネゴシエーションを受け付けられるようになる。
d1659 1
a1659 1
まず言世辰討戮覆里蓮△海寮設定はDoS攻撃に対して
d1661 1
a1661 1
ISAKMP/IKEプロトコルには欠陥がある。いずれにしても、デフォルトの [phase 1] セクションを使えば、
d1668 1
a1668 1
どのコンピュータからでも（社内LAN上のものに限らず）誓楝海任襪茲Δ砲靴燭い韻譴鼻
箟況甕況次のようなpolicy が書けるはずだ澄
箟訓甕訓ぜんぜん動かないかもしれない）。それと、こいつみたいなpolicy （というか、
デフォルトがピアのIPにしてあるものすべて）は、isakmpd.confファイルもあわせて書き換えないと
d1716 2
a1717 2
たぶん誓楝海靴真佑栂 はすべてログしておいたほうが
望ましい。isakmpd はぼくの知る限りでは、これをまだ瀬汽檗璽箸靴討い覆ぁ気蕕
箟群甕群もしこういう形でISAKMP/IKE を使っているコンピュータがすべて、
リモートからユーザが使いたいと思っているサービスのそれぞれについて、条件の束を持っていたとしよう。すると CA は、
ユーザの証明製颪砲靴襪戮囎礪繝踉令辣
d1733 2
a1734 2
すべてのコンピュータ上のpolicyファイルを変える必要もない。
同じ方式はISAKMP/IPsec 以外の目的にも使えるはずだ澄淵侫薀ぅ鵐轡好謄爐稜Ь擇気┐任襦法
箟軍甕軍とにかく。これをやる組織はおそらく自分で自分自身のCAになったほうがいい。
d1741 1
a1741 1
事前共有鍵でもできうけれど、でもそれだ世函△匹賓から誓楝海靴討襪錣蕕覆い蕁
箟郡甕郡だ世苗瀰厦ぢモードではなくAGGRESSIVE モードを
使わなくてはならない(AGGRESSIVE モードでは、IDはネゴシエーションの
d1752 1
a1752 1
<h1>13.10 - isakmpdで使えるIKE クライアントは?</h1>
d1755 2
a1756 2
<tt>isakmpd</tt> は、OpenBSD についてくる ISAKMP/Oakley 鍵管理デーモンだ澄
たぶん、ほとんどの ISAKMP 実装とは、部分的にせよ相互運用可能だ世隼廚Δ韻譴鼻
箟卦甕卦蜩瘠逅ぢソフトの一部は、実は OpenBSD isakmp デーモンをベースにしたものだ世辰燭蠅垢襦
箟袈甕袈以下の MS-Windows クライアントは、互換誓△襪箸諒鷙陲△
箟袈甕袈写評釈鱚羹∵雕迚竰闢閹竢蹉祥蜒鳫齒胄鹿畩蜴粹旭鱇銖竟鶯ぢモードのみ)
d1769 1
a1769 1
以下のゲートウェイ/ルータも互換誓△襪箸諒鷙
箟傾甕傾賓黼トラブルシューティングの最初のツールは <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&apropos=0&sektion=8&format=html">tcpdump(8)</a>だ澄
箟傾甕鍵まずOpenBSDの tcpdump を使っている人は、
拡張版の tcpdump を使っているので、
ESP と AH パケットについても情報がとれる。もし OpenBSD
2.5 や他の OS の tcpdump を使っているなら、たぶん古い
バージョンだ世組 や ESPについてはプロトコル番号しか表示されない
(ESP は IP プロトコル 50, AH は 51)。
d1805 1
a1805 1
tcpdump では、トラフィックが AH/ESP を使っているか平文のままかを確かめよう。
d1807 1
a1807 1
isakmp のネゴシエーションがうまくいっていない。<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&apropos=0&sektion=8&format=html">ping(8)</a>を使って
d1811 2
a1812 2
たとえば、208.1.1.1 と 208.2.2.2 の２つのホストがある。
208.2.2.2 にログオンして、以下をやってみよう:
d1823 1
a1823 1
別のセッションでは、encapsulated されたpingが見られる:
d1838 1
a1838 1
<LI>ISAKMP はUDP port 500で実行される。もしこれがファイアーウォールか
d1850 1
a1850 1
<LI>Photuris は UDP port 468 で動く。考えるのは同じことだ世韻譴鼻▲廛蹈肇灰襪瘉だ澄
箟厳甕厳写評賓黼ぢで処理されたトラフィックを、netBから自分のローカルのファイアーウォール保護つきnetAに
d1880 2
a1881 2
<LI>OpenBSD の tcpdump だ世函△曚箸鵑匹離ぅ鵐拭璽優奪
鍵交換（自動鍵交換）セッションの平文部分はほとんどデコードできる。Tcpdump はまた AH ペイロードデータも表示する。
d1889 2
a1890 2
/kern には、現在の SA/SPI 一覧表があって、フローがあるもの
（外行きの SA）もないもの（入ってくる SA)も記述されている。
d1894 1
a1894 1
<LI>最後に、 <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=netstat&apropos=0&sektion=1&format=html">netstat(1)</a> を使って SAを見ることができる。
d1912 3
a1914 3
これだ世韻笋辰討皀誓メなら、<tt>option ENCDEBUG</tt>つきでカーネルをコンパイルしなおすこと。
それから <tt>net.inet.ip.encdebug</tt> を 1 にする。そして dmesg を見て
警告やエラーをさがし、それを <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendbug&apropos=0&sektion=1&format=html">sendbug(1)</a>を使って
d1916 1
a1916 1
バグかどうかわからなかったら、 you may want to send a message to one of the <A HREF="../../mail.html">メーリングリスト</a>のどれかにメッセージを投げてみよう。
d1922 1
a1922 1
<h1>13.12 - 関連ドキュメンテーション</h1>
d1927 1
a1927 1
ページだ澄３銅錣寮設定テンプレートが <A HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/">/usr/share/ipsec/</a>
d1937 1
a1937 1
のmanページも詳しくて、IPsecの誓瀋蠅髪人僂北鯲弔呂困誓。
d1950 1
a1950 1
そしてつづきましては RFCども...</a>
d1984 3
a1986 3
<a href= "index.html">[FAQ トップへ]</a>
<a href= "faq12.html">[12.0 - 高度なユーザ向け]</a>
<a href= "../faq14.html">[14.0 - OpenBSD のハードディスク]</a>
d1996 1
a1996 1
$Translation: faq13.html,v 1.5 2002/03/23 09:58:16 jufi Exp $
@


1.3
log
@
sync with badlands translation CVS.
@
text
@d3 1
a3 1
<title>13.0 - IPsec を使う</title>
d9 1
a9 1
<meta name= "copyright"     content= "This document copyright 2000-2001 by OpenBSD">
d13 1
a13 1
<body bgcolor= "#ffffff" text= "#000000" link= "#23238E">
d16 1
a16 1
<h1><font color=#e00000>13.0 - IPsec (IP Security Protocol) を使う</font></h1>
d19 2
a20 2
<P>
<h3>目次</h3>
d22 12
a33 12
<LI><A HREF="#13.1">13.1 - IPsecって何?</A></LI>
<LI><A HREF="#13.2">13.2 - そりゃ結構だ世韻譴鼻△海里椶覆偕繝ぢなんか使わにゃならんの?</A></LI>
<LI><A HREF="#13.3">13.3 - IPsecの裏にあるプロトコルは?</A>
<LI><A HREF="#13.4">13.4 - ネットワーク上のパケットフォーマット</A>
<LI><A HREF="#13.5">13.5 - IPsec の誓瀋鹿曽
写評質凖峠■嘘⊂嘘偕繝ぢを手動鍵誓瀋蠅濃箸Δ砲深写評質凖峠■嘘⊂嘘蓖鱸黻ぢのセットアップは?</A>
<LI><A HREF="#13.8">13.8 - isakmpd のセットアップは?</A>
<LI><A HREF="#13.9">13.9 - isakmpd を X.509 証明製颪隼箸Δ砲深写評質凖峠■嘘唖庄凱碓謀ぢクライアントで isakmpd と互換誓△襪里深写評質凖峠■嘘陰庄凱臼偕繝侘ぢのトラブルシューティング</A>
<LI><A HREF="#13.12">13.12 - 関連ドキュメンテーション</A>
d37 1
a37 1
このドキュメントの一部は、以下のドキュメントからとっている:
d39 5
a43 5
<LI><A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&sektion=4&format=html">ipsec(4)</a>
<LI><A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&sektion=8&format=html">vpn(8)</a>
<LI><A HREF="http://www.freebsd.org/‾julian/IPSEC_4_Dummies.html">IPsec for Dummies</a> by Julian Elischer
<LI><A HREF="http://www.secureops.com/vpn/vpn.html">ISAKMP Howto</a> by Patrick Ethier
<LI><A HREF="http://hem.passagen.se/hojg/isakmpd/">X.509v3 certificates with isakmpd</a> by J&ouml;rgen Granstam
d48 22
a69 3
<a name= "13.1">
<h1>13.1 - IPsecってなに?</h1>
</a>
d71 1
a71 16
IPsec は、IP プロトコルファミリーに対する拡張だ澄
暗号セキュリティサービスを提供する。このサービスで、認証、
完全誓蜴苒蜚ぢ）、アクセス誓罅〔性が提供される。IPsec は
SSL と似たサービスを、ネットワーク層で提供して、しかもアプリケーションにはまったく
透過的で、しかもずっと強力。透過的というのは、
アプリケーションのほうでは IPsec を使うのに、IPsec のことを何一つ知らなくていい、
ということだ澄
賓黼上では<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/protocols?rev=1.8">あらゆる IP プロトコル</a>を使える。暗号化トンネル (VPN) も作れるし、コンピュータ間で単純な暗号化をしてもいい。
オプションが実にいろいろあるせいで、IPsec はちょっとややこしいのである (それも SSL よりずっと!)
<P>
IPsec を使う前に、
FAQ <a href="../faq6.html">6章</a> の推奨文献には
誓鵑箸睫椶鯆未靴討い討曚靴ぁＦ辰法△發アドレスの考え方がわかっていなかったら、<a href="http://www.3com.com/nsc/501302s.html">Understanding
IP Addressing</a> は大いにお奨めだ澄
斜論斥砲蓮賓黼は以下のどんな形でも機能する:
d77 128
a204 119
ネットワークのからむすべてのシナリオで、ぼくたちはルータを念頭においている。
つまりは Host-to-Router (そしてこのルータは、ある<i>Network</i>の
トラフィックを誓罎靴動店羃修垢ぢ。
<P>
これから見るように、IPsec は VPN 誓楝獲僂縫肇薀侫奪鬟肇鵐優襪任襦
でも、その応用は VPN よりはるかに広い。中央インターネット鍵交換登録所があれば、
インターネット上の全マシンはお互いにやりとりをするときに、
強力な暗号や認証が使えるようになるんだ澄
腫釈瘢綵嘘⊂
取云嘘ぢそりゃ結構だ世韻譴鼻△海里椶覆偕繝なんか使わにゃならんの?</h1>
</a>
<P>
インターネットのプロトコルである IP または IPv4 は、それ自体としては、転送しているデータに対して何の保護も提供しない。
送り主が、自分で名乗っている通りの存在かどうかすら保証してくれない。
IPsec はこれを解決しようとする。以下のサービスはそれぞれ独立と考えられているけれど、
IPsec はそれを統一的な形でサポートしている。
<P>
<h4>機密誓鹿茣受信者以外の人には、どんなデータが通信されたかを
理解しにくいようにしておく。インターネット経由で
リモートのマシンにログインするとき、
ほかの人にパスワードを知られたくないよね。
<P>
<h4>完全誓侮苒蜚ぢ）</h4> データが途中で改竄されないようにする。
誓禅畚颯如璽燭鬟鵐薀ぅ鵑覗襪鵑覆蕁
数量や金額やアカウント番号が誓騎里如
途中で改竄されたりしていないか確かめたいでしょう。
<P>
<h4>Authenticity（誓疑神性／確実誓鹿茣データに署名して、それを送ったのが本当にあなただ世搬召凌佑
確認できるようにする。ドキュメントがインチキじゃないと確認できるのは、
どう考えてもよいことだ澄
斜取款再送保護（Replay protection）</h4> やりとりは、何度も繰り返すよう認められたもの以外は、
確実に一回だ世韻靴生じないようにする方法が必要だ澄弔泙蝓
だ世譴笋蠅箸蠅魑燭靴討い董
それをそのまま再送して、結果として同じ応答を何度ももらう、ということができないようにする必要がある。
たとえば、攻撃者が暗号クラック以外の手段でトラフィックの趣旨を他の方法でつきとめて、
そしてそのトラフィックが、その人物にとって有利なイベントを誓犬犬気擦襪發里
しよう（かれの口座にお金を振り込むとか）。
その人物が、あとから単純に同じトラフィックを再送しても
うまくいかないようにする必要がある。
<i>警告: 通常の仕様に関する限り、手動鍵の IPsec を使っているとき 
(たとえば <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&amp;apropos=0&amp;sektion=8&amp;format=html">ipsecadm(8)</a> を使っているとき)
には再送からの保護は実行されない</i>.
<p>
<a name= "13.3">
<h1>13.3 - IPsec の裏にあるプロトコルは?</h1>
</a>
<P>
IPsec は、機密誓袷汗性、authenticity（誓疑神性）、再送保護を提供するのに、
新しいプロトコルを 2 つ使う。このプロトコルは AH（
Authentication header, 認証ヘッダ澄砲嗤（Encapsulated security payload、暗号ペイロード）だ澄
斜組ぢは認証と完全誓蛤徳欷遒鯆鷆，垢襦覆〔性は提供しない）。
ESP との主な差は、AH はパケットの
IP ヘッダ世琉貮堯覆燭箸┐丱僖吋奪箸糧機α蠕先アドレス）も
保護することだ澄
斜途は認証、完全誓∈徳欷遏▲如璽慎〔性を
提供する（ヘッダ世砲弔鼎僖吋奪汎發里垢戮討鯤欷遒垢襦法
再送保護は認証と完全誓廚誓
（この二つはいつもペアでくる）。機密誓憤店羃宗砲蓮
認証/完全誓△辰討發覆討盪箸┐襦
同じように、認証・完全誓狼〔性なしでも使える。
<P>
<a name= "13.4">
<h1>13.4 - ネットワーク上のパケットフォーマット</h1>
</a>

<P>   <B>認証ヘッダ澄装緕竅闔縺粤ぢ）</B>
(AH) は基本的な IP ヘッダ世慮紊砲董▲如璽燭琉店罐魯奪轡紊
識別情報を持っている。ハッシュは 
IP ヘッダ声里痢疏罎肪佑儔修靴覆ど皀弌爾任襦
組ぢに使う実際のアルゴリズムについては、いくつか別個の RFC があって選べるようになっているけれど、
そのどれも、<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC2402</a>に指定されたガイドラインには準拠していなくてはならない。

<P>The <B>暗号ペイロード（Encapsulating
Security Payload）</B> (ESP) ヘッダ世蓮▲撻ぅ蹇璽匹魄店羃修気譴新舛能颪垢┐襪海箸魏椎修砲垢襦
途ヘッダ世蓮△修譴棒先立つ IP
ヘッダ世楼靴錣覆い里如▲撻ぅ蹇璽桧奮阿里發里砲弔い討呂泙辰燭歉擇靴覆ぁ
それぞれ各種の ESP は <A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC2406</A>にしたがう必要がある。
ESP ヘッダ世蓮▲撻ぅ蹇璽匹稜Ь擇眥鷆，任襦覆嗤ぢの外の
ヘッダ世砲弔い討惑Ь擇任覆ぁ法

斜症偕繝ぢ機能の（ほとんど）独立した部分が、IPsec encapsulation を
やっているのがデータのもとの発信源かゲートウェイかに
応じて適用される:

<UL>
<LI><B>Transport</B> モードは、パケットを誓言成しているホストが使うものだ澄
夸瘤齔闥モードでは、セキュリティヘッダ世魯肇薀鵐好檗璽帆弛嫩乂ぢのヘッダ世料阿法賓ヘッダ世僖吋奪箸寮先頭につけられる前の段階で追加される。
言世ご垢┐襪函▲僖吋奪箸膨媛辰気譴が
TCP ヘッダ世函緕筬鈔ヘッダ世琉貮凜侫璽襯匹離魯奪轡鵐阿鮹甘垢襪箸いΔ海箸誓。
そしてTCP ヘッダ世肇如璽燭琉店羃修嗤
ヘッダ世弌爾垢襪韻譴鼻△任發修譴鈔鎰緕賓ぢヘッダ世楼店羃修靴討譴覆ぁ鹿棉
写評実ぢトンネル</B> モードは、すでに end-to-end IP ヘッダ世
パケットに追加されているときで、さらにセキュア誓楝海諒卻涼爾
ただ世離押璽肇ΕДい里箸忙箸錣譴襦海離癲璽匹任蓮組ぢと ESP ヘッダ世蓮鈔鎰緕蒹痲纈ぢを含め
パケット全体をカバーするのに使われる。そしてセキュア誓楝海慮海γ爾泙任離曠奪廚里
（といっても、これはもちろん複数の IP ホップをまたがるかもしれないけれど）をカバーする、
新しい IP ヘッダ世弔韻覆気譴襦鹿棉鹿嫐
斜症偕繝ぢで保護されたリンクは、<B>Security Associations
</B>(SAs) によって定義づけられる。各 SA は単一の単方向のデータの流れについて定義されて、
普通は（マルチキャストは無視して）一つの点世虔未療誓までについて、
なんらかの<B>ユニークなセレクタ</B>によって識別できるトラフィックフローをさす。単一の SA 上を流れるトラフィックはすべて
同じ扱いを受ける。トラフィックの中には、複数の SA を経るものもあって、
そのそれぞれがなんらかの変換を加える。SA の集団を
SA <B>Bundle</B> と呼ぶ。入ってくるパケットは、3 つの定義フィールド
(<B>宛誓アドレス, セキュリティパラメータインデックス（Security Parameter
Index）, セキュリティプロトコル</B>)に応じて指定の SA に割り当てることができる。
セキュリティパラメータインデックス（Security Parameter
Index、略してSPI）は誓楝海離僖薀瓠璽燭離優乾轡─璽轡腑鵑圓錣譴襪箸法啻ぢの受け手が手渡すクッキーだ世隼廚┐个いぁ
セキュリティプロトコルは AH か ESP のどちらかでなくてはならない。受け手の IP
アドレスがこの３つ１組の中に含まれているので、これはユニークな値になることが保証されている。
これは外側の IP ヘッダ世藐弔韻襪海箸發任襪掘∈能蕕離札絅螢謄悒奪誓（これは SPI とセキュリティプロトコルを含む）から見つけることもできる。
d206 1
a206 1
<P>トンネルモードの AH パケットの例を挙げよう:
d210 1
a210 1
<td><B>IPヘッダ鹿他鹿箍渦
甓唄
儒箴賓ヘッダ下箴
儒箴埣ぢヘッダ鹿儒箴データ</td>
d218 1
a218 1
<P>transport モード AH パケットの例を挙げよう:
d222 1
a222 1
<td><B>IPヘッダ鹿他鹿箍牡
甓乙
儒箴埣ぢヘッダ鹿儒箴データ</td>
d229 2
a230 2
<P>ESP ヘッダ世漏安Δヘッダ世鯒Ь擇任覆い里如
組ぢと ESP ヘッダ世鯀箸濆腓錣擦銅，里茲Δ砲靴燭曚Δい箍慨
甓慨
儒箴実症ぢヘッダ鹿他鹿箍碍
甓蓋
儒箴蕊菖弛ヘッダ鹿評鹿儒箴蕊ぢデータ</I></td>
d242 2
a243 2
<P>これは <B>Transport Adjacency</B> と呼ばれる。トンネル版だ世
こんな感じだ箍慣
甓慣
儒箴実症ぢヘッダ鹿他鹿箍軌
甓飢
儒箴蕊症ぢヘッダ下昭箴
儒箴蕊菖弛ヘッダ鹿評鹿儒箴蕊ぢデータ</I></td>
d256 56
a311 54
<P>でも、これは RFC には明声傍劼気譴討い覆ぁ夸瘤齔闥痲裃竇釿と同じように、これはIP ヘッダ世涼罎離悒奪誓いくつかを除いて全パケットを認証したうえで、
ペイロード（イタリクスで表示）を暗号化する。
AH と ESP ヘッダ世海里茲Δ膨樟接いっしょに適用されているときには、
ヘッダ世僚臠屬肋綉里茲Δ砲覆辰討い詆廚△襦肇鵐優襯癲璽匹任蓮
任意の recursive encapsulation をやることで、この順番が指定されずにすむようにすることもできる。

<A name="13.5">
<h1>13.5 - IPsec の誓瀋鹿莟鹿畩

斜症偕繝ぢシステムとゲートウェイがどう誓瀋蠅気譴襪蓮△△訥戮論設計者まかせに
なってはいるのだ世韻譴鼻△任特ぢはそれがどう実装されるべきかについて強いレコメンデーションを行って
混乱を最小限におさえようとしている。

<p>パケットに何が起こるかをコントロールする、管理エンティティが２つある。
一つは<B>Security Association Database</B> (SAD, 
OpenBSDの IPsecソースコードの中では、TDB または TDB table と呼ばれている）で、
もう一つは<B>Security Policy Database</B> (SPD)だ澄

斜ぢこの二つは、あるトラフィックを表現したセレクタをいくつか与えられると、
必要となる処理を記述したエントリを提供してくれるという点世濃討い襦
でもSPD は実際の処理から二段階ほど遠いところにある: 
SPD は外へ出るパケットに使われて、どの SAD エントリを使うべきか決めるのに利用される。
逆に SAD エントリは、実際のプロセスとそこで使うパラメータを記述する。
SPD のエントリは、既存の SAD エントリのうちどれを使うか
（バンドルなら、SAD エントリは複数あり得世襪里如砲鮖慊蠅垢襪韻譴鼻△任發垢任
適誓擇覆發里覆い覆蕁△修離┘鵐肇蠅鮖箸辰匿靴靴い發里弔蕕譴襦弔蕕譴のフィールドは、
SPD エントリから持ってくる場合もあるし、そのフィールド新誓澆
開始させたパケットから持ってくる場合もある。

<P>　外行きのパケットは、SPD エントリから個別の SA に行ってエンコーディング用
パラメータをもらう。入ってくるパケットは、SPI/宛誓賓ぢプロトコルの 3 点瀬札奪箸鮖箸辰
直誓楡正しい SA にたどりつき、そこから SPD エントリにたどりつく。

<P>　SPD はまたどのトラフィックが IPsec をバイパスすべきか、またどのトラフィックを
捨てるべきかを指定できるので、入ってくる非 IPsec のトラフィックについても参照されなくてはならない。
SPD エントリは、順番が明声房┐気譴討い詆廚△襦△襯僖吋奪箸吠瑤里發里泪奪舛垢覯椎柔性があるし、
処理には再現誓覆討呂覆蕕覆い蕕誓。

<P>SPD というのは、パケットフィルタと似たようなものだ世隼廚┐个いい發靴譴覆ぁ修海之萃蠅気譴襯▲轡腑鵑箸いΔ里蓮
啻ぢプロセスの起動になるわけだ澄札譽燭箸靴道箸┐襪里
送信元と宛誓茱▲疋譽后愀犬△訃豺腓砲魯檗璽犯峭罅▲▲廛螢院璽轡腑鵑筺△△訃豺腓砲魯罅璽（これは host based transport SAのみ)、ホスト名、セキュリティ
感度レベル、プロトコルなどだ澄

斜肖祖ぢエントリに含まれるのはたとえば:

<UL>
<LI>宛誓アドレス
<LI>IPsec プロトコル(AH か ESP)
<LI>SPI (クッキー)
<LI>シーケンスカウンタ
<LI>Seq O/F フラグ
d313 28
a340 28
<LI>AH の種類と情報
<LI>ESP の種類と情報
<LI>寿命情報
<LI>Tunnel/transport モードフラグ
<LI>Path MTU 情報
</UL>

<P>SPD エントリに含まれるのは:

<UL>
<LI>SA起動ポインタ
<LI>セレクタフィールド
</UL>

<P>各 SA は、ESP ヘッダ整譴弔ヘッダ整譴弔鯆蟲舛任襦
賓黼セッションはこのどちらか、あるいは両方を持たなきゃならない。どちらのヘッダ世發覆靴把蟲舛気譴襪海箸
できない――さもないと、SA を参照するための SPI を指定するヘッダ世覆い海箸砲覆辰討靴泙Α
卞は、AH とESP ヘッダ世佗ぢの値について
別々の指定をしている場合のことは定義していない。察するに、
これはバンドル中の複数の SA を意味するものと判断されるだ世蹐Α

斜章鞳鄲喞ぢの SPD は、<tt>ipsecadm flow</tt> コマンドを使って管理される
（これに変更を加えるのは、手動鍵誓瀋蠅鮖箸豺腓誓けだ澄法
啻エントリは、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&apropos=0&sektion=8&format=html">ipsecadm(8)</a>を使えばマニュアルで誓瀋蠅任襪韻譴鼻
錨堝ぢはセッションや鍵交換の初期化などの
自動メカニズムも定義している。
OpenBSD はPhoturis (<A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2522.html">RFC2522</a>および
d342 1
a342 1
と ISAKMP 自動かぎ交換
d346 1
a346 1
を実装していて、それぞれ
d348 21
a368 19
と <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&apropos=0&sektion=8&format=html">isakmpd(8)</a>
デーモンで使われている。
<P>
<a name= "13.6">
<h1>13.6 - 手動鍵誓瀋蠅偕繝ぢを誓瀋蠅垢襪砲呂匹Δ垢襪深云
鹿畩
斜賓黼ぢの手始めとしていちばんかんたんなのが手動鍵誓瀋蠅誓。
この手法でネットワーク間を暗号化してVPNをつくれる。
この部分を読んだ世蕁△海寮設定を
自動化するのに<A HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.3">/usr/share/ipsec/rc.vpn</a>
を使う、なんていうのもやってみるといいかもしれない。
<P>
まず、OpenBSDカーネルの IP AH と IP ESP オプションを有効にしよう
(もし rc.vpn スクリプトを使っていたり、あるいは
この次の例のように、ESP だ世韻鮖箸辰討い襪茲Δ幣豺腓砲蘊組は有効にしないでいい。</i>それどころか、
使っていないのに AH を有効にするとセキュリティ上の問題が
発誓犬垢襪發靴譴覆ぁ法斜こういうプロトコルを有効にするための、すてきな sysctl がある。
d375 9
a383 9
起動時にこれをたちあげるには<tt>/etc/sysctl.conf</tt> を編集すればいい。
使いたいものに応じてnet.inet.esp.enable そして/あるいは
net.inet.ah.enableの前の # をはずし、それが 1 にセットされている
ことを確かめよう。
<P>
さらに手動鍵の誓言成も必要だ澄
嶄のセキュリティは、この鍵を推定するのが不可能だ世箸いε誓にかかっているので、
この鍵を選ぶのには強力な乱数源を使うのがとてもだ世い犬誓。
これを誓言成するのに実用誓發な，琉譴弔箸靴董
箜元
甞元
デバイスを使う手がある。たとえば160ビット分の乱数誓鬚弔蠅誓すには、以下のようにする:
d389 1
a389 1
誓言成されるビット数はだ世い犬誓。暗号の種類によって、必要な鍵のサイズがちがう。
d391 1
a391 1
暗号方式    鍵長
d394 2
a395 2
BLF       可変 (40-160, 160 bits 推奨)
CAST      可変 (40-128, 128 bits 推奨)
d399 11
a409 11
では、SA (Security Associations) の誓瀋蠅鬚靴茲Α
嚆笊鱸齠閭蛛闔ぢというのは、IP アドレス、SPI, 
セキュリティプロトコル (AH そして/または ESP) の組み合わせだ澄賓ぢアドレスは、あなた自身のものと、
送り誓茲里發領省誓。SPI (Security Parameter
Index) は各種 SA の分類に OpenBSD が使う番号だ澄
斜蕊ぢこれらの例は、トラフィックの暗号化に ESP しか使わない。ESP は
暗号化された中身のデータの認証はするけれど、AH とはちがって
それを包むIP ヘッダ世惑Ь擇靴討譴覆ぁ海痢峺造蕕譴診Ь據廚蓮
それでもほとんどの場合にはまったく十分なものだ澄Ｆ辰縫肇鵐優覺超任
途の場合には。</I>
d418 1
a418 1
これを二つのルータで実際にやってみよう。ルータのIPアドレスはそれぞれ192.168.5.1 と 192.168.25.9だ澄
箚屋
甦屋
ホスト192.168.5.1上では:
d427 1
a427 1
ホスト 192.168.25.9上では:
d435 1
a435 1
ごらんのように、SPI がちがっている。SPI が何で、それがどこで使われているかについての完全な誓睫誓は、<A HREF="#13.4">On the wire format</a> を参照。
d437 2
a438 2
これで Security Associations ができあがったので、
フローを誓瀋蠅靴茲Α
箚完
甦幹
まずは192.168.5.1から:<P>
さてここでいきなり、フローが<b>2つ</b>創られる。一つはローカルのソースアドレスで、
ローカルホストから出て目的地に向かうすべてのパケットをカバーし、
もう一つのフローは送り誓茲薀蹇璽襯曠好箸北瓩辰討
フローだ澄
箚軌
甦軌
厩荻蔚軒乙側ではこんな具合だ箚儀甦祁もし Host-to-Host VPN のオーバーヘッドを減らしたければ、SPI
を作るのに <tt>-forcetunnel</tt> をはずしておくと、transport モードが使える (<tt>-forcetunnel</tt>
を使うと IP ヘッダ世泙粘泙鵑誓IP パケットのすべてが必ずSPIにカプセル化
される)。もし
発信元か送り誓茲里匹舛蕕優奪肇錙璽覆蕁▲肇鵐優襯癲璽匹鮖箸Δ靴覆ぁ
ネットワークから出入りするトラフィックに SA を使うと、自動的に
トンネルモードの SPI が確実に作られることになる。
<p>
これはIPsecを使い始める簡単なやりかただ澄
斜賓黼を使えば、プライベート IP アドレス空間をインターネットごしにつなげる。
いい例を挙げよう……208.1.1.1の背後にある 192.168.99.0/24 と、
208.2.2.2の背後にある 208.1.5.0/24 と 208.1.2.0/24 をトンネルでつなげたいとしよう。
以下の例は <A HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.3">rc.vpn</a> スクリプトを使って誓言成したものだ澄
斜ごらんのとおり、IPsecで手動鍵誓瀋蠅鮖箸辰討い襪函
やってほしいことを<b>ずばり誓騎里鹿眈指定しなきゃダ瀬瓩誓。
あなたのかわりに見当をつけてくれたりはしない。以下の例をみてごらん……
<h2>208.1.1.1の側では:</h2>
まず、security associations (SA)を誓瀋蠅靴茲瑳岱ぢこれで SPI, 暗号化の方法と鍵が誓瀋蠅気譴
箚顕
甦顕
次に、208.1.1.1 から 208.2.2.2へのフローを誓瀋蝓
箚原
甦原
次に  208.2.2.2の背後にある208.1.2.0/24 から 192.168.99.0/24へのフローを誓瀋蝓
箚弘
甦弘
次に 208.2.2.2の背後にある 208.1.5.0/24 から 192.168.99.0/24へのフローを誓瀋蝓
箚拘
甦拘
こんどは 208.2.2.2の背後にある 208.1.2.0/24 からルータ 208.1.1.1へのフローを誓瀋蝓
箚晃
甦晃
オッケー、では 208.2.2.2の背後の 208.1.5.0/24 からルータ 208.1.1.1へのフローを誓瀋
箋芦
甬芦
最後に、ルータ 208.2.2.2 から 192.168.99.0/24へのフローを誓瀋蠅靴茲
箋扱
甬宛
取仮屋軒荻荻ぢ側では:</h2>
前と同じように、まずは SAの誓瀋蠅蕁帖
箋嘘
甬唄
さてこっちは裏返しになるので……
ルータ 208.2.2.2 から 208.1.1.1へのフローを誓瀋蝓
箋姥
甬姥
屋軒窺窺ぢの背後にあるネットワーク 192.168.99.0/24 から 208.1.2.0/24へのフローを誓瀋蝓
箋臆
甬臆
屋軒窺窺ぢの背後にあるネットワーク 192.168.99.0/24 から 208.1.5.0/24へのフローを誓瀋蝓
箋俺
甬俺
では208.1.1.1の背後の 192.169.99.0/24 からルータ 208.2.2.2へのフローを誓瀋蝓
箋外
甬害
はーい、もうすぐおしまいですよー……
208.1.2.0/24 と 208.1.5.0/24 をルータ 208.2.2.2から 208.1.1.1まで届けるのに、
あとフロー2つだ世院
箋蓋
甬街
蜷黼竅粱ぢを使っていて、自分のやった作業をぜんぶご破算にして
一からやりなおしたければ、次のようにする：
d543 7
a549 5
これですべての IPsec 情報 (SPI、フロー、ルーティングのエントリ）がシステムから一掃される。
<P>
<a name="13.7">
<h1>13.7 - photurisdの誓瀋蠅呂匹Δ笋襪深云
鹿畩
箋輝
甬騎
俶阡蜩ぢはまだ世△泙蟷箸錣譴討い覆い掘
卞ぢのステータスから言世┐个泙誓実験段階だ澄任緕帯ぢではたくさんの人が
利用してきた。
d555 2
a556 2
photurisd を誓瀋蠅垢襪砲蓮△泙續祚韆阡蜩繝鱚闔を photurisdを持ったホストのすべてで編集すること。
d566 2
a567 2
identity local &quot;Default&quot; &quot;ここを変える&quot;
identity remote &quot;Default&quot; &quot;ここを変える&quot;
d569 6
a574 6
&quot;ここを変える&quot; の部分を、local config 側で好きな鍵にして、
それからremote configでは別の好きな鍵にしよう。
(リモートボックスでも config を使うこと。ただ世髟阡詞閭瘡鱚迴ぢを入れ替えて、リモートホスト側にとってはそっちがローカル鍵になるようにする。)
なお、これらの鍵は将来の photurisd のバージョンでは、
最初の鍵交換を公開鍵で行うような形で置き換わることになるので注意。
d576 1
a576 1
<tt>net.inet.ah.enable</tt> が 1に誓瀋蠅気譴討い襪海箸魍稜Г靴茲Α
箋険
甬険
それから startkeyを実行。
d585 2
a586 2
それでは tcpdump を実行して、パケットが AHで暗号化されていることを確認してみよう
（別のウィンドウでpingするとか、なんかセッションを開始してトラフィックをつくること）。
d590 1
a590 1
なにも出てこないようなら、tcpdump をホストアドレス側で使ってみる手がある。
d594 2
a595 2
photurisd が自動的に発信元と送り誓茲離曠好箸筌優奪肇錙璽鮴設定するように
するには、 /etc/photuris/photuris.startupに記述しておく。
d597 35
a631 31
<P> <a name="13.8"> <h1>13.8 - isakmpdの誓瀋蠅深云
鹿畩斜蕉侘をはじめIPsecの各種伝統的なアプリケーションを考えているなら、
たぶん ISAKMP を使うことになる。IPsec の商業実装の
一部は、手動鍵誓瀋蠅鬚気擦討譴覆い里如
なんらかの形の ISAKMPを使うしかなくなる。
<P>

<h3>13.8.1 - isakmpdってなに?</h3> ISAKMP (ときどき IKE, 
Internet Key Exchange、インターネット鍵交換、自動鍵交換とも呼ばれる) は VPN 用の鍵交換メカニズムだ澄
卞牡扱卞牡宛、RFC 2409に記述された手法を使ってセキュリティ上の問題をクリアしている。
ISAKMP は、通常なら <A
HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&apropos=0&sektion=8">ipsecadm(8)</a>
を使わなくてはならないような暗号家具のやりとりを管理してくれる。
二つのIPsecノード間でIPsecパラメータを確立するために、
二段階プロセスを採用している。

<P> <b>フェーズ 1</b> - ISAKMP ピア２つは、保護され認証されたチャネルを確立し、
２つのデーモン間で通信ができるようにする。これは
両ホスト間で Security Association (SA) を確立する。このチャネルを確立するための手法は、<b>Main
Mode</b> と <b>Aggressive Mode</b> だ澄
浴蜴閼は各種認証情報を
特定の順番で送り、アイデンティティの保護を提供する。Aggressive Mode は
アイデンティティ保護は提供しない。認証情報を
すべて一気に送るからだ澄燥苒纉皷閼を使うのは、
ネットワークの帯域幅が狭いときだ世韻砲靴燭曚Δいぁ
斜
錫ぢフェーズ 2</b> - Security Associations がIPsecにかわってネゴされる。
フェーズ 2 はIPsecホスト間にトンネルか endpoint SA を確立する。
フェーズ 2 では<b>Quick Mode</b> が使われる。フェーズ 1 ですでに SA が確立しているので、
完全な認証をくり返さなくていいからだ澄
箒概甼換手短にいえば、フェーズ 1 は保護されたチャネルを確保するのに使われて、そこで
（もっと手早い）フェーズ 2 の誓瀋蠅圓錣譴襦Ｆ韻献侫А璽ぢチャネルの中で、複数のフェーズ 2 誓瀋蠅
することもある。フェーズ 2 は実際のトンネルを誓瀋蠅垢襪里忙箸錣譴襦
フェーズ 1 では IPsec ノード同士が誓楝海魍領靴
認証を交換する (X509 証明世
事前に共有した秘密）。これで両端とも、相手が認証されたことを
確認できる。フェーズ 2 は鍵の交換で、両者の間のデータが
どう暗号化されるかを決める。

<h3>13.8.2 - isakmpdことはじめ</h3>

<P>
デフォルトで OpenBSD は ISAKMP と
IPsec スタック用のバイナリがついてくる。残念ながら、
サンプルファイルはデフォルトではない。これを手に入れるには、ソースツリーから以下のものを取ってこよう:
d652 26
a677 26
CD-ROM（当然持ってるよね）からでもいいし、<A
HREF="http://www.openbsd.org/cgi-bin/cvsweb/">cvsweb</a> や
<A HREF="http://www.usa.openbsd.org/anoncvs.html">コマンドライン CVS
クライアント</a>. を使ってもいい (Cvsweb は <A
HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/samples/VPN-east.conf">VPN-east.conf</a>
と <A
HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/samples/policy">policy</a>
を用意してある)。この例で使うには、<i>policy</i>
を /etc/isakmpd/isakmpd.policy にコピーしよう。<i>VPN-east.conf</i> は /etc/isakmpd/isakmpd.confにコピーする。
ここでは、VPN (トンネル) の誓瀋蠅了妬鮴説明世靴討澆襦發
蜩瘠逅を個別ホスト間で使いたければ、<i>samples</i> ディレクトリにそれ用のサンプルが
入っている。
manページに詳しい情報があるので、
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&sektion=5">isakmpd.conf(5)</a> と
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a> をお忘れなく。

<P>
まずは esp の起動からだ澄質凖峠■嘘堊卩都就烽赱鉉⊂嘘の頭の
ところ</a> で、これを実行時・起動時にそれぞれやる方法を誓睫誓している。
次に /etc/isakmpd.policy の編集だ澄
このファイルは ISAKMP に、だ世譴偕繝ぢにアクセスできるかを教える。このシナリオでは、この policy ファイルは、
Encapsulate Security Payload(ESP)を使ってデータを送ってきて、mekmitasdigoat というパスワード（これはあなたが
勝手に決めればいい）で認証された相手なら、だ世譴任黶謐鞣ぢと通信できると述べている。このファイルをを変更して、
特定のデジタル証明製颪能靆召気譴織如璽燭誓けを認めるとか、特定の暗号変換を使ったデータだ世韻鯒Г瓩襪箸
希望をISAKMPに伝えられる。まただ世譴任偕繝ぢが使えるようにしてもいい。これはテスト用だ世韻砲靴討里召泙靴ぁ
万人にアクセスさせるには、policy ファイルを編集して以下だ世韻砲靴茲箒鹸
甼元
同じ policy ファイルには $ のついた行が二行ある。
使う前にこの２行は削除すること。CVS でしか使わない。
d687 1
a687 1
この例で、もっと使い物になる policy ファイルはこんな感じだ箒弘
甼弘
衷迯緕ぢこの policy は誓気靴ぅ僖好錙璽匹鮖箸Ε螢癲璽箸蕕嗤を受け付ける
d696 3
a698 3
これを実装すれば、ESP だ世韻鮖箸辰心靄榲侘トンネル) ができあがる。
ホスト A では /etc/isakmpd/isakmpd.conf を編集する。見本で入っている249.2.2.2 という IP アドレスは、
ホスト A の実際の外部 IP アドレスに書き換えること。
d707 2
a708 2
同じようなことをホスト B の isakmpd.conf でもやろう。249.3.3.3 は
ホスト B の外部 IP アドレスだ澄
箏鰻
畄臆
腫ぢここで isakmpd のおもなふるまいを決める変数を誓瀋蠅任襦海海任
デフォルトを使っておけばいい。
<b>Listen-on</b>= value は、isakmpd が聞き耳をたてるべき IP 
を指定する。あなたのゲートウェイのインターネット IP だ世韻廚誓。
ゲートウェイに複数の外部インターフェースがあるなら、
コンマで区誓擇辰唇賤措阿覇呂靴董△匹離ぅ鵐拭璽侫А璽垢鯆阿い討曚靴い賤砲任襦
箏牡
畄牡
次にホスト A で、もう一度isakmpd.conf を編集しよう。
d731 1
a731 1
ホスト Bでは:
d738 4
a741 4
<p>この部分は、フェーズ 1 誓楝海離優乾轡─璽轡腑鵑鬚垢襪箸房栄佞韻襪戮アドレスを記述する。
ここでの値は下の部分を指している（フェーズ 1 は単にリモートのピアを認証して、
それが主張通りの相手だ世罰稜Г垢襪誓けなのをお忘れなく）。
IP_Address=<i> &lt;PEER-NAME&gt;</i>という形式で複数のピアを記述できる。
d743 1
a743 1
次にホスト Aでは:
d749 1
a749 1
ホスト Bでは:
d756 2
a757 2
<p>これは誓楝海離侫А璽ぢを記述したもの。このフェーズは、通信に両
ピアが使うプロトコルを決めるところだ澄
箏宜
畄況
腫菖蒹眈衷銕繝闔鷦晶瘍ぢは、その下のセクションをさす。
フェーズ 2 を誓瀋蠅垢襪燭瓩房影譴蕕譴襯瓮愁奪匹簍弖錣鬟ぅ縫轡─璽箸垢襦海譴呂泙拭
いったん開始したらどの誓楝海鬟ぅ縫轡─璽箸垢戮瓶阻熔に告げる。
複数のピアホストにつなぐつもりなら、
以下のように複数のセクションを書いてもいいことに注意。

<p>リモートホストの IP アドレスがわからなければ、 <b>Connections</b>= tag に
挙がっていない IP からの誓楝海濃仮箸気譴襦突僖┘鵐肇蠅鬚△襯札轡腑鵑傍劼靴討い董
それを Default= で指定するようにすればいい。
d769 1
a769 1
ホスト Aでは:
d781 1
a781 1
ホスト Bでは:
d794 3
a796 3
これらは上で誓睫誓したフェーズ 1 の部分で参照されているセクションだ澄修譴召
フェーズ 2 に進むためにピアのゲートウェイが満足しなければならない要件を記述している。ほかにもオプションは
たくさんあるけれど、上に挙げたものは最低限必要なものだ澄
箏晃畍臆殊蘊錫笑葹黼襲ぢが必要なのは、 ISAKMPD コードがフェーズ 1 とフェーズ 2 を処理するのに同じプロシージャを使うからだ澄
これを <b>1</b> にしないと、何一つ機能しなくなる。
<li><b>Transport= </b> は、ピアごとにちがう可能誓△襦海海任
を使うことにしてあるので、そういうことにしておこう。
一部のピアはファイアーウォールの背後にあって、UDP トラフィックを通さない場合があることに注意。これは当然ながら、誓瀋蠢阿乏稜Г靴討廚△襦
殊蘊錫礁閭瘡粐鱚齠ぢは入ってくるパケットが指す目的アドレスだ澄０貮瑤離院璽垢任蓮
フェーズ 1 の誓楝海里燭瓩膨阿ぅ鵐拭璽侫А璽垢舛辰討い襪發靴譴覆ぁ
この例では、インターフェースは一つしかないので、このピアで聞き耳をたてる
インターフェースの IP がそれになる。
<li><b>Address= </b>は、入ってくるパケットのソースIP。これはピアゲートウェイを
指すのがふつう。
ここはもっと誓睫誓が必要。ピアの発信する IP アドレスは事前にわからないことがあるから。
<li><b>Configuration= </b>は、下のセクションを指す。ここでやったような形で
複数のセクションを指定できる。ここではサンプルファイルにあった
デフォルト値を使おう。
<li><b>Authentication=</b> は、このピアが使うはずの、
事前に共有してある秘密。このパスワードが policy に渡されて、
このピアがこのホストと IPsec を使っていいことになっているかを確認する。ここのパスワードを変えたら、
policy ファイルでの記述も変える必要がある。sample ファイルがこのパスワードに応じて提供されるからだ澄
最低限の policy ファイルで行くつもりなら、ここでは好きなものを指定すればいい。
<li><b>Flags=</b> はいまは使われていない。RFC では、フェーズ 1 用の追加オプションを指定するための予備として
これを残している。
<p>ほかのオプションを指定するためのタグもたくさんある。詳しくは
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&apropos=0&sektion=5&format=html">isakmpd.conf(5)</a>
を参照。
d825 1
a825 1
ホスト Aでは:
d835 1
a835 1
ホスト Bでは:
d845 3
a847 3
<p>これらは、上記のフェーズ2で参照されているセクションをあらわしている。これは
個別の誓楝海里燭瓩法鵑弔離押璽肇ΕДご屬馬辰鬚垢襪里啻僕伉ぢが使うべき
個別誓瀋蠅覆里誓。
d849 15
a863 15
<li><b>Phase=2</b> は必須。ISAKMPD コードは、フェーズ 1 と
フェーズ 2 の認証に同じ関数を使うから。これがないと VPN は機能しない。
<li><b>ISAKMPD-Peer=</b> は、上でのホストのセクションの名前だ澄弔泙螢侫А璽ぢ誓楝海魍領垢襪燭瓩法
ここで指定したピアと話をしているんですよ、という意味だ澄海譴△襪里蓮黶謐ピアや誓楝海魑劼垢襪里
複数のセクションがある場合もあるからだ澄
殊蘊錫消闔肅苺鱇闔充は、下のセクションで、このホストと誓楝海砲韻觧慊蠅離團△箸
したがうべき規格を記述した部分をさす。
<li><b>Local-ID=</b> は、ピアのゲートウェイへのこのプライベートネットワークを
記述した、以下の IPsec-ID セクションを指す。この部分が送られて、向こう側のゲートウェイがVPN経由で
こちらのネットワークにデータを転送するためのルーティングテーブルをきちんと誓瀋蠅任襪茲Δ砲垢襦
殊蘊錫紹纃阡絖苗充これは、こちらのホストから見て、リモートのプライベートネットワークで
あるはずのものを記述した、下のIPsec-ID セクションを記述しているこの部分が解釈されて、こちらのプライベートネットワークから
VPN経由でリモートのプライベートネットワークにデータを転送するためのルーティングテーブルをきちんと誓瀋蠅垢襦
腫ぢここでサポートされているタグがもう一つあって、それが Flags= だ澄海離織阿廚覆
質凖峠∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜩瘠逅筮竢鈕頏關闢衆繼闔週闥轣蔗迪⊂蜩瘠逅筮竢鈕┻ぢを読んでほしい。
d866 4
a869 4
ここはIPsec-ID セクションだ澄０焚爾離┘鵐肇蠅蓮▲曠好ぢとホストBの
両方で isakmpd.conf ファイルの中になければいけない。この例だ世
ホストA（これは上の Net-Aに
つながっている）では 192.168.1.0/255.255.255.0 、ホストB（これは上の Net-Bにつながっている）では192.168.20.0/255.255.255.0 だ澄
筝顕
畍元
腫ぢこの二つのセクションが各ホストの <b>conf</b> ファイルに含まれている。これが
<b>Local-ID</b> と <b>Remote-ID</b>の識別しで参照されるセクションだ澄０譴弔
プライベートネットワークから、別のプライベートネットワークへのトラフィックを可能にするのに誓瀋蠅気譴襪戮佻筏劼靴討い襦
錫症牒鞳鹿眈は <b>IPV4_ADDR_SUBNET</b> か <b>IPV4_ADDR</b>がとれる (RFC2708 にはほかにも有効な値があがっている。OpenBSDの実装ではいまのところIPv4 しかサポートされていない。IPv6 は、OpenBSD-current でサポートされているかもしれない)。
d888 1
a888 1
　これで両方のホストで、sample ファイルはこんな具合になっているはずだ筝攻畊圧このセクションはフェーズ 1 誓楝海濃箸Π店翳阿陵弖錣魑劼靴討い襦Ｌ樵阿
守消闔肅苺鱇闔充変数のとる値を反映している。ごらんのとおり、
Domain of Interest (DOI) を IPSEC として記述した。<b>EXCHANGE_TYPE</b> 変数は、フェーズ 1 では <b>ID_PROT</b> に誓瀋蠅靴討△襦
これはこの認証でカバーされるプロトコルを指定している。
<b>Transforms=</b> はこのやりとりで必要とされる（または指定される）暗号変換方式だ澄海領磴任蓮
これは誓瀋螢侫．ぅ襪硫爾離札轡腑鵑鬚気靴討い董△修海任蓮△錣譴錣譴劃途で暗号化されていて
SHAで確認できるチェックサムを持つパケットを受け取る、と書いてある。
サンプルの<b>VPN-east.conf</b>には、いろいろ変換方式が山ほどかいてある。なぜかというと 3DES や SHA は各種プラットホームで必ずしもサポートされいる
わけではないからだ澄緕帯の場合、これを基本的な誓瀋蠅琶僂┐襪戮海脇辰砲覆ぁ海離札轡腑鵑鬟灰圈爾靴栃儡絞阿鯤僂┐襪里蓮
ぞんぶんにやってほしい。唯一、必要になるのは、 Configuration= 変数も変えることだ澄
箙唄畊桶腫ぢこのセクションは、VPN経由で送られるデータの暗号の要件を記述するところで、
上の <i>Configuration</i> で参照される。このセクションと、
すぐ上のフェーズ 1 でここに相当するところとのちがいは、 <b>EXCHANGE_TYPE</b> が <b>QUICK_MODE</b>になっていることなのに注目。
フェーズ 2 では必ずこうなる。
<b>Suites=</b> は IPsec Suite セクションを指している。
両ホスト間で提供されている各種の暗号方式を記述したものだ澄
瓶阻熔ぢと IPsec については、ほかにも誓睫誓することがいっぱいある。いまの基本的な誓睫誓をもとに、
自立してやっていける単純ながらも堅牢なVPNができる。
でもこれは、両ホストにとって<i>必要最低最小限の</i> 
<b>isakmpd.conf</b> でしかない。
d925 2
a926 2
<h3>13.8.3 - isakmpdの起動</h3>
最初にこのデーモンを走らせるときには、以下のコマンドを使おう：
d932 42
a973 39
デーモンはデーモンモードでは走らず、ふつうのプロセスとして
走る。そしてすべてをターミナルに出力する。isakmpdを止めて
経路を一掃するには、各ノードでisakmpd プロセスを殺してから
<b>ipsecadm flush</b>を実行しよう。

<P> <a name="13.9"> <h1>13.9 - isakmpd を X.509 証明製颪箸い辰靴腓忙箸Δ砲深云
鹿畩
斜事前に共有した鍵のかわりに証明製颪鮖箸Δ茲Δ黶謐鞣ぢを誓瀋蠅垢襪里蓮∧欷遒気譴討い覆ぅ團△燭気鵑△覽霏腑優奪肇錙璽両豺腓砲蓮
小さなネットワークにくらべてそんなにむずかしくない。むしろ誓瀋蠅蔽韻砲覆辰董△気蕕暴斗廚覆海箸箸靴
鍵管理も簡単になるかもしれない。
<P>

<h2>証明製颪寮生誓鹿莢
鍵や証明製颪寮生誓了妬砲弔い討里茲さ劼蜩瘠逅ソースディレクトリの
<A HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/README.PKI?rev=1.7">README.PKI</a>
ファイルに書いてある。必要なのは
CA 鍵、対応する CA X.509
証明製顱▲優奪肇錙璽紊黶謐鞣ぢを使うコンピュータそれぞれに秘密鍵一つと、その秘密鍵のそれぞれに対して X.509
証明製餔譴弔困弔誓。
<p>
X.509 証明製颪蓮⊂斂誓書の持ち主を記述する Subject Alternative Name
(SubjectAltName) extension が必要だ澄斂誓書の SubjectAltName extension を
certpatch を使って誓瀋蠅垢詈，癲
囎礪繝踉令辣としてIPアドレスを誓瀋蠅垢訃豺腓寮説明世伝塚溺佶に書いてある。
ここで IP アドレスを使うのは、isakmpd の
デフォルトのふるまいでもある。
<p>
Certpatch はまた、 FQDN (Fully Qualified Domain
Name) か UFQDN (User FQDN) の使用もサポートしている。FQDN の例はたとえば
<tt>www.openbsd.org</tt> だ世掘嫺冂の例としては
メールアドレスがある。たとえば <tt>Jorgen.Granstam@@abc.se</tt> など。
<p>
この howto 文書では、 FQDN を
SubjectAltNames で使う。IP アドレスを使うほうがちょっと簡単になる。
それが isakmpd のデフォルトのふるまいだ世蕕誓。
でも、すぐにわかるように大した差ではない。
d975 2
a976 2
FQDN SubjectAltName を証明製颪貌譴襪砲蓮
こんな感じにすればいい：
d981 10
a990 10
ここで ca.key は CA の秘密鍵なので、これが
できるのは CA 秘密鍵にアクセスできる人だ世韻誓。
home.mysite.se というのは（実在はしないけれど）証明製颪冒淨気譴襪戮冂だ澄
闥蜃蜴瘡竇鶯鶯ぢと newcert.crt のファイル名は同じ名前にしてもいい。
この場合、もとのファイルは新しい変更済みの証明製颪
上書きされる。
<p>
この鍵と証明製颪髻凖祖妖防ぢの最後に誓睫誓にしたがってディレクトリに
放り込もう。もし本気で鍵を使うつもりなら、CA 鍵 (ca.key) は
どこか安全なところにしまっておこう。
d993 1
a993 1
<h2>isakmpdの誓瀋鹿莢箙控甕旭欝
こんどは /etc/isakmpd/isakmpd.conf 誓瀋螢侫．ぅ襪鮓討笋蹐Α
これはもともと
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&sektion=5">isakmpd.conf(5)</a>
のサンプルファイルから取ったものだ世韻譴鼻△覆蟒颪垢┐討△襦
さらにman ページにあるものよりもかなり短いファイルを使う。
この誓瀋蠅陵鬚魎蔽韻砲垢襪燭瓩法▲侫．ぅ襪蕁
この誓瀋蠅砲鷲廚覆い發里鬚曚箸鵑漂鐔靴拭気蕕縫灰瓮鵐箸眥媛辰靴
（一部のコメントは isakmpd.conf(5)にあったまま) 、名前もちょっと変えた。
ここで使ったドメイン名は、ぼくの知る限りでは一つも実在していない。
<p>
実はこれを読む人はみんな、すでに事前共有鍵についてまともに動く
誓瀋蠅鮖辰討い襪里如柄阿寮節を参照）このファイルでも
目新しいところはあまりない。だ世蕕海譴蓮∩管戮棒説明世靴燭蠅呂靴覆ぁ
ぼくが誓睫誓しない部分については isakmpd.conf(5) を
見てほしい。
d1011 1
a1011 1
全体の構誓呂海鵑粉兇犬誓としようか。
d1026 5
a1030 5
要するに、二つのネットワークが、保護されていないネットワーク上を、IPsecトンネル経由で
誓楝海気譴襦△箸いΔ海函海海妊廛薀ぅ戞璽肇ぅ鵐拭璽優奪藩僂僕縮鵑気譴賓
アドレス (RFC1918) を使っていることは無視してほしい。
なにかしら例は必要だ世辰燭發鵑如蜩瘠逅を NAT
と組み合わせて使うとかその手のをどうするかは誓睫誓しない(ぼく自身やったことがないから）。
d1032 2
a1033 2
では誓瀋螢侫．ぅ襪鮓討笋蹐Α０焚爾蓮
セキュリティゲートウェイ gw.mysite.se用のファイルだ箟鯵甕鯵逋皷蜩瘠逅筮竢鈕のはじまり       ************
d1110 2
a1111 2
# ここで記述されたネットワーク上のコンピュータから発せられた
# パケットで... 
d1117 3
a1119 3
# ... 以下の記述とマッチする目的地を
# 持ったものは、暗号化されて
# IPsecトンネル経由でリモートシステムに転送される。
d1125 1
a1125 1
# Main mode の記述
d1224 4
a1227 4
ここまではローカルシステム用の誓瀋蝓螢癲璽肇轡好謄爐
誓瀋蠅發泙辰燭韻犬誓けれど、裏返しになる。だ世蕕舛Δ里
蜩瘠逅筮竢鈕ぢファイルの頭のところだ世韻誓。
セキュリティゲートウェイgw.worksite.seの isakmpd.conf ファイルの頭のところだ世姥討笋蹐箟桶甕桶鳬皷蜩瘠逅筮竢鈕ぢのはじまり    **********
d1267 1
a1267 1
# **********************     ... つづく...      **********************
d1272 2
a1273 2
あまりむずかしくはなかったね。ただ斉匹爐里呂舛腓辰搬犇誓ったかもしれないけれど。次の部分は、
もうちょっとおもしろくなる。
d1277 1
a1277 1
<h2>policy ファイル</h2>
d1279 5
a1283 5
実をいえば、policy ファイルは初めての人にはちょっとややこしいかもしれない。
特に思い通りに動かないときには。man-ページ
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a>
は、実はそんなに悪くない。ところどころ
はっきりしないところがあるけれど、全体としてはいい。
d1285 2
a1286 2
一番簡単な、ちゃんと機能する policy ファイルは
たった一行だ箟温唄
甕外唄
これは要するに、だ世譴接続していいかについて、ポリシー上の誓鵑呂覆砲發覆ぁ
ということだ澄誓からあまりセキュリティの高い誓瀋蠅任呂覆ぁ海海
癜闥蝴纈ぢタグは、policy を決める権限を持った人物、
ということだ澄Ｆ段蓖鱸である&quot;POLICY&quot; は、
policy について最終的かつ無限の権限を持つ。それ以外の authorizer は、
ここで権限を持つためにはまず &quot;POLICY&quot; に認定してもらわなければならない。
<p>
さらに何が許されるかについて、条件群があるかもしれない。
以下の policy はだ世蕁∨槓琉店罎魏燭箸辰嗤
プロトコルを使用した人だ世韻蠅気譴襪箸いΔ海箸誓（本物といってもまあ、
これだ世途ぢを使っている人も認められて、DES は
いまやほとんどインチキと思ってもいいくらいだ世韻譴鼻△任途ぢを認めないように
この policy を変更するのは、読者の練習問題として残しておこうか）。
これだ世途で暗号化する人ならだ世譴任眷Г瓩蕕譴襪海箸肪躇奸
箟咳甕害さらに権限をだ世譴召梁減漾癖瑤任
いい）に「サブライセンス」することもできる。簡単なケースとしては、事前共有鍵の
場合だ澄海両豺隋∋阿剖ν気譴織僖好錙璽匹鮹里辰討い訖佑呂垢戮
認められる。だ世蕁
箟崖甕慨これはこのパスワードを知って条件にマッチした人すべてに
誓楝海鯒Г瓩襦覆燭誓しこのパスワードは isalmpd.conf の Authentication タグでも
誓瀋蠅靴討里鬚困譴覆法
腫ここまでは何もむずかしくない。こっからがおもしろいところ。まず、
ライセンスを受ける存在はたくさんあってもいいけれど、そのすべてが &quot;POLICY&quot;に認定されなくてはならない。
さらに認定されたライセンス保持者は、他のライセンス保持者にサブライセンスを出せる。
ライセンス保持者は、policyファイルでさらに記述されていたら
単なるストリングでもいい:
d1360 5
a1364 5
さあみなさんお待ちかねの部分。Policy はまた、
鍵にサブライセンスしたり権限委譲したりできる。この場合の鍵は、ふつうは
X.509 証明製颪誓。証明製颪魎蔽韻忙箸Δ砲蓮
それをパスワードがわりに使うことだ澄
竟跚笙ぢファイルに個別ユーザの証明製颪魏辰┐襪誓けでいい:
d1374 1
a1374 1
        CzA           この部分はユーザ証明製颪任瓦兇い泙垢囘腿
箟蓋甕街さて、ユーザの数が多ければ、このやり方がばかげているのはすぐわかる。
isakmpd が CA- ディレクトリと Certificate
ディレクトリから読んでくる証明製颪函▲團△藾蕕譴討訃斂誓書は、
疑似資格証明澄竰繖緕瘡ぢ）に変換される。こうした疑似資格証明世吠儡垢気譴疹斂誓書は、
こんな感じになっている:
d1399 2
a1400 2
    	CzA  この部分はユーザ証明製顱覆弔泙蛋証明製顱砲暴靆召靴囘腿
耐　人の公開鍵／証明製颪任垢付箟官甕官丁ぢここんとこは証明製颪鮗韻訛Δ慮阿法囘腿
耐ぢなります                       IUuz¥
d1422 7
a1428 7
さて、これらが &quot;POLICY&quot; に認められたものではないので、
それをなんらかの形で認知する policy がなければダ瀬瓩誓ということに注意。さらに、これは
内部で証明製颪匹Δ覆辰討い襪鮴説明世靴討い襦紊了餝幣斂誓（credential）は、
policy ファイルの中では見られない。でも、そういう資格証明世
サブライセンスは出せる。上のサブライセンス発行を思いだ世靴討曚靴ぁ△譴鮖箸┐弌
蛋証明製颪鬟薀ぅ札鵐垢箸靴髟阡姉鰐秒戲髟阡ぢに書いてやれば、
ある CA が署名した証明製颪垢戮討縫薀ぅ札鵐垢个擦襦
箟干甕干丁この部分が CA 証明製颪任瓦兇い泙垢叢殿箟患抗
甕鬼抗
つまり上の policy は、CA に権限委譲する policy の簡単な例だ澄
この証明製颪鮖辰が署名した証明製颪鮖辰討い
竟跚笙ぢと誓瀋螢侫．ぅ襪寮設定したほかの条件にも
したがっているユーザはすべて認められる。
<p>

<h2>ほとんど安全……は安全に非ず!</h2>

さて、本当に安全を期するなら、これでは残念ながら十分ではないのだ澄
こういう誓瀋蠅離札絅螢謄押璽肇ΕДい鮃況發垢詈，△襦
もし細々した話がいらないなら、いますぐ次の誓瓩泙波瑤个修Α
それ以外の人たちは、なぜこれが安全でないかを理解してみようではないの。
むずかしくはないよ。
<p>
この段階で、isakmpds がどんな情報にアクセスできるか考えてほしい。
誓瀋螢侫．ぅ襪蕁蜩瘠逅はピアがどの IP-アドレスから
送信してくるかわかる（[フェーズ 1] セクションで)。フェーズ 1 の
ネゴシエーションをするときに得世蕕譴訃霾鵑蕁▲團△匹鵑を
出してくるかわかって、ピアからの証明製颪鬚發蕕辰燭蕕修譴妊團△榲
そのIDを持っていることが証明世気譴襦Ｌ簑蠅覆気修Δ誓ね?
<p>
うん、もしID 情報が IP なら（フェーズ 1 の ID セクションを使わなければ
これがデフォルトに状況になる）すべてはオッケーだ澄蛋
はその IP を cert に結びつけて、誓瀋蠅涼罎だ世韻派彎霾鵑呂垢戮討修蹐Α覆蠅垢泙携箸△曚離灰鵐團紂璽燭
同じ IP を使うことも不可能ではない
（たとえば両方のコンピュータが同じ LAN 上にあって、
ふだ世鵑修を使っているマシンがなんらかの理由でダ瀬Ε鵑靴討い襪覆鼻法
でも、なりすまし犯が、証明製颪箸修譴紡弍垢詒詭阿鮖辰董
その IP がなりすまし犯のものだ世函壁埓正に）証明世垢襪海箸
不可能なはずだ澄
腫もしそれが万が一起こったら、そのなりすまし犯はそのIPの所有者から秘密鍵を
どうにかして盗んだ世△△襪いをなんらかの方法でだ世泙靴董
にせの情報を含んだ西斂誓書を発行させたかのどちらかだ澄
もしこのいずれかが起こったなら、
秘密鍵の保護が不十分だ世辰燭蛋ぢが
なりすまし犯の身元（あるいは cert の
ID 情報）を十分にチェックできなかったか、あるいは CA 秘密鍵が十分に保護されていなかったかだ澄
これらはすべて、そもそもセキュリティがまともに機能する前提なので、
こういう状況は誓簑个傍海辰討呂い韻覆ぁ

腫さてぼくたちの例では状況がちがう。ここでは
証明製颪涼罎法賓アドレスではなく FQDN が入っている。
[Phase 1] セクションにまだアドレスがあるので、
これはセキュリティ問題となる可能誓△襦瓶阻熔
フェーズ 1 ネゴシエーションの間に何が起きるかというと、ピアが
期待どおりの IP から送られてきたことをチェックできる（でもさっき誓睫誓したように、
これは一部の状況ではごまかせる）。ピアが提示するIDを、
本当にそのピアが持っていることもチェックできる。
でも、いまチェックできないのは、そのID が本当にそのピアが持っていると期待すべき ID なのか、ということだ澄
蜩瘠逅は、どんな ID を期待すればいいか一度も教わっていないからだ澄
腫栂システムがホストのために IP を FQDN と
結びつけてくれる、という人もいるだ世蹐Α修譴呂修Δ覆鵑誓けれど、現在の DNS システムはセキュリティが高くないし、
だ世泙靴討砲擦両霾鵑鮟个気擦襪海箸癲⊂豺腓砲茲辰討
できる（あるいはサービス拒否（DoS）攻撃を
攻撃者に受けて、その攻撃者のマシンがDNSサーバの答を
偽造することもできる）。いずれ高セキュリティ DNS も登場するけれど、
まだ製于鵑辰討い覆い掘幣覆箸發曚箸鵑匹林ぢサーバはまだ盛皀札絅螢謄任呂覆ぁ法
だ世藐什漾竇鶯ぢの FQDN が期待される IP と対応しているかを調べるのに
DNS を使っても保証にはならない。実は isakmpd はこれを DNS にきいたりしない。
DNS が安全でも、UFQDNを使っている場合には
これをチェックできない。
<p>
つまり ID として FQDN を使う場合、アタッカーは
自分の秘密鍵を用意して、それをわれわれの使うのと
同じ CA に署名させる（でももちろんアタッカー自身の FQDN を使って)。それから
ピアに DoS 攻撃をしかけてダ瀬Ε鵑気擦実は
ISAKMP プロトコル自体に欠陥があって、ピアに対して
リモートDoS を仕掛けてダ瀬Ε鵑気擦討靴泙┐覯椎柔性があるけれど、
isakmpd がこういう攻撃に対してどのくらい敏感かは知らない)。それから
アタッカーは自分のコンピュータをわれわれのピアと同じように誓瀋蠅靴董
ピアのネットワークにつないで
自分のIDと秘密鍵と証明製颪鮖箸┐襦
腫ぼくたち側の isakmpd は、こっちのピアへの ID が何かを教わっていない（そしてそれは、アタッカーが
証明製颪苗と秘密鍵以外はまったく同じ誓瀋蠅砲靴討い燭蕁法気蕕砲椶燭舛
蜩瘠逅は証明製颪韻のサインしたものだ世肇船Д奪任襦覆任
多くの CA はcert をいっぱいサインするから、cert を手に入れるのはむずかしくないかも）。そして
そこで示された ID が証明製颪涼罎といっしょなのも確認できる。でも、
これまで提示された誓瀋蠅任蓮△修が期
待していた ID かどうかはチェックできない。だ世薀▲織奪爾論接続を認められてしまう。
<p>

<h3>攻撃をふせぐ</h3>

すると問題は、どうやったら isakmpd に期待すべき ID のことを教えてあげられるか、
ということだ澄△蠅燭い海箸砲海譴牢蔽韻如
質凖峠∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜩瘠逅筮竟跚笙繼闔週⊂蜩瘠逅筮竟跚笙┻ぢにも誓睫誓されている。
policy内でチェックをかけなきゃいけないのだ澄
たとえばこんなふうに:
d1554 1
a1554 1
        CzA             この部分が CA 証明製颪任瓦兇い泙垢叢殿箟偽甕儀これで、IPsec誓楝海鯑誓られるのは gw.worksite.se だ世韻里呂此
かに remote_idのチェックを足せば、許可されるIDは簡単に増える。
つまり以下のようなのを policy に足せばいい:
d1583 2
a1584 2
この policy だ世函范闥謫蜚絎黼范闕纉蜚絎黼、
gw.whatsite.se のいずれも誓楝海任襦
箟妓鰻
甕彊鰻
竟跚笙ぢに証明製餞櫃瓦抜泙瓩覆討呂覆蕕覆い里六椎亜
という人もいるだ世蹐Α斂誓書を policy に
入るような形式になおすのは手間だ世掘
竟跚笙ぢも読みにくくなる。だ世譴泙舛辰董
ややこしい policy のなかで、CA 証明製颪箸泙舛┐
ユーザ証明製颪鯑譴討靴泙辰燭蕁造里覆ぅ罅璽兇
誓楝海Г瓩蕕譴討靴泙Δ發靴譴此△気蕕忘い辰燭海箸法
竟跚笙ぢファイルを見てもそれをつきとめるのはむずかしい (X.509 証明製颪
人間に読める形ではないから)。

<p>
さて、本当にカリカリの最誓菽爾凌佑燭舛砲蓮
この問題の解決方法がある。いまでは、policy 内で証明製颪修里發里里錣蠅法
証明製颪堤齡蜴苺蜩蒹令辣栂を使うことができる（対応する
証明製颪呂發舛蹐鵐妊好紊纈
か ca ディレクトリにあって、isakmpd が見つけられるようになっていること)。この
形式だ世函⊂紊闌蜒は以下のような感じになるだ世蹐箟恐甕恐ずっと読みやすい、でしょ？　ある証明製颪寮正確な DN
は、openssl ユーティリティを使って証明製颪鮓討笋襪箸錣襦
こんな具合:
d1629 22
a1650 22
もっと複雑な policy はもちろんできるけれど、
これはとりあえず入門だ世掘⊆，寮節で別の例を見て
やることになる。
<p>
これで ca.crt の中の証明製颪砲弔い読廚幣霾鵑
提供されるはずだ澄竟跚笙ぢが小さいか、そこそこくらいなら
これでもいいだ世蹐Α任盖霏腓淵汽ぅ箸農接続ユーザが山ほどいるなら、
これでもまだ世泙誓だ澄

屡仮マルチユーザ誓瀋蠅函羆浜診Ь鹿莢
それじゃ isakmpd のホントにクールな機能をいくつか見てやろう。これまでは、
誓楝海靴討襪呂困離團△呂茲里蕕譴討い董賓アドレスも誓電妨把蠅気譴討い襪發里箸靴拭
でも、そういう場合ばかりじゃない。動的に割り当てられたIPを使ったり、
コンピュータを何台も使ったりする人は多い。あるいは（サーバ
なんかだ世函棒接続したいのがだ世譴覆里△呂辰蠅錣蕕覆い海箸發△襦

腫そこでisakmpdのすてきな機能の一つは、
[Phase 1]セクションでIPではなくデフォルトのタグを使えるというもの。
これによって、isakmpdはどのIPからでもネゴシエーションを受け付けられるようになる。
これはこんな感じになる：
d1659 12
a1670 12
まず言世辰討戮覆里蓮△海寮設定はDoS攻撃に対して
安全ではないかもしれないということ。まえにも言世辰燭茲Δ法
瓶阻熔謀プロトコルには欠陥がある。いずれにしても、デフォルトの [phase 1] セクションを使えば、
一種の「認証証明製顱廚僂錣蠅忙箸┐襪茲Δ砲覆襦
腫たとえば権限を持つユーザはたくさんいるけれど、
でも誰でもいいからうけつける、というわけではない場合を考えてみよう。たとえば会社なんかの場合。
会社の従業員は誓楝海気擦燭い韻譴鼻△修谿奮阿凌佑砲論接続してほしくない。さて、
大企業で社員が何誓蘓佑發い襪箸靴茲Α譴蕕
どのコンピュータからでも（社内LAN上のものに限らず）誓楝海任襪茲Δ砲靴燭い韻譴鼻
全員がなんでもできるようにはしたくない。この場合、
次のようなpolicy が書けるはずだ澄
箟訓碓
甕訓碓
これは厳密に誓気靴い匹Δ呂錣蕕鵝椶里觚造蝓
こいつはまったくテストしていない（だ世蕕海離侫襯疹魴錣蓮△椶了廚つ未蠅砲
ぜんぜん動かないかもしれない）。それと、こいつみたいなpolicy （というか、
デフォルトがピアのIPにしてあるものすべて）は、isakmpd.confファイルもあわせて書き換えないと
ダ瀬瓩誓。これには、セキュリティ上の問題もついてまわる。さらに、
だ世譴任眄接続できるようになっているこの種の誓楝海任蓮
たぶん誓楝海靴真佑はすべてログしておいたほうが
望ましい。isakmpd はぼくの知る限りでは、これをまだ瀬汽檗璽箸靴討い覆ぁ気蕕
この可能誓砲呂戮弔離札絅螢謄紊量簑蠅弔い討襪發靴譴覆ぁ覆砲△辰討癲
だ世譴眄責任はとってくれないので、覚悟して進むように。でも基本的な考え方はもうはっきりしているはずだ澄
箟群唄
甕軍唄
いまのが持っている、実におもしろい可能誓忙廚づ燭蕕覆た佑い襪肇▲譴誓から、念のため誓睫誓しておこう、
もしこういう形でISAKMP/IKE を使っているコンピュータがすべて、
リモートからユーザが使いたいと思っているサービスのそれぞれについて、条件の束を持っていたとしよう。すると CA は、
ユーザの証明製颪砲靴襪戮裙笏糟瘢纔銖蜿を入れておくだ世韻任修離罅璽兇稜Ь擇任襦気蕕法△修Δい斂誓書の有効期限を
比較的短いものにしておいて、ユーザは
証明製颪鼎覆辰討燭蘊斂誓書を再発行してダ瀬Ε鵐蹇璽匹任襪茲Δ
しておく。もしユーザが権限を悪用するなら、
証明製颪鮑独圓靴覆い茲Δ砲垢譴弌⇒存紊脇辰討海蕕譴覆ぁ
社員が一人やめたくらいで、
すべてのコンピュータ上のpolicyファイルを変える必要もない。
同じ方式はISAKMP/IPsec 以外の目的にも使えるはずだ澄淵侫薀ぅ鵐轡好謄爐稜Ь擇気┐任襦法
ただ世靴修両豺腓砲脇段未淵愁侫箸廚砲覆襪韻譴鼻
とにかく。これをやる組織はおそらく自分で自分自身のCAになったほうがいい。
d1740 8
a1747 8
こういうマルチユーザ誓瀋蝓淵皀丱ぅ襯罅璽供砲蓮
事前共有鍵でもできうけれど、でもそれだ世函△匹賓から誓楝海靴討襪錣蕕覆い蕁
苗をもとに誓気靴ぅ僖好錙璽匹戮襪茲Δ砲覆辰討い詆廚△襦
だ世苗瀰厦ぢモードではなくAGGRESSIVE モードを
使わなくてはならない(AGGRESSIVE モードでは、IDはネゴシエーションの
初期の段階で送られるけれど、暗号化されないで送られる。だ世
素拝途喇崚ぢモードのほうがメッセージ交換が少なくてすむので、高速だ世韻譴鼻
苗がナマのままで送られるからちょっとセキュリティは下がる）。
d1749 2
a1750 1
<P>
d1752 1
a1752 1
<h1>13.10 - isakmpdで使えるIKE クライアントは?</h1>
d1755 30
a1784 32
<tt>isakmpd</tt> は、OpenBSD についてくる ISAKMP/Oakley 鍵管理デーモンだ澄
たぶん、ほとんどの ISAKMP 実装とは、部分的にせよ相互運用可能だ世隼廚Δ韻譴鼻
実際にテストされたのは以下のものだ澄于鵑辰討い
蜩瘠逅ぢソフトの一部は、実は OpenBSD isakmp デーモンをベースにしたものだ世辰燭蠅垢襦
斜以下の MS-Windows クライアントは、互換誓△襪箸諒鷙陲△謝名
写評質凖峠∵雕辣齡辮闕菖蜊縒霄佚厖不跚緕写評質凖峠∵雕竢蹼竢躁⊂蒼蓐纖癜鱚銓鹿畩价闕侘ぢソフトウェア
<LI><A HREF="http://www.nai.com/asp_set/products/tns/pgp_vpn.asp">PGP VPN</a> ソフトウェア
<LI><A HREF="http://www.radguard.com/">Radguard</a> cIPro クライアント
<LI><A HREF="http://www.cisco.com/">Cisco</a> IRE クライアント
<LI><A HREF="http://www.microsoft.com">Microsoft</a> Windows 2000 (Transport モードのみ)
</UL>
<P>
以下のゲートウェイ/ルータも互換誓△襪箸諒鷙謝名
写評質凖峠∵雕竕黹鎬竢躁⊂忠黹鐚貧写評質凖峠∵雕竕黹鎬竢躁⊂忠黹鐚佗写評質凖峠∵雕蜴谺竢躁⊂侮貅戻醪阮纈
写評質凖峠∵雕辣齡辮闕菖蜊縒霄佚厖不癆写評質凖峠∵雕竇鈔蜿闕消緕粡鐚弐繚写評質凖峠∵雕諱辣續硝鼠甜肬汝繞帯写評質凖峠∵雕玩跛豁鱚纉遲⊂汝繞哢彖亮肬也銛写評質凖峠∵雕癢緕竢躁⊂遭緕听頸闥
写評質凖峠∵雕纈蜒齠闔闕湘鱸笂齒郤綢陂
写評質凖峠∵雕鱇粢鰾闕紹痲苺癇篌禀會鎰嶄写評質凖峠∵雕罩黼笊鱚闕焼繝綣嶄掠
写評質凖峠∵雕瘢鱚闕菖縺逞癇綣墸瓶写評質凖峠∵雕潟闕闕廠竢躰倚碯蛹粤写評質凖峠∵雕鈿鶯繻鈬闥謫闕称闥貅衷銓蝟蜚写評質凖峠∵雕竏繝謳濶銓闕消蒹站倆蜴惇
箟係甕係斜釈瘢綵嘘陰箟傾甕傾鹿畩
箟傾甕鍵賓黼トラブルシューティングの最初のツールは <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&apropos=0&sektion=8&format=html">tcpdump(8)</a>だ澄
儒鞣霄ぢを使っていくつか探すべきものを挙げると：
<P>
まずOpenBSDの tcpdump を使っている人は、
拡張版の tcpdump を使っているので、
ESP と AH パケットについても情報がとれる。もし OpenBSD
2.5 や他の OS の tcpdump を使っているなら、たぶん古い
バージョンだ世や ESPについてはプロトコル番号しか表示されない
(ESP は IP プロトコル 50, AH は 51)。
d1805 4
a1808 4
tcpdump では、トラフィックが AH/ESP を使っているか平文のままかを確かめよう。
平文のままなら、フローがちゃんと誓瀋蠅気譴討い覆い
蜩瘠逅ぢのネゴシエーションがうまくいっていない。<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&apropos=0&sektion=8&format=html">ping(8)</a>を使って
簡単なトラフィックを発誓犬気擦討澆茲Α
箟険甕険たとえば、208.1.1.1 と 208.2.2.2 の２つのホストがある。
208.2.2.2 にログオンして、以下をやってみよう:
d1823 1
a1823 1
別のセッションでは、encapsulated されたpingが見られる:
d1838 2
a1839 2
<LI>ISAKMP はUDP port 500で実行される。もしこれがファイアーウォールか
パケットフィルタでロックアウトされていたら、これを変えること！
d1850 1
a1850 1
<LI>Photuris は UDP port 468 で動く。考えるのは同じことだ世韻譴鼻▲廛蹈肇灰襪ぢだ澄
箟原甕原蜩瘠逅にデバッグを全部つけるなら、次のようにして実行しよう：
d1867 1
a1867 1
あるいは（いちばん詳しいタイマーデバッグ情報をとばすには）
d1873 2
a1874 2
<LI>IPsecで処理されたトラフィックを、netBから自分のローカルのファイアーウォール保護つきnetAに
入れるようにしてやる必要がある。
d1880 2
a1881 2
<LI>OpenBSD の tcpdump だ世函△曚箸鵑匹離ぅ鵐拭璽優奪
鍵交換（自動鍵交換）セッションの平文部分はほとんどデコードできる。Tcpdump はまた AH ペイロードデータも表示する。
d1883 1
a1883 1
<LI>/kern ファイルシステムをマウントしよう（もしすでにデフォルトで使っていないなら）：
d1889 4
a1892 4
/kern には、現在の SA/SPI 一覧表があって、フローがあるもの
（外行きの SA）もないもの（入ってくる SA)も記述されている。
またどんなトラフィックがどこへ行っているのかしらべられる、トラフィックカウンタも
ある。
d1894 1
a1894 1
<LI>最後に、 <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=netstat&apropos=0&sektion=1&format=html">netstat(1)</a> を使って SAを見ることができる。
d1912 5
a1916 5
これだ世韻笋辰討皀誓メなら、<tt>option ENCDEBUG</tt>つきでカーネルをコンパイルしなおすこと。
それから <tt>net.inet.ip.encdebug</tt> を 1 にする。そして dmesg を見て
警告やエラーをさがし、それを <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendbug&apropos=0&sektion=1&format=html">sendbug(1)</a>を使って
OpenBSD デベロッパーに報告しよう。 あるいはもしそれが
バグかどうかわからなかったら、 you may want to send a message to one of the <A HREF="../mail.html">メーリングリスト</a>のどれかにメッセージを投げてみよう。
d1918 6
a1923 4
<P>
<a name= "13.12">
<h1>13.12 - 関連ドキュメンテーション</h1>
</a>
d1925 1
a1925 1
IPsec が特に詳しく誓睫誓してあるのは
d1927 20
a1946 20
ページだ澄３銅錣寮設定テンプレートが <A HREF="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/">/usr/share/ipsec/</a>
ディレクトリにあるので役にたつだ世蹐Α
質凖峠∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈緕礒黼謾蜿扈刈上釿┫宵
質凖峠∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜷黼礒黼謾蜿扈刈冗頌繝┫宵
質凖峠∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜷黼竅粱繼闔集⊂蜷黼竅粱┯宵
質凖峠∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈韆阡蜩筅黼謾蜿扈権情蓖鱸黻┯宵
質凖峠∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈齡癇纖繼闔襲⊂齡癇纖┗宵
質凖峠∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜩瘠逅筅黼謾蜿扈権冗黶謐鞣┯宵
釈凖峠∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜩瘠逅筮竢鈕繼闔週⊂蜩瘠逅筮竢鈕┻瘤釈凖峠∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈蜩瘠逅筮竟跚笙繼闔週⊂蜩瘠逅筮竟跚笙┻のmanページも詳しくて、IPsecの誓瀋蠅髪人僂北鯲弔呂困誓。
<P>
その他リンクとして……
<UL>
<LI><A HREF="http://www.ietf.org/html.charters/ipsec-charter.html">IETF IPsec Working Group</a>
<LI><A HREF="http://isakmp-test.ssh.fi/">SSH IPsec interoperability Test Node</a>
<LI><A HREF="http://ipsec-wit.antd.nist.gov/">NIST IPsec Web Based Interoperability Tester</a>
<LI><A HREF="http://www.r4k.net/ipsec/">A port of OpenBSD's IPsec to FreeBSD</a>
<LI><A HREF="http://www.xs4all.nl/‾freeswan/">FreeS/WAN - IPsec for Linux</a>
<LI><A HREF="http://www.codetalker.com/greenbox/docs/vpn-24-minifaq.html">OpenBSD 2.4 VPN Configuration Mini-FAQ</a>
d1950 1
a1950 1
そしてつづきましては RFCども...</a>
d1952 30
a1981 30
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc1320.html">RFC 1320</a> - The MD4 Message-Digest Algorithm
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc1321.html">RFC 1321</a> - The MD5 Message-Digest Algorithm
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc1828.html">RFC 1828</a> - IP Authentication using Keyed MD5
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc1829.html">RFC 1829</a> - The ESP DES-CBC Transform
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2040.html">RFC 2040</a> - The RC5, RC5-CBC, RC5-CBC-Pad, and RC5-CTS Algorithms
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2085.html">RFC 2085</a> - HMAC-MD5 IP Authentication with Replay Prevention
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2104.html">RFC 2104</a> - HMAC: Keyed-Hashing for Message Authentication
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2144.html">RFC 2144</a> - The CAST-128 Encryption Algorithm 
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2202.html">RFC 2202</a> - Test Cases for HMAC-MD5 and HMAC-SHA-1 
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2207.html">RFC 2207</a> - RSVP Extensions for IPsec Data Flows
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2268.html">RFC 2268</a> - A Description of the RC2 Encryption Algorithm 
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2367.html">RFC 2367</a> - PF_KEY Key Management API, Version 2
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2401.html">RFC 2401</a> - Security Architecture for the Internet Protocol (<b>IPsec</b>)
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC 2402</A> - IP Authentication Header (<b>AH</b>)
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2403.html">RFC 2403</A> - The Use of HMAC-MD5-96 within ESP and AH
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2404.html">RFC 2404</A> - The Use of HMAC-SHA-1-96 within ESP and AH
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2405.html">RFC 2405</A> - The ESP DES-CBC Cipher Algorithm With Explicit IV
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC 2406</A> - IP Encapsulating Security Payload (<b>ESP</b>)
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">RFC 2407</A> - The Internet IP Security Domain of Interpretation for ISAKMP
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC 2408</A> - Internet Security Association and Key Management Protocol (<b>ISAKMP</b>)
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">RFC 2409</A> - The Internet Key Exchange (<b>IKE</b>)
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2410.html">RFC 2410</A> - The NULL Encryption Algorithm and Its Use With IPsec (ha ha...)
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2411.html">RFC 2411</A> - IP Security Document Roadmap
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2412.html">RFC 2412</A> - The OAKLEY Key Determination Protocol
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2451.html">RFC 2451</a> - The ESP CBC-Mode Cipher Algorithms
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2522.html">RFC 2522</a> - Photuris: Session-Key Management Protocol
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2523.html">RFC 2523</a> - Photuris: Extended Schemes and Attributes
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2631.html">RFC 2631</a> - Diffie-Hellman Key Agreement Method
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2709.html">RFC 2709</a> - Security Model with Tunnel-mode IPsec for NAT Domains
</UL>
d1984 3
a1986 3
<a href= "index.html">[FAQ トップへ]</a>
<a href= "faq12.html">[12.0 - 高度なユーザ向け]</a>
<a href= "../faq14.html">[14.0 - OpenBSD のハードディスク]</a>
d1994 1
a1994 1
Originally [OpenBSD: faq13.html,v 1.46 ]
d1996 1
a1996 1
$Translation: faq13.html,v 1.3 2002/01/12 04:09:11 tueda Exp $
d1998 1
a1998 1
$OpenBSD: faq13.html,v 1.46 2001/12/23 03:09:52 miod Exp $
@


1.2
log
@sync with badlands translation CVS.
@
text
@d3 1
a3 1
<title>13.0 - IPSec を使う</title>
d10 1
a10 1
 <meta http-equiv="Content-Type" content="text/html; charset=iso-2022-jp">
d16 1
a16 1
<h1><font color=#e00000>13.0 - IPSec (IP Security Protocol) を使う</font></h1>
d22 3
a24 3
<LI><A HREF="#13.1">13.1 - IPSecって何?</A></LI>
<LI><A HREF="#13.2">13.2 - そりゃ結構だ世韻譴鼻△海里椶覆佯繝ぢなんか使わにゃならんの?</A></LI>
<LI><A HREF="#13.3">13.3 - IPSecの裏にあるプロトコルは?</A>
d26 2
a27 2
<LI><A HREF="#13.5">13.5 - IPSec の誓瀋鹿曽
写評質凖峠■嘘⊂嘘佯繝ぢを手動鍵誓瀋蠅濃箸Δ砲深箜甞写評質凖峠■嘘陰庄凱臼佯繝侘ぢのトラブルシューティング</A>
d41 1
a41 1
<LI><A HREF="http://www.freebsd.org/‾julian/IPSEC_4_Dummies.html">IPSec for Dummies</a> by Julian Elischer
d49 1
a49 1
<h1>13.1 - IPSecってなに?</h1>
d52 1
a52 1
IPSec は、IP プロトコルファミリーに対する拡張だ澄
箋甬完全誓蜴苒蜚ぢ）、アクセス誓罅〔性が提供される。IPSec は
d57 1
a57 1
アプリケーションのほうでは IPSec を使うのに、IPSec のことを何一つ知らなくていい、
d59 2
a60 2
IPSec 上では<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/protocols?rev=1.8">あらゆる IP プロトコル</a>を使える。暗号化トンネル (VPN) も作れるし、コンピュータ間で単純な暗号化をしてもいい。
オプションが実にいろいろあるせいで、IPSec はちょっとややこしいのである (それも SSL よりずっと!)
d62 1
a62 1
IPSec を使う前に、
d67 1
a67 1
論斥砲蓮賓嚆は以下のどんな形でも機能する:
d77 1
a77 1
これから見るように、IPSec は VPN 誓楝獲僂縫肇薀侫奪鬟肇鵐優襪任襦
筝畍取云嘘ぢそりゃ結構だ世韻譴鼻△海里椶覆佯繝なんか使わにゃならんの?</h1>
d88 2
a89 2
IPSec はこれを解決しようとする。以下のサービスはそれぞれ独立と考えられているけれど、
IPSec はそれを統一的な形でサポートしている。
d119 1
a119 1
<h1>13.3 - IPSec の裏にあるプロトコルは?</h1>
d122 1
a122 1
IPSec は、機密誓袷汗性、authenticity（誓疑神性）、再送保護を提供するのに、
d157 1
a157 1
<P>IPsec 機能の（ほとんど）独立した部分が、IPSec encapsulation を
d178 1
a178 1
<P>IPSec で保護されたリンクは、<B>Security Associations
d251 1
a251 1
<h1>13.5 - IPSec の誓瀋鹿莟箍鬼
甓鬼
斜症佯繝ぢシステムとゲートウェイがどう誓瀋蠅気譴襪蓮△△訥戮論設計者まかせに
d260 1
a260 1
OpenBSDの IPSecソースコードの中では、TDB または TDB table と呼ばれている）で、
d278 2
a279 2
<P>　SPD はまたどのトラフィックが IPSec をバイパスすべきか、またどのトラフィックを
捨てるべきかを指定できるので、入ってくる非 IPSec のトラフィックについても参照されなくてはならない。
d293 1
a293 1
<LI>IPSec プロトコル(AH か ESP)
d313 1
a313 1
IPSec セッションはこのどちらか、あるいは両方を持たなきゃならない。どちらのヘッダ世發覆靴把蟲舛気譴襪海箸
箜碍
甞碍
取云嘘ぢ手動鍵誓瀋蠅佯繝ぢを誓瀋蠅垢襪砲呂匹Δ垢襪深云
箜完
甞完
賓嚆ぢの手始めとしていちばんかんたんなのが手動鍵誓瀋蠅誓。
d448 1
a448 1
これはIPSecを使い始める簡単なやりかただ澄
箚軌
甦軌
賓嚆を使えば、プライベート IP アドレス空間をインターネットごしにつなげる。
d452 1
a452 1
208.2.2.2の背後にある 208.1.5.0/24 をトンネルでつなげたいとしよう。
d455 1
a455 1
ごらんのとおり、IPSecで手動鍵誓瀋蠅鮖箸辰討い襪函
箋俺
甬俺
これですべての IPSec 情報 (SPI、フロー、ルーティングのエントリ）がシステムから一掃される。
d579 2
a580 2
</a><P>VPNs をはじめIPSecの各種伝統的なアプリケーションを考えているなら、
たぶん ISAKMP を使うことになる。IPSec の商業実装の
d591 1
a591 1
二つのIPSecノード間でIPSecパラメータを確立するために、
d605 2
a606 2
<b>フェーズ 2</b> - Security Associations がIPSecにかわってネゴされる。
フェーズ 2 はIPSecホスト間にトンネルか endpoint SA を確立する。
d615 1
a615 1
フェーズ 1 では IPSec ノード同士が誓楝海魍領靴
箒乙
甼乙
賓嚆スタック用のバイナリがついてくる。残念ながら、
d649 1
a649 1
このファイルは ISAKMP に、だ世譴佯繝ぢにアクセスできるかを教える。このシナリオでは、この policy ファイルは、
d653 1
a653 1
希望をISAKMPに伝えられる。まただ世譴任佯繝ぢが使えるようにしてもいい。これはテスト用だ世韻砲靴討里召泙靴ぁ
箒薫
甼薫
衷鈔蜚蜿銖瘰鞏粹轣蜴賓嚆竟跚笙瘢雹逅箏慌
畄慌
このピアがこのホストと IPSec を使っていいことになっているかを確認する。ここのパスワードを変えたら、
d834 1
a834 1
記述した、以下の IPSec-ID セクションを指す。この部分が送られて、向こう側のゲートウェイがVPN経由で
d837 1
a837 1
あるはずのものを記述した、下のIPSec-ID セクションを記述しているこの部分が解釈されて、こちらのプライベートネットワークから
d843 1
a843 1
ここはIPSec-ID セクションだ澄０焚爾離┘鵐肇蠅蓮▲曠好ぢとホストBの
d895 1
a895 1
<b>Suites=</b> は IPSec Suite セクションを指している。
d897 1
a897 1
ISAKMP と IPSec については、ほかにも誓睫誓することがいっぱいある。いまの基本的な誓睫誓をもとに、
d1000 1
a1000 1
要するに、二つのネットワークが、保護されていないネットワーク上を、IPSecトンネル経由で
d1034 1
a1034 1
# Now phase 2 is negotiating IPSec SAs. As in phase 1, the name here
d1071 1
a1071 1
# This is the section for the IPSec connection. The section name is
d1075 1
a1075 1
# packages should be forwarded over the IPSec tunnel to the remote 
d1093 1
a1093 1
# IPSecトンネル経由でリモートシステムに転送される。
d1543 1
a1543 1
これで、IPSec誓楝海鯑誓られるのは gw.worksite.se だ世韻里呂此
箟袈甕袈取云嘘夸阨碎纉蓖阡蜴賓嚆祚嶄亮云
箟袈甕袈賓嚆トラブルシューティングの最初のツールは <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&apropos=0&sektion=8&format=html">tcpdump(8)</a>だ澄
箟鹸甕鹸写評賓嚆ぢで処理されたトラフィックを、netBから自分のローカルのファイアーウォール保護つきnetAに
d1896 1
a1896 1
IPSec が特に詳しく誓睫誓してあるのは
d1908 1
a1908 1
のmanページも詳しくて、IPSecの誓瀋蠅髪人僂北鯲弔呂困誓。
d1912 5
a1916 5
<LI><A HREF="http://www.ietf.org/html.charters/ipsec-charter.html">IETF IPSec Working Group</a>
<LI><A HREF="http://isakmp-test.ssh.fi/">SSH IPSec interoperability Test Node</a>
<LI><A HREF="http://ipsec-wit.antd.nist.gov/">NIST IPSec Web Based Interoperability Tester</a>
<LI><A HREF="http://www.r4k.net/ipsec/">A port of OpenBSD's IPSec to FreeBSD</a>
<LI><A HREF="http://www.xs4all.nl/‾freeswan/">FreeS/WAN - IPSec for Linux</a>
d1932 1
a1932 1
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2207.html">RFC 2207</a> - RSVP Extensions for IPSec Data Flows
d1935 1
a1935 1
<LI><A HREF="http://www.cis.ohio-state.edu/htbin/rfc/rfc2401.html">RFC 2401</a> - Security Architecture for the Internet Protocol (<b>IPSec</b>)
d1965 1
a1965 1
Originally [OpenBSD: faq13.html,v 1.45 ]
d1967 1
a1967 1
$Translation: faq13.html,v 1.2 2001/10/19 11:24:15 tueda Exp $
d1969 1
a1969 1
$OpenBSD: faq13.html,v 1.45 2001/10/04 09:59:02 wilfried Exp $
@


1.1
log
@
Sync with badlands translation CVS
@
text
@d9 2
a10 2
<meta name= "copyright"     content= "This document copyright (C) 2000 OpenBSD">
<meta http-equiv="Content-Type" content="text/html; charset=iso-2022-jp">
d16 3
a18 20

<p>
<font color= "#0000e0">
<a href="index.html">[FAQ 目次]</a>
<a href="faq12.html">[12.0 - 高度なユーザ向け]</a>
<a href="../faq14.html">[14.0 - OpenBSD でディスクを使う]</a>
</font>
</p>

<p>
<Font size="-1">
このドキュメントの一部は、以下のドキュメントからとっている:
<UL>
<LI><A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&sektion=4&format=html">ipsec(4)</a>
<LI><A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&sektion=8&format=html">vpn(8)</a>
<LI><A HREF="http://www.freebsd.org/‾julian/IPSEC_4_Dummies.html">IPSec for Dummies</a> by Julian Elischer
<LI><A HREF="http://www.secureops.com/vpn/vpn.html">ISAKMP Howto</a> by Patrick Ethier
<LI><A HREF="http://hem.passagen.se/hojg/isakmpd/">X.509v3 certificates with isakmpd</a> by J&ouml;rgen Granstam
</UL>
</font>
d20 1
a20 1
<h1>13.0 - IPSec (IP Security Protocol) を使う</h1>
d36 12
a1916 1
<LI><A HREF="http://www.cs.umass.edu/‾lmccarth/ipsec.html">Lots of IPSec related links</A>
d1965 1
a1965 1
Originally [OpenBSD: faq13.html,v 1.40 ]
d1967 1
a1967 1
$Translation: faq13.html,v 1.1 2001/06/16 15:35:37 tueda Exp $
d1969 1
a1969 1
$OpenBSD: faq13.html,v 1.40 2001/03/26 17:14:09 todd Exp $
@

