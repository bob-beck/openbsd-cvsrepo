head	1.17;
access;
symbols;
locks; strict;
comment	@# @;


1.17
date	2014.04.01.17.14.10;	author nick;	state dead;
branches;
next	1.16;

1.16
date	2013.06.05.12.30.47;	author ajacoutot;	state Exp;
branches;
next	1.15;

1.15
date	2012.11.08.08.49.02;	author ajacoutot;	state Exp;
branches;
next	1.14;

1.14
date	2012.11.04.08.15.48;	author ajacoutot;	state Exp;
branches;
next	1.13;

1.13
date	2012.10.15.10.51.18;	author ajacoutot;	state Exp;
branches;
next	1.12;

1.12
date	2012.05.26.08.43.42;	author ajacoutot;	state Exp;
branches;
next	1.11;

1.11
date	2012.04.05.17.07.26;	author ajacoutot;	state Exp;
branches;
next	1.10;

1.10
date	2011.11.21.10.51.28;	author ajacoutot;	state Exp;
branches;
next	1.9;

1.9
date	2011.08.20.14.54.01;	author ajacoutot;	state Exp;
branches;
next	1.8;

1.8
date	2011.05.04.12.45.18;	author ajacoutot;	state Exp;
branches;
next	1.7;

1.7
date	2011.04.02.08.13.11;	author ajacoutot;	state Exp;
branches;
next	1.6;

1.6
date	2010.11.06.00.17.30;	author ajacoutot;	state Exp;
branches;
next	1.5;

1.5
date	2010.06.19.07.38.08;	author ajacoutot;	state Exp;
branches;
next	1.4;

1.4
date	2008.01.13.13.42.30;	author tobias;	state dead;
branches;
next	1.3;

1.3
date	2003.11.10.14.42.48;	author horacio;	state Exp;
branches;
next	1.2;

1.2
date	2003.11.10.13.22.18;	author horacio;	state Exp;
branches;
next	1.1;

1.1
date	2003.11.03.14.24.05;	author horacio;	state Exp;
branches;
next	;


desc
@@


1.17
log
@
Abandon translations, per deraadt@@ and ajacoutot@@.
@
text
@<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Filtrov√°n√≠ paket≈Ø</title>
<link rev="made" href="mailto:www@@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003-2007 Joel Knight <enabled@@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../cs/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="tables.html">P≈ôedchoz√≠: Tabulky</a>]
[<a href="index.html">Obsah</a>]
[<a href="../nat.html">Dal≈°√≠: Network Address Translation</a>]

<h1><font color="#e00000">PF: Filtrov√°n√≠ paket≈Ø</font></h1>

<hr>

<h3>Obsah</h3>
<ul>
<li><a href="#intro">√övod</a>
<li><a href="#syntax">Syntaxe pravidel</a>
<li><a href="#defdeny">Zak√°z√°n√≠ v≈°eho</a>
<li><a href="#pass">Povolov√°n√≠ provozu</a>
<li><a href="#quick">Kl√≠ƒçov√© slovo <tt>quick</tt></a>
<li><a href="#state">Udr≈æov√°n√≠ informace o spojen√≠</a>
<li><a href="#udpstate">Udr≈æov√°n√≠ informace o spojen√≠ pro UDP</a>
<li><a href="#stateopts">Volby pro sledov√°n√≠ stav≈Ø</a>
<li><a href="#tcpflags">Volby TCP paketu</a>
<li><a href="#synproxy">TCP SYN Proxy</a>
<li><a href="#antispoof">Blokov√°n√≠ podvr≈æen√Ωch paket≈Ø</a>
<li><a href="#urpf">Unicast Reverse Path Forwarding</a>
<li><a href="#osfp">Pasivn√≠ detekce operaƒçn√≠ch syst√©m≈Ø</a>
<li><a href="#ipopts">Volby protokolu IP</a>
<li><a href="#example">P≈ô√≠klad filtrovac√≠ch pravidel</a>
</ul>

<hr>

<a name="intro"></a>
<h2>√övod</h2>
Filtrov√°n√≠ paket≈Ø je selektivn√≠ povolen√≠ nebo blokov√°n√≠ datov√Ωch paket≈Ø, 
kter√© proch√°z√≠ p≈ôes s√≠≈•ov√© rozhran√≠. Krit√©ria, kter√° 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+5.3"
>pf(4)</a> pou≈æ√≠v√° p≈ôi inspekci paket≈Ø jsou zalo≈æena na vrstvƒõ 3
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ip&amp;sektion=4"
>IPv4</a> a 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ip6&amp;sektion=4"
>IPv6</a>) a vrstvƒõ 4
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcp&amp;sektion=4"
>TCP</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=udp&amp;sektion=4"
>UDP</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=icmp&amp;sektion=4"
>ICMP</a> a
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=icmp6&amp;sektion=4"
>ICMPv6</a>) z√°hlav√≠. Nejƒçastƒõji pou≈æ√≠van√° krit√©ria jsou zdrojov√° a c√≠lov√°
adresa, zdrojov√Ω a c√≠lov√Ω port a protokol.

<p>
Filtrovac√≠ pravidla specifikuj√≠ krit√©ria, kter√° mus√≠ paket splnit a n√°slednou
akci, buƒè blokov√°n√≠ nebo povolen√≠, kter√° se vykon√° jakmile se najde shoda.
Filtrovac√≠ pravidla jsou vykon√°v√°na sekvenƒçnƒõ od prvn√≠ho k posledn√≠mu.
Pokud paket neodpov√≠d√° pravidlu obsahuj√≠c√≠mu kl√≠ƒçov√© slovo <tt>quick</tt>, 
tak paket proch√°z√≠ <i>v≈°echna</i> pravidla p≈ôedt√≠m ne≈æ nastane fin√°ln√≠ akce.
Posledn√≠ pravidlo, kter√© odpov√≠d√° je "v√≠tƒõz" a bude urƒçovat, kter√° akce se 
s paketem provede. Je zde defaultn√≠ pravidlo <tt>pass all</tt> na zaƒç√°tku
seznamu, kter√© znamen√°, ≈æe pokud paket neodpov√≠d√° ≈æ√°dn√©mu filtrovac√≠mu 
pravidlu, tak v√Ωsledn√° akce bude <tt>pass</tt>.

<a name="syntax"></a>
<h2>Syntaxe pravidel</h2>
Obecn√°, <i>velmi zjednodu≈°en√°</i> syntaxe pro filtrovac√≠ pravidla je:
<blockquote>
<tt>
<i>action</i> [<i>direction</i>] [log] [quick] [on <i>interface</i>] 
[<i>af</i>] [proto <i>protocol</i>] \<br>
&nbsp;&nbsp;&nbsp;[from <i>src_addr</i> [port <i>src_port</i>]] [to 
<i>dst_addr</i> [port <i>dst_port</i>]] \<br>
&nbsp;&nbsp;&nbsp;[flags <i>tcp_flags</i>] [<i>state</i>]
</tt>
</blockquote>

<dl>
<dt><tt><i>action</i></tt>
<dd>Akce, kter√° se vykon√° na odpov√≠daj√≠c√≠ch paketech. Buƒè <tt>pass</tt> nebo
<tt>block</tt>. Akce <tt>pass</tt> propust√≠ paket d√°le do j√°dra k dal≈°√≠mu
zpracov√°n√≠, zat√≠mco <tt>block</tt> akce reaguje podle nastaven√≠
<a href="options.html#block-policy"><tt>block-policy</tt></a> volby. 
Defaultni reakce m≈Ø≈æe b√Ωt p≈ôeps√°na buƒè pomoc√≠ specifikov√°n√≠ 
<tt>block drop</tt> nebo <tt>block return</tt>.

<dt><tt><i>direction</i></tt>
<dd>Smƒõr, kter√Ωm se paket pohybuje na rozhran√≠. Buƒè
<tt>in</tt> nebo <tt>out</tt>.

<dt><tt>log</tt>
<dd>Specifikuje, ≈æe paket by mƒõl b√Ωt zaznamen√°n pomoc√≠
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+5.3"
>pflogd(8)</a>. Pokud pravidlo vytv√°≈ô√≠ stav, tak pouze paket, kter√Ω tento
stav vytv√°≈ô√≠ je zaznamen√°n. K zaznamen√°n√≠ v≈°ech paket≈Ø bez rozd√≠lu pou≈æijte
<tt>log (all)</tt>.

<dt><tt>quick</tt>
<dd>Pokud paket odpov√≠d√° pravidlu specifikuj√≠c√≠mu <tt>quick</tt>, tak je toto
pravidlo pova≈æov√°no za posledn√≠ odpov√≠daj√≠c√≠ a specifikovan√°
<tt><i>action</i></tt> je provedena.

<dt><tt><i>interface</i></tt>
<dd>N√°zev nebo skupina s√≠≈•ov√©ho rozhran√≠ p≈ôes kter√© se paket pohybuje.
Rozhran√≠ mohou b√Ωt p≈ôid√°na do skupin pomoc√≠
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"
>ifconfig(8)</a> p≈ô√≠kazu.
Nƒõkter√© skupiny jsou vytvo≈ôeny automaticky j√°drem:
<ul>
<li>Skupina <tt>egress</tt> , kter√° obsahuje rozhran√≠(i v√≠ce z nich) je≈æ
maj√≠ defaultn√≠ route(s).
<li>Obecn√° skupina pro klonovan√© rozhran√≠.
P≈ô√≠klad: <tt>ppp</tt> nebo <tt>carp</tt>.
</ul>
Tohle zajist√≠, ≈æe pravidlo bude odpov√≠dat jak√©mukoliv paketu, kter√Ω jde
p≈ôes jak√©koliv <tt>ppp</tt> nebo <tt>carp</tt> rozhran√≠.

<dt><tt><i>af</i></tt>
<dd>Rodina adres paketu. Buƒè <tt>inet</tt> pro IPv4 nebo
<tt>inet6</tt> pro IPv6. PF je obvykle schopn√© rozli≈°it tento parametr
na z√°kladƒõ zdrojov√© a/nebo c√≠lov√© adresy(adres).

<dt><tt><i>protocol</i></tt>
<dd>Protokol paketu z vrstvy 4:
<ul>
<li><tt>tcp</tt>
<li><tt>udp</tt>
<li><tt>icmp</tt>
<li><tt>icmp6</tt>
<li>Platn√© jm√©no protokolu z 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=protocols&amp;sektion=5"
><tt>/etc/protocols</tt></a>
<li>ƒå√≠slo protokolu mezi 0 a 255
<li>Sada protokol≈Ø za pou≈æit√≠ <a href="macros.html#lists">seznamu</a>.
</ul>

<dt><tt><i>src_addr</i></tt>, <tt><i>dst_addr</i></tt> 
<dd>Zdrojov√°/c√≠lov√° adresa v IP z√°hlav√≠. Adresy mohou b√Ωt specifikov√°ny
jako:
<ul>
<li>Samotn√° IPv4 nebo IPv6 adresa.
<li><a href="http://public.swbell.net/dedicated/cidr.html">CIDR</a> 
s√≠≈•ov√Ω blok.
<li>Pln√© dom√©nov√© jm√©no, kter√© bude p≈ôelo≈æeno pomoc√≠ DNS v dobƒõ nahr√°v√°n√≠
pravidel. V≈°echny v√Ωsledn√© IP adresy budou do pravidel doplnƒõny a nahrad√≠
dom√©nov√© jm√©na.
<li>Jm√©no s√≠≈•ov√©ho rozhran√≠ nebo skupiny. Jak√°koliv IP adresa p≈ôi≈ôazen√° k
rozhran√≠ bude doplnƒõna do pravidla.
<li>Jm√©no s√≠≈•ov√©ho rozhran√≠ n√°sledovan√©
<tt>/<i>s√≠≈•ovou maskou</i></tt> (nap≈ô., <tt>/24</tt>). 
Ka≈æd√° IP adresa na rozhran√≠ je zkombinovan√° se s√≠≈•ovou maskou k vytvo≈ôen√≠
CIDR s√≠≈•ov√©ho bloku, kter√Ω je n√°slednƒõ doplnƒõn do pravidla.
<li>Jm√©no s√≠≈•ov√©ho rozhran√≠ nebo skupiny v jednoduch√Ωch z√°vork√°ch
<tt>( )</tt>.
Toto PF ≈ô√≠k√°, ≈æe se pravidlo m√° aktualizovat pokud se IP adresa(adresy) na
pojmenovan√©m rozhran√≠ zmƒõn√≠.
Toto je u≈æiteƒçn√© na rozhran√≠, kter√© z√≠sk√°v√° svou IP adresu pomoc√≠ DHCP nebo
na vyt√°ƒçen√©m p≈ôipojen√≠, proto≈æe pravidla pak nemus√≠ b√Ωt znovu nahr√°v√°na 
poka≈æd√©, kdy≈æ se adresa zmƒõn√≠.
<li>Jm√©no s√≠≈•ov√©ho rozhran√≠ n√°sledovan√© jak√Ωmkoliv z n√°sleduj√≠c√≠ch
modifik√°tor≈Ø: 
  <ul>
  <li><tt>:network</tt> - dosad√≠ CIDR s√≠≈•ov√Ω blok (nap≈ô.,
  192.168.0.0/24)
  <li><tt>:broadcast</tt> - dosad√≠ s√≠≈•ovou broadcast adresu
  (nap≈ô., 192.168.0.255)
  <li><tt>:peer</tt> - dosad√≠ peer IP adresu na point-to-point lince
  </ul>
  <dl>
  <dd>Jako doplnƒõn√≠, <tt>:0</tt> modifik√°tor m≈Ø≈æe b√Ωt p≈ôid√°n buƒè ke jm√©nu
  rozhran√≠ nebo k jak√©mukoliv v√Ω≈°e zm√≠nƒõn√©mu modifik√°toru pro indikaci, ≈æe
  PF by nemƒõl zahrnout IP aliasy k dosazen√≠. Tyto modifik√°tory mohou b√Ωt
  tak√© pou≈æity, kdy≈æ je rozhran√≠ uvedeno v z√°vork√°ch.
  P≈ô√≠klad: <tt>fxp0:network:0</tt>
  </dl>
<li><a href="tables.html">Tabulka</a>.
<li>Kl√≠ƒçov√© slovo <tt>urpf-failed</tt> m≈Ø≈æe b√Ωt pou≈æito pro zdrojovou adresu
k indikaci toho, ≈æe by mƒõla proj√≠t <a href="#urpf">uRPF kontrolou</a>.
<li>Cokoliv z v√Ω≈°e uveden√©ho, ale negovan√© pomoc√≠ <tt>!</tt> ("ne") 
modifik√°toru.
<li>Sada adres pomoc√≠ <a href="macros.html#lists">seznamu</a>.
<li>Kl√≠ƒçov√© slovo <tt>any</tt> znamenaj√≠c√≠ v≈°echny adresy.
<li>Kl√≠ƒçov√© slovo <tt>all</tt>, kter√© je zkratkou pro <tt>from any to
any</tt>.
</ul>

<dt><tt><i>src_port</i></tt>, <tt><i>dst_port</i></tt>
<dd>Zdrojov√Ω/c√≠lov√Ω port v z√°hlav√≠ paketu na vrstvƒõ 4. Porty mohou b√Ωt
specifikov√°ny jako:
<ul>
<li>ƒå√≠slo mezi 1 a 65535
<li>Platn√© jm√©no slu≈æby z
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=services&amp;sektion=5"
><tt>/etc/services</tt></a>
<li>Sada port≈Ø pomoc√≠ <a href="macros.html#lists">seznamu</a>
<li>Rozsah:
	<ul>
	<li><tt>!=</tt> (nerovn√° se)
	<li><tt>&lt;</tt> (m√©nƒõ ne≈æ)
	<li><tt>&gt;</tt> (v√≠ce ne≈æ)
	<li><tt>&lt;=</tt> (m√©nƒõ ne≈æ nebo rovn√° se)
	<li><tt>&gt;=</tt> (v√≠ce ne≈æ nebo rovn√° se)
	<li><tt>&gt;&lt;</tt> (rozsah)
	<li><tt>&lt;&gt;</tt> (inverzn√≠ rozsah)
	<dl>
	<dd>Posledn√≠ dva jsou bin√°rn√≠ oper√°tory (p≈ôij√≠maj√≠ dva argumenty) 
	a neobsahuj√≠ argumenty v rozsahu.
	</dl>
	<li><tt>:</tt> (v≈°eobecn√Ω rozsah)
	<dl>
	<dd>Jedn√° se tak√© o bin√°rn√≠ oper√°tor a obsahuje argumenty v rozsahu.
	</dl>
	</ul>
</ul>

<dt><tt><i>tcp_flags</i></tt>
<dd>Specifikuje volby, kter√© mus√≠ b√Ωt nastaveny v TCP z√°hlav√≠ p≈ôi pou≈æ√≠t√≠
<tt>proto tcp</tt>. Volby jsou specifikov√°ny jako 
<tt>flags <i>check</i>/<i>mask</i></tt>. P≈ô√≠klad: <tt>flags
S/SA</tt> - toto PF ≈ô√≠k√°, aby se pod√≠val na S a A (SYN a ACK)
volby a aplikoval toto pravidlo na paket jen pokud je SYN volba "zapnuta" 
(defaultnƒõ to plat√≠ pro v≈°echna TCP pravidla).
<tt>flags any</tt> instructs PF not to check flags.

<dt><tt><i>state</i></tt>
<dd>Specifikuje, zda se ukl√°d√° informace o stavu spojen√≠ pro pakety, kter√©
odpov√≠daj√≠ tomuto pravidlu.
<ul>
<li><tt>no state</tt> - funguje s TCP, UDP a ICMP.
PF nebude sledovat informace o stavu spojen√≠.
Pro TCP spojen√≠, <tt>flags any</tt> je obvykle nutno pou≈æ√≠t.
<li><tt>keep state</tt> - funguje s TCP, UDP a ICMP.
Tato volba je defaultn√≠ pro v≈°echny filtrovac√≠ pravidla.
<li><tt>modulate state</tt> - funguje pouze s TCP. PF vygeneruje siln√©
Initial Sequence Number (ISN) pro pakety odpov√≠daj√≠c√≠ tomuto pravidlu.
<li><tt>synproxy state</tt> - funguje jako proxy pro p≈ô√≠choz√≠ TCP spojen√≠
k ochranƒõ server≈Ø p≈ôed zahlcen√≠m TCP SYN pakety s podvr≈æenou adresou.
Tato volba obsahuje funkƒçnost <tt>keep state</tt> a
<tt>modulate state</tt>.
</ul>
</dl>

<a name="defdeny"></a>
<h2>Zak√°z√°n√≠ v≈°eho</h2>
Doporuƒçen√° praxe p≈ôi nastavov√°n√≠ firewallu je pou≈æ√≠t p≈ô√≠stup "default deny".
To znamen√° zak√°zat <i>v≈°e</i> a pot√© selektivnƒõ povolovat urƒçit√Ω provoz
p≈ôes firewall. Tento p≈ô√≠stup je doporuƒçen√Ω, proto≈æe zvy≈°uje bezpeƒçnost a
zjednodu≈°uje psan√≠ pravidel.

<p>
Pro vytvo≈ôen√≠ "default deny" filtrovac√≠ politiky staƒç√≠ vytvo≈ôit tyto prvn√≠
dvƒõ filtrovac√≠ pravidla:
<blockquote>
<tt>
block in &nbsp;all<br>
block out all
</tt>
</blockquote>

<p>
Toto bude blokovat v≈°echen provoz na v≈°ech rozhran√≠ch v jak√©mkoliv smƒõru a
odkudkoliv kamkoliv.

<a name="pass"></a>
<h2>Povolov√°n√≠ provozu</h2>
Provoz nyn√≠ mus√≠ b√Ωt explicitnƒõ povolen pro pr≈Øchod firewallem, proto≈æe
jinak bude zahozen d√≠ky politice "default deny". Tohle je oblast, kde 
krit√©ria paket≈Ø jako zdrojov√Ω/c√≠lov√Ω port, zdrojov√°/c√≠lov√° adresa a protokol
p≈ôich√°zej√≠ do hry. Kdykoliv je provoz povolen proch√°zet p≈ôes firewall, tak
pravidlo(pravidla) mus√≠ b√Ωt maxim√°lnƒõ restriktivn√≠ jak to jen je mo≈æn√©.
Je to kv≈Øli tomu, aby se zajistilo, ≈æe jen chtƒõn√Ω provoz a opravdu jen chtƒõn√Ω
provoz bude povolen.

<p>
Nƒõkter√© p≈ô√≠klady:
<blockquote>
<tt>
# Pass traffic in on dc0 from the local network, 192.168.0.0/24,<br>
# to the OpenBSD machine's IP address 192.168.0.1. Also, pass the<br>
# return traffic out on dc0.<br>
pass in &nbsp;on dc0 from 192.168.0.0/24 to 192.168.0.1<br>
pass out on dc0 from 192.168.0.1 to 192.168.0.0/24<br>
<br>
<br>
# Pass TCP traffic in on fxp0 to the web server running on the<br>
# OpenBSD machine. The interface name, fxp0, is used as the<br>
# destination address so that packets will only match this rule if<br>
# they're destined for the OpenBSD machine.<br>
pass in on fxp0 proto tcp from any to fxp0 port www
</tt>
</blockquote>

<a name="quick"></a>
<h2>Kl√≠ƒçov√© slovo <tt>quick</tt></h2>
Jak ji≈æ bylo zm√≠nƒõno d≈ô√≠ve, tak ka≈æd√Ω paket se vyhodnocuje v pravidlech
od shora dol≈Ø. Defaultnƒõ je paket oznaƒçen k propu≈°tƒõn√≠ co≈æ m≈Ø≈æe b√Ωt
zmƒõnƒõno kter√Ωmkoliv pravidlem. M≈Ø≈æe to b√Ωt zmƒõnƒõno tam a zpƒõt nƒõkolikr√°t
po sobƒõ ne≈æ se doraz√≠ na konec filtrovac√≠ch pravidel. <b>Posledn√≠
odpov√≠daj√≠c√≠ pravidlo "v√≠tƒõz√≠".</b>  Je zde ale vyj√≠mka z tohoto pravidla:  <tt>quick</tt> volba ve filtrovac√≠m pravidle m√° efekt zru≈°en√≠ jak√©hokoliv
n√°sledn√©ho zpracov√°v√°n√≠ a zp≈Øsob√≠, ≈æe specifikovan√° akce se provede.
Pojƒème se pod√≠vat na nƒõkolik p≈ô√≠klad≈Ø:

<p>
≈†patnƒõ:
<blockquote>
<tt>
block in on fxp0 proto tcp to port ssh<br>
pass &nbsp;in all
</tt>
</blockquote>

<p>
V tomto p≈ô√≠padƒõ by <tt>block</tt> ≈ô√°dek mƒõl b√Ωt vykon√°n, ale nikdy nebude
m√≠t ≈æ√°dn√Ω efekt, proto≈æe je n√°sledov√°n ≈ô√°dkem, kter√Ω propust√≠ v≈°e.

<p>
L√©pe:
<blockquote>
<tt>
block in quick on fxp0 proto tcp to port ssh<br>
pass &nbsp;in all
</tt>
</blockquote>

<p>
Tyto pravidla jsou vykon√°ny trochu odli≈°nƒõ. Pokud ≈ô√°dek <tt>block</tt>
odpov√≠d√°, tak d√≠ky volbƒõ <tt>quick</tt> bude paket zablokov√°n a zbytek
pravidel bude ignorov√°n.

<a name="state"></a>
<h2>Udr≈æov√°n√≠ informace o spojen√≠</h2>
Jedna z d≈Øle≈æit√Ωch vlastnost√≠ PF je udr≈æov√°n√≠ informace o spojen√≠
"keeping state" nebo kontrola stavu spojen√≠ "stateful inspection".
Kontrola stavu spojen√≠ odkazuje na schopnost PF sledovat stav nebo v√Ωvoj
s√≠≈•ov√©ho spojen√≠. Pomoc√≠ ukl√°d√°n√≠ informace o ka≈æd√©m spojen√≠ do stavov√© 
tabulky je PF schopn√© rychle rozhodnout jestli paket proch√°zej√≠c√≠ firewallem
n√°le≈æ√≠ do ji≈æ existuj√≠c√≠ho nav√°zan√©ho spojen√≠. Pokud ano, tak je pu≈°tƒõn skrze
firewall ani≈æ by proch√°zel dal≈°√≠mi pravidly.

<p>
Udr≈æov√°n√≠ informace o spojen√≠ m√° mnoho v√Ωhod vƒçetnƒõ lehƒç√≠ch pravidel a 
lep≈°√≠ho v√Ωkonu filtrov√°n√≠ paket≈Ø. PF je schopn√© kontrolovat pakety pohybuj√≠c√≠
se v <i>jak√©mkoliv</i> smƒõru proti z√°znam≈Øm ve stavov√© tabulce co≈æ znamen√°,
≈æe filtrovac√≠ pravidla, kter√° propu≈°t√≠ vracej√≠c√≠ se provoz nemus√≠ b√Ωt v≈Øbec
napsan√°. A d√≠ky tomu, ≈æe pakety odpov√≠daj√≠c√≠ nav√°zan√Ωm spojen√≠ neproch√°z√≠
vyhodnocen√≠m pomoc√≠ pravidel, tak ƒças, kter√Ω PF str√°v√≠ spr√°vou tƒõchto paket≈Ø
m≈Ø≈æe b√Ωt v√Ωraznƒõ sn√≠≈æen.

<p>
Kdy≈æ pravidlo vytv√°≈ô√≠ stav, tak prvn√≠ paket odpov√≠daj√≠c√≠ pravidlu vytv√°≈ô√≠
"stav" mezi odes√≠latelem a p≈ô√≠jemcem. Nyn√≠ nejen pakety odch√°zej√≠c√≠ od
odes√≠latele k p≈ô√≠jemci odpov√≠daj√≠ stavov√©mu z√°znamu a p≈ôeskakuj√≠ pr≈Øchod
pravidly, ale i pakety vracej√≠c√≠ se stejnou cestou se chovaj√≠ stejnƒõ.

<p>
V≈°echny <i>pass</i> pravidla automaticky vytv√°≈ô√≠ stavov√Ω z√°znam, kdy≈æ
paket odpov√≠d√° pravidlu.
Toto m≈Ø≈æe b√Ωt explicitnƒõ zru≈°eno pou≈æ√≠t√≠m <tt>no state</tt> volby.

<blockquote>
<tt>
pass out on fxp0 proto tcp from any to any
</tt>
</blockquote>

<p>
Toto pravidlo umo≈æ≈àuje jak√Ωkoliv odchoz√≠ TCP provoz na <tt>fxp0</tt>
rozhran√≠ a tak√© povoluje vracej√≠c√≠ se provoz k tomuto spojen√≠ skrze
firewall. Udr≈æov√°n√≠ informace o spojen√≠ v√Ωraznƒõ zlep≈°uje v√Ωkon va≈°eho
firewallu, proto≈æe vyhled√°v√°n√≠ stavu jsou dramaticky rychlej≈°√≠ v porovn√°n√≠
s pr≈Øchodem paketu filtrovac√≠mi pravidly.

<p>
Volba <tt>modulate state</tt> funguje stejnƒõ jako <tt>keep state</tt>
mimo to, ≈æe je funkƒçn√≠ pouze pro TCP pakety. S
<tt>modulate state</tt> je Initial Sequence Number (ISN) odchoz√≠ho
spojen√≠ randomizov√°no. Toto je u≈æiteƒçn√© pro ochranu spojen√≠ navazovan√Ωch
nƒõkter√Ωmi operaƒçn√≠mi syst√©my, kter√© odv√°d√≠ ≈°patnou pr√°ci p≈ôi v√Ωbƒõru ISN.
Pro umo≈ænƒõn√≠ lehƒç√≠ch pravidel m≈Ø≈æe b√Ωt volba <tt>modulate state</tt> 
pou≈æita v pravidlech, kter√° specifikuj√≠ protokol jin√Ω ne≈æ TCP; v tƒõchto
 p≈ô√≠padech je vyhodnocov√°na jako <tt>keep state</tt>. 

<p>
Udr≈æov√°n√≠ informace o spojen√≠ pro odchoz√≠ TCP, UDP a ICMP pakety a modulov√°n√≠
TCP ISN:
<blockquote>
<tt>
pass out on fxp0 proto { tcp, udp, icmp } from any \<br>
&nbsp;&nbsp;&nbsp;&nbsp;to any modulate state<br>
</tt>
</blockquote>

<p>
Dal≈°√≠ v√Ωhoda udr≈æov√°n√≠ informace o spojen√≠ je, ≈æe souvisej√≠c√≠ ICMP provoz
bude propu≈°tƒõn skrze firewall.

Nap≈ô√≠klad kdy≈æ TCP spojen√≠ proch√°z√≠ firewallem a je o nƒõm udr≈æov√°na informace
o spojen√≠ a z√°rove≈à p≈ôijde ICMP source-quench zpr√°va odkazuj√≠c√≠ na toto TCP
spojen√≠, tak bude p≈ôi≈ôazena odpov√≠daj√≠c√≠mu z√°znamu o stavu a propu≈°tƒõna skrze
firewall.

<p>
Rozsah stavov√©ho z√°znamu je glob√°lnƒõ kontrolov√°n pomoc√≠
<a href="options.html#state-policy"><tt>state-policy</tt></a>
volby za bƒõhu a v jednotliv√Ωch pravidlech pomoc√≠ <tt>if-bound</tt>
a <tt>floating</tt> kl√≠ƒçov√Ωch slov pro stavy.
Tyto kl√≠ƒçov√° slova pro jednotliv√° pravidla maj√≠ stejn√Ω v√Ωznam jako
kdy≈æ se pou≈æ√≠j√≠ s volbou <tt>state-policy</tt> . P≈ô√≠klad:

<blockquote>
<tt>
pass out on fxp0 proto { tcp, udp, icmp } from any \<br>
&nbsp;&nbsp;&nbsp;&nbsp;to any modulate state (if-bound)<br>
</tt>
</blockquote>

<p>
Toto pravidlo na≈ô√≠d√≠, ≈æe aby pakety souhlasili se stavov√Ωm z√°znamem, tak
mus√≠ proch√°zet p≈ôes <tt>fxp0</tt> rozhran√≠.


<a name="udpstate"></a>
<h2>Udr≈æov√°n√≠ informace o spojen√≠ pro UDP</h2>
Mo≈æn√° jste nƒõkdy sly≈°eli, jak se ≈ô√≠k√°, ≈æe "Nejde vytvo≈ôit informace o stavu
UDP, proto≈æe UDP je bezstavov√Ω protokol!". I kdy≈æ je pravda, ≈æe UDP 
komunikace nem√° ≈æ√°dn√Ω koncept stav≈Ø (explicitnƒõ definovan√Ω zaƒç√°tek a
konec komunikace), tak to nem√° ≈æ√°dn√Ω vliv na schopnost PF vytvo≈ôit informaci
o stavu pro UDP spojen√≠. V p≈ô√≠padƒõ protokol≈Ø bez "poƒç√°teƒçn√≠ch" a "koncov√Ωch"
paket≈Ø PF prostƒõ sleduje informaci o tom, kolik ƒçasu ubƒõhlo od okam≈æiku, kdy
odpov√≠daj√≠c√≠ paket proch√°zel. Pokud ƒças vypr≈°√≠(timeout), tak se informace o
stavu sma≈æe. ƒåasov√© hodnoty je mo≈æn√© nastavit v
<a href="options.html">options</a> sekci <tt>pf.conf</tt>
souboru.

<a name="stateopts"></a>
<h2>Volby pro sledov√°n√≠ stav≈Ø</h2>
Filtrovac√≠ pravidla, kter√° vytv√°≈ôej√≠ stavov√© z√°znamy mohou specifikovat
r≈Øzn√© volby pro kontrolu chov√°n√≠ v√Ωsledn√©ho stavov√©ho z√°znamu. N√°sleduj√≠c√≠
volby jsou dostupn√©:

<dl>
<dt><tt>max <i>number</i></tt>
<dd>Omezuje maxim√°ln√≠ ƒç√≠slo stavov√Ωch z√°znam≈Ø, kter√© pravidlo m≈Ø≈æe vytvo≈ôit
na <i>number</i>.
Pokud je maximum dosa≈æeno, tak pakety, kter√© by norm√°lnƒõ vytvo≈ôili stavov√Ω
z√°znam nebudou tomuto pravidlu vyhovovat, dokud se ƒç√≠slo existuj√≠ch stavov√Ωch
z√°znam≈Ø nesn√≠≈æ√≠ pod uveden√Ω limit.

<dt><tt>no state</tt>
<dd>Zabra≈àuje pravidlu automaticky vytv√°≈ôet stavov√Ω z√°znam.

<dt><tt>source-track</tt>
<dd>Tato volba umo≈æ≈àuje sledov√°n√≠ poƒçtu stavov√Ωch z√°znam≈Ø vytvo≈ôen√Ωch pro 
ka≈ædou zdrojovou IP adresu. 
Tato volba m√° dva form√°ty:
	<ul>
	<li><tt>source-track rule</tt> - Maxim√°ln√≠ poƒçet stav≈Ø vytvo≈ôen√Ωch
	pomoc√≠ tohoto pravidla je limitov√°n pomoc√≠ <tt>max-src-nodes</tt>
	a <tt>max-src-states</tt> voleb pravidla. Pouze stavy vytvo≈ôen√© 
	pomoc√≠ tohoto konkr√©tn√≠ho pravidla se p≈ôipoƒç√≠t√°vaj√≠ k limit≈Øm 
	pravidla.
	<li><tt>source-track global</tt> - Poƒçet stav≈Ø vytvo≈ôen√Ωch v≈°emi
	pravidly, kter√© pou≈æ√≠vaj√≠ tuto volbu je limitov√°n. Ka≈æd√© pravidlo
	m≈Ø≈æe specifikovat rozd√≠ln√© <tt>max-src-nodes</tt> a 
	<tt>max-src-states</tt> volby. Ov≈°em stavov√© z√°znamy vytvo≈ôen√©
	jak√Ωmkoliv dal≈°√≠m pravidlem se p≈ôipoƒç√≠t√°vaj√≠ k individu√°ln√≠m limit≈Øm
	pravidla.
	</ul>
Celkov√Ω poƒçet zdrojov√Ωch IP adres, kter√© mohou b√Ωt sledov√°ny glob√°lnƒõ m≈Ø≈æe
b√Ωt kontrolov√°n pomoc√≠
<a href="options.html#limit"><tt>src-nodes</tt> on-line volby</a>.

<dt><tt>max-src-nodes <i>number</i></tt>
<dd>Kdy≈æ se pou≈æije <tt>source-track</tt> volba, tak
<tt>max-src-nodes</tt> omez√≠ poƒçet zdrojov√Ωch IP adres, kter√© mohou souƒçasnƒõ
vytvo≈ôit stav. Tato volba m≈Ø≈æe b√Ωt pou≈æita pouze s 
<tt>source-track rule</tt>.

<dt><tt>max-src-states <i>number</i></tt>
<dd>Kdy≈æ se pou≈æije <tt>source-track</tt> volba, tak
<tt>max-src-states</tt> omez√≠ poƒçet simult√°nn√≠ch  stavov√Ωch z√°znam≈Ø, kter√©
mohou b√Ωt vytvo≈ôeny pro ka≈ædou IP adresu. Rozsah tohoto limitu 
(to znaƒç√≠, stavy vytvo≈ôen√© pouze t√≠mto pravidlem nebo stavy vytvo≈ôen√© 
v≈°emi pravidly, kter√© pou≈æ√≠vaj√≠ <tt>source-track</tt>) je z√°visl√Ω
na specifikaci <tt>source-track</tt> volby.
</dl>

<p>
Volby jsou specifikov√°ny uvnit≈ô z√°vorek a okam≈æitƒõ po jednom z kl√≠ƒçov√Ωch
slov pro stavy (<tt>keep state</tt>, <tt>modulate state</tt> nebo 
 <tt>synproxy state</tt>). V√≠cen√°sobn√© volby jsou oddƒõleny ƒç√°rkou.
V OpenBSD 4.1 a pozdƒõj≈°√≠ch se <tt>keep state</tt> volba stala implicitnƒõ
defaultn√≠ pro v≈°echna filtrovac√≠ pravidla.
Navzdory tomuto mus√≠ b√Ωt p≈ôi specifikaci voleb stav≈Ø jedno z kl√≠ƒçov√Ωch
slov pro stavy v≈ædy pou≈æito je≈°tƒõ p≈ôed tƒõmito volbami.


<p>
P≈ô√≠klad pravidla:

<blockquote>
<tt>
pass in on $ext_if proto tcp to $web_server \<br>
&nbsp;&nbsp;&nbsp;&nbsp;port www keep state \<br>
&nbsp;&nbsp;&nbsp;&nbsp;(max 200, source-track rule, max-src-nodes 100,
max-src-states 3)
</tt>
</blockquote>

<p>
Pravidlo uveden√© v√Ω≈°e definuje n√°sleduj√≠c√≠ chov√°n√≠:

<ul>
<li>Omezuje absolutn√≠ maxim√°lnƒõ mo≈æn√Ω poƒçet stav≈Ø, kter√© toto pravidlo m≈Ø≈æe
vytvo≈ôit na 200
<li>Povoluje source-track volbu; omezuje vytvo≈ôen√≠ stav≈Ø na stavy vytvo≈ôen√©
pouze pomoc√≠ tohoto pravidla
<li>Omezuje maxim√°ln√≠ mo≈æn√Ω poƒçet uzl≈Ø, kter√© mohou souƒçasnƒõ vytvo≈ôiv stav
na 100
<li>Omezuje maxim√°ln√≠ poƒçet simult√°nn√≠ch stav≈Ø pro zdrojovou IP na 3
</ul>

<p>
Samostatn√° sada omezen√≠ m≈Ø≈æe b√Ωt uplatnƒõna na stateful TCP spojen√≠, kter√°
dokonƒçila tzv. 3-cestn√Ω handshake.

<dl>
<dt><tt>max-src-conn <i>number</i></tt>
<dd>Omezuje maxim√°ln√≠ poƒçet simult√°nn√≠ch TCP spojen√≠, kter√© m≈Ø≈æe jednotliv√Ω
syst√©m vytvo≈ôit a kter√© dokonƒçili 3-cestn√Ω handshake.
<dt><tt>max-src-conn-rate <i>number</i> / <i>interval</i></tt>
<dd>Omezuje rychlost nov√Ωch spojen√≠ na urƒçit√Ω poƒçet za dann√Ω ƒçasov√Ω interval.
</dl>

<p>
Obƒõ tyto volby automaticky pou≈æ√≠vaj√≠ <tt>source-track rule</tt>
volbu a jsou nekompatibiln√≠ s <tt>source-track global</tt>.

<p>
Proto≈æe tyto limity jsou aplikov√°ny pouze proti TCP spojen√≠m, kter√©
dokonƒçili 3-cestn√Ω handshake, tak je mo≈æn√© pou≈æ√≠t mnohem agresivnƒõj≈°√≠ akce
proti "√∫toƒç√≠c√≠m" IP adres√°m.

<dl>
<dt><tt>overload &lt;<i>table</i>&gt;</tt>
<dd>Vlo≈æ√≠ "√∫toƒç√≠c√≠" IP adresu syst√©mu do pojmenovan√© tabulky.
<dt><tt>flush [global]</tt>
<dd>Zniƒç jak√©koliv dal≈°√≠ stavy, kter√© odpov√≠daj√≠ tomuto pravidlu a kter√©
byly vytvo≈ôeny touto zdrojovou IP adresou.
Kdy≈æ je <tt>global</tt> specifikov√°no, tak zniƒç v≈°echny stavy odpov√≠daj√≠c√≠ 
zdrojov√© IP adrese bez ohledu na to, kter√© pravidlo stav vytvo≈ôilo.
</dl>

<p>
P≈ô√≠klad:

<blockquote>
<tt>
table &lt;abusive_hosts&gt; persist<br>
block in quick from &lt;abusive_hosts&gt;<br>
<br>
pass in on $ext_if proto tcp to $web_server \<br>
&nbsp;&nbsp;&nbsp;&nbsp;port www flags S/SA keep state \<br>
&nbsp;&nbsp;&nbsp;&nbsp;(max-src-conn 100, max-src-conn-rate 15/5,
overload &lt;abusive_hosts&gt; flush)
</tt>
</blockquote>

<p>
Toto dƒõl√° n√°sleduj√≠c√≠:

<ul>
<li>Omezuje maxim√°ln√≠ poƒçet spojen√≠ ze zdroje na 100
<li>Limituje poƒçet spojen√≠ na 15 v rozsahu 5 sekund
<li>Vlo≈æ IP adresu jak√©hokoliv syst√©mu, kter√Ω poru≈°√≠ tyto pravidla do
<tt>&lt;abusive_hosts&gt;</tt> tabulky
<li>Pro jakoukoliv "√∫toƒç√≠c√≠" IP adresu zniƒç jak√©koliv stavy vytvo≈ôen√© t√≠mto
pravidlem.
</ul>

<a name="tcpflags"></a>
<h2>Volby TCP paketu</h2>
V√Ωbƒõr TCP paket≈Ø podle jejich voleb je nejƒçastƒõji pou≈æ√≠v√°no k filtrov√°n√≠
TCP paket≈Ø, kter√© se pokou≈°ej√≠ otev≈ô√≠t nov√© spojen√≠. TCP volby paketu a
jejich v√Ωznamy jsou vyps√°ny zde:
<ul>
<li><b>F</b> : FIN  - Finish; konec spojen√≠
<li><b>S</b> : SYN  - Synchronize; indikuje po≈æadavak na zaƒç√°tek spojen√≠
<li><b>R</b> : RST  - Reset; zahod√≠ spojen√≠
<li><b>P</b> : PUSH - Push; paket je posl√°n okam≈æitƒõ
<li><b>A</b> : ACK  - Acknowledgement; potvrzen√≠
<li><b>U</b> : URG  - Urgent; urgentn√≠
<li><b>E</b> : ECE  - Explicit Congestion Notification Echo
<li><b>W</b> : CWR  - Congestion Window Reduced
</ul>

<p>
Aby PF kontroloval TCP volby paketu bƒõhem vykon√°v√°n√≠ pravidla, tak se pou≈æ√≠v√°
kl√≠ƒçov√© slovo <tt>flags</tt> s n√°sleduj√≠c√≠ syntax√≠:
<blockquote>
<tt>
flags <i>check</i>/<i>mask</i><br>
flags any
</tt>
</blockquote>

<p>
ƒå√°st <tt><i>mask</i></tt> PF ≈ô√≠k√°, aby kontroloval pouze specifikovan√©
volby a ƒç√°st <tt><i>check</i></tt> specifikuje, kter√° volba(y) mus√≠ b√Ωt
"zapnuty" v z√°hlav√≠ aby nastala shoda.
Pou≈æit√≠ kl√≠ƒçov√©ho slova <tt>any</tt> umo≈æ≈àuje, aby jak√°koliv kombinace
voleb v z√°hlav√≠ odpov√≠dala.
<blockquote>
<tt>
pass in on fxp0 proto tcp from any to any port ssh flags S/SA<br>
pass in on fxp0 proto tcp from any to any port ssh
</tt>
</blockquote>

<p>
Proto≈æe <tt>flags S/SA</tt> je nastaveno defaultnƒõ, tak v√Ω≈°e uveden√°
pravidla jsou stejn√°; ka≈æd√© z tƒõchto pravidel propou≈°t√≠ TCP provoz
s volbou SYN nastavenou, p≈ôiƒçem≈æ se d√≠v√° pouze na SYN a ACK volby.
Paket s volbami SYN a ECE bude odpov√≠dat v√Ω≈°e uveden√Ωm pravidl≈Øm, ale paket
s SYN a ACK nebo pouze ACK u≈æ ne.

<p>
Defaultn√≠ volby mohou b√Ωt p≈ôeps√°ny pomoc√≠ volby <tt>flags</tt> jak je
zm√≠nƒõno v√Ω≈°e.

<p>
Je d≈Øle≈æit√© b√Ωt opatrn√Ω p≈ôi pou≈æ√≠t√≠ voleb -- rozumƒõjte tomu co dƒõl√°te a proƒç
a buƒète opatrn√≠ s doporuƒçen√≠mi od lid√≠, proto≈æe hodnƒõ z nich je ≈°patn√Ωch.
Nƒõkte≈ô√≠ lid√© doporuƒçovali vytvo≈ôit stav "jen pokud je SYN volba nastavena
a ≈æ√°dn√© jin√©". Takov√© pravidlo m≈Ø≈æe konƒçit nƒõjak takhle:
<pre>
     . . . flags S/FSRPAUEW  <i>bad idea!!</i>
</pre>

<p>
Teorie je vytvo≈ôit stav jen na zaƒç√°tku TCP spojen√≠ a spojen√≠ by mƒõlo zaƒç√≠nat
s SYN volbou a ≈æ√°dnou jinou. Probl√©m je, ≈æe nƒõkter√© syst√©my zaƒç√≠naj√≠ pou≈æ√≠vat
ECN volbu a tak jak√Ωkoliv syst√©m pou≈æ√≠vaj√≠c√≠ ECN, kter√Ω se pokus√≠ s v√°mi 
spojit bude t√≠mto pravidlem odm√≠tnut.
Mnohem lep≈°√≠ p≈ô√≠stup je nespecifikovat v≈Øbec ≈æ√°dn√© volby a nechat PF
aplikovat defaultn√≠ volby do va≈°ich pravidel.
Pokud opravdu sami pro sebe chcete volby specifikovat, tak n√°sleduj√≠c√≠
kombinace by mƒõla b√Ωt bezpeƒçn√°:
<blockquote>
<tt>
. . . flags S/SAFR
</tt>
</blockquote>

<p>
<!--XXX scrub changes may have invalidated this-->
I kdy≈æ je toto praktick√© a bezpeƒçn√©, tak je tak√© zbyteƒçn√© kontrolovat
FIN a RST volby pokud je provoz tak√© kontrolov√°n pomoc√≠ scrub.
Scrub proces zp≈Øsob√≠, ≈æe PF zahod√≠ jak√©koliv p≈ô√≠choz√≠ pakety s neleg√°ln√≠mi
kombinacemi TCP voleb (jako SYN a RST) a normalizuje potencion√°lnƒõ nejasn√©
kombinace (jako SYN a FIN).


<a name="synproxy"></a>
<h2>TCP SYN Proxy</h2>
<p>
Norm√°lnƒõ, kdy≈æ klient inicializuje TCP spojen√≠ k serveru, tak PF propust√≠
<a href="http://www.inetdaemon.com/tutorials/internet/tcp/3-way_handshake.shtml"
>handshake</a> pakety mezi dvƒõma body spojen√≠ tak jak p≈ôich√°zej√≠.
PF m√° ov≈°em schopnost aplikovat proxy na tyto handshake.
Kdy≈æ handshake proch√°z√≠ p≈ôes tuto proxy, tak PF samotn√© dokonƒç√≠ handshake
s klientem a pot√© vyvol√° handshake se serverem a a≈æ pot√© propust√≠ pakety
mezi klientem a serverem.
V p≈ô√≠padƒõ TCP SYN flood √∫toku √∫toƒçn√≠k nikdy nedokonƒç√≠ 3-cestn√Ω handshake,
tak≈æe pakety √∫toƒçn√≠ka nikdy nedojdou a≈æ na chr√°nƒõn√Ω server, ale legitimn√≠
klienti handshake dokonƒçit mohou a jsou propu≈°tƒõni d√°le.
Toto omezuje dopad podvr≈æen√Ωch TCP SYN floods na chr√°nƒõnou slu≈æbu, kter√©
jsou zpracov√°ny p≈ô√≠mo v PF.
Bƒõ≈æn√© pou≈æ√≠v√°n√≠ t√©to volby nen√≠ doporuƒçeno, proto≈æe naru≈°uje oƒçek√°van√©
chov√°n√≠ TCP protokolu v p≈ô√≠padƒõ, kdy server nem≈Ø≈æe zpracovat dotaz a v 
p≈ô√≠padech kdy je pou≈æit load balancer.

<p>
TCP SYN proxy se povoluje pomoc√≠ kl√≠ƒçov√©ho slova <tt>synproxy state</tt>
 ve filtrovac√≠ch pravidlech. P≈ô√≠klad:

<blockquote>
<tt>
pass in on $ext_if proto tcp to $web_server port www synproxy state
</tt>
</blockquote>

<p>
V tomto p≈ô√≠padƒõ budou spojen√≠ k web serveru proch√°zet p≈ôes TCP proxy v PF.

<p>
D√≠ky tomu jak <tt>synproxy state</tt> funguje, tak tak√© obsahuje stejnou
funkcionalitu jako <tt>keep state</tt> a <tt>modulate state</tt>.

<p>
SYN proxy nebude fungovat pokud PF bƒõ≈æ√≠ na  
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=bridge&amp;sektion=4"
>bridge(4)</a>.

<a name="antispoof"></a>
<h2>Blokov√°n√≠ podvr≈æen√Ωch paket≈Ø</h2>
Podvr≈æen√≠ adresy ("spoofing") je, kdy≈æ zlomysln√Ω u≈æivatel podvrhne zdrojovou
IP adresu v paketech, kter√© p≈ôen√°≈°√≠ buƒè kv≈Øli tomu, aby skryl svou re√°lnou
adresu nebo aby se vyd√°val za jin√Ω syst√©m na s√≠ti. Jakmile u≈æivatel podvrhne
svou adresu, tak m≈Ø≈æe zaƒç√≠t s√≠≈•ov√Ω √∫tok ani≈æ by odhalil prav√Ω zdroj √∫toku
nebo z√≠skat p≈ô√≠stup k s√≠≈•ov√Ωm slu≈æb√°m, kter√© jsou jinak vyhrazen√© pro
urƒçit√© IP adresy.

<p>
PF nab√≠z√≠ urƒçitou ochranu proti podvr≈æen√Ωm adres√°m pomoc√≠ kl√≠ƒçov√©ho slova
<tt>antispoof</tt> :

<blockquote>
<tt>
antispoof [log] [quick] for <i>interface</i> [<i>af</i>]
</tt>
</blockquote>

<dl>
<dt><tt>log</tt>
<dd>Urƒçuje, ≈æe odpov√≠daj√≠c√≠ pakety budou zaznamen√°ny pomoc√≠
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+5.3"
>pflogd(8)</a>.

<dt><tt>quick</tt>
<dd>Pokud paket odpov√≠d√° tomuto pravidlu, tak pravidlo bude pova≈æov√°no
 za "v√≠tƒõze" a vyhodnocov√°n√≠ pravidel se zde ukonƒç√≠.

<dt><tt><i>interface</i></tt>
<dd>S√≠≈•ov√© rozhran√≠ na kter√©m se m√° tato ochrana aktivovat. M≈Ø≈æe to tak√©
b√Ωt <a href="macros.html#lists">seznam</a> rozhran√≠.

<dt><tt><i>af</i></tt>
<dd>Rodina adres pro kterou se m√° tato ochrana aktivovat. Buƒè
<tt>inet</tt> pro IPv4 nebo <tt>inet6</tt> pro IPv6.
</dl>

<p>
P≈ô√≠klad:
<blockquote>
<tt>
antispoof for fxp0 inet
</tt>
</blockquote>

<p>
Kdy≈æ se pravidla nahr√°vaj√≠, tak jak√Ωkoliv v√Ωskyt kl√≠ƒçov√©ho slova
<tt>antispoof</tt> je roz≈°√≠≈ôen do dvou filtrovac√≠ch pravidel. Pokud m√°
nap≈ô√≠klad rozhran√≠ <tt>fxp0</tt> IP adresu 10.0.0.1 a s√≠≈•ovou masku 
 255.255.255.0 (tzn., /24), tak <tt>antispoof</tt> pravidlo se roz≈°√≠≈ô√≠ do:

<blockquote>
<tt>
block in on ! fxp0 inet from 10.0.0.0/24 to any<br>
block in inet from 10.0.0.1 to any
</tt>
</blockquote>

<p>
Tyto pravidla spl≈àuj√≠ dvƒõ vƒõci:
<ul>
<li>Blokuj√≠ v≈°echen provoz p≈ôich√°zej√≠c√≠ z 10.0.0.0/24 s√≠tƒõ, kter√Ω 
<i>nep≈ôi≈°el</i> p≈ôes <tt>fxp0</tt>. Proto≈æe 10.0.0.0/24 s√≠≈• je na
<tt>fxp0</tt> rozhran√≠, tak pakety se zdrojovou adresou v tomto s√≠≈•ov√©m
bloku se nikdy nemaj√≠ objevit jako p≈ôich√°zej√≠c√≠ na jak√©mkoliv jin√©m rozhran√≠.
<li>Blokuj√≠ v≈°echen p≈ô√≠choz√≠ provoz z 10.0.0.1, co≈æ je IP adresa, kter√° je 
na <tt>fxp0</tt>. Syst√©m by nikdy nemƒõl pos√≠lat pakety s√°m sobƒõ p≈ôes extern√≠
rozhran√≠. Tak≈æe jak√©koliv pakety p≈ô√≠ch√°zej√≠c√≠ se zdrojovou adresou n√°le≈æej√≠c√≠
samotn√©mu syst√©mu mohou b√Ωt pova≈æov√°ny za podez≈ôel√©.
</ul>

<p>
<b>POZN√ÅMKA</b>: Filtrovac√≠ pravidla, do kter√Ωch se <tt>antispoof</tt> 
pravidlo tak√© roz≈°√≠≈ôi, blokuj√≠ i pakety pos√≠lan√© p≈ôes lok√°ln√≠ rozhran√≠
na lok√°ln√≠ adresy. Je proto dobrou prax√≠ vynechat filtrov√°n√≠ na lok√°ln√≠ch
rozhran√≠ch. Co≈æ je dobr√© i tak, ale st√°v√° se to nutnost√≠ p≈ôi pou≈æ√≠t√≠
antispoof pravidel:
<blockquote>
<tt>
set skip on lo0<br>
<br>
antispoof for fxp0 inet
</tt>
</blockquote>

<p>
Pou≈æit√≠ <tt>antispoof</tt> by mƒõlo b√Ωt omezeno na rozhran√≠, kter√° maj√≠
p≈ôi≈ôazenu IP adresu. Pou≈æit√≠ <tt>antispoof</tt> na rozhran√≠ bez IP adresy
skonƒç√≠ filtrovac√≠m pravidlem, kter√© vypad√° nƒõjak takto:
<blockquote>
<tt>
block drop in on ! fxp0 inet all<br>
block drop in inet all
</tt>
</blockquote>

<p>
S tƒõmito pravidly je zde riziko, ≈æe bude blokov√°n <i>v≈°echen</i> p≈ô√≠choz√≠
provoz na <i>v≈°ech</i> rozhran√≠ch.

<a name="urpf"></a>
<h2>Unicast Reverse Path Forwarding</h2>

<p>
PF nab√≠z√≠ vlastnost - Unicast Reverse Path Forwarding (uRPF).
Kdy≈æ paket proch√°z√≠ uRPF kontrolou, tak zdrojov√° IP adresa paketu projde
kontrolou v smƒõrovac√≠ tabulce. Pokud odchoz√≠ rozhran√≠ nalezen√© v z√°znamu
smƒõrovac√≠ tabulky je stejn√© jako rozhran√≠ p≈ôes kter√© paket p≈ôi≈°el, tak
uRPF kontrola probƒõhne v po≈ô√°dku. Pokud ale rozhran√≠ nejsou stejn√°, tak
je mo≈æn√©, ≈æe paket m√° svoji zdrojovou adresu podvr≈æenu.

<p>
Kontrola uRPF m≈Ø≈æe b√Ωt na paketech vykon√°na pomoc√≠ kl√≠ƒçov√©ho slova
<tt>urpf-failed</tt> ve filtrovac√≠ch pravidlech:

<blockquote>
<tt>
block in quick from urpf-failed label uRPF
</tt>
</blockquote>

<p>
Uvƒõdomte si, ≈æe uRPF kontrola m√° smysl pouze v prost≈ôed√≠, kde se pou≈æ√≠v√°
symetrick√© smƒõrov√°n√≠.

<p>
uRPF poskytuje stejnou funkcionalitu jako
<a href="#antispoof">antispoof</a> pravidla.


<a name="osfp"></a>
<h2>Pasivn√≠ detekce operaƒçn√≠ch syst√©m≈Ø</h2>

<p>
Pasivn√≠ detekce operaƒçn√≠ch syst√©m≈Ø - Passive OS Fingerprinting (OSFP) 
je metoda pro pasivn√≠ detekci operaƒçn√≠ho syst√©mu vzd√°len√©ho syst√©mu 
(poƒç√≠taƒçe, serveru,...), kter√° je zalo≈æena na urƒçit√Ωch charakteristik√°ch,
kter√© tento syst√©m prom√≠tne do TCP SYN paket≈Ø. Tato informace pak m≈Ø≈æe b√Ωt
pou≈æita jako krit√©rium ve filtrovac√≠ch pravidlech.

<p>
PF urƒçuje vzd√°len√Ω operaƒçn√≠ syst√©m porovn√°n√≠m charakteristik TCP SYN paketu
proti 
<a href="options.html#fingerprints">souboru otisk≈Ø</a>, kter√Ωm je
defaultnƒõ 
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.os&amp;sektion=5&amp;manpath=OpenBSD+5.3"
><tt>/etc/pf.os</tt></a>. 
Jakmile je PF povolen, tak aktu√°ln√≠ seznam otisk≈Ø m≈Ø≈æe b√Ωt zobrazen
pomoc√≠ tohoto p≈ô√≠kazu:

<blockquote>
<tt>
# pfctl -s osfp
</tt>
</blockquote>

<p>
V r√°mci filtrovac√≠ho pravidla m≈Ø≈æe b√Ωt otisk specifikov√°n pomoc√≠ t≈ô√≠dy OS,
verze nebo subtypu/patch verze. Ka≈æd√° z tƒõchto polo≈æek je vyps√°na ve v√Ωstupu
p≈ô√≠kazu <tt>pfctl</tt> pou≈æit√©ho v√Ω≈°e. Ke specifikov√°ni otisku ve filtrovac√≠m
pravidle je t≈ôeba pou≈æ√≠t kliƒçov√© slovo <tt>os</tt> :

<blockquote>
<tt>
pass &nbsp;in on $ext_if proto tcp from any os OpenBSD keep state<br>
block in on $ext_if proto tcp from any os "Windows 2000"<br>
block in on $ext_if proto tcp from any os "Linux 2.4 ts"<br>
block in on $ext_if proto tcp from any os unknown
</tt>
</blockquote>

<p>
Speci√°ln√≠ t≈ô√≠da operaƒçn√≠ho syst√©mu <tt>unknown</tt> umo≈æ≈àuje nastavit shodu
u paket≈Ø, kde otisk OS nen√≠ zn√°m.
<p>
<font color="#ff0000">NEZAPOME≈áTE</font> na n√°sleduj√≠c√≠:
<ul>
  <li>Otisky operaƒçn√≠ch syst√©m≈Ø jsou obƒças ≈°patnƒõ kv≈Øli podvr≈æen√Ωm a/nebo
  upraven√Ωm paket≈Øm, kter√© jsou vytvo≈ôeny tak, aby vypadali jako kdyby
  poch√°zeli ze specifick√©ho operaƒçn√≠ho syst√©mu.
  <li>Nƒõkter√© revize aktualizac√≠ operaƒçn√≠ho syst√©mu mohou zmƒõnit chov√°n√≠
  s√≠≈•ov√© vrstvy a zp≈Øsobit, ≈æe otisk neodpov√≠d√° tomu co je v souboru otisk≈Ø
  nebo odpov√≠dat jin√©mu z√°znamu a to i oboje z√°rove≈à.
  <li>OSFP funguje pouze s TCP SYN paketem; nebude fungovat s jin√Ωm 
  protokolem nebo na ji≈æ existuj√≠c√≠m nav√°zan√©m spojen√≠.
</ul>

<a name="ipopts"></a>
<h2>Volby protokolu IP</h2>
Defaultnƒõ PF blokuje pakety s pou≈æit√Ωmi volbami IP. Tohle m≈Ø≈æe zt√≠≈æit pr√°ci
pro "OS detekƒçn√≠" utility jako nmap. Pokud m√°te aplikaci, kter√° vy≈æaduje
propu≈°tƒõn√≠ tƒõchto paket≈Ø, jako nap≈ô√≠klad multicast nebo IGMP, tak m≈Ø≈æete
pou≈æ√≠t <tt>allow-opts</tt> direktivu:
<blockquote>
<tt>
pass in quick on fxp0 all allow-opts
</tt>
</blockquote>

<a name="example"></a>
<h2>P≈ô√≠klad filtrovac√≠ch pravidel</h2>
N√≠≈æe je p≈ô√≠klad filtrovac√≠ch pravidel. Stroj na kter√©m bƒõ≈æ√≠ PF vystupuje
jako firewall mezi malou intern√≠ s√≠t√≠ a Internetem. Uk√°z√°ny jsou pouze
filtrovac√≠ pravidla; 
<a href="../queueing.html"><tt>queueing</tt></a>, 
<a href="../nat.html"><tt>nat</tt></a>, 
<a href="../rdr.html"><tt>rdr</tt></a>, 
atp., byla v tomto p≈ô√≠kladu vynech√°na.
<br>
<br>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
ext_if  = "fxp0"
int_if  = "dc0"
lan_net = "192.168.0.0/24"

# table containing all IP addresses assigned to the firewall
table &lt;firewall&gt; const { self }

# don't filter on the loopback interface
set skip on lo0

# scrub incoming packets
match in all scrub (no-df)

# setup a default deny policy
block all

# activate spoofing protection for all interfaces
block in quick from urpf-failed

# only allow ssh connections from the local network if it's from the
# trusted computer, 192.168.0.15. use "block return" so that a TCP RST is
# sent to close blocked connections right away. use "quick" so that this
# rule is not overridden by the "pass" rules below.
block return in quick on $int_if proto tcp from ! 192.168.0.15 \
   to $int_if port ssh

# pass all traffic to and from the local network.
# these rules will create state entries due to the default
# "keep state" option which will automatically be applied.
pass in  on $int_if from $lan_net
pass out on $int_if to $lan_net

# pass tcp, udp, and icmp out on the external (Internet) interface. 
# tcp connections will be modulated, udp/icmp will be tracked
# statefully.
pass out on $ext_if proto { tcp udp icmp } all modulate state

# allow ssh connections in on the external interface as long as they're
# NOT destined for the firewall (i.e., they're destined for a machine on
# the local network). log the initial packet so that we can later tell
# who is trying to connect. 
# Uncomment last part to use the tcp syn proxy to proxy the connection.
pass in log on $ext_if proto tcp to ! &lt;firewall&gt; \
   port ssh # synproxy state
</pre>
</td></tr>
</table>

<p>
[<a href="tables.html">P≈ôedchoz√≠: Tabulky</a>]
[<a href="index.html">Obsah</a>]
[<a href="../nat.html">Dal≈°√≠: Network Address Translation</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@@openbsd.org">www@@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: filter.html,v 1.67 ]<br>
$Translation: filter.html,v 1.16 2013/06/05 09:28:16 bodie Exp $<br>
-->
$OpenBSD: filter.html,v 1.16 2013/06/05 12:30:47 ajacoutot Exp $
</small>
</small>

</body>
</html> 
@


1.16
log
@Sync with Steelix CVS
@
text
@d1017 1
a1017 1
$OpenBSD$
@


1.15
log
@Sync with Steelix CVS
@
text
@d71 1
a71 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+5.2"
d126 1
a126 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+5.2"
d761 1
a761 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+5.2"
d886 1
a886 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.os&amp;sektion=5&amp;manpath=OpenBSD+5.2"
d1014 2
a1015 2
Originally [OpenBSD: filter.html,v 1.66 ]<br>
$Translation: filter.html,v 1.15 2012/11/07 13:31:10 bodie Exp $<br>
@


1.14
log
@Sync with Steelix CVS
@
text
@d116 1
a116 1
<a href="../options.html#block-policy"><tt>block-policy</tt></a> volby. 
d438 1
a438 1
<a href="../options.html#state-policy"><tt>state-policy</tt></a>
d466 1
a466 1
<a href="../options.html">options</a> sekci <tt>pf.conf</tt>
d505 1
a505 1
<a href="../options.html#limit"><tt>src-nodes</tt> on-line volby</a>.
d883 1
a883 1
<a href="../options.html#fingerprints">souboru otisk≈Ø</a>, kter√Ωm je
d1015 1
a1015 1
$Translation: filter.html,v 1.14 2012/11/03 08:56:05 bodie Exp $<br>
@


1.13
log
@Sync with Steelix CVS
@
text
@d71 1
a71 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+5.1"
d126 1
a126 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+5.1"
d761 1
a761 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+5.1"
d886 1
a886 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.os&amp;sektion=5&amp;manpath=OpenBSD+5.1"
d1014 2
a1015 2
Originally [OpenBSD: filter.html,v 1.65 ]<br>
$Translation: filter.html,v 1.13 2012/10/15 05:55:45 bodie Exp $<br>
@


1.12
log
@Sync with Steelix CVS
@
text
@d708 8
a715 5
V√Ωhoda tohoto procesu je, ≈æe ≈æ√°dn√© pakety nejsou posl√°ny serveru dokud
klient nedokonƒç√≠ handshake.
To elimuje nebezpeƒç√≠ n√°valu podvr≈æen√Ωch TCP SYN spojen√≠ , kter√© by
 ovliv≈àovali server, proto≈æe podvr≈æen√© klientsk√© spojen√≠ nebude 
schopn√© dokonƒçit handshake.
d945 1
a945 1
<a href="../queueing.html">queueing</a>, 
d994 2
a995 3
# who is trying to connect. use the tcp syn proxy to proxy the connection.
# the default flags "S/SA" will automatically be applied to the rule by
# PF.
d997 1
a997 1
   port ssh synproxy state
d1014 2
a1015 2
Originally [OpenBSD: filter.html,v 1.62 ]<br>
$Translation: filter.html,v 1.12 2012/05/24 08:06:37 bodie Exp $<br>
@


1.11
log
@Sync with Steelix CVS
@
text
@d71 1
a71 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+5.0"
d126 1
a126 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+5.0"
d758 1
a758 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+5.0"
d883 1
a883 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.os&amp;sektion=5&amp;manpath=OpenBSD+5.0"
d1012 2
a1013 2
Originally [OpenBSD: filter.html,v 1.61 ]<br>
$Translation: filter.html,v 1.11 2012/04/01 15:14:49 bodie Exp $<br>
@


1.10
log
@Sync with Steelix CVS
@
text
@d902 4
a905 4
pass &nbsp;in on $ext_if from any os OpenBSD keep state<br>
block in on $ext_if from any os "Windows 2000"<br>
block in on $ext_if from any os "Linux 2.4 ts"<br>
block in on $ext_if from any os unknown
d1012 2
a1013 2
Originally [OpenBSD: filter.html,v 1.60 ]<br>
$Translation: filter.html,v 1.10 2011/11/19 19:25:07 bodie Exp $<br>
@


1.9
log
@Sync with Steelix CVS
@
text
@d71 1
a71 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+4.9"
d126 1
a126 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+4.9"
d758 1
a758 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+4.9"
d883 1
a883 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.os&amp;sektion=5&amp;manpath=OpenBSD+4.9"
d1012 2
a1013 2
Originally [OpenBSD: filter.html,v 1.59 ]<br>
$Translation: filter.html,v 1.9 2011/08/20 12:53:57 bodie Exp $<br>
@


1.8
log
@Sync with Steelix CVS
@
text
@d1012 2
a1013 2
Originally [OpenBSD: filter.html,v 1.58 ]<br>
$Translation: filter.html,v 1.8 2011/05/04 12:31:16 bodie Exp $<br>
@


1.7
log
@Sync with Steelix CVS
@
text
@d71 1
a71 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+4.8"
d126 1
a126 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+4.8"
d758 1
a758 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+4.8"
d883 1
a883 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.os&amp;sektion=5&amp;manpath=OpenBSD+4.8"
d1012 2
a1013 2
Originally [OpenBSD: filter.html,v 1.57 ]<br>
$Translation: filter.html,v 1.7 2011/03/31 14:21:38 bodie Exp $<br>
@


1.6
log
@Sync with Steelix CVS
@
text
@d176 1
a176 1
<li><a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a> 
d649 1
a649 1
pass in on fxp0 proto tcp from any to any port ssh flags S/SA
d1012 2
a1013 2
Originally [OpenBSD: filter.html,v 1.55 ]<br>
$Translation: filter.html,v 1.6 2010/11/04 15:26:12 bodie Exp $<br>
@


1.5
log
@Sync with Steelix CVS
@
text
@d71 1
a71 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+4.7"
d126 1
a126 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+4.7"
d758 1
a758 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+4.7"
d883 1
a883 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.os&amp;sektion=5&amp;manpath=OpenBSD+4.7"
d1012 2
a1013 2
Originally [OpenBSD: filter.html,v 1.54 ]<br>
$Translation: filter.html,v 1.5 2010/06/13 15:58:10 bodie Exp $<br>
@


1.4
log
@Noone feels responsible for these files (or are not supposed to feel
responsible) anymore.

They are still in Steelix repository, but as long as they are not linked
in and out of date, remove them.

Discussed with saad@@ and wvdputte@@.
@
text
@d4 1
a4 1
<title>PF: Filtrov·nÌ paket˘</title>
d6 1
a6 1
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
a10 1
<meta name="copyright"     content="This document copyright 2002-2003 by OpenBSD.">
d13 17
d34 3
a36 1
<img alt="[OpenBSD]" height=30 width=141 src="../../images/smalltitle.gif">
d38 1
a38 1
[<a href="rdr.html">P¯edchozÌ: P¯esmÏrov·nÌ trafficu</a>]
d40 1
a40 1
[<a href="logging.html">D·le: Logov·nÌ</a>]
d42 1
a42 1
<h1><font color="#e00000">PF: Filtrov·nÌ paket˘</font></h1>
d48 15
a62 11
<li><a href="#intro">⁄vod</a>
<li><a href="#syntax">Sytax pravidel</a>
<li><a href="#defdeny">Default Deny</a>
<li><a href="#pass">Passing Traffic</a>
<li><a href="#state">Udræov·nÌ stavu</a>
<li><a href="#udpstate">Udræov·nÌ stavu pro UDP</a>
<li><a href="#tcpflags">TCP Flagy</a>
<li><a href="#quick">KlÌËovÈ slovo <tt>quick</tt></a>
<li><a href="#antispoof">Blokov·nÌ spoofnut˝ch paket˘</a>
<li><a href="#ipopts">IP Options</a>
<li><a href="#example">P¯Ìklad mnoæiny pravidel pro filtrov·nÌ</a>
d68 6
a73 6
<h2>⁄vod</h2>
Filtrov·nÌ paket˘ je selektivnÌ pr˘chod nebo blokov·nÌ datov˝ch paket˘ tÌm
jak proch·zejÌ sÌªov˝m interfacem. Kriteria, kter·
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>pf(4)</a> pouæÌv· kdyæ prov·dÌ inspekci paket˘ jsou zaloæenna na Layer 3 
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ip&amp;sektion=4&amp;manpath=OpenBSD+3.3"
d75 3
a77 3
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ip6&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>IPv6</a>) a Layer 4
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcp&amp;sektion=4&amp;manpath=OpenBSD+3.3"
d79 1
a79 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=udp&amp;sektion=4&amp;manpath=OpenBSD+3.3"
d81 16
a96 18
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=icmp&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>ICMP</a>, a
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=icmp6&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>ICMPv6</a>) hlaviËk·ch. NejËastÏji pouæÌvan· kriteria jsou zdrojov· a
cÌlov· adresa, zdrojov˝ a cÌlov˝ port a protokol.

<p>
FiltrovacÌ pravidla specifikujÌ kriteria, kter· musÌ paket splÚovat a
akci, buÔ povolit nebo zak·zat, kter· je provedena, pokud je pravidlo
splnÏno. FiltrovacÌ pravidla jsou vyhodnocov·na v sekvenËnÌm po¯adÌ, od
prvnÌho do poslednÌho. Dokud nenÌ nalezeno pravidlo obsahujÌcÌ klÌËovÈ
slovo <tt>quick</tt>, paket bude vyhodnocov·n oproti <i>vπem</i>
filtrovacÌm pravidl˘m p¯edtÌm neæ bude provedena koneËn· akce. PoslednÌ
pravidlo, kterÈ vyhovuje, "vyhr·v·" a bude diktovat jak· akce se s paketem
provede. Na konci mnoæiny filtrovacÌch pravidel je implicitnÌ <tt>pass
all</tt>, coæ znamen·, æe pokud paket nebude splÚovat æ·dnÈ pravidlo,
v˝sledn· akce bude <tt>pass</tt>. 

d99 2
a100 2
<h2>Syntax pravidel</h2>
Obecn·, <i>velmi zjednoduπen·</i> syntax pro filtrovacÌ pravidla je:
d103 5
a107 5
<i>action</i> <i>direction</i> [log] [quick] on <i>int</i> [<i>af</i>] 
[proto <i>protocol</i>] \<br>
&nbsp;&nbsp;&nbsp;from <i>src_addr</i> [port <i>src_port</i>] to 
<i>dst_addr</i> [port <i>dst_port</i>] \<br>
&nbsp;&nbsp;&nbsp;[<i>tcp_flags</i>] [<i>state</i>]
d113 5
a117 7
<dd>Akce, kter· bude provedena na pakety splÚujÌcÌ pravidlo,
buÔ <tt>pass</tt> nebo
<tt>block</tt>. Akce <tt>pass</tt> nech· projÌt paket zp·tky do kernelu
pro dalπÌ zpracov·nÌ, zatÌmco akce <tt>block</tt> bude reagovat v
z·vislosti na volbÏ
<a href="options.html#block-policy"><tt>block-policy</tt></a>. 
DefaultnÌ rekace m˘æe b˝t p¯eps·na buÔ specifikov·nÌm 
d121 1
a121 1
<dd>SmÏr paketu jak˝m jde na interface, buÔ 
d125 5
a129 7
<dd>Specifikuje æe by paket mÏl b˝t zalogov·n via
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>pflogd(8)</a>. Pokud pravidlo specifikuje volbu <tt>keep state</tt> nebo
<tt>modulate state</tt> pak pouze pokud paket nastavÌ stav, je stav
zalogov·n. K logov·nÌ vπech paket˘, nehledÏ na to jestli nastavÌ stav nebo
ne, pouæijte
<tt>log-all</tt>.
d132 3
a134 3
<dd>Pokud pakket matchuje pravidlo obsahujÌcÌ <tt>quick</tt> pak 
je toto pravidlo povaæov·no za poslednÌ splÚujÌcÌ a je provedena akce
specifikovan· v tomto pravidle.
d136 15
a150 2
<dt><tt><i>int</i></tt>
<dd>JmÈno sÌªovÈho interface, kter˝m proch·zÌ paket.
d153 3
a155 3
<dd>Address family paketu, buÔ <tt>inet</tt> pro IPv4 nebo
<tt>inet6</tt> pro IPv6. PF je obvykle schopen zjistit tento parametr
v z·vislosti na zdrojovÈ a cÌlovÈ adrese (adres·ch).
d158 1
a158 1
<dd>Layer 4 protokol:
d164 2
a165 2
<li>PlatnÈ jmÈno protokolu z
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=protocols&amp;sektion=5&amp;manpath=OpenBSD+3.3"
d167 2
a168 2
<li>»Ìslo protokolu mezi 0 a 255
<li>Mnoæina protokol˘ pouæitÌm <a href="macros.html#lists">list</a>.
d172 1
a172 1
<dd>Zdrojov·/cÌlov· adresa v IP hlaviËce. Adresy mohou b˝t specifkov·ny
d175 43
a217 26
<li>Jedna IPv4 nebo IPv6 adresa.
<li>SÌªov˝ blok v <a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a> 
form·tu.
<li>PlnÏ kvalifikovanÈ domÈnovÈ jmÈno kterÈ se resolvÌ via DNS ve chvÌli,,
kdy je mnoæina pravidel nahr·na. Vπechny v˝slednÈ IP adresy budou
substituov·ny do tohoto pravidla.
<li>JmÈno sÌªovÈho interface. Vπechny IP adresy p¯i¯azenÈ tomuto sÌªovÈmu
interface budou substituovanÈ do tohoto pravidla.
<li>JmÈno sÌªovÈho inteface n·sledovanÈho 
<tt>/<i>netmask</tt></i> (nap¯., <tt>/24</tt>). Kaæd· IP adresa na tomto
za¯ÌzenÌ kombinovan· s maskou vytvo¯Ì CIDR sÌªov˝ blok, kter˝ jje
substituov·n do tohoto pravidla.
<li>JmÈno sÌªovÈho interface v z·vork·ch <tt>( )</tt>. Toto
¯ekne PF aby obnovil pravidlo pokud se IP adresa (adresy) na takto
pojmenovanÈm interface zmÏnÌ. Toto je uæiteËnÈ na interface, kterÈ dostane
svoji IP adresu via DHCP nebo dial-up, protoæe mnoæina pravidel nemusÌ b˝t
znovu nahr·na pokaædÈ, kdyæ se adresa zmÏnÌ.
<li>JmÈno sÌªovÈho interface n·sledovanÈ klÌËov˝m slovem <tt>:network</tt> nebo
<tt>:broadcast</tt>. V˝sledn· CIDR sÌª (nap¯.,
192.168.0.0/24) nebo broadcast adresa (nap¯., 192.168.0.255) bude 
substituov·na do pravidla kdyæ je mnoæina pravidel nahr·na.
<li><a href="tables.html">table</a>.
<li>Cokoliv z v˝πe uvedenÈho, ale negov·no pomocÌ modifiktoru <tt>!</tt> ("not").
<li>Mnoæina adres pouæitÌm <a href="macros.html#lists">list</a>.
<li>KlÌËovÈ slovo <tt>any</tt> p¯edstavujÌcÌ vπechny adresy
<li>KlÌËovÈ slovo <tt>all</tt> coæ je zkratka za <tt>from any to
d222 2
a223 2
<dd>Zdrojov˝/cÌlov˝ port v Layer 4 hlaviËce paketu. Porty mohou b˝t
specifikov·ny jako:
d225 3
a227 3
<li>»Ìslo mezi 1 a 65535
<li>Platn· jmÈno sluæby z
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=services&amp;sektion=5&amp;manpath=OpenBSD+3.3"
d229 2
a230 2
<li>Mnoæina port˘ pouæitÌm <a href="macros.html#lists">list</a>
<li>RozmezÌ:
d232 12
a243 8
	<li><tt>!=</tt> (nerovnost)
	<li><tt>&lt;</tt> (ost¯e menπÌ neæ)
	<li><tt>&gt;</tt> (ost¯e vÏtπÌ neæ)
	<li><tt>&lt;=</tt> (menπÌ nebo rovno)
	<li><tt>&gt;=</tt> (vÏtπÌ nebo rovno)
	<li><tt>&gt;&lt;</tt> (rozmezÌ)
	<li><tt>&lt;&gt;</tt> (inverznÌ rozmezÌ)
	</ul>
d245 1
a245 2
	<dd>PoslednÌ dva jsou bin·rnÌ oper·tory (berou dva argumenty) a
	nezahrnujÌ argumenty v rozmezÌ.
d247 1
d251 7
a257 5
<dd>Specifikuje flagy, kterÈ musÌ b˝t nastaveny v TCP hlaviËce p¯i pouæitÌ
<tt>proto tcp</tt>. Flagy jsou specifikov·ny jako
<tt>flags <i>check</i>/<i>mask</i></tt>. Nap¯. : <tt>flags
S/SA</tt> - to ¯ekne PF aby se dÌval pouze na flagy S a A (SYN a ACK)
a matchoval pokud je "nahozen" SYN flag.
d260 2
a261 2
<dd>Specifikuje zda je udræov·na informace o stavu paket˘ splÚujÌcÌch toto
pravidlo.
d263 11
a273 3
<li><tt>keep state</tt> - pracuje s TCP, UDP, a ICMP.
<li><tt>modulate state</tt> - pracuje pouze s TCP. PF bude generovat 
siln· Initial Sequence Numbers (ISNs) pro paketu splÚujÌcÌ toto pravidlo.
d278 5
a282 6
<h2>Default Deny</h2>
DoporuËen· praxe pro nastavenÌ firewallu je 
"default deny". To znamen·, zak·zat <i>vπechno</i> a pak selektivnÏ
povolit urËit˝ traffic skrz firewall. Tento p¯Ìstup je doporuËen˝, protoæe
zmenπuje pravdÏpodobnost chyby v mnoæinÏ pravidel a takÈ dÏl· mnoæinu
pravidel p¯ehlednÏjπÌ.
d285 2
a286 2
Pro vytvo¯enÌ filtrovacÌ politiky default deny, prvnÌ dvÏ pravidla by
mÏla b˝t
d295 2
a296 1
To bude blokovat vπechen traffic na vπech interfacech v obou smÏrech.
d299 16
a314 15
<h2>Passing Traffic</h2>
Traffic musÌ b˝t explicitnÏ povolen skrz firewall nebo bude zahozen
default deny politikou. Toto je chvÌle, kdy se ke slovu dost·vajÌ 
zdrojov˝/cÌlov˝ port, zdrojov·/cÌlov· adresa, a protokol.
Kdykoliv je traffic povolen skrz firewall nÏjak˝m pravidlem, toto pravidlo
by mÏlo b˝t naps·no co nejrestriktivnÏji. Toto zajistÌ, æe projde jen a pouze
traffic, kter˝ chceme nechat projÌt.

<p>
NÏjakÈ p¯Ìklady:
<blockquote>
<tt>
# Povol traffic na dc0 z lok·lnÌ sÌtÏ, 192.168.0.0/24,<br>
# na IP adresu OpenBSD storje 192.168.0.1. D·le povol<br>
# vracejÌcÌ se traffic na dc0.<br>
d319 4
a322 4
# Povol TCP traffic na fxp0 na web server bÏæÌcÌ na<br>
# OpenBSD stroji. JmÈno interface, fxp0, je pouæito jako<br>
# cÌlov· adresa, takæe pakety budou splÚovat toto pravidlo pouze tehdy,<br>
# kdyæ jsou urËeny pro tento OpenBSD stroj.<br>
d327 37
d365 8
a372 7
<h2>Udræov·nÌ stavu</h2>
Jedna z d˘leæit˝ch schopnostÌ Packet filtru je "udræov·nÌ stavu" nebo 
"stavov· inspekce". Stavov· inspekce se vztahuje k schopnosti PF udræovat
p¯ehled o stavu nebo pr˘bÏhu sÌªovÈho spojenÌ. UloæenÌm informace 
o kaædÈm spojenÌ do stavovÈ tabulky, je PF schopen rychle zjistit, zda
paket proch·zejÌcÌ firewallem pat¯Ì do jiæ ustavenÈho spojenÌ. Pokud
pat¯Ì, projde firewallem bez vyhodnocov·nÌ rulesetu.
d375 7
a381 7
Udræov·nÌ stavu m· mnoho v˝hod vËetnÏ jednoduππÌch mnoæin pravidel a
lepπÌho v˝kon filtrov·nÌ. PF je schopno poznat pakety jdoucÌ v 
<i>obou</i> smÏrech v r·mci stavovÈ tabulky, coæ znamen·, æe pravidla pro
vracejÌcÌ se traffic nemusÌ b˝t v mnoæinÏ pravidel uvedena.
A protoæe pakety vyhovujÌcÌ stavov˝m spojenÌm nemusÌ projÌt vyhodnocov·nÌm
rulesetu, Ëas kter˝ PF str·vÌ zpracov·nÌm takov˝ch paket˘ m˘æe b˝t hodnÏ
snÌæen.
d384 10
a393 5
Pokud obsahuje pravidlo volbu <tt>keep state</tt>, prvnÌ paket, kter˝
vyhovuje tomuto pravidlo vytvo¯Ì "stav" mezi odesilatelem a p¯Ìjemcem.
Od tÈ chvÌle nejenom pakety jdoucÌ od odesilatele k p¯Ìjemmcci splÚujÌ
z·znam ve stavovÈ tabulce, ale takÈ pakety jdoucÌ od p¯Ìjemce k
odesilateli. Nap¯.:
d396 1
a396 1
pass out on fxp0 proto tcp from any to any keep state
d401 5
a405 4
To povolÌ jak˝koliv odchozÌ TCP traffic na interface <tt>fxp0</tt> 
a d·le povolÌ traffic v opaËnÈm smÏru.
Udræov·nÌ stavu je hezk· fÌËura, jeæ znatelnÏ zlepπÌ v˝kon firewallu,
protoæe vyhled·v·nÌ stav˘ je rychlejπÌ neæ vyhodnocov·nÌ rulesetu.
d408 8
a415 5
Volba <tt>modulate state</tt> pracuje jako <tt>keep state</tt> s tou
v˝jimkou, æe se vztahuje pouze k TCP paket˘m. S
<tt>modulate state</tt>, Initial Sequence Number (ISN) odchozÌch spojenÌ
je n·hodnÈ. To je uæiteËnÈ pro ochranu spojenÌ iniciovan˝ch urËit˝mi
operaËnÌmi systÈmy, kterÈ majÌ uboh˝ zp˘sob volby ISN ËÌsel.
d418 2
a419 1
Keep state na odchozÌch TCP, UDP, a ICMP paketech a modulace TCP ISNs:
d422 2
a423 2
pass out on fxp0 proto tcp from any to any modulate state<br>
pass out on fxp0 proto { udp, icmp } from any to any keep state
d428 7
a434 4
DalπÌ v˝hodou udræov·nÌ stavu je æe korespondujÌcÌ ICMP traffic projde
firewallem. Nap¯. pokud je <tt>keep state</tt> specifikov·n pro TCP
spojenÌ a p¯ijde ICMP source-quennch zpr·va vztahujÌcÌ se k tomuto TCP
spojenÌ, bude vyhovovat p¯isluπnÈmu ·znamu ve stavovÈ tabulce a povolena.
d437 13
a449 6
Je d˘leæitÈ poznamenat, æe stavovÈ konence jsou limitovanÈ na interface,
na kterÈm byly vytvo¯eny. To je obzvl·πtÏ d˘leæitÌ na routerech a
firewallech bÏæÌcÌch PF, zvl·πª kdyæ je implementov·na politika
"default deny" jak je naznaËeno v˝πe. Pokud firewall udræuje stav na vπech
odhchozÌch spojenÌch na externÌm interface, tyto pakety musÌ b˝t
explicitnÏ povoleny skrz internÌ interface.
d452 3
a454 5
Pravidla <a href="nat.html"><tt>nat</tt></a>, 
<a href="nat.html#binat"><tt>binat</tt></a>, a
<a href="rdr.html"><tt>rdr</tt></a> implicitnÏ vytv·¯Ì stav pro
vyhovujÌcÌ spojenÌ tak dlouho jak je spojenÌ povoleno mnoæinou filtrovaÌch
pravidel.
d457 73
a529 10
<h2>Udræov·nÌ stavu pro UDP</h2>
NÏkdo jednou ¯ekl, æe "Nelze vytvo¯it stav pro UDP, protoæe UDP je
bezstavov˝ protokol!"  I kdyæ je pravda, æe UDP komunikace 
nem· æ·dn˝ stavov˝ koncept (nebo expliticnÌ zaË·tek a konec komunikace),
to nem· vliv na schopnost PF vytvo¯it stav pro UDP session. V p¯ÌpadÏ
protkol˘ bez "start" a "end" paket˘, PF jednoduπe sleduje kolik uplynulu
Ëasu od poslednÌho pektu, kter˝ vyhovoval pravidlu. Pokud vyprπel timeout,
dojde ke smaz·nÌ stavu. Hodnoty timeout˘ mohou b˝t nastaveny 
v sekci <a href="options.html">options</a> v souboru
<tt>/etc/pf.conf</tt>.
a530 15
<a name="tcpflags"></a>
<h2>TCP Flagy</h2>
Vyhodnocov·nÌ TCP paket˘ zaloæenÈ na flags je nejËastÏji pouæito k
filtrov·nÌ TCP paket˘, kterÈ se pokouπÌ u ustavenÌ spojenÌ. TCP flagy a
jejich v˝znam je zde: 
<ul>
<li><b>F</b> : FIN  - Finish; konec session
<li><b>S</b> : SYN  - Synchronize; indikuje æ·dost o zaË·tek session
<li><b>R</b> : RST  - Reset; strhni spojenÌ 
<li><b>P</b> : PUSH - Push; paket je posl·n ihned
<li><b>A</b> : ACK  - Acknowledgement
<li><b>U</b> : URG  - Urgent
<li><b>E</b> : ECE  - Explicit Congestion Notification Echo
<li><b>W</b> : CWR  - Congestion Window Reduced
</ul>
d533 2
a534 2
Aby PF prov·dÏl inspekci TCP flag˘ bÏhem vyhodnocov·nÌ pravidla, je
pouæito klÌËovÈ slovo <tt>flags</tt> s n·sledujÌcÌ syntaxÌ:
d537 4
a540 1
flags <i>check</i>/<i>mask</i>
d545 46
a590 3
<tt><i>mask</i></tt> ¯ekne PF aby se prov·dÏla inspekce pouze
specifikovan˝ch flag˘ a <tt><i>check</i></tt> specifikuje kterÈ flagy musÌ
b˝t "nahozeny" v hlaviËce aby pravidlo vyhovovalo. 
d593 7
a599 1
pass in on fxp0 proto tcp from any to any port ssh flags S/SA
d604 26
a629 3
V˝πe uvedenÈ pravidlo pustÌ TCP traffic s nastaven˝m SYN flagem, zkoum·
pouze p¯Ìtomnost SYN a ACK flag˘. Paket s SYN a ECE flagy bude v˝πe
uvedenÈmu pravidlu vyhovovat a paket s SYN a ACK nebo jenom ACK nebude.
d632 2
a633 2
Pozn·mka: v p¯edchozÌch verzÌch OpenBSD, n·sledujÌcÌ syntax byla 
podporovan·:
d636 2
a637 1
. . . flags S
d642 5
a646 5
To uæ neplatÌ. Maska musÌ b˝t nynÌ <i>vædy</i> specifikov·na.

<p>
Flagy jsou Ëasto pouæity ve spojenÌ s pravidly obsahujÌcÌmi 
<tt>keep state</tt> pro snadnÏjπÌ vytv·¯enÌ z·znam˘ ve stavovÈ tabulce:
d649 2
a650 1
pass out on fxp0 proto tcp all flags S/SA keep state
d655 9
a663 2
Toto povolÌ vytv·¯enÌ stavu pro odchozÌ TCP pakety s nastaven˝m SYN flagem
z SYN a ACK flag˘.
d666 4
a669 5
MÏli byste b˝t opatrnÌ p¯i pouæÌv·nÌ flag˘ -- rozumÏjte tomu, co dÏl·te a
proË a buÔte opatrnÌ s radami, kterÈ dostanete, protoæe spousta z nich je
πpatn˝ch.
NÏkte¯Ì lidÈ navrhujÌ vytvo¯enÌ stavu "pouze pokud je nastaven SYN flag
a ne ostatnÌ". TakovÈ pravidlo by skonËilo takto: 
d671 1
a671 1
     . . . flags S/FSRPAUEW  <i>πpatn˝ n·pad!!</i>
d675 8
a682 4
Teorie je, æe stav se vytv·¯Ì pouze na zaË·tku TCP session a session by
mÏla zaËÌnat pouze SYN flagem a ne ostatnÌmmi. ProblÈm je v tom, æe
nÏkterÈ stroje zaËÌnajÌ pouæÌvat ECN flag a pokud se takov˝ stroj pokusÌ
p¯ipojit, bude takov˝m pravidlem odmÌtnuta. O moc lepπÌ pravidlo je:
d690 7
a696 16
ZatÌmco toto je praktickÈ a bezpeËnÈ, je takÈ nezbytnÈ kontrolovat FIN a
RST flagy pokud traffic takÈ podlÈh·
<a href="scrub.html">scrub</a>. Scrub proces zp˘sobÌ, æe PF bude zahazovat
jakÈkoliv p¯ÌchozÌ pakety s ileg·lnÌ kombinacÌ TCP flag˘ (jako nap¯. SYN a
FIN nebo SYN a RST). Je d˘raznÏ doporuËeno vædcky pouæÌvat 
<tt>scrub</tt> na p¯ÌchozÌ traffic:
<blockquote>
<tt>
scrub in on fxp0<br>
.<br>
.<br>
.<br>
pass in on fxp0 proto tcp from any to any port ssh flags S/SA \<br>
&nbsp;&nbsp;&nbsp;keep state
</tt>
</blockquote>
d698 15
a712 10
<a name="quick"></a>
<h2>KlÌËovÈ slovo <tt>quick</tt></h2>
Jak bylo naznaËeno d¯Ìve, kaæd˝ paket je vyhodnocovan˝ oproti mnoæinÏ
filtrovacÌch pravidel od shora dol˘. DefaultnÏ, paket je oznaËen pro
pr˘chod, coæ m˘æe b˝t zmÏmÏno nÏjak˝m pravidlem a m˘æe b˝t zmÏnÏno tam a
zp·tky p¯edtÌm neæ vyhodnocov·nÌ dorazÌ na konec mnoæiny pravidel.
<b>PoslednÌ pravidlo, kterÈ vyhovuje "vyhr·v·".</b>  K tomuto chov·nÌ
existuje v˝jimka: Volba <tt>quick</tt> ve filtrovacÌm pravidle 
ukonËÌ zpracov·nÌ a vede k provedenÌ akce s paketem. PodÌvejme se na
nÏkolik p¯Ìklad˘:
d715 3
a717 1
©patnÏ:
d720 1
a720 2
block in on fxp0 proto tcp from any to any port ssh<br>
pass &nbsp;in all
d725 1
a725 2
V tomto p¯ÌpadÏ, m˘æe b˝t ¯·dek s <tt>block</tt> vyhodnocen, ale nikdy
nebude mÌt æ·dn˝ efekt, protoæe n·sleduje ¯·dek, kter˝ povolÌ vπechno.
d728 2
a729 7
LepπÌ:
<blockquote>
<tt>
block in quick on fxp0 proto tcp from any to any port ssh<br>
pass &nbsp;in all
</tt>
</blockquote>
d732 3
a734 3
Tato pravidla budou vyhodnocov·na trochu odliπnÏ. Pokud
¯·dek s <tt>block</tt> vyhovuje, kv˘li volbÏ <tt>quick</tt> bude paket
zablokov·n a zbytek mnoæiny pravidel bude ignorov·n.
d737 7
a743 7
<h2>Blokov·nÌ Spoofnut˝ch Paket˘</h2>
"spoofov·nÌ" adres je kdyæ nehodn˝ uæivatel zfalπuje zdrojovou IP adresu v
paketech, kterÈ p¯en·πÌ za ˙Ëelem schovat svoji skuteËnou adresu nebo
vyd·vat se za nÏjak˝ jin˝ uzel na sÌtÌ. Jakmile uæivattel spoofnul svoji
adresu, m˘æe spustit sÌªov˝ ˙tok bez toho, æe by odhalil skuteËn zdroj
˙toku nebo se m˘æe pokusit zÌskat p¯Ìstup k sÌªov˝m sluæb·m, kterÈ jsou
restringov·ny na urËitÈ IP adresy.
d746 2
a747 2
PF naÌbÌzÌ ochranu proti spoofov·nÌ adres pomocÌ klÌËovÈho slova
<tt>antispoof</tt>:
d757 2
a758 2
<dd>Specifikuje æe vyhovujÌcÌ pakety majÌ b˝t zalogov·ny via 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+3.3"
d762 2
a763 2
<dd>Pokud paket vyhovuje tomuto pravidlu, pak bude povaæov·no 
"v˝herce" a vyhodnocov·nÌ rulesetu se zastavÌ.
d766 2
a767 2
<dd>SÌªov˝ interface na kterÈm aktivovat ochranu proti spoofov·nÌ.
Zde m˘æe b˝t seznam interfac˘ via <a href="macros.html#lists">list</a>.
d770 1
a770 1
<dd>Address family pro kterou aktivovat ochranu proti spoofov·nÌ, buÔ
d775 1
a775 1
P¯Ìklad:
d783 4
a786 5
Kdyæ je mnoæina pravidel nahr·na, vπechny v˝skyty klÌËovÈho slova
<tt>antispoof</tt> jsou expandov·ny do dvou filtrovacÌch pravidel.
P¯edpokl·dejme, æe interface fxp0 m· IP 
adresu 10.0.0.1 a masku podsÌtÏ 255.255.255.0 (tj.
/24), pak v˝πe uvedenÈ <tt>antispoof</tt> pravidlo se rozvine do:
d796 1
a796 1
Tato pravidla provedou dvÏ vÏci:
d798 8
a805 8
<li>Zablokuje vπechen traffic p¯ich·zejÌcÌ ze sÌtÏ 10.0.0.0/24 
<i>not</i> kter˝ nejde p¯es fxp0. Protoæe sÌª 10.0.0.0/24 
je na interface fxp0, pakety se zdrojovou adresou z tohoto sÌªovÈho bloku
by nemÏly nikdy p¯ijÌt na jin˝ interface. 
<li>Zablokuje vπechen p¯ÌchozÌ traffic z 10.0.0.1, IP addresy na fxp0.
Stroj by nikdy nemÏl posÌlat pakety sobÏ sama skrz externÌ interface,
takæe vπechny p¯ÌchozÌ pakety se zdrojovou adresou n·leæÌcÌ stroji by mÏly
b˝t povaæov·ny za zlomyslnÈ.
d809 5
a813 4
<b>POZN¡MKA</b>: FiltrovacÌ pravidla do kter˝ch se expanduje pravidlo 
<tt>antispoof</tt> budou takÈ blokovat pakety poslanÈ p¯es loopback
interface na lok·lnÌ adresu. Tyto adresy by mÏly b˝t explicitnÏ povoleny.
Nap¯.:
d816 1
a816 1
pass in quick on lo0 all<br>
d823 3
a825 4
PouæitÌ <tt>antispoof</tt> by mÏlo b˝t omezeno na interfacy, kterÈ majÌ
p¯i¯azenu IP adresu. PouæitÌ
<tt>antispoof</tt> na interface bez IP adresy vy˙stÌ v filtrovacÌ pravidla
jako
d834 90
a923 2
S tÏmito pravidly riskujete blokov·nÌ <i>veπkerÈho</i> p¯ÌchozÌho trafficu
na <i>vπech</i> interfacech.
d926 5
a930 5
<h2>IP Options</h2>
DefaultnÏ, PF blokuje vπechny pakety s nastaven˝mi IP options. To m˘æe
b˝t dobrÈ pro detekci "OS fingerprinting" utilitami jako nmap. Pokud
provozujete aplikaci, kter· vyæaduje povolenÌ takov˝ch paket˘ jako nap¯.
multicast nebo IGMP, m˘æe pouæÌt direktivu <tt>allow-opts</tt>:
d938 8
a945 8
<h2>P¯Ìklad mnoæiny filtrovacÌch pravidel</h2>
NÌæe je uveden p¯iklad mnoæiny filtrovacÌch pravidel. Stroj, na kterÈm
bÏæÌ PF funguje jako firewall mezi malou internÌ sÌtÌ a Internetem.
Uvedena jsou pouze filtrovcÌ pravidla.
<a href="queueing.html">queueing</a>, 
<a href="nat.html"><tt>nat</tt></a>, 
<a href="rdr.html"><tt>rdr</tt></a>, 
atd., byly v tomto p¯Ìkladu vynech·ny.
d955 6
d962 1
a962 5
scrub in all

# nastav politiku default deny 
block in  all
block out all
d964 2
a965 2
# povol traffic na loopback interface v obou smÏrech
pass quick on lo0 all
d967 2
a968 2
# aktivuj ochranu proti spoofov·nÌ na internÌm interface.
antispoof quick for $int_if inet
d970 4
a973 4
# povol pouze ssh spojenÌ z lok·lnÌ sÌtÏ pokud je to d˘veryhodn˝ poËÌtaË
# 192.168.0.15. pouæij "block return" takæe je posl·n TCP RST 
# pro uzav¯en˝ch blokovan˝ch spojenÌ. pouæij "quick" aby nebylo toto
# pravidlo p¯eps·no nÏkter˝m z "pass" pravidel pod nÌm.
d975 1
a975 1
   to $int_if port ssh flags S/SA
d977 19
a995 15
# povol vπechen traffic z a do lok·lnÌ sÌtÏ
pass in  on $int_if from $lan_net to any
pass out on $int_if from any to $lan_net

# povol tcp, udp, a icmp z externÌho (Internet) interface. 
# keep state pro udp a icmp a modulate state pro tcp.
pass out on $ext_if proto tcp all modulate state flags S/SA
pass out on $ext_if proto { udp, icmp } all keep state

# povol ssh spojenÌ na externÌ interface pokud NENÕ urËen 
# pro firewall (tj. jsou urËeny pro stroj v lok·lnÌ sÌti)
# loguj inici·lnÌ pakety takæe m˘æeme pozdÏji ¯Ìci, kdo se pokouπel
# napojit
pass in log on $ext_if proto tcp from any to { !$ext_if, !$int_if } \
   port ssh flags S/SA keep state
d1001 1
a1001 1
[<a href="rdr.html">P¯edchozÌ: P¯esmÏroov·nÌ Trafficu</a>]
d1003 1
a1003 1
[<a href="logging.html">DalπÌ: Logov·nÌ</a>]
d1009 1
d1011 6
a1016 7
<br>
Originally [OpenBSD: filter.html,v 1.13 ]
<!--- translation by Vladimir Kotal -->
<br>
$Translation: filter.html,v 1.3 2003/11/10 13:34:59 horacio Exp $
<br>
$OpenBSD: filter.html,v 1.3 2003/11/10 14:42:48 horacio Exp $
@


1.3
log
@Sync with Steelix CVS
@
text
@d680 1
a680 1
$OpenBSD$
@


1.2
log
@Sync with Steelix CVS
@
text
@d675 1
a675 1
Originally: [OpenBSD: filter.html,v 1.13 ]
d678 1
a678 1
$Translation: filter.html,v 1.2 2003/11/10 13:01:17 horacio Exp $
@


1.1
log
@Sync with Steelix CVS
@
text
@d675 1
a675 1
Originally: [OpenBSD: filter.html,v 1.13]
d678 1
a678 1
$Translation: filter.html,v 1.1 2003/11/02 21:53:36 certik Exp $
@

