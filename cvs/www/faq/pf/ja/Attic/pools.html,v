head	1.9;
access;
symbols;
locks; strict;
comment	@# @;


1.9
date	2005.08.13.08.24.51;	author saad;	state dead;
branches;
next	1.8;

1.8
date	2004.05.09.09.58.22;	author saad;	state Exp;
branches;
next	1.7;

1.7
date	2004.01.04.22.47.55;	author horacio;	state Exp;
branches;
next	1.6;

1.6
date	2003.12.15.19.44.12;	author horacio;	state Exp;
branches;
next	1.5;

1.5
date	2003.12.03.21.55.18;	author horacio;	state Exp;
branches;
next	1.4;

1.4
date	2003.11.10.21.40.53;	author horacio;	state Exp;
branches;
next	1.3;

1.3
date	2003.11.03.16.54.43;	author jufi;	state Exp;
branches;
next	1.2;

1.2
date	2003.09.19.16.44.17;	author horacio;	state Exp;
branches;
next	1.1;

1.1
date	2003.06.21.10.04.16;	author jufi;	state Exp;
branches;
next	;


desc
@@


1.9
log
@remove unmaintained [ja] translation files.  requested by translator.
@
text
@<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Address Pools and Load Balancing</title>
<link rev="made" href="mailto:www@@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-2022-JP">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2003-2004 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="queueing.html">前に戻る: パケットキューイングと優誓莉膂棉佞鹿畩杣蓿繙就蜴粤蔗迪⊂目次</a>]
[<a href="tagging.html">次に進む: パケットのタグ付け</a>]

<p>
<h1>
<font color="#e00000">PF: アドレスプールと負荷分散 (Load Balancing)</font>
</h1>

<hr>

<h3>目次</h3>
<ul>
<li><a href="#intro">はじめに</a>
<li><a href="#nat">NAT アドレスプール</a>
<li><a href="#incoming">着信誓楝海良蕾拱鹿畩
殊蘊釈鱚羹■阨濶鈑⊂送出トラフィックの負荷分散</a>
	<ul>
	<li><a href="#outexample">ルールセットの例</a>
	</ul>
</ul>

<hr>

<a name="intro"></a>
<h2>はじめに</h2>
アドレスプールは、ユーザのグループの間で共有して使用される、ふたつ以上のアドレスを
提供するためのものです。アドレスプールは、<a href="rdr.html"><tt>rdr</tt></a> ルール中の
リダ瀬ぅ譽轡腑鵐▲疋譽垢箸靴董△△襪い蓮釈鱚羹癆譬昭嬢癆鹿昭ルール中の
変換アドレスや、<a href="filter.html">フィルタ</a>オプションの
<tt>route-to</tt>、<tt>reply-to</tt> および <tt>dup-to</tt>
のターゲットアドレスとして指定することができます。

<p>
アドレスプールを使用するには、4 つの方法があります。
<ul>
<li><tt>bitmask</tt> - プールアドレスのネットワーク部を、変更されるアドレス
(<tt>nat</tt> ルールの送信元アドレス、<tt>rdr</tt> ルールの送信誓茱▲疋譽に移植します。
例: アドレスプールが 192.0.2.1/24 であり、変換されるアドレスが 10.0.0.50
の場合、結果のアドレスは 192.0.2.50 となります。
アドレスプールが 192.0.2.1/25 であり、変換されるアドレスが 10.0.0.130
の場合、結果のアドレスは 192.0.2.2 となります。
<li><tt>random</tt> - プールからアドレスをランダ瀬爐冒鬚靴泙后
殊蘊儒齒竇癈莠ぢプールからどのアドレスを使用するのかを決定するのに、
送信元アドレスのハッシュを使用します。この方法は、与えられた送信元アドレスが
常に同じプールアドレスにマッピングされるのを確実にします。
ハッシュアルゴリズムから導かれた鍵を、オプションとして <tt>source-hash</tt>
の後に 16 進数のフォーマットか文字列で指定することができます。
デフォルトでは、
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.4"
>pfctl(8)</a> はランダ瀬爐文阿鬟襦璽襯札奪箸蹇璽匹気譴襪瓦箸
毎回誓言成しています。
<li><tt>round-robin</tt> - アドレスプールを順にループします。
これがデフォルトの方法であり、<a href="tables.html">テーブル</a>を使用して
アドレスプールが指定された場合に許される
唯一の方法でもあります。
</ul>

<p>
<tt>round-robin</tt> 法を除いて、アドレスプールは
<a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>
(Classless Inter-Domain Routing)
ネットワークブロックとして記述されていなければなりません。<tt>round-robin</tt>
法では、<a href="macros.html#lists">リストのフォーマット</a>や
<a href="tables.html">テーブル</a>を使用して複数の個々のアドレスを指定できます。

<a name="nat"></a>
<h2>NAT アドレスプール</h2>
アドレスプールは、<a href="nat.html"><tt>nat</tt></a> ルールの
変換アドレスとして使用することができます。誓楝海慮気料汽▲疋譽垢蓮
選択した方法に基づくプールからのアドレスで変換されます。
これは、PF が非常に大規模なネットワークで NAT を実行しているような状況で
役に立つものです。変換アドレスごとの NAT を使用する誓楝海凌瑤聾造蕕譴討い襪里如
付加的な変換アドレスを追加することは、より多くのユーザにサービスを提供するため、
NAT ゲートウェイがその規模を拡大させることができることを意味します。

<p>
この例では、送出されるパケットを変換するために、ふたつのアドレスのプールが
使用されることになります。それぞれの送出される誓楝海里燭瓩法
估ぢはラウンドロビンで使用するアドレスのローテーションを行います。
<blockquote>
<tt>
nat on $ext_if inet from any to any -&gt; { 192.0.2.5, 192.0.2.10 }
</tt>
</blockquote>

<p>
この方法のひとつの欠点世蓮睇凜優奪肇錙璽蕕琉賚△寮接続に対して、
常に同じアドレスへと変換されるとは限らないということでしょう。
これはたとえば、IP アドレスに基づいてユーザのログインを追誓廚垢襪茲Δ
サイトをブラウジングする際などに、障害となり得世襪發里任后
この代替の方法は、それぞれの内部アドレスが常に同じ変換アドレスへと
変換される <tt>source-hash</tt> 法を使用することです。
これを使用するためには、アドレスプールは
<a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>
ネットワークブロックでなければなりません。
<blockquote>
<tt>
nat on $ext_if inet from any to any -&gt; 192.0.2.4/31 source-hash
</tt>
</blockquote>

<p>
この <tt>nat</tt> ルールは、192.0.2.4/31 (192.0.2.4 〜 192.0.2.5) の
アドレスプールを、送出パケットの変換アドレスとして使用しています。
それぞれの内部アドレスは、<tt>source-hash</tt> キーワードによって、
常に同じ変換アドレスへと変換されます。

<a name="incoming"></a>
<h2>着信誓楝海良蕾拱鹿莢アドレスプールはまた、着信誓楝海良蕾拱兇里燭瓩砲盪藩僂垢襪海箸任泙后
たとえば、web サーバに着信する誓楝海蓮焚爾里茲Δ繧ぢサーバの集合に
分散させることができるのです。
<blockquote>
<tt>
web_servers = "{ 10.0.0.10, 10.0.0.11, 10.0.0.13 }"<br>
<br>
rdr on $ext_if proto tcp from any to any port 80 -&gt; $web_servers
</tt>
</blockquote>

<p>
一連の誓楝海蓮▲薀Ε鵐疋蹈咼麕，繧ぢサーバに
リダ瀬ぅ譽箸気譴襪海箸砲覆蠅泙后

腫料の例としては、すべての web サーバが CIDR ネットワークブロック内に
配置されている場合には、与えられた IP アドレスが物理的に同じ web サーバに
常にリダ瀬ぅ譽箸気譴襪茲Α儒齒竇癈莠ぢキーワードを
使用することができます。もう一度言世い泙垢△海譴蓮サーバのブラウジングの際の
セッション情報を保守するために、ときどき必要となるものです。

<a name="outgoing"></a>
<h2>送出トラフィックの負荷分散</h2>
アドレスプールは、(<a href="http://www.rfc-editor.org/rfc/rfc1771.txt">BGP4</a>
のような) 適誓気癖佻僂離襦璽謄鵐哀廛蹈肇灰襪鰺僂任覆ぞ豺腓法
ふたつ以上のインターネット誓楝海良蕾拱兇鮃圓Δ燭瓩条阨鐚
フィルタオプションと組み合わせて使用することができます。
<tt>round-robin</tt> 法のアドレスプールとともに <tt>route-to</tt>
を使用することで、外向きの誓楝海亙瑤粒宛侶佻涼罎
均等に分散されるようになります。

<p>
これは付加的な情報ですが、このようにするためには、それぞれの
インターネット誓楝海卜拈接するルータの IP アドレスが必要になります。
これは、送出パケットの送信誓茲鮴制御するため、<tt>route-to</tt>
オプションに供給するためのものです。

<p>
以下の例は、ふたつのインターネット誓楝海悗料丱肇薀侫奪
負荷分散を行います。
<blockquote>
<tt>
lan_net = "192.168.0.0/24"<br>
int_if &nbsp;= "dc0"<br>
ext_if1 = "fxp0"<br>
ext_if2 = "fxp1"<br>
ext_gw1 = "68.146.224.1"<br>
ext_gw2 = "142.59.76.1"<br>
<br>
pass in on $int_if route-to \<br>
&nbsp;&nbsp;&nbsp;{ ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \<br>
&nbsp;&nbsp;&nbsp;from $lan_net to any keep state
</tt>
</blockquote>

<p>
<tt>route-to</tt> オプションは、それぞれのゲートウェイに対してトラフィックの
負荷分散を行うための、送出用のネットワークインターフェイスを指定するため、
<i>内部</i>インターフェイスに着信するトラフィックに対して使用されるものです。
<tt>route-to</tt> オプションは、<i>それぞれ</i>のトラフィックの負荷分散を行う
フィルタルールが存在していなければならないということに注意してくだ世気ぁ
戻りパケットは、送出されたものと同じ外部インターフェイスに返送されて来て
(これは ISP によって行われます)、さらに普通に内部ネットワークへと
転送されて行きます。

<p>
<tt>$ext_if1</tt> に属する送信元アドレスを持つパケットが、常に
<tt>$ext_gw1</tt> へと (そして、同様に、<tt>$ext_if2</tt> は
<tt>$ext_gw2</tt> へと) ルーティングされるのを確実にするため、
以下の 2 行がルールセットに含まれているべきでしょう。
<blockquote>
<tt>
pass out on $ext_if1 route-to ($ext_if2 $ext_gw2) from $ext_if2 \<br>
&nbsp;&nbsp;&nbsp;to any<br>
pass out on $ext_if2 route-to ($ext_if1 $ext_gw1) from $ext_if1 \<br>
&nbsp;&nbsp;&nbsp;to any 
</tt>
</blockquote>

<p>
最終的に、NAT をそれぞれの送出用インターフェイスに対して使用することができます。
<blockquote>
<tt>
nat on $ext_if1 from $lan_net to any -&gt; ($ext_if1)<br>
nat on $ext_if2 from $lan_net to any -&gt; ($ext_if2)
</tt>
</blockquote>

<a name="outexample"></a>
<p>
送出トラフィックの負荷分散を行うための完全な例は、
以下のようなものになるかも知れません。

<p>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
lan_net = "192.168.0.0/24"
int_if  = "dc0"
ext_if1 = "fxp0"
ext_if2 = "fxp1"
ext_gw1 = "68.146.224.1"
ext_gw2 = "142.59.76.1"

#  nat outgoing connections on each internet interface
nat on $ext_if1 from $lan_net to any -&gt; ($ext_if1)
nat on $ext_if2 from $lan_net to any -&gt; ($ext_if2)

#  default deny
block in  from any to any
block out from any to any

#  pass all outgoing packets on internal interface
pass out on $int_if from any to $lan_net
#  pass in quick any packets destined for the gateway itself
pass in quick on $int_if from $lan_net to $int_if
#  load balance outgoing tcp traffic from internal network. 
pass in on $int_if route-to \
    { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \
    proto tcp from $lan_net to any flags S/SA modulate state
#  load balance outgoing udp and icmp traffic from internal network
pass in on $int_if route-to \
    { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \
    proto { udp, icmp } from $lan_net to any keep state

#  general "pass out" rules for external interfaces
pass out on $ext_if1 proto tcp from any to any flags S/SA modulate state
pass out on $ext_if1 proto { udp, icmp } from any to any keep state
pass out on $ext_if2 proto tcp from any to any flags S/SA modulate state
pass out on $ext_if2 proto { udp, icmp } from any to any keep state

#  route packets from any IPs on $ext_if1 to $ext_gw1 and the same for
#  $ext_if2 and $ext_gw2
pass out on $ext_if1 route-to ($ext_if2 $ext_gw2) from $ext_if2 to any 
pass out on $ext_if2 route-to ($ext_if1 $ext_gw1) from $ext_if1 to any 
</pre>
</td></tr>
</table>

<p>
[<a href="queueing.html">前に戻る: パケットキューイングと優誓莉膂棉佞鹿畩杣蓿繙就蜴粤蔗迪⊂目次</a>]
[<a href="tagging.html">次に進む: パケットのタグ付け</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@@openbsd.org">www@@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: pools.html,v 1.10 ]
<br>
$Translation: pools.html,v 1.6 2004/01/03 05:24:39 toshi Exp $
<br>
$OpenBSD: pools.html,v 1.8 2004/05/09 09:58:22 saad Exp $
</small>

</body>
</html> 
@


1.8
log
@sync with Steelix CVS
@
text
@d286 1
a286 1
$OpenBSD: pools.html,v 1.10 2004/01/01 04:16:17 nick Exp $
@


1.7
log
@Sync with Steelix CVS
@
text
@@


1.6
log
@Sync with Steelix CVS
@
text
@d11 1
a11 1
<meta name="copyright"     content="This document copyright 2003 by OpenBSD.">
d282 1
a282 1
Originally [OpenBSD: pools.html,v 1.9 ]
d284 1
a284 1
$Translation: pools.html,v 1.5 2003/12/15 03:00:13 toshi Exp $
d286 1
a286 1
$OpenBSD: pools.html,v 1.9 2003/11/30 23:18:06 nick Exp $
@


1.5
log
@Sync with Steelix CVS
@
text
@d22 1
a22 1
[<a href="../tagging.html">次に進む: パケットのタグ付け</a>]
d274 1
a274 1
[<a href="../tagging.html">次に進む: パケットのタグ付け</a>]
d284 1
a284 1
$Translation: pools.html,v 1.4 2003/12/03 04:48:37 toshi Exp $
@


1.4
log
@Sync with Steelix CVS
@
text
@d20 1
a20 1
[<a href="shortcuts.html">前に戻る: ルールセット作誓龍疇鹿畩箍甓杣蓿繙就鞳鱠譬ぢ次に進む: 誓鹿畩箏畄これがデフォルトの方法です。
d84 2
a85 7
法では、<a href="macros.html#lists">リストのフォーマット</a>を使用して
複数の個々のアドレスを指定できます。

<p>
さらに、<tt>nat</tt> ルールが TCP および UDP パケットの送信元ポートを
変更してしまわないようにするため、<tt>static-port</tt> キーワードを
上記の方法のひとつの後に指定することができます。
d272 1
a272 1
[<a href="shortcuts.html">前に戻る: ルールセット作誓龍疇鹿畩箍郡
甓郡
杣蓿繙就鞳鱠譬ぢ次に進む: 誓鹿畩箍顕
甓顕
蜃蜴瘡踟緕帯頂闖踈讙窺箍鹸
甓鹸
ぴ鱇銖赱闔竟闌鶤蔗迪旭劾臼唄叉該鰻闢蓍
箍原
甓原
は鞳鄲喞竟闌鶤蔗迪旭劾臼桶魂杭芦蜒祷

窺跫栴繻蝌鱇銖赱闔嶝

絶薫
畄釈鱚羹∵雕關緕碵筮闥膀竍薛砠遲轣隨竍蘓髟纈鞴笏讀瘢雹黼謾蜿扈研瘢雹轣鉋癆莉緕帯朝凱晦
箍元
甓元
蜃蜴瘡踟緕帯頂闖踈讙窺箍厳
甓厳
ぴ鱇銖赱闔竟闌鶤蔗迪旭劾姐唄紺杭幹闢蓍
箍弦
甓弦
は鞳鄲喞竟闌鶤蔗迪旭劾姐葦魂該換蜒祷

窺跫栴繻蝌

誓


窺跫栴繻蝌鱇銖赱闔嶝

絶恩甓元
蜃蜴瘡踟緕帯頂闖踈讙窺箍厳
甓厳
ぴ鱇銖赱闔竟闌鶤蔗迪旭劾斡渦魂刑碍闢蓍
箍弦
甓弦
は鞳鄲喞竟闌鶤蔗迪旭劾斡芦叉敢宛蜒祷
