head	1.18;
access;
symbols;
locks; strict;
comment	@# @;


1.18
date	2014.04.01.17.14.11;	author nick;	state dead;
branches;
next	1.17;

1.17
date	2013.12.06.20.52.46;	author ajacoutot;	state Exp;
branches;
next	1.16;

1.16
date	2013.05.03.05.53.48;	author ajacoutot;	state Exp;
branches;
next	1.15;

1.15
date	2013.03.24.06.51.44;	author ajacoutot;	state Exp;
branches;
next	1.14;

1.14
date	2009.10.19.09.39.59;	author ajacoutot;	state Exp;
branches;
next	1.13;

1.13
date	2009.10.17.15.58.26;	author ajacoutot;	state Exp;
branches;
next	1.12;

1.12
date	2009.05.16.08.59.12;	author ajacoutot;	state Exp;
branches;
next	1.11;

1.11
date	2009.03.16.20.24.23;	author tobias;	state Exp;
branches;
next	1.10;

1.10
date	2008.06.22.21.06.13;	author tobias;	state Exp;
branches;
next	1.9;

1.9
date	2007.12.01.10.39.11;	author tobias;	state Exp;
branches;
next	1.8;

1.8
date	2007.06.23.18.29.30;	author jufi;	state Exp;
branches;
next	1.7;

1.7
date	2006.12.29.12.56.48;	author jufi;	state Exp;
branches;
next	1.6;

1.6
date	2006.08.27.09.43.20;	author saad;	state Exp;
branches;
next	1.5;

1.5
date	2006.06.26.18.32.12;	author jufi;	state Exp;
branches;
next	1.4;

1.4
date	2006.05.29.11.06.11;	author jufi;	state Exp;
branches;
next	1.3;

1.3
date	2005.11.18.20.48.47;	author jufi;	state Exp;
branches;
next	1.2;

1.2
date	2005.05.30.13.52.07;	author saad;	state Exp;
branches;
next	1.1;

1.1
date	2005.01.06.20.03.30;	author jufi;	state Exp;
branches;
next	;


desc
@@


1.18
log
@
Abandon translations, per deraadt@@ and ajacoutot@@.
@
text
@<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Exemplo: Firewall para Casa ou Pequeno Escrit√≥rio</title>
<link rev="made" href="mailto:www@@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="carp.html">Anterior: Redund√¢ncia de Firewall com CARP
e pfsync</a>]
[<a href="index.html">Conte√∫do</a>]

<p>
<h1><font color="#e00000">PF: Exemplo: Firewall para Casa ou Pequeno
Escrit√≥rio</font></h1>
<hr>

<h3>Conte√∫do</h3>
<ul>
<li><a href="#scenario">O Cen√°rio</a>
	<ul>
	<li><a href="#network">A Rede</a>
	<li><a href="#objective">O Objetivo</a>
	<li><a href="#prep">Prepara√ß√£o</a>
	</ul>
<li><a href="#ruleset">O Conjunto de Regras</a>
	<ul>
	<li><a href="#macros">Macros</a>
	<li><a href="#options">Op√ß√µes</a>
	<li><a href="#rules">Regras de Firewall</a>

	</ul>
<li><a href="#allrules">O Conjunto de Regras Completo</a>
</ul>

<hr>

<a name="scenario"></a>
<h2>O Cen√°rio</h2>
Neste exemplo, o PF est√° em execu√ß√£o em uma m√°quina OpenBSD agindo como
firewall e gateway NAT para uma pequena rede em casa ou no escrit√≥rio. O
objetivo geral √© prover acesso √† Internet para a rede interna e acesso
limitado ao firewall de conex√µes provenientes da Internet, e ainda
disponibilizar para acesso externo um servidor Web localizado na rede
interna. Este documento guia-o atrav√©s da cria√ß√£o de um conjunto de
regras para esse fim.

<a name="network"></a>
<h3>A Rede</h3>
A rede est√° configurada da seguinte forma:

<pre>

  [ COMP1 ]    [ COMP3 ]
      |            |
   ---+------+-----+------- xl0 [ OpenBSD ] fxp0 -------- ( Internet )
             |
         [ COMP2 ]

</pre>

<p>
Existem v√°rios computadores na rede interna; o diagrama mostra apenas
tr√™s, mas o n√∫mero real √© irrelevante. Esses computadores s√£o
esta√ß√µes de trabalho usadas para navegar na Internet, ler
mensagens de correio eletr√¥nico, usar programas de bate-papo virtual,
etc., exceto COMP3, que tamb√©m roda um pequeno servidor Web.
A rede interna usa o bloco de rede 192.168.0.0 / 255.255.255.0.

<p>
O firewall OpenBSD √© um Celeron 300 com duas placas de rede:
uma 3com 3c905B (<tt>xl0</tt>) e uma Intel EtherExpress Pro/100
(<tt>fxp0</tt>).
Ele possui uma conex√£o a cabo com a Internet e faz NAT para compartilhar
o acesso com a rede interna. O endere√ßo IP na interface externa √©
atribu√≠do dinamicamente pelo Provedor de Acesso √† Internet.

<a name="objective"></a>
<h3>O Objetivo</h3>
Os Objetivos s√£o:
<ul>
<li>Prover acesso irrestrito √† Internet para a rede interna.
<li>Usar "negar por padr√£o" como pol√≠tica padr√£o do conjunto de regras.
<li>Permitir o seguinte tr√°fego vindo da Internet para o firewall:
	<ul>
	<li>SSH (porta TCP 22): ser√° utilizado para manuten√ß√£o
            remota do firewall.
	<li>Auth/Ident (porta TCP 113): utilizado por alguns
	    servi√ßos como SMTP e IRC.
	<li>Requisi√ß√µes de Eco ICMP: o tipo de pacote ICMP usado pelo
            comando <a
            href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8"
            >ping(8)</a>.
	</ul>
<li>Redirecionar tentativas de conex√£o na porta TCP 80 (que s√£o
    tentativas de conex√£o a um servidor Web) para o computador COMP3.
    E tamb√©m permitir tr√°fego TCP na porta 80 destinado a COMP3 atrav√©s
    do firewall.
<li>Registrar as estat√≠sticas de filtragem na interface externa.
<li>Por padr√£o, responder os pacotes bloqueados com um pacote TCP RST
    ou ICMP de Inalcan√ß√°vel.
<li>Tornar o conjunto de regras o mais simples poss√≠vel, para facilitar
    a manuten√ß√£o.</ul>

<a name="prep"></a>
<h3>Prepara√ß√£o</h3>
Este documento assume que a m√°quina OpenBSD tenha sido corretamente
configurada para funcionar como roteador, incluindo a configura√ß√£o de
endere√ßos IP, conectividade com a Internet e a defini√ß√£o das vari√°veis
do
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=3"
>sysctl(3)</a> <tt>net.inet.ip.forwarding</tt> e/ou
<tt>net.inet6.ip6.forwarding</tt> para "<tt>1</tt>".
Tamb√©m √© necess√°rio que voc√™ tenha ativado o PF usando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+5.4"
>pfctl(8)</a> ou definindo a vari√°vel apropriada em
<tt>/etc/rc.conf.local</tt>.

<a name="ruleset"></a>
<h2>O Conjunto de Regras</h2>
A seguir um passo a passo atrav√©s do conjunto de regras que realizar√£o
os objetivos descritos acima.

<a name="macros"></a>
<h3>Macros</h3>
As seguintes macros s√£o definidas para facilitar a leitura e manuten√ß√£o
do conjunto de regras:
<blockquote><pre>
int_if="xl0"
<br>
tcp_services = "{ 22, 113 }"<br>
icmp_types = "echoreq"<br>
<br>
comp3="192.168.0.3"
</pre></blockquote>

<p>
A primeira linha define a interface de rede interna onde a filtragem
acontecer√°.
Definindo aqui, se precisarmos mover esse sistema para outra
m√°quina com hardware diferente, podemos alterar apenas essa
linha e o resto das regras continuar√£o utiliz√°veis.
(Para este exemplo, a interface externa vai ser tratada usando o <tt>egress</tt> grupo de interface.
Isto &eacute; definido automaticamente em qualquer interface segurando uma rota padr&atilde;o, neste caso, fxp0).
A segunda e terceira linha listam os n√∫meros de portas TCP dos servi√ßos
que ser√£o abertos para a Internet (SSH e ident/auth) e os tipos de
pacotes ICMP que ter√£o permiss√£o de alcan√ßar a m√°quina do firewall.
Finalmente, a √∫ltima linha define o endere√ßo IP de COMP3.

<p>
<b>Nota</b>: Caso a conex√£o com a Internet necessite do
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=4"
>PPPoE</a>, ent√£o filtragem e NAT devem acontecer na interface
<tt>pppoe0</tt> e <i>n&atilde;o</i> na interface egress (<tt>fxp0</tt>).

<a name="options"></a>
<h3>Op√ß√µes</h3>
As duas op√ß√µes seguintes s√£o respons√°veis pela defini√ß√£o da resposta
padr√£o para regras de filtragem <tt>block</tt> e pelo "ativamento" do
registro de estat√≠sticas para a interface externa:
<blockquote><pre>
set block-policy return<br>
set loginterface egress
</pre></blockquote>

<p>
Todo sistema Unix possui uma interface "loopback".
Esta √© uma interface de rede virtual que √© utilizada por aplicativos
para conversarem entre si dentro do sistema.
No OpenBSD, a interface loopback √© a
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4"
>lo(4)</a>.
√â recomendado desabilitar qualquer filtragem nas interfaces loopback;
use <a href="options.html#skip">set skip</a> para fazer isso.
<blockquote><pre>
set skip on lo
</pre></blockquote>
<!-- XXX this should be interface groups, but PF (at least up to
4.8) just does a substring match on the interface name -->
Note que n√≥s estamos usando skip para todas as interfaces <tt>lo</tt>,
dessa maneira n√≥s podemos mais tarde adicionar interfaces
loopback adicionais e n√£o precisamos nos preocupar em alterar essa
parte do nosso arquivo de regras.

<a name="rules"></a>
<h3>Firewall Rules</h3>

Vamos iniciar as regras para suportar o uso de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+5.4"
>ftp-proxy(8)</a> 
para que osclientes de FTP local possam se conectar
a servidores de FTP na internet.
Isso funciona por inserir dinamicamente regras quando uma conex&aatilde;o ftp &eacute; feita.
Isso &eacute; usando um <a href="anchors.html">anchor</a>:
<blockquote><pre>
anchor "ftp-proxy/*"
</pre></blockquote>

<p>
Agora adicionamos a regra necess&aacute;ria para desviar as conex&otilde;es
para que eles sejam visto por ftp-proxy(8):
<blockquote><pre>
pass in quick on $int_if inet proto tcp to any port ftp \
    divert-to 127.0.0.1 port 8021
</pre></blockquote>

<p>
Esta regra ir&aacute; interceptar liga&cedil;&otilde;es de FTP para a porta 21
e desvi&aacute;-las para uma inst√¢ncia ftp-proxy(8) em execu√ß√£o na porta 8021 e,
atrav√©s do uso de palavra-chave <tt>-quick</tt>, pacotes combinando n√£o ser√£o
novamente verificadas em rela√ß√£o ao resto do conjunto de regras 
Se os usu√°rios se conectem a servidores FTP em outras portas,
ent√£o uma lista deve ser usado para especificar a porta de destino,
por exemplo:
<tt>to any port { 21, 2121 }</tt>.

<p>
Note-se que tanto a regra <a href="anchors.html">anchor</a> eo
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+5.4">ftp-proxy(8)</a>
de desvio precisam ser localizados antes de qualquer <tt>match</tt>,
regras de NAT ou o proxy-ftp(8) n√£o vai funcionar como esperado.

<p>
Agora vamos passar para algumas regras o <tt>match</tt>.
Por si s√≥, a regra <tt>match</tt> n√£o determina se ou n√£o o pacote √© permitido passar.
Em vez disso, os pacotes que atendam essa regra ter√° os par√¢metros lembrado,
pois eles v√£o ser usados ‚Äã‚Äãem qualquer regras <tt>pass</tt> que lidam com estes pacotes.

<p>
Isto √© powerful: par√¢metros tais como <a href="nat.html">NAT</a>
 ou <a href="queueing.html">queueing</a> pode ser aplicado a certas
 classes de pacote e, em seguida, as permiss√µes de acesso pode ser definida separadamente.

<p>
Para fazer NAT para toda a rede interna a seguinte regra
<tt>match</tt> √© usada:
<blockquote><pre>
match out on egress inet from !(egress:network) to any nat-to (egress:0)
</pre></blockquote>
 
<p>
Neste caso, o "<tt>!(egress:network)</tt>" pode ser facilmente substitu√≠do por um "<tt>$int_if:network</tt>",
mas se voc√™ adicionou v√°rias interfaces internas, voc√™ teria que adicionar mais regras de NAT,
enquanto que com esta estrutura, NAT ser√£o tratadas em todas as interfaces protegidas.

<p>
J√° que o endere√ßo IP na interface externa √© atribu√≠do dinamicamente,
par√™nteses s√£o colocados ao redor da interface de tradu√ß√£o para
que o PF note quando o endere√ßo mudar.
O sufixo :0 √© usado para que, se a interface external tenha multiplos
endere√ßos, somente o primeiro endere√ßo √© usado para a tradu√ß√£o.

<p>
Por fim, o protocolo familiar <tt>inet</tt> (IPv4) √© ‚Äã‚Äãespecificado.
Isso evita traduzir quaisquer pacotes <tt>inet6</tt> (IPv6), que podem ser recebidos.

<p>
Agora as regras para controlar as permiss√µes de acesso.
Inicia com o bloqueio padr√£o:
<blockquote><pre>
block in log
</pre></blockquote>

<p>
Nesse ponto todo o tr√°fego tentando entrar em uma interface ser√°
bloqueado, mesmo os da interface de rede interna.
Estes pacotes tamb√©m seram registrados.
As regras seguintes abrem o firewall de acordo com os objetivos
descritos acima, e abrem tamb√©m quaisquer interfaces virtuais que se
fa√ßam necess√°rias.

<p>
Tenha em mente que o pf pode bloquear o tr√°fego que entra e sai de uma
interface. Para simplificar sua vida, voc√™ pode escolher fazer a
filtragem de tr√°fego em apenas uma dire√ß√£o em vez de bloquear entrada
e sa√≠da. Em nosso caso optamos por filtrar o tr√°fego de entrada,
mas uma vez filtrada a entrada n√£o tentaremos obstruir sua
sa√≠da, portanto faremos o seguinte:

<blockquote><pre>
pass out quick
</pre></blockquote>

<p>
Ao utilizar <tt>quick</tt>, os pacotes de sa√≠da pode evitar, ser 
verificado contra as seguintes regras, melhorando o desempenho.

<p>
√â bom usar tamb√©m a
<a href="filter.html#antispoof">prote√ß√£o contra falsifica√ß√µes</a>:
<blockquote><pre>
antispoof quick for { lo $int_if }
</pre></blockquote>

<p>
Agora abrimos as portas usadas pelos servi√ßos que estar√£o dispon√≠veis
para a Internet. Primeiro, o tr√°fego que √© destinado ao firewall em si:

<blockquote><pre>
pass in on egress inet proto tcp from any to (egress) \
&nbsp;&nbsp;&nbsp;port $tcp_services
</pre></blockquote>

<p>
Especificar as portas na macro <tt>$tcp_services</tt> simplifica a
abertura de servi√ßos adicionais para a Internet atrav√©s da simples
edi√ß√£o da macro e recarregamento do conjunto de regras.
Servi√ßos UDP tamb√©m podem ser abertos com a cria√ß√£o de uma macro
<tt>$udp_services</tt> e a adi√ß√£o de uma regra de filtragem, similar a
anterior, que especifique <tt>proto udp</tt>.

<p>
A pr√≥xima regra pega qualquer tentativa por algu√©m na Internet para conectar a porta TCP 80 no firewall.
Tentativas leg√≠timas para acessar esta porta ser√£o de usu√°rios que tentam acessar o servidor da rede web.
Estas tentativas de conex√£o devem ser redirecionados para COMP3:

<blockquote><pre>
pass in on egress inet proto tcp to (egress) port 80 rdr-to $comp3
</pre></blockquote>

<p>
Tr√°fego ICMP precisa ser permitido:
<blockquote><pre>
pass in inet proto icmp all icmp-type $icmp_types
</pre></blockquote>

<p>
Similar √† macro <tt>$tcp_services</tt>, a macro <tt>$icmp_types</tt>
pode ser facilmente editada para alterar os tipos de pacotes ICMP que
ter√£o permiss√£o de passar pelo firewall.
Note que essa regra se aplica a todas as interfaces de rede.

<p>
Agora o tr√°fego deve passar "de" e "para" a interface interna.
Assumiremos que os usu√°rios da rede interna sabem o que est√£o fazendo
e n√£o nos causar√£o problemas. Essa n√£o √© necessariamente uma suposi√ß√£o
v√°lida; um conjunto de regras muito mais restritivo pode ser apropriado
para muitos ambientes.
<blockquote><pre>
pass in on $int_if
</pre></blockquote>

<p>
Tr√°fego TCP, UDP e ICMP pode sair do firewall com destino √† Internet
de acordo com a linha "<tt>pass out</tt>" anterior.
A informa√ß√£o de estado das conex√µes √© mantida de forma que pacotes que
retornam passar√£o pelo firewall.

<a name="allrules"></a>
<h2>O Conjunto de Regras Completo</h2>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# Macros
ext_if="fxp0"

int_if="xl0"

tcp_services="{ 22, 113 }"
icmp_types="echoreq"

comp3="192.168.0.3"

# Op√ß√µes
set block-policy return
set loginterface egress

set skip on lo

# FTP Proxy rules

anchor "ftp-proxy/*"

pass in quick on $int_if inet proto tcp to any port ftp \
&nbsp;&nbsp;&nbsp;divert-to 127.0.0.1 port 8021
 
# match rules

match out on egress inet from !(egress:network) to any nat-to (egress:0)

# Regras de filtragem
block in log
pass out quick

antispoof quick for { lo $int_if }

pass in on egress inet proto tcp from any to (egress) \
&nbsp;&nbsp;&nbsp;port $tcp_services

pass in on egress inet proto tcp to (egress) port 80 rdr-to $comp3

pass in inet proto icmp all icmp-type $icmp_types

pass in on $int_if
</pre>
</td></tr>
</table>

<p>
[<a href="carp.html">Anterior: Redund√¢ncia de Firewall com CARP
e pfsync</a>]
[<a href="index.html">Conte√∫do</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@@openbsd.org">www@@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: example1.html,v 1.54 ]<br>
$Translation: example1.html,v 1.17 2013/12/01 12:44:32 egypcio Exp $<br>
-->
$OpenBSD: example1.html,v 1.17 2013/12/06 20:52:46 ajacoutot Exp $
</small>

</body>
</html>
@


1.17
log
@Sync with Steelix CVS
@
text
@d443 1
a443 1
$OpenBSD$
@


1.16
log
@Sync with Steelix CVS
@
text
@d144 1
a144 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+5.3"
d218 1
a218 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+5.3"
d248 1
a248 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+5.3">ftp-proxy(8)</a>
d440 2
a441 2
Originally [OpenBSD: example1.html,v 1.53 ]<br>
$Translation: example1.html,v 1.16 2013/05/02 22:48:46 renato Exp $<br>
@


1.15
log
@Sync with Steelix CVS
@
text
@d144 1
a144 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+5.2"
d218 1
a218 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+5.2"
d248 1
a248 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+5.2">ftp-proxy(8)</a>
d440 2
a441 2
Originally [OpenBSD: example1.html,v 1.52 ]<br>
$Translation: example1.html,v 1.15 2013/03/23 20:28:55 renato Exp $<br>
@


1.14
log
@Sync with Steelix CVS
@
text
@d4 1
a4 1
<title>PF: Exemplo: Firewall para Casa ou Pequeno EscritÛrio</title>
d6 1
a6 1
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
d38 1
a38 1
[<a href="carp.html">Anterior: Redund‚ncia de Firewall com CARP
d40 1
a40 1
[<a href="index.html">Conte˙do</a>]
d44 1
a44 1
EscritÛrio</font></h1>
d47 1
a47 1
<h3>Conte˙do</h3>
d49 1
a49 1
<li><a href="#scenario">O Cen·rio</a>
d53 1
a53 1
	<li><a href="#prep">PreparaÁ„o</a>
d58 3
a60 5
	<li><a href="#options">OpÁıes</a>
	<li><a href="#scrub">Scrub</a>
	<li><a href="#nat">TraduÁ„o do EndereÁo de Rede (NAT)</a>
	<li><a href="#rdr">Redirecionamento</a>
	<li><a href="#filter">Regras de Filtragem</a>
d68 5
a72 5
<h2>O Cen·rio</h2>
Neste exemplo, o PF est· em execuÁ„o em uma m·quina OpenBSD agindo como
firewall e gateway NAT para uma pequena rede em casa ou no escritÛrio. O
objetivo geral È prover acesso ‡ Internet para a rede interna e acesso
limitado ao firewall de conexıes provenientes da Internet, e ainda
d74 1
a74 1
interna. Este documento guia-o atravÈs da criaÁ„o de um conjunto de
d79 1
a79 1
A rede est· configurada da seguinte forma:
d92 5
a96 5
Existem v·rios computadores na rede interna; o diagrama mostra apenas
trÍs, mas o n˙mero real È irrelevante. Esses computadores s„o
estaÁıes de trabalho usadas para navegar na Internet, ler
mensagens de correio eletrÙnico, usar programas de bate-papo virtual,
etc., exceto COMP3, que tambÈm roda um pequeno servidor Web.
d100 1
a100 1
O firewall OpenBSD È um Celeron 300 com duas placas de rede:
d103 3
a105 3
Ele possui uma conex„o a cabo com a Internet e faz NAT para compartilhar
o acesso com a rede interna. O endereÁo IP na interface externa È
atribuÌdo dinamicamente pelo Provedor de Acesso ‡ Internet.
d109 1
a109 1
Os Objetivos s„o:
d111 3
a113 3
<li>Prover acesso irrestrito ‡ Internet para a rede interna.
<li>Usar "negar por padr„o" como polÌtica padr„o do conjunto de regras.
<li>Permitir o seguinte tr·fego vindo da Internet para o firewall:
d115 1
a115 1
	<li>SSH (porta TCP 22): ser· utilizado para manutenÁ„o
d118 2
a119 2
	    serviÁos como SMTP e IRC.
	<li>RequisiÁıes de Eco ICMP: o tipo de pacote ICMP usado pelo
d124 3
a126 3
<li>Redirecionar tentativas de conex„o na porta TCP 80 (que s„o
    tentativas de conex„o a um servidor Web) para o computador COMP3.
    E tambÈm permitir tr·fego TCP na porta 80 destinado a COMP3 atravÈs
d128 5
a132 5
<li>Registrar as estatÌsticas de filtragem na interface externa.
<li>Por padr„o, responder os pacotes bloqueados com um pacote TCP RST
    ou ICMP de InalcanÁ·vel.
<li>Tornar o conjunto de regras o mais simples possÌvel, para facilitar
    a manutenÁ„o.</ul>
d135 4
a138 4
<h3>PreparaÁ„o</h3>
Este documento assume que a m·quina OpenBSD tenha sido corretamente
configurada para funcionar como roteador, incluindo a configuraÁ„o de
endereÁos IP, conectividade com a Internet e a definiÁ„o das vari·veis
d143 3
a145 3
TambÈm È necess·rio que vocÍ tenha ativado o PF usando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.6"
>pfctl(8)</a> ou definindo a vari·vel apropriada em
d150 1
a150 1
A seguir um passo a passo atravÈs do conjunto de regras que realizar„o
d155 1
a155 1
As seguintes macros s„o definidas para facilitar a leitura e manutenÁ„o
d157 2
a158 4
<blockquote>
<tt>
ext_if="fxp0"<br>
int_if="xl0"<br>
d164 1
a164 2
</tt>
</blockquote>
d167 17
a183 15
As primeiras duas linhas definem as interfaces de rede onde a filtragem
acontecer·.
Definindo elas aqui, se precisarmos mover esse sistema para outra
m·quina com hardware diferente, podemos alterar apenas essas duas
linhas e o resto das regras continuar„o utiliz·veis.
A terceira e quarta linha listam os n˙meros de portas TCP dos serviÁos
que ser„o abertos para a Internet (SSH e ident/auth) e os tipos de
pacotes ICMP que ter„o permiss„o de alcanÁar a m·quina do firewall.
Finalmente, a ˙ltima linha define o endereÁo IP de COMP3.

<p>
<b>Nota</b>: Caso a conex„o com a Internet necessite do
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8"
>PPPoE</a>, ent„o filtragem e NAT devem acontecer na interface
<tt>tun0</tt> e <i>n„o</i> em <tt>fxp0</tt>.
d186 5
a190 6
<h3>OpÁıes</h3>
As duas opÁıes seguintes s„o respons·veis pela definiÁ„o da resposta
padr„o para regras de filtragem <tt>block</tt> e pelo "ativamento" do
registro de estatÌsticas para a interface externa:
<blockquote>
<tt>
d192 2
a193 3
set loginterface $ext_if
</tt>
</blockquote>
d197 1
a197 1
Esta È uma interface de rede virtual que È utilizada por aplicativos
d199 1
a199 1
No OpenBSD, a interface loopback È a
d202 1
a202 1
… recomendado desabilitar qualquer filtragem nas interfaces loopback;
d204 1
a204 2
<blockquote>
<tt>
d206 6
a211 5
</tt>
</blockquote>
Note que nÛs estamos usando skip no grupo de interface <tt>lo</tt>
inteiro, dessa maneira nÛs podemos mais tarde adicionar interfaces
loopback adicionais e n„o precisamos nos preocupar em alterar essa
d214 78
a291 84
<a name="scrub"></a>
<h3>Scrub</h3>
N„o h· raz„o para n„o utilizar "scrubbing", recomendado para todo
tr·fego de entrada; portanto, aplicamos a regra com uma simples linha:
<blockquote>
<tt>
match in all scrub (no-df)
</tt>
</blockquote>

<a name="nat"></a>
<h3>TraduÁ„o do EndereÁo de Rede (NAT)</h3>
Para fazer NAT para toda a rede interna, a seguinte regra <tt>nat</tt>
È usada:
<blockquote>
<tt>
nat on $ext_if from !($ext_if) to any -&gt; ($ext_if)
</tt>
</blockquote>

<p>
O "<tt>!($ext_if)</tt>" poderia ser facilmente substituÌdo por
"<tt>$int_if</tt>" nesse caso, mas caso vocÍ tenha m˙ltiplas interfaces
internas, vocÍ precisaria ter que adicionar mais regras NAT, ao passo
que, com essa estrutura, a NAT ser· feita em todas as interfaces
protegidas.

<p>
J· que o endereÁo IP da interface externa È atribuÌdo dinamicamente,
parÍntesis devem ser colocados em volta da interface de traduÁ„o,
assim o PF notar· qualquer alteraÁ„o no endereÁo.

<p>
Como queremos que o proxy FTP funcione, adicionaremos uma
<a href="anchors.html">‚ncora</a> NAT tambÈm:

<blockquote>
<tt>
nat-anchor "ftp-proxy/*"
</tt>
</blockquote>


<a name="rdr"></a>
<h3>Redirecionamento</h3>
As primeiras regras de redirecionamento s„o necess·rias para o
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.6"
>ftp-proxy(8)</a>,
assim os clientes FTP na rede interna local podem se conectar
a servidores FTP na Internet.
<blockquote>
<tt>
rdr-anchor "ftp-proxy/*"<br>
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 port 8021
</tt>
</blockquote>

<p>
Note que essa regra somente captura conexıes destinadas ‡ porta 21.
Caso usu·rios se conectem a servidores FTP em outras portas,
ent„o uma lista deve ser utilizada para especificar as portas
de destino, por exemplo: <tt>from any to any port { 21, 2121 }</tt>.

<p>
A ˙ltima regra de redirecionamento captura qualquer tentativa de conex„o
vinda da Internet em direÁ„o ‡ porta TCP 80 no firewall.
Tentativas legÌtimas de conex„o nessa porta ser„o de usu·rios tentando
acessar o servidor Web da rede.
Essas tentativas de conex„o devem ser redirecionadas para COMP3:

<blockquote>
<tt>
rdr on $ext_if proto tcp from any to any port 80 -&gt; $comp3
</tt>
</blockquote>

<a name="filter"></a>
<h3>Regras de Filtragem</h3>
Agora as regras de filtragem. ComeÁando com negar por padr„o:
<blockquote>
<tt>
block in<br>
</tt>
</blockquote>
d294 1
a294 1
Nesse ponto todo o tr·fego tentando entrar em uma interface ser·
d296 1
d298 2
a299 2
descritos acima, e abrem tambÈm quaisquer interfaces virtuais que se
faÁam necess·rias.
d302 14
a315 21
Tenha em mente que o pf pode bloquear o tr·fego que entra e sai de uma
interface. Para simplificar sua vida, vocÍ pode escolher fazer a
filtragem de tr·fego em apenas uma direÁ„o em vez de bloquear entrada
e saÌda. Em nosso caso optamos por filtrar o tr·fego de entrada,
mas uma vez filtrada a entrada n„o tentaremos obstruir sua
saÌda, portanto faremos o seguinte:

<blockquote>
<tt>
pass out keep state
</tt>
</blockquote>

<p>
Precisamos ter uma <a href="anchors.html">‚ncora</a> para o
ftp-proxy(8):
<blockquote>
<tt>
anchor "ftp-proxy/*"
</tt>
</blockquote>
d317 4
a320 4
… bom usar tambÈm a
<a href="filter.html#antispoof">proteÁ„o contra falsificaÁıes</a>:
<blockquote>
<tt>
d322 1
a322 2
</tt>
</blockquote>
d325 2
a326 2
Agora abrimos as portas usadas pelos serviÁos que estar„o disponÌveis
para a Internet. Primeiro, o tr·fego que È destinado ao firewall em si:
d328 4
a331 6
<blockquote>
<tt>
pass in on $ext_if inet proto tcp from any to ($ext_if) \<br>
&nbsp;&nbsp;&nbsp;port $tcp_services flags S/SA keep state
</tt>
</blockquote>
d335 4
a338 4
abertura de serviÁos adicionais para a Internet atravÈs da simples
ediÁ„o da macro e recarregamento do conjunto de regras.
ServiÁos UDP tambÈm podem ser abertos com a criaÁ„o de uma macro
<tt>$udp_services</tt> e a adiÁ„o de uma regra de filtragem, similar a
d342 7
a348 22
AlÈm de ter uma regra <tt>rdr</tt> que redireciona o tr·fego do servidor
Web para COMP3, ainda PRECISAMOS permitir a passagem do tr·fego atravÈs
do firewall:
<blockquote>
<tt>
pass in on $ext_if inet proto tcp from any to $comp3 port 80 \<br>
&nbsp;&nbsp;&nbsp;&nbsp;flags S/SA synproxy state
</tt>
</blockquote>

<p>
Para aumentar um pouco a seguranÁa, faremos uso do
<a href="filter.html#synproxy">Proxy de Pacotes TCP SYN</a>
com o intuito de proteger o servidor Web.

<p>
Tr·fego ICMP precisa ser permitido:
<blockquote>
<tt>
pass in inet proto icmp all icmp-type $icmp_types keep state
</tt>
</blockquote>
d351 7
a357 1
Similar ‡ macro <tt>$tcp_services</tt>, a macro <tt>$icmp_types</tt>
d359 1
a359 1
ter„o permiss„o de passar pelo firewall.
d363 4
a366 4
Agora o tr·fego deve passar "de" e "para" a interface interna.
Assumiremos que os usu·rios da rede interna sabem o que est„o fazendo
e n„o nos causar„o problemas. Essa n„o È necessariamente uma suposiÁ„o
v·lida; um conjunto de regras muito mais restritivo pode ser apropriado
d368 3
a370 5
<blockquote>
<tt>
pass in quick on $int_if
</tt>
</blockquote>
d373 4
a376 4
Tr·fego TCP, UDP e ICMP pode sair do firewall com destino ‡ Internet
de acordo com a linha "<tt>pass out keep state</tt>" anterior.
A informaÁ„o de estado das conexıes È mantida de forma que pacotes que
retornam passar„o pelo firewall.
d385 1
d393 1
a393 1
# OpÁıes
d395 1
a395 1
set loginterface $ext_if
d399 1
a399 2
# Scrub
match in all scrub (no-df)
d401 6
a406 4
# Nat/rdr
nat on $ext_if from !($ext_if) -> ($ext_if:0)
nat-anchor "ftp-proxy/*"
rdr-anchor "ftp-proxy/*"
d408 1
a408 2
rdr pass on $int_if proto tcp to port ftp -> 127.0.0.1 port 8021
rdr on $ext_if proto tcp from any to any port 80 -> $comp3
d411 2
a412 1
block in
a413 3
pass out keep state

anchor "ftp-proxy/*"
d416 2
a417 2
pass in on $ext_if inet proto tcp from any to ($ext_if) \
   port $tcp_services flags S/SA keep state
d419 1
a419 2
pass in on $ext_if inet proto tcp from any to $comp3 port 80 \
    flags S/SA synproxy state
d421 1
a421 1
pass in inet proto icmp all icmp-type $icmp_types keep state
d423 1
a423 1
pass in quick on $int_if
d429 1
a429 1
[<a href="carp.html">Anterior: Redund‚ncia de Firewall com CARP
d431 1
a431 1
[<a href="index.html">Conte˙do</a>]
d440 2
a441 2
Originally [OpenBSD: example1.html,v 1.39 ]<br>
$Translation: example1.html,v 1.14 2009/10/18 16:52:52 alan Exp $<br>
@


1.13
log
@Sync with Steelix CVS
@
text
@d146 1
a146 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.5"
d221 2
a222 2
N„o h· raz„o para n„o utilizar scrubbing, recomendado para todo tr·fego
de entrada; portanto, aplicamos a regra com uma simples linha:
d225 1
a225 1
scrub in
d265 1
a265 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.5"
d430 1
a430 1
scrub in
d473 2
a474 2
Originally [OpenBSD: example1.html,v 1.38 ]<br>
$Translation: example1.html,v 1.13 2009/10/13 19:12:27 alan Exp $<br>
@


1.12
log
@Sync with Steelix CVS
@
text
@d52 1
a52 1
	<li><a href="#objective">Objetivo</a>
d55 1
a55 1
<li><a href="#ruleset">As Regras</a>
d64 1
a64 1
<li><a href="#allrules">O Arquivo Completo</a>
d71 2
a72 2
Neste exemplo, o PF est· rodando numa m·quina OpenBSD agindo como
firewall e gateway NAT para uma pequena rede em casa ou escritÛrio. O
d74 4
a77 3
limitado ao firewall pela Internet, e ainda disponibilizar para acesso
externo um servidor web localizado na rede Interna. Este documento o
guiar· na criaÁ„o de um conjunto de regras para esse fim.
d96 4
a99 3
estaÁıes de trabalho usadas para navegar na Internet, ler email, chat,
etc., exceto COMP3 que tambÈm roda um pequeno servidor web.
A rede interna usa a faixa de ips 192.168.0.0 / 255.255.255.0.
d105 2
a106 2
Ele possui uma conex„o Internet a Cabo e faz NAT para compartilhar o
acesso com a rede interna. O endereÁo IP na interface externa È
d110 1
a110 1
<h3>Objetivo</h3>
d114 1
a114 1
<li>Usar "negar por padr„o" como polÌtica padr„o de regras.
d117 2
a118 2
	<li>SSH (porta TCP 22): ser· utilizado para manutenÁ„o remota
            do firewall.
d121 2
a122 2
	<li>ICMP Echo Requests: o tipo de pacote ICMP usado pelo comando
            <a
d126 9
a134 9
<li>Redirecionar tentativas de conex„o na porta 80 TCP (que s„o
    tentativas de conex„o a um servidor web) para o computador COMP3.
    TambÈm permitir trafego TCP na porta 80 destinado a COMP3 atravÈs do
    firewall.
<li>Logar estatÌsticas de filtragem na interface externa.
<li>Por padr„o, responder com um TCP RST ou ICMP Unreachable para
    pacotes bloqueados.
<li>Tornar as regras o mais simples possÌvel, para facilitar a
    manutenÁ„o.</ul>
d138 4
a141 3
Este documento assume que o host OpenBSD tenha sido corretamente
configurado para funcionar como roteador, incluindo configuraÁ„o de
endereÁos IP, conectividade com a Internet e definiÁ„o das vari·veis
d151 3
a153 3
<h2>As regras</h2>
A seguir um passo a passo atravÈs das regras que realizar„o os
objetivos acima descritos.
d157 2
a158 2
As seguintes macros s„o definidas para facilitar a leitura e
manutenÁ„o das regras:
d172 1
a172 1
As primeiras duas linhas definem a interface de rede onde a filtragem
d175 4
a178 4
m·quina com hardware diferente, nÛs trocamos apenas essas duas linhas
e o resto das regras continuar„o as mesmas.
A terceira e quarta linhas listam os n˙meros de portas TCP dos serviÁos
que ser„o abertos para a internet (SSH e ident/auth) e os tipos de
d183 1
a183 1
<b>Nota</b>: Caso a conex„o com a Internet necessite
d185 1
a185 1
>PPPoE</a>, ent„o, filtragem e NAT devem acontecer na interface
d190 3
a192 3
As duas opÁıes seguintes definem a resposta padr„o <tt>block</tt> para
regras de filtragem, e fazem com que sejam logadas estatÌsticas de
filtragem (statistics logging "on") para a interface externa:
d202 3
a204 3
… uma interface de rede virtual que È utilizada por aplicaÁıes para
conversarem entre si dentro do sistema.
No OpenBSD, a interface loopback È
d207 2
a208 3
… recomendado desabilitar qualquer filtragem nas interfaces
loopback.
Usando <a href="options.html#skip">set skip</a> para isso.
d215 1
a215 1
inteiro, dessa maneira nÛs podemos, mais tarde, adicionar interfaces
d222 1
a222 1
entrante, portanto aplicamos a regra com uma simples linha:
d231 2
a232 2
Para fazer NAT para toda a rede interna, a seguinte regra
<tt>nat</tt> ser· usada:
d240 5
a244 4
O "<tt>!($ext_if)</tt>" pode ser substituÌdo por "<tt>$int_if</tt>"
nesse caso, mas caso vocÍ tenha m˙ltiplas interfaces, precisar·
adicionar mais regras NAT, ao passo que, com essa estrutura o NAT
ser· feito em todas as interfaces protegidas.
d248 2
a249 2
parÍnteses devem ser colocados em volta da interface, assim o PF notar·
qualquer alteraÁ„o no endereÁo.
d264 1
a264 1
As primeiras regras de redirecionamento necess·rias s„o para o
d267 1
a267 1
assim, clientes FTP na rede interna local poder„o se conectar
d277 1
a277 2
Note que essa regra funcionar· apenas com conexıes destinadas ‡
porta 21.
d283 5
a287 5
As ˙ltimas regras de redirecionamento pegam qualquer tentativa
de conex„o vinda da Internet em direÁ„o ‡ porta TCP 80 no firewall.
Tentativas de conexıes legÌtimas nessa porta, ser„o de usu·rios tentando
acessar o servidor web da rede.
Essas conexıes devem ser redirecionadas para COMP3:
d307 3
a309 3
As regras seguintes abrem o firewall de acordo com os objetivos acima
descritos, bem como quaisquer interfaces virtuais que se faÁam
necess·rias.
d312 6
a317 7
Tenha em mente que o pf pode bloquear tr·fego entrando e saindo
de uma interface.
Para simplificar sua vida, vocÍ pode escolher fazer a filtragem de
tr·fego em apenas uma direÁ„o em vez de bloquear entrada e saÌda.
Em nosso caso, optamos por filtrar tr·fego entrando na interface,
uma vez filtrada a entrada, n„o tentaremos obstruir sua saÌda,
portanto faremos o seguinte:
d335 1
a335 1
<a href="filter.html#antispoof">proteÁ„o antispoof</a>:
d344 1
a344 2
para a Internet.
Primeiro, o tr·fego que È destinado ao firewall em si:
d355 2
a356 2
abertura de serviÁos adicionais para a Internet atravÈs da
simples ediÁ„o da macro e recarregamento das regras.
d358 1
a358 1
<tt>$udp_services</tt> e a adiÁ„o de uma regra de filtragem similar a
d362 3
a364 3
AlÈm de ter uma regra <tt>rdr</tt> que redireciona o tr·fego do
servidor web para COMP3, ainda PRECISAMOS permitir a passagem do
tr·fego atravÈs do firewall:
d373 3
a375 3
Para aumentar um pouco a seguranÁa, faremos uso de
<a href="filter.html#synproxy">TCP SYN Proxy</a> com o intuito de
proteger o servidor web.
d386 3
a388 3
Similar ‡ macro <tt>$tcp_services</tt>, a macro
<tt>$icmp_types</tt> pode ser facilmente editada para alterar os tipos
de pacotes ICMP que ter„o permiss„o de passar pelo firewall.
d395 2
a396 2
v·lida; um conjunto de regras muito mais restritivo pode ser
apropriado para muitos ambientes.
d405 1
a405 1
de acordo com a regra "<tt>pass out keep state</tt>" anterior.
d410 1
a410 1
<h2>O Conjunto Completo de Regras</h2>
d452 1
a452 1
   flags S/SA synproxy state
d474 1
a474 1
$Translation: example1.html,v 1.12 2009/05/10 17:44:16 alan Exp $<br>
@


1.11
log
@Sync with Steelix CVS
@
text
@d143 1
a143 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.4"
d262 1
a262 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.4"
d473 2
a474 2
Originally [OpenBSD: example1.html,v 1.37 ]<br>
$Translation: example1.html,v 1.11 2009/03/11 00:52:55 dsantos Exp $<br>
@


1.10
log
@Sync with Steelix CVS
@
text
@d4 1
a4 1
<title>PF: Exemplo: Firewall para Casa ou Pequeno Escrit&oacute;rio</title>
d8 3
a10 3
<meta name="description" content="the OpenBSD FAQ page">
<meta name="keywords" content="openbsd,faq,pf">
<meta name="distribution" content="global">
a36 1

d38 3
a40 2
[<a href="carp.html">Anterior: Redund&acirc;ncia de Firewall com CARP e pfsync</a>]
[<a href="index.html">Conte&uacute;do</a>]
d43 2
a44 1
<h1><font color="#e00000">PF: Exemplo: Firewall para Casa ou Pequeno Escrit&oacute;rio</font></h1>
d47 1
a47 1
<h3>Conte&uacute;do</h3>
d49 1
a49 1
<li><a href="#scenario">O Cen&aacute;rio</a>
d53 1
a53 1
	<li><a href="#prep">Prepara&ccedil;&atilde;o</a>
d58 1
a58 1
	<li><a href="#options">Op&ccedil;&otilde;es</a>
d60 1
a60 1
	<li><a href="#nat">Tradu&ccedil;&atilde;o do Endere&ccedil;o de Rede (NAT)</a>
d70 7
a76 9
<h2>O Cen&aacute;rio</h2>
Neste exemplo, PF est&aacute; rodando numa m&aacute;quina OpenBSD 
agindo como firewall e gateway NAT para uma pequena rede em casa ou 
escrit&oacute;rio. O objetivo geral &eacute; prover acesso &agrave; 
Internet para a rede interna e acesso limitado
ao firewall pela Internet, e ainda disponibilizar para acesso externo
um servidor web localizado na rede Interna. Este documento o 
guiar&aacute; na cria&ccedil;&atilde;o de um conjunto de regras para 
esse fim.
d80 3
a82 1
A rede est&aacute; configurada da seguinte forma:
a83 2
<pre>   
 
d93 4
a96 5
Existem v&aacute;rios computadores na rede interna; o diagrama mostra apenas
tr&ecirc;s, mas o n&uacute;mero real &eacute; irrelevante.  Estes computadores 
s&atilde;o esta&ccedil;&otilde;es de trabalho usadas para navegar na Internet, 
ler email, chat, etc., exceto COMP3 que tamb&eacute;m roda um pequeno servidor 
web.
d100 2
a101 2
O firewall OpenBSD &eacute; um Celeron 300 com duas placas de rede: 
uma 3com 3c905B (<tt>xl0</tt>) e uma Intel EtherExpress Pro/100 
d103 3
a105 4
Ele possui uma conex&atilde;o Internet a Cabo e faz NAT para 
compartilhar o acesso com a rede interna. O endere&ccedil;o IP na 
interface externa &eacute; atribu&iacute;do dinamicamente pelo 
Provedor de Acesso Internet.
d109 1
a109 1
Os Objetivos s&atilde;o:
d111 3
a113 4
<li>Prover acesso irrestrito &agrave; Internet para a rede interna.
<li>Usar "negar por padr&atilde;o" como pol&iacute;tica padr&atilde;o 
de regras.
<li>Permitir o seguinte tr&aacute;fego vindo da Internet para o firewall:
d115 8
a122 8
	<li>SSH (porta TCP 22): ser&aacute; utilizado para 
	manuten&ccedil;&atilde;o remota do firewall.
	<li>Auth/Ident (porta TCP 113): utilizado por alguns 
	servi&ccedil;os como SMTP e IRC.
	<li>ICMP Echo Requests: o tipo de pacote ICMP usado pelo comando 
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8"
>ping(8)</a>.
d124 9
a132 10
<li>Redirecionar tentativas de conex&atilde;o na porta 80 TCP (que 
s&atilde;o tentativas de conex&atilde;o a um servidor web) para o 
computador COMP3.
Tamb&eacute;m permitir trafego TCP porta 80 destinado a COMP3 
atrav&eacute;s do firewall.
<li>Logar estat&iacute;sticas de filtragem na interface externa.
<li>Por padr&atilde;o, responder com um TCP RST ou ICMP Unreachable para 
pacotes bloqueados.
<li>Tornar as regras o mais simples poss&iacute;vel, para facilitar a
manuten&ccedil;&atilde;o.</ul>
d135 5
a139 7
<h3>Prepara&ccedil;&atilde;o</h3>
Este documento assume que o host OpenBSD tenha sido corretamente 
configurado para funcionar como roteador, incluindo 
configura&ccedil;&atilde;o de endere&ccedil;os IP, conectividade com a 
Internet e defini&ccedil;&atilde;o de variaveis
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=3"
d142 3
a144 4
Tamb&eacute;m &eacute; necess&aacute;rio que voc&ecirc; tenha ativado 
o PF usando <a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.2"
>pfctl(8)</a> ou definindo a vari&aacute;vel apropriada em
d149 1
a149 1
A seguir um passo a passo atrav&eacute;s das regras que realizar&atilde;o os 
d154 2
a155 2
As seguintes macros s&atilde;o definidas para facilitar a leitura e 
manuten&ccedil;ao das regras:
d169 15
a183 20
As primeiras duas linhas definem a interface de rede onde a filtragem 
acontecer&aacute;. 
Definindo elas aqui, se precisarmos mover este sistema
para outra m&aacute;quina com hardware diferente, n&oacute;s
trocamos apenas estas duas linhas e o resto das regras 
continuar&aacute; a mesma.

A terceira e quarta linhas listam os n&uacute;meros 
de portas TCP dos servi&ccedil;os que ser&atilde;o abertos para a 
internet (SSH e ident/auth) e os tipos de pacotes ICMP que 
ter&atilde;o permiss&atilde;o de alcan&ccedil;ar a m&aacute;quina do 
firewall. 
Finalmente, a &uacute;ltima linha define o endere&ccedil;o IP de COMP3.

<p>
<b>Nota</b>: Caso a conex&atilde;o com a Internet necessite
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8"
>PPPoE</a>, ent&atilde;o, filtragem e NAT devem acontecer na interface 
<tt>tun0</tt> <i>n&atilde;o</i> em <tt>fxp0</tt>.
d186 4
a189 5
<h3>Op&ccedil;&otilde;es</h3>
As duas op&ccedil;&otilde;es seguintes definem a resposta padr&atilde;o
<tt>block</tt> para regras de filtragem, e fazem com que sejam logadas
estat&iacute;sticas de filtragem (statistics logging "on") para a 
interface externa:
d199 4
a202 5
&Eacute; uma interface de rede virtual que &eacute; utilizada por
aplica&ccedil;&otilde;es para conversarem entre si dentro do sistema.
No OpenBSD, a interface loopback &eacute;
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4"
d204 1
a204 1
&Eacute; recomendado desabilitar qualquer filtragem nas interfaces
d206 1
a206 1
Usando <a href="options.html#skip">set skip</a> para isto.
d212 4
a215 4
Note que n&oacute;s estamos usando skip no grupo de interface 
<tt>lo</tt> inteiro, desta maneira n&oacute;s podemos, mais tarde,
adicionar interfaces loopback adicionais e n&atilde;o precisamos
nos preocupar em alterar esta parte do nosso arquivo de regras.
d219 2
a220 3
N&atilde;o h&aacute; raz&atilde;o para n&atilde;o utilizar scrubbing, 
recomendado para todo tr&aacute;fego entrante, portanto aplicamos a 
regra com uma simples linha:
d228 3
a230 3
<h3>Tradu&ccedil;&atilde;o do Endere&ccedil;o de Rede (NAT)</h3>
Para fazer NAT para toda a rede interna a seguinte regra
<tt>nat</tt> ser&aacute; usada:
d238 4
a241 5
O "<tt>!($ext_if)</tt>" pode ser substitu&iacute;do por 
"<tt>$int_if</tt>" neste caso, mas caso voc&ecirc; tenha 
v&aacute;rias interfaces precisar&aacute; adicionar mais regras 
NAT, ao passo que, com esta estrutura o NAT ser&aacute; feito em 
todas as interfaces protegidas.
d244 3
a246 4
J&aacute; que o endere&ccedil;o IP da interface externa &eacute; 
atribu&iacute;do dinamicamente, par&ecirc;nteses devem ser colocados 
em volta da interface, assim o PF notar&aacute; qualquer 
altera&ccedil;&atilde;o no endere&ccedil;o.
d249 2
a250 2
Como queremos que o proxy FTP funcione, adicionaremos uma 
<a href="anchors.html">&acirc;ncora</a> NAT tamb&eacute;m:
d261 4
a264 6
As primeiras regras de redirecionamento necess&aacute;rias s&atilde;o 
para o
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.2"
>ftp-proxy(8)</a> 
assim, clientes FTP na rede interna local, poder&atilde;o se conectar 
d274 4
a277 4
Note que esta regra funcionar&aacute; apenas com conex&otilde;es 
destinadas &agrave; porta 21.
Caso usu&aacute;rios se conectem a servidores FTP em outras portas, 
ent&atilde;o uma lista deve ser utilizada para especificar as portas 
d281 5
a285 6
As &uacute;ltimas regras de redirecionamento pegam qualquer tentativa 
de conex&atilde;o vinda da Internet em dire&ccedil;&atilde;o &agrave; 
porta 80 TCP no firewall.
Tentativas de conex&otilde;es leg&iacute;timas nesta porta 
ser&atilde;o de usu&aacute;rios tentando acessar o servidor web da rede.
Estas conex&otilde;es devem ser redirecionadas para COMP3:
d295 1
a295 2
Agora as regras de filtragem. Come&ccedil;ando com negar por 
padr&atilde;o:
d303 5
a307 5
Neste ponto todo tr&aacute;fego tentando entrar em uma interface 
ser&aacute; bloqueado, mesmo estes da interface de rede interna.
As regras seguintes abrem o firewall de acordo com os objetivos acima 
descritos, bem como quaisquer interfaces virtuais que se fa&ccedil;am 
necess&aacute;rias.
d310 1
a310 1
Tenha em mente que o pf pode bloquear tr&aacute;fego entrando e saindo 
d312 5
a316 6
Para simplificar sua vida voc&ecirc; pode escolher fazer a filtragem de
tr&aacute;fego em apenas uma dire&ccedil;&atilde;o ao inv&eacute;s de 
bloquear entrada e sa&iacute;da.
Em nosso caso optamos por filtrar tr&aacute;fego entrando na interface, 
uma vez filtrada a entrada, n&atilde;o tentaremos obstruir sua 
sa&iacute;da, portanto faremos o seguinte:
d325 2
a326 3
Precisamos ter uma <a href="anchors.html">&acirc;ncora</a> 
para o ftp-proxy(8):

d333 2
a334 4
<p>
&Eacute; bom usar tamb&eacute;m a 
<a href="filter.html#antispoof">prote&ccedil;&atilde;o antispoof</a>:

d342 3
a344 3
Agora abrimos as portas usadas pelos servi&ccedil;os que estar&atilde;o
dispon&iacute;veis para a Internet.
Primeiro, o tr&aacute;fego que &eacute; destinado ao firewall em si:
d354 5
a358 6
Especificando as portas na macro <tt>$tcp_services</tt> simplifica a
abertura de servi&ccedil;os adicionais para a Internet atrav&eacute;s da
simples edi&ccedil;&atilde;o da macro e recarregamento das regras.
Servi&ccedil;os UDP tamb&eacute;m podem ser abertos com a 
cria&ccedil;&atilde;o de uma macro <tt>$udp_services</tt> e 
adi&ccedil;&atilde;o de uma regra de filtragem similar &agrave; 
d362 3
a364 3
Al&eacute;m de ter uma regra <tt>rdr</tt> que redireciona o 
tr&aacute;fego do servidor web para COMP3, ainda PRECISAMOS
permitir a passagem do tr&aacute;fego atrav&eacute;s do firewall:
d373 2
a374 2
Para aumentar um pouco a seguran&ccedil;a, faremos uso de 
<a href="filter.html#synproxy">TCP SYN Proxy</a> com intuito de 
d378 1
a378 1
Tr&aacute;fego ICMP precisa ser permitido:
d386 4
a389 4
Similar &agrave; macro <tt>$tcp_services</tt>, a macro 
<tt>$icmp_types</tt> pode ser facilmente editada para alterar os tipos 
de pacotes ICMP que ter&atilde;o permiss&atilde;o de passar pelo 
firewall. Note que esta regra se aplica a todas interfaces de rede.
d392 4
a395 5
Agora o tr&aacute;fego deve passar "de" e "para" a interface interna.
Assumiremos que os usu&aacute;rios da rede interna sabem o que 
est&atilde;o fazendo e n&atilde;o nos causar&atilde;o problemas.  Esta 
n&atilde;o &eacute; necessariamente uma suposi&ccedil;&atilde;o 
v&aacute;lida; um conjunto de regras muito mais restritivo pode ser 
d404 4
a407 5
Tr&aacute;fego TCP, UDP e ICMP pode sair do firewall com destino 
&agrave; Internet de acordo com a regra "<tt>pass out keep state</tt>"
anterior.
A informa&ccedil;&atilde;o de estado das conex&otilde;es &eacute; 
mantida de forma que pacotes que retornam passar&atilde;o pelo firewall.
d414 1
a414 1
# macros
d423 1
a423 1
# op&ccedil;&otilde;es
d429 1
a429 1
# scrub
d432 2
a433 2
# nat/rdr
nat on $ext_if from !($ext_if) -> ($ext_if:0) 
d440 1
a440 1
# regras de filtragem
d445 1
a445 1
anchor "ftp-proxy/*" 
d452 1
a452 1
   flags S/SA synproxy state 
a456 1

d462 3
a464 2
[<a href="carp.html">Anterior: Redund&acirc;ncia de Firewall com CARP e pfsync</a>]
[<a href="index.html">Conte&uacute;do</a>]
d473 2
a474 2
Originally [OpenBSD: example1.html,v 1.34 ]<br>
$Translation: example1.html,v 1.10 2008/06/06 01:07:41 dsantos Exp $<br>
d476 1
a476 1
$OpenBSD$ 
@


1.9
log
@Sync with Steelix CVS
@
text
@d485 1
a485 1
pass quick on $int_if
d502 2
a503 2
Originally [OpenBSD: example1.html,v 1.33 ]<br>
$Translation: example1.html,v 1.9 2007/11/24 03:02:04 dsantos Exp $<br>
@


1.8
log
@sync with steelix translation CVS
@
text
@d151 1
a151 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.1"
d256 1
a256 1
m&uacute;ltiplas interfaces precisar&aacute; adicionar mais regras 
d282 1
a282 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.1"
d338 2
a339 2
uma vez filtrada a entrada, n&atilde;o tentaremos obstruir sua s
a&iacute;da, portanto faremos o seguinte:
d502 2
a503 2
Originally [OpenBSD: example1.html,v 1.32 ]<br>
$Translation: example1.html,v 1.8 2007/06/21 23:41:17 dsantos Exp $<br>
@


1.7
log
@sync with steelix translation CVS
@
text
@d95 4
a98 3
tr&ecirc;s, mas o n&uacute;mero real &eacute; irrelevante.  Estes computadores s&atilde;o 
esta&ccedil;&otilde;es de trabalho usadas para navegar na Internet, ler email, chat, etc., 
exceto COMP3 que tamb&eacute;m roda um pequeno servidor web.
d125 1
a125 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8&amp;manpath=OpenBSD+4.0"
d146 1
a146 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=3&amp;manpath=OpenBSD+4.0"
d151 1
a151 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.0"
d194 1
a194 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8&amp;manpath=OpenBSD+4.0"
d217 1
a217 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4&amp;manpath=OpenBSD+4.0"
d282 2
a283 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.0">ftp-proxy(8)</a> 
d502 2
a503 2
Originally [OpenBSD: example1.html,v 1.31 ]<br>
$Translation: example1.html,v 1.7 2006/12/28 18:29:28 dsantos Exp $<br>
@


1.6
log
@sync with Steelix CVS
@
text
@d114 2
a115 1
<li>Usar "negar por padr&atilde;o" como pol&iacute;tica padr&atilde;o de regras.
d118 4
a121 4
	<li>SSH (porta TCP 22): ser&aacute; utilizado para manuten&ccedil;&atilde;o remota 
	do firewall.
	<li>Auth/Ident (porta TCP 113): utilizado por alguns servi&ccedil;os como SMTP
	e IRC.
d124 1
a124 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8&amp;manpath=OpenBSD+3.9"
d143 5
a147 2
Internet e defini&ccedil;&atilde;o de 
<tt>net.inet.ip.forwarding</tt> para "<tt>1</tt>".
d149 4
a152 1
o PF em <tt>/etc/rc.conf.local</tt>.
d161 2
a162 2
As seguintes macros s&atilde;o definidas para facilitar a leitura e manuten&ccedil;ao
das regras:
d193 1
a193 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8&amp;manpath=OpenBSD+3.9"
d201 2
a202 2
estat&iacute;sticas de filtragem (statistics logging "on") para a interface
externa:
d216 1
a216 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4&amp;manpath=OpenBSD+3.9"
d281 1
a281 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+3.9">ftp-proxy(8)</a> 
d411 4
a414 4
Similar &agrave; macro <tt>$tcp_services</tt>, a macro <tt>$icmp_types</tt>
pode ser facilmente editada para alterar os tipos de pacotes ICMP que 
ter&atilde;o permiss&atilde;o de passar pelo firewall. Note que esta 
regra se aplica a todas interfaces de rede.
d500 2
a501 2
Originally [OpenBSD: example1.html,v 1.28 ]<br>
$Translation: example1.html,v 1.6 2006/08/26 21:42:10 dsantos Exp $<br>
@


1.5
log
@sync with steelix translation CVS
@
text
@d188 1
a188 1
<tt>tun0</tt> <i>n&atilde;o</i> em <tt>xl0</tt>.
d493 2
a494 2
Originally [OpenBSD: example1.html,v 1.27 ]<br>
$Translation: example1.html,v 1.5 2006/06/23 15:10:21 dsantos Exp $<br>
@


1.4
log
@sync with steelix translation CVS
@
text
@d246 5
a250 4
O !($ext_if) pode ser substitu&iacute;do por $int_if neste caso, mas 
caso voc&ecirc; tenha m&uacute;ltiplas interfaces precisar&aacute; 
adicionar mais regras NAT, ao passo que, com esta estrutura o NAT 
ser&aacute; feito em todas as interfaces protegidas.
d494 1
a494 1
$Translation: example1.html,v 1.4 2006/05/28 17:23:02 dsantos Exp $<br>
@


1.3
log
@sync with steelix translation CVS
@
text
@d51 1
a51 1
	<li><a href="#objective">O Objetivo</a>
d70 8
a77 5
Neste exemplo, PF est&aacute; rodando numa m&aacute;quina OpenBSD agindo como firewall
e gateway NAT para uma pequena rede em casa ou escrit&oacute;rio. O objetivo
geral &eacute; prover acesso &agrave; Internet para a rede interna e acesso limitado
ao firewall pela Internet. Este documento ir&aacute; guia-lo na cria&ccedil;&atilde;o de
um conjunto de regras para esse fim.
d86 2
a87 2
      |            |                               ADSL
   ---+------+-----+------- fxp0 [ OpenBSD ] ep0 -------- ( Internet )
d101 7
a107 5
O roteador OpenBSD &eacute; um Pentium 100 com duas placas de rede: uma 3com 
3c509B (<tt>ep0</tt>) e uma Intel EtherExpress Pro/100 (<tt>fxp0</tt>).
O roteador possui uma conex&atilde;o ADSL para a Internet e faz NAT para 
compartilhar sua conex&atilde;o com a rede interna. O endere&ccedil;o IP na interface
externa &eacute; atribu&iacute;do dinamicamente pelo Provedor de Acesso Internet.
d110 1
a110 1
<h3>O Objetivo</h3>
d123 1
a123 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8&amp;manpath=OpenBSD+3.8"
d126 5
a130 3
<li>Redirecionar tentativas de conex&atilde;o na porta 80 TCP (que &eacute; uma 
tentativa de conex&atilde;o a um servidor web) para o computador COMP3.
Tamb&eacute;m permitir trafego TCP porta 80 destinado a COMP3 atrav&eacute;s do firewall.
d134 2
a135 3
<li>Tornar as regras simples, para que sua manuten&ccedil;ao seja o mais 
f&aacute;cil poss&iacute;vel.
</ul>
d139 4
a142 3
Este documento assume que o host OpenBSD tenha sido corretamente configurado
para funcionar como roteador, incluindo configura&ccedil;&atilde;o de endere&ccedil;os IP, 
conectividade com a Internet e defini&ccedil;&atilde;o de 
d144 2
d158 2
a159 2
int_if = "fxp0"<br>
ext_if = "ep0"<br>
d164 1
a164 4
priv_nets = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }"
<br>
<br>
comp3 = "192.168.0.3"
d170 11
a180 6
acontecer&aacute;. A terceira e quarta linhas listam os n&uacute;meros de portas
TCP dos servi&ccedil;os que ser&atilde;o abertos para a internet (SSH e ident/auth) 
e os tipos de pacotes ICMP que ter&atilde;o permiss&atilde;o de alcan&ccedil;ar a m&aacute;quina 
do firewall. A quinta linha define os endere&ccedil;os de loopback e blocos
de endere&ccedil;amento descritos na 
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>.
d184 1
a184 1
<b>Nota</b>: Caso a conex&atilde;o ADSL com a Internet necessite
d186 1
a186 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8&amp;manpath=OpenBSD+3.8"
d188 1
a188 1
<tt>tun0</tt> <i>n&atilde;o</i> em <tt>ep0</tt>.
d203 21
d226 3
a228 2
N&atilde;o h&aacute; raz&atilde;o para n&atilde;o utilizar scrubbing, recomendado para 
todo tr&aacute;fego entrante, portanto a regra &eacute; simples como uma linha:
d231 1
a231 1
scrub in all
d241 1
a241 1
nat on $ext_if from $int_if:network to any -&gt; ($ext_if)
d246 21
a266 3
J&aacute; que o endere&ccedil;o IP da interface externa &eacute; atribu&iacute;do dinamicamente, 
par&ecirc;nteses devem ser colocados em volta da interface, assim o PF 
notar&aacute; qualquer altera&ccedil;&atilde;o no endere&ccedil;o.
d270 2
a271 1
A primeira regra de redirecionamento necess&aacute;ria &eacute; 
d273 2
a274 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+3.8">ftp-proxy(8)</a> assim, clientes FTP na rede interna local, poder&atilde;o se conectar 
d278 1
d284 5
a288 4
Note que esta regra funcionar&aacute; apenas com conex&otilde;es destinadas &agrave; porta 21.
Caso usu&aacute;rios se conectem a servidores FTP em outras portas, ent&atilde;o uma 
lista deve ser utilizada para especificar as portas de destino, por 
exemplo: <tt>from any to any port { 21, 2121 }</tt>.
d291 5
a295 4
A segunda regra de redirecionamento pega qualquer tentativa de conex&atilde;o
vinda da Internet em dire&ccedil;&atilde;o &agrave; porta 80 TCP no firewall.
Tentativas de conex&otilde;es leg&iacute;timas nesta porta ser&atilde;o de usu&aacute;rios 
tentando acessar o servidor web da rede.
d306 2
a307 1
Agora as regras de filtragem. Come&ccedil;ando com negar por padr&atilde;o:
d310 1
a310 1
block all<br>
d315 5
a319 3
Neste ponto nada passar&aacute; atrav&eacute;s do firewall, nem mesmo da rede interna.
As regras seguintes abrem o firewall de acordo com os objetivos acima descritos,
bem como quaisquer interfaces virtuais que se fa&ccedil;am necess&aacute;rias.
d322 9
a330 7
Todo sistema Unix possui uma interface de "loopback". &Eacute; uma interface de 
rede virtual utilizada por aplica&ccedil;&otilde;es para se comunicarem entre si dentro
do sistema. Em geral, todo tr&aacute;fego na interface loopback deve ser aceito.
No OpenBSD a interface de loopback &eacute; 
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4&amp;manpath=OpenBSD+3.8"
>lo(4)</a>.
d333 1
a333 1
pass quick on lo0 all
d338 3
a340 8
Depois, os endere&ccedil;os
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>
ser&atilde;o bloqueados, tanto para entrada quanto sa&iacute;da na interface
externa. Estes endere&ccedil;os nunca devem aparecer na Internet, 
portanto, filtra-los nos certificar&aacute; de que o roteador n&atilde;o 
deixar&aacute; "escapar" estes endere&ccedil;os para fora da rede interna 
e tamb&eacute;m bloquear&aacute; qualquer pacote vindo da Internet com 
qualquer desses endere&ccedil;os de origem.
d343 1
a343 2
block drop in &nbsp;quick on $ext_if from $priv_nets to any<br>
block drop out quick on $ext_if from any to $priv_nets
d348 8
a355 7
Note que <tt>block drop</tt> &eacute; usado, dizendo ao PF para n&atilde;o responder
com um pacote TCP RST ou ICMP Unreachable. J&aacute; que endere&ccedil;os da RFC 1918
n&atilde;o existem na Internet, quaisquer pacotes enviados para estes endere&ccedil;os 
nunca alcan&ccedil;ar&atilde;o seu destino. A op&ccedil;ao <tt>quick</tt> &eacute; utilizada, 
informando ao PF para n&atilde;o se preocupar em avaliar o restante das regras
de filtragem caso uma das regras acima case com o pacote; pacotes de ou
para as redes <tt>$priv_nets</tt> ser&atilde;o descartados imediatamente.
d358 4
a361 2
Agora abrimos as portas usadas pelos servi&ccedil;os que estar&atilde;o dispon&iacute;veis 
para a Internet:
d370 7
a376 5
Especificando as portas na macro <tt>$tcp_services</tt> torna-se 
simples abrir mais portas para a Internet caso necess&aacute;rio, editando simplesmente 
a macro e recarregando as regras. Servi&ccedil;os UDP tamb&eacute;m podem ser abertos 
criando-se uma macro <tt>$udp_services</tt> e adicionando uma regra
de filtragem similar &agrave; regra acima, que especifique <tt>proto udp</tt>.
d379 3
a381 2
Al&eacute;m de ter uma regra <tt>rdr</tt> que redireciona o tr&aacute;fego para COMP3,
DEVEMOS tamb&eacute;m autorizar esse tr&aacute;fego atrav&eacute;s do firewall:
d384 1
a384 1
pass in on $ext_if proto tcp from any to $comp3 port 80 \<br>
d391 2
a392 14
<a href="filter.html#synproxy">TCP SYN Proxy</a> para proteger ainda mais o servidor web.

<p>
Para que conex&otilde;es FTP ativas funcionem fora da LAN, a seguinte regra 
deve existir, passando a conex&atilde;o ftp-data iniciada pelo servidor FTP 
de volta para o cliente.
Como as conex&otilde;es FTP est&atilde;o utilizando ftp-proxy, ele mesmo ter&aacute; o trabalho 
de aceitar as conex&otilde;es ftp-data e repassa-las para o cliente na LAN.
<blockquote>
<tt>
pass in on $ext_if inet proto tcp from port 20 to ($ext_if) \<br>
&nbsp;&nbsp;&nbsp;&nbsp;user proxy flags S/SA keep state
</tt>
</blockquote>
d395 1
a395 1
Agora tr&aacute;fego ICMP deve ser permitido:
d405 2
a406 2
ter&atilde;o permiss&atilde;o de alcan&ccedil;ar o firewall. Note que esta regra se aplica a 
todas interfaces de rede.
d409 6
a414 5
Tr&aacute;fego de e para a rede interna deve ser permitido.
Assumiremos que usu&aacute;rios da rede interna sabem o que est&atilde;o 
fazendo e n&atilde;o nos causar&atilde;o problemas.  Esta n&atilde;o &eacute; necessariamente 
uma suposi&ccedil;&atilde;o v&aacute;lida; um conjunto de regras bem mais restritivas 
&eacute; apropriado para a maioria dos ambientes computacionais.
d417 1
a417 1
pass in on $int_if from $int_if:network to any keep state
d422 5
a426 46
As regras acima permitem a qualquer m&aacute;quina interna enviar pacotes 
atrav&eacute;s do firewall, contudo, <i>n&atilde;o</i> permite que o pr&oacute;prio firewall
inicie qualquer conex&atilde;o com uma m&aacute;quina da rede interna. Isso &eacute; uma 
boa id&eacute;ia? Depende dos detalhes precisos de configura&ccedil;&atilde;o da rede.
Caso o firewall seja tamb&eacute;m um servidor DHCP, ele precisa "pingar" um
endere&ccedil;o para verificar sua disponibilidade antes de atribu&iacute;-lo a uma
m&aacute;quina. Permitir ao firewall se conectar &agrave; rede interna tamb&eacute;m d&aacute; 
permiss&atilde;o a algu&eacute;m com uma conex&atilde;o ssh no firewall pela Internet para acessar 
m&aacute;quinas da rede interna. Tenha em mente que <i>n&atilde;o</i> permitir ao 
firewall se comunicar com a rede interna n&atilde;o traz um grande benef&iacute;cio 
em seguran&ccedil;a; de qualquer modo, caso algu&eacute;m consiga acesso ao firewall, 
essa pessoa provavelmente pode alterar as regras de filtragem.
Adicionando a regra a seguir, o firewall poder&aacute; iniciar conex&otilde;es com
a rede interna.
<blockquote>
<tt>
pass out on $int_if from any to $int_if:network keep state
</tt>
</blockquote>

<p>
Note que se ambas as linhas estiverem presentes, a op&ccedil;&atilde;o <tt>keep state</tt>
n&atilde;o se faz necess&aacute;ria; todos pacotes passar&atilde;o pela interface interna,
isso porqu&ecirc; existem regras para passar os pacotes em ambas as dire&ccedil;&otilde;es.
Contudo caso a linha <tt>pass out</tt> <i>n&atilde;o</i> exista a linha 
<tt>pass in</tt> <i>deve</i> incluir <tt>keep state</tt>.  Existe 
al&eacute;m disso um ganho de performance mantendo-se o estado da conex&atilde;o:
as tabelas de estado (State tables) s&atilde;o verificadas antes das regras
serem avaliadas, e caso um pacote combine com alguma entrada na
tabela, o mesmo passa pelo firewall sem ser avalidado pelas regras.
Isso oferece ganho de performance num firewall muito carregado, 
mas num sistema simples como este n&atilde;o trar&aacute; benef&iacute;cios vis&iacute;veis.

<p>
Finalmente, permitimos tr&aacute;fego na interface externa:
<blockquote>
<tt>
pass out on $ext_if proto tcp all modulate state flags S/SA<br>
pass out on $ext_if proto { udp, icmp } all keep state
</tt>
</blockquote>

<p>
Tr&aacute;fego TCP, UDP e ICMP &eacute; permitido sair do firewall em dire&ccedil;&atilde;o 
&agrave; Internet. Informa&ccedil;&atilde;o de estado das conex&otilde;es &eacute; mantido 
para que os pacotes de retorno passem direto pelo firewall.
d434 2
a435 2
int_if = "fxp0"
ext_if = "ep0"
d437 2
a438 2
tcp_services = "{ 22, 113 }"
icmp_types = "echoreq"
d440 1
a440 3
priv_nets = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }"
	  
comp3 = "192.168.0.3"
d446 2
d449 1
a449 1
scrub in all
d452 6
a457 4
nat on $ext_if from $int_if:network to any -&gt; ($ext_if)
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 \
   port 8021
rdr on $ext_if proto tcp from any to any port 80 -&gt; $comp3
d460 1
a460 1
block all
d462 1
a462 1
pass quick on lo0 all
d464 2
a465 2
block drop in  quick on $ext_if from $priv_nets to any
block drop out quick on $ext_if from any to $priv_nets
d470 2
a471 5
pass in on $ext_if proto tcp from any to $comp3 port 80 \
   flags S/SA synproxy state

pass in on $ext_if inet proto tcp from port 20 to ($ext_if) \
   user proxy flags S/SA keep state
d475 1
a475 2
pass in  on $int_if from $int_if:network to any keep state
pass out on $int_if from any to $int_if:network keep state
a476 2
pass out on $ext_if proto tcp all modulate state flags S/SA
pass out on $ext_if proto { udp, icmp } all keep state
d492 2
a493 2
Originally [OpenBSD: example1.html,v 1.21 ]<br>
$Translation: example1.html,v 1.3 2005/11/15 14:36:42 dsantos Exp $<br>
@


1.2
log
@sync with Steelix CVS
@
text
@d117 2
a118 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8&amp;manpath=OpenBSD+3.7"
d174 2
a175 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8&amp;manpath=OpenBSD+3.7"
d220 2
a221 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+3.7">ftp-proxy(8)</a> assim, clientes FTP na rede interna local, poder&atilde;o se conectar 
d267 2
a268 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4&amp;manpath=OpenBSD+3.7"
d486 4
a489 2
Originally [OpenBSD: example1.html,v 1.20 ]<br>
$Translation: example1.html,v 1.2 2005/05/27 15:11:33 dsantos Exp $<br>                
@


1.1
log
@sync with steelix translation CVS
@
text
@d39 1
a39 1
[<a href="authpf.html">Anterior: Authpf: Shell de Usu&aacute;rio para Autentica&ccedil;&atilde;o em Gateways</a>]
d117 1
a117 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8&amp;manpath=OpenBSD+3.6"
d173 1
a173 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8&amp;manpath=OpenBSD+3.6"
d218 1
a218 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+3.6">ftp-proxy(8)</a> assim, clientes FTP na rede interna local, poder&atilde;o se conectar 
d264 1
a264 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4&amp;manpath=OpenBSD+3.6"
d473 1
a473 1
[<a href="authpf.html">Anterior: Authpf: Shell de Usu&aacute;rio para Autentica&ccedil;&atilde;o em Gateways</a>]
d482 2
a483 2
Originally [OpenBSD: example1.html,v 1.18 ]<br>
$Translation: example1.html,v 1.1 2005/01/04 17:09:07 dsantos Exp $<br>                
@

