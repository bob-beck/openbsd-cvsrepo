head	1.7;
access;
symbols;
locks; strict;
comment	@# @;


1.7
date	2008.03.31.20.01.45;	author tobias;	state dead;
branches;
next	1.6;

1.6
date	2005.01.20.19.41.28;	author jufi;	state Exp;
branches;
next	1.5;

1.5
date	2004.05.09.09.58.22;	author saad;	state Exp;
branches;
next	1.4;

1.4
date	2004.02.15.18.18.41;	author jufi;	state Exp;
branches;
next	1.3;

1.3
date	2003.11.03.16.46.36;	author jufi;	state Exp;
branches;
next	1.2;

1.2
date	2003.03.07.10.50.11;	author jufi;	state Exp;
branches;
next	1.1;

1.1
date	2003.02.05.19.43.39;	author jufi;	state Exp;
branches;
next	;


desc
@@


1.7
log
@Sync with Steelix CVS
@
text
@<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="Content-Type"
	content="text/html; charset=iso-2022-jp">
  <meta name="resource-type"
	content="document">
  <meta name="description"
	CONTENT="How to make an OpenBSD port; audio">
  <meta name="keywords"
	content="openbsd,ports,audio">
  <meta name="distribution"
	content="global">
  <meta name="copyright"
	content="This document copyright 1998-2002 by OpenBSD.">
  <title>Porting audio applications to OpenBSD</title>
  <link rev="made" HREF="mailto:www@@openbsd.org">
 </head>
 <body text="#000000" bgcolor="#FFFFFF" link="#23238E">
<a href="index.html"><img alt="[OpenBSD]" height="30" width="141" src="../images/smalltitle.gif" border="0"></a>

  <h1>オーディオアプリケーションの OpenBSD への移植</h1>

<p>
  このドキュメントは、現時点世任魯汽Ε鵐百慙△里澆鮗茲螳靴辰討い泙后
シンセサイザや波形の表などの寄付を歓迎します。

</p>
<p>
	オーディオアプリケーションは、まだ瀬ぅ鵐拭璽侫Дぅ垢現牴修気譴討い覆
	領域であるため、移植が難しいものとなりがちですが、オペレーティングシステム
	間でのアプローチにあまり変化がないものでもあります。
</p>

  <h2><font color="#e00000"><code>ossaudio</code> の使用</font></h2>

  <code>ossaudio</code> エミュレーションはおそらく最も単純な方法ですが、
  必ずしも動くとは限りませんし、通常はすばらしいアイディアの類でもありません。
  <ul>
	<li>これは <code>ioctl</code> を再定義します。移植するコードがオーディオ
	以外の <code>ioctl</code> を使用している場合、<code>#undef ioctl</code>
	を指定した上で、<code>_ossioctl</code> でそのままの形を使用する必要が
	あります。

	<li>Linux のサウンドのいくつかの機能はエミュレートされません。

	<li>Intel 固有ではない Linux のサウンドを誓気靴汽檗璽箸垢
	アプリケーションでは、これらの機能を使用する傾向があります。

  </ul>

  <h2><font color="#e00000">既存の NetBSD や FreeBSD のコードの使用</font></h2>
  NetBSD や FreeBSD とオーディオインターフェイスの部分を共有しているので、
  NetBSD の port から始めるのは理に適っています。ただ世掘△い弔離侫．ぅ襪
置き場所が変っていますので注意が必要です。また、<code>sys/audioio.h</code>
  のいくつかのエントリを使用されなくなりました。同様に、多くの ports は間違って
  コーディングされ、たったひとつのタイプのマシンでしか動かないことも多いのです。
  なので、ある種の変更が必要になります。次の部分をよくお読みくだ世気ぁ

取仮惹闔竢跫鮟■絨旭旭⊂緕帯のコードの書き方</font></h2>
	  <h3><font color="#0000e0">ハードウェア依存</font></h3>

   <p>
	<strong>使用されているオーディオハードウェアについて何も仮定すべきではありません。
	</strong><br>
	間違ったコードは、<code>a_info.play.precision</code> フィールドが 8 か 16 ビット
	かだ世韻鬟船Д奪掘▲汽Ε鵐疋屮薀好拭爾竜麁阿亡陲鼎い董箙腓覆靴箙臧佞
	仮定してしまっています。サンプルの型は明声縫船Д奪垢戮任垢掘△修譴暴召辰
	コーディングしなければなりません。以下に単純な例を示します。
   <p>
	<pre>
    AUDIO_INIT_INFO(&amp;a_info);
    a_info.play.encoding = AUDIO_ENCODING_SLINEAR;
    a_info.play.precision = 16;
    a_info.play.sample_rate = 22050;
    error = ioctl(audio, AUDIO_SETINFO, &amp;a_info);
    if (error)
	/* deal with it */
    error = ioctl(audio, AUDIO_GETINFO, &amp;a_info);
    switch(a_info.play.encoding)
	{
    case AUDIO_ENCODING_ULINEAR_LE:
    case AUDIO_ENCODING_ULINEAR_BE:
	if (a_info.play.precision == 8)
	    /* ... */
	else 
	    /* ... */
	break;
    case ...

    default:
	/* don't forget to deal with what you don't know !!! For instance, */
	fprintf(stderr, 
		"Unsupported audio format (%d), ask ports@@ about that\n",
		a_info.play.encoding);

	}
    /* now don't forget to check what sampling frequency you actually got */
	</pre>
  
  <p>
  これは、ほとんどの問題を取り扱える、最も小さなコードの断片についてです。

  	<h3><font color="#0000e0">16 ビットフォーマットとエンディアン</font></h3>
	通常の使用において、エンコーディングタイプ (たとえば <code>AUDIO_ENCODING_SLINEAR</code>)
	を問い合わせることで、エンディアンとともにエンコーディングタイプ
	(たとえば <code>AUDIO_ENCODING_SLINEAR_LE</code>) を受け取ります。
	同じエンディアンを使用しなければならないわけではないサウンドカードを
	使用するプラットフォームを考える場合でも、その取り扱に備えるべきです。
	最も簡単なのはおそらく、完全なオーディオバッファを用意して、エンディアンの
	変更を要求された場合には <code>swab(3)</code> を使用する方法でしょう。
	外部のサンプルの取り扱いはおおよそ以下のようになります。
	<ol>
		<li>サンプルフォーマットの解誓
		殊蘊サンプルの取り込み
		<li>ネイティブフォーマットではない場合、エンディアンを変換
		<li>バッファに何を出力したいのかを計算
		<li>サウンドカードがネイティブフォーマットではない場合、エンディアンを変換
		<li>バッファを出力
	</ol>
	たまたま、サウンドカードのネイティブフォーマットであるサウンドのサンプルを
	単純に演奏しようとしている場合には、明世望綉ぢと 5 のステップを省略
	可能です。

	<h3><font color="#0000e0">音質</font></h3>
	<p>
	たとえば、44100Hz までのモノラルなら可能なのに、ステレオだ世屋軌枇ぢ以上に
	できないなどの、おかしな誓造鬟蓮璽疋ΕД△辰討い襪海箸△蠅泙后海里茲Δ幣豺隋
	ユーザの好みに応じて状態を変更可能にすべきで、その上で可能な限り最良の誓修鮟个垢茲
	最前の努力を尽してくだ世気ぁ燭箸┐弌▲好謄譽能侘呂垢襪燭瓩誓からとサンプリング
	周波数を 22050Hz に誓造靴燭蠅垢襪里藁匹い海箸任呂△蠅泙擦鵝發掘▲罅璽兇
	オーディオカードの出力に誓楝海気譴織好謄譽汽Ε鵐疋轡好謄爐鮖辰討い覆辰燭箸靴燭
	どうでしょうか ?
	</p>

	<p>
	また、サウンドブラスターのような誓造鬟廛蹈哀薀狠罎縫蓮璽疋魁璽匹靴討靴泙Δ里
	愚かな行為です。これらのことには注意すべきではありますが、ステレオで 22050Hz
	以上という壁を乗り越えるために努力し、結果をチェックしてみてくだ世気ぁ
	鹿霈

	取款サンプリング周波数</h4>
	カードが返してくるサンプリング周波数は明棲里縫船Д奪垢戮發里任后
	汽ぢの誤差というのは既に半音階に達するものですし、ある人々は、
	それ以上に誓騎里兵鮖辰討い泙垢△曚箸鵑匹凌佑呂△泙蟲い
	しないでしょう。アプリケーションは、動作中にできるだ世叡噂磴法
	あるいは可能なら、シャノンの再サンプリング方式の回りくどい
	アプリケーションを通して、再サンプリングを可能にすべきです。

	<h4>ダ瀬ぅ淵潺奪譽鵐鹿茣	腫	サンプルは、使用可能なレンジを常時フルに使用するわけではありません。
	まず、低い利得世馬寝擦気譴織汽鵐廛襪蓮▲罅璽兇椒螢紂璽爐鯡椣貲佞望紊欧討癲
	マシン上では非常にうるさいほどの音量になることはないでしょう。
	次に、オーディオの誓箟錣琉ぅ泪轡鵑砲韻訥磴げ酸声出力は、ほとんど
	マシンの騒音を聞いていることになり、期待する音が聞けないことを意味します。
	最後に、16 ビットから 8 ビットへの変換方法が悪いと、ひどく音質の悪い
	4 ビット分しか意味のないオーディオ情報しか残らないことがあります。
	</p>
	<p>
	もし可能なら、最も良い解決策はおそらく、これから演奏しようとしている
	全ストリームをスキャンし、ダ瀬ぅ淵潺奪譽鵐諺澗里謀腓垢襪茲Α
	音量を変更することでしょう。もし、その余裕がなくても、今これから
	演奏しようとしているものを少しだ世韻任蘯萋誓することができるのでしたら、
	演奏中に音量の増加を調誓瓩垢襪海箸發任泙垢∪絶対に
	<em>オーバーフローさせることなく</em>、これから演奏したい音に比べて
	低い周期で音量の調誓疥未魴茲瓩覆韻譴个覆蠅泙擦鵝
	しかし、このようなことをしても、得世茲Δ箸靴討い覯纂漸韻量槁犬茲蝓
	非常に悪いものになってしまうだ世韻任靴腓Α錫鮠
	音量の知覚は対数的ですので、算術シフトを使用するだ世韻任眥名錣禄淑任靴腓Α
	もし、データが符合付きなら、C 言生譴竢粤商苳殺苳纂閼緇ぢ演算子は
	符合付きデータに対しては移植可能ではありませんので、
	明声暴擦砲茲襯轡侫箸鮖藩僂垢襪茲Ε魁璽妊鵐阿垢戮任后
	鹿霈
	腫	もし、すべての方法がうまくいかなければ、少なくともユーザに対して
	音量を調誓瓩垢觴蠱覆鯆鷆，垢戮任后
	鹿霈

	取馨惹闔竢跫鮟■旭旭絨⊂オーディオの誓鹿肬銓昭馨
	腫	ローエンドのアプリケーションでは、あまり心配することはありません。
	ローエンドの 68030 上で OpenBSD を使用する人もいることを念頭に置いて、
	もし、サウンドアプリケーションがその上で実行可能なら、そうすべきです。
	</p>

	<p>
	ベンチマークテストの実施を忘れないようにしてくだ世気ぁＭ誓的な最適化は
	理論静覆發里任靴△蠅泙擦鵝い弔瞭颪靴し舛砲弔い討蓮燭グ未
	何がそうでないのかをチェックするために集めておくべきです。
	</p>

	<p>
	MPEG I - レイヤー 3 のような高誓修淵璽妊▲廛螢院璽轡腑鵑里燭瓩法
	いくつかの点世魴彁擦貌譴討戮任后
	鹿霈
	受貍
	殊蘊オーディオインターフェイスは、ハードウェアにとって自然なブロックサイズを
	    用意するものです。そして、出力バッファとしてそれらを複数使用することが
	    基本となります。システムコールである <code>write</code> は、内部での
	    オーディオ処理に比較して高価な処理であるということを覚えておいてくだ世気ぁ

	殊蘊帯域幅はオーディオを扱う場合に非常に重要な要素となります。
	    オーディオプレイヤーを最適化する上で役に立つ方法は、それを圧縮解除するものと
	    見なすことです。圧縮されたデータとの調和を保つのに十分であり、
	    通常はより良いものでしょう。極く小さな処理を行う非常に小さなループは、
	    通常は良くないアイディアです。一般的に、すべての処理をひとつのループに
	    入れてしまう方がずっと良いものになります。

	    <li>いくつかのフォーマットは、他のものより大きなオーバーヘッドを必要とします。
	    オーディオデバイスが提供するすべてのフォーマットを受け取るために、
	    <code>AUDIO_GETENC</code> <code>ioctl</code> を使用すべきです。
	    特に <code>AUDIO_ENCODINGFLAG_EMULATED</code> フラグには
	    注意してくだ世気ぁ發掘△△覆燭離▲廛螢院璽轡腑鵑垢戮討亮鑪爐
	風変りなフォーマットを出力できるようになっているのでしたら、また、
	    それに対して理に適った最適化を行えるのでしたら、ぜひともネイティブな
	    フォーマットを使用するようにしてくだ世気ぁ泙拭貶如▲璽妊妊丱ぅ垢
	エミュレーションコードはかなり最適なものであると仮定できますので、
	    それをクイックハックのコードと置き換えようとしないでくだ世気ぁ
	鹿
	最適な結果を得世襪燭瓩砲△覆燭温佑砲靴覆韻譴个覆蕕覆い眞里譴覆ぅ皀妊襪蓮
	利用可能な特定のオーディオハードウェアについて問い合わせる小さなテストプログラムを
	まずコンパイルすることです。その上で、そのハードウェアを最適に扱うことができるよう、
	あなたのプログラムの構誓鯊海韻討誓さい。良いオーディオ誓修鰺澆靴た諭垢
	ハードウェアを変えた場合に、彼らがあなたの ports を再コンパイルして
	異なるものにしてくれることを、それなりに期待することができるでしょう。
	</p>

	<h3><font color="#0000e0">リアルタイムか同期か</font></h3>
	<p>
	OpenBSD がリアルタイムではないことを考慮してもなお、たとえばゲーム用に
	ほとんどリアルタイムのオーディオアプリケーションをあなたは書きたいと思うかも知れません。
	このような場合、今のゲームと効果音の同期が外れないよう、ブロックサイズを
	より小さくしなければならないでしょう。
	この場合の問題は、恐るべき結果を誓犬犬襦▲璽妊妊丱ぅ垢剖ゝ襪垢戮
	データが間に合わなくなるかも知れないということです。
	</p>
	<p>
	たとえば、オーディオがあるグラフィックスの出力と
	単純に同期することを望んでおり、プログラムの挙動が予測可能である場合は、
	その同期は比較的簡単でしょう。オーディオサンプルを演奏する場合、
	現在演奏中のオーディオデバイスに <code>AUDIO_GETOOFFS</code>
	で問い合わせ、後で同期するグラフィックスへの情報として使用します。
	十分に頻繁に (たとえば 10 秒ごとに) 問い合わせるという条件の下で、
	そして、アプリケーションの実行に十分な馬力がある限り、この方法でも
	この方法でも非常に良好な同期を得世襪海箸任襪任靴腓Α
	ただ澄什澑藾嫦罎里發里肇璽妊離譽檗璽箸箸隆屬砲麓禊海離織ぅ爛薀阿
	ありますし、また X Window が何かを表示するための時間もありますので、
	一定のオフセットで波形を微調誓阿靴覆韻譴个覆蕕覆覆襪眞里譴泙擦鵝
	鹿霈
取仮惹闔竢跫鮟■絨旭旭⊂コードの寄付</font></h2>
	<p>オーディオアプリケーションの場合、オリジナルのプログラムの
	作者との共同作業が非常に重要です。たとえば、彼のコードが
	サウンドブラスターカードでのみ動くというような場合、これは、
	彼が他の技術に直ちに対処するための、良い機会となるでしょう。
	</p>

	<p>
	<strong>ただ世靴△覆燭△△覆燭離灰瓮鵐箸鯣爐冒蕕覆辰燭箸靴燭蕁
	あなたの作業は役に立たないものになってしまうことでしょう</strong>。</p>

	<p>
	また、あなたが現在取り組んでいるいろいろな問題について、彼は既に注目して
	いるかも知れませんし、彼の現在の開発ツリーにその解決策が織り込まれて
	いるかも知れません。もし、あなたが、少量の行数より多くのパッチを書いているのでしたら、
	ほぼ確実に、彼との共同作業は非常に良いアイディアでしょう。
	</p>

  <hr>
  <a href="porting.html"><img height="24" width="24" src="../back.gif"
   border="0" alt="Porting"></a> 
  <a href="mailto:www@@openbsd.org">www@@openbsd.org</a>
<br>
<small>
<!-- 
Originally [OpenBSD: audio-port.html,v 1.9 ]
$Translation: audio-port.html,v 1.3 2005/01/20 04:06:14 toshi Exp $
-->
$OpenBSD: audio-port.html,v 1.6 2005/01/20 19:41:28 jufi Exp $
</small>
</body>
</html>
@


1.6
log
@Sync with Steelix CVS
@
text
@d281 1
a281 1
$OpenBSD: audio-port.html,v 1.8 2003/03/06 13:51:31 naddy Exp $
@


1.5
log
@sync with Steelix CVS
@
text
@d277 4
a280 4
Originally [OpenBSD: audio-port.html,v 1.8 ]
<br>
$Translation: audio-port.html,v 1.2 2003/03/07 09:37:57 toshi Exp $
<br>
@


1.4
log
@*** empty log message ***
@
text
@@


1.3
log
@sync with steelix translation CVS
@
text
@@


1.2
log
@
sync with steelix translation CVS
@
text
@@


1.1
log
@
sync with steelix translation CVS
@
text
@d1 2
d30 1
a30 1

d34 1
d36 1
a36 2

  <h2><font color=#e00000><code>ossaudio</code> の使用</font></h2>
d53 1
a53 1
  <h2><font color=#e00000>既存の NetBSD や FreeBSD のコードの使用</font></h2>
d61 2
a62 2
  <h2><font color=#e00000>OpenBSD のコードの書き方</font></h2>
	  <h3><font color=#0000e0>ハードウェア依存</font></h3>
d71 1
d102 1
a102 1
  </p>
d105 1
a105 1
  	<h3><font color=#0000e0>16 ビットフォーマットとエンディアン</font></h3>
d126 1
a126 1
	<h3><font color=#0000e0>音質</font></h3>
d181 1
a181 1
	<h3><font color=#0000e0>オーディオの誓鹿肬銓昭馨
箟昂
甓憶
	鹿霈
箍咳
甓咳
	取馨惹闔竢跫鮟０旭医鮎リアルタイムか同期か</font></h3>
d253 1
a253 1
  <h2><font color=#e00000>コードの寄付</font></h2>
d264 1
d269 1
a269 1

d277 1
a277 1
Originally [OpenBSD: audio-port.html,v 1.7 ]
d279 1
a279 1
$Translation: audio-port.html,v 1.1 2003/02/03 22:52:20 toshi Exp $
d281 1
a281 1
$OpenBSD: audio-port.html,v 1.7 2002/06/18 01:44:05 jsyn Exp $
@

